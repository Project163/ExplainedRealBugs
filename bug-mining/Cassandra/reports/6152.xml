<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:26:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17254] nodetool toppartitions can fail because ByteBuffer.array() returns more bytes than would be considered valid by UTF8Serializer.validate</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17254</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The error below is caused by the use of &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L1628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ByteBuffer.array()&lt;/tt&gt;&lt;/a&gt;. Doing so not only makes the hex key potentially incorrect but causes invalid data to be passed to &lt;tt&gt;AbstractType.getString&lt;/tt&gt; and ultimately &lt;tt&gt;UTF8Validator.validate&lt;/tt&gt;. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
error: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; didn&apos;t validate.
-- StackTrace --
org.apache.cassandra.serializers.MarshalException: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; didn&apos;t validate.
	at org.apache.cassandra.serializers.UTF8Serializer.validate(UTF8Serializer.java:35)
	at org.apache.cassandra.db.marshal.AbstractType.getString(AbstractType.java:129)
	at org.apache.cassandra.db.ColumnFamilyStore.finishLocalSampling(ColumnFamilyStore.java:1633)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13421838">CASSANDRA-17254</key>
            <summary>nodetool toppartitions can fail because ByteBuffer.array() returns more bytes than would be considered valid by UTF8Serializer.validate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwest">Jordan West</assignee>
                                    <reporter username="jwest">Jordan West</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Jan 2022 00:38:24 +0000</created>
                <updated>Thu, 22 Jun 2023 15:21:11 +0000</updated>
                            <resolved>Wed, 30 Nov 2022 02:36:41 +0000</resolved>
                                        <fixVersion>3.0.29</fixVersion>
                                    <component>Tool/nodetool</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17472381" author="jrwest" created="Tue, 11 Jan 2022 00:44:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...jrwest:jwest/17254-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.0...jrwest:jwest/17254-3.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17629971" author="brandon.williams" created="Mon, 7 Nov 2022 19:12:24 +0000"  >&lt;p&gt;Can we add a test for this?&lt;/p&gt;</comment>
                            <comment id="17629985" author="jrwest" created="Mon, 7 Nov 2022 19:31:18 +0000"  >&lt;p&gt;I&apos;m generally +1 on adding tests but it looks like it will be somewhat cumbersome for this function. Any recommendations on approaches? I was thinking maybe an in-JVM dtest but the key has to be a certain format to trigger the issue. On the other hand, the usage of the ByteBuffer API here is definitely wrong. Thoughts?&#160;&lt;/p&gt;</comment>
                            <comment id="17630057" author="JIRAUSER291462" created="Mon, 7 Nov 2022 22:13:19 +0000"  >&lt;p&gt;+1. Approved.&#160;&lt;/p&gt;</comment>
                            <comment id="17630066" author="brandon.williams" created="Mon, 7 Nov 2022 22:26:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;I was thinking maybe an in-JVM dtest but the key has to be a certain format to trigger the issue. On the other hand, the usage of the ByteBuffer API here is definitely wrong. Thoughts?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, that&apos;s a lot of effort to trigger it.  The usage is definitely wrong though, that person didn&apos;t know what they were doing (it was me.)&lt;/p&gt;

&lt;p&gt;3.11 doesn&apos;t seem to have this problem and uses ByteBufferUtil.bytesToHex instead, any reason not to just backport that solution to 3.0?&lt;/p&gt;</comment>
                            <comment id="17630073" author="jrwest" created="Mon, 7 Nov 2022 22:37:48 +0000"  >&lt;p&gt;If I am reading the 3.11 code right (pasted below jic), it uses &lt;tt&gt;bytesToHex&lt;/tt&gt; for the key but just uses the &lt;tt&gt;ByteBuffer&lt;/tt&gt; directly unlike my patch which duplicates it for the value. I am fine with the 3.11 approach as well assuming the comment is correct:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//Not duplicating the buffer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; safety because AbstractSerializer and ByteBufferUtil.bytesToHex
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//don&apos;t modify position or limit
&lt;/span&gt;ByteBuffer key = counter.getItem();
result.put(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompositeDataSupport(COUNTER_COMPOSITE_TYPE, COUNTER_NAMES, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] {
        ByteBufferUtil.bytesToHex(key), &lt;span class=&quot;code-comment&quot;&gt;// raw
&lt;/span&gt;        counter.getCount(),  &lt;span class=&quot;code-comment&quot;&gt;// count
&lt;/span&gt;        counter.getError(),  &lt;span class=&quot;code-comment&quot;&gt;// error
&lt;/span&gt;        metadata.getKeyValidator().getString(key) })); &lt;span class=&quot;code-comment&quot;&gt;// string &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17630075" author="brandon.williams" created="Mon, 7 Nov 2022 22:44:37 +0000"  >&lt;p&gt;That was from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9241&quot; title=&quot;ByteBuffer.array() without ByteBuffer.arrayOffset() + ByteBuffer.position() is a bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9241&quot;&gt;&lt;del&gt;CASSANDRA-9241&lt;/del&gt;&lt;/a&gt; and seems trustworthy to me.&lt;/p&gt;</comment>
                            <comment id="17631300" author="jrwest" created="Wed, 9 Nov 2022 21:26:59 +0000"  >&lt;p&gt;Updated the branch linked above with the 3.11 code and kicked off tests &#160;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jrwest/cassandra/112/workflows/4c88ab60-cd11-4579-b4ee-d8f3c241d6fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17631318" author="brandon.williams" created="Wed, 9 Nov 2022 22:26:34 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17641041" author="jrwest" created="Wed, 30 Nov 2022 02:36:41 +0000"  >&lt;p&gt;Commited as &lt;a href=&quot;https://github.com/apache/cassandra/commit/13d495aa7d5b7a7c121fcc9e105f79107c5c2a1c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/13d495aa7d5b7a7c121fcc9e105f79107c5c2a1c&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12998" cascade-level="1"><![CDATA[Other Exception]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yfzs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[superwangcheng]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12352450">3.0.29</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/13d495aa7d5b7a7c121fcc9e105f79107c5c2a1c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/13d495aa7d5b7a7c121fcc9e105f79107c5c2a1c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;manual / production&#160;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>