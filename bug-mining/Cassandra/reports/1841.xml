<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4786] NPE in migration stage after creating an index</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4786</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The dtests are generating this error after trying to create an index in cql2:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
ERROR [MigrationStage:1] 2012-10-09 20:54:12,796 CassandraDaemon.java (line 132) Exception in thread Thread[MigrationStage:1,5,main]
java.lang.NullPointerException
    at org.apache.cassandra.db.ColumnFamilyStore.reload(ColumnFamilyStore.java:162)
    at org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:549)
    at org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:479)
    at org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:344)
    at org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:256)
    at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:662)
ERROR [Thrift:1] 2012-10-09 20:54:12,797 CustomTThreadPoolServer.java (line 214) Error occurred during processing of message.
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.NullPointerException
    at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:348)
    at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:238)
    at org.apache.cassandra.service.MigrationManager.announceColumnFamilyUpdate(MigrationManager.java:209)
    at org.apache.cassandra.cql.QueryProcessor.processStatement(QueryProcessor.java:714)
    at org.apache.cassandra.cql.QueryProcessor.process(QueryProcessor.java:816)
    at org.apache.cassandra.thrift.CassandraServer.execute_cql_query(CassandraServer.java:1656)
    at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3721)
    at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3709)
    at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)
    at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)
    at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:196)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:662)
Caused by: java.util.concurrent.ExecutionException: java.lang.NullPointerException
    at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)
    at java.util.concurrent.FutureTask.get(FutureTask.java:83)
    at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:344)
    ... 13 more
Caused by: java.lang.NullPointerException
    at org.apache.cassandra.db.ColumnFamilyStore.reload(ColumnFamilyStore.java:162)
    at org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:549)
    at org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:479)
    at org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:344)
    at org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:256)
    at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    ... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12611102">CASSANDRA-4786</key>
            <summary>NPE in migration stage after creating an index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Oct 2012 01:58:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:25 +0000</updated>
                            <resolved>Tue, 16 Oct 2012 06:41:01 +0000</resolved>
                                        <fixVersion>1.2.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13473518" author="xedin" created="Wed, 10 Oct 2012 20:04:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; Can you please elaborate which of dtests indicates that? I tried cloning riptano/cassandra-dtests and running secondary_indexes_test.py on trunk but it can&apos;t even start a node because of cassandra.yaml changes...&lt;/p&gt;</comment>
                            <comment id="13473523" author="brandon.williams" created="Wed, 10 Oct 2012 20:06:40 +0000"  >&lt;p&gt;It&apos;s actually snapshot_test in concurrent_schema_changes_test.py that does it about 50% of the time.&lt;/p&gt;</comment>
                            <comment id="13473524" author="xedin" created="Wed, 10 Oct 2012 20:09:22 +0000"  >&lt;p&gt;Interesting, I will try to deal with cassandra.yaml problem and run those tests then.&lt;/p&gt;</comment>
                            <comment id="13473525" author="brandon.williams" created="Wed, 10 Oct 2012 20:09:59 +0000"  >&lt;p&gt;I had to comment out the native_transport_address line in ccmlib/node.py to get it to run.&lt;/p&gt;</comment>
                            <comment id="13474477" author="brandon.williams" created="Thu, 11 Oct 2012 20:15:35 +0000"  >&lt;p&gt;Here is a similar error I&apos;ve seen when creating a CF:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [InternalResponseStage:1] 2012-10-11 15:12:16,695 CassandraDaemon.java (line 132) Exception in thread Thread[InternalResponseStage:1,5,main]
java.lang.NullPointerException
    at org.apache.cassandra.db.DefsTable.addColumnFamily(DefsTable.java:500)
    at org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:434)
    at org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:344)
    at org.apache.cassandra.service.MigrationTask$1.response(MigrationTask.java:66)
    at org.apache.cassandra.net.ResponseVerbHandler.doVerb(ResponseVerbHandler.java:44)
    at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13474557" author="brandon.williams" created="Thu, 11 Oct 2012 22:14:21 +0000"  >&lt;p&gt;Also doesn&apos;t appear to be tied to cql2, it happens with cql3 index creation too sometimes:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
ERROR [Thrift:1] 2012-10-11 17:09:39,616 CustomTThreadPoolServer.java (line 214) Error occurred during processing of message.
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.NullPointerException
    at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:348)
    at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:238)
    at org.apache.cassandra.service.MigrationManager.announceColumnFamilyUpdate(MigrationManager.java:209)
    at org.apache.cassandra.cql3.statements.CreateIndexStatement.announceMigration(CreateIndexStatement.java:113)
    at org.apache.cassandra.cql3.statements.SchemaAlteringStatement.execute(SchemaAlteringStatement.java:82)
    at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:130)
    at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:138)
    at org.apache.cassandra.thrift.CassandraServer.execute_cql_query(CassandraServer.java:1658)
    at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3721)
    at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3709)
    at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)
    at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)
    at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:196)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:662)
Caused by: java.util.concurrent.ExecutionException: java.lang.NullPointerException
    at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)
    at java.util.concurrent.FutureTask.get(FutureTask.java:83)
    at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:344)
    ... 15 more
Caused by: java.lang.NullPointerException
    at org.apache.cassandra.db.ColumnFamilyStore.reload(ColumnFamilyStore.java:162)
    at org.apache.cassandra.db.DefsTable.updateColumnFamily(DefsTable.java:549)
    at org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:479)
    at org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:344)
    at org.apache.cassandra.service.MigrationManager$1.call(MigrationManager.java:256)
    at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    ... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13474700" author="xedin" created="Fri, 12 Oct 2012 01:11:39 +0000"  >&lt;p&gt;It looks like it&apos;s not a good idea to try to switch memtables as part of the CF reload process as NPE happens in CFS.reload():162 which is related to ability to change CF comparators feature (introduced in CQL3?), we can probably minimize the effect by actually somehow checking if comparator was changed before requesting memtable switch...&lt;/p&gt;</comment>
                            <comment id="13475049" author="brandon.williams" created="Fri, 12 Oct 2012 15:02:04 +0000"  >&lt;p&gt;If what we&apos;re seeing here is racy memtable switch behavior, then this is only being seen by schema changes since they flush two tables so close together, so we have a greater overall problem.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, can you take a look?&lt;/p&gt;</comment>
                            <comment id="13476034" author="slebresne" created="Mon, 15 Oct 2012 08:50:03 +0000"  >&lt;p&gt;So the NPE is because when we switch the memtable during reload, there could be a race where some other thread flush the current memtable first and thus maybeSwitchMemtable returns null.&lt;/p&gt;

&lt;p&gt;This can be fixed by storing the comparator at the time a memtable is created, and when we try to change the memtable in reload, try switching the memtable until we know it has the right comparator (this also has the advantage that we won&apos;t switch the memtable unless there has been a comparator change). Patch attached to implement that.&lt;/p&gt;

&lt;p&gt;Note that the patch also switch all the non-final variables from CFMetadata to volatile as they are definitively accessed from multiple threads.&lt;/p&gt;</comment>
                            <comment id="13476466" author="xedin" created="Mon, 15 Oct 2012 21:19:09 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13476800" author="slebresne" created="Tue, 16 Oct 2012 06:41:01 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13561222" author="mharris" created="Wed, 23 Jan 2013 23:23:08 +0000"  >&lt;p&gt;Do you guys know what version this bug was introduced in?  This is affecting us, but we&apos;re hesitant to move to 1.2 so soon after release.  Do you have a recommendation for a version of cassandra to use that would not be affected by this?&lt;/p&gt;</comment>
                            <comment id="13561255" author="jbellis" created="Wed, 23 Jan 2013 23:59:03 +0000"  >&lt;p&gt;This bug was introduced in 1.2.0 beta1.&lt;/p&gt;</comment>
                            <comment id="13561266" author="mharris" created="Thu, 24 Jan 2013 00:21:12 +0000"  >&lt;p&gt;Weird, we&apos;re seeing this on 1.1.6.  Do you know of a fix we could try for this on that version?  We saw a similar bug had been fixed for 1.1.1, so it&apos;s surprising to see it again in 1.1.6.  I&apos;ll double check our deployment setup, but I&apos;m pretty sure that&apos;s the case.&lt;/p&gt;
</comment>
                            <comment id="13561345" author="mharris" created="Thu, 24 Jan 2013 01:54:43 +0000"  >&lt;p&gt;Apologies, I think I was barking up the wrong tree here.  The stack trace I&apos;m seeing actually matches &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4219&quot; title=&quot;Problem with creating keyspace after drop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4219&quot;&gt;&lt;del&gt;CASSANDRA-4219&lt;/del&gt;&lt;/a&gt;, which looks similar but isn&apos;t quite the same thing, so I&apos;ll start being obnoxious on that thread instead.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12549121" name="4786.txt" size="8226" author="slebresne" created="Mon, 15 Oct 2012 08:50:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>246571</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07rqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43260</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xedin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>