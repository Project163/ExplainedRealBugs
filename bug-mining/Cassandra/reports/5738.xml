<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16668] Intermittent failure of SEPExecutorTest.changingMaxWorkersMeetsConcurrencyGoalsTest caused by race condition when shrinking maximum pool size to zero</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16668</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A difficult-to-hit race condition exists in&#160;changingMaxWorkersMeetsConcurrencyGoalsTest when changing the maximum pool size from 0 -&amp;gt; 4 which results in the test failing like so:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;junit.framework.AssertionFailedError: Test tasks did not hit max concurrency goal expected:&amp;lt;true&amp;gt; but was:&amp;lt;false&amp;gt;junit.framework.AssertionFailedError: Test tasks did not hit max concurrency goal expected:&amp;lt;true&amp;gt; but was:&amp;lt;false&amp;gt; at org.apache.cassandra.concurrent.SEPExecutorTest.assertMaxTaskConcurrency(SEPExecutorTest.java:198) at org.apache.cassandra.concurrent.SEPExecutorTest.changingMaxWorkersMeetsConcurrencyGoalsTest(SEPExecutorTest.java:132)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I can hit this issue maybe 2/3 times for every 100 invocations of the unit test.&lt;/p&gt;

&lt;p&gt;The issue that causes the failure is that if tasks are still enqueued when the maximum pool size is set to zero and if all of the SEPWorker threads enter the STOP state before the pool size is bumped to 4, then no SEPWorker threads will be spun up to service the task queue. This causes the above error.&lt;/p&gt;

&lt;p&gt;Why don&apos;t we spin up SEPWorker threads when enqueing tasks? Because of the guard logic in addTask: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/concurrent/SEPExecutor.java#L113,L121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/concurrent/SEPExecutor.java#L113,L121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this scenario taskPermits will not be zero (because we have tasks on the queue) so we never call &lt;tt&gt;maybeStartSpinningWorker()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;A trick to make this issue much easier to hit is to insert a &lt;tt&gt;Thread.sleep(500)&lt;/tt&gt; immediately after setting the pool size to zero. This has the effect of guaranteeing that all SEPWorker threads will be STOP&apos;d before enqueueing more work.&lt;/p&gt;

&lt;p&gt;Here&apos;s a fix that attempts to spin up an SEPWorker whenever we grow the number of work permits:&#160;&lt;a href=&quot;https://github.com/mfleming/cassandra/commit/071516d29e41da9924af24e8002822d3c6af0e01&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mfleming/cassandra/commit/071516d29e41da9924af24e8002822d3c6af0e01&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13378373">CASSANDRA-16668</key>
            <summary>Intermittent failure of SEPExecutorTest.changingMaxWorkersMeetsConcurrencyGoalsTest caused by race condition when shrinking maximum pool size to zero</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mfleming">Matt Fleming</assignee>
                                    <reporter username="mfleming">Matt Fleming</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 May 2021 21:13:32 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:56 +0000</updated>
                            <resolved>Fri, 21 May 2021 18:34:26 +0000</resolved>
                                        <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                    <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Local/Other</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17344146" author="edimitrova" created="Thu, 13 May 2021 21:36:50 +0000"  >&lt;p&gt;Jenkins &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/776/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI run &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17346130" author="adelapena" created="Mon, 17 May 2021 12:35:32 +0000"  >&lt;p&gt;Here are 10K runs of &lt;tt&gt;SEPExecutorTest&lt;/tt&gt; with the patch, using the &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/doc/source/development/testing.rst#circleci&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI multiplexer&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/457/workflows/cb5b1d27-75d4-4b3a-814c-04454fb4f4ef/jobs/4017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-j8&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/457/workflows/cb5b1d27-75d4-4b3a-814c-04454fb4f4ef/jobs/4015&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-j11&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/457/workflows/1b82f571-9dd8-4a98-892b-1c0e3704f2d9/jobs/4013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11-j11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It seems that &lt;tt&gt;changingMaxWorkersMeetsConcurrencyGoalsTest&lt;/tt&gt;&#160;happily survives the three 10K runs, but there are some uncommon failures on &lt;tt&gt;shutdownTest&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://4017-85817267-gh.circle-artifacts.com/62/stdout/fails/049/testsome-org.apache.cassandra.concurrent.SEPExecutorTest.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-j8 runner 62 iteration 49&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://4015-85817267-gh.circle-artifacts.com/73/stdout/fails/009/testsome-org.apache.cassandra.concurrent.SEPExecutorTest.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-j11 runner 73 iteration 9&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://4013-85817267-gh.circle-artifacts.com/68/stdout/fails/051/testsome-org.apache.cassandra.concurrent.SEPExecutorTest.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11-j11 runner 68 iteration 51&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Not sure whether that is related or an independent failure.&lt;/p&gt;</comment>
                            <comment id="17346892" author="mfleming" created="Tue, 18 May 2021 13:21:13 +0000"  >&lt;p&gt;I think that failure is probably unrelated because we saw similar failures for shutdownTest before this patch here &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/441/workflows/bcf154ff-0b56-48ed-9f82-6b3e395f53ed/jobs/3880/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/441/workflows/bcf154ff-0b56-48ed-9f82-6b3e395f53ed/jobs/3880/tests#failed-test-0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Btw, I&apos;ve also written a new unit test to catch this bug in the future: &lt;a href=&quot;https://github.com/mfleming/cassandra/commit/b4f43608c9a8db23a622608804d95629616a66da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mfleming/cassandra/commit/b4f43608c9a8db23a622608804d95629616a66da&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17347196" author="jmeredithco" created="Tue, 18 May 2021 22:26:22 +0000"  >&lt;p&gt;+1 from me on 071516d29e41da9924af24e8002822d3c6af0e01 and b4f43608c9a8db23a622608804d95629616a66da . Thanks so much for fixing it and updating the tests. &lt;/p&gt;

&lt;p&gt;I think it fixes the issue you found, and I don&apos;t think it is possible to create an unbounded number of threads in the shared pool by frequently calling &lt;tt&gt;setMaximumPoolSize&lt;/tt&gt; as it only calls schedule if there are no spinning threads, and tries to satisfy itself for work from the parked/spinning pools first.&lt;/p&gt;

&lt;p&gt;I&apos;m slightly concerned about the fixed duration sleep() in the new test given how much variability there is in CI infrastructure timing. Ideally the test would verify that all of the SEPWorkers were parked (and none spinning), but there&apos;s not any straightforward way I can see to do that without refactoring. Worst case is the test doesn&apos;t always cover the all-SEPWorkers parked case every time, but seems unlikely to fail and create a new flaky test.&lt;/p&gt;

&lt;p&gt;On the {{shutdownTest} failures I agree it is unlikely related to the change. Perhaps 100 milliseconds is not long enough for the thread to notice it is being shutdown and exit for the join call. Threads should request a nano sleep for at most 10ms, but are not guaranteed to be awoken on a busy CI server and may exceed the test deadline. What do you think about an increase from 100 milliseconds up to 1 second to see if it improves things?&lt;/p&gt;</comment>
                            <comment id="17348618" author="adelapena" created="Thu, 20 May 2021 16:38:52 +0000"  >&lt;p&gt;+1 on both changes.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;On the {{shutdownTest} failures I agree it is unlikely related to the change. Perhaps 100 milliseconds is not long enough for the thread to notice it is being shutdown and exit for the join call. Threads should request a nano sleep for at most 10ms, but are not guaranteed to be awoken on a busy CI server and may exceed the test deadline. What do you think about an increase from 100 milliseconds up to 1 second to see if it improves things?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Indeed &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/87351868a2b09b605fbd7931e4aba7ef26928ecb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a wait of 1 second&lt;/a&gt; seems to make &lt;tt&gt;shutdownTest&lt;/tt&gt; not to fail anymore, at least not in these 20K runs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/475/workflows/71011b7f-3883-4a73-89cf-552099ff5896/jobs/4200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-j8&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/475/workflows/71011b7f-3883-4a73-89cf-552099ff5896/jobs/4201&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-j11&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/475/workflows/a20f69cd-ec0e-499b-ad7f-0d2e4a92a2fb/jobs/4208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11-j11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think we could include that here, as part of the fix.&lt;/p&gt;

&lt;p&gt;I&apos;m leaving a few very minor suggestions in the commit for &lt;tt&gt;SEPExecutorTest&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17349305" author="edimitrova" created="Fri, 21 May 2021 14:50:58 +0000"  >&lt;p&gt;+1 from me too, if it is fine with the others I can address on commit the nits from Andres later today. Thank you!&lt;/p&gt;</comment>
                            <comment id="17349335" author="adelapena" created="Fri, 21 May 2021 15:30:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;&#160;I have the two patches, the suggestions and few additional minor warning fixes in &lt;a href=&quot;https://github.com/adelapena/cassandra/tree/16668-trunk-review&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this branch&lt;/a&gt;, which is the one used for the CircleCI runs above.&lt;/p&gt;</comment>
                            <comment id="17349349" author="mfleming" created="Fri, 21 May 2021 15:51:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;&#160;your changes look good! Thanks for doing that. +1&lt;/p&gt;</comment>
                            <comment id="17349431" author="edimitrova" created="Fri, 21 May 2021 18:34:02 +0000"  >&lt;p&gt;Committed to 4.0 and propagated to trunk. Thank you all!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13297271">CASSANDRA-15709</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mfleming]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="13163" cascade-level=""><![CDATA[Code]]></customfieldvalue>
                                <customfieldvalue key="13164" cascade-level="1"><![CDATA[Bug - Unclear Impact]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r0ps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[e.dimitrova]]></customfieldvalue>
        <customfieldvalue><![CDATA[jmeredithco]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/8cd02afce972ecaf0e0cf0fe09c610d67d9af9c5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/8cd02afce972ecaf0e0cf0fe09c610d67d9af9c5&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/mfleming/cassandra/commit/071516d29e41da9924af24e8002822d3c6af0e01&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mfleming/cassandra/commit/071516d29e41da9924af24e8002822d3c6af0e01&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>