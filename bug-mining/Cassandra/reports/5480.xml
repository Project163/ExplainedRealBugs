<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14801] calculatePendingRanges no longer safe for multiple adjacent range movements</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14801</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Correctness depended upon the narrowing to a &lt;tt&gt;Set&amp;lt;InetAddressAndport&amp;gt;&lt;/tt&gt;, which we no longer do - we maintain a collection of all &lt;tt&gt;Replica&lt;/tt&gt;.  Our &lt;tt&gt;RangesAtEndpoint&lt;/tt&gt; collection built by &lt;tt&gt;getPendingRanges&lt;/tt&gt; can as a result contain the same endpoint multiple times; and our &lt;tt&gt;EndpointsForToken&lt;/tt&gt; obtained by &lt;tt&gt;TokenMetadata.pendingEndpointsFor&lt;/tt&gt; may fail to be constructed, resulting in cluster-wide failures for writes to the affected token ranges for the duration of the range movement.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13189134">CASSANDRA-14801</key>
            <summary>calculatePendingRanges no longer safe for multiple adjacent range movements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Gerrrr">Alex Sorokoumov</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 3 Oct 2018 11:21:54 +0000</created>
                <updated>Thu, 15 Jul 2021 09:15:42 +0000</updated>
                            <resolved>Mon, 14 Sep 2020 12:11:58 +0000</resolved>
                                        <fixVersion>4.0-beta3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Coordination</component>
                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16918949" author="jolynch" created="Thu, 29 Aug 2019 20:59:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;do you think this should block the first alpha or it can wait for beta?&lt;/p&gt;</comment>
                            <comment id="17054830" author="gerrrr" created="Mon, 9 Mar 2020 10:14:12 +0000"  >&lt;p&gt;Is anyone working on this ticket? If not, I would like to work on it.&lt;/p&gt;</comment>
                            <comment id="17054832" author="benedict" created="Mon, 9 Mar 2020 10:21:53 +0000"  >&lt;p&gt;Nobody is actively working on it, but this is one of the most deceptively complex tickets that needs to be accomplished before 4.0 is released.  I can see you work at DataStax, so perhaps you have the time and skill to dedicate to this, but please be confident before you address it, and be willing to wait a while for a sufficient review.  The class in which the change is needed has had numerous bugs (and in fact has inherent conceptually bugs wrt range movements that are mostly out of scope to address here), so a great deal of care is needed.  Ideally this ticket would attempt to address some of the ugliness that permitted the bug, and &lt;em&gt;certainly&lt;/em&gt; needs to be accompanied by a sophisticated-ish randomised correctness test.&lt;/p&gt;</comment>
                            <comment id="17054911" author="gerrrr" created="Mon, 9 Mar 2020 12:28:10 +0000"  >&lt;p&gt;Thank you for a comprehensive response, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;! I am quite new to C* 4.0 code, so it will take me some time to ramp up. If anyone has planned to work on this issue in the next 1-2 weeks, it probably makes sense for me to work on something else. Otherwise, I&apos;d be happy to contribute.&lt;/p&gt;

&lt;p&gt;In the latter case, in the next couple of days, I plan to read on how pending ranges are calculated and what changes since 3.11 introduced the bug. Then I&apos;ll write a test case that reproduces the issue.&lt;/p&gt;</comment>
                            <comment id="17068746" author="gerrrr" created="Fri, 27 Mar 2020 14:10:55 +0000"  >&lt;p&gt;I reproduced the bug using simple &lt;a href=&quot;https://gist.github.com/Gerrrr/f59dc5dedaf6501bb31d79b068244213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;randomized test&lt;/a&gt; that creates a cluster of N nodes and adds, moves, and removes nodes from it. I also found another bug where &lt;tt&gt;TokenMetadata#calculatePendingRanges&lt;/tt&gt; fails during move-affected replica calculation.&lt;/p&gt;

&lt;p&gt;Patch that addresses both problems (&lt;a href=&quot;https://github.com/apache/cassandra/pull/495&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link to PR&lt;/a&gt;):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a534b2be9a653fb0cdda75043c0b79e481ca1701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a534b2&lt;/a&gt; adds tests that reproduce both bugs.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/bb36cd09c164840ad9ab3231f1039c443f8f040c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bb36cd&lt;/a&gt; fixes the newly discovered bug (&lt;tt&gt;test1Leave1Move&lt;/tt&gt; in &lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a534b2be9a653fb0cdda75043c0b79e481ca1701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a534b2&lt;/a&gt;). There, the failure happens because for the same pending range we can include 2 replicas with the same endpoint and different ranges (violation of &lt;tt&gt;PendingRangeMaps Conflict.DUPLICATE&lt;/tt&gt; policy). This happens because right now we include in &lt;tt&gt;PendingRangeMaps&lt;/tt&gt; the entire new replica after leave for leave-affected ranges and only the pending part of it for move-affected ranges. This commit marks as pending only the missing part of the new replica.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a33b032cd75044db3475505cd32e6afd6f98ad40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a33b03&lt;/a&gt; solves the original issue. Without this commit &lt;tt&gt;getPendingRanges&lt;/tt&gt; can fail if the same replica covers more than 1 pending range. I think that this is a valid situation. Consider &lt;tt&gt;testLeave2&lt;/tt&gt; in &lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a534b2be9a653fb0cdda75043c0b79e481ca1701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a534b2&lt;/a&gt;. In this case replica &lt;tt&gt;Full(127.0.0.1:7012,(-9,0])&lt;/tt&gt; covers 2 ranges - &lt;tt&gt;(-9,-4]&lt;/tt&gt; and &lt;tt&gt;(-4,0]&lt;/tt&gt;. If we run the same test against 3.11 &lt;tt&gt;(-9, 0]&lt;/tt&gt; is represented as {&lt;tt&gt;(-9, -4], (-4, 0]&lt;/tt&gt;} and that possible representation would not trigger the bug in 4.0. However, I think that we should not base safety of &lt;tt&gt;getPendingRanges&lt;/tt&gt; execution on the way a particular &lt;tt&gt;AbstractReplicationStrategy&lt;/tt&gt; represents a range and we should allow duplicate entries while building pending &lt;tt&gt;RangesAtEndpoint&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With these changes, the randomized test hasn&apos;t failed after running for a while. As I mentioned, it is a very simplistic test, so any suggestions for improvement are welcome. I haven&apos;t included it in the PR, as it seems to be a good candidate to become flaky. Maybe it is worth adding as a &lt;tt&gt;long&lt;/tt&gt; test?&lt;/p&gt;</comment>
                            <comment id="17074336" author="michaelsembwever" created="Fri, 3 Apr 2020 07:15:36 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;circleci&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...Gerrrr:14801-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk_14801&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/Gerrrr/workflows/cassandra/tree/14801-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/13/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17075201" author="jmckenzie" created="Sat, 4 Apr 2020 16:42:11 +0000"  >&lt;p&gt;Thanks for raising that this is a thorny area of the code-base where specific care needs to be taken. There would probably be a lot of value in a class level comment on TokenMetaData.java indicating this for future people as they ramp on the code-base (and likely other areas of the code-base as well!).&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I can see you work at DataStax, so perhaps you have the time and skill to dedicate to this, but please be confident before you address it, and be willing to wait a while for a sufficient review.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Regarding &lt;a href=&quot;https://www.apache.org/theapacheway/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;earned authority&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;their influence is based on publicly earned merit &#8211; what they contribute to the community. Merit lies with the individual, does not expire, is not influenced by employment status or employer&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Please refrain from focusing on who is employed by whom and instead focus on their individual merit and contribution to the code-base in the future.&lt;/p&gt;</comment>
                            <comment id="17075318" author="benedict" created="Sat, 4 Apr 2020 22:09:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Please refrain from focusing on who is employed by whom and instead focus on their individual merit and contribution to the code-base in the future.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is the case that new contributors can generally be assumed to have no knowledge of complex areas of the codebase.  There is however precisely one company I am aware of with people who may secretly have the requisite knowledge and skill.  There is also only one company with &lt;em&gt;full time&lt;/em&gt; contributors that were previously unknown to the community, who may have the time to either obtain the necessary skill, or to have weeks to dedicate to difficult tasks such as this.&lt;/p&gt;

&lt;p&gt;Were this to be a random individual, I could quite reasonably just direct them to another ticket.  In this case I thought it was best only to issue a fair warning that this &lt;em&gt;might&lt;/em&gt; not be suitable but that I do not have sufficient knowledge to say for sure.&lt;/p&gt;

&lt;p&gt;I am perceiving a pattern on your part, of choosing to interpret my actions in an unwarrantedly negative light.  Please check yourself, before you check others.&lt;/p&gt;</comment>
                            <comment id="17083399" author="gerrrr" created="Tue, 14 Apr 2020 16:29:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fcofdezc&quot; class=&quot;user-hover&quot; rel=&quot;fcofdezc&quot;&gt;fcofdezc&lt;/a&gt; reviewed the PR and based on his suggestion I re-wrote the randomized test using QuickTheories. As the run time of that test ended comparable to the other unit tests, I included it in the suite as well (&lt;a href=&quot;https://github.com/apache/cassandra/pull/495/commits/a0246e1e8ba481b98f76896e5005e9a8cc277586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a0246e&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17189625" author="beobal" created="Wed, 2 Sep 2020 18:30:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;, this looks pretty good to me, with a few caveats regarding the QT test.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Move operations are not permitted when nodes have multiple tokens, so I think we can split the test into:
	&lt;ul&gt;
		&lt;li&gt;multiple tokens per node with leave and bootstrap operations.&lt;/li&gt;
		&lt;li&gt;single token nodes with leave, bootstrap and move operations.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Any node should be moved at most once per &lt;tt&gt;Cluster&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The rf for each cluster was being hardcoded to 2, we ought to use &lt;tt&gt;Input.rf&lt;/tt&gt; when constructing &lt;tt&gt;Cluster&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve pushed a commit with those suggestions &lt;a href=&quot;https://github.com/beobal/cassandra/tree/14801-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and kicked off CI &lt;a href=&quot;https://app.circleci.com/pipelines/github/beobal/cassandra?branch=14801-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Would you mind taking a look at the suggestions?&lt;/p&gt;</comment>
                            <comment id="17190073" author="gerrrr" created="Thu, 3 Sep 2020 11:40:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; Your suggestions look good! As a nitpick, I propose to replace the while-true loop with filtering out moving nodes and selecting one from what&apos;s left (&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/8d6dfc090da2a49dcc07c65029f33deeff7e186b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;8d6dfc090da2a&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17190326" author="beobal" created="Thu, 3 Sep 2020 17:37:28 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;, looks good as far as I&apos;m concerned. I&apos;ve pulled in your patch and I&apos;m happy to commit pending CI and a second +1.&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#8203;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14801-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;14801-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/beobal/cassandra?branch=14801-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&#8203;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17195414" author="krummas" created="Mon, 14 Sep 2020 11:59:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17195426" author="krummas" created="Mon, 14 Sep 2020 12:11:58 +0000"  >&lt;p&gt;and committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="13183397">CASSANDRA-14697</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Gerrrr]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ys47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/8ba163f25a56cb507e621b89b6928c2aef0ecc57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/8ba163f25a56cb507e621b89b6928c2aef0ecc57&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a534b2be9a653fb0cdda75043c0b79e481ca1701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a534b2&lt;/a&gt; adds tests that reproduce both bugs.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/bb36cd09c164840ad9ab3231f1039c443f8f040c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bb36cd&lt;/a&gt; fixes the newly discovered bug (&lt;tt&gt;test1Leave1Move&lt;/tt&gt; in &lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a534b2be9a653fb0cdda75043c0b79e481ca1701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a534b2&lt;/a&gt;). There, the failure happens because for the same pending range we can include 2 replicas with the same endpoint and different ranges (violation of &lt;tt&gt;PendingRangeMaps Conflict.DUPLICATE&lt;/tt&gt; policy). This happens because right now we include in &lt;tt&gt;PendingRangeMaps&lt;/tt&gt; the entire new replica after leave for leave-affected ranges and only the pending part of it for move-affected ranges. This commit marks as pending only the missing part of the new replica.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a33b032cd75044db3475505cd32e6afd6f98ad40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a33b03&lt;/a&gt; solves the original issue. Without this commit &lt;tt&gt;getPendingRanges&lt;/tt&gt; can fail if the same replica covers more than 1 pending range. I think that this is a valid situation. Consider &lt;tt&gt;testLeave2&lt;/tt&gt; in &lt;a href=&quot;https://github.com/Gerrrr/cassandra/commit/a534b2be9a653fb0cdda75043c0b79e481ca1701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a534b2&lt;/a&gt;. In this case replica &lt;tt&gt;Full(127.0.0.1:7012,(-9,0])&lt;/tt&gt; covers 2 ranges - &lt;tt&gt;(-9,-4]&lt;/tt&gt; and &lt;tt&gt;(-4,0]&lt;/tt&gt;. If we run the same test against 3.11 &lt;tt&gt;(-9, 0]&lt;/tt&gt; is represented as {{
{(-9, -4], (-4, 0]}
&lt;p&gt;}} and that possible representation would not trigger the bug in 4.0. However, I think that we should not base safety of &lt;tt&gt;getPendingRanges&lt;/tt&gt; execution on the way a particular &lt;tt&gt;AbstractReplicationStrategy&lt;/tt&gt; represents a range and we should allow duplicate entries while building pending &lt;tt&gt;RangesAtEndpoint&lt;/tt&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>