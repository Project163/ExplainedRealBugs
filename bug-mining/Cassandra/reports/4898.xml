<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13794] Fix short read protection logic for querying more rows</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13794</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Discovered by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; while reviewing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13747&quot; title=&quot;Fix AssertionError in short read protection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13747&quot;&gt;&lt;del&gt;CASSANDRA-13747&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;While reviewing I got a little suspicious of the modified line &lt;tt&gt;DataResolver&lt;/tt&gt; :479, as it seemed that n and x were the wrong way around... and, reading the comment of intent directly above, and reproducing the calculation, they are indeed.&lt;/p&gt;

&lt;p&gt;This is probably a significant enough bug that it warrants its own ticket for record keeping, though I&apos;m fairly agnostic on that decision.&lt;/p&gt;

&lt;p&gt;I&apos;m a little concerned about our current short read behaviour, as right now it seems we should be requesting exactly one row, for any size of under-read, which could mean extremely poor performance in case of large under-reads.&lt;/p&gt;

&lt;p&gt;I would suggest that the outer unconditional &lt;tt&gt;Math.max&lt;/tt&gt; is a bad idea, has been (poorly) insulating us from this error, and that we should first be asserting that the calculation yields a value &amp;gt;= 0 before setting to 1.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13097299">CASSANDRA-13794</key>
            <summary>Fix short read protection logic for querying more rows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                            <label>Correctness</label>
                    </labels>
                <created>Thu, 24 Aug 2017 12:36:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:01 +0000</updated>
                            <resolved>Wed, 20 Sep 2017 16:59:45 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16152884" author="iamaleksey" created="Mon, 4 Sep 2017 19:28:08 +0000"  >&lt;p&gt;Work in progress branch &lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13794-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Currently missing (new) tests, but I want to get the underlying logic reviewed and approved, first. Would add coverage before committing it.&lt;/p&gt;

&lt;p&gt;A short summary of the issue: the code right now has two variables swapped, which ultimately results in us always fetching 1 extra row per short read protection requests, in a blocking manner, making it very inefficient. But upon closer look, there are some other inefficiencies here that can and should be addressed:&lt;/p&gt;

&lt;p&gt;1. One of our stop conditions is &lt;tt&gt;lastCount == counter.counted()&lt;/tt&gt;. It&apos;s supposed to abort a short read if our previous attempt to fetch more rows yielded 0 extra rows. It&apos;s not incorrect, but is only a special case of the more general scenario: our previous attempt to fetch more extra rows yielded fewer results than we requested for. That would mean there is no more rows to fetch at that replica, and allows us to abort earlier and more frequently.&lt;/p&gt;

&lt;p&gt;2. Another of our stop conditions is &lt;tt&gt;!counter.isDoneForPartition()&lt;/tt&gt;. Once again, it isn&apos;t incorrect, but it can be extended further. Due to the way &lt;tt&gt;isDoneForPartition()&lt;/tt&gt; is defined (&lt;tt&gt;isDone() || rowInCurrentPartition &amp;gt;= perPartitionLimit&lt;/tt&gt;) and because of that counter being counting-only, it is possible for us to have fetched enough rows total for other partitions short read retries previously to hit the global limit of rows in the counter. That would make &lt;tt&gt;isDone()&lt;/tt&gt; return &lt;tt&gt;true&lt;/tt&gt; always, and have &lt;tt&gt;isDoneForPartition()&lt;/tt&gt; return false positives even if the partition currently processed only has a partition level deletion and/or tombstones. That can affect queries that set per partition limit explicitly or when running &lt;tt&gt;SELECT DISTINCT&lt;/tt&gt; queries. Spotted that during &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13747&quot; title=&quot;Fix AssertionError in short read protection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13747&quot;&gt;&lt;del&gt;CASSANDRA-13747&lt;/del&gt;&lt;/a&gt; fixing.&lt;/p&gt;

&lt;p&gt;3. Once we&apos;ve swapped &lt;tt&gt;x&lt;/tt&gt; and &lt;tt&gt;n&lt;/tt&gt; in &lt;tt&gt;moreContents()&lt;/tt&gt; to fix the logic error, we&apos;d still have some issues. In degenerate cases where we have some nodes missing a fresh partition deletion, for example, the formula would fetch &lt;b&gt;a lot&lt;/b&gt; of rows &lt;tt&gt;n * (n - 1)&lt;/tt&gt;, with &lt;tt&gt;n&lt;/tt&gt; growing exponentially with every attempt.&lt;/p&gt;

&lt;p&gt;Upon closer inspection, the formula doesn&apos;t make 100% sense. It claims that we miss &lt;tt&gt;n - x&lt;/tt&gt; rows - where &lt;tt&gt;n = counter.countedInCurrentPartition()&lt;/tt&gt; and &lt;tt&gt;x = postReconciliationCounter.countedInCurrentPartition()&lt;/tt&gt;, but the number we really miss is &lt;tt&gt;limit - postReconciliationCounter.counted()&lt;/tt&gt; or &lt;tt&gt;perPartitionLimit - postReconciliationCounter.countedInCurrentPartition()&lt;/tt&gt;. They might be the same on our first short read protection iteration, but will be diverging further and further with each request. In addition to that, it seems to assume a uniform distribution of tombstones (in the end result) rows in the source partition, which can&apos;t be true for most workloads.&lt;/p&gt;

&lt;p&gt;I couldn&apos;t come up with some ideal heuristic that covers all workloads, so I stuck to something safe that respects client paging limits but still attempts to minimise the # of requests we make by fetching (in most cases) more rows than is minimally necessary. I&apos;m not completely sure about it, but I welcome any ideas on how to make it better. Either way, anything we do should be significantly more efficient than what we have now.&lt;/p&gt;

&lt;p&gt;I&apos;ve also made some renames, refactorings, and moved a few things around to better understand the code myself, and make it clearer for future contributors - including future me. The most significant noticeable change is application of the per-response counter shift to &lt;tt&gt;mergeWithShortReadProtection()&lt;/tt&gt; method, instead of overloading &lt;tt&gt;ShortReadRowProtection&lt;/tt&gt; with responsibilities - I also like it to be next to the global counter creation, so you can see the contrast in arguments.&lt;/p&gt;</comment>
                            <comment id="16152886" author="iamaleksey" created="Mon, 4 Sep 2017 19:29:17 +0000"  >&lt;p&gt;Marking the ticket as &lt;tt&gt;Patch Available&lt;/tt&gt;, despite its lack of (new) tests, so that it can be reviewed first. Tests will be committed with the rest of the code.&lt;/p&gt;</comment>
                            <comment id="16166838" author="benedict" created="Thu, 14 Sep 2017 19:13:06 +0000"  >&lt;p&gt;This patch is great (excepting a couple of extraneous edits).  Love the comments.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I would suggest filing two follow-up tickets to address some short comings with this code path, but they&apos;re edge-case, and not straight-forward enough, to not block this merge.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;For some extreme users, 16 rows could be a huge amount of data.  There should probably be some modulation of this lower bound based on known data sizes in the table, or the like.&lt;/li&gt;
	&lt;li&gt;Conversely, in an overloaded cluster on which users are commonly performing fairly large-limit reads (say, 1k+ moderate sized rows) of larger partitions, we could find ourselves doubling the amount of work the cluster needs to do; during overload we can expect dropped writes, and a single missing row in any read would trigger a same-sized read.  This could iteratively compound the overload.&lt;br/&gt;
 The best solutions to this problem are probably non-trivial, though a simplish approach might be to use exponential growth, bounded on both sides by a minimum and maximum (perhaps similarly determined from the known data size distribution) - with the query limit being used as the first value if it is small enough.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I &lt;em&gt;would&lt;/em&gt; say that (2) is no worse than the status-quo, given the per-request overheads are probably greater than the per-datum overheads in a typical cluster, but &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12872&quot; title=&quot;Fix short read protection when more than one row is missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12872&quot;&gt;&lt;del&gt;CASSANDRA-12872&lt;/del&gt;&lt;/a&gt; suggests we haven&apos;t been incurring the full overheads of SRP, so we cannot claim that.  I still think it is reasonable to address this in a follow-up ticket, however.&lt;/p&gt;</comment>
                            <comment id="16173500" author="iamaleksey" created="Wed, 20 Sep 2017 16:59:24 +0000"  >&lt;p&gt;Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/f93e6e3401c343dec74687d8b079b5697813ab28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;f93e6e3401c343dec74687d8b079b5697813ab28&lt;/a&gt; and merged with 3.11 and trunk.&lt;/p&gt;

&lt;p&gt;Circle run for 3.0 &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/39&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; has two completely unrelated &lt;tt&gt;CommitLogSegmentManagerTest&lt;/tt&gt; failures, and &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/314/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest run&lt;/a&gt; here is mostly failures to git clone.&lt;/p&gt;

&lt;p&gt;The passing tests include the 3 new dtests added since this JIRA was created. My initial plan was to cover it with proper unit tests, too - similar to read repair tests we have - but doing it properly has proven to be too time consuming. In addition to the tests we have, I did a lot of manual testing (which uncovered a couple more issues - not affecting my branch). But more unit test coverage will be added later - we&apos;ve budgeted a significant chunk of time on &lt;tt&gt;DataResolver&lt;/tt&gt; testing alone.&lt;/p&gt;

&lt;p&gt;Follow up JIRAs I&apos;ll file soonish. Thanks for the review! &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13092855">CASSANDRA-13747</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j8kn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>