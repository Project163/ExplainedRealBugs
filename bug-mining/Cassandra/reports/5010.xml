<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14286] IndexOutOfBoundsException with SELECT JSON using IN and ORDER BY</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14286</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CassandraJsonOrderingBug {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        Session session = CassandraFactory.getSession();

        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE thebug ( PRIMARY KEY (a, b), a INT, b INT)&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO thebug (a, b) VALUES (20, 30)&quot;&lt;/span&gt;);
            session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO thebug (a, b) VALUES (100, 200)&quot;&lt;/span&gt;);
            Statement statement = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT JSON a, b FROM thebug WHERE a IN (20, 100) ORDER BY b&quot;&lt;/span&gt;);
            statement.setFetchSize(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Row w: session.execute(statement)) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(w.toString());
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;DROP TABLE thebug&quot;&lt;/span&gt;);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following exception is thrown server-side:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IndexOutOfBoundsException: Index: 1, Size: 1
	at java.util.Collections$SingletonList.get(Collections.java:4815) ~[na:1.8.0_151]
	at org.apache.cassandra.cql3.statements.SelectStatement$SingleColumnComparator.compare(SelectStatement.java:1297) ~[apache-cassandra-3.11.1.jar:3.11.1]
	at org.apache.cassandra.cql3.statements.SelectStatement$SingleColumnComparator.compare(SelectStatement.java:1284) ~[apache-cassandra-3.11.1.jar:3.11.1]
	at java.util.TimSort.countRunAndMakeAscending(TimSort.java:355) ~[na:1.8.0_151]
	at java.util.TimSort.sort(TimSort.java:220) ~[na:1.8.0_151]
	at java.util.Arrays.sort(Arrays.java:1512) ~[na:1.8.0_151]
	at java.util.ArrayList.sort(ArrayList.java:1460) ~[na:1.8.0_151]
	at java.util.Collections.sort(Collections.java:175) ~[na:1.8.0_151]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(full traceback attached)&lt;/p&gt;

&lt;p&gt;The accessed index is the index of the sorted column in the SELECT JSON fields list.&lt;br/&gt;
Similarly, if the select clause is changed to&lt;/p&gt;

&lt;p&gt;SELECT JSON b, a FROM thebug WHERE a IN (20, 100) ORDER BY b&lt;/p&gt;

&lt;p&gt;then the query finishes, but the output is sorted incorrectly (by textual JSON representation):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Row[{&quot;b&quot;: 200, &quot;a&quot;: 100}]
Row[{&quot;b&quot;: 30, &quot;a&quot;: 20}]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Kubernetes cluster using&#160;cassandra:3.11.1 Docker image.&lt;/p&gt;</environment>
        <key id="13142178">CASSANDRA-14286</key>
            <summary>IndexOutOfBoundsException with SELECT JSON using IN and ORDER BY</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fcofdezc">Francisco Fernandez</assignee>
                                    <reporter username="accek-invinets">Szymon Aceda&#324;ski</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Mar 2018 19:26:19 +0000</created>
                <updated>Fri, 15 May 2020 08:01:54 +0000</updated>
                            <resolved>Tue, 17 Apr 2018 10:45:04 +0000</resolved>
                                        <fixVersion>2.2.13</fixVersion>
                    <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16409339" author="fcofdezc" created="Thu, 22 Mar 2018 10:21:44 +0000"  >&lt;p&gt;The problem was that columns were serialized as&#160;json and then discarded, while &lt;tt&gt;OrderingComparator&lt;/tt&gt; expected those columns to be present. With this patch, all columns are present and only the json column is sent back to clients. It uses the same mechanism as the regular ordering of non-selected columns.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:14286-2.2-review&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Patch 2.2&lt;/a&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...fcofdez:14286-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Patch 3.0&lt;/a&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...fcofdez:14286-3.11?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Patch 3.11&lt;/a&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...fcofdez:14286-trunk-2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Patch trunk&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16425693" author="blerer" created="Wed, 4 Apr 2018 15:17:51 +0000"  >&lt;p&gt;Patches and test results look fine. Thanks.&lt;/p&gt;</comment>
                            <comment id="16427144" author="blerer" created="Thu, 5 Apr 2018 15:45:21 +0000"  >&lt;p&gt;I just noticed while merging a problem with the trunk patch. In trunk &lt;tt&gt;Selection&lt;/tt&gt; is immutable but the patch is breaking that contract.&lt;/p&gt;

&lt;p&gt;Sorry, for noticing that problem only now.&lt;/p&gt;</comment>
                            <comment id="16430386" author="fcofdezc" created="Mon, 9 Apr 2018 11:15:12 +0000"  >&lt;p&gt;I&apos;ve updated the trunk patch with the suggested approach, let me know if there is something that should be changed. Thanks for the review.&lt;/p&gt;</comment>
                            <comment id="16440597" author="blerer" created="Tue, 17 Apr 2018 08:33:51 +0000"  >&lt;p&gt;I looked at the trunk patch. For queries with selection clauses having some processing like: &lt;tt&gt;SELECT JSON a, CAST(b AS FLOAT) FROM %s WHERE a IN (20, 100) ORDER BY b&lt;/tt&gt;. The query will fail with an &lt;tt&gt;IndexOutOfBoundException&lt;/tt&gt; during the &lt;tt&gt;Selection&lt;/tt&gt; initialization.&lt;/p&gt;

&lt;p&gt;I looked into the problem and pushed a correction to the patch &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:14286-trunk-review&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. CI results look good.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fcofdezc&quot; class=&quot;user-hover&quot; rel=&quot;fcofdezc&quot;&gt;fcofdezc&lt;/a&gt; Could you have a look at my changes and tell me if they make sense to you?&lt;/p&gt;</comment>
                            <comment id="16440645" author="fcofdezc" created="Tue, 17 Apr 2018 09:14:22 +0000"  >&lt;p&gt;I see the problem now, thanks for pointing out. The code seems less complicated with your approach, so +1. Only one nit: there is a &lt;tt&gt;println&lt;/tt&gt; on &lt;tt&gt;Selection.java&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16440736" author="blerer" created="Tue, 17 Apr 2018 10:45:04 +0000"  >&lt;p&gt;Committed into 2.2 at 594cde7937de6f848998bac35d35591f8a18aa10 and merged into 3.0, 3.11 and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12912816" name="orderbug-traceback.txt" size="11997" author="accek-invinets" created="Fri, 2 Mar 2018 19:23:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[fcofdezc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qt53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332983">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>