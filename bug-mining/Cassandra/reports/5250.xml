<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15364] Avoid over scanning data directories in LogFile.verify()</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15364</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We currently list the data directory for every &lt;tt&gt;REMOVE&lt;/tt&gt; record in the file in &lt;tt&gt;LogFile.verify()&lt;/tt&gt; - this can get very expensive during startup when we call &lt;tt&gt;LogTransaction.removeUnfinishedLeftovers()&lt;/tt&gt;. In &lt;tt&gt;LogRecord.getExistingFiles(Set&amp;lt;String&amp;gt; absoluteFilePaths)&lt;/tt&gt; we also fully parse the file name of the sstables found, here we only need to prefix match.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13263081">CASSANDRA-15364</key>
            <summary>Avoid over scanning data directories in LogFile.verify()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Oct 2019 11:30:21 +0000</created>
                <updated>Fri, 15 May 2020 08:39:11 +0000</updated>
                            <resolved>Wed, 11 Dec 2019 08:11:51 +0000</resolved>
                                        <fixVersion>3.0.20</fixVersion>
                    <fixVersion>3.11.6</fixVersion>
                    <fixVersion>4.0-alpha3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16954535" author="krummas" created="Fri, 18 Oct 2019 11:53:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/15364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; - this lists the files only once and improves performance of getExistingFiles by using a TreeSet containing the file name prefixes. In my silly laptop local benchmark (verifying a LogFile with 2000 remove records in a directory with 2000 sstables), unpatched takes 35s and patched about 150ms.&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/krummas/workflows/cassandra/tree/marcuse%2F15364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16956431" author="dcapwell" created="Mon, 21 Oct 2019 20:35:04 +0000"  >&lt;ul&gt;
	&lt;li&gt;As a general comment, almost every case I see where absolutePath.ifPresent is called is known to be a ADD or REMOVE so the lambda version could be replaced with .get() (style comment, feel free to ignore)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:marcuse/15364#diff-d8721a4dd04f4f35b65e7edeb6c883f6R357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...krummas:marcuse/15364#diff-d8721a4dd04f4f35b65e7edeb6c883f6R357&lt;/a&gt;&lt;br/&gt;
 The makeRecord call above will do a listing (in make(Type, SSTable) method), so this change looks to be because deleteRecordFiles(LogRecord) no longer exists and was replaced by deleteRecordFiles(List&amp;lt;File&amp;gt;); LGTM&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:marcuse/15364#diff-d8721a4dd04f4f35b65e7edeb6c883f6R386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...krummas:marcuse/15364#diff-d8721a4dd04f4f35b65e7edeb6c883f6R386&lt;/a&gt;&lt;br/&gt;
 Is this to handle failure in the middle of the log (while deleting on commit we hard-stop in the middle, so recovery may see missing files)? Seems fine, was just curious if there was a different reason (there was a comment in the code about people copying tx files to different nodes, hence why I wanted to call out).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:marcuse/15364#diff-2e4c884e6aace427bdb6b0a122164ce4R308-R328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...krummas:marcuse/15364#diff-2e4c884e6aace427bdb6b0a122164ce4R308-R328&lt;/a&gt;&lt;br/&gt;
 Took a while to parse this change, so I am curious what was the motivation? Was it just to avoid File::getCanonicalPath? As far as I can tell Descriptor::fromFilenameWithComponent is only string parsing with a call to File::getCanonicalFile.&lt;br/&gt;
 While reading this change, what bothered me was the question &quot;why is the file name a prefix&quot; and I missed the comment in the javadoc which expresses that expectation (&quot;absoluteFilePaths contains full file parts up to the component name&quot;, &quot;up to&quot; being the important part); the code before relied on Descriptor:fromFilename so didn&apos;t really care.&lt;br/&gt;
The new version looks fine, I just wanted to better understand the motive&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Overall, looks good to me; I want to do one more pass and test this, ETA EOD.&lt;/p&gt;</comment>
                            <comment id="16956580" author="dcapwell" created="Tue, 22 Oct 2019 01:27:55 +0000"  >&lt;p&gt;FYI I created a quick JMH to show the difference between the TreeSet version and the canonical file version; here are the results (too lazy to run long enough, stoped after iterations became stable... only ran on Mac...)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Number of Components: 5&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# 1 SSTable
* Before : ~30031.749 ops/s
* After  : ~42116.323 ops/s
# 20000
* Before : ~0.328 ops/s
* After  : ~4.523 ops/s
* Before w/abspath : ~3.133 ops/s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The last one is when I switched from&#160;FileUtils.getCanonicalPath to&#160;new File(baseFilename).getAbsolutePath() (though, descriptor still calls getCanonicalFile).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;LGTM.&lt;/p&gt;</comment>
                            <comment id="16956588" author="dcapwell" created="Tue, 22 Oct 2019 01:45:13 +0000"  >&lt;p&gt;Ran locally and ran with a debugger to monitor file listings; this lowers the listing on startup to a handful per table.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16957064" author="krummas" created="Tue, 22 Oct 2019 13:35:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;As a general comment, almost every case I see where absolutePath.ifPresent is called is known to be a ADD or REMOVE&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;guess I could add asserts that it exists instead, would probably be clearer&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is this to handle failure in the middle of the log (while deleting on commit we hard-stop in the middle, so recovery may see missing files)?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;the null check is unnecessary, I&apos;ll remove it&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Took a while to parse this change, so I am curious what was the motivation?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I was mostly worried that this patch would slow things down in the &quot;normal case&quot; (a tiny number of remove records in a directory with many files) by parsing the filename and creating a Descriptor for every file in the directory when we really don&apos;t have to.&lt;/p&gt;</comment>
                            <comment id="16959213" author="jrwest" created="Thu, 24 Oct 2019 20:54:15 +0000"  >&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&apos;s evaluation that this reduces file listing calls considerably. Some code comments below. None are serious or required, so +1:&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;LogFile#deleleFilesForRecordOfType&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Unless its truly exceptional and requires throwing, I prefer the filtering approach to getting rid of non-present absolute paths (like the code below). If it is something we should throw for, consider adding a description to the assert or a more descriptive exception.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
records.stream()
       .filter(r -&amp;gt; type.matches(r) &amp;amp;&amp;amp; r.absolutePath.isPresent())
       .forEach(r -&amp;gt; absolutePaths.add(r.absolutePath.get()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Regarding the second for loop in this method, could it instead iterate over absolutePaths, which is already filtered (regardless of the suggestion above) for paths matched by type and having the path present in the record? This would save a few calls/branches, and reduce the need for the repeated assert.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In LogFile#verify, these are truly minor nits and personal style, it could be argued they are less efficient but I prefer the more java 8 like approach to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;#L160-1: &lt;tt&gt;records.forEach(r -&amp;gt; r.absolutePath.ifPresent(absolutePaths::add))&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;#L164-173:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (LogRecord record : records)
{
    List&amp;lt;File&amp;gt; existingFiles = record.absolutePath.flatMap(k -&amp;gt; Optional.ofNullable(recordFiles.get(k)))
                                                  .orElse(Collections.emptyList());
    LogFile.verifyRecord(record, existingFiles);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16960882" author="krummas" created="Mon, 28 Oct 2019 09:25:53 +0000"  >&lt;p&gt;pushed a commit which adds an explanation to the assert and changes the second loop to iterate over the values of the map instead&lt;/p&gt;</comment>
                            <comment id="16961188" author="dcapwell" created="Mon, 28 Oct 2019 15:57:34 +0000"  >&lt;p&gt;Assert msg looks good to me; loop assumes the above asserts ran so can safely loop over the files.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16993286" author="krummas" created="Wed, 11 Dec 2019 08:11:51 +0000"  >&lt;p&gt;And committed, thanks&lt;/p&gt;

&lt;p&gt;tests: &lt;a href=&quot;https://circleci.com/workflow-run/96079445-bfe1-4a54-a7e3-94ed4d93d72a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;a href=&quot;https://circleci.com/workflow-run/2cebe9b9-9547-4336-b78f-08b71ff2e63d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;a href=&quot;https://circleci.com/workflow-run/3f11f211-6b4d-44f7-bf42-f9da96512853&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07q8g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332361">3.0 alpha 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/af963e3a7318aad177bc1b985478d4a598b51d9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/af963e3a7318aad177bc1b985478d4a598b51d9c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;circle ci run&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>