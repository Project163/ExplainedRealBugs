<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5540] Concurrent secondary index updates remove rows from the index</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5540</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Existing rows disappear from secondary index when doing simultaneous updates of a row with the same secondary index value.&lt;/p&gt;

&lt;p&gt;Here is a little pycassa script that reproduces a bug. The script inserts 4 rows with same secondary index value, reads those rows back and check that there are 4 of them.&lt;br/&gt;
Please run two instances of the script simultaneously in two separate terminals in order to simulate concurrent updates:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-----scrpit.py START-----
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pycassa
from pycassa.index &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; *

pool = pycassa.ConnectionPool(&lt;span class=&quot;code-quote&quot;&gt;&apos;ks123&apos;&lt;/span&gt;)
cf = pycassa.ColumnFamily(pool, &lt;span class=&quot;code-quote&quot;&gt;&apos;cf1&apos;&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; True:
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; rowKey in xrange(4):
        cf.insert(str(rowKey), {&lt;span class=&quot;code-quote&quot;&gt;&apos;indexedColumn&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;indexedValue&apos;&lt;/span&gt;})

    index_expression = create_index_expression(&lt;span class=&quot;code-quote&quot;&gt;&apos;indexedColumn&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;indexedValue&apos;&lt;/span&gt;)
    index_clause = create_index_clause([index_expression])
    rows = cf.get_indexed_slices(index_clause)
    length = len(list(rows))
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; length == 4:
        pass
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
        print &lt;span class=&quot;code-quote&quot;&gt;&apos;found just %d rows out of 4&apos;&lt;/span&gt; % length

pool.dispose()

---script.py FINISH---

---schema cli start---
create keyspace ks123
  with placement_strategy = &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;
  and strategy_options = {datacenter1 : 1}
  and durable_writes = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

use ks123;

create column family cf1
  with column_type = &lt;span class=&quot;code-quote&quot;&gt;&apos;Standard&apos;&lt;/span&gt;
  and comparator = &lt;span class=&quot;code-quote&quot;&gt;&apos;AsciiType&apos;&lt;/span&gt;
  and default_validation_class = &lt;span class=&quot;code-quote&quot;&gt;&apos;AsciiType&apos;&lt;/span&gt;
  and key_validation_class = &lt;span class=&quot;code-quote&quot;&gt;&apos;AsciiType&apos;&lt;/span&gt;
  and read_repair_chance = 0.1
  and dclocal_read_repair_chance = 0.0
  and populate_io_cache_on_flush = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  and gc_grace = 864000
  and min_compaction_threshold = 4
  and max_compaction_threshold = 32
  and replicate_on_write = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  and compaction_strategy = &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;
  and caching = &lt;span class=&quot;code-quote&quot;&gt;&apos;KEYS_ONLY&apos;&lt;/span&gt;
  and column_metadata = [
    {column_name : &lt;span class=&quot;code-quote&quot;&gt;&apos;indexedColumn&apos;&lt;/span&gt;,
    validation_class : AsciiType,
    index_name : &lt;span class=&quot;code-quote&quot;&gt;&apos;INDEX1&apos;&lt;/span&gt;,
    index_type : 0}]
  and compression_options = {&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.SnappyCompressor&apos;&lt;/span&gt;};
---schema cli finish---
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Test cluster created with &apos;ccm create --cassandra-version 1.2.4 --nodes 1 --start testUpdate&apos;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646193">CASSANDRA-5540</key>
            <summary>Concurrent secondary index updates remove rows from the index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="alexeibakanov">Alexei Bakanov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 May 2013 11:04:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:13 +0000</updated>
                            <resolved>Thu, 9 May 2013 22:42:02 +0000</resolved>
                                        <fixVersion>1.2.5</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13650050" author="jbellis" created="Mon, 6 May 2013 20:01:08 +0000"  >&lt;p&gt;Hmm.  It looks like this can happen when multiple inserts happen at the same timestamp, since we delete the existing entry with its own timestamp.  But if the replacement has the same timestamp, then the tombstone wins the tie.&lt;/p&gt;

&lt;p&gt;Any clever ideas to fix this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13650762" author="beobal" created="Tue, 7 May 2013 12:30:02 +0000"  >&lt;p&gt;I don&apos;t think this is caused by the index updates in KeysSearcher. There, we only compare the values &amp;amp; since this test always writes the same values the index entry is never deemed stale, and so we don&apos;t ever write a tombstone. &lt;/p&gt;

&lt;p&gt;The test script does reproduce the issue completely reliably though, so I&apos;ll dig in and find the actual cause.&lt;/p&gt;</comment>
                            <comment id="13650932" author="beobal" created="Tue, 7 May 2013 14:58:56 +0000"  >&lt;p&gt;Sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; I misunderstood, I see what you mean now. No clever ideas yet, but I&apos;m working on it.&lt;/p&gt;</comment>
                            <comment id="13650966" author="jbellis" created="Tue, 7 May 2013 15:32:06 +0000"  >&lt;p&gt;Can we just special-case StandardUpdater.update to check for oldColumn.equals(column) and no-op that?&lt;/p&gt;

&lt;p&gt;(NB I think the compaction code that calls &lt;tt&gt;remove&lt;/tt&gt; would need to check for &lt;tt&gt;.equals&lt;/tt&gt; instead of &lt;tt&gt;==&lt;/tt&gt; as well.)&lt;/p&gt;</comment>
                            <comment id="13650975" author="beobal" created="Tue, 7 May 2013 15:43:07 +0000"  >&lt;p&gt;Can we just remove the deletion from StandardUpdater.update() altogether? That seems to be fine for realtime updates (I no longer see the missing rows &amp;amp; all unit tests are passing) but will it screw with compaction?&lt;/p&gt;</comment>
                            <comment id="13650981" author="jbellis" created="Tue, 7 May 2013 15:48:54 +0000"  >&lt;p&gt;Right, the reason that&apos;s there is that compaction can&apos;t know to purge the stale index entries for values that never made it into an sstable.&lt;/p&gt;</comment>
                            <comment id="13651361" author="beobal" created="Tue, 7 May 2013 21:59:41 +0000"  >&lt;p&gt;Checking oldColumn.equals(column) in SU.update() isn&apos;t sufficient. I found that even with the short circuit, occasionally the test script would return only 3 of the 4 expected columns. My suspicion is that this is caused by the delete &amp;amp; subsequent insert in SU.update() being non-atomic, though I haven&apos;t proved this. Rather than go down that rabbit hole, I&apos;ve split the Updater implementation into 2 subclasses - LiveUpdater &amp;amp; CompactionUpdater. The difference between them is that the CU behaves like SU and always purges old values, whereas LU just upserts into the index. SIM.updaterFor() now takes a second argument to determine whether the updater is for processing live updates or for use during compaction.&lt;/p&gt;

&lt;p&gt;Unit tests pass &amp;amp; the test script runs without issue.&lt;/p&gt;</comment>
                            <comment id="13651991" author="jbellis" created="Wed, 8 May 2013 15:32:16 +0000"  >&lt;p&gt;How does this avoid leaking index entries that will never be cleaned up by compaction?&lt;/p&gt;</comment>
                            <comment id="13652893" author="beobal" created="Thu, 9 May 2013 12:10:09 +0000"  >&lt;p&gt;yes, you&apos;re right that&apos;s dumb sorry. &lt;/p&gt;

&lt;p&gt;It took me a while, but there&apos;s actually 2 issues here. The first, as you identified, is caused by overwrites with identical timestamps and is fixed by making the case where oldColumn.equals(newColumn) a no-op. The second is the window of inconsistency that I mentioned earlier. When the 2 instances of the test script are running, its possible for one to query the index while inbetween the old index entry being deleted &amp;amp; the new one inserted, leading to a &quot;missing&quot; result. To address that, I&apos;ve reversed the order so that the new entry is added before the old one is removed. This should be safe for readers due to the checking for stale values in the index searcher. &lt;/p&gt;</comment>
                            <comment id="13653333" author="jbellis" created="Thu, 9 May 2013 22:42:02 +0000"  >&lt;p&gt;LGTM; committed.&lt;/p&gt;</comment>
                            <comment id="13653560" author="alexeibakanov" created="Fri, 10 May 2013 05:43:47 +0000"  >&lt;p&gt;Fabulous! Thank you very much for the fix!&lt;/p&gt;</comment>
                            <comment id="13773286" author="rcoli" created="Fri, 20 Sep 2013 18:38:45 +0000"  >&lt;p&gt;Is it a correct assessment that this issues &quot;affects&quot; begins with the initial implementation of 2i in 0.7? If not, when?&lt;/p&gt;</comment>
                            <comment id="13773309" author="jbellis" created="Fri, 20 Sep 2013 19:04:14 +0000"  >&lt;p&gt;No, affects 1.2.0+ as indicated.&lt;/p&gt;</comment>
                            <comment id="13773518" author="rcoli" created="Fri, 20 Sep 2013 22:25:28 +0000"  >&lt;p&gt;Oh, weird. I see &quot;affects&quot; in the history but don&apos;t see it in the &quot;Details&quot; section.&lt;/p&gt;

&lt;p&gt;Probably I just need to configure my JIRA better, sorry for the noise.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12582179" name="0001-Use-different-index-updater-for-live-updates-compact.patch" size="8436" author="samt" created="Tue, 7 May 2013 21:59:41 +0000"/>
                            <attachment id="12582457" name="5540.txt" size="3392" author="samt" created="Thu, 9 May 2013 12:10:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326551</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kc4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326896</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>