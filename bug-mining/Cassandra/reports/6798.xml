<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:33:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19703] Newly inserted prepared statements got evicted too early from cache that leads to race condition</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19703</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We&apos;re upgrading from Cassandra 4.0 to Cassandra 4.1.3 and system.prepared_statements table size start growing to GB size after upgrade. This slows down node startup significantly when it&apos;s doing preloadPreparedStatements&lt;/p&gt;

&lt;p&gt;I can&apos;t share the exact log but it&apos;s a race condition like this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 1&amp;#93;&lt;/span&gt; Receives a prepared request for S1. Attempts to get S1 in cache&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 1&amp;#93;&lt;/span&gt; Cache miss, put this S1 into cache&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 1&amp;#93;&lt;/span&gt; Attempts to write S1 into local table&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 2&amp;#93;&lt;/span&gt; Receives a prepared request for S2. Attempts to get S2 in cache&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 2&amp;#93;&lt;/span&gt; Cache miss, put this S2 into cache&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 2&amp;#93;&lt;/span&gt; Cache is full, evicting S1 from cache&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 2&amp;#93;&lt;/span&gt; Attempts to delete S1 from local table&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 2&amp;#93;&lt;/span&gt; Tombstone inserted for S1, delete finished&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread 1&amp;#93;&lt;/span&gt; Record inserted for S1, write finished&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thread 2 inserted a tombstone for S1 earlier than Thread 1 was able to insert the record in the table. Hence the data will not be removed because the later insert has newer write time than the tombstone.&lt;/p&gt;

&lt;p&gt;Whether this would happen or not depends on how the cache decides what&#8217;s the next entry to evict when it&#8217;s full. We noticed that in 4.1.3 Caffeine was upgraded to 2.9.2 &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15153&quot; title=&quot;Ensure Caffeine cache does not return stale entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15153&quot;&gt;&lt;del&gt;CASSANDRA-15153&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I did a small research in Caffeine commits. It seems this commit was causing the entry got evicted to early: Eagerly evict an entry if it too large to fit in the cache(Feb 2021), available after 2.9.0: &lt;a href=&quot;https://github.com/ben-manes/caffeine/commit/464bc1914368c47a0203517fda2151fbedaf568b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ben-manes/caffeine/commit/464bc1914368c47a0203517fda2151fbedaf568b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And later fixed in: Improve eviction when overflow or the weight is oversized(Aug 2022), available after 3.1.2: &lt;a href=&quot;https://github.com/ben-manes/caffeine/commit/25b7d17b1a246a63e4991d4902a2ecf24e86d234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ben-manes/caffeine/commit/25b7d17b1a246a63e4991d4902a2ecf24e86d234&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Previously an attempt to centralize evictions into one code path led to a suboptimal approach (&lt;a href=&quot;https://github.com/ben-manes/caffeine/commit/464bc1914368c47a0203517fda2151fbedaf568b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;464bc19&lt;/tt&gt;&lt;/a&gt;&lt;br/&gt;
). This tried to move those entries into the LRU position for early eviction, but was confusing and could too aggressively evict something that is desirable to keep.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I upgrade the Caffeine to 3.1.8 (same as 5.0 trunk) and this issue is gone. But I think this version is not compatible with Java 8.&lt;/p&gt;

&lt;p&gt;I&apos;m not 100% sure if this is the root cause and what&apos;s the correct fix here.&#160;Would appreciate if anyone can have a look, thanks&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13582605">CASSANDRA-19703</key>
            <summary>Newly inserted prepared statements got evicted too early from cache that leads to race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tolbertam">Andy Tolbert</assignee>
                                    <reporter username="yukei">Yuqi Yan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Jun 2024 20:34:14 +0000</created>
                <updated>Fri, 30 May 2025 11:23:35 +0000</updated>
                            <resolved>Wed, 28 May 2025 03:49:12 +0000</resolved>
                                        <fixVersion>4.0.19</fixVersion>
                    <fixVersion>4.1.10</fixVersion>
                    <fixVersion>5.0.5</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="61200">17h</timespent>
                                <comments>
                            <comment id="17928573" author="JIRAUSER301388" created="Wed, 19 Feb 2025 21:47:29 +0000"  >&lt;p&gt;To provide some more context on this issue:&lt;/p&gt;

&lt;p&gt;This race condition results in a larger system table and slow down the restart - which is &quot;fine&quot;. But this reveals a more severe issue (which we saw in production), that because the new behavior evicting these newly inserted statements too early, if user is not using prepared statements properly and try to prepare a bunch of non-unique new statements, the instance can be easily overloaded by this prepare-evict-prepare cycle, because client will keep retrying prepare the same statements again and again&lt;/p&gt;</comment>
                            <comment id="17928952" author="andrew.tolbert" created="Fri, 21 Feb 2025 00:15:10 +0000"  >&lt;p&gt;I&apos;ve recently also encountered this issue, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukei&quot; class=&quot;user-hover&quot; rel=&quot;yukei&quot;&gt;yukei&lt;/a&gt;&apos;s explanation of it seems right on!&lt;/p&gt;

&lt;p&gt;Absent of upgrading Caffeine, I think one way to address this would be ensure that the timestamp of the INSERT always precedes the timestamp of the DELETE. We can accomplish this pretty trivially by adding &lt;tt&gt;USING TIMESTAMP&lt;/tt&gt; onto in &lt;tt&gt;SystemKeyspace.writePreparedStatement&lt;/tt&gt; with a timestamp that was generated on construction of the &lt;tt&gt;Prepared&lt;/tt&gt;. This would ensure the INSERT doesn&apos;t shadow the DELETE, even if the DELETE happens in the insert.&lt;/p&gt;

&lt;p&gt;Additionally, any clusters currently experiencing a leaky system.prepared_statements table from this bug may struggle to bounce into a version with this fix as&lt;br/&gt;
SystemKeyspace.loadPreparedPreparedStatements currently does not paginate the query to system.prepared_statements, causing heap OOMs. To fix this this patch adds pagination at 5000 rows, which should allow nodes to come up and delete older prepared statements that may no longer be used as&lt;br/&gt;
the cache fills up (which should happen immediately).&lt;/p&gt;

&lt;p&gt;I&apos;ve created a proposed solution in &lt;a href=&quot;https://github.com/apache/cassandra/pull/3917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #3917&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note that this patch does not address the issue of Caffeine immediately evicting a prepared statement, however it will prevent the&lt;br/&gt;
system.prepared_statements table from growing unbounded. For most I think this should be adequate, as the cache should only be filled when there are erroneously many unique prepared statements. In such a case we can expect that clients will constantly (re)prepare statements regardless of whether or not the cache is evicting statements.&lt;/p&gt;</comment>
                            <comment id="17932752" author="bschoeni" created="Wed, 5 Mar 2025 21:23:36 +0000"  >&lt;p&gt;Just a suggestion that it would be helpful to update the documentation on prepared statements to describe the eviction policy used by Caffeine.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://cassandra.apache.org/doc/stable/cassandra/cql/cql_singlefile.html#preparedStatement&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassandra.apache.org/doc/stable/cassandra/cql/cql_singlefile.html#preparedStatement&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We&apos;ve seen a slew of problems with miss-prepared statements, for example Spring Data for Cassandra &lt;a href=&quot;https://github.com/spring-projects/spring-data-cassandra/issues/1213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#1213&lt;/a&gt; and it&apos;s been mysterious when (and how) the bad statements would expire after correcting the code.&lt;/p&gt;</comment>
                            <comment id="17936514" author="andrew.tolbert" created="Tue, 18 Mar 2025 14:25:47 +0000"  >&lt;p&gt;I think that&apos;s a good idea &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bschoeni&quot; class=&quot;user-hover&quot; rel=&quot;bschoeni&quot;&gt;bschoeni&lt;/a&gt;, I&apos;ll add something to the docs to note this in my PR.  I think your point about Spring Data is good, as most users I&apos;ve worked with whose clusters have had this issue were using a library that prepared statements for them without them realizing what was going on.  Another example of this is gocql, which implicitly prepares everything (which I&apos;ve come around to actually being a good idea because it simplifies things quite a bit when you have all the query metadata).&lt;/p&gt;

&lt;p&gt;I have deployed this to a couple hundred clusters now and it does seem to resolve the prepared statement leak and prevent instances from OOMing on startup, but there&apos;s a couple things I have to acknowledge:&lt;/p&gt;

&lt;p&gt;1. The fix addresses caffeine evicting before inserting by not leaking into system.prepared_statements by ensuring the client timestamp on the insert precedes the delete, but there still is the problem of the early eviction, which causes a decent amount of client re-prepare behavior.   However, in extreme cases like this where clients are overwhelming the prepared statement cache, you are still going to see a ton of reprepares regardless of how the cache chooses to evict.  I&apos;ve seen some clusters where the cache essentially gets reset every 2 seconds.&lt;/p&gt;

&lt;p&gt;2. The fix addresses the OOM on startup by introducing pagination of the system.prepared_statements table, but if you have hundreds of thousands of leaked statements, it can take hours for a node to start up.  I think we could consider adding some logic (like truncating the table after X000 prepared statements), but I think it&apos;s probably best not to add something to startup that does something like truncate and just provide some good guidance for folks who need to dig themselves out of this.   Since we were able to detect the problem before rolling out the change more than a couple hundred clusters, it was pretty easy for us to work around this; so I expect maybe that problem could be solved by documentation.&lt;/p&gt;</comment>
                            <comment id="17942130" author="bereng" created="Wed, 9 Apr 2025 08:35:07 +0000"  >&lt;p&gt;Added a couple notes to the PR.&lt;/p&gt;</comment>
                            <comment id="17950821" author="andrew.tolbert" created="Mon, 12 May 2025 02:57:31 +0000"  >&lt;p&gt;Attached CI tests from commit 10c009a (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076461/13076461_CASSANDRA-19703-4.1-511-0_ci_summary.html&quot; title=&quot;CASSANDRA-19703-4.1-511-0_ci_summary.html attached to CASSANDRA-19703&quot;&gt;CASSANDRA-19703-4.1-511-0_ci_summary.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;).  Ran clean except for an unrelated 2i suite (&lt;tt&gt;upgrade_tests.cql_tests.TestCQLNodes3RF3_Upgrade_indev_4_0_x_To_indev_4_1_x&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="17951163" author="bereng" created="Tue, 13 May 2025 11:28:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tolbertam&quot; class=&quot;user-hover&quot; rel=&quot;tolbertam&quot;&gt;tolbertam&lt;/a&gt; do you need help finding a 2nd committer to review?&lt;/p&gt;</comment>
                            <comment id="17951263" author="maedhroz" created="Tue, 13 May 2025 18:51:58 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17952487" author="andrew.tolbert" created="Mon, 19 May 2025 02:41:37 +0000"  >&lt;p&gt;I&apos;ve created branches from 4.0 through trunk and run our internal CI against it. I also ran &lt;tt&gt;PstmtPersistenceTest&lt;/tt&gt; repeatedly in free-tier pipelines (small resources) to ensure I didn&apos;t introduce any flakes:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;JDK 1 repeat&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;JDK 2 repeat&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/4164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19703-4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076565/13076565_CASSANDRA-19703-4.0-518.html&quot; title=&quot;CASSANDRA-19703-4.0-518.html attached to CASSANDRA-19703&quot;&gt;CASSANDRA-19703-4.0-518.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/207/workflows/9bda5ee1-5b80-42a0-915f-ddee69dfb7d5/jobs/18291&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/207/workflows/897ba6c1-3bd2-48c2-8faf-4d53e952b649/jobs/18287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19703-4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076566/13076566_CASSANDRA-19703-4.1-518.html&quot; title=&quot;CASSANDRA-19703-4.1-518.html attached to CASSANDRA-19703&quot;&gt;CASSANDRA-19703-4.1-518.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/208/workflows/dc556ec3-9c69-45af-9da0-a3fdc38238a9/jobs/18292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/208/workflows/48d90512-0181-405e-a4f7-d24450839aa8/jobs/18288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/4161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19703-5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076568/13076568_CASSANDRA-19703-5.0-518.html&quot; title=&quot;CASSANDRA-19703-5.0-518.html attached to CASSANDRA-19703&quot;&gt;CASSANDRA-19703-5.0-518.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; (upgrade tests pending)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/209/workflows/4bcda1d2-03a8-442a-a576-958922f07ff5/jobs/18290&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/209/workflows/ee06b743-778d-4bdf-9ae0-9b70d7ca1d9c/jobs/18289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/4160&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19703-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076567/13076567_CASSANDRA-19703-trunk-518.html&quot; title=&quot;CASSANDRA-19703-trunk-518.html attached to CASSANDRA-19703&quot;&gt;CASSANDRA-19703-trunk-518.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/206/workflows/7d3b0879-f056-4a35-b846-2c33b5aab03d/jobs/18281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/tolbertam/cassandra/206/workflows/85529fee-9946-4ef7-b824-4a6418699404/jobs/18278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;CI ran pretty well except for several flakes, there doesn&apos;t look to be anything where the changes made would be contributing.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;io.sstable.SSTableReaderTest.testSpannedIndexPositions&lt;/tt&gt; failing on 5.0 and trunk (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20636&quot; title=&quot;Fix MAX_SEGMENT_SIZE &amp;lt; chunkSize in MmappedRegions::updateState&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20636&quot;&gt;&lt;del&gt;CASSANDRA-20636&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;NetstatsBootstrapWithEntireSSTablesCompressionStreamingTest.testWithStreamingEntireSSTablesWithoutCompression&lt;/tt&gt; failing on&#160;4.1, I see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17345&quot; title=&quot;Fix flaky NetstatsBootstrapWithEntireSSTablesCompressionStreamingTest.testWithStreamingEntireSSTablesWithoutCompression &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17345&quot;&gt;&lt;del&gt;CASSANDRA-17345&lt;/del&gt;&lt;/a&gt; was closed as cannot reproduce, perhaps it&apos;s not reproducible on 5.0 but have seen this fail several times in CI.&lt;/li&gt;
	&lt;li&gt;4.0 &lt;tt&gt;distributed.upgrade.MixedModeAvailabilityV22Test&lt;/tt&gt; failing on 4.0 during shutdown, doesn&apos;t like concerning&lt;/li&gt;
	&lt;li&gt;5.0: gossip_test.TestGossip which has a history of flakiness (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19261&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.jmx.JMXFeatureTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19261&quot;&gt;CASSANDRA-19261&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17366&quot; title=&quot;Fix flaky test - gossip_test.TestGossip&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17366&quot;&gt;&lt;del&gt;CASSANDRA-17366&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;5.0: TestCqlshCopy.test_round_trip_with_rate_file (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17322&quot; title=&quot;Test Failure: dtest-novnode.cqlsh_tests.test_cqlsh_copy.TestCqlshCopy.test_round_trip_with_rate_file (from Cassandra dtests)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17322&quot;&gt;CASSANDRA-17322&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;5.0: TestLargeColumn.test_cleanup (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20509&quot; title=&quot;Test failure: largecolumn_test.TestLargeColumn.test_cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20509&quot;&gt;&lt;del&gt;CASSANDRA-20509&lt;/del&gt;&lt;/a&gt; is recent but only addressed on trunk)&lt;/li&gt;
	&lt;li&gt;Various timeouts in upgrade dtests&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Will attach the 5.0 report as soon as it finishes.&lt;/p&gt;</comment>
                            <comment id="17952780" author="bereng" created="Tue, 20 May 2025 07:02:45 +0000"  >&lt;p&gt;It&apos;s difficult to judge CI but all failures look unrelated to me +1&lt;/p&gt;</comment>
                            <comment id="17953051" author="bereng" created="Wed, 21 May 2025 06:20:08 +0000"  >&lt;p&gt;Is this ready to merge, are we waiting on a final +1 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; for the rest of PRs or is it sthg else?&lt;/p&gt;</comment>
                            <comment id="17953202" author="maedhroz" created="Wed, 21 May 2025 16:43:09 +0000"  >&lt;p&gt;+1 from me, unless something materially changed between them&lt;/p&gt;</comment>
                            <comment id="17954217" author="bereng" created="Tue, 27 May 2025 05:27:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tolbertam&quot; class=&quot;user-hover&quot; rel=&quot;tolbertam&quot;&gt;tolbertam&lt;/a&gt; you need help committing this or are we waiting on anything else?&lt;/p&gt;</comment>
                            <comment id="17954321" author="andrew.tolbert" created="Tue, 27 May 2025 12:32:54 +0000"  >&lt;p&gt;I&apos;ll work on getting this merged today, thanks!&lt;/p&gt;</comment>
                            <comment id="17954471" author="andrew.tolbert" created="Wed, 28 May 2025 03:49:12 +0000"  >&lt;p&gt;Finally got around to committing this.  Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bschoeni&quot; class=&quot;user-hover&quot; rel=&quot;bschoeni&quot;&gt;bschoeni&lt;/a&gt; for reviews and all your help in getting this in!  Fix should be in 4.0.19 (will update label when that&apos;s made), 4.1.10, 5.0.5, and 6.x.&lt;/p&gt;</comment>
                            <comment id="17954480" author="bereng" created="Wed, 28 May 2025 05:33:30 +0000"  >&lt;p&gt;That is a great addition. Thx for your work!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13238523">CASSANDRA-15153</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13594633">CASSANDRA-19986</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13076565" name="CASSANDRA-19703-4.0-518.html" size="19818" author="andrew.tolbert" created="Mon, 19 May 2025 02:30:40 +0000"/>
                            <attachment id="13076461" name="CASSANDRA-19703-4.1-511-0_ci_summary.html" size="20775" author="andrew.tolbert" created="Mon, 12 May 2025 02:55:30 +0000"/>
                            <attachment id="13076566" name="CASSANDRA-19703-4.1-518.html" size="45916" author="andrew.tolbert" created="Mon, 19 May 2025 02:30:49 +0000"/>
                            <attachment id="13076568" name="CASSANDRA-19703-5.0-518.html" size="53880" author="andrew.tolbert" created="Mon, 19 May 2025 03:28:20 +0000"/>
                            <attachment id="13076567" name="CASSANDRA-19703-trunk-518.html" size="42483" author="andrew.tolbert" created="Mon, 19 May 2025 02:30:56 +0000"/>
                            <attachment id="13074901" name="ci_summary.html" size="16039" author="andrew.tolbert" created="Fri, 21 Feb 2025 04:10:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tolbertam]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1psjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12352689">4.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d077f695534b3db57b1573ee6b2bd0463c3883b3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d077f695534b3db57b1573ee6b2bd0463c3883b3&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19703?focusedCommentId=17952487&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17952487&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-19703?focusedCommentId=17952487&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17952487&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>