<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11742] Failed bootstrap results in exception when node is restarted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11742</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since 2.2 a failed bootstrap results in a &lt;tt&gt;org.apache.cassandra.exceptions.ConfigurationException: Found system keyspace files, but they couldn&apos;t be loaded!&lt;/tt&gt; exception when the node is restarted. This did not happen in 2.1, it just tried to bootstrap again. I know that the workaround is relatively easy, just delete the system keyspace in the data folder on disk and try again, but its a bit annoying that you have to do that.&lt;br/&gt;
The problem seems to be that the creation of the &lt;tt&gt;system.local&lt;/tt&gt; table has been moved to just before the bootstrap begins (in 2.1 it was done much earlier) and as a result its still in the memtable och commitlog if the bootstrap failes. Still a few values is inserted to the &lt;tt&gt;system.local&lt;/tt&gt; table at an earlier point in the startup and they have been flushed from the memtable to an sstable. When the node is restarted the &lt;tt&gt;SystemKeyspace.checkHealth()&lt;/tt&gt; is executed before the commitlog is replayed and therefore only see the sstable with an incomplete &lt;tt&gt;system.local&lt;/tt&gt; table and throws an exception.&lt;br/&gt;
I think we could fix this very easily by forceFlush the system keyspace in the &lt;tt&gt;StorageServiceShutdownHook&lt;/tt&gt;, I have included a patch that does this. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12966738">CASSANDRA-11742</key>
            <summary>Failed bootstrap results in exception when node is restarted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkni">Joel Knighton</assignee>
                                    <reporter username="tommy_s">Tommy Stendahl</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 May 2016 13:47:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:33 +0000</updated>
                            <resolved>Fri, 3 Jun 2016 10:02:36 +0000</resolved>
                                        <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.7</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15283140" author="jkni" created="Fri, 13 May 2016 20:51:29 +0000"  >&lt;p&gt;I&apos;ve confirmed this issue - there&apos;s a window between &lt;tt&gt;SystemKeyspace.finishStartup()&lt;/tt&gt; and calling &lt;tt&gt;Gossiper.instance.start()&lt;/tt&gt; in &lt;tt&gt;prepareToJoin&lt;/tt&gt; where the contents will only be in the memtable/commitlog and not flushed.&lt;/p&gt;

&lt;p&gt;There doesn&apos;t seem a clearly better way to refactor &lt;tt&gt;SystemKeyspace.checkHealth()&lt;/tt&gt; - ideally, we wouldn&apos;t write to &lt;tt&gt;local&lt;/tt&gt; before &lt;tt&gt;finishStartup&lt;/tt&gt;, but that would be a significant refactor without a very significant reward. Even with your proposed fix, there&apos;s a window where we could crash before we even attempt to write in {[SystemKeyspace.finishStartup()}}, but I think that&apos;s livable.&lt;/p&gt;

&lt;p&gt;As an alternative to your patch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tommy_s&quot; class=&quot;user-hover&quot; rel=&quot;tommy_s&quot;&gt;tommy_s&lt;/a&gt;, how would you feel about just forcing a blocking flush in &lt;tt&gt;persistLocalMetadata&lt;/tt&gt;? This would ensure the data is present even if we have a hard crash/kill circumstance where &lt;tt&gt;StorageServiceShutdownHook&lt;/tt&gt; doesn&apos;t run.&lt;/p&gt;</comment>
                            <comment id="15284249" author="tommy_s" created="Mon, 16 May 2016 08:04:48 +0000"  >&lt;p&gt;I see what you mean, that should close the reaming window. Even if that window is small it would be good if we can avoid it  I will do some tests with a blocking flush in &lt;tt&gt;persistLocalMetadata&lt;/tt&gt;, if it works out I will post a new patch.&lt;/p&gt;</comment>
                            <comment id="15286633" author="tommy_s" created="Tue, 17 May 2016 13:41:23 +0000"  >&lt;p&gt;I looked in to this again and done some tests and a blocking flush in &lt;tt&gt;persistLocalMetadata&lt;/tt&gt; seams to be a better way to do it. I have done a new patch for that.&lt;/p&gt;</comment>
                            <comment id="15292309" author="jkni" created="Thu, 19 May 2016 23:05:50 +0000"  >&lt;p&gt;I think this second patch is an improvement - I traced this issue to determine exactly why it worked on 2.1. This behavior was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8049&quot; title=&quot;Explicitly examine current C* state on startup to detect incompatibilities before upgrade&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8049&quot;&gt;&lt;del&gt;CASSANDRA-8049&lt;/del&gt;&lt;/a&gt; which centralized Cassandra startup checks. Prior to this change, we inserted cluster name directly after checking the health of the system keyspace, so if an sstable for the system keyspace was flushed, we could guarantee that some sstable contained cluster name. After &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8049&quot; title=&quot;Explicitly examine current C* state on startup to detect incompatibilities before upgrade&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8049&quot;&gt;&lt;del&gt;CASSANDRA-8049&lt;/del&gt;&lt;/a&gt;, we insert cluster name with the rest of the local metadata in &lt;tt&gt;SystemKeyspace.finishStartup&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; - I couldn&apos;t find a reason for the change as to when cluster name is inserted other than that it didn&apos;t seem like a good idea to mutate anything in a startup check. Can you think of any reason we can&apos;t just call &lt;tt&gt;SystemKeyspace.persistLocalMetadata&lt;/tt&gt; immediately after snapshotting the system keyspace in &lt;tt&gt;CassandraDaemon&lt;/tt&gt;? The root cause of this problem is that we need the data persisted before any truncate/schema logic, since these will write to the system keyspace, so we can have flushed sstables with this data but no sstable with cluster name, which breaks the logic of the system keyspace health check. I ran full unit tests/dtests on a branch that moved &lt;tt&gt;SystemKeyspace.persistLocalMetadata&lt;/tt&gt; to immediately after the snapshot of the system keyspace and the results looked good.&lt;/p&gt;</comment>
                            <comment id="15293104" author="beobal" created="Fri, 20 May 2016 10:04:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can you think of any reason we can&apos;t just call SystemKeyspace.persistLocalMetadata immediately after snapshotting the system keyspace in CassandraDaemon?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That sounds entirely reasonable to me.&lt;/p&gt;</comment>
                            <comment id="15293873" author="jkni" created="Fri, 20 May 2016 18:04:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tommy_s&quot; class=&quot;user-hover&quot; rel=&quot;tommy_s&quot;&gt;tommy_s&lt;/a&gt; Any reason you&apos;re opposed to switching to the approach I described above? It would guarantee that a crash during start up wouldn&apos;t leave the system keyspace in a failing health check state, as opposed to only shrinking the window. If that&apos;s fine with you, I can switch myself to assignee and push that branch for CI.&lt;/p&gt;</comment>
                            <comment id="15294889" author="tommy_s" created="Sat, 21 May 2016 10:22:24 +0000"  >&lt;p&gt;No, I have no objection. You&apos;re approach seams to be the best one.&lt;/p&gt;</comment>
                            <comment id="15309443" author="jkni" created="Wed, 1 Jun 2016 07:05:13 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/CASSANDRA-11742-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11742-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/CASSANDRA-11742-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11742-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/CASSANDRA-11742-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11742-3.7&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-3.7-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-3.7-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/CASSANDRA-11742-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11742-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-CASSANDRA-11742-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Patches implement the approach described above of persisting local metadata in the SystemKeyspace immediately after the startup checks have completed. testall/dtests look clean - the delay in these patches was uncertainty about a few tests that were destabilized over the last couple weeks, but rebased runs look better.&lt;/p&gt;

&lt;p&gt;2.2 patch differs from 3.0 patch slightly due to some 3.0 refactoring. 3.0 patch merges cleanly through 3.7 and trunk.&lt;/p&gt;</comment>
                            <comment id="15313928" author="beobal" created="Fri, 3 Jun 2016 10:02:36 +0000"  >&lt;p&gt;Thanks, LGTM.&lt;br/&gt;
Committed to 2.2 in &lt;tt&gt;360541f16a158f560d7cce1fcc264e246a80d10f&lt;/tt&gt; and merged to 3.0/3.7/trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12974455">CASSANDRA-11934</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12970236">CASSANDRA-11813</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12804419" name="11742-2.txt" size="569" author="tommy_s" created="Tue, 17 May 2016 13:38:44 +0000"/>
                            <attachment id="12803237" name="11742.txt" size="856" author="tommy_s" created="Tue, 10 May 2016 13:49:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jkni]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xghz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334272">2.2.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332983">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>