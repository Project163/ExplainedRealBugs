<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15899] Dropping a column can break queries until the schema is fully propagated</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15899</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;With a table like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE ks.tbl (id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key, v1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v3 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and we drop &lt;tt&gt;v2&lt;/tt&gt;, we get this exception on the replicas which haven&apos;t seen the schema change:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [SharedPool-Worker-1] node2 2020-06-24 09:49:08,107 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-1,5,node2]
java.lang.IllegalStateException: [ColumnDefinition{name=v1, type=org.apache.cassandra.db.marshal.Int32Type, kind=REGULAR, position=-1}, ColumnDefinition{name=v2, type=org.apache.cassandra.db.marshal.Int32Type, kind=REGULAR, position=-1}, ColumnDefinition{name=v3, type=org.apache.cassandra.db.marshal.Int32Type, kind=REGULAR, position=-1}] is not a subset of [v1 v3]
	at org.apache.cassandra.db.Columns$Serializer.encodeBitmap(Columns.java:546) ~[main/:na]
	at org.apache.cassandra.db.Columns$Serializer.serializeSubset(Columns.java:478) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:184) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:114) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:102) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:132) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[main/:na]
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that it doesn&apos;t matter if we &lt;tt&gt;SELECT *&lt;/tt&gt; or &lt;tt&gt;SELECT id, v1&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13313185">CASSANDRA-15899</key>
            <summary>Dropping a column can break queries until the schema is fully propagated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jun 2020 07:50:47 +0000</created>
                <updated>Sun, 3 Jan 2021 17:03:44 +0000</updated>
                            <resolved>Tue, 6 Oct 2020 17:16:08 +0000</resolved>
                                        <fixVersion>3.0.23</fixVersion>
                    <fixVersion>3.11.9</fixVersion>
                    <fixVersion>4.0-beta3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Cluster/Schema</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17143617" author="krummas" created="Wed, 24 Jun 2020 07:57:10 +0000"  >&lt;p&gt;repro dtest: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/15899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/15899&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is probably caused by &lt;tt&gt;isFetchAll&lt;/tt&gt; vs &lt;tt&gt;fetchedColumns()&lt;/tt&gt; in &lt;tt&gt;ColumnFilter&lt;/tt&gt; as they will mismatch if there is a disagreement on which columns exist&lt;/p&gt;</comment>
                            <comment id="17166754" author="bdeggleston" created="Tue, 28 Jul 2020 23:37:36 +0000"  >&lt;p&gt;���I have a patch ready for review here: &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15899-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bdeggleston/cassandra/tree/15899-trunk&lt;/a&gt;. This fixes the issue for dropping columns as well as adding them, which would also throw validation errors.&lt;/p&gt;

&lt;p&gt;Dropped columns are handled by checking that the columns we&apos;re serializing and the header columns are actually equal, not just the same length, and ignoring situations where we have a column not specified by the read command.&lt;/p&gt;

&lt;p&gt;Added columns are handled by returning placeholder columns when deserializing columns instead of throwing an exception. We will throw an exception if we attempt to deserialize any data with a placeholder column.&lt;/p&gt;</comment>
                            <comment id="17181962" author="beobal" created="Fri, 21 Aug 2020 15:55:11 +0000"  >
&lt;p&gt;The patch looks good to me, the only minor nit I&apos;ve got is that having &lt;tt&gt;SearchIterator&lt;/tt&gt; extend &lt;tt&gt;Iterator&lt;/tt&gt; is somewhat unnecessary for how we&apos;re using it. I&apos;ve pushed a branch (rebased onto latest trunk) for you to take a look at: &lt;a href=&quot;https://github.com/beobal/cassandra/commits/beobal/15899-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/beobal/cassandra/commits/beobal/15899-trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also, it may be worth adding a test where a write is received for a dropped column but the coordinator isn&apos;t aware of the schema change. This is handled correctly already on the other replicas via DroppedColumn and isn&apos;t affected by anything in this patch, but it took me a little time to manually verify that that was actually the case. If you agree, I&apos;ve added that to the linked branch too.&lt;/p&gt;

&lt;p&gt;Otherwise, this seems fine to me. The fixver is 3.0, but I don&apos;t think there should be much involved in backporting this to 3.0/3.11.&lt;/p&gt;</comment>
                            <comment id="17183133" author="ifesdjeen" created="Mon, 24 Aug 2020 10:16:13 +0000"  >&lt;p&gt;A minor comment: shouold we consider implementing &lt;tt&gt;isPlaceholder&lt;/tt&gt; on &lt;tt&gt;Placeholder&lt;/tt&gt; class to avoid instanceOf checks? Also, it might be useful to add tests for &lt;tt&gt;*&lt;/tt&gt; not only &lt;tt&gt;id, v1&lt;/tt&gt; in &lt;tt&gt;SchemaTest.java&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17188001" author="bdeggleston" created="Mon, 31 Aug 2020 21:03:55 +0000"  >&lt;p&gt;I pulled in Sam&apos;s changes, added the tests Alex suggested, and ported to 3.0/3.11&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15899-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/bdeggleston/cassandra?branch=15899-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15899-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/bdeggleston/cassandra?branch=15899-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15899-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/bdeggleston/cassandra?branch=15899-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17190752" author="beobal" created="Fri, 4 Sep 2020 14:31:26 +0000"  >&lt;p&gt;+1 LGTM&lt;br/&gt;
One tiny nit if you don&apos;t mind fixing on commit: in the 3.0 &amp;amp; 3.11 branches, there are a couple of stray semicolons in &lt;tt&gt;SimpleReadWriteTest&lt;/tt&gt; (lines 137 &amp;amp; 148).&lt;/p&gt;</comment>
                            <comment id="17198945" author="ifesdjeen" created="Sun, 20 Sep 2020 10:10:25 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;

&lt;p&gt;The only change I can suggest (feel free to ignore it) is to add tests not only for added, but also for dropped columns, and test for when coordinator is a node that is not aware of the schema change:&#160; &lt;a href=&quot;https://github.com/ifesdjeen/cassandra/pull/new/15899-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ifesdjeen/cassandra/pull/new/15899-3.0&lt;/a&gt;. All tests pass.&lt;/p&gt;</comment>
                            <comment id="17208339" author="bdeggleston" created="Mon, 5 Oct 2020 21:32:39 +0000"  >&lt;p&gt;committed to 3.0 and merged up. I can&apos;t mark the ticked as committed until INFRA-20942 is resolved, but in the meantime, here&apos;s the github link: &lt;a href=&quot;https://github.com/apache/cassandra/commit/31b9078a691a6f93b104cc6b3f72fe2fbf6557f6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/31b9078a691a6f93b104cc6b3f72fe2fbf6557f6&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0g5co:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/31b9078a691a6f93b104cc6b3f72fe2fbf6557f6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/31b9078a691a6f93b104cc6b3f72fe2fbf6557f6&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;in-jvm dtests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>