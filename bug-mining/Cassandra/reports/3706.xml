<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9871] Cannot replace token does not exist - DN node removed as Fat Client</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9871</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We lost a node due to disk failure, we tried to replace it via -Dcassandra.replace_address per &amp;#8211; &lt;a href=&quot;http://docs.datastax.com/en/cassandra/2.1/cassandra/operations/opsReplaceNode.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.datastax.com/en/cassandra/2.1/cassandra/operations/opsReplaceNode.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The node would not come up with these errors in the system.log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  [main] 2015-07-22 03:20:06,722  StorageService.java:500 - Gathering node replacement information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /10.171.115.233
...
INFO  [SharedPool-Worker-1] 2015-07-22 03:22:34,281  Gossiper.java:954 - InetAddress /10.111.183.101 is now UP
INFO  [GossipTasks:1] 2015-07-22 03:22:59,300  Gossiper.java:735 - FatClient /10.171.115.233 has been silent &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 30000ms, removing from gossip
ERROR [main] 2015-07-22 03:23:28,485  CassandraDaemon.java:541 - Exception encountered during startup
java.lang.UnsupportedOperationException: Cannot replace token -1013652079972151677 which does not exist!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is not clear why Gossiper removed the node as a FatClient, given that it was a full node before it died and it had tokens assigned to it (including -1013652079972151677) in system.peers and nodetool ring. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12848339">CASSANDRA-9871</key>
            <summary>Cannot replace token does not exist - DN node removed as Fat Client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="sebastian.estevez@datastax.com">Sebastian Estevez</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jul 2015 18:30:03 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:03 +0000</updated>
                            <resolved>Mon, 3 Aug 2015 12:17:42 +0000</resolved>
                                        <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>3.0 beta 1</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14638597" author="stefania" created="Thu, 23 Jul 2015 10:08:01 +0000"  >&lt;p&gt;I&apos;ve reproduced the problem with this test:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    def can_replace_down_node_test(self):
        &quot;&quot;&quot;
        @jira_ticket CASSANDRA-9871
        Test that we can replace a node that is down and in status normal (DN) by using
        -Dcassandra.replace_address
        &quot;&quot;&quot;
        cluster = self.cluster
        cluster.populate(3)
        cluster.start(wait_for_binary_proto=True)

        version = cluster.version()
        stress_table = &lt;span class=&quot;code-quote&quot;&gt;&apos;keyspace1.standard1&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; self.cluster.version() &amp;gt;= &lt;span class=&quot;code-quote&quot;&gt;&apos;2.1&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-quote&quot;&gt;&quot;Keyspace1&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;Standard1&quot;&lt;/span&gt;&apos;&lt;/span&gt;

        # write some data
        node1, node2, node3 = cluster.nodelist()
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; version &amp;lt; &lt;span class=&quot;code-quote&quot;&gt;&quot;2.1&quot;&lt;/span&gt;:
            node1.stress([&lt;span class=&quot;code-quote&quot;&gt;&apos;-n&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;10000&apos;&lt;/span&gt;])
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
            node1.stress([&lt;span class=&quot;code-quote&quot;&gt;&apos;write&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;n=10000&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-rate&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;threads=8&apos;&lt;/span&gt;])

        # Stop node 3
        node3.stop(gently=True)

        # Sleep a bit to let GOSSIP settle
        time.sleep(2)

        out, err = node1.nodetool(&lt;span class=&quot;code-quote&quot;&gt;&apos;status&apos;&lt;/span&gt;)
        self.assertEquals(&apos;&apos;, err)
        debug(out)

        # Create a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; node to replace node3
        node4 = new_node(cluster, bootstrap=True)
        node4.start(jvm_args=[&lt;span class=&quot;code-quote&quot;&gt;&quot;-Dcassandra.replace_address=127.0.0.3&quot;&lt;/span&gt;], wait_for_binary_proto=True)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Interestingly if the old node is shutdown with kill -9 (gently=False in the stop method), then it can be replace without problems.&lt;/p&gt;

&lt;p&gt;Here is the code determining if it&apos;s a fat client:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFatClient(InetAddress endpoint)
    {
        EndpointState epState = endpointStateMap.get(endpoint);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (epState == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !isDeadState(epState) &amp;amp;&amp;amp; !StorageService.instance.getTokenMetadata().isMember(endpoint);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The dead states are REMOVING, REMOVED, LEFT and HIBERNATE. The state for a clean shutdown should be SHUTDOWN, so &lt;tt&gt;!isDealState(epState)&lt;/tt&gt; should be true. I still need to work out why the endpoint is not a member but it should be due to the &quot;is now DOWN&quot; log, which is not present when the old node is killed with -9.&lt;/p&gt;
</comment>
                            <comment id="14638741" author="jasobrown" created="Thu, 23 Jul 2015 12:45:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; can you provide a dump of both nodetool gossipinfo and nodetool status? &lt;tt&gt;isFatClient&lt;/tt&gt; returns true as the endpoint is not a member in TokenMetadata, and that&apos;s why we fail in &lt;tt&gt;SS.joinTokenRing&lt;/tt&gt; (we check to see if the token is associated with a TokenMetadata member).&lt;/p&gt;</comment>
                            <comment id="14638902" author="stefania" created="Thu, 23 Jul 2015 14:23:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;can you provide a dump of both nodetool gossipinfo and nodetool status?&lt;/p&gt;&lt;/blockquote&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens  Owns    Host ID                               Rack
UN  127.0.0.1  82.71 KB   256     ?       af23fcbb-fce4-495c-b5b5-b0b90ccc71c1  rack1
UN  127.0.0.2  51.57 KB   256     ?       11814d51-5120-4f9f-b5fc-d0ffa534f964  rack1
DN  127.0.0.3  51.59 KB   256     ?       0101e850-7f3a-499c-a80c-092ecf4e27e3  rack1

Note: Non-system keyspaces don&apos;t have the same replication settings, effective ownership information is meaningless

/127.0.0.1
  generation:1437661129
  heartbeat:164
  RELEASE_VERSION:2.1.8-SNAPSHOT
  SEVERITY:0.0
  STATUS:NORMAL,-107708216716906722
  DC:datacenter1
  NET_VERSION:8
  RACK:rack1
  HOST_ID:af23fcbb-fce4-495c-b5b5-b0b90ccc71c1
  SCHEMA:fa2a3033-51b7-30c0-8926-a2b71bf0fd8a
  RPC_ADDRESS:127.0.0.1
  LOAD:52781.0
/127.0.0.2
  generation:1437661129
  heartbeat:166
  SEVERITY:0.0
  RELEASE_VERSION:2.1.8-SNAPSHOT
  STATUS:NORMAL,-1054644930469012369
  DC:datacenter1
  NET_VERSION:8
  RACK:rack1
  HOST_ID:11814d51-5120-4f9f-b5fc-d0ffa534f964
  SCHEMA:fa2a3033-51b7-30c0-8926-a2b71bf0fd8a
  RPC_ADDRESS:127.0.0.2
  LOAD:52807.0
/127.0.0.3
  generation:1437661129
  heartbeat:2147483647
  RELEASE_VERSION:2.1.8-SNAPSHOT
  SEVERITY:0.0
  STATUS:shutdown,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  DC:datacenter1
  NET_VERSION:8
  RACK:rack1
  HOST_ID:0101e850-7f3a-499c-a80c-092ecf4e27e3
  SCHEMA:fa2a3033-51b7-30c0-8926-a2b71bf0fd8a
  RPC_ADDRESS:127.0.0.3
  LOAD:52826.0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;isFatClient returns true as the endpoint is not a member in TokenMetadata and that&apos;s why we fail in SS.joinTokenRing (we check to see if the token is associated with a TokenMetadata member).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes this is the root cause but why would the node not be a member? I guess handleStateNormal() is never called, so once again isFatClient() is at fault, just like for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9765&quot; title=&quot;checkForEndpointCollision fails for legitimate collisions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9765&quot;&gt;&lt;del&gt;CASSANDRA-9765&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;Anyway, I plan on putting more debug information tomorrow to find out when the TM is modified.&lt;/p&gt;</comment>
                            <comment id="14639322" author="jasobrown" created="Thu, 23 Jul 2015 18:30:08 +0000"  >&lt;p&gt;As part of understanding this, when we do the shadow round from &lt;tt&gt;SS.prepareReplacementInfo&lt;/tt&gt;, Gossiper will not update TMD (via &lt;tt&gt;SS.onJoin&lt;/tt&gt;, which calls &lt;tt&gt;SS.onChange&lt;/tt&gt; and so down to &lt;tt&gt;TMD.updateNormalTokens&lt;/tt&gt;) as there are no registered subscriber yet. So I can see how we would not have any previous entry in TMD for the node being replaced, thus causing the failure in &lt;tt&gt;SS.joinTokenRing&lt;/tt&gt;. Still digging in deeper...&lt;/p&gt;</comment>
                            <comment id="14639334" author="jasobrown" created="Thu, 23 Jul 2015 18:39:35 +0000"  >&lt;p&gt;FWIW, I used &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt;&apos;s dtest on 2.1 and was able to reproduce the error (new node could not replace the dead one); however, 2.0 did not reproduce the error (the new node successfully replaced the dead one). UPDATE: This was done with the gently = true shutdown option.&lt;/p&gt;</comment>
                            <comment id="14647463" author="stefania" created="Thu, 30 Jul 2015 10:54:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; I understood from IRC that you were going to bisect this to find the problematic commit, did you have any luck? If not and you are too busy, don&apos;t worry about it, I can work on this myself and then submit my analysis for you to review later on.&lt;/p&gt;</comment>
                            <comment id="14651457" author="stefania" created="Mon, 3 Aug 2015 05:26:12 +0000"  >&lt;p&gt;The change that introduced this issue is &lt;tt&gt;3c17ac6e1c3da822013c99a179e9e4030b5086f9&lt;/tt&gt;. There was problem with the merge of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8336&quot; title=&quot;Add shutdown gossip state to prevent timeouts during rolling restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8336&quot;&gt;&lt;del&gt;CASSANDRA-8336&lt;/del&gt;&lt;/a&gt; from 2.0 to 2.1. Probably due to a conflict, the call to &lt;tt&gt;handleStateNormal&lt;/tt&gt; for the SHUTDOWN status in 2.1 StorageService.onChange() was left out.&lt;/p&gt;

&lt;p&gt;Attached patch for 2.1 and dtest pull request.&lt;/p&gt;
</comment>
                            <comment id="14651459" author="stefania" created="Mon, 3 Aug 2015 05:28:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; would you mind reviewing?&lt;/p&gt;</comment>
                            <comment id="14651642" author="stefania" created="Mon, 3 Aug 2015 09:27:03 +0000"  >&lt;p&gt;CI:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9871-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9871-2.1-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9871-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9871-2.1-testall/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unpatched dtests for comparison:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.1_dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.1_dtest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14651790" author="jasobrown" created="Mon, 3 Aug 2015 12:07:38 +0000"  >&lt;p&gt;+1. committed to 2.1, 2.1, and trunk. Commit sha 8f9ca07e9a0140d93224bf941fa4f6315e5093cf. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12849447">CASSANDRA-9905</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hswn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>