<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:19:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2211] Cleanup can create sstables whose contents do not match their advertised version</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2211</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since cleanup switched to per-sstable operation (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1916&quot; title=&quot;Cleanup needs to remove secondary index entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1916&quot;&gt;&lt;del&gt;CASSANDRA-1916&lt;/del&gt;&lt;/a&gt;), the main loop looks like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Range.isTokenInRanges(row.getKey().token, ranges))
                    {
                        writer = maybeCreateWriter(sstable, compactionFileLocation, expectedBloomFilterSize, writer);
                        writer.append(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EchoedRow(row));
                        totalkeysWritten++;
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                    {
                        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (row.hasNext())
                        {
                            IColumn column = row.next();
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (indexedColumns.contains(column.name()))
                                Table.cleanupIndexEntry(cfs, row.getKey().key, column);
                        }
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... that is, rows that haven&apos;t changed we copy to the new sstable without deserializing, with EchoedRow.  But, the new sstable is created with CURRENT_VERSION which may not be what the old data consisted of.&lt;/p&gt;

&lt;p&gt;(This could cause symptoms similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2195&quot; title=&quot;java.lang.RuntimeException: java.lang.NegativeArraySizeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2195&quot;&gt;&lt;del&gt;CASSANDRA-2195&lt;/del&gt;&lt;/a&gt; but I do not think it is the cause of that bug; IIRC the cluster in question there was not upgraded from an older Cassandra.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12499284">CASSANDRA-2211</key>
            <summary>Cleanup can create sstables whose contents do not match their advertised version</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Feb 2011 23:28:02 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:06 +0000</updated>
                            <resolved>Tue, 22 Feb 2011 14:53:19 +0000</resolved>
                                        <fixVersion>0.7.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="14400">4h</timeoriginalestimate>
                            <timeestimate seconds="14400">4h</timeestimate>
                                        <comments>
                            <comment id="12997608" author="jbellis" created="Mon, 21 Feb 2011 23:44:33 +0000"  >&lt;p&gt;This bug was introduced in 0.7.0 but in practice was not a problem until we changed sstable formats again in 0.7.1 for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1555&quot; title=&quot;Considerations for larger bloom filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1555&quot;&gt;&lt;del&gt;CASSANDRA-1555&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12997629" author="jbellis" created="Tue, 22 Feb 2011 02:41:44 +0000"  >&lt;p&gt;A better fix would be to have it echo if the data is on the current version, otherwise rewrite.  This would (a) be a better fit with our policy of not having to keep code around to write old versions and (b) allow a better upgrade path to version N + 1 (that doesn&apos;t support the old version sstables) than major compaction. I&apos;ll see if I can do that tonight.&lt;/p&gt;</comment>
                            <comment id="12997646" author="jbellis" created="Tue, 22 Feb 2011 05:43:59 +0000"  >&lt;p&gt;v2 as described above.&lt;/p&gt;</comment>
                            <comment id="12997767" author="slebresne" created="Tue, 22 Feb 2011 12:40:14 +0000"  >&lt;p&gt;+1 on the patch. I&apos;m just attaching a v3 that simply use getDefaultGcBefore() throughout CompactionManager (to make things cleaner)&lt;/p&gt;

&lt;p&gt;Sadly, this is not the only place where we echo data wrongfully, cf. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2216&quot; title=&quot;Compaction can echo data which breaks upon sstable format changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2216&quot;&gt;&lt;del&gt;CASSANDRA-2216&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12997831" author="jbellis" created="Tue, 22 Feb 2011 14:53:19 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12997845" author="hudson" created="Tue, 22 Feb 2011 15:20:55 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #303 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/303/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/303/&lt;/a&gt;)&lt;br/&gt;
    fix for cleanup writing old-format data into new-version sstable&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2211&quot; title=&quot;Cleanup can create sstables whose contents do not match their advertised version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2211&quot;&gt;&lt;del&gt;CASSANDRA-2211&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12471610" name="0001-2211-v3.patch" size="5179" author="slebresne" created="Tue, 22 Feb 2011 12:40:14 +0000"/>
                            <attachment id="12471599" name="2211-v2.txt" size="2918" author="jbellis" created="Tue, 22 Feb 2011 05:43:59 +0000"/>
                            <attachment id="12471584" name="2211.txt" size="5226" author="jbellis" created="Mon, 21 Feb 2011 23:49:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20507</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g9zz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93050</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>