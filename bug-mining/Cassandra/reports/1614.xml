<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4233] overlapping sstables in leveled compaction strategy</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4233</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4142&quot; title=&quot;OOM Exception during repair session with LeveledCompactionStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4142&quot;&gt;&lt;del&gt;CASSANDRA-4142&lt;/del&gt;&lt;/a&gt; introduces test failures, that are caused by overlapping tables within a level, which Shouldn&apos;t Happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12554549">CASSANDRA-4233</key>
            <summary>overlapping sstables in leveled compaction strategy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Wed, 9 May 2012 19:53:39 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:34 +0000</updated>
                            <resolved>Fri, 18 May 2012 16:35:26 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13271738" author="jbellis" created="Wed, 9 May 2012 20:00:02 +0000"  >&lt;p&gt;I see CompactionsTest.testStandardColumnCompactions fail 100% of the time &amp;#8211; but only when run as part of the entire CompactionsTest suite; testStandardColumnCompactions run alone passes.&lt;/p&gt;

&lt;p&gt;About 80% of the time the assertion in LCS fails, but sometimes the one in LM fails.  (How the former can fail, without the latter, is a mystery to me.)&lt;/p&gt;

&lt;p&gt;Is there an off-by-one bug in IntervalTree?&lt;/p&gt;</comment>
                            <comment id="13271739" author="jbellis" created="Wed, 9 May 2012 20:00:17 +0000"  >&lt;p&gt;(Assertions in question are attached.)&lt;/p&gt;</comment>
                            <comment id="13271742" author="brandon.williams" created="Wed, 9 May 2012 20:02:02 +0000"  >&lt;p&gt;An easy way to recreate this in a live situation that I just accidentally discovered is to set memtable_total_space_in_mb to something small like 3, and then run stress with LCS.&lt;/p&gt;</comment>
                            <comment id="13271824" author="jbellis" created="Wed, 9 May 2012 21:26:03 +0000"  >&lt;p&gt;Reproduced assertion errors applying patch (just the LM part) to version 1686a36 (the version before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4142&quot; title=&quot;OOM Exception during repair session with LeveledCompactionStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4142&quot;&gt;&lt;del&gt;CASSANDRA-4142&lt;/del&gt;&lt;/a&gt; was committed).&lt;/p&gt;</comment>
                            <comment id="13273331" author="brandon.williams" created="Fri, 11 May 2012 15:06:32 +0000"  >&lt;p&gt;Here&apos;s a log with compaction at debug illustrating the repro with small memtable space.&lt;/p&gt;</comment>
                            <comment id="13273351" author="slebresne" created="Fri, 11 May 2012 15:31:01 +0000"  >&lt;p&gt;So it&apos;s not (only) a problem of overlapping sstables in a given level, since extracted from the log above we get:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [CompactionExecutor:4] 2012-05-11 15:04:39,125 LeveledManifest.java (line 273) Compaction candidates for L0 are Standard1-4(L0), Standard1-3(L0), Standard1-2(L1), 
 INFO [CompactionExecutor:4] 2012-05-11 15:04:39,126 CompactionTask.java (line 109) Compacting [SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-hd-4-Data.db&apos;), SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-hd-3-Data.db&apos;), SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-hd-2-Data.db&apos;)]
ERROR [CompactionExecutor:4] 2012-05-11 15:04:41,829 AbstractCassandraDaemon.java (line 134) Exception in thread Thread[CompactionExecutor:4,1,main]
java.lang.AssertionError: Last written key DecoratedKey(170030165514395172434635544532010976042, 30303033313634) &amp;gt;= current key DecoratedKey(983360854569225448206418564333137310, 30303036353031) writing into /var/lib/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-tmp-hd-6-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That is, we get an error even though we compact 2 L0 with 1 L1.&lt;/p&gt;</comment>
                            <comment id="13273372" author="jbellis" created="Fri, 11 May 2012 15:49:03 +0000"  >&lt;p&gt;Brandon&apos;s error was from a node that didn&apos;t have 67ed39fa9bf71be4cfc13fccbdd7b76dcb46c062 applied.  So I guess we&apos;re dealing with a potential buggy test.&lt;/p&gt;</comment>
                            <comment id="13273373" author="brandon.williams" created="Fri, 11 May 2012 15:49:10 +0000"  >&lt;p&gt;My mistake, that log is pre-67ed39fa9b which fixes it, so I think we just have a bad test now.&lt;/p&gt;</comment>
                            <comment id="13277918" author="slebresne" created="Thu, 17 May 2012 16:01:38 +0000"  >&lt;p&gt;This was kind of a test problem, though this is kind of a bug.&lt;/p&gt;

&lt;p&gt;The main problem is that LeveledCompaction should never get a maxCompactionThreshold &amp;lt; Integer.MAX_VALUE, otherwise it ends up not compaction what it should and this screw up the levels. However, the way we try to ensure that is by overriding the maxCompactionThreshold in LeveledCompactionStrategy constructor. This is however dangerous because it means that if anyone change the threshold afterward, it will break. And sure enough, that is what happens with CompactionsTest.&lt;/p&gt;

&lt;p&gt;So attaching a patch that change the code to ensure this doesn&apos;t happen. To a large extend this patch is a hack and in the long run, we should refactor all this to move the min/max compaction threshold inside SizeTieredCompaction, where they belong. This is however a bigger refactor than I want to do on the 1.1 branch as currently the thresholds are used to deactivate automatic compaction and whatnot.&lt;/p&gt;</comment>
                            <comment id="13277953" author="jbellis" created="Thu, 17 May 2012 16:38:57 +0000"  >&lt;p&gt;simpler v2 attached, to just ignore CFS min/max in the actual LeveledCompactionTask.&lt;/p&gt;

&lt;p&gt;also respects isCompactionDisabled in LCS.&lt;/p&gt;</comment>
                            <comment id="13277961" author="jbellis" created="Thu, 17 May 2012 16:48:31 +0000"  >&lt;p&gt;tweaked v3 to not mess w/ min/max settings at all (which would result in re-activating compaction if it&apos;s &quot;disabled&quot;)&lt;/p&gt;</comment>
                            <comment id="13277968" author="slebresne" created="Thu, 17 May 2012 16:56:14 +0000"  >&lt;p&gt;I&apos;d submit that my version was giving a slightly better feedback through JMX but I guess that&apos;s not a big deal.&lt;/p&gt;

&lt;p&gt;But other than that, the definition of isCompactionDisabled so far has been to disallow automatic compaction, but forced compaction (&quot;maximal&quot; ones) was still allowed. v2 change that for LCS. I&apos;ll note that disabling compaction was respected for background tasks by LCS by the fact that DataTracker.maxCompacting was skipping compaction when maxCompactionThreshold is 0, but allowed for maximal tasks since the maxCompactionThreshold is overriden in compactionManager in that case. I don&apos;t know if it&apos;s a big deal though (I suspect some tests would fail if run with LCS because they rely on that) but wanted to mention it.&lt;/p&gt;</comment>
                            <comment id="13278204" author="jbellis" created="Thu, 17 May 2012 20:11:56 +0000"  >&lt;p&gt;I think the status quo (and v1, which perpetuates it) are too fragile...  Exhibit A being this bug, and exhibit B being my reading of the code leading me to believe that there was no way to disable LCS. Rather than try to prevent setting max inappropriately, much more clear to have LCS ignore min/max entirely, except via isCompactionDisabled.  This is closer to how it &quot;should&quot; be w/ min + max being STCS-specific options.&lt;/p&gt;

&lt;p&gt;v4 rearranges background/maximal methods to continue allowing maximal to kick off a compaction when autocompaction is disabled.&lt;/p&gt;</comment>
                            <comment id="13278819" author="slebresne" created="Fri, 18 May 2012 14:08:06 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13278937" author="jbellis" created="Fri, 18 May 2012 16:35:26 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13290893" author="iscariot" created="Thu, 7 Jun 2012 09:02:22 +0000"  >&lt;p&gt;I already have this bug in 1.1.1 version&lt;/p&gt;

&lt;p&gt;java.lang.AssertionError: Last written key DecoratedKey(144093708553026671072703572185472027831, 00000000003eef36) &amp;gt;= current key DecoratedKey(50602742485951681279829043048319220646, 00000000004506bf) writing into /cassandra/data/XXXXXX/YYYYYY/AAAAAAA-BBBBBBB-tmp-hd-5217-Data.db&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:134)&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:153)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;any help?&lt;/p&gt;</comment>
                            <comment id="13290895" author="slebresne" created="Thu, 7 Jun 2012 09:09:51 +0000"  >&lt;p&gt;I may or may not be related to this issue. It would help to get the full stack trace and a bit more information on when that happened, if that was a fresh 1.1.1 cluster or an upgraded one from 1.1.0 and the compaction strategy used. And it&apos;s probably worth creating a new ticket.&lt;/p&gt;</comment>
                            <comment id="13290906" author="iscariot" created="Thu, 7 Jun 2012 09:36:15 +0000"  >&lt;p&gt;Stack trace of this error&lt;/p&gt;

&lt;p&gt;ERROR 04:09:21,216 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:410,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: Last written key DecoratedKey(144093708553026671072703572185472027831, 00000000003eef36) &amp;gt;= current key DecoratedKey(50602742485951681279829043048319220646, 00000000004506bf) writing into /cassandra/data/Server/Messages/Server-Messages-tmp-hd-5380-Data.db&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:134)&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:153)&lt;br/&gt;
	at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:159)&lt;br/&gt;
	at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)&lt;br/&gt;
	at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)&lt;br/&gt;
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;/p&gt;

&lt;p&gt;Linux version 2.6.32-5-amd64 (Debian 2.6.32-45)&lt;br/&gt;
32GB ram, 24 threads (12 cores)&lt;/p&gt;

&lt;p&gt;We are upgraded Cassandra server from repository(config file was overwritten, but we change it later). &lt;br/&gt;
And we REcreated keyspace with all CF (we in not a production stage yet).&lt;/p&gt;

&lt;p&gt;all us CFs&lt;br/&gt;
UPDATE COLUMN FAMILY Messages WITH compression_options=&lt;/p&gt;
{sstable_compression:SnappyCompressor, chunk_length_kb:1}
&lt;p&gt;;&lt;br/&gt;
UPDATE COLUMN FAMILY Messages WITH compaction_strategy=LeveledCompactionStrategy AND compaction_strategy_options=&lt;/p&gt;
{sstable_size_in_mb: 10}
&lt;p&gt;;&lt;br/&gt;
UPDATE COLUMN FAMILY Messages WITH gc_grace = 0;&lt;/p&gt;

&lt;p&gt;This CF has many inserts in one time. &lt;br/&gt;
Over 1000-3000 keys with 9 columns each in one sec.&lt;br/&gt;
And this CF has 4 secondary indexes (numbers ~ from 1 to 20)&lt;/p&gt;

&lt;p&gt;More info about Cassandra server&lt;br/&gt;
partitioner: org.apache.cassandra.dht.RandomPartitioner&lt;br/&gt;
key_cache_size_in_mb - default&lt;br/&gt;
row_cache_size_in_mb - default&lt;br/&gt;
row_cache_provider: SerializingCacheProvider&lt;/p&gt;

&lt;p&gt;MAX_HEAP_SIZE=&quot;8G&quot;&lt;br/&gt;
HEAP_NEWSIZE=&quot;2G&quot;&lt;/p&gt;


&lt;p&gt;Thanks for any help.&lt;/p&gt;</comment>
                            <comment id="13293481" author="slebresne" created="Tue, 12 Jun 2012 09:48:55 +0000"  >&lt;p&gt;I believe this is the same than &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4321&quot; title=&quot;stackoverflow building interval tree &amp;amp; possible sstable corruptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4321&quot;&gt;&lt;del&gt;CASSANDRA-4321&lt;/del&gt;&lt;/a&gt; and being tracked there.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12527850" name="0001-Make-sure-Leveled-compaction-always-use-the-right-min-.txt" size="4637" author="slebresne" created="Thu, 17 May 2012 16:01:37 +0000"/>
                            <attachment id="12526201" name="4233-assert.txt" size="4037" author="jbellis" created="Wed, 9 May 2012 20:00:02 +0000"/>
                            <attachment id="12527852" name="4233-v2.txt" size="1425" author="jbellis" created="Thu, 17 May 2012 16:38:55 +0000"/>
                            <attachment id="12527855" name="4233-v3.txt" size="1841" author="jbellis" created="Thu, 17 May 2012 16:48:31 +0000"/>
                            <attachment id="12527904" name="4233-v4.txt" size="3320" author="jbellis" created="Thu, 17 May 2012 20:11:56 +0000"/>
                            <attachment id="12526534" name="system.log.bz2" size="7623" author="brandon.williams" created="Fri, 11 May 2012 15:06:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>238799</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gtjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96216</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>