<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4655] Truncate operation doesn&apos;t delete rows from HintsColumnFamily.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4655</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;br/&gt;
1. Start writing of data to some column family, let name it &apos;MyCF&apos;&lt;br/&gt;
2. Stop 1 node&lt;br/&gt;
3. Wait some time (until some data will be collected in HintsColumnFamily)&lt;br/&gt;
4. Start node (HintedHandoff will be started automatically for &apos;MyCF&apos;)&lt;br/&gt;
5. Run &apos;truncate&apos; command for &apos;MyCF&apos; column family from command from cli&lt;br/&gt;
6. Wait until truncate will be finished&lt;br/&gt;
7. You will see that &apos;MyCF&apos; is not empty because HintedHandoff is copying data &lt;/p&gt;

&lt;p&gt;So, I suggest to clean HintsColumnFamily (for truncated column family) before we had started to discard sstables. &lt;br/&gt;
I think it should be done in CompactionManager#submitTrucate() method. I can try to create patch but I need to know right way of cleaning HintsColumnFamily. Could you clarify it?&lt;/p&gt;</description>
                <environment>&lt;p&gt;Centos 6.2, Cassandra 1.1.4 (DataStax distribution), three-nodes cluster.&lt;/p&gt;</environment>
        <key id="12607241">CASSANDRA-4655</key>
            <summary>Truncate operation doesn&apos;t delete rows from HintsColumnFamily.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="azotcsit">Aleksei Zotov</reporter>
                        <labels>
                            <label>hintedhandoff</label>
                            <label>truncate</label>
                    </labels>
                <created>Wed, 12 Sep 2012 13:48:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:27 +0000</updated>
                            <resolved>Thu, 23 May 2013 15:07:46 +0000</resolved>
                                        <fixVersion>1.2.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13460603" author="jbellis" created="Fri, 21 Sep 2012 16:35:56 +0000"  >&lt;p&gt;Maybe it would be easier to record truncate time and drop hints older than that on replay, than to make truncate a two-pass operation.&lt;/p&gt;</comment>
                            <comment id="13461690" author="azotcsit" created="Mon, 24 Sep 2012 08:57:36 +0000"  >&lt;p&gt;Good idea. I&apos;ll try to implement it.&lt;/p&gt;</comment>
                            <comment id="13463614" author="azotcsit" created="Wed, 26 Sep 2012 08:24:36 +0000"  >&lt;p&gt;Patch has been attached. Please review it.&lt;/p&gt;</comment>
                            <comment id="13463889" author="jbellis" created="Wed, 26 Sep 2012 15:20:07 +0000"  >&lt;p&gt;Two things:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Need to store last truncation time across server restart.  Storing these as a Map in &lt;tt&gt;system.local&lt;/tt&gt; is one option.  (&lt;tt&gt;system&lt;/tt&gt; columnfamilies are defined in CFMetaData.)&lt;/li&gt;
	&lt;li&gt;Instead of skipping the entire hint if any component CF has been truncated, should generate a new RowMutation with only untruncated CF data in it.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13492722" author="jbellis" created="Wed, 7 Nov 2012 21:33:11 +0000"  >&lt;p&gt;Are you still working on this, Alexey?&lt;/p&gt;</comment>
                            <comment id="13511284" author="azotcsit" created="Thu, 6 Dec 2012 11:48:34 +0000"  >&lt;p&gt;Jonathan, I&apos;m sorry for so long delay and a silence from my side. &lt;br/&gt;
I&apos;ve created another patch against current trunk (46f1c7fabd6a7102a7a363bcfdc40c62a3bdc461). It uses local column family as you suggested. I tested it on three-nodes ccm cluster with replication factor 2. Steps:&lt;br/&gt;
1. load 150KB per node&lt;br/&gt;
2. stop one of them&lt;br/&gt;
3. wait until both live nodes will have about 20MB of data&lt;br/&gt;
4. stop loading of data&lt;br/&gt;
5. start downed node&lt;br/&gt;
6. wait 3-5 seconds after start of hints delivery process and truncate data&lt;br/&gt;
7. wait until data will be successfully truncated&lt;br/&gt;
Results:&lt;br/&gt;
Nodes which were not stopped are completely empty. Another node &lt;span class=&quot;error&quot;&gt;&amp;#91;that was stopped&amp;#93;&lt;/span&gt; contains about several tens rows but all their were marked as deleted. Note that the both nodes which weren&apos;t stopped before truncate operation has about 5-6 thousands of rows.&lt;/p&gt;

&lt;p&gt;Please review the patch.&lt;/p&gt;</comment>
                            <comment id="13586862" author="azotcsit" created="Tue, 26 Feb 2013 06:43:17 +0000"  >&lt;p&gt;Is there any progress on review?&lt;/p&gt;</comment>
                            <comment id="13588180" author="vijay2win@yahoo.com" created="Wed, 27 Feb 2013 09:47:15 +0000"  >&lt;p&gt;Overall LGTM, &lt;/p&gt;

&lt;p&gt;Do we really need to remove removeTruncationTime? IMHO it might be a useful information for the user to query.&lt;br/&gt;
Instead of caching the truncatedAt in CFS can we just cache it in deliverHintsToEndpointInternal? coz it wont be thread safe in CFS anyways.&lt;/p&gt;</comment>
                            <comment id="13612753" author="jbellis" created="Mon, 25 Mar 2013 15:54:00 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azotcsit&quot; class=&quot;user-hover&quot; rel=&quot;azotcsit&quot;&gt;azotcsit&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13664676" author="jbellis" created="Wed, 22 May 2013 23:24:15 +0000"  >&lt;p&gt;v3 attached.  I&apos;ve retained removing obsolete truncation information; otherwise, in the case of creating many temporary tables we will cause problems eventually.&lt;/p&gt;

&lt;p&gt;Moved caching to HHOM.  Also combined the new hint time with the existing truncated_at blob for simplicity and to make sure both get updated as a group.&lt;/p&gt;</comment>
                            <comment id="13664804" author="vijay2win@yahoo.com" created="Thu, 23 May 2013 02:33:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13665252" author="jbellis" created="Thu, 23 May 2013 15:07:46 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12584401" name="4655-v3.txt" size="10921" author="jbellis" created="Wed, 22 May 2013 23:24:15 +0000"/>
                            <attachment id="12556263" name="cassandra-1.2-4655-hints_truncation-v2.txt" size="12227" author="azotcsit" created="Thu, 6 Dec 2012 11:48:34 +0000"/>
                            <attachment id="12546659" name="cassandra-1.2-4655-hints_truncation.txt" size="3727" author="azotcsit" created="Wed, 26 Sep 2012 08:22:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250235</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 26 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0awfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61527</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vijay2win@yahoo.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>