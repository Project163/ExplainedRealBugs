<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11332] nodes connect to themselves when NTS is used</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11332</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I tested this with both the simple snitch and PFS.  It&apos;s quite easy to repro, setup a cluster, start it.  Mine looks like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;tcp        0      0 10.208.8.123:48003      10.208.8.63:7000        ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:7000       10.208.8.63:40215       ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:55559      10.208.35.225:7000      ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:33498      10.208.8.63:7000        ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:7000       10.208.35.225:52530     ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:7000       10.208.35.225:53674     ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:40846      10.208.35.225:7000      ESTABLISHED 26254/java
tcp        0      0 10.208.8.123:7000       10.208.8.63:48880       ESTABLISHED 26254/java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No problems so far.  Now create a keyspace using NTS with an rf of 3, and perform some writes.  Now it looks like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;tcp        0      0 10.208.8.123:48003      10.208.8.63:7000        ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:7000       10.208.8.123:35024      ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:35024      10.208.8.123:7000       ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:47212      10.208.8.123:7000       ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:7000       10.208.8.63:40215       ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:55559      10.208.35.225:7000      ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:33498      10.208.8.63:7000        ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:7000       10.208.35.225:52530     ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:7000       10.208.35.225:53674     ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:7000       10.208.8.123:47212      ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:40846      10.208.35.225:7000      ESTABLISHED 26254/java      
tcp        0      0 10.208.8.123:7000       10.208.8.63:48880       ESTABLISHED 26254/java  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can&apos;t think of any reason for a node to connect to itself, and this can cause problems with PFS where you might only define the broadcast addresses, but now you need the internal addresses too because the node will need to look itself up when connecting to itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12948554">CASSANDRA-11332</key>
            <summary>nodes connect to themselves when NTS is used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blambov">Branimir Lambov</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2016 21:34:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:39 +0000</updated>
                            <resolved>Thu, 1 Sep 2016 21:16:04 +0000</resolved>
                                        <fixVersion>2.2.8</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15188098" author="brandon.williams" created="Wed, 9 Mar 2016 21:42:39 +0000"  >&lt;p&gt;I should note that all my nodes are in a single DC, and I reproduced this on 2.1 head but it probably runs through all the versions.&lt;/p&gt;</comment>
                            <comment id="15189031" author="slebresne" created="Thu, 10 Mar 2016 10:25:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;I can&apos;t think of any reason for a node to connect to itself&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is quite a few places where we don&apos;t special case the local case and just go through &lt;tt&gt;MessagingService&lt;/tt&gt; even for localhost out of simplicity. Of the top of my head I believe that&apos;s at least the case for truncation, repair and most of Paxos messages, but I&apos;m sure I&apos;m missing some. And &lt;tt&gt;MessagingService&lt;/tt&gt; don&apos;t special case the local host either.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that afaict normal writes and schema both do special case the local host so I&apos;m not sure why you can reproduce with just adding a keyspace and doing a few writes (unless those write include LWT in which that&apos;s definitively due to Paxos), but I&apos;m sure I&apos;m forgotting something that is not special cases and I&apos;m not surprised at all.&lt;/p&gt;

&lt;p&gt;Now, we could modify &lt;tt&gt;MessagingService&lt;/tt&gt; I suppose to special case local messages, though we still want sending to be non-blocking so we&apos;ll still need a specific thread with a queue, and we probably still want to preserve the protection we have like dropping messages too old (which, while I&apos;m fine implementing that solution, make me uncomfortable doing it on an old branch).&lt;/p&gt;

&lt;p&gt;But truth is, I&apos;m not sure I understand the concrete consequence this has for &lt;tt&gt;PropertyFileSnitch&lt;/tt&gt; (that is, have you noticed a genuine bug due to this?) but we could also fix it so it recognize that both broadcast and listen addresses mean the same thing.&lt;/p&gt;</comment>
                            <comment id="15189577" author="brandon.williams" created="Thu, 10 Mar 2016 17:19:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;But truth is, I&apos;m not sure I understand the concrete consequence this has for PropertyFileSnitch (that is, have you noticed a genuine bug due to this?)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I actually saw someone using PFS get bitten by this.  If your nodes always use BCA, you&apos;d think you only need BCA IPs in the property file.  But since the node connects to itself on listen_address, now you need to have that internal IP in the file as well or have a default, or it will complain about not being able to find it when it connects to itself.  Since the property file should be the same everywhere, now you have to add &lt;b&gt;all&lt;/b&gt; the internal listen_address IPs to the property file in addition to the BCAs (setting a default isn&apos;t viable in a multi-dc configuration.)  GPFS gets around this by pure luck since we&apos;re pulling it via gossip for the endpoint.&lt;/p&gt;</comment>
                            <comment id="15189862" author="joseph.nottingham@gmail.com" created="Thu, 10 Mar 2016 20:01:38 +0000"  >&lt;p&gt;My team was affected by this, using AWS private ips for listen_address and public ips for broadcast_address. Public ips were in the PropertyFileSnitch. We are using NTS, and replication of 3 as Brandon demonstrated. The effect we were seeing was high rate of failure for LOCAL_QUORUM requests. We temporarily hacked the local addresses into the topology config for now.&lt;/p&gt;</comment>
                            <comment id="15190969" author="slebresne" created="Fri, 11 Mar 2016 14:15:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;or it will complain about not being able to find it when it connects to itself&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe you, but it would still be a little bit more useful to have a proper stack of the error, or in which way it &quot;complains&quot;.&lt;/p&gt;

&lt;p&gt;Anyway, my preference for fixing it when it goes to 2.1/2.2/3.0 would be to fix it in PFS, having it recognize your &lt;tt&gt;listen_address&lt;/tt&gt; when asked for it and use the BCA instead to figure out the DC and rack. That ought to be simple and safe. Changing MessagingService to special case the local path is doable, but as said above a tad more involved.&lt;/p&gt;</comment>
                            <comment id="15201442" author="blambov" created="Fri, 18 Mar 2016 13:06:54 +0000"  >&lt;p&gt;Patch adding local address to &lt;tt&gt;PropertyFileSnitch&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11332-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest &lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9421-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;This is an LHF-hackathon fix to the concrete problem, I think we should consider a more thorough investigation of where and how we use local addresses in token/rack/dc/etc. lookups.&lt;/p&gt;</comment>
                            <comment id="15456641" author="carlyeks" created="Thu, 1 Sep 2016 21:16:04 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Committed as &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/cassandra/commit/ad4a91da7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ad4a91da7&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I didn&apos;t put this into 2.1 as it doesn&apos;t seem like a critical fix, but did put it into 2.2+.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ufef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>