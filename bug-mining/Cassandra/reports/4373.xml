<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11988] NullPointerException when reading/compacting table</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11988</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have a table that suddenly refuses to be read or compacted. Issuing a read on the table causes a NPE.&lt;/p&gt;

&lt;p&gt;On compaction, it returns the error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:6] 2016-06-09 17:10:15,724 CassandraDaemon.java:213 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:6,1,main]
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.db.transform.UnfilteredRows.isEmpty(UnfilteredRows.java:38) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:64) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:24) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:76) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:226) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:182) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:82) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60) ~[apache-cassandra-3.6.jar:3.6]
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:264) ~[apache-cassandra-3.6.jar:3.6]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_45]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Schema:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE cmpayments.report_payments (
    reportid timeuuid,
    userid timeuuid,
    adjustedearnings decimal,
    deleted set&amp;lt;timeuuid&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
    earnings map&amp;lt;timeuuid, decimal&amp;gt;,
    gross map&amp;lt;timeuuid, decimal&amp;gt;,
    organizationid text,
    payall timestamp &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
    status text,
    PRIMARY KEY (reportid, userid)
) WITH CLUSTERING ORDER BY (userid ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = {&lt;span class=&quot;code-quote&quot;&gt;&apos;keys&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;ALL&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;rows_per_partition&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NONE&apos;&lt;/span&gt;}
    AND comment = &apos;&apos;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;min_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;}
    AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;chunk_length_in_kb&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;64&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;&lt;/span&gt;}
    AND crc_check_chance = 1.0
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99PERCENTILE&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12977459">CASSANDRA-11988</key>
            <summary>NullPointerException when reading/compacting table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="nimi">Nimi Wariboko Jr.</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Jun 2016 01:02:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:30 +0000</updated>
                            <resolved>Wed, 20 Jul 2016 12:36:57 +0000</resolved>
                                        <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15329056" author="adeon" created="Tue, 14 Jun 2016 08:03:34 +0000"  >&lt;p&gt;We experience the same issue with Cassandra 3.0.6 too. This bug makes data inaccessible. It might be related to static columns because we use them too&lt;/p&gt;</comment>
                            <comment id="15329066" author="bkowalczyyk" created="Tue, 14 Jun 2016 08:07:27 +0000"  >&lt;p&gt;Same issue with Cassandra 3.0.6&lt;/p&gt;</comment>
                            <comment id="15329089" author="adam suflida" created="Tue, 14 Jun 2016 08:17:35 +0000"  >&lt;p&gt;We encountered the same issue with Cassandra 3.0.6 - we are not able to read data anymore due to this error.&lt;/p&gt;</comment>
                            <comment id="15331441" author="marekasf" created="Wed, 15 Jun 2016 09:29:06 +0000"  >&lt;p&gt;Some more details to identify issue in 3.0.7:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it happens only with static column&lt;/li&gt;
	&lt;li&gt;it might be related to setting null to static column value&lt;/li&gt;
	&lt;li&gt;I identified that org.apache.cassandra.db.ReadCommand$1WithoutPurgeableTombstones transformation returns null in org.apache.cassandra.db.transform.BaseRows.add(...) method so staticRow is set to null&lt;/li&gt;
	&lt;li&gt;There can be also some data corruption because we lost at least one partition row after it happened&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is naive fix to mitigate this issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/src/java/org/apache/cassandra/db/transform/BaseRows.java b/src/java/org/apache/cassandra/db/transform/BaseRows.java
index 78526e8..bc92b41 100644
--- a/src/java/org/apache/cassandra/db/transform/BaseRows.java
+++ b/src/java/org/apache/cassandra/db/transform/BaseRows.java
@@ -1,17 +1,24 @@
 &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.cassandra.db.transform;
 
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.apache.cassandra.utils.Throwables.merge;
+
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.config.CFMetaData;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.DecoratedKey;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.PartitionColumns;
-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.rows.*;
-
-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.apache.cassandra.utils.Throwables.merge;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.rows.BaseRowIterator;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.rows.RangeTombstoneMarker;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.rows.Row;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.db.rows.Unfiltered;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.slf4j.Logger;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.slf4j.LoggerFactory;
 
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BaseRows&amp;lt;R &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Unfiltered, I &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BaseRowIterator&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Unfiltered&amp;gt;&amp;gt;
 &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BaseIterator&amp;lt;Unfiltered, I, R&amp;gt;
 &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; BaseRowIterator&amp;lt;R&amp;gt;
 {
 
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger logger = LoggerFactory.getLogger(BaseRows.class);
+
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Row staticRow;
 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; BaseRows(I input)
@@ -82,7 +89,14 @@ &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; BaseRowIterator&amp;lt;R&amp;gt;
         &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.add(transformation);
 
         &lt;span class=&quot;code-comment&quot;&gt;// transform any existing data
&lt;/span&gt;-        staticRow = transformation.applyToStatic(staticRow);
+        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Row afterTransform = transformation.applyToStatic(staticRow);
+
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (staticRow != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; afterTransform == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
+            logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Transformation returns NULL value : &quot;&lt;/span&gt; + transformation);
+
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (afterTransform != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
+            staticRow = afterTransform;
+
         next = applyOne(next, transformation);
     }
 
diff --git a/src/java/org/apache/cassandra/db/transform/UnfilteredRows.java b/src/java/org/apache/cassandra/db/transform/UnfilteredRows.java
index 98640ae..e497bef 100644
--- a/src/java/org/apache/cassandra/db/transform/UnfilteredRows.java
+++ b/src/java/org/apache/cassandra/db/transform/UnfilteredRows.java
@@ -35,6 +35,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;UnfilteredRows &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BaseRows&amp;lt;Unfiltered, UnfilteredRowIterator&amp;gt; i
     @Override
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEmpty()
     {
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (staticRow() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; staticRow().isEmpty() &amp;amp;&amp;amp; partitionLevelDeletion().isLive() &amp;amp;&amp;amp; !hasNext();
     }
 }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15331667" author="carlyeks" created="Wed, 15 Jun 2016 12:51:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marekasf&quot; class=&quot;user-hover&quot; rel=&quot;marekasf&quot;&gt;marekasf&lt;/a&gt; This is really helpful; it definitely focuses the work on this a lot. I&apos;ll report back when I have something more.&lt;/p&gt;</comment>
                            <comment id="15334626" author="carlyeks" created="Thu, 16 Jun 2016 20:35:03 +0000"  >&lt;p&gt;This issue has been happening all the way back to 3.0; it was caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9975&quot; title=&quot;Flatten Iterator call hierarchy with a shared Transformer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9975&quot;&gt;&lt;del&gt;CASSANDRA-9975&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We hit this condition when we have tombstoned a static column, and are ready to delete it. I was able to reproduce by setting &lt;tt&gt;gc_grace_seconds&lt;/tt&gt; to 0, and then doing some tombstones of static columns.&lt;/p&gt;

&lt;p&gt;Looking at the usages of &lt;tt&gt;BaseRows.staticRow()&lt;/tt&gt;, I&apos;m worried that other places might have the same issue; they take the static row, expecting it to be non-null, and call &lt;tt&gt;isEmpty()&lt;/tt&gt; on it.&lt;/p&gt;</comment>
                            <comment id="15334641" author="bkowalczyyk" created="Thu, 16 Jun 2016 20:44:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; according to &quot;I&apos;m worried that other places might have the same issue;&quot;.  Can deletion of those static columns  protect us from such data corruption in future ?&lt;/p&gt;</comment>
                            <comment id="15336253" author="carlyeks" created="Fri, 17 Jun 2016 14:57:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bkowalczyyk&quot; class=&quot;user-hover&quot; rel=&quot;bkowalczyyk&quot;&gt;bkowalczyyk&lt;/a&gt;: It is actually the deletion of the static columns that is causing this issue, but I don&apos;t think there is presently any data corruption - we need a fix to be able to compact and read this data, but it shouldn&apos;t be changed on disk at this point (as we can&apos;t compact it away).&lt;/p&gt;

&lt;p&gt;I&apos;m working today on a fix.&lt;/p&gt;</comment>
                            <comment id="15336877" author="carlyeks" created="Fri, 17 Jun 2016 20:25:31 +0000"  >&lt;p&gt;I had a &lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/11988/3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fix&lt;/a&gt;, but there seems to be a dependency between the change to return null for empty static rows and early reopen, so there are failing unit tests.&lt;/p&gt;

&lt;p&gt;I&apos;ll work on a different fix on Monday which will just target the possibly bad usages.&lt;/p&gt;</comment>
                            <comment id="15340383" author="nimi" created="Mon, 20 Jun 2016 20:54:29 +0000"  >&lt;p&gt;Carl Yeksigian,&lt;/p&gt;

&lt;p&gt;Are you aware if your fix will work with sstabledump? I need to find a way to export/dump this data. This bug also prevents me from bootstrapping new nodes (they fail to stream this table), and obviously I can&apos;t work with the problematic partitions in the mean time.&lt;/p&gt;</comment>
                            <comment id="15340413" author="carlyeks" created="Mon, 20 Jun 2016 21:15:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nimi&quot; class=&quot;user-hover&quot; rel=&quot;nimi&quot;&gt;nimi&lt;/a&gt;: Is there currently an issue with sstabledump?&lt;/p&gt;

&lt;p&gt;I believe this issue is only be affecting the read path where the static row has been tombstoned, and sstabledump doesn&apos;t use the same read path. If you are having issues, that might be related, or it might be something else.&lt;/p&gt;</comment>
                            <comment id="15340416" author="nimi" created="Mon, 20 Jun 2016 21:18:16 +0000"  >&lt;p&gt;Okay good to know,&lt;/p&gt;

&lt;p&gt;I just did an initial test, and while the CQL Representation seems to work fine, the JSON output returns some errors.&lt;/p&gt;

&lt;p&gt;Nimi&lt;/p&gt;</comment>
                            <comment id="15340433" author="nimi" created="Mon, 20 Jun 2016 21:25:35 +0000"  >&lt;p&gt;Also, for anyone that comes across this, it looks like a temporarily pushed out the issue by increasing gc_grace_seconds.&lt;/p&gt;</comment>
                            <comment id="15382772" author="carlyeks" created="Mon, 18 Jul 2016 18:18:47 +0000"  >&lt;p&gt;Not sure what happened, but in the time since I last ran this, the &lt;tt&gt;SSTableRewriterTest&lt;/tt&gt; is happy on this branch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;: can you take review on this? This is a really simple fix, which I&apos;m afraid is actually naive.&lt;/p&gt;</comment>
                            <comment id="15384140" author="slebresne" created="Tue, 19 Jul 2016 13:25:36 +0000"  >&lt;p&gt;I&apos;m a little worried of making the &lt;tt&gt;filter&lt;/tt&gt; and &lt;tt&gt;purge&lt;/tt&gt; methods, which depend on &lt;tt&gt;transformAndFilter&lt;/tt&gt;, behave differently if the row is static or not. The semantic &quot;returns null if everything is filtered&quot; feels easier to remember if you don&apos;t add &quot;unless it&apos;s a static row, in which case it returns an empty row&quot;. And more concretely, I can&apos;t swear without concrete inspection that there isn&apos;t code that actually expect &lt;tt&gt;null&lt;/tt&gt; from those method to detect full purge (it&apos;s admitedly unlikely in that case though).&lt;/p&gt;

&lt;p&gt;Anyway, the issue is that the code expects the &lt;tt&gt;staticRow()&lt;/tt&gt; method of &lt;tt&gt;UnfilteredRowIterator&lt;/tt&gt; to never return &lt;tt&gt;null&lt;/tt&gt; (it&apos;s kind of part of its contract even though it&apos;s not all that clearly stated right now), and I prefer fixing that by brute-forcing &lt;tt&gt;BaseRows.staticRow()&lt;/tt&gt; to never return &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a patch to do so below. The patch does the same &lt;tt&gt;AbstractBTreePartition&lt;/tt&gt; to be on the safe side (I believe it&apos;s theoretically possible to have the static row null today because &lt;tt&gt;Row.updateAllTimestamp&lt;/tt&gt; can also theoretically return null, but I&apos;m not sure at all this can be practically triggered).&lt;/p&gt;

&lt;p&gt;The patch also adds a few precisions to javadocs regarding those behavior as well as minor cleanups I did while looking at that (apologies on the latter, shouldn&apos;t pollute patch like that in general, but figured it&apos;s simple enough here and couldn&apos;t help myself). I&apos;ve also added a simple unit test to reproduce the issue for good measure. &lt;/p&gt;

&lt;p&gt;Let me know if that work for you.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11988-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11988-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11988-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11988-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11988-3.9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11988-3.9&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11988-3.9-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11988-3.9-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15384210" author="carlyeks" created="Tue, 19 Jul 2016 14:21:01 +0000"  >&lt;p&gt;That does look like a better way to fix it.&lt;/p&gt;

&lt;p&gt;+1 once CI is clean&lt;/p&gt;</comment>
                            <comment id="15385775" author="slebresne" created="Wed, 20 Jul 2016 12:36:46 +0000"  >&lt;p&gt;Strangely, the 3.0 run has a unit test failure on a &lt;tt&gt;SSTableRewriterWriter&lt;/tt&gt; like you also reported. That said, it&apos;s not on the 3.9 branch, even though the patch merge cleanly, I wasn&apos;t able to reproduce in 10+ runs, and I really can&apos;t see how this patch could ever &quot;break&quot; &lt;tt&gt;SSTableRewriter&lt;/tt&gt;. I&apos;m further pretty confident returning an empty static row from &lt;tt&gt;UnfilteredRowIterator&lt;/tt&gt; is the right thing to do and that&apos;s all what this patch does, so I suspect a rare flaky test and some uncanny coincidence. So I committed, but I&apos;ll keep an eye on CI runs in the near term to see if that test start failing regularly.&lt;/p&gt;</comment>
                            <comment id="15387981" author="nothau" created="Thu, 21 Jul 2016 16:22:15 +0000"  >&lt;p&gt;FYI, we&apos;re having the same issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12215&quot; title=&quot;NullPointerException during Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12215&quot;&gt;&lt;del&gt;CASSANDRA-12215&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I implemented the patch, set gc_grace_seconds to 86400, and still ran into the error.  Setting the gc_grace_seconds to something high, all rows show up, including the ones that are supposed to be tombstones.  &lt;/p&gt;</comment>
                            <comment id="15397598" author="eprothro" created="Thu, 28 Jul 2016 14:25:47 +0000"  >&lt;p&gt;I&apos;m with Hau. We&apos;re eager to see this resolved in 3.0.9 if at all possible. To be clear, the current patch does not fix the issue for us, compaction still fails.&lt;/p&gt;

&lt;p&gt;Currently we&apos;re working around this by effectively disabling compaction with an extremely high value for `gc_grace_seconds` on tables with static fields. Clearly the shorter we have to live with that workaround the less nervous we are.&lt;/p&gt;

&lt;p&gt;Please don&apos;t hesitate to let us know anything we can do to help isolate or reproduce. As Hau mentioned, we can provide an sstable and schema that should reproduce.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12989899">CASSANDRA-12215</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13001795">CASSANDRA-12582</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12993291">CASSANDRA-12336</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12851320">CASSANDRA-9975</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z9gn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>