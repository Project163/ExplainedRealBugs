<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15553] Preview repair should include sstables from finalized incremental repair sessions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15553</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running a preview repair we currently grab all repaired sstables, problem is that we depend on compaction to move the sstables from pending to repaired so we might have different data marked repaired on different nodes. Including any sstables from finalized incremental repair sessions as repaired will solve this.&lt;/p&gt;

&lt;p&gt;Another problem is that validations don&apos;t start at exactly the same time on different nodes, so if an incremental repair finishes while the preview repair is running we might also validate the wrong repaired set. We should fail the preview repair if an intersecting incremental repair finishes during the preview repair.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13283638">CASSANDRA-15553</key>
            <summary>Preview repair should include sstables from finalized incremental repair sessions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Feb 2020 07:12:41 +0000</created>
                <updated>Mon, 21 Dec 2020 08:08:19 +0000</updated>
                            <resolved>Mon, 2 Mar 2020 08:30:42 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17031330" author="krummas" created="Thu, 6 Feb 2020 07:19:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/previewrepairfix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/workflow-run/9ee445fb-8ac7-44e3-b74e-345734b312c3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cci&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Patch includes sstables from finalized sessions in the repaired set. Also adds a state change listener interface to `LocalSessions` which preview repair `RepairSession` listens to to fail any intersecting preview repairs. &lt;/p&gt;</comment>
                            <comment id="17040445" author="bdeggleston" created="Wed, 19 Feb 2020 21:23:58 +0000"  >&lt;p&gt;looks good, I just have a few minor things:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;CassandraValidationIterator.java:61 - stray whitespace at top of class def&lt;/li&gt;
	&lt;li&gt;LocalSessions$Listener - it would be nice to have a more descriptive method name `onIncrementalStateChange` or something. We have at least a few listeners with generic `onStateChange` methods&lt;/li&gt;
	&lt;li&gt;&#160;RepairSession#stateChange - we should return after forcingShutdown. Alternatively, we could use &lt;tt&gt;Iterables.any(ranges(), r -&amp;gt; r.intersects(session.ranges)&lt;/tt&gt;&#160;instead of iterating over the ranges.&lt;/li&gt;
	&lt;li&gt;RepairSession#involvesTables - includesSSTables or containsSSTables might be a better name&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17040506" author="dcapwell" created="Wed, 19 Feb 2020 23:17:00 +0000"  >&lt;p&gt;Took a look and had to look closer at IR messaging, what I see is the following&lt;/p&gt;

&lt;p&gt;IR messaging is fire-and-forget pattern, so any ephemeral issues lead to messages not being seen (tests show this &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15564&quot; title=&quot;Refactor repair coordinator so errors are consistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15564&quot;&gt;&lt;del&gt;CASSANDRA-15564&lt;/del&gt;&lt;/a&gt; and have been reported as issues with current repair &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15566&quot; title=&quot;Repair coordinator can hang under some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15566&quot;&gt;CASSANDRA-15566&lt;/a&gt;).  This patch relies on the FINALIZE_COMMIT_MSG being seen on the coordinator of the IR preview repair in order to detect conflict, but the message is seen asynchronously so may see this on the participants while validation is running and seen on the coordinator after all validations have been seen on the coordinator (so session is already complete); in this case you have the same issue as reported by this JIRA.&lt;/p&gt;

&lt;p&gt;This patch also affectively blocks preview and IR running for the same range as the preview will fail with conflict*, so IR should stop scheduling if preview is running, and preview should not be scheduled while IR is running (else we waste the resources on validation); effectively what ever is scheduling the repairs will have to be enhanced to handle this which adds more complexity to operators.&lt;/p&gt;

&lt;p&gt;I actually wonder if we can remove this restriction.  What it looks like to me is that repairedAt is system time (aka, could have drift, could roll backwards, etc.), but we could keep track of largest one and make sure this counter is monotonic.  With a data structure of &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;largest contiguous commit (long)&lt;/li&gt;
	&lt;li&gt;inFlight (array of long)&lt;/li&gt;
	&lt;li&gt;committed but not contagious (array of longs, its to represent cases where inFlight commits out of order)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We could make sure that we (coordinator) always produce a repairedAt larger than any we know of, and this lets preview take a snapshot of the state at the start of coordination. With this snapshot, we filter for repaired and repairedAt &amp;lt;= largest contiguous commit snapshot; this should give preview repair effectively snapshot isolation (assuming compaction also maintains repairedAt).&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15564&quot; title=&quot;Refactor repair coordinator so errors are consistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15564&quot;&gt;&lt;del&gt;CASSANDRA-15564&lt;/del&gt;&lt;/a&gt; I show that preview doesn&apos;t properly check session failures, run &lt;a href=&quot;https://github.com/apache/cassandra/pull/446/files#diff-af4a07a2b44695f510dddb0c102e1953R28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this test&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/pull/446/files#diff-ca9f3b43ad8ff955d6ddd2ef4d2b6904R28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this one&lt;/a&gt; without the change in the JIRA to see it.  The reason your tests are different is because you don&apos;t use nodetool and directly monitor notifications.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17040546" author="bdeggleston" created="Thu, 20 Feb 2020 01:17:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;assuming compaction also maintains repairedAt&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;not in a way that would make this possible. Once an sstable gets into the repaired bucket, it will be compacted with other repaired sstables, potentially with different repaired at timestamps (and keeping the min timestamp, I believe) .&lt;/p&gt;</comment>
                            <comment id="17040573" author="dcapwell" created="Thu, 20 Feb 2020 02:04:48 +0000"  >&lt;p&gt;Yeah, that complicates things a little bit, would need to think about it more.&lt;/p&gt;</comment>
                            <comment id="17040575" author="dcapwell" created="Thu, 20 Feb 2020 02:12:28 +0000"  >&lt;p&gt;If compaction only compacted &amp;lt;= &quot;largest contiguous&quot; then it would work, the big risk is if there are bugs in IR where we can&apos;t promote that because of gaps (caused by ephemeral issues such as message loss, so would require &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15566&quot; title=&quot;Repair coordinator can hang under some cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15566&quot;&gt;CASSANDRA-15566&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17043222" author="krummas" created="Mon, 24 Feb 2020 08:33:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;CassandraValidationIterator.java:61 - stray whitespace at top of class def&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commit/142d11c1539ed677dfd4e1f21fb09a6fd68b79fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/142d11c1539ed677dfd4e1f21fb09a6fd68b79fc&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;LocalSessions$Listener - it would be nice to have a more descriptive method name `onIncrementalStateChange` or something. We have at least a few listeners with generic `onStateChange` methods&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commit/c4248ddce35a14549e617379fc2fabdd275ee3a1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/c4248ddce35a14549e617379fc2fabdd275ee3a1&lt;/a&gt; (made it &lt;tt&gt;onIRStateChange&lt;/tt&gt;)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;RepairSession#stateChange - we should return after forcingShutdown. Alternatively, we could use Iterables.any(ranges(), r -&amp;gt; r.intersects(session.ranges) instead of iterating over the ranges.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commit/dd8cafea5debfb9cf90794ed3f9cc4a258681717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/dd8cafea5debfb9cf90794ed3f9cc4a258681717&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;RepairSession#involvesTables - includesSSTables or containsSSTables might be a better name&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commit/8f212ad77e53c0823a56fbc0d7da04f085200f56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/8f212ad77e53c0823a56fbc0d7da04f085200f56&lt;/a&gt; (&lt;tt&gt;includesTables&lt;/tt&gt; - we are not dealing with sstables here)&lt;/p&gt;</comment>
                            <comment id="17044304" author="krummas" created="Tue, 25 Feb 2020 10:11:55 +0000"  >&lt;p&gt;Pushed another &lt;a href=&quot;https://github.com/krummas/cassandra/commit/b28d63aed8b09f49936b06b7ec436c53ca3e5ec9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt; which should handle the case where FINALIZE_COMMIT_MSG is lost or delayed - if we encounter any pending non-finalized intersecting sstables we fail the preview repair.&lt;/p&gt;</comment>
                            <comment id="17044977" author="dcapwell" created="Tue, 25 Feb 2020 22:55:11 +0000"  >&lt;p&gt;Spoke to Marcus.  I am fine with this patch failing preview rather than producing a false positive match for mismatch, though we should also improve it so we can remove this restriction later (just not this JIRA).&lt;/p&gt;

&lt;p&gt;Ill try to look at the update later today&lt;/p&gt;</comment>
                            <comment id="17045773" author="bdeggleston" created="Wed, 26 Feb 2020 18:10:15 +0000"  >&lt;p&gt;+1, and thanks for addressing each point in it&apos;s own commit. Makes it way easier to review the changes&lt;/p&gt;</comment>
                            <comment id="17045933" author="dcapwell" created="Wed, 26 Feb 2020 21:42:21 +0000"  >&lt;p&gt;I like the use of blocking filters, glad we don&apos;t transfer them =D&lt;/p&gt;

&lt;p&gt;Some of the tests make assumptions about time using thread.sleep; this could make them flaky.  With &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15564&quot; title=&quot;Refactor repair coordinator so errors are consistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15564&quot;&gt;&lt;del&gt;CASSANDRA-15564&lt;/del&gt;&lt;/a&gt; I setup utilities for querying repair state, so if that does end up happening we can always block waiting until the repair table is updating.&lt;/p&gt;

&lt;p&gt;I made the comment that the tests only pass because we look at the notifications, but with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15564&quot; title=&quot;Refactor repair coordinator so errors are consistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15564&quot;&gt;&lt;del&gt;CASSANDRA-15564&lt;/del&gt;&lt;/a&gt; that will be fixed so can ignore that comment.&lt;/p&gt;

&lt;p&gt;A test that would be good to add would be&lt;br/&gt;
1) run preview&lt;br/&gt;
2) delay the merle tree so the coordinator doesn&apos;t see it yet&lt;br/&gt;
3) run IR, wait for it to complete&lt;br/&gt;
4) unblock merle tree&apos;s&lt;/p&gt;

&lt;p&gt;If I am reading this correctly, the preview will fail even though the validation wouldn&apos;t.&lt;/p&gt;

&lt;p&gt;I am +1&lt;/p&gt;</comment>
                            <comment id="17047048" author="dcapwell" created="Thu, 27 Feb 2020 23:27:31 +0000"  >&lt;p&gt;Blake and I both gave +1, so moving to ready to commit.&lt;/p&gt;</comment>
                            <comment id="17048869" author="krummas" created="Mon, 2 Mar 2020 08:30:42 +0000"  >&lt;p&gt;and committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0b7lc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
        <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/219d209651759cf702519a100c4f43595f7be8d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/219d209651759cf702519a100c4f43595f7be8d7&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;new in-jvm dtests and cci runs&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>