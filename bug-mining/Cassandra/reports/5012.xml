<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13851] Allow existing nodes to use all peers in shadow round</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13851</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10134&quot; title=&quot;Always require replace_address to replace existing address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10134&quot;&gt;&lt;del&gt;CASSANDRA-10134&lt;/del&gt;&lt;/a&gt; we made collision checks necessary on every startup. A side-effect was introduced that then requires a nodes seeds to be contacted on every startup. Prior to this change an existing node could start up regardless whether it could contact a seed node or not (because checkForEndpointCollision() was only called for bootstrapping nodes). &lt;/p&gt;

&lt;p&gt;Now if a nodes seeds are removed/deleted/fail it will no longer be able to start up until live seeds are configured (or itself is made a seed), even though it already knows about the rest of the ring. This is inconvenient for operators and has the potential to cause some nasty surprises and increase downtime.&lt;/p&gt;

&lt;p&gt;One solution would be to use all a nodes existing peers as seeds in the shadow round. Not a Gossip guru though so not sure of implications.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13100446">CASSANDRA-13851</key>
            <summary>Allow existing nodes to use all peers in shadow round</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="KurtG">Kurt Greaves</assignee>
                                    <reporter username="KurtG">Kurt Greaves</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Sep 2017 12:36:34 +0000</created>
                <updated>Fri, 29 Jul 2022 17:45:22 +0000</updated>
                            <resolved>Tue, 17 Apr 2018 17:16:46 +0000</resolved>
                                        <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16168008" author="beobal" created="Fri, 15 Sep 2017 15:15:18 +0000"  >&lt;p&gt;Seeds have a secondary purpose in gossip, to help shorten convergence time (though this is a little contentious, see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9206&quot; title=&quot;Remove seed gossip probability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9206&quot;&gt;CASSANDRA-9206&lt;/a&gt;). &lt;br/&gt;
If a node is restarted and cannot contact any seeds (especially if the configured seeds have been removed from the cluster), it&apos;s probably a good thing that operators are aware of that. &lt;/p&gt;</comment>
                            <comment id="16168185" author="jjirsa" created="Fri, 15 Sep 2017 17:00:08 +0000"  >&lt;p&gt;Agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; here that this is a regression. We should be able to start if all the seeds are down. Imagine doing a full cluster bounce (either all nodes at once, or one of each replica set), there&apos;s a pretty good chance you&apos;ll end up in a weird state trying to order restart based on seeds first, which is not ideal.&lt;/p&gt;</comment>
                            <comment id="16169592" author="kurtg" created="Mon, 18 Sep 2017 05:08:00 +0000"  >&lt;p&gt;Certainly agree we should make operators aware of that. Let&apos;s most definitely not do that by surprise &quot;you can&apos;t start C*&quot;. Those are the worst types of surprise. Just needs a warning on startup that no live seeds are configured IMO.&lt;br/&gt;
I&apos;ll probably have a crack at this after NGCC, not going to assign myself to it yet though in case someone else wants to have at it.&lt;/p&gt;</comment>
                            <comment id="16233892" author="kurtg" created="Wed, 1 Nov 2017 10:26:20 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...kgreav:13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...kgreav:3.11-13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Current changes pass through whatever peers exist in system.peers to the shadow round and will only use them if the first round of gossips to the seeds fail. So it will still try the seeds first, it&apos;s just if the shadow round goes longer than 5 seconds will peers be included. This allows a node to start if only peers are alive.&lt;br/&gt;
It also allows a node that doesn&apos;t need to bootstrap to start, even if it couldn&apos;t contact any peers or seeds. &lt;/p&gt;

&lt;p&gt;From what I can tell this works but open to ideas on other test cases/obvious things I&apos;ve missed.&lt;/p&gt;

&lt;p&gt;FWIW this also passed all the bootstrap dtests, if that means anything.&lt;/p&gt;

&lt;p&gt;edit: updated dtest to actually fail when there is a timeout, rather than throwing an error.&lt;/p&gt;</comment>
                            <comment id="16273459" author="jjirsa" created="Thu, 30 Nov 2017 21:16:47 +0000"  >&lt;p&gt;Who wants to review a gossip patch? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkni&quot; class=&quot;user-hover&quot; rel=&quot;jkni&quot;&gt;jkni&lt;/a&gt;, you two have touched it most recently?&lt;/p&gt;</comment>
                            <comment id="16274389" author="jasobrown" created="Fri, 1 Dec 2017 13:28:18 +0000"  >&lt;p&gt;I can add it to my (ever growing) queue, but no guarantees on promptness.&lt;/p&gt;</comment>
                            <comment id="16291566" author="beobal" created="Thu, 14 Dec 2017 20:31:12 +0000"  >&lt;p&gt;This looks pretty reasonable, but the thing that concerns me is that the &apos;starting unsafely&apos; path can be reached in 2 ways:&lt;br/&gt;
1) when a new node comes up and has no seeds (other than itself) configured, and no persisted ring info. &lt;br/&gt;
2) when a non-bootstrapping node starts up with seeds and/or peers it &lt;b&gt;could&lt;/b&gt; contact, but it&apos;s unable to reach any of them within RING_DELAY.&lt;/p&gt;

&lt;p&gt;I&apos;m not worried about the former case, it is necessary for starting a single node cluster (or the first node in a multi node cluster if starts are staggered) and is also existing behaviour post &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10134&quot; title=&quot;Always require replace_address to replace existing address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10134&quot;&gt;&lt;del&gt;CASSANDRA-10134&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The latter case though could lead to a regression of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10134&quot; title=&quot;Always require replace_address to replace existing address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10134&quot;&gt;&lt;del&gt;CASSANDRA-10134&lt;/del&gt;&lt;/a&gt;. If a new node comes up with the same address as an existing down node, and it is not bootstrapping (because it already bootstrapped, auto_bootstrap: false, or it&apos;s present in its own seed list) it will take over that address if it cannot perform the shadow round i.e. if partitioned.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Imagine doing a full cluster bounce&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is already a mechanism in place to work around a whole cluster bounce. If the whole cluster is restarted, all seeds would be in their own shadow rounds. They report this to the any node contacting them and if all seeds are found to be in that state, the node exits its own shadow round and continues to start. In large clusters, you might have to increase RING_DELAY to give all seeds a chance to enter their shadow round before other nodes start to time theirs out.&lt;/p&gt;

&lt;p&gt;Extending the shadow round targets to include known peers works well for the scenario where all seeds are down for a longer period, so I&apos;m +1 on that. I just think that to avoid regression of 10134 we still need to hard fail if a node coming up is not able to contact any seeds &lt;b&gt;or&lt;/b&gt; peers at all (unless case 1 above applies).&lt;/p&gt;

&lt;p&gt;nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;1 arg version of checkForEndpointCollision is unused&lt;/li&gt;
	&lt;li&gt;Having 2 log statements at the end of doShadowRound is a bit meaningless, as in both cases we proceed even though the state of the cluster is unknown.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16294501" author="kurtg" created="Mon, 18 Dec 2017 04:01:36 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...kgreav:13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...kgreav:3.11-13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/kgreav/cassandra/51&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Updated the patch so that a node that&apos;s not a seed won&apos;t be able to start if it can&apos;t contact any peers. TBH I don&apos;t think this is the best solution as it&apos;s still in part a regression on the old behaviour and requires you startup seeds first in a full cluster bounce, but if anyone still sees that as a major issue it can be done in a separate ticket as it&apos;s likely a bit of refactoring.&lt;/p&gt;

&lt;p&gt;dtest has also been updated.&lt;/p&gt;</comment>
                            <comment id="16309845" author="beobal" created="Wed, 3 Jan 2018 16:09:32 +0000"  >&lt;p&gt;I&apos;m +1 on this latest version, though it occurs to me that there is something else we could do to help full cluster bounces that are done in one shot (per-replica set or otherwise partial bounces will now proceed ok).&lt;/p&gt;

&lt;p&gt;Failure to receive an ack within RING_DELAY will terminate the shadow round, fatally for a node not in it&apos;s own seed list. So if we make non-seeds remain in the SR for longer than seeds, (e.g. for RING_DELAY * 2), then as long as a single seed is contactable, startup should be able to proceed.&lt;/p&gt;

&lt;p&gt;e.g. all peers have nodes 1, 2 &amp;amp; 3 configured as seeds, but 2 &amp;amp; 3 have failed. If the cluster is completely stopped and restarted, node1 will exit its SR after RING_DELAY and be available to ack the other nodes&apos; syn requests. Once other, non-seeds start to come up, they will also now ack shadow round syns. &lt;br/&gt;
This would increase startup times for a full bounce when some seeds are failing/missing, but in &quot;normal&quot; circumstances it would have no impact. &lt;br/&gt;
It wouldn&apos;t help if all of the seeds 1, 2 &amp;amp; 3 were down during a full bounce, but I&apos;d consider that tradeoff acceptable.&lt;/p&gt;</comment>
                            <comment id="16328152" author="kurtg" created="Wed, 17 Jan 2018 02:05:36 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...kgreav:13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...kgreav:3.11-13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/kgreav/cassandra/54&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Added another quick dtest to make sure that if a non-seed starts it will still join as long as the seed is started within &lt;tt&gt;RING_DELAY * 2&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16398028" author="kurtg" created="Wed, 14 Mar 2018 03:09:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; have you had a chance to review the latest? I&apos;ve rebased both dtests and patch and also uploaded a branch for trunk (now that it no longer merges).&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...kgreav:3.11-13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...kgreav:13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/kgreav/cassandra/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/kgreav/cassandra/137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16398535" author="beobal" created="Wed, 14 Mar 2018 12:51:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; sorry, I totally missed the last update, I&apos;ll try my best to look at it today.&lt;/p&gt;</comment>
                            <comment id="16398928" author="beobal" created="Wed, 14 Mar 2018 17:21:23 +0000"  >&lt;p&gt;Thanks for adding the extra delay for non-seeds, that all LTGM so I&apos;ve kicked off some dtest runs on CircleCI. If&#160;they look&#160;good&#160;I&apos;ll commit everything and update here.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/b931896e-6ebb-4513-8f0c-7b6bb8486ee0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci workflow&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/36423e6e-1763-4274-b923-d78d2947a812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci workflow&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;There were a couple of tweaks I made to the dtest, lmk if those are ok with you: &lt;a href=&quot;https://github.com/beobal/cassandra-dtest/commit/94dee685e10f8819752d7c27533ba8f59b7acb9b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/beobal/cassandra-dtest/commit/94dee685e10f8819752d7c27533ba8f59b7acb9b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One small request for future stuff, it makes reviewing iterations on patches much easier if you don&apos;t rebase/squash once the review is ongoing. Additional commits + periodically merging from the base branch makes it a lot simpler to pick out the incremental changes during the course of a review. Thanks!&lt;/p&gt;</comment>
                            <comment id="16399825" author="kurtg" created="Thu, 15 Mar 2018 02:56:06 +0000"  >&lt;p&gt;Ah sure thing. Sorry about that.&lt;/p&gt;

&lt;p&gt;dtest changes LGTM but looks like &lt;tt&gt;test_startup_non_seed_with_peers&lt;/tt&gt; is failing on trunk (unrelated to changes). I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="16425315" author="kurtg" created="Wed, 4 Apr 2018 10:42:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; Sorry for the delay, went on holidays and just got around to fixing the test. Turns out it was failing because the log message changed ever so slightly after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7544&quot; title=&quot;Allow storage port to be configurable per node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7544&quot;&gt;&lt;del&gt;CASSANDRA-7544&lt;/del&gt;&lt;/a&gt; by removing the leading slash on the IP address. I also applied your dtest changes to my branch and made some minor formatting changes.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...kgreav:3.11-13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/kgreav/cassandra/150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...kgreav:13851-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/kgreav/cassandra/148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...kgreav:13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16434866" author="kurtg" created="Thu, 12 Apr 2018 02:57:09 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;. keen on getting this in before something breaks it again. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16435026" author="beobal" created="Thu, 12 Apr 2018 07:06:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; ack. I did see the update, but have been a bit snowed under this past week. I&apos;ll get it done by Monday, latest.&lt;/p&gt;</comment>
                            <comment id="16441204" author="beobal" created="Tue, 17 Apr 2018 17:16:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt;, latest CI (after rebases) looks good committed so I&apos;ve to cassandra-3.11 in &lt;tt&gt;28ccf3fe3989d9d80063fe4d4bb048efe471936b&lt;/tt&gt; and merged to trunk. &lt;br/&gt;
I&apos;ll get the dtest committed directly.&lt;/p&gt;</comment>
                            <comment id="16441687" author="kurtg" created="Wed, 18 Apr 2018 00:04:56 +0000"  >&lt;p&gt;Thanks heaps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17569515" author="daniel.cranford" created="Thu, 21 Jul 2022 16:27:32 +0000"  >&lt;p&gt;This is still an &lt;b&gt;undocumented&lt;/b&gt; regression in the definition of a &quot;seed&quot; node. A node &lt;b&gt;will not start&lt;/b&gt; unless it can contact at least one seed node which is a detail that still hasn&apos;t made it into the &lt;a href=&quot;https://cassandra.apache.org/doc/latest/cassandra/faq/index.html#what-are-seeds&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17569535" author="brandon.williams" created="Thu, 21 Jul 2022 16:57:00 +0000"  >&lt;p&gt;Please open a ticket for that to be added to the documentation.&lt;/p&gt;</comment>
                            <comment id="17569908" author="beobal" created="Fri, 22 Jul 2022 09:55:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;A node will not start unless it can contact at least one seed node &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is not true. In fact, it was the very point of this JIRA to fix that regression, which was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10134&quot; title=&quot;Always require replace_address to replace existing address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10134&quot;&gt;&lt;del&gt;CASSANDRA-10134&lt;/del&gt;&lt;/a&gt;. If a node cannot contact any seeds during startup, it will expand the set of nodes contacted in the shadow round to include all known peers. So only if no peers at all can be reached will the node fail to start (and even then, only if the node is not a seed itself).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            
{code:java}
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
{
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (slept % 5000 == 0)
    { &lt;span class=&quot;code-comment&quot;&gt;// CASSANDRA-8072, retry at the beginning and every 5 seconds
&lt;/span&gt;        logger.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Sending shadow round GOSSIP DIGEST SYN to seeds {}&quot;&lt;/span&gt;, seeds);

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InetAddressAndPort seed : seeds)
            MessagingService.instance().send(message, seed);

        &lt;span class=&quot;code-comment&quot;&gt;// Send to any peers we already know about, but only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a seed didn&apos;t respond.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (includePeers)
        {
            logger.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Sending shadow round GOSSIP DIGEST SYN to known peers {}&quot;&lt;/span&gt;, peers);
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InetAddressAndPort peer : peers)
                MessagingService.instance().send(message, peer);
        }
        includePeers = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }

    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inShadowRound)
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;

    slept += 1000;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (slept &amp;gt; shadowRoundDelay)
    {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we got here no peers could be gossiped to. If we&lt;span class=&quot;code-quote&quot;&gt;&apos;re a seed that&apos;&lt;/span&gt;s OK, but otherwise we stop. See CASSANDRA-13851
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSeed)
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to gossip with any peers&quot;&lt;/span&gt;);

        inShadowRound = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17570067" author="daniel.cranford" created="Fri, 22 Jul 2022 15:02:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;, sorry, I miss-spoke. I appreciate the material improvement in behavior this ticket has provided. What I intended to say was&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A node will note start unless it can contact a seed node &lt;b&gt;or&lt;/b&gt; another node not also performing the shadow round&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Background: my operations guys routinely perform a full cluster bounce to ensure everything is starting from a clean state. Up until Cassandra 3.6 this worked fine. Unfortunately, due to the details of our hardware, sometimes nodes take longer to come up than usual (eg 5 minutes instead of 30 seconds). If the slow nodes happen to be the seed node/nodes, it is game over - the cluster will not start.&lt;/p&gt;

&lt;p&gt;The only way my ops guys were able to figure out how to resolve this was to give me the stack trace of the error, which I had to correlate with the source code and use `git blame` to find &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10134&quot; title=&quot;Always require replace_address to replace existing address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10134&quot;&gt;&lt;del&gt;CASSANDRA-10134&lt;/del&gt;&lt;/a&gt; and this ticket. I would not consider a bug tracker to be appropriate documentation for the semantics of a seed node, especially when the public docs state&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The ring can operate or boot without a seed; however, you will not be able to add new nodes to the cluster.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My ops guys have worked around this behavior by begrudgingly setting `cassandra.allow_unsafe_joins=true` - an undocumented workaround I found by inspecting the source code. After we upgraded from 3.9 to 3.11, I was eager to see if this ticket allowed us to remove the workaround. Unfortunately it does not, since a full cluster bounce will still fail since only seed nodes and nodes not themselves in the shadow round can release a node from the shadow round.&lt;/p&gt;

&lt;p&gt;If anything, the error message in this version is worse, since it is now incorrect. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSeed)
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to gossip with any peers&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;actually, the node was unable to gossip with any seeds and any peers not themselves in the shadow round. Peers may be alive but themselves trapped in the shadow round.&lt;/p&gt;</comment>
                            <comment id="17570116" author="beobal" created="Fri, 22 Jul 2022 16:45:55 +0000"  >&lt;p&gt;The first thing I would say is that if you routinely shutdown the entire cluster, you&apos;re going to experience unavailability. It &lt;em&gt;shouldn&apos;t&lt;/em&gt; be necessary to periodically/preemptively bounce nodes, but I appreciate that sometimes a restart is the simplest solution. If that&apos;s the case, is there a reason why it couldn&apos;t be done via a rolling bounce? That&apos;s something that many ops teams do regularly when deploying configuration changes and the like.&lt;/p&gt;

&lt;p&gt;An alternative to `cassandra.allow_unsafe_joins` would be to bump `RING_DELAY`. As described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13851?focusedCommentId=16309845&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16309845&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this comment&lt;/a&gt;, after that period, seed nodes will exit the SR whether they receive a response or not and so will be able to respond to the non-seed nodes, which remain in the SR for `RING_DELAY * 2`.&lt;/p&gt;

&lt;p&gt;Lastly, I&apos;d have to respectfully disagree with you about the accuracy of the error message. Just because the node was able to send and receive messages with some peer(s), it was unable to gossip with them due to constraints inherent in the gossip contract. i.e. Nodes in SR don&apos;t respond to peers SR requests. Perhaps we should expand on that though to include some further info on how to remedy the situation (or at least where to look).&lt;/p&gt;</comment>
                            <comment id="17570118" author="daniel.cranford" created="Fri, 22 Jul 2022 16:52:47 +0000"  >&lt;p&gt;Respectfully, the shadow round isn&apos;t documented at all (outside the source code) and gossip is barely documented. My ops guys are going to see `unable to gossip with peers` and assume there&apos;s a network issue preventing a node from talking to any of their peers and not &quot;all my peers are also stuck in this undocumented thing called the shadow round&quot;&lt;/p&gt;</comment>
                            <comment id="17570152" author="daniel.cranford" created="Fri, 22 Jul 2022 18:12:28 +0000"  >&lt;p&gt;I hope it is clear that I/we don&apos;t care that the behavior of seeds has changed. But rather that this behavior change was not made public (it is &quot;hidden&quot; in source code and bug trackers) and took us a significant amount of skilled man-hours to track down what had changed and why and what our potential workarounds were. Just a simple update to the seed docs would have helped us immensely.&lt;/p&gt;</comment>
                            <comment id="17573088" author="daniel.cranford" created="Fri, 29 Jul 2022 17:45:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; ticket added. cf &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17786&quot; title=&quot;Seed docs are out of date&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17786&quot;&gt;CASSANDRA-17786&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[KurtG]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jrdz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335055">3.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>