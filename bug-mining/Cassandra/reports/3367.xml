<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8308] Windows: Commitlog access violations on unit tests</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8308</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have four unit tests failing on trunk on Windows, all with FileSystemException&apos;s related to the SchemaLoader:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit] Test org.apache.cassandra.db.compaction.DateTieredCompactionStrategyTest FAILED
[junit] Test org.apache.cassandra.cql3.ThriftCompatibilityTest FAILED
[junit] Test org.apache.cassandra.io.sstable.SSTableRewriterTest FAILED
[junit] Test org.apache.cassandra.repair.LocalSyncTaskTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Example error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Caused by: java.nio.file.FileSystemException: build\test\cassandra\commitlog;0\CommitLog-5-1415908745965.log: The process cannot access the file because it is being used by another process.
    [junit]
    [junit]     at sun.nio.fs.WindowsException.translateToIOException(WindowsException.java:86)
    [junit]     at sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:97)
    [junit]     at sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:102)
    [junit]     at sun.nio.fs.WindowsFileSystemProvider.implDelete(WindowsFileSystemProvider.java:269)
    [junit]     at sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:103)
    [junit]     at java.nio.file.Files.delete(Files.java:1079)
    [junit]     at org.apache.cassandra.io.util.FileUtils.deleteWithConfirm(FileUtils.java:125)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12755148">CASSANDRA-8308</key>
            <summary>Windows: Commitlog access violations on unit tests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="jmckenzie">Josh McKenzie</reporter>
                        <labels>
                            <label>Windows</label>
                    </labels>
                <created>Thu, 13 Nov 2014 20:20:01 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:06 +0000</updated>
                            <resolved>Wed, 18 Feb 2015 18:41:09 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14211250" author="jmckenzie" created="Thu, 13 Nov 2014 20:31:15 +0000"  >&lt;p&gt;This looks like a test-only artifact from schemaloader attempting to delete files that are opened as RAF in Windows which causes the error.  As done in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4050&quot; title=&quot;Rewrite RandomAccessReader to use FileChannel / nio to address Windows file access violations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4050&quot;&gt;&lt;del&gt;CASSANDRA-4050&lt;/del&gt;&lt;/a&gt;, converting the CommitLogSegment to nio would resolve this deletion sharing issue, however we rely on having an integer FD for trySkipCache calls; I&apos;m not seeing an immediate method to get a FileDescriptor for a FileChannel.  If I can track something down in that vein I&apos;ll pursue converting CommitLogSegment to nio so we can avoid potential future access violations.  If not, refactoring the AbstractCommitLogService to allow stopping and restarting (rather than relying on the ctor only for functionality) should allow us to better test that component.&lt;/p&gt;</comment>
                            <comment id="14215398" author="jmckenzie" created="Mon, 17 Nov 2014 23:30:32 +0000"  >&lt;ol&gt;
	&lt;li&gt;Swapped to FileChannel on CommitLogSegment&lt;/li&gt;
	&lt;li&gt;Use reflection to grab FD out of it to use in trySkipCache (new method in CLibrary)&lt;/li&gt;
	&lt;li&gt;Added clibrary method for strerror&lt;/li&gt;
	&lt;li&gt;Added logger warning on non-0 result from trySkipCache w/error message&lt;/li&gt;
	&lt;li&gt;Tweaked logic on SchemaLoader to recursively delete contents of commitlog folder rather than the folder itself&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This fixes 3 of the 4 unit tests above; SSTableRewriterTest assumes that when a sstable is successfully deleted it won&apos;t be present in the filesystem, however on Windows when you delete a file with FILE_SHARE_DELETE and something else still has a handle to the file, it stays in its original location on the drive rather than getting removed and a link preserved in the /proc filesystem.  I&apos;ll open another ticket to make the SSTableRewriter tests more multi-platform friendly.&lt;/p&gt;

&lt;p&gt;The warning on trySkipCache has uncovered that we have invalid fd references on our trySkipCache calls in SSTR.cloneWithNewStart - I haven&apos;t dug into it yet but it might be an ordering issue where a file&apos;s deleted before we posix_fadvise it.&lt;/p&gt;</comment>
                            <comment id="14238116" author="jmckenzie" created="Mon, 8 Dec 2014 17:27:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;: any chance you&apos;d take this review this since it&apos;s similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4050&quot; title=&quot;Rewrite RandomAccessReader to use FileChannel / nio to address Windows file access violations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4050&quot;&gt;&lt;del&gt;CASSANDRA-4050&lt;/del&gt;&lt;/a&gt; (though &lt;b&gt;far&lt;/b&gt; less complicated)?&lt;/p&gt;</comment>
                            <comment id="14238128" author="benedict" created="Mon, 8 Dec 2014 17:43:37 +0000"  >&lt;p&gt;Sure. Will review tomorrow.&lt;/p&gt;</comment>
                            <comment id="14239291" author="benedict" created="Tue, 9 Dec 2014 11:28:43 +0000"  >&lt;ul&gt;
	&lt;li&gt;channel.truncate() is not equivalent to raf.setLength(), and we want the length to be set upfront to somewhat ensure contiguity&lt;/li&gt;
	&lt;li&gt;would be nice to extract the &quot;is linux&quot; decision to an enum, embed it in FBUtilities where we already have an isUnix() method (and an OPERATING_SYSTEM property, that could be converted to the enum)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14241325" author="jmckenzie" created="Wed, 10 Dec 2014 16:21:45 +0000"  >&lt;p&gt;v2 attached.  Good catch on truncate on nio - I misread the javadoc on that and also assumed they were going for functional parity with RAF.setLength.&lt;/p&gt;

&lt;p&gt;I couldn&apos;t find an analogue to RAF.setLength in nio; rather than creating a single byte ByteBuffer, seeking to DD.getCommitLogSegmentSize(), writing that byte, and seeking back - I went ahead and just used RAF.setLength to get our size and then used the FileChannel API to map it later as it seems less prone to error and opening CLS isn&apos;t critical path.  If there&apos;s a cleaner or more idiomatic way to do that in nio I&apos;m all for it but I couldn&apos;t track it down.&lt;/p&gt;

&lt;p&gt;I also added another call to CommitLog.instance.resetUnsafe in SchemaLoader before we attempt to delete directories as it was failing to delete the memory-mapped files.  Not sure why it worked in v1 but it definitely needs it now.&lt;/p&gt;

&lt;p&gt;Lastly - while I 100% agree the os determination needs to be tightened up (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8452&quot; title=&quot;Add missing systems to FBUtilities.isUnix, add FBUtilities.isWindows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8452&quot;&gt;&lt;del&gt;CASSANDRA-8452&lt;/del&gt;&lt;/a&gt;), I&apos;m not sure how that&apos;s related to this patch as none of the changes reference that.&lt;/p&gt;</comment>
                            <comment id="14244033" author="benedict" created="Fri, 12 Dec 2014 11:53:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure how that&apos;s related to this patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My bad, misread the patch boundary,&lt;/p&gt;

&lt;p&gt;Since we&apos;re opening/closing an extra file, it might be worth only performing the action if the channel isn&apos;t the correct size, since it typically will be (so, open channel, if incorrect size close it, open raf, set length, reopen channel).&lt;/p&gt;

&lt;p&gt;I haven&apos;t tested the change to introduce strerror - are you confident of it, and have you tested it? Might be sensible to split into its own ticket.&lt;/p&gt;

&lt;p&gt;Otherwise LGTM&lt;/p&gt;</comment>
                            <comment id="14267967" author="jmckenzie" created="Wed, 7 Jan 2015 18:12:56 +0000"  >&lt;p&gt;v3 attached.  Checked length of logFile and then RAF.setLength on it if it&apos;s incorrect rather than open / close / open on FileChannel (so we can keep the channel final).  Also removed the strerror CLibrary code as that should be added separately.&lt;/p&gt;</comment>
                            <comment id="14268044" author="benedict" created="Wed, 7 Jan 2015 19:16:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14269753" author="jmckenzie" created="Thu, 8 Jan 2015 17:53:37 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14281831" author="snazy" created="Sun, 18 Jan 2015 15:39:40 +0000"  >&lt;p&gt;The commit breaks a lot of unit tests - at least on my machine (&lt;tt&gt;14.0.0 Darwin Kernel Version 14.0.0&lt;/tt&gt;) - with Java 7.&lt;/p&gt;

&lt;p&gt;ant test run with Java 7 is affected (tried some 7u65, 7u71)&lt;br/&gt;
&lt;del&gt;ant test run with Java 8 works&lt;/del&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ant test&lt;/tt&gt; fails with a lot of timeout exceptions. The first one is constantly this one:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testcase: org.apache.cassandra.config.DatabaseDescriptorTest:testTransKsMigration:	Caused an ERROR
    [junit] Timeout occurred. Please note the time in the report does not reflect the time until the timeout.
    [junit] junit.framework.AssertionFailedError: Timeout occurred. Please note the time in the report does not reflect the time until the timeout.
    [junit] 	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;system.log&lt;/tt&gt; contains messages like this - which seems to be the reason for the unit test timeout:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [main] 2015-01-18 16:30:39,349 Syncing log with a batch window of 1.0
INFO  [main] 2015-01-18 16:30:39,349 DiskAccessMode is mmap, indexAccessMode is mmap
INFO  [main] 2015-01-18 16:30:39,360 Global memtable on-heap threshold is enabled at 227MB
INFO  [main] 2015-01-18 16:30:39,360 Global memtable off-heap threshold is enabled at 227MB
INFO  [main] 2015-01-18 16:30:39,372 Started the RoundRobin Request Scheduler
INFO  [main] 2015-01-18 16:30:39,373 Loading settings from file:/Users/snazy/devel/cassandra/trunk/test/conf/cassandra.yaml
INFO  [main] 2015-01-18 16:30:39,378 Node configuration:[cluster_name=Test Cluster; column_index_size_in_kb=4; commitlog_directory=build/test/cassandra/commitlog; commitlog_segment_size_in_mb=5; commitlog_sync=batch; commitlog_sync_batch_window_in_ms=1.0; compaction_throughput_mb_per_sec=0; concurrent_compactors=4; data_file_directories=[build/test/cassandra/data]; disk_access_mode=mmap; dynamic_snitch=true; endpoint_snitch=org.apache.cassandra.locator.SimpleSnitch; incremental_backups=true; listen_address=127.0.0.1; memtable_allocation_type=offheap_objects; native_transport_port=9042; partitioner=org.apache.cassandra.dht.ByteOrderedPartitioner; request_scheduler=org.apache.cassandra.scheduler.RoundRobinScheduler; request_scheduler_id=keyspace; rpc_port=9170; saved_caches_directory=build/test/cassandra/saved_caches; seed_provider=[{class_name=org.apache.cassandra.locator.SimpleSeedProvider, parameters=[{seeds=127.0.0.1}]}]; server_encryption_options=&amp;lt;REDACTED&amp;gt;; start_native_transport=true; storage_port=7010]
DEBUG [COMMIT-LOG-ALLOCATOR] 2015-01-18 16:30:39,388 No segments in reserve; creating a fresh one
DEBUG [main] 2015-01-18 16:30:39,400 Closing and clearing existing commit log segments...
DEBUG [main] 2015-01-18 16:30:39,403 Deleting CommitLog-5-1421595039390.log
DEBUG [main] 2015-01-18 16:30:39,417 Deleting backups
DEBUG [main] 2015-01-18 16:30:39,418 Deleting schema_triggers-0359bc7171233ee19a4ab9dfb11fc125
DEBUG [main] 2015-01-18 16:30:39,418 Deleting system
DEBUG [main] 2015-01-18 16:30:39,418 Closing and clearing existing commit log segments...
INFO  [COMMIT-LOG-ALLOCATOR] 2015-01-18 16:30:39,426 Overriding RING_DELAY to 1000ms
ERROR [COMMIT-LOG-ALLOCATOR] 2015-01-18 16:30:39,517 Failed managing commit log segments. Commit disk failure policy is stop; terminating thread
org.apache.cassandra.io.FSWriteError: java.nio.file.NoSuchFileException: build/test/cassandra/commitlog:0/CommitLog-5-1421595039390.log
        at org.apache.cassandra.db.commitlog.CommitLogSegment.&amp;lt;init&amp;gt;(CommitLogSegment.java:189) ~[main/:na]
        at org.apache.cassandra.db.commitlog.CommitLogSegment.freshSegment(CommitLogSegment.java:120) ~[main/:na]
        at org.apache.cassandra.db.commitlog.CommitLogSegmentManager$1.runMayThrow(CommitLogSegmentManager.java:119) ~[main/:na]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) [main/:na]
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_71]
Caused by: java.nio.file.NoSuchFileException: build/test/cassandra/commitlog:0/CommitLog-5-1421595039390.log
        at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86) ~[na:1.7.0_71]
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102) ~[na:1.7.0_71]
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107) ~[na:1.7.0_71]
        at sun.nio.fs.UnixFileSystemProvider.newFileChannel(UnixFileSystemProvider.java:177) ~[na:1.7.0_71]
        at java.nio.channels.FileChannel.open(FileChannel.java:287) ~[na:1.7.0_71]
        at java.nio.channels.FileChannel.open(FileChannel.java:334) ~[na:1.7.0_71]
        at org.apache.cassandra.db.commitlog.CommitLogSegment.&amp;lt;init&amp;gt;(CommitLogSegment.java:174) ~[main/:na]
        ... 4 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;EDIT: unit tests also fail with 8u25 (same exception in &lt;tt&gt;system.log&lt;/tt&gt;) - just other tests&lt;/p&gt;</comment>
                            <comment id="14281976" author="snazy" created="Sun, 18 Jan 2015 21:50:18 +0000"  >&lt;p&gt;Some more information on this (using &lt;tt&gt;DatabaseDescriptorTest&lt;/tt&gt; as an example):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;test methods &lt;tt&gt;testCFMetaDataSerialization&lt;/tt&gt; + &lt;tt&gt;testKSMetaDataSerialization&lt;/tt&gt; run fine&lt;/li&gt;
	&lt;li&gt;test method &lt;tt&gt;testTransKsMigration&lt;/tt&gt; calls &lt;tt&gt;SchemaLoader.cleanupAndLeaveDirs&lt;/tt&gt;, which calls &lt;tt&gt;CommitLog.instance.resetUnsafe()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CommitLog.instance.resetUnsafe()&lt;/tt&gt; calls &lt;tt&gt;CommitLogSegmentManager.resetUnsafe&lt;/tt&gt;, which waits until &lt;tt&gt;segmentManagementTasks&lt;/tt&gt; is empty&lt;/li&gt;
	&lt;li&gt;there is one task (guess its the one from &lt;tt&gt;CommitLogSegmentManager.wakeManager&lt;/tt&gt; via &lt;tt&gt;advanceAllocatingFrom&lt;/tt&gt;) in &lt;tt&gt;segmentManagementTasks&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;but &lt;tt&gt;segmentManagementTasks&lt;/tt&gt; cannot become empty, because &lt;tt&gt;COMMIT-LOG-ALLOCATOR&lt;/tt&gt; is not running&lt;/li&gt;
	&lt;li&gt;result is an infinite loop ; the test hangs and times out&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Removing the first &lt;tt&gt;CommitLog.instance.resetUnsafe();&lt;/tt&gt; in &lt;tt&gt;SchemaLoader.cleanupAndLeaveDirs&lt;/tt&gt; fixes &lt;tt&gt;ant test&lt;/tt&gt; - but I don&apos;t know what this means for Windows.&lt;/p&gt;</comment>
                            <comment id="14284064" author="jmckenzie" created="Tue, 20 Jan 2015 17:27:33 +0000"  >&lt;p&gt;Unit tests are clean on both linux and windows on trunk on jdk7 on our CI environment, and have 2 failure on jdk8 on linux.  Also, I&apos;m running 7u71 locally on Windows and don&apos;t see these problems either.&lt;/p&gt;

&lt;p&gt;I&apos;d expect we&apos;d have heard more from other developers regarding this if it was a widespread issue so I&apos;m inclined to suspect your environment before digging in and changing code.  Have you done a new clone of the git repo and tried to test on a completely clean checkout?&lt;/p&gt;

&lt;p&gt;Even if you remove the 1st call to &lt;tt&gt;CommitLog.instance.resetUnsafe()&lt;/tt&gt; in &lt;tt&gt;SchemaLoader.cleanupAndLeaveDirs&lt;/tt&gt;, there&apos;s still a second call at the end of that method that should also hang if your theory as to why it&apos;s failing is correct.&lt;/p&gt;

&lt;p&gt;Is COMMIT-LOG-ALLOCATOR not running?  Since CommitLog is a singleton, I would expect the allocator thread would be running since the managerThread is started in the constructor for CommitLogSegmentManager which is called in the singleton&apos;s constructor - unless I&apos;m missing something.&lt;/p&gt;</comment>
                            <comment id="14285552" author="snazy" created="Wed, 21 Jan 2015 11:59:34 +0000"  >&lt;p&gt;I&apos;ll dig a bit deeper into this and try it on a Linux box and figure out why this happens (only to me and my Mac?).&lt;/p&gt;</comment>
                            <comment id="14286434" author="snazy" created="Wed, 21 Jan 2015 22:29:28 +0000"  >&lt;p&gt;I tried on my Linux box and on another (5 yrs old) MBP: tests pass.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&apos;s Mac does also have no timeouts.&lt;/p&gt;

&lt;p&gt;Seems to be a pure local (mine) problem. Sorry for alerting for nothing.&lt;/p&gt;</comment>
                            <comment id="14300113" author="snazy" created="Sun, 1 Feb 2015 08:29:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; cassci now also complains about TimeoutExceptions (&lt;a href=&quot;http://cassci.datastax.com/job/trunk_utest/1353/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_utest/1353/testReport/&lt;/a&gt; and various previous builds).&lt;/p&gt;

&lt;p&gt;I digged a bit more into it and have a patch that solves the TimeoutException-problem: &lt;a href=&quot;https://gist.github.com/snazy/6f2f8203ca4ab7c19422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/snazy/6f2f8203ca4ab7c19422&lt;/a&gt; and a branch &lt;a href=&quot;https://github.com/snazy/cassandra/tree/8308-post-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/snazy/cassandra/tree/8308-post-fix&lt;/a&gt;&lt;br/&gt;
The good: the problem does only affect unit tests - not the production code.&lt;/p&gt;

&lt;p&gt;Background:&lt;br/&gt;
Sometimes &lt;tt&gt;CommitLogSegmentManager.resetUnsafe()&lt;/tt&gt; produces a deadlock - when depends on &apos;random&apos; - i.e. when &lt;tt&gt;COMMIT-LOG-ALLOCATOR&lt;/tt&gt; thread works against data &apos;corrupted&apos; by &lt;tt&gt;resetUnsafe&lt;/tt&gt;. The patch of &lt;tt&gt;resetUnsafe&lt;/tt&gt; just shuts down &lt;tt&gt;COMMIT-LOG-ALLOCATOR&lt;/tt&gt; thread, does its work and restarts &lt;tt&gt;COMMIT-LOG-ALLOCATOR&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14303598" author="jmckenzie" created="Tue, 3 Feb 2015 17:09:38 +0000"  >&lt;p&gt;Changes on 8308-post-fix LGTM.&lt;/p&gt;</comment>
                            <comment id="14303832" author="snazy" created="Tue, 3 Feb 2015 19:36:53 +0000"  >&lt;p&gt;Committed 8308-post-fix.txt as 3dd1bf10441a86a620976b479a66fe428acc2d66&lt;/p&gt;</comment>
                            <comment id="14304970" author="snazy" created="Wed, 4 Feb 2015 11:21:28 +0000"  >&lt;p&gt;I&apos;m really sorry to reopen this one again. My last patch accidentally made trunk-utest-win failing.&lt;/p&gt;

&lt;p&gt;Follow-up patch is here: &lt;a href=&quot;https://gist.github.com/snazy/2494731cb7e2ed1e2479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/snazy/2494731cb7e2ed1e2479&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14305782" author="jmckenzie" created="Wed, 4 Feb 2015 19:22:14 +0000"  >&lt;p&gt;Hm.  Something is clearly different between our CI environment and my local win7 install, as both current trunk and your branch complete with no test errors.&lt;/p&gt;

&lt;p&gt;Having said that - your changes on post-fix-2 look like they should address the latest errors on trunk-utest-win and look benign.  +1.&lt;/p&gt;</comment>
                            <comment id="14306780" author="snazy" created="Thu, 5 Feb 2015 07:22:07 +0000"  >&lt;p&gt;Okay - committed post-fix-2 as 0fa19b7ce791701231f888902ad7d981c17cb9f4&lt;/p&gt;</comment>
                            <comment id="14306980" author="snazy" created="Thu, 5 Feb 2015 10:35:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;clearly different between our CI environment and my local win7 install&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;same for me - trunk_utest_win32 still failing (though less utest errors) and working fine in my Win7 VM&lt;/p&gt;</comment>
                            <comment id="14307062" author="snazy" created="Thu, 5 Feb 2015 11:09:51 +0000"  >&lt;p&gt;Hm - at the moment I&apos;ve got no other idea than to try to delete each segment file in a for-try-wait loop.&lt;br/&gt;
Made another one &lt;a href=&quot;https://github.com/snazy/cassandra/commit/9d1cb6fc3a5a89480817434e55d515f4a37036dc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/snazy/cassandra/commit/9d1cb6fc3a5a89480817434e55d515f4a37036dc&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe there&apos;s something async going on here (which the new pray-n-error-patch could fix) or something with mmap cleaner is going weird (which would be a bigger problem). We could check the latter by setting &lt;tt&gt;disk_access_mode = standard&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14312930" author="jmckenzie" created="Mon, 9 Feb 2015 21:39:45 +0000"  >&lt;p&gt;I was able to reproduce the CI issues on my local machine once, so this isn&apos;t CI-specific.&lt;/p&gt;

&lt;p&gt;As per some offline discussion, I went ahead and threw together a version that integrates stopping and starting the AbstractCommitLogExecutorService into the mix in the off chance part of our failure is that the ACLE is futzing with files at the time we go to delete them.  I did a full 10 runs of our unit tests on trunk on my local win7 install with 0 unit test failures.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;: branch is &lt;a href=&quot;https://github.com/josh-mckenzie/cassandra/compare/8308_executor&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; if you wouldn&apos;t mind taking a look (was your idea after all&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt;: would it be possible to have our CI windows server do a run against that branch to see if it resolves the issues there?  Our CI environment appears to be racing / failing on every run (as opposed to 1 out of 8 attempts to retry on my local this morning).&lt;/p&gt;</comment>
                            <comment id="14314597" author="snazy" created="Tue, 10 Feb 2015 18:28:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; branch LGTM - except that there&apos;s a change in &lt;tt&gt;test/data/corrupt-sstables/Keyspace1-Standard3-jb-1-Summary.db&lt;/tt&gt;&lt;br/&gt;
I like the idea to test it from the branch on cassci &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14314814" author="jmckenzie" created="Tue, 10 Feb 2015 20:07:30 +0000"  >&lt;p&gt;Reverted the test/data that snuck in - thanks for the heads up.&lt;/p&gt;</comment>
                            <comment id="14315080" author="snazy" created="Tue, 10 Feb 2015 22:22:44 +0000"  >&lt;p&gt;I&apos;ve setup a Jenkins instance against apache/trunk and Josh&apos;s branch. Both utests flap with TimeoutExceptions. Time&apos;s come for good-old LOGGER debugging...&lt;/p&gt;

&lt;p&gt;&lt;em&gt;blame:off&lt;/em&gt; may I change the title to &quot;pray-and-error-issue&quot;?&lt;/p&gt;</comment>
                            <comment id="14317983" author="snazy" created="Thu, 12 Feb 2015 10:42:40 +0000"  >&lt;p&gt;I&apos;ve taken Josh&apos;s diff from its branch and ensured that all unit tests pass.&lt;br/&gt;
Additionally I&apos;ve setup a Jenkins instance on Linux that runs utests against my branch every 30 minutes.&lt;br/&gt;
Until now it made 27 builds without and failure/error. (&quot;Only&quot;) two build failures during these runs: one-time flappy tests:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;one TimeoutException in AggregationTest.testJavaAggregate&lt;/li&gt;
	&lt;li&gt;one NPE in LeveledCompactionStrategyTest.testValidationMultipleSSTablePerLevel&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But the TimeoutExceptions in these BeforeTest... methods are gone.&lt;br/&gt;
I&apos;ll leave my Jenkins instance busy so we&apos;ll have a good expectation about the patch.&lt;br/&gt;
Additionally I&apos;d like to see it pass on a real Win box.&lt;/p&gt;</comment>
                            <comment id="14317986" author="snazy" created="Thu, 12 Feb 2015 10:46:31 +0000"  >&lt;p&gt;Forgot one: also added a new &lt;tt&gt;MmapFileTest&lt;/tt&gt; that basically ensures that mmap works the way it is used in CL including querying the appropriate JMX bean.&lt;/p&gt;</comment>
                            <comment id="14318529" author="jmckenzie" created="Thu, 12 Feb 2015 16:52:51 +0000"  >&lt;p&gt;Feature branch with a couple of formatting nits applied &lt;a href=&quot;https://github.com/josh-mckenzie/cassandra/compare/8308_fix3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  Have job on cassci queued &lt;a href=&quot;http://cassci.datastax.com/job/DEV_cassandra-branch/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14318864" author="jmckenzie" created="Thu, 12 Feb 2015 19:48:29 +0000"  >&lt;p&gt;Got Philip to run it against a Windows CI (thanks) - results are &lt;a href=&quot;http://cassci.datastax.com/job/8308_trunk_utest_win32/lastBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  Looks like it&apos;s resolved the issue however before we commit I have a couple of questions and one concern:&lt;/p&gt;

&lt;p&gt;Why 10 retries and why 500ms sleep between retries on closeAndDeleteSegmentUnsafe (vs. 5 and 10ms, for instance, or some other arbitrary number)?  The &quot;keep trying to delete it until it works or eventually we time out&quot; smells a lot like a micro-version of SSTableDeletingTask for CLS where we&apos;re just spinning locally instead of scheduling off GC.  More limited in scope (also only applies to tests) but equally hackish.&lt;/p&gt;

&lt;p&gt;This may very well be the best we can do on Windows if we&apos;re in an environment where filesystem drivers can&apos;t be trusted to consistently stay out of our way and mangle up our deleteRecursive calls (which is looking more and more like the case) - but I think it&apos;s best we have a clear view of the pig before we put lipstick on it and call it a day.&lt;/p&gt;</comment>
                            <comment id="14318903" author="snazy" created="Thu, 12 Feb 2015 20:08:59 +0000"  >&lt;p&gt;You&apos;re right, the retry-sleep-loop (including the randomly chosen 500ms sleep) would hide the problem. So, yup - we can remove it. I didn&apos;t see it spin there on OSX or Linux.&lt;/p&gt;

&lt;p&gt;+1 on getting a view of the pig and fix it where it occurs (and aims to occur in production?).&lt;/p&gt;</comment>
                            <comment id="14319753" author="snazy" created="Fri, 13 Feb 2015 08:48:33 +0000"  >&lt;p&gt;Update from &quot;my Jenkins&quot;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;nearly 100 builds&lt;/li&gt;
	&lt;li&gt;one TimeoutException in AggregationTest.testJavaAggregate&lt;/li&gt;
	&lt;li&gt;3 failed with NPE in LeveledCompactionStrategyTest.testValidationMultipleSSTablePerLevel&lt;/li&gt;
	&lt;li&gt;2 failed with AssertionError in LeveledCompactionStrategyTest.testValidationMultipleSSTablePerLevel&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My interpretation: LeveledCompactionStrategyTest.testValidationMultipleSSTablePerLevel needs some investigation but the flappy BeforeTest-TimeoutException is finally fixed.&lt;/p&gt;

&lt;p&gt;Note: scheduling GC should not be necessary if the &lt;tt&gt;Cleaner&lt;/tt&gt; for &lt;tt&gt;DirectByteBuffer&lt;/tt&gt; is working - the unit test &lt;a href=&quot;https://github.com/snazy/cassandra/blob/8308-post-fix/test/unit/org/apache/cassandra/db/MmapFileTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;MmapFileTest&lt;/tt&gt;&lt;/a&gt; asserts that a mmap&apos;d file can be deleted without GC.&lt;/p&gt;</comment>
                            <comment id="14320858" author="jmckenzie" created="Fri, 13 Feb 2015 22:15:10 +0000"  >&lt;p&gt;So to clarify from our earlier conversation regarding the retry-sleep-loop - are you seeing it spin there on Windows?  I.e. is the success of the unit tests running within CI contingent upon retrying deletion of those files?&lt;/p&gt;</comment>
                            <comment id="14321647" author="snazy" created="Sat, 14 Feb 2015 19:11:45 +0000"  >&lt;p&gt;I&apos;ve no real Windows box - just a (slow) VM.&lt;br/&gt;
I suppose the success on is not related to the try-spin-loop - but would like to it without the loop in CI environment.&lt;/p&gt;</comment>
                            <comment id="14324704" author="jmckenzie" created="Tue, 17 Feb 2015 19:14:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt;: Could you do another run on cassci against &lt;a href=&quot;https://github.com/josh-mckenzie/cassandra/compare/8308_fix3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this branch&lt;/a&gt;?  Has the try/spin loop on segment deletion removed.&lt;/p&gt;</comment>
                            <comment id="14324946" author="philipthompson" created="Tue, 17 Feb 2015 21:44:55 +0000"  >&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/8308_trunk_utest_win32/2/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/8308_trunk_utest_win32/2/testReport/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/8308_trunk_utest_win32/3/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/8308_trunk_utest_win32/3/testReport/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I ran it twice. Inconsistent results, but removing the try/spin loop didn&apos;t meaningfully affect results.&lt;/p&gt;</comment>
                            <comment id="14326345" author="jmckenzie" created="Wed, 18 Feb 2015 18:41:09 +0000"  >&lt;p&gt;Committed v3.  Now to keep an eye on Windows CI...&lt;/p&gt;</comment>
                            <comment id="14326458" author="snazy" created="Wed, 18 Feb 2015 19:49:13 +0000"  >&lt;p&gt;I&apos;ll keep my fingers crossed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12698399" name="8308-post-fix-3.txt" size="23356" author="snazy" created="Thu, 12 Feb 2015 10:42:40 +0000"/>
                            <attachment id="12696260" name="8308-post-fix.txt" size="2357" author="snazy" created="Tue, 3 Feb 2015 19:36:32 +0000"/>
                            <attachment id="12682022" name="8308_v1.txt" size="7302" author="joshuamckenzie" created="Mon, 17 Nov 2014 23:30:32 +0000"/>
                            <attachment id="12686293" name="8308_v2.txt" size="8083" author="joshuamckenzie" created="Wed, 10 Dec 2014 16:21:45 +0000"/>
                            <attachment id="12690580" name="8308_v3.txt" size="7294" author="joshuamckenzie" created="Wed, 7 Jan 2015 18:12:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22chj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>