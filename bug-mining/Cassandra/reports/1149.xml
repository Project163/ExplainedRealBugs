<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3219] Nodes started at the same time end up with the same token</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3219</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since autoboostrap is defaulted to on when you start a cluster at once (&lt;a href=&quot;http://screenr.com/5G6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://screenr.com/5G6&lt;/a&gt;) you can end up with nodes being assigned the same token.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO 17:34:55,688 Node /67.23.43.14 is now part of the cluster
 INFO 17:34:55,698 InetAddress /67.23.43.14 is now UP
 INFO 17:34:55,698 Nodes /67.23.43.14 and tjake2/67.23.43.15 have the same token 8823900603000512634329811229926543166.  Ignoring /67.23.43.14
 INFO 17:34:55,698 Node /98.129.220.182 is now part of the cluster
 INFO 17:34:55,698 InetAddress /98.129.220.182 is now UP
 INFO 17:34:55,698 Nodes /98.129.220.182 and tjake2/67.23.43.15 have the same token 8823900603000512634329811229926543166.  Ignoring /98.129.220.182
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12523364">CASSANDRA-3219</key>
            <summary>Nodes started at the same time end up with the same token</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="tjake">T Jake Luciani</reporter>
                        <labels>
                            <label>bootstrap</label>
                    </labels>
                <created>Fri, 16 Sep 2011 17:39:55 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:50 +0000</updated>
                            <resolved>Mon, 19 Sep 2011 16:59:28 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13106686" author="jbellis" created="Fri, 16 Sep 2011 18:45:19 +0000"  >&lt;p&gt;We should add special values &quot;auto&quot; and &quot;random&quot; to initial_token, so you can have random with bootstrap and auto-selected w/o.&lt;/p&gt;

&lt;p&gt;Of course both of those are not recommended vs picking your own.&lt;/p&gt;</comment>
                            <comment id="13106701" author="vijay2win@yahoo.com" created="Fri, 16 Sep 2011 18:55:23 +0000"  >&lt;p&gt;Can we also have some thing like &quot;equal split&quot; which will try to split the token ranges into perfect halfs? this will work well for bootstrapping ring of sizes = 2^n&lt;/p&gt;</comment>
                            <comment id="13106721" author="jbellis" created="Fri, 16 Sep 2011 19:06:16 +0000"  >&lt;p&gt;That is what &quot;auto&quot; does, with the caveat that nodes need to be started 2 minutes apart so they don&apos;t race as in Jake&apos;s example here.&lt;/p&gt;</comment>
                            <comment id="13106757" author="jbellis" created="Fri, 16 Sep 2011 19:50:11 +0000"  >&lt;p&gt;auto and random initial_token modes added.&lt;/p&gt;</comment>
                            <comment id="13107756" author="slebresne" created="Mon, 19 Sep 2011 11:46:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;auto and random initial_token modes added.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I hate it and I&apos;m -1 on that idea.&lt;/p&gt;

&lt;p&gt;Basically, I think that it&apos;s more complicated to explain/understand how to choose between those two options that it was to explain the &quot;old&quot; auto-bootstrap option while it&apos;s essentially the same option. The default to random would also make it more likely for people to leave it at that when bootstrapping new nodes, while random is really the worst possible algorithm you can use expect maybe for the 2-3 initial nodes of a cluster (and even then it&apos;s really only admissible because the balanced token algorithm don&apos;t work in that case and picking random token is the only simple choice we have).&lt;/p&gt;

&lt;p&gt;I&apos;d rather add back the auto-bootstrap option than setting the initial_token to random.&lt;/p&gt;

&lt;p&gt;As for alternatives, I can propose one of:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Decide whether we are really bootstrapping (if we are, balanced token is the &quot;right&quot; automatic choice, otherwise we have no other choice than to fall back to random tokens) or not based on whether there is a keyspace defined already. That is the same test we use to decide whether we actually do some bootstrap streaming or not so this doesn&apos;t seem too far fetched (attaching a v2 patch for that to make it clear what I mean here).&lt;/li&gt;
	&lt;li&gt;Stop pretending we know how to pick up token automatically and just force user to set a token. We can default that token to 0 so that you can start a single node cluster with 0 configuration and we can ship a new small tiny script that compute the tokens for a n node initial cluster if we want people to be able to do without a calculator.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13107826" author="jbellis" created="Mon, 19 Sep 2011 13:53:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think that it&apos;s more complicated to explain/understand how to choose between those two options&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Huh?  This is a HUGE simplification because initial_token behavior depends only on initial_token.  The old behavior (where initial_token=empty behavior does one thing with auto_bootstrap=true, and another with a_b=false) was ENORMOUSLY confusing: EVERY training class I taught was baffled by this.&lt;/p&gt;

&lt;p&gt;Further, the old behavior doesn&apos;t let you specify bootstrap/random or nobootstrap/auto, both of which are valid things to do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;based on whether there is a keyspace defined already&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t see how this helps the situation Jake describes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;just force user to set a token&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is a non-starter.&lt;/p&gt;</comment>
                            <comment id="13107882" author="slebresne" created="Mon, 19 Sep 2011 15:00:47 +0000"  >
&lt;blockquote&gt;&lt;p&gt;Further, the old behavior doesn&apos;t let you specify bootstrap/random&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would depend on what is definition of valid. In my opinion, picking random token is &lt;b&gt;always&lt;/b&gt; stupid, it will always result in crappy distribution (it just happens to be less stupid than &quot;auto&quot; in the noboostrap case, which imho is and should remain the only reason we ever generate random token). If you bootstrap, it means you have an existing cluster with data in it (I&apos;m not saying you &lt;b&gt;have to&lt;/b&gt;, I&apos;m saying this is why bootstrap is for and so should be the case if you don&apos;t do something wrong). In such situation, I don&apos;t see why you would want to pick a random token. If some people like to live on the edge, they can write a random token generator and use that, but that we would want to expose an option, hence suggesting that this could be something useful ...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;or nobootstrap/auto, both of which are valid things to do&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Again, really depends on the definition of &quot;valid&quot;. First, if you start two nodes at the same time with that, you end up in this ticket situation. Sure the patch adds a &quot;don&apos;t do it&quot; comment but it doesn&apos;t really fix it more than that. Second, noboostrap (when token selection is involved, i.e, not a replace_token) is mainly useful to set up an initial cluster, that is when nodes don&apos;t have data at all (otherwise you want to bootstrap the node). In that situation, auto will likely don&apos;t do anything useful (it&apos;s a completely degenerated case for the algorithm). That the nobootstrap/auto pair doesn&apos;t work correctly is actually the only reason I can come up for us picking a random token in &amp;lt;= 0.8 versions.&lt;/p&gt;

&lt;p&gt;Besides, when was the last time we had a user requesting to do one of boostrap/random or nobootstrap/auto, or us recommanding anything else than &apos;pick your token yourself&apos;?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t see how this helps the situation Jake describes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m willing to bet that when Jake encountered that problem he was trying to set up an initial cluster &lt;b&gt;before&lt;/b&gt; having set up schemas and inserted some data. In that case, the second patch would pick a random token so there wouldn&apos;t be problem.&lt;/p&gt;

&lt;p&gt;The thing is, there is not too many way to create a Cassandra cluster. First you create a cluster with n initial machines. For that you want to be in mode noboostrap/random (noboostrap/auto doesn&apos;t really work too well with no data; and by noboostrap I don&apos;t really speak of the auto-boostrap=false option, but more of not doing data streaming). Once you have data in the cluster, you want to bootstrap and then auto is always less stupid than random (IMHO). Hence the rational for the v2 patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This is a non-starter&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I find it weird to consider that a non-starter so rapidly when we all know that the very first advise we give is to hand pick token and that it&apos;s unreasonable to use auto (let&apos;s not talk about random) token in any real life situation (even the config file basically says it). But I&apos;m willing to consider that it&apos;s not the right time to discuss that and to discard that solution, at least for now.&lt;/p&gt;</comment>
                            <comment id="13107890" author="jbellis" created="Mon, 19 Sep 2011 15:11:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;when Jake encountered that problem he was trying to set up an initial cluster before having set up schemas and inserted some data&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe, but it sounded to me like the situation was &quot;I was adding new nodes to an existing cluster, and they picked the same token.&quot;  Which as I pointed out in chat is NOT a new problem, but it&apos;s one we should address.&lt;/p&gt;

&lt;p&gt;Another way of looking at my patch is, it&apos;s okay for defaults to give you something suboptimal (random tokens) but it&apos;s not okay for it to give you something broken (two nodes w/ same token).  If you want auto token picking and its potential downsides, you need to opt in.  (And hopefully read the comments and go with manual token assignment instead.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I find it weird to consider that a non-starter so rapidly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Because demo-ability matters.&lt;/p&gt;</comment>
                            <comment id="13107892" author="vijay2win@yahoo.com" created="Mon, 19 Sep 2011 15:14:08 +0000"  >&lt;p&gt;IMO... Instead of random we should actually try and balance the tokens when no keyspace is defined... By which I mean moving the nodes around as there is no data to stream and at that time it will be more predictive... This will give a better distribution...&lt;/p&gt;

</comment>
                            <comment id="13107905" author="jbellis" created="Mon, 19 Sep 2011 15:30:01 +0000"  >&lt;p&gt;Sure, in magic fairy land I&apos;d love that too, but the question here is what can we improve for 1.0.&lt;/p&gt;</comment>
                            <comment id="13107935" author="slebresne" created="Mon, 19 Sep 2011 16:14:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Which as I pointed out in chat is NOT a new problem, but it&apos;s one we should address.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, but I suspect this is due (in the not a new problem case) to races in Boostrapper.getBootstrapSource() detection of already bootstrapping node. We should fix that if possible, which the patch don&apos;t really since if you will still potentially have those race with auto. But note that this problem is present in 0.8 and I think is not a top priority because it&apos;s relatively rare to actually start bootstrapping 2 nodes at the same time in real life. Again, I&apos;m not saying we shouldn&apos;t fix, but it&apos;s ok to say that as long as it&apos;s not worth than in 0.8, it can wait post 1.0.0 to get fixed.&lt;/p&gt;

&lt;p&gt;Now there is a actual new problem with 1.0.0. That problem is that when you start an initial cluster, i.e, when in 0.8 you would start node with auto-boostrap=false, you do often end up starting nodes simultaneously. That is why older version were using random token when auto-bootstrap was false. This problem does need to be fix for 1.0.0 because that is a serious regression. However, my argument is that even though we now default to auto-boostrap=true, that doesn&apos;t mean that there is no difference between setting up the initial nodes of a cluster and the latter bootstrapping of nodes to add capacity to an existing cluster. Indeed, in 1.0.0 we decided to draw this line based on whether a schema had been created or not (we call the bootstrap() method based on that). Imho, this means that we have no boostrap option and the &quot;I have no schema&quot; is the old auto-boostrap=false. So we should use random token in that case and balanced one otherwise the same way we are doing it in 0.8.&lt;/p&gt;

&lt;p&gt;And I&apos;m saying that I would prefer we do that and report the fixing of Boostrapper.getBootstrapSource() rather than exposing (and making the default) the random choice of tokens, which is my opinion is a bad idea.&lt;/p&gt;</comment>
                            <comment id="13107983" author="jbellis" created="Mon, 19 Sep 2011 16:59:28 +0000"  >&lt;p&gt;I&apos;m still not convinced this is intuitive behavior, but it&apos;s no more broken than what we&apos;ve lived with for the last couple years, so I&apos;ll run with that on the grounds of &quot;we&apos;re already in freeze, we shouldn&apos;t mess with things when we can help it.&quot;&lt;/p&gt;

&lt;p&gt;rebased v2 + committed&lt;/p&gt;</comment>
                            <comment id="13108004" author="jbellis" created="Mon, 19 Sep 2011 17:22:04 +0000"  >&lt;p&gt;v2 actually breaks things because getNewToken doesn&apos;t repeat the test for seed-ness.  I reverted things and went with a simpler change to accomplish the same goal in r1172717.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12494854" name="3219.txt" size="9045" author="jbellis" created="Fri, 16 Sep 2011 19:50:11 +0000"/>
                            <attachment id="12495049" name="3219_v2.patch" size="5438" author="slebresne" created="Mon, 19 Sep 2011 11:46:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4013</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gh93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94225</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>