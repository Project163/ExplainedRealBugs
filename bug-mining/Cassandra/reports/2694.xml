<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6862] Schema versions mismatch on large ring</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6862</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a large cluster with several hundreds nodes in 1 ring. Sometimes, especially after massive restarts, schema versions reported on different nodes mismatch.&lt;br/&gt;
Investigated and found, that difference is not in schema itsself, but in thombstones (different nodes have different set of thombstones applied to system tables).&lt;/p&gt;

&lt;p&gt;Fixed by digesting schema with thombstones removed first.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.0&lt;/p&gt;</environment>
        <key id="12701546">CASSANDRA-6862</key>
            <summary>Schema versions mismatch on large ring</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="m0nstermind">Oleg Anastasyev</assignee>
                                    <reporter username="m0nstermind">Oleg Anastasyev</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Mar 2014 18:37:48 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:51 +0000</updated>
                            <resolved>Wed, 19 Mar 2014 06:05:56 +0000</resolved>
                                        <fixVersion>2.0.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13935542" author="jbellis" created="Fri, 14 Mar 2014 19:53:48 +0000"  >&lt;p&gt;Should probably also remove row-level and range tombstones?  v2 attached.&lt;/p&gt;</comment>
                            <comment id="13935832" author="m0nstermind" created="Fri, 14 Mar 2014 23:50:35 +0000"  >&lt;p&gt;row level and range tombstones does not participate in digest calculation AFAIK, so this is not neccessary&lt;/p&gt;</comment>
                            <comment id="13937912" author="jbellis" created="Mon, 17 Mar 2014 15:22:59 +0000"  >&lt;p&gt;I think the right conclusion from that is &quot;we need to fix the digest to include row + range tombstones&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13939327" author="m0nstermind" created="Tue, 18 Mar 2014 14:58:32 +0000"  >&lt;p&gt;agree. figured out the same &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. can fix this by the way in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6863&quot; title=&quot;Incorrect read repair of range thombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6863&quot;&gt;&lt;del&gt;CASSANDRA-6863&lt;/del&gt;&lt;/a&gt; or open a separate ticket about this ?&lt;/p&gt;</comment>
                            <comment id="13939329" author="m0nstermind" created="Tue, 18 Mar 2014 14:59:38 +0000"  >&lt;p&gt;patch LGTM&lt;/p&gt;</comment>
                            <comment id="13940217" author="jbellis" created="Wed, 19 Mar 2014 06:05:57 +0000"  >&lt;p&gt;committed, will follow up in 6863&lt;/p&gt;</comment>
                            <comment id="14012922" author="rcoli" created="Thu, 29 May 2014 21:17:39 +0000"  >&lt;p&gt;Does this affect versions before 2.0 as well? Or is &quot;since&quot; here 2.0.0, like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6863&quot; title=&quot;Incorrect read repair of range thombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6863&quot;&gt;&lt;del&gt;CASSANDRA-6863&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14192141" author="kohlisankalp" created="Fri, 31 Oct 2014 17:38:40 +0000"  >&lt;p&gt;This will cause problems for 1.2 to 2.0 upgrade as 1.2 will add tombstones and 2.0 won&apos;t. &lt;/p&gt;</comment>
                            <comment id="14192312" author="iamaleksey" created="Fri, 31 Oct 2014 19:34:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;This will cause problems for 1.2 to 2.0 upgrade as 1.2 will add tombstones and 2.0 won&apos;t.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Which is completely irrelevant, because of the startup migration of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5125&quot; title=&quot;Support indexes on composite column components (clustered columns)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5125&quot;&gt;&lt;del&gt;CASSANDRA-5125&lt;/del&gt;&lt;/a&gt; (see SystemKeyspace#copyAllAliasesToColumnsProper())&lt;/p&gt;

&lt;p&gt;3.0 to 3.1 upgrade will be the first to get rid of the issue entirely, making schema pulls, pushes, and digests fully flawless (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6038&quot; title=&quot;Support schema changes in mixed version clusters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6038&quot;&gt;CASSANDRA-6038&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="14192423" author="kohlisankalp" created="Fri, 31 Oct 2014 20:30:26 +0000"  >&lt;p&gt;Why do you think it is not a problem from 1.2 to 2.0? Can you please elaborate? &lt;/p&gt;</comment>
                            <comment id="14193125" author="iamaleksey" created="Sat, 1 Nov 2014 12:23:00 +0000"  >&lt;p&gt;I&apos;m not saying it&apos;s not a problem - just that this particular issue is irrelevant here. Because as soon as 1.2 node upgrades to 2.0 and starts up, we&apos;ll make change to its schema (conversion of aliases to proper columns) and schema versions will change anyway, tombstones or not.&lt;/p&gt;</comment>
                            <comment id="14193127" author="iamaleksey" created="Sat, 1 Nov 2014 12:24:53 +0000"  >&lt;p&gt;Also, the proper fix here was probably to figure out why different nodes had differing tombstones, and fix that, instead of excluding them from digest altogether.&lt;/p&gt;</comment>
                            <comment id="14195242" author="kohlisankalp" created="Mon, 3 Nov 2014 22:31:36 +0000"  >&lt;p&gt;&quot;Also, the proper fix here was probably to figure out why different nodes had differing tombstones, and fix that, instead of excluding them from digest altogether.&quot;&lt;br/&gt;
Different nodes don&apos;t have differing tombstones. The problem is that 1.2 machines are adding the tombstones in its schema version and 2.0 are not. This will cause schema to never agree even with same tombstones in the ring. &lt;/p&gt;

&lt;p&gt;This is different from schema changes due to 1.2 to 2.0 upgrade which settles once it is propagated in the ring. &lt;/p&gt;

&lt;p&gt;Am I missing something? &lt;/p&gt;</comment>
                            <comment id="14195265" author="iamaleksey" created="Mon, 3 Nov 2014 22:41:27 +0000"  >&lt;p&gt;One of us is, because I&apos;ve lost the thread.&lt;/p&gt;

&lt;p&gt;What do you think the current issue is, under what circumstances does it happen, and why?&lt;/p&gt;</comment>
                            <comment id="14195533" author="kohlisankalp" created="Tue, 4 Nov 2014 01:34:16 +0000"  >&lt;p&gt;Say there are tombstones in the tables storing schema. They are all within GC grace(written in last 7 days) and is successfully replicated on all machines. &lt;br/&gt;
You are upgrading a 1.2.19 cluster to 2.0.11. You upgrade one node to 2.0, the 2.0 node will compute the schema version without using tombstones. All 1.2 nodes are computing the schema version using tombstones. This will cause schema disagreement leading to schema pulls. Even after schema pull, things won&apos;t settle since schema versions will differ. This will happen till the entire cluster is upgraded to 2.0. &lt;br/&gt;
For large clusters, this will be bad as it takes a long time to upgrade. &lt;/p&gt;

&lt;p&gt;So this is the problem.&lt;/p&gt;

&lt;p&gt;Also I think you are saying that 2.0 code will have a schema change and there will be a schema disagreement after first node is upgraded. But that will settle after all machines have the new schema.&lt;/p&gt;

&lt;p&gt;In this, schema will bounce around till all machines have been upgraded. &lt;/p&gt;</comment>
                            <comment id="14195950" author="iamaleksey" created="Tue, 4 Nov 2014 09:28:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also I think you are saying that 2.0 code will have a schema change and there will be a schema disagreement after first node is upgraded. But that will settle after all machines have the new schema.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;They won&apos;t. They will only settle on a single schema once every single node has been upgraded - because we don&apos;t exchange schema (no push, no pull) between nodes with different major versions - because of internal migrations like that (if you try to push those new columns created from aliases to 1.2 nodes, your 1.2 node will not be able to handle it).&lt;/p&gt;

&lt;p&gt;So this issue doesn&apos;t introduce the problem you are talking about - because it&apos;s already there, since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5125&quot; title=&quot;Support indexes on composite column components (clustered columns)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5125&quot;&gt;&lt;del&gt;CASSANDRA-5125&lt;/del&gt;&lt;/a&gt;, which we aren&apos;t going to revert.&lt;/p&gt;

&lt;p&gt;The only solution is to wait until &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6038&quot; title=&quot;Support schema changes in mixed version clusters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6038&quot;&gt;CASSANDRA-6038&lt;/a&gt; happens - after that, we&apos;ll have schema push/pull/digests done in a separately versioned manner (and instead of having a single current schema version, have a map &lt;/p&gt;
{3.0 : f8d559cd7fc723fc176e914d6d71c6f3, 3.1 : f6b405436ca4cb04fd2b4b7be3e8571e}
&lt;p&gt;).&lt;/p&gt;</comment>
                            <comment id="14196449" author="kohlisankalp" created="Tue, 4 Nov 2014 17:54:15 +0000"  >&lt;p&gt;Make sense. Thanks&lt;/p&gt;</comment>
                            <comment id="15279521" author="michael.fong" created="Wed, 11 May 2016 04:29:24 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;We have recently seen schema version mismatch issue while doing rolling upgrade from 1.2.19 to 2.0.17. What is worse is that the mismatch could lead to a rapid and massive message exchange of schema information across nodes, and sometimes may lead to node OOM. I opened a ticket regarding this at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11748&quot; title=&quot;Schema version mismatch may leads to Casandra OOM at bootstrap during a rolling upgrade process&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11748&quot;&gt;CASSANDRA-11748&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Has anyone observed the heap over usage on exchanging schema information before?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12749813">CASSANDRA-8165</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12634814" name="6862-v2.txt" size="688" author="jbellis" created="Fri, 14 Mar 2014 19:53:48 +0000"/>
                            <attachment id="12634781" name="SchemaVersionLiveColumns.txt" size="627" author="m0nstermind" created="Fri, 14 Mar 2014 18:38:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[m0nstermind]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379892</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tgfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380177</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325322">2.0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>