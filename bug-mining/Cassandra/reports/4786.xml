<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13068] Fully expired sstable not dropped when running out of disk space</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13068</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If a fully expired sstable is larger than the remaining disk space we won&apos;t run the compaction that can drop the sstable (ie, in our disk space check should not include the fully expired sstables)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13029802">CASSANDRA-13068</key>
            <summary>Fully expired sstable not dropped when running out of disk space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Lerh Low">Lerh Chuan Low</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                            <label>lhf</label>
                    </labels>
                <created>Wed, 21 Dec 2016 16:01:23 +0000</created>
                <updated>Fri, 15 May 2020 08:06:00 +0000</updated>
                            <resolved>Wed, 21 Jun 2017 08:37:49 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16027975" author="lerh low" created="Sun, 28 May 2017 23:53:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, &lt;/p&gt;

&lt;p&gt;I&apos;ve pushed up a patch for this for trunk here: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13068&lt;/a&gt;, any thoughts? If it seems ok I&apos;ll make one for the other branches (it doesn&apos;t apply cleanly). I&apos;ve manually tested it locally on my machine to verify that the disk space check no longer includes fully expired SSTables, and also re-ran the LongCompactionsTest. &lt;/p&gt;

&lt;p&gt;Ty! &lt;/p&gt;</comment>
                            <comment id="16028122" author="krummas" created="Mon, 29 May 2017 08:04:24 +0000"  >&lt;p&gt;Had a quick read through, and we really need tests for the disk space stuff, I added one here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/lerh/13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/lerh/13068&lt;/a&gt; - maybe you could add a few more testing this feature?&lt;/p&gt;

&lt;p&gt;just a single code comment so far, in &lt;tt&gt;CompactionTask#reduceScopeForLimitedSpace&lt;/tt&gt; - no need to do &lt;tt&gt;nonExpiredSSTables.remove(removedSSTable);&lt;/tt&gt; - &lt;tt&gt;nonExpiredSSTables&lt;/tt&gt; is &lt;tt&gt;Sets.difference(transaction.originals(), controller.getFullyExpiredSSTables());&lt;/tt&gt; so when you cancel the sstable from the transaction, it gets removed from &lt;tt&gt;nonExpiredSSTables&lt;/tt&gt; (otherwise it would have thrown an exception since &lt;tt&gt;Sets.difference&lt;/tt&gt; returns an unmodifiable set) &lt;/p&gt;

&lt;p&gt;I&apos;ll do a deeper code review once the tests are in&lt;/p&gt;</comment>
                            <comment id="16028709" author="lerh low" created="Tue, 30 May 2017 02:26:50 +0000"  >&lt;p&gt;Thanks for the quick reply. I&apos;ll look into writing some tests (I was initially wondering how that would be done without actually filling up the disk of the machine). I didn&apos;t know about Byteman, so going to do some digging into it and also thanks for providing an example. &lt;/p&gt;

&lt;p&gt;Re: &lt;tt&gt;Sets.difference&lt;/tt&gt; - you&apos;re right, just checked the java doc. Wasn&apos;t aware it returned an unmodifiable view of a set. &lt;/p&gt;</comment>
                            <comment id="16028817" author="lerh low" created="Tue, 30 May 2017 07:47:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Here&apos;s the new branch: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve added some 3 different tests using the example, but I&apos;ve also added an extra check &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;SSTableReader&amp;gt; fullyExpiredSSTables = controller.getFullyExpiredSSTables();
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;SSTableReader&amp;gt; actuallyCompact = Sets.difference(transaction.originals(), fullyExpiredSSTables);

            &lt;span class=&quot;code-comment&quot;&gt;// note that we need to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a rough estimate early &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we can fit the compaction on disk - &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is pessimistic, but
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// since we might remove sstables from the compaction in checkAvailableDiskSpace it needs to be done here
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// If there are no fully expired SSTables, check available disk space. Otherwise, we want to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and always compact
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// fully expired SSTables
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fullyExpiredSSTables.isEmpty())
                checkAvailableDiskSpace(actuallyCompact);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is to make the test I wrote &lt;tt&gt;testExpiredSSTablesStillGetDroppedWithNoDiskSpace()&lt;/tt&gt; work. I am not sure if this is the right way to do it or if it was intentionally left that way - basically if you have expired SSTables and SSTables that are too big, we will throw the run time exception instead of try and compact the expired SSTables away. I don&apos;t know if there&apos;s ordering of compactions at this point though, so I don&apos;t know if this is a safe operation to do. &lt;/p&gt;

&lt;p&gt;Feel free to let me know about any feedback. There seem to be other ways to go about this, such as &lt;tt&gt;checkAvailableDiskSpace&lt;/tt&gt; should just estimate fully expired SSTables to have compacted file size 0 instead...? &lt;/p&gt;</comment>
                            <comment id="16036678" author="krummas" created="Mon, 5 Jun 2017 08:37:11 +0000"  >&lt;p&gt;instead of that &lt;tt&gt;fullyExpiredSSTables.isEmpty()&lt;/tt&gt; check could we just subtract the size of the &lt;tt&gt;fullyExpiredSSTables&lt;/tt&gt; from &lt;tt&gt;expectedWriteSize&lt;/tt&gt; in &lt;tt&gt;CompactionTask#checkAvailableDiskSpace&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16047380" author="krishna.koneru" created="Tue, 13 Jun 2017 03:39:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; , I work with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt; . He wanted me to continue working on this.  I have uploaded patches on github for  &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krishna-koneru:cassandra-trunk-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...krishna-koneru:cassandra-3.11-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 &lt;/a&gt;  branches .&lt;/p&gt;



&lt;p&gt;I had to make few more changes to what was initially implemented by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt; to address your comments.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;renamed &lt;tt&gt;CompactionTask#checkAvailableDiskSpace()&lt;/tt&gt; to &lt;tt&gt;CompactionTask#buildCompactionCandidatesForAvailableDiskSpace()&lt;/tt&gt; as the method checks and might also modify the list of SSTables that will be compacted.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;buildCompactionCandidatesForAvailableDiskSpace()&lt;/tt&gt; does not throw exception  if there is no diskspace to compact non-expired SSTables when there are fully expired SSTables.This means, instead of throwing exception, we try to compact fully expired SSTables which might free up some space to allow further compactions.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16051916" author="krummas" created="Fri, 16 Jun 2017 13:43:09 +0000"  >&lt;p&gt;This looks good to me, I&apos;ll try to run dtests somewhere before committing&lt;/p&gt;</comment>
                            <comment id="16055178" author="krummas" created="Tue, 20 Jun 2017 05:42:08 +0000"  >&lt;p&gt;and dtests look good, could you prepare a 3.0 branch as well &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krishna.koneru&quot; class=&quot;user-hover&quot; rel=&quot;krishna.koneru&quot;&gt;krishna.koneru&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16056710" author="krishna.koneru" created="Wed, 21 Jun 2017 00:13:43 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; for review and running tests!&lt;/p&gt;

&lt;p&gt;Here are latest branches with the patch.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...krishna-koneru:cassandra-3.0-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...krishna-koneru:cassandra-3.11-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krishna-koneru:cassandra-trunk-13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16057182" author="krummas" created="Wed, 21 Jun 2017 08:37:49 +0000"  >&lt;p&gt;I just realised that this breaks the public API on &lt;tt&gt;CompactionTask&lt;/tt&gt; (someone might have overridden the &lt;tt&gt;checkAvailableDiskSpace()&lt;/tt&gt; or &lt;tt&gt;reduceScopeForLimitedSpace()&lt;/tt&gt;, this patch would break that for them&lt;/p&gt;

&lt;p&gt;Committed to trunk (4.0) only, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Lerh Low]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37vun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>