<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4201] Preserve commitlog size cap when recycling segments at startup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4201</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;1. Create a single node cluster, use default configuration, use cassandra.bat to start the server:&lt;/p&gt;

&lt;p&gt;2. run the following commands in cli:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create keyspace toto;
use toto;
create column family titi;
truncate titi;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. the node dies with this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR 23:23:02,118 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[COMMIT-LOG-ALLOCATOR,5,main]
java.io.IOError: java.io.IOException: Map failed
        at org.apache.cassandra.db.commitlog.CommitLogSegment.&amp;lt;init&amp;gt;(CommitLogSegment.java:127)
        at org.apache.cassandra.db.commitlog.CommitLogSegment.recycle(CommitLogSegment.java:202)
        at org.apache.cassandra.db.commitlog.CommitLogAllocator$2.run(CommitLogAllocator.java:159)
        at org.apache.cassandra.db.commitlog.CommitLogAllocator$1.runMayThrow(CommitLogAllocator.java:95)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
Caused by: java.io.IOException: Map failed
        at sun.nio.ch.FileChannelImpl.map(Unknown Source)
        at org.apache.cassandra.db.commitlog.CommitLogSegment.&amp;lt;init&amp;gt;(CommitLogSegment.java:119)
        ... 5 more
Caused by: java.lang.OutOfMemoryError: Map failed
        at sun.nio.ch.FileChannelImpl.map0(Native Method)
        ... 7 more
 INFO 23:23:02,122 Stop listening to thrift clients
 INFO 23:23:02,123 Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; messaging service to quiesce
 INFO 23:23:02,125 MessagingService shutting down server thread.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Windows 7 x64, 4Gb, JRE 1.6.0_31 (x86)&lt;/p&gt;</environment>
        <key id="12553420">CASSANDRA-4201</key>
            <summary>Preserve commitlog size cap when recycling segments at startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="pchalamet">Pierre Chalamet</reporter>
                        <labels>
                            <label>commitlog</label>
                    </labels>
                <created>Mon, 30 Apr 2012 21:28:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:34 +0000</updated>
                            <resolved>Wed, 23 May 2012 21:34:12 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13265407" author="jbellis" created="Mon, 30 Apr 2012 21:47:36 +0000"  >&lt;p&gt;I can&apos;t reproduce.  Are you using a 32bit jvm?&lt;/p&gt;</comment>
                            <comment id="13265700" author="pchalamet" created="Tue, 1 May 2012 07:52:09 +0000"  >&lt;p&gt;Yes it is a 32 bits jvm running on x64 system.&lt;/p&gt;</comment>
                            <comment id="13265810" author="jbellis" created="Tue, 1 May 2012 14:01:48 +0000"  >&lt;p&gt;How big is your heap?&lt;/p&gt;</comment>
                            <comment id="13265837" author="pchalamet" created="Tue, 1 May 2012 14:32:46 +0000"  >&lt;p&gt;1 gig. Using jvm options in cassandra.bat :&lt;/p&gt;

&lt;p&gt;set JAVA_OPTS=-ea^&lt;br/&gt;
 -javaagent:&quot;%CASSANDRA_HOME%\lib\jamm-0.2.5.jar&quot;^&lt;br/&gt;
 -Xms1G^&lt;br/&gt;
 -Xmx1G^&lt;br/&gt;
 -XX:+HeapDumpOnOutOfMemoryError^&lt;br/&gt;
 -XX:+UseParNewGC^&lt;br/&gt;
 -XX:+UseConcMarkSweepGC^&lt;br/&gt;
 -XX:+CMSParallelRemarkEnabled^&lt;br/&gt;
 -XX:SurvivorRatio=8^&lt;br/&gt;
 -XX:MaxTenuringThreshold=1^&lt;br/&gt;
 -XX:CMSInitiatingOccupancyFraction=75^&lt;br/&gt;
 -XX:+UseCMSInitiatingOccupancyOnly^&lt;br/&gt;
 -Dcom.sun.management.jmxremote.port=7199^&lt;br/&gt;
 -Dcom.sun.management.jmxremote.ssl=false^&lt;br/&gt;
 -Dcom.sun.management.jmxremote.authenticate=false^&lt;br/&gt;
 -Dlog4j.configuration=log4j-server.properties^&lt;br/&gt;
 -Dlog4j.defaultInitOverride=true&lt;/p&gt;</comment>
                            <comment id="13266161" author="pchalamet" created="Tue, 1 May 2012 21:50:30 +0000"  >&lt;p&gt;The first time truncate is called, CommitLogAllocator (line 104) calls createFreshSegment() : a new CommitLogSegment is created. It is working fine.&lt;/p&gt;

&lt;p&gt;It seems that everything collapes when the segment is recycled. CommitLogSegment failed line 119&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     buffer = logFileAccessor.getChannel().map(FileChannel.MapMode.READ_WRITE, 0, CommitLog.SEGMENT_SIZE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The map() function is failing with &quot;java.io.IOException: Map failed&quot; with an OutOfMemory as inner exception.&lt;/p&gt;

&lt;p&gt;I&apos;ve also attached a log in debug mode.&lt;/p&gt;</comment>
                            <comment id="13266183" author="jbellis" created="Tue, 1 May 2012 22:01:45 +0000"  >&lt;p&gt;The problem is you don&apos;t have enough contiguous address space to mmap the commitlog segements.&lt;/p&gt;

&lt;p&gt;1.1.1 already has a configuration parameter to change the commitlog segment size; dropping that to 16, and setting commitlog_total_space_in_mb to the same, works for me.&lt;/p&gt;

&lt;p&gt;I did find a related bug, that Cassandra keeps extra commitlog segments around at startup time.  Patch attached to fix that.&lt;/p&gt;</comment>
                            <comment id="13278449" author="vijay2win@yahoo.com" created="Fri, 18 May 2012 00:29:48 +0000"  >&lt;p&gt;+1 &lt;/p&gt;</comment>
                            <comment id="13281932" author="jbellis" created="Wed, 23 May 2012 21:34:12 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525229" name="4201.txt" size="1484" author="jbellis" created="Tue, 1 May 2012 22:01:45 +0000"/>
                            <attachment id="12525111" name="cassandra.yaml" size="24156" author="pchalamet" created="Mon, 30 Apr 2012 21:28:56 +0000"/>
                            <attachment id="12525227" name="log.txt" size="72945" author="pchalamet" created="Tue, 1 May 2012 21:50:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237579</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gt6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96157</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vijay2win@yahoo.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>