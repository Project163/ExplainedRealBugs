<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12198] Deadlock in CDC during segment flush</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12198</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8844&quot; title=&quot;Change Data Capture (CDC)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8844&quot;&gt;&lt;del&gt;CASSANDRA-8844&lt;/del&gt;&lt;/a&gt;, we added a &lt;tt&gt;synchronized(this)&lt;/tt&gt; block inside CommitLogSegment.setCDCState. This introduces the possibility of deadlock in the following scenario:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;A &lt;tt&gt;CommitLogSegment.sync()&lt;/tt&gt; call is made (synchronized method)&lt;/li&gt;
	&lt;li&gt;A &lt;tt&gt;CommitLogSegment.allocate&lt;/tt&gt; call from a cdc-enabled write is in flight and acquires a reference to the Group on appendOrder (the OpOrder in the Segment)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CommmitLogSegment.sync&lt;/tt&gt; hits &lt;tt&gt;waitForModifications&lt;/tt&gt; which calls &lt;tt&gt;appendOrder.awaitNewBarrier&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The in-flight write, if changing the state of the segment from CDCState.PERMITTED to CDCState.CONTAINS, enters &lt;tt&gt;setCDCState&lt;/tt&gt; and blocks on synchronized(this)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;And neither of them ever come back. This came up while doing some further work on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12148&quot; title=&quot;Improve determinism of CDC data availability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12148&quot;&gt;&lt;del&gt;CASSANDRA-12148&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12989264">CASSANDRA-12198</key>
            <summary>Deadlock in CDC during segment flush</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="jmckenzie">Josh McKenzie</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Jul 2016 22:02:48 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:05 +0000</updated>
                            <resolved>Thu, 14 Jul 2016 14:38:27 +0000</resolved>
                                        <fixVersion>3.8</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15375934" author="jmckenzie" created="Wed, 13 Jul 2016 22:42:06 +0000"  >&lt;p&gt;Changed synchronization to &lt;tt&gt;CommitLogSegment.cdcState&lt;/tt&gt; in CDCSizeTracker and &lt;tt&gt;CommitLogSegment.setCDCState&lt;/tt&gt;. This should give us the previously desired effect of atomic changes to this state without exposing us to the risk of deadlock by other unrelated methods synchronizing on the segment.&lt;/p&gt;

&lt;p&gt;The other 2 uses of the cdcState should be unaffected by this (write path allocation check, discard handling in segment manager) due to rules of transition (only set FORBIDDEN on segment creation, only transition from PERMITTED to CONTAINS) and discard check should be guarded by OpOrder barrier and flushing mechanisms.&lt;/p&gt;

&lt;p&gt;Given I only saw this once in the wild while working on 12148 and the very infrequent nature of it due to segment sync interaction, I&apos;d prefer we get a review and get this into 3.8 rather than blocking release to try and get a reproduction test.&lt;/p&gt;

&lt;p&gt;Ran some targeted unit tests locally w/test-cdc and things look fine (CommitLogSegmentManagerCDCTest, CommitLogTest, CommitLogStressTests). CI is running now.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.8...josh-mckenzie:12198?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12198&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/josh-mckenzie/job/josh-mckenzie-12198-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/josh-mckenzie/job/josh-mckenzie-12198-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15376818" author="jmckenzie" created="Thu, 14 Jul 2016 12:23:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; to review since Branimir is out.&lt;/p&gt;</comment>
                            <comment id="15376837" author="jmckenzie" created="Thu, 14 Jul 2016 12:45:46 +0000"  >&lt;p&gt;Updated branch to synchronize on a discrete Object rather than the cdcState enum. Apparently synchronizing on an enum in java means synchronization on the underlying Singleton object for the value which is clearly not what we want here.&lt;/p&gt;</comment>
                            <comment id="15376846" author="carlyeks" created="Thu, 14 Jul 2016 12:50:04 +0000"  >&lt;p&gt;Updated branch looks good; kicked off new CI tests. +1 once cassci is happy&lt;/p&gt;</comment>
                            <comment id="15377031" author="jmckenzie" created="Thu, 14 Jul 2016 14:38:17 +0000"  >&lt;p&gt;CI looks good - failures aren&apos;t related to this change. Committed to 3.8 branch, also to 3.9 then merged to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30xyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>