<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7245] Out-of-Order keys with stress + CQL3</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7245</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have been generating data (stress with CQL3 prepared) for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4718&quot; title=&quot;More-efficient ExecutorService for improved throughput&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4718&quot;&gt;&lt;del&gt;CASSANDRA-4718&lt;/del&gt;&lt;/a&gt; and found following problem almost in every SSTable generated (~200 GB of data and 821 SSTables).&lt;/p&gt;

&lt;p&gt;We set up they keys to be 10 bytes in size (default) and population between 1 and 600000000.&lt;/p&gt;

&lt;p&gt;Once I ran &apos;sstablekeys&apos; on the generated SSTable files I got following exceptions:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;There is a problem with sorting of normal looking keys:&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;30303039443538353645&lt;br/&gt;
30303039443745364242&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(-217680888487824985, &lt;b&gt;30303039443745364242&lt;/b&gt;) &amp;gt; DecoratedKey(-1767746583617597213, &lt;b&gt;30303039443437454333&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;00000a30303033343933&lt;br/&gt;
37344400001388343933&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(5440473860101999581, &lt;b&gt;37344400001388343933&lt;/b&gt;) &amp;gt; DecoratedKey(-7565486415339257200, &lt;b&gt;30303033344639443137&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;30303033354244363031&lt;br/&gt;
30303033354133423742&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(2687072396429900180, &lt;b&gt;30303033354133423742&lt;/b&gt;) &amp;gt; DecoratedKey(-7838239767410066684, &lt;b&gt;30303033354145344534&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;30303034313442354137&lt;br/&gt;
30343136353633340000&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(1516003874415400462, &lt;b&gt;30343136353633340000&lt;/b&gt;) &amp;gt; DecoratedKey(-9106177395653818217, &lt;b&gt;30303034313333444238&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;30303035373044373435&lt;br/&gt;
30303035373044334631&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(-3645715702154616540, &lt;b&gt;30303035373044334631&lt;/b&gt;) &amp;gt; DecoratedKey(-4296696226469000945, &lt;b&gt;30303035373132364138&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;And completely different ones:&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;30303041333745373543&lt;br/&gt;
7cd045c59a90d7587d8d&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(-3595402345023230196, &lt;b&gt;7cd045c59a90d7587d8d&lt;/b&gt;) &amp;gt; DecoratedKey(-5146766422778260690, &lt;b&gt;30303041333943303232&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;30303033323144444144&lt;br/&gt;
30303033323346343932&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(7071845511166615635, &lt;b&gt;30303033323346343932&lt;/b&gt;) &amp;gt; DecoratedKey(5233296131921119414, &lt;b&gt;53d83e00000012287e03&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;30303034314531374431&lt;br/&gt;
3806734b256c27e41ec2&lt;br/&gt;
java.io.IOException: Key out of order! DecoratedKey(-7720474642702543193, &lt;b&gt;3806734b256c27e41ec2&lt;/b&gt;) &amp;gt; DecoratedKey(-8072288379146044663, &lt;b&gt;30303034314136413343&lt;/b&gt;)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;And sometimes there is no problem at all:&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;30303033353144463637&lt;br/&gt;
0000002a31b3b31a1c2f&lt;br/&gt;
5d616dd38211ebb5d6ec&lt;br/&gt;
44423645000013880000&lt;br/&gt;
00001388138844463744&lt;br/&gt;
30303033353143394343&lt;/p&gt;

&lt;p&gt;It&apos;s worth to mention that we have got 22 timeout exceptions but number of out-of-order keys is much larger than that.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12714684">CASSANDRA-7245</key>
            <summary>Out-of-Order keys with stress + CQL3</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjake">T Jake Luciani</assignee>
                                    <reporter username="xedin">Pavel Yaskevich</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 May 2014 01:13:39 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:45 +0000</updated>
                            <resolved>Thu, 5 Jun 2014 18:24:11 +0000</resolved>
                                        <fixVersion>2.1 rc2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13999509" author="tjake" created="Fri, 16 May 2014 01:26:44 +0000"  >&lt;p&gt;We were talking on the IRC and we suspect this is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6861&quot; title=&quot;Optimise our Netty 4 integration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6861&quot;&gt;&lt;del&gt;CASSANDRA-6861&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We need to push the ref counting of pooled buffers into the mutations in case they live longer than the request.&lt;/p&gt;</comment>
                            <comment id="13999517" author="xedin" created="Fri, 16 May 2014 01:38:33 +0000"  >&lt;p&gt;Jason told me that they idea was that it could only happen when there is an operation timeout but I&apos;m not sure why almost every of 862 SSTables has such keys, when we only got total of 22 timeouts and there is no batching or anything, also it&apos;s not obvious why normal keys are getting sorted out of order too, also if the data is corrupted why the key is of correct size?...&lt;/p&gt;</comment>
                            <comment id="13999536" author="tjake" created="Fri, 16 May 2014 02:25:02 +0000"  >&lt;p&gt;Well an easy check would be roll back 6861 locally and see if the issue goes away.&lt;/p&gt;</comment>
                            <comment id="13999572" author="brandon.williams" created="Fri, 16 May 2014 03:44:29 +0000"  >&lt;p&gt;Any chance you&apos;re using HSHA? &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6285&quot; title=&quot;2.0 HSHA server introduces corrupt data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6285&quot;&gt;&lt;del&gt;CASSANDRA-6285&lt;/del&gt;&lt;/a&gt; which is still not yet committed (I have a reason for that) could be a factor in that case.&lt;/p&gt;</comment>
                            <comment id="13999588" author="xedin" created="Fri, 16 May 2014 04:17:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; It&apos;s using native, so no thrift involvement what so ever. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; We will try to do that tomorrow.&lt;/p&gt;</comment>
                            <comment id="14004124" author="xedin" created="Tue, 20 May 2014 23:28:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; Can you please generate the same amount of data as you did before but with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6861&quot; title=&quot;Optimise our Netty 4 integration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6861&quot;&gt;&lt;del&gt;CASSANDRA-6861&lt;/del&gt;&lt;/a&gt; reverted so we can test shared buffer + ref counting theory?&lt;/p&gt;</comment>
                            <comment id="14004252" author="benedict" created="Wed, 21 May 2014 02:52:45 +0000"  >&lt;p&gt;Whilst it isn&apos;t conclusive, I have been able to generate the same errors inserting large data sets with cql3 over native transport, but not over thrift. &lt;/p&gt;</comment>
                            <comment id="14008777" author="jbellis" created="Mon, 26 May 2014 11:47:29 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;bq&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; Can you please generate the same amount of data as you did before but with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6861&quot; title=&quot;Optimise our Netty 4 integration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6861&quot;&gt;&lt;del&gt;CASSANDRA-6861&lt;/del&gt;&lt;/a&gt; reverted so we can test shared buffer + ref counting theory?&lt;/p&gt;

&lt;p&gt;Good idea.  (And if it still reproduces w/o 6861, can you check 2.0?)&lt;/p&gt;</comment>
                            <comment id="14010271" author="jasobrown" created="Tue, 27 May 2014 21:05:09 +0000"  >&lt;p&gt;Reverted &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6861&quot; title=&quot;Optimise our Netty 4 integration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6861&quot;&gt;&lt;del&gt;CASSANDRA-6861&lt;/del&gt;&lt;/a&gt; as well as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5663&quot; title=&quot;Add server side write batching to the native transport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5663&quot;&gt;&lt;del&gt;CASSANDRA-5663&lt;/del&gt;&lt;/a&gt;, and was unable to reproduce the keys out of order bug. I used a rather beefy, three node cluster and used this stress command:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cassandra-stress write n=600000000 -schema replication\(factor\=2\) -key populate=1..600000000 -rate threads=42  -mode &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; prepared cql3 -port &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;=9043 thrift=9161  -col n=fixed\(21\) size=exp\(11..42\)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14010285" author="xedin" created="Tue, 27 May 2014 21:17:54 +0000"  >&lt;p&gt;That still leaves us with either 6861 or 5663, can you please generate with only 6861 reverted to rule out 5663?&lt;/p&gt;</comment>
                            <comment id="14010295" author="jasobrown" created="Tue, 27 May 2014 21:27:04 +0000"  >&lt;p&gt;Will do, but requires a bit of finesse as 5663 depends on some of the changes introduced in 6861. Just want to ensure those aren&apos;t very interesting changes.&lt;/p&gt;</comment>
                            <comment id="14010321" author="tjake" created="Tue, 27 May 2014 21:39:25 +0000"  >&lt;p&gt;I&apos;m quite sure the issue is 6861 so let me post a patch for you to test&lt;/p&gt;</comment>
                            <comment id="14010331" author="jasobrown" created="Tue, 27 May 2014 21:43:14 +0000"  >&lt;p&gt;Err, hold on - just ran a test with 6881 and no 5663, and saw the corruption (again, rather quickly). Let me try one more time, but with 6861 and without 5663.&lt;/p&gt;</comment>
                            <comment id="14010355" author="jasobrown" created="Tue, 27 May 2014 21:51:38 +0000"  >&lt;p&gt;seeing the corruption with 6861 and without 5663.&lt;/p&gt;

&lt;p&gt;So, in short, the presence of either patch causes the corruption.&lt;/p&gt;</comment>
                            <comment id="14010389" author="benedict" created="Tue, 27 May 2014 22:10:45 +0000"  >&lt;p&gt;To answer your question &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;, with RF&amp;gt;1 it&apos;s possible for the surmised bug to be hit without timeouts - if the write stage finishes applying its mutation before the OTC has forwarded the data to the next node, and we&apos;re running with CL.ONE (stress default), then the other node can get the corrupted data. If the other node was in the middle of a flush/GC, the OTC could easily be backed up causing this bug to present very commonly. I believe Jason hit this bug much more easily with RF=2, so this would explain everything.&lt;/p&gt;

&lt;p&gt;FTR, I think it is unlikely 5663 has anything to do with this.&lt;/p&gt;</comment>
                            <comment id="14010738" author="tjake" created="Wed, 28 May 2014 03:57:06 +0000"  >&lt;p&gt;Good news is I can reproduce now with the following dtest:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; time

from dtest &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Tester, debug
from assertions &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; assert_unavailable
from tools &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; (since)

#Run with MAX_HEAP_SIZE=150M HEAP_NEWSIZE=100M
 
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestNettyTransport(Tester):
    @since(&lt;span class=&quot;code-quote&quot;&gt;&apos;2.1&apos;&lt;/span&gt;)
    def reused_bytebuffers_test(self):
        debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Creating a ring&quot;&lt;/span&gt;)
        cluster = self.cluster
        cluster.set_configuration_options(values={&lt;span class=&quot;code-quote&quot;&gt;&apos;concurrent_writes&apos;&lt;/span&gt; : 2}, batch_commitlog=True)
    
        cluster.populate(2).start()
        [node1, node2] = cluster.nodelist()
        cluster.start()
     
	node1.stress([&lt;span class=&quot;code-quote&quot;&gt;&apos;write&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;n=100000&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-schema&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication(factor=2)&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;-rate&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;threads=191&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;-mode&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;cql3&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;prepared&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;-col&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;n=fixed(21)&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;size=exp(11..42)&apos;&lt;/span&gt;])	
	node1.stress([&lt;span class=&quot;code-quote&quot;&gt;&apos;read&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;n=100000&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-mode&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;cql3&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;prepared&apos;&lt;/span&gt;])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve confirmed the issue is the pooled buffer allocator reclaiming the buffers too soon. Working on patching the Mutations to keep references to the netty frame.&lt;/p&gt;</comment>
                            <comment id="14010772" author="xedin" created="Wed, 28 May 2014 04:51:12 +0000"  >&lt;p&gt;Ref counting seems an obvious culprit to me but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; is reporting that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5663&quot; title=&quot;Add server side write batching to the native transport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5663&quot;&gt;&lt;del&gt;CASSANDRA-5663&lt;/del&gt;&lt;/a&gt; has the same problem with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6861&quot; title=&quot;Optimise our Netty 4 integration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6861&quot;&gt;&lt;del&gt;CASSANDRA-6861&lt;/del&gt;&lt;/a&gt; reverted.&lt;/p&gt;</comment>
                            <comment id="14011012" author="benedict" created="Wed, 28 May 2014 10:57:15 +0000"  >&lt;p&gt;Well, 5663 depends on 6861, so it explicitly releases references (as 6861 did), so it&apos;s not a clean test. I reckon we fix the bug we know exists, and then we test thoroughly to confirm everything&apos;s okay once it&apos;s been stomped on - it&apos;ll soon come out of the woodwork if there&apos;s something else to blame as well.&lt;/p&gt;</comment>
                            <comment id="14011199" author="tjake" created="Wed, 28 May 2014 15:28:47 +0000"  >&lt;p&gt;Patch to incorporate refcount of underlying frame in write path.&lt;/p&gt;

&lt;p&gt;This fixes the issue for me.  &lt;/p&gt;</comment>
                            <comment id="14011299" author="jasobrown" created="Wed, 28 May 2014 16:47:19 +0000"  >&lt;p&gt;Hmm, unfortunately, this patch makes things worse for me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I still am seeing the decorated key exception on compaction (including here since we haven&apos;y so far in the ticket):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:4] 2014-05-28 16:42:36,909 CassandraDaemon.java:166 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:4,1,main]
java.lang.RuntimeException: Last written key DecoratedKey(-2628246975040818544, 30303030373145304638) &amp;gt;= current key DecoratedKey(-7730803788015025148, 30303030364642324138) writing into /u/sdd/cassandra-jasobrown/data/Keyspace1/Standard1-48037880e68611e3865a919228363515/Keyspace1-Standard1-tmp-ka-22-Data.db
	at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:172) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:196) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:109) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:177) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:74) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:64) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:235) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_13]
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334) ~[na:1.7.0_13]
	at java.util.concurrent.FutureTask.run(FutureTask.java:166) ~[na:1.7.0_13]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_13]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_13]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722) [na:1.7.0_13]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But now I also ref counting exceptions:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Native-Transport-Requests:176] 2014-05-28 16:37:54,838 ErrorMessage.java:218 - Unexpected exception during request
io.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1
	at io.netty.buffer.AbstractReferenceCountedByteBuf.retain(AbstractReferenceCountedByteBuf.java:64) ~[netty-all-4.0.17.Final.jar:4.0.17.Final]
	at org.apache.cassandra.transport.Frame.retain(Frame.java:60) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.db.Mutation.retain(Mutation.java:114) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.net.MessagingService.addCallback(MessagingService.java:584) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.net.MessagingService.sendRR(MessagingService.java:650) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.service.StorageProxy.sendToHintedEndpoints(StorageProxy.java:812) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.service.StorageProxy$2.apply(StorageProxy.java:122) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:703) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.service.StorageProxy.mutate(StorageProxy.java:467) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.service.StorageProxy.mutateWithTriggers(StorageProxy.java:537) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeWithoutCondition(ModificationStatement.java:503) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.cql3.statements.ModificationStatement.execute(ModificationStatement.java:487) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:187) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:413) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:133) ~[apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:414) [apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:309) [apache-cassandra-2.1.0-beta2-SNAPSHOT.jar:2.1.0-beta2-SNAPSHOT]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:103) [netty-all-4.0.17.Final.jar:4.0.17.Final]
	at io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340) [netty-all-4.0.17.Final.jar:4.0.17.Final]
	at io.netty.channel.DefaultChannelHandlerContext.access$700(DefaultChannelHandlerContext.java:29) [netty-all-4.0.17.Final.jar:4.0.17.Final]
	at io.netty.channel.DefaultChannelHandlerContext$8.run(DefaultChannelHandlerContext.java:331) [netty-all-4.0.17.Final.jar:4.0.17.Final]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_13]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_13]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722) [na:1.7.0_13]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;fwiw, it looks like the ref counting exception occurs when a memtable flush is starting:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  [SlabPoolCleaner] 2014-05-28 16:37:48,597 ColumnFamilyStore.java:857 - Enqueuing flush of Standard1: 836991055 (40%) on-heap, 0 (0%) off-heap
INFO  [MemtableFlushWriter:3] 2014-05-28 16:37:48,633 Memtable.java:331 - Writing Memtable-Standard1@1182801803(255151849 serialized bytes, 7100814 ops, 40%/0% of on/off-heap limit)
INFO  [MemtableFlushWriter:4] 2014-05-28 16:37:51,545 Memtable.java:365 - Completed flushing /u/sdd/cassandra-jasobrown/flush/Keyspace1/Standard1-48037880e68611e3865a919228363515/Keyspace1-Standard1-ka-2-Data.db (313657615 bytes) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1401294928141, position=20412051)
ERROR [Native-Transport-Requests:176] 2014-05-28 16:37:54,838 ErrorMessage.java:218 - Unexpected exception during request
io.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I could be wrong about this, but it anecdotally looks related.&lt;/p&gt;</comment>
                            <comment id="14011674" author="tjake" created="Wed, 28 May 2014 22:01:53 +0000"  >&lt;p&gt;I was able to replicate the issue on a physical cluster.&lt;/p&gt;

&lt;p&gt;with v2 patch I no longer see the corruption, but I do see a couple recount errors on the first inserts of the first run.  &lt;/p&gt;

&lt;p&gt;I&apos;m trying to track that down but please give this one a try in the meantime.&lt;/p&gt;</comment>
                            <comment id="14011738" author="jasobrown" created="Wed, 28 May 2014 22:40:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; well, i see less IllegalReferenceCountExceptions, but still getting the keys out of order exception. I can get the cluster into that state within &amp;lt; 5 minutes using the same stress command i inserted earlier in this ticket. &lt;/p&gt;</comment>
                            <comment id="14011749" author="benedict" created="Wed, 28 May 2014 22:52:44 +0000"  >&lt;p&gt;There&apos;s a race in your patch where a response can come back from another machine while the expiringmap is timing it out (and writing a hint), causing a ref can be decremented twice. Can fix this by only calling the postExpireHook if remove() actually removes the item. It&apos;s a pretty narrow race, though, so not convinced it&apos;s the cause of such easy reproduction.&lt;/p&gt;

&lt;p&gt;Is it also possible Netty is tidying a reference for us if e.g. a connection gets disconnected? Should we take a single reference to guard our native-transport-request thread&apos;s participation in the write operation? Again, not convinced it&apos;s causing these problems, but it&apos;s a concern for border cases.&lt;/p&gt;

&lt;p&gt;FYI, it&apos;s not necessary for sourceFrame to be volatile, as it&apos;s always guarded by either an executor service or concurrenthashmap access&lt;/p&gt;</comment>
                            <comment id="14011825" author="xedin" created="Wed, 28 May 2014 23:38:00 +0000"  >&lt;p&gt;I still not sure if Netty is a direct cause of this problem and this is why - in Memtable.put(DecoratedKey, ...) we clone key and cf, after that while Memtable is being flushed SSTableWriter.beforeAppend(DecoratedKey) does check if the last written key greater or equals to current key as there are no errors reported on the flush that most luckily leaves us with the situation when corruption (if it is a corruption) is happening after SSTableWriter.beforeAppend(DecoratedKey) check.&lt;/p&gt;</comment>
                            <comment id="14011835" author="benedict" created="Wed, 28 May 2014 23:44:58 +0000"  >&lt;p&gt;Except that we sort in the Memtable/CLSM (and assert order at flush) by Token which is computed much earlier, whereas we write the raw key only, which could have been corrupted by the time we copy it.&lt;/p&gt;</comment>
                            <comment id="14011850" author="jasobrown" created="Wed, 28 May 2014 23:58:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Just to clarify a few things: Is the sorting within Memtable.put(), due to adding the entry to the ConcurrentSkipListMap? &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;assert order at flush&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;SSTableWriter.beforeAppend(), correct?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;whereas we write the raw key only&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;still SSTableWriter?&lt;/p&gt;
</comment>
                            <comment id="14011854" author="benedict" created="Thu, 29 May 2014 00:03:48 +0000"  >&lt;p&gt;Correct on all the above &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14011880" author="xedin" created="Thu, 29 May 2014 00:29:11 +0000"  >&lt;p&gt;Ah, so that&apos;s the piece I&apos;m missing, we check actual bytes iff tokens are equal. We are going to do a test when instead of ByteBuf.slice we are always going to copy the data to the byte[], let&apos;s see if that runs into the same problem.&lt;/p&gt;</comment>
                            <comment id="14011927" author="tjake" created="Thu, 29 May 2014 01:11:41 +0000"  >&lt;p&gt;You can also work around the problem by changing the allocator in CBUtil to UnpooledByteBufAllocator(false)&lt;/p&gt;</comment>
                            <comment id="14011960" author="xedin" created="Thu, 29 May 2014 01:46:15 +0000"  >&lt;p&gt;That&apos;s fine what we really want to test is if slicing of ByteBuf is what creates an issue or is there something else.&lt;/p&gt;</comment>
                            <comment id="14012067" author="jasobrown" created="Thu, 29 May 2014 04:54:11 +0000"  >&lt;p&gt;I took the 2.1 branch made the following minor change to CBUtil.readValue():&lt;/p&gt;

&lt;p&gt;current:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ByteBuffer readValue(ByteBuf cb)
    {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; length = cb.readInt();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (length &amp;lt; 0)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        ByteBuf slice = cb.readSlice(length);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (slice.nioBufferCount() &amp;gt; 0)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; slice.nioBuffer();
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ByteBuffer.wrap(readRawBytes(cb));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;slight change to always copy the netty buffer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ByteBuffer readValue(ByteBuf cb)
    {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; length = cb.readInt();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (length &amp;lt; 0)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        ByteBuf slice = cb.readSlice(length);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ByteBuffer.wrap(readRawBytes(slice));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and ran stress again. It has been going for greater than four hours, and no sign of the reported corruption (keys out of order exception) on the compaction merge. Thus, I think it&apos;s reasonable to assume that data corruption is sneaking in due to the wrapping/reuse of the netty buffer.&lt;/p&gt;</comment>
                            <comment id="14012074" author="xedin" created="Thu, 29 May 2014 05:14:13 +0000"  >&lt;p&gt;Perfect, that&apos;s what I wanted to hear &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14012260" author="slebresne" created="Thu, 29 May 2014 10:25:58 +0000"  >&lt;p&gt;Since it&apos;s time to go ahead with 2.1 RC1, and unless somewhat has a fix he is 100% confident with now, can we commit Jason&apos;s copy changes above (or change the allocator) for now? We can then take the time to fix this correctly without copy for 2.1.1 (or 2.1.0 final, I don&apos;t really mind if we test properly).&lt;/p&gt;</comment>
                            <comment id="14012324" author="jasobrown" created="Thu, 29 May 2014 12:36:22 +0000"  >&lt;p&gt;I&apos;m reasonably OK with the idea of shipping either my fix or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;&apos;s pool suggestion as a temporary relief. &lt;/p&gt;</comment>
                            <comment id="14012339" author="tjake" created="Thu, 29 May 2014 12:58:03 +0000"  >&lt;p&gt;Both accomplish the same goal.  since you&apos;ve already tested your patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; let&apos;s go with that (ninja?).  I&apos;ll continue working on this in the meantime.&lt;/p&gt;</comment>
                            <comment id="14012349" author="tjake" created="Thu, 29 May 2014 13:19:43 +0000"  >&lt;p&gt;Ok, I pushed Jason&apos;s fix&lt;/p&gt;</comment>
                            <comment id="14014880" author="tjake" created="Sun, 1 Jun 2014 01:19:53 +0000"  >&lt;p&gt;After much experimentation I&apos;ve found one of the issues here:&lt;/p&gt;

&lt;p&gt;Our version of netty throws away buffers once they have been read.  This issue was fixed in the latest netty so buffer with refcounts aren&apos;t cannibalized  &lt;a href=&quot;https://github.com/netty/netty/issues/2327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/2327&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve tested a with 4.0.19 release and the token corruption is now gone.&lt;/p&gt;

&lt;p&gt;I am however seeing some kind of race condition which I think may be netty related as well. It seems like the same Message is being dispatched to multiple threads sometimes and causing refcount exceptions.  I&apos;ve added logging to capture the history when this happens and I&apos;m trying to track this down.&lt;/p&gt;</comment>
                            <comment id="14015897" author="tjake" created="Mon, 2 Jun 2014 21:08:20 +0000"  >&lt;p&gt;v3 passes my cluster tests for counters/non-counters. I still need to test with triggers and batch inserts though.&lt;/p&gt;

&lt;p&gt;Could you test this version &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; with the attached netty jar?&lt;/p&gt;</comment>
                            <comment id="14015969" author="jasobrown" created="Mon, 2 Jun 2014 22:21:24 +0000"  >&lt;p&gt;will give it a shot this afternoon - thanks!&lt;/p&gt;</comment>
                            <comment id="14015976" author="jasobrown" created="Mon, 2 Jun 2014 22:26:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; can you rebase? the v3 patch didn&apos;t apply cleanly:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ git apply ../patches/reviews/7245v3.txt
error: patch failed: src/java/org/apache/cassandra/service/StorageProxy.java:780
error: src/java/org/apache/cassandra/service/StorageProxy.java: patch does not apply
error: patch failed: src/java/org/apache/cassandra/transport/Frame.java:199
error: src/java/org/apache/cassandra/transport/Frame.java: patch does not apply
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14016083" author="tjake" created="Tue, 3 Jun 2014 00:29:24 +0000"  >&lt;p&gt;attached v3 rebase&lt;/p&gt;</comment>
                            <comment id="14016926" author="benedict" created="Tue, 3 Jun 2014 18:02:41 +0000"  >&lt;p&gt;I think there&apos;s a bug if there is a counter write sent to an owning coordinator: SP.applyCounterMutationOnCoordinator does not take retain a reference, but it gets executed asynchronously on the countermutation executor service.&lt;/p&gt;</comment>
                            <comment id="14017099" author="tjake" created="Tue, 3 Jun 2014 20:26:26 +0000"  >&lt;p&gt;Good catch. v4 attached&lt;/p&gt;</comment>
                            <comment id="14017249" author="jasobrown" created="Tue, 3 Jun 2014 23:18:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; v4 looks good for my tests.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; looks like you&apos;ve been playing the at-home game, as well. Do you want to handle the review? Else, I can do it (not a problem)&lt;/p&gt;</comment>
                            <comment id="14018257" author="benedict" created="Wed, 4 Jun 2014 22:08:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; I got this one if you&apos;ve got better stuff to do &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I think the change you made doesn&apos;t actually totally eliminate the bug: since it extends DroppableRunnable, the finally block may never be run&lt;/li&gt;
	&lt;li&gt;In SP.mutate() you can&apos;t release the mutations until after we get the all clear from the replicas, as we may have to use the mutations to write local hints. It might be nice, however, to have the response handler release() the reference once we receive enough responses from our replicas, so that we don&apos;t keep all of the references if we&apos;re just waiting for one mutation&lt;/li&gt;
	&lt;li&gt;Why do we need a ThreadLocal in ClientState to store the sourceFrame. Can&apos;t we just store it directly in a field in QueryState?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Nit:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;WS in ClientState constructor; would also prefer to just create ThreadLocal in var initialiser since it&apos;s always init&apos;d empty&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also, this is off-topic, but I wonder if we shouldn&apos;t replace the NBHM in ServerConnection with a simple array. We know the range is &amp;lt; 32K (&amp;lt;.1K for older clients), and each index is accessed by a single thread at any given time, so we&apos;d just need to be able to atomically swap in larger arrays if we wanted dynamic sizing. &lt;/p&gt;

&lt;p&gt;Otherwise LGTM&lt;/p&gt;</comment>
                            <comment id="14018428" author="tjake" created="Thu, 5 Jun 2014 02:43:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;In SP.mutate() you can&apos;t release the mutations until after we get the all clear from the replicas, as we may have to use the mutations to write local hints.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;MS.addCallback also retains the mutation, this will be released by either the timeoutReporter, or in the ResponseVerbHander&lt;/p&gt;

&lt;p&gt;You are right on the other two points, I got rid of the ThreadLocal and moved the frame to QueryState only. and I fixed the DroppableRunnable so release always gets called.  Attached as v5&lt;/p&gt;</comment>
                            <comment id="14018731" author="benedict" created="Thu, 5 Jun 2014 12:25:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;MS.addCallback also retains the mutation, this will be released by either the timeoutReporter, or in the ResponseVerbHander&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Unfortunately there&apos;s still a race condition there, as these can be released by the ExpiringMap reaper (or by the responses arriving in the interval) before the exception block runs, so that they&apos;ve been reallocated by the time we submit them as hints&lt;/p&gt;</comment>
                            <comment id="14018938" author="tjake" created="Thu, 5 Jun 2014 16:42:59 +0000"  >&lt;p&gt;Ok v6 releases the refrence at once at the end of mutate() vs as it processes them to avoid any raciness &lt;/p&gt;</comment>
                            <comment id="14018958" author="benedict" created="Thu, 5 Jun 2014 16:53:37 +0000"  >&lt;p&gt;Might be worthwhile clarifying the comment on only releasing the prefix of mutations we&apos;d actually despatched. Otherwise LGTM +1&lt;/p&gt;</comment>
                            <comment id="14019057" author="tjake" created="Thu, 5 Jun 2014 18:24:11 +0000"  >&lt;p&gt;done and committed thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12647226" name="7245-v2.txt" size="24755" author="tjake" created="Wed, 28 May 2014 22:01:53 +0000"/>
                            <attachment id="12647145" name="7245.txt" size="18116" author="tjake" created="Wed, 28 May 2014 15:28:47 +0000"/>
                            <attachment id="12648036" name="7245v3-rebase.txt" size="33871" author="tjake" created="Tue, 3 Jun 2014 00:29:24 +0000"/>
                            <attachment id="12647989" name="7245v3.txt" size="32799" author="tjake" created="Mon, 2 Jun 2014 21:08:20 +0000"/>
                            <attachment id="12648217" name="7245v4.txt" size="35998" author="tjake" created="Tue, 3 Jun 2014 20:26:26 +0000"/>
                            <attachment id="12648417" name="7245v5.txt" size="33979" author="tjake" created="Thu, 5 Jun 2014 02:43:29 +0000"/>
                            <attachment id="12648508" name="7245v6.txt" size="34034" author="tjake" created="Thu, 5 Jun 2014 16:42:59 +0000"/>
                            <attachment id="12647984" name="netty-all-4.0.19.Final.jar" size="1678810" author="tjake" created="Mon, 2 Jun 2014 20:47:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392997</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1voav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393165</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326276">2.1 beta2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>