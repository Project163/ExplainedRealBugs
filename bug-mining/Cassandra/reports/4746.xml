<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13265] Expiration in OutboundTcpConnection can block the reader Thread</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13265</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I observed that sometimes a single node in a Cassandra cluster fails to communicate to the other nodes. This can happen at any time, during peak load or low load. Restarting that single node from the cluster fixes the issue.&lt;/p&gt;

&lt;p&gt;Before going in to details, I want to state that I have analyzed the situation and am already developing a possible fix. Here is the analysis so far:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A Threaddump in this situation showed  324 Threads in the OutboundTcpConnection class that want to lock the backlog queue for doing expiration.&lt;/li&gt;
	&lt;li&gt;A class histogram shows 262508 instances of OutboundTcpConnection$QueuedMessage.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What is the effect of it? As soon as the Cassandra node has reached a certain amount of queued messages, it starts thrashing itself to death. Each of the Thread fully locks the Queue for reading and writing by calling iterator.next(), making the situation worse and worse.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Writing: Only after 262508 locking operation it can progress with actually writing to the Queue.&lt;/li&gt;
	&lt;li&gt;Reading: Is also blocked, as 324 Threads try to do iterator.next(), and fully lock the Queue&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This means: Writing blocks the Queue for reading, and readers might even be starved which makes the situation even worse.&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;The setup is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;3-node cluster&lt;/li&gt;
	&lt;li&gt;replication factor 2&lt;/li&gt;
	&lt;li&gt;Consistency LOCAL_ONE&lt;/li&gt;
	&lt;li&gt;No remote DC&apos;s&lt;/li&gt;
	&lt;li&gt;high write throughput (100000 INSERT statements per second and more during peak times).&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment>&lt;p&gt;Cassandra 3.0.9&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM version 25.112-b15 (Java version 1.8.0_112-b15)&lt;br/&gt;
Linux 3.16&lt;/p&gt;</environment>
        <key id="13046063">CASSANDRA-13265</key>
            <summary>Expiration in OutboundTcpConnection can block the reader Thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cesken">Christian Esken</assignee>
                                    <reporter username="cesken">Christian Esken</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Feb 2017 16:16:48 +0000</created>
                <updated>Fri, 15 May 2020 08:00:50 +0000</updated>
                            <resolved>Wed, 3 May 2017 20:55:34 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Messaging/Internode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15883042" author="cesken" created="Fri, 24 Feb 2017 16:38:12 +0000"  >&lt;p&gt;Thread Dump&lt;/p&gt;</comment>
                            <comment id="15883044" author="cesken" created="Fri, 24 Feb 2017 16:38:35 +0000"  >&lt;p&gt;Class Histogram&lt;/p&gt;</comment>
                            <comment id="15883047" author="cesken" created="Fri, 24 Feb 2017 16:39:14 +0000"  >&lt;p&gt;The Thread dumps show, that several Threads park on the same objects.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;324 Threads are waiting on the same object, trying to iterate over Queue (expiration)&lt;/li&gt;
	&lt;li&gt;24 Threads  wait on a different object, as far as we see they try to read from the Queue&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;--- cassandra.pb-cache4-dus.2017-02-20-01-41-14.td -------------------------------------------------------------------
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c04b1748&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c056d4f0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c0579c60&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
     24         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c058ce50&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c058e520&amp;gt; (a java.util.concurrent.Semaphore$NonfairSync)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c058ee50&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c0592bc0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c0593058&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c0593ae0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c05958d0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c059f788&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      4         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c07f5ea8&amp;gt; (a java.util.concurrent.SynchronousQueue$TransferStack)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c0df0548&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c4b52790&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c56a7ca8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c56beea8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c56bf2d8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
    324         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c5d5a150&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c628edb0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c6290b78&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c62958a8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c6295b08&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c72343a8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c7581d58&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001c8dd5738&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001ccdc3b80&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001cd22e1b0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001f3c39428&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000001fb43f5d0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
      1         - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000002003b6018&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15883172" author="cesken" created="Fri, 24 Feb 2017 17:41:26 +0000"  >&lt;p&gt;Link to the current patch: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...christian-esken:13265-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...christian-esken:13265-3.0?expand=1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15883446" author="aweisberg" created="Fri, 24 Feb 2017 20:15:37 +0000"  >&lt;p&gt;Thanks for catching this. I am not clear on you end up with so many threads blocked. There shouldn&apos;t be that many threads since only 128 request threads can be in flight in a default configuration. What are these threads and what pool are they coming from?&lt;/p&gt;

&lt;p&gt;This fix creates a thread to do the scheduled work per outbound TCP connection and unfortunately we have a lot of them. For a typical thousand node cluster we will create 6k threads (3 inbound, 3 outbound) and this would add another 3k.&lt;/p&gt;

&lt;p&gt;I think the ideal fix would commit a bounded number of threads to processing expiration work. It would also only attempt to expire on a fixed interval so excessive time isn&apos;t spent checking for expirations that won&apos;t occur because no time has passed.&lt;/p&gt;

&lt;p&gt;Initially I was going to suggest another thread pool based approach to handle expiration, but I don&apos;t see much to be gained doing expiration in a separate thread. Certainly it would reduce outliers and be more non-blocking. You could do the expiration work in the thread submitting a message and just take care that only one thread does expiration work every X milliseconds/seconds.&lt;/p&gt;

&lt;p&gt;So the general requirements as I see it whether you use another thread or not.:&lt;/p&gt;

&lt;p&gt;If there is currently no expiration processing task for a connection and it looks like we should expire then we should atomically perform expiration. It would be okay to occasionally miss executing expiration since the next message will have an opportunity to perform expiration. We should not perform expiration if the time since the last expiration finished is &amp;lt; some threshold that is configurable via cassandra.yaml and JMX (also queryable via JMX).&lt;/p&gt;

&lt;p&gt;If we do decide to use a thread pool I think you want allocate a bounded thread pool that is not that big. Maybe min(availableProcessors, 4). Configurable via a property.&lt;/p&gt;

&lt;p&gt;This also needs to be done on 2.1, 2.2, 3.0, 3.11, and trunk, but to start just get it done in one version so we can get the design right.&lt;/p&gt;</comment>
                            <comment id="15887685" author="cesken" created="Tue, 28 Feb 2017 09:50:19 +0000"  >&lt;p&gt;I see your argument. On larger clusters this may get problematic. I will try to summarize the alternative solutions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Offload expiration to a &quot;random&quot; regular Thread, but only a single one. If one Thread already expires ...
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;... let the other Threads continue  (1)&lt;/li&gt;
		&lt;li&gt;... let the other Threads wait  (2)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Use an &quot;Expiration Thread Pool&quot; (3). I am not (currently) in favor for it, and if I understood you correctly then it is also not your preference.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will implement option (1) today.&lt;/p&gt;


&lt;p&gt;Please see the attached Thread Dump to see which Threads are blocking. Here are two examples from the Thread Dumps. Mainly they are SharedPool-Worker threads, that either do iterator.remove() or iterator.next(). I think in the Threaddump there is also a HintDispatcher Thread that is parking on the same lock.&lt;/p&gt;

&lt;p&gt;java.util.concurrent.LinkedBlockingQueue$Itr.remove:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;SharedPool-Worker-294&quot;&lt;/span&gt; #587 daemon prio=5 os_prio=0 tid=0x00007fb69b11e260 nid=0x6090 waiting on condition [0x00007fb162c0e000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000023a426218&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
        at java.util.concurrent.LinkedBlockingQueue.fullyLock(LinkedBlockingQueue.java:225)
        at java.util.concurrent.LinkedBlockingQueue$Itr.remove(LinkedBlockingQueue.java:840)
        at org.apache.cassandra.net.OutboundTcpConnection.expireMessages(OutboundTcpConnection.java:555)
        at org.apache.cassandra.net.OutboundTcpConnection.enqueue(OutboundTcpConnection.java:165)
        at org.apache.cassandra.net.MessagingService.sendOneWay(MessagingService.java:771)
        at org.apache.cassandra.net.MessagingService.sendReply(MessagingService.java:744)
        at org.apache.cassandra.hints.HintVerbHandler.reply(HintVerbHandler.java:99)
        at org.apache.cassandra.hints.HintVerbHandler.doVerb(HintVerbHandler.java:94)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;java.util.concurrent.LinkedBlockingQueue$Itr.next:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;SharedPool-Worker-295&quot;&lt;/span&gt; #590 daemon prio=5 os_prio=0 tid=0x00007fb69b1135b0 nid=0x608d waiting on condition [0x00007fb162cd1000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000023a426218&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
        at java.util.concurrent.LinkedBlockingQueue.fullyLock(LinkedBlockingQueue.java:225)
        at java.util.concurrent.LinkedBlockingQueue$Itr.next(LinkedBlockingQueue.java:823)
        at org.apache.cassandra.net.OutboundTcpConnection.expireMessages(OutboundTcpConnection.java:550)
        at org.apache.cassandra.net.OutboundTcpConnection.enqueue(OutboundTcpConnection.java:165)
        at org.apache.cassandra.net.MessagingService.sendOneWay(MessagingService.java:771)
        at org.apache.cassandra.net.MessagingService.sendReply(MessagingService.java:744)
        at org.apache.cassandra.hints.HintVerbHandler.reply(HintVerbHandler.java:99)
        at org.apache.cassandra.hints.HintVerbHandler.doVerb(HintVerbHandler.java:94)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15888439" author="cesken" created="Tue, 28 Feb 2017 16:58:55 +0000"  >&lt;p&gt;Here is one possibly very important observation. It looks like Coalescing is doing an infinite loop while doing maybeSleep(). I checked 10 Thread dumps, and in each of them the Thread was at the same location. Is it possible that averageGap is 0? This would lead to infinite recursion.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; maybeSleep(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; messages, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; averageGap, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; maxCoalesceWindow, Parker parker)
    {
        &lt;span class=&quot;code-comment&quot;&gt;// only sleep &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we can expect to &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; the number of messages we&apos;re sending in the time interval
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sleep = messages * averageGap; &lt;span class=&quot;code-comment&quot;&gt;// TODO can averageGap be 0 ?
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sleep &amp;gt; maxCoalesceWindow)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

        &lt;span class=&quot;code-comment&quot;&gt;// assume we receive as many messages as we expect; apply the same logic to the &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; batch:
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// expect twice as many messages to consider sleeping &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;another&quot;&lt;/span&gt; interval; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; basically translates
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// to doubling our sleep period until we exceed our max sleep window
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (sleep * 2 &amp;lt; maxCoalesceWindow)
            sleep *= 2;     &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; CoalescingStrategies:106
&lt;/span&gt;        parker.park(sleep);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If sum is bigger than MEASURED_INTERVAL, then averageGap() returns 0. I am aware that this is highly unlikely, but I cannot explain the likely hanging in maybeSleep() line 106.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; averageGap()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sum == 0)
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE;
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MEASURED_INTERVAL / sum;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15888465" author="aweisberg" created="Tue, 28 Feb 2017 17:09:45 +0000"  >&lt;p&gt;This bug was noticed recently and fixed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13159&quot; title=&quot;Coalescing strategy can enter infinite loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13159&quot;&gt;&lt;del&gt;CASSANDRA-13159&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15889631" author="jjirsa" created="Wed, 1 Mar 2017 06:50:22 +0000"  >&lt;p&gt;Closing&lt;/p&gt;</comment>
                            <comment id="15890092" author="cesken" created="Wed, 1 Mar 2017 12:45:30 +0000"  >&lt;p&gt;Reopening.&lt;/p&gt;

&lt;p&gt;While the &quot;averageGap == 0&quot; issue has been fixed, I would still want to fix the issue from the description. That issue is that multiple Threads do the expiration, which leads to unnecessary locking, more CPU usage  and possible starvation of the reader Thread.&lt;/p&gt;

&lt;p&gt;I will prepare a patch, that fixes that.&lt;/p&gt;</comment>
                            <comment id="15890155" author="cesken" created="Wed, 1 Mar 2017 13:26:13 +0000"  >&lt;p&gt;Here is the patch for reducing contention in the queue expiration. The patch wraps expireMessages() in expireMessagesConditionally(), which makes sure that only a single Thread will do expiration at the same time:&lt;br/&gt;
  &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...christian-esken:13265-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...christian-esken:13265-3.0?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;PS: Commits in this patch are not yet squashed. If the patch is good, I will create a proper branch to have a more clear history.&lt;/p&gt;</comment>
                            <comment id="15890195" author="jasobrown" created="Wed, 1 Mar 2017 13:51:36 +0000"  >&lt;p&gt;I think this patch is reasonable, so please clean it up for review. As a quick comment, you can collapse the functionality of &lt;tt&gt;expireMessagesConditionally()&lt;/tt&gt; into &lt;tt&gt;expireMessages()&lt;/tt&gt; and leave out the &lt;tt&gt;BACKLOG_EXPIRATION_DEBUG&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15890199" author="cesken" created="Wed, 1 Mar 2017 13:54:19 +0000"  >&lt;p&gt;Will do. Thanks for your quick feedback.&lt;/p&gt;</comment>
                            <comment id="15890315" author="githubbot" created="Wed, 1 Mar 2017 14:58:10 +0000"  >&lt;p&gt;GitHub user christian-esken opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Expire messages by a single Thread&lt;/p&gt;

&lt;p&gt;    When queue expiration is done, one single Thread is elected to do the&lt;br/&gt;
    work. Previously, all Threads would go in and do the same work,&lt;br/&gt;
    producing high lock contention. The Thread reading from the Queue could&lt;br/&gt;
    even be starved by not be able to acquire the read lock. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13265&quot; title=&quot;Expiration in OutboundTcpConnection can block the reader Thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13265&quot;&gt;&lt;del&gt;CASSANDRA-13265&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/christian-esken/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra&lt;/a&gt; 13265b-3.0&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/95.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #95&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 448d7a9c1430d9f23bd819895fc618bb227ca833&lt;br/&gt;
Author: Christian Esken &amp;lt;christian.esken@trivago.com&amp;gt;&lt;br/&gt;
Date:   2017-03-01T14:56:36Z&lt;/p&gt;

&lt;p&gt;    Expire messages by a single Thread&lt;/p&gt;

&lt;p&gt;    When queue expiration is done, one single Thread is elected to do the&lt;br/&gt;
    work. Previously, all Threads would go in and do the same work,&lt;br/&gt;
    producing high lock contention. The Thread reading from the Queue could&lt;br/&gt;
    even be starved by not be able to acquire the read lock. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13265&quot; title=&quot;Expiration in OutboundTcpConnection can block the reader Thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13265&quot;&gt;&lt;del&gt;CASSANDRA-13265&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15890316" author="cesken" created="Wed, 1 Mar 2017 14:59:12 +0000"  >&lt;p&gt;I created a fresh branch to have a clean commit. The Pull request is opened: &lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15890439" author="jasobrown" created="Wed, 1 Mar 2017 16:01:00 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;remove &lt;tt&gt;BACKLOG_EXPIRATION_DEBUG&lt;/tt&gt; logging and constant.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;backlogExpireAt&lt;/tt&gt; should be a class constant (&lt;tt&gt;private static final BACKLOG_EXPIRE_AT&lt;/tt&gt;. Also, maybe rename this to something like &lt;tt&gt;BACKLOG_PURGE_SIZE&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15890471" author="aweisberg" created="Wed, 1 Mar 2017 16:19:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; Seems like wires got crossed. This issue still exists. It&apos;s just the infinite loop in the comments that was already addressed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cesken&quot; class=&quot;user-hover&quot; rel=&quot;cesken&quot;&gt;cesken&lt;/a&gt; This still allows back to back expirations to continue. I think we only want to attempt expiration every 200 milliseconds or something.&lt;/p&gt;</comment>
                            <comment id="15890836" author="jasobrown" created="Wed, 1 Mar 2017 19:14:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;This still allows back to back expirations to continue&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This happens in the existing code already. We exit out of the loop when we find the first message that is not timed out: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/OutboundTcpConnection.java#L563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;, however, you could (and can) have multiple threads each iterating over the LBQ. Where things get really nuts is in the iterator in LBQ (&lt;tt&gt;LinkedBlockingQueue.Itr&lt;/tt&gt;), all of the methods need to acquire both the put and take locks for the instance, combined with the OTC thread itself trying to acquire the take lock. So it&apos;s pretty clear how you can get into lock acquisition hell here if the messages are not being consumed fast enough.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cesken&quot; class=&quot;user-hover&quot; rel=&quot;cesken&quot;&gt;cesken&lt;/a&gt;&apos;s patch relieves the callers of &lt;tt&gt;OutboundTcpConnection#enqueue()&lt;/tt&gt; from having to contend for the LBQ locks, and I think that&apos;s the biggest benefit. I don&apos;t have a strong enough opinion about only expiring after some length of time has elapsed. tbh, I&apos;d prefer to defer that kind of extra behavior until we can prove that the current patch doesn&apos;t satisfy what is needed here.&lt;/p&gt;</comment>
                            <comment id="15890865" author="aweisberg" created="Wed, 1 Mar 2017 19:26:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;This happens in the existing code already. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That doesn&apos;t make it not a bad behavior that blocks the reader thread while it goes to do some potentially large task that doesn&apos;t actually accomplish anything. Iterating a list with 262508 elements is not going to be very fast. The list can actually be longer now that threads aren&apos;t going to be slowed down appending to the list by the need to iterate for expiration.&lt;/p&gt;

&lt;p&gt;We have no way of knowing if this is actually fixed. How often does this issue occur? This expiration code is ancient, but it hasn&apos;t been reported until now.&lt;/p&gt;

&lt;p&gt;I don&apos;t think we should leave it to silently afflict people later on who may not know what&apos;s going on or how to address it.&lt;/p&gt;

&lt;p&gt;Expiration is based on time. There is no point in attempting expiration again immediately because almost nothing will have expired. It allows one bad connection to consume resources it shouldn&apos;t in the form of hijacking a thread to iterate a list.&lt;/p&gt;

&lt;p&gt;I don&apos;t see the downside of switching from a boolean to a long and CASing that instead. If we aren&apos;t confident in it we can set a small interval so that it still checks for expiration often although I think that just generates useless work. We can&apos;t make timeouts pass faster.&lt;/p&gt;</comment>
                            <comment id="15891356" author="zznate" created="Thu, 2 Mar 2017 00:23:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;How often does this issue occur?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not very often, IME, but it does happen. You can see this if you monitor the &lt;tt&gt;ConnectionMetrics#commandDroppedTasks&lt;/tt&gt; gauge. &lt;/p&gt;</comment>
                            <comment id="15891641" author="aweisberg" created="Thu, 2 Mar 2017 05:09:19 +0000"  >&lt;p&gt;I didn&apos;t notice that it already bails out and doesn&apos;t iterate the entire list once it encounters the first message that isn&apos;t timed out. In that case it&apos;s fine to attempt to iterate the queue frequently because the cost to check is low since it will fail on the first element.&lt;/p&gt;

&lt;p&gt;I am actually surprised this a performance issue. I guess that there is some pathological behavior once you start trying to have multiple threads iterate and remove at the same time and they actually end up needing to remove elements.&lt;/p&gt;

&lt;p&gt;I&apos;ll kick off utests and dtests for this tomorrow.&lt;/p&gt;</comment>
                            <comment id="15891896" author="cesken" created="Thu, 2 Mar 2017 09:20:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;How often does this issue occur?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not very often, but it happens. I assume that special scenarios trigger this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;High write-throughput  (especially when you have write spikes it is easy to get above 1024 messages)&lt;/li&gt;
	&lt;li&gt;A long Stop-the-World GC phase (because then even more Threads could start to write and iterate the Queue)&lt;/li&gt;
	&lt;li&gt;Temporary network overload to the target node (because nothing is taken from the Queue in that case).&lt;/li&gt;
	&lt;li&gt;Many non-droppable entries in the Queue (because then the loop does not bail out:  &quot;if (! qm.droppable)  continue;&quot; )&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Temporary overloads usually resolve themselves, but in this case it does not. As soon as the Queue has reached a certain size limit, most time is spent in iterating the Queue, and the reader is starved (1 reader Thread fights against 324 Threads that do a read-lock by calling iterator.next()).&lt;/p&gt;</comment>
                            <comment id="15891905" author="cesken" created="Thu, 2 Mar 2017 09:25:38 +0000"  >&lt;p&gt;Ariel wrote:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Expiration is based on time. There is no point in attempting expiration again immediately because almost nothing will have expired. It allows one bad connection to consume resources it shouldn&apos;t in the form of hijacking a thread to iterate a list.&lt;/p&gt;

&lt;p&gt;I don&apos;t see the downside of switching from a boolean to a long and CASing that instead. If we aren&apos;t confident in it we can set a small interval so that it still checks for expiration often although I think that just generates useless work. We can&apos;t make timeouts pass faster.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;, I understand that you want to CAS on &quot;lastExpirationTime&quot;, right? I am also for doing this. Its fitting better and still keeps the change simple. In that case the Thread should iterate the whole Queue, and not bail out on the first hit. I will change it in the PR.&lt;/p&gt;</comment>
                            <comment id="15892114" author="cesken" created="Thu, 2 Mar 2017 11:40:21 +0000"  >&lt;p&gt;I updated the PR with the following changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Variable names / modifiers (static)&lt;/li&gt;
	&lt;li&gt;Expiration is based on time&lt;/li&gt;
	&lt;li&gt;Expiration inspects the whole Queue (no bailing out)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is really hard to reproduce and to test. Because of that I did not yet remove the BACKLOG_EXPIRATION_DEBUG. If you have a hint about test possibilities, let me know.&lt;/p&gt;</comment>
                            <comment id="15892217" author="jasobrown" created="Thu, 2 Mar 2017 13:07:17 +0000"  >&lt;p&gt;Some comments on the patch&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;use &lt;tt&gt;System.nanoTime()&lt;/tt&gt; instead of &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt;. nanoTime is monotonic, currentTimeMillis is not.&lt;/li&gt;
	&lt;li&gt;for testing, I&apos;d give &lt;tt&gt;expireMessages&lt;/tt&gt; default visibility, and write a test that enqueues a bunch of messages the expire in n seconds, immediately calls &lt;tt&gt;expireMessages&lt;/tt&gt; and ensure no messages were purged, wait the &lt;tt&gt;BACKLOG_EXPIRATION_INTERVAL_MILLIS&lt;/tt&gt;, then invoke &lt;tt&gt;expireMessages&lt;/tt&gt; and make sure everything was purged. You don&apos;t need to run OTC as a thread or with the consumer part of the class executing.&lt;/li&gt;
	&lt;li&gt;then you can remove the {[BACKLOG_EXPIRATION_DEBUG}} &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15892221" author="jasobrown" created="Thu, 2 Mar 2017 13:12:15 +0000"  >&lt;p&gt;tbh, I don&apos;t think we want to traverse the entire &lt;tt&gt;backlog&lt;/tt&gt;. If we go with the assumption that items are added to the backlog &apos;reasonably&apos; in ascending timestamp order, then even a few out of order entries won&apos;t make much of a difference to the overload load. Thus, bailing out on the first non-expired message is still a sensible thing.&lt;/p&gt;</comment>
                            <comment id="15892331" author="aweisberg" created="Thu, 2 Mar 2017 14:33:27 +0000"  >&lt;p&gt;I don&apos;t want to traverse the whole backlog I just thought we were so we should avoid doing it to frequently. Then I realized we don&apos;t have to traverse the entire backlog and sure enough that is what it was already doing. I prefer the version from yesterday with Jason&apos;s suggestions.&lt;/p&gt;</comment>
                            <comment id="15892332" author="cesken" created="Thu, 2 Mar 2017 14:33:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;use System.nanoTime() instead of System.currentTimeMillis().&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, &lt;tt&gt;System.nanoTime()&lt;/tt&gt; is slightly better here. In real life it won&apos;t make a terrific difference even with the worst clocks, but &quot;&lt;em&gt;lets do things right&quot;&lt;/em&gt;. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; . I never looked up the native code for nanoTIme(), but I bet on Unix it uses the POSIX &lt;tt&gt;clock_gettime(CLOCK_MONOTONIC, ...)&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t think we want to traverse the entire backlog. &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Your argument  &quot;reasonably in ascending timestamp order&quot; makes sense, if all entries would have the same expiration time. But the Verbs have different timeouts, the defaults ranging from 2 to 60 seconds. Thus iterating the whole Queue should be done, as in the worst case we will remove nothing even though most entries are timed out.&lt;/p&gt;</comment>
                            <comment id="15892350" author="aweisberg" created="Thu, 2 Mar 2017 14:49:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Your argument &quot;reasonably in ascending timestamp order&quot; makes sense, if all entries would have the same expiration time. But the Verbs have different timeouts, the defaults ranging from 2 to 60 seconds. Thus iterating the whole Queue should be done, as in the worst case we will remove nothing even though most entries are timed out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Oh you are right. That&apos;s a pretty serious bug in and of itself. That sucks!&lt;/p&gt;

&lt;p&gt;If you want to leave the trace code in it&apos;s not the end of the world just use the trace functionality in the logger? You can grab whether trace is enabled once inside the expire method. Do reduce it to a single statement that prints the timing after expiration finishes.&lt;/p&gt;</comment>
                            <comment id="15892360" author="jasobrown" created="Thu, 2 Mar 2017 14:57:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;But the Verbs have different timeouts, the defaults ranging from 2 to 60 seconds&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oh, dang! Nice find. Yeah, I guess we should traverse the &lt;tt&gt;backlog&lt;/tt&gt; in that case.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In real life it won&apos;t make a terrific difference even with the worst clocks&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Clocks go wrong all the time at scale, so timestamping must be done as correctly as possible. &lt;tt&gt;System.nanoTime()&lt;/tt&gt; does indeed call &lt;tt&gt;clock_gettime(CLOCK_MONOTONIC, ...)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15892378" author="aweisberg" created="Thu, 2 Mar 2017 15:08:48 +0000"  >&lt;p&gt;A nit that has been pointed out to me for System.nanoTime(). It can wrap so you should use &lt;tt&gt;now - lastExpirationTime &amp;gt; interval&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15892471" author="cesken" created="Thu, 2 Mar 2017 16:08:50 +0000"  >&lt;p&gt;Change to System.nanoTime() is done. I kept the logging, but stripped it down and guarded it with a &lt;tt&gt;isTraceEnabled()&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15892595" author="aweisberg" created="Thu, 2 Mar 2017 16:52:33 +0000"  >&lt;p&gt;Sorry one other nit. Instead of retrieving System.nanoTime() twice when enqueuing a message can you retrieve it once in &lt;tt&gt;enqueue&lt;/tt&gt; and then pass it as a parameter to &lt;tt&gt;QueuedMessage&lt;/tt&gt;? &lt;/p&gt;

&lt;p&gt;I think it&apos;s actually OK if it&apos;s slightly old because expiration runs for a while. In that scenario we want to be timing out messages sooner not later.&lt;/p&gt;</comment>
                            <comment id="15894000" author="cesken" created="Fri, 3 Mar 2017 09:41:17 +0000"  >&lt;p&gt;Your &quot;nit&quot; totally makes sense, as &lt;tt&gt;nanoTime()&lt;/tt&gt; is expensive if called very often. Good catch, actually I should have seen that myself. I committed the change, including the required change to RetriedQueuedMessage. I also removed two warnings by adding the generic types.&lt;/p&gt;

&lt;p&gt;As a side note, one could even use an estimated time here, like EstimatorTimeSource which works with a regularly updated cached time. I was able to boost the performance of Triava Cache by factor 2 - 10 depending on the test. An example is in &lt;a href=&quot;https://github.com/trivago/triava/blob/master/src/examples/java/com/trivago/examples/TimeSourceExample.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/trivago/triava/blob/master/src/examples/java/com/trivago/examples/TimeSourceExample.java&lt;/a&gt;, estimatorTimeSource().&lt;/p&gt;</comment>
                            <comment id="15894783" author="jasobrown" created="Fri, 3 Mar 2017 18:09:19 +0000"  >&lt;p&gt;I&apos;m +1 on the ticket, but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; should also weigh in.&lt;/p&gt;

&lt;p&gt;As a note, we have &lt;tt&gt;ApproximateTime&lt;/tt&gt; for an estimated time, but that works off of &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt; rather than &lt;tt&gt;System.nanoTime()&lt;/tt&gt;, so monotonicity.&lt;/p&gt;

&lt;p&gt;UPDATE: Actually, I&apos;d like to see a unit test implemented, like what I described earlier.&lt;/p&gt;</comment>
                            <comment id="15897121" author="cesken" created="Mon, 6 Mar 2017 11:23:07 +0000"  >&lt;p&gt;I was already looking into doing a unit test it but it requires access to the queue which means making it package level access and using &lt;tt&gt;@VisibleForTesting&lt;/tt&gt;. I will do that tomorrow, unless there are arguments against it. I will also check alternatives.&lt;/p&gt;</comment>
                            <comment id="15897641" author="cesken" created="Mon, 6 Mar 2017 16:54:41 +0000"  >&lt;p&gt;I have one question about a code fragment. When the socket is not available the backlog is cleared, but no drops are counted. Looks like an omission to me, or is it intentional? &lt;tt&gt;dropped.addAndGet(backlog.size(); )&lt;/tt&gt; would be an approximation. We likely cannot get closer as &lt;tt&gt;backlog.clear();&lt;/tt&gt; does not tell how much elements were removed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (qm.isTimedOut())
                        dropped.incrementAndGet();
                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (socket != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || connect())
                        writeConnected(qm, count == 1 &amp;amp;&amp;amp; backlog.isEmpty());
                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                    {
                        &lt;span class=&quot;code-comment&quot;&gt;// clear out the queue, &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; gossip messages back up.
&lt;/span&gt;                        drainedMessages.clear();
                        &lt;span class=&quot;code-comment&quot;&gt;// dropped.addAndGet(backlog.size()); //  TODO Should dropped statistics be counted in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;?
&lt;/span&gt;                        backlog.clear();
                        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;;
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15898249" author="aweisberg" created="Mon, 6 Mar 2017 22:13:12 +0000"  >&lt;p&gt;I think you are correct that we were supposed to mark those as dropped. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; do you agree?&lt;/p&gt;

&lt;p&gt;I think the approximate nanoTime/currenTimeMillis approach where a single thread periodically updates the time is reasonable. If you added nanoTime to ApproximateTime with it&apos;s own configuration I think it would be fine to use it in this context.&lt;/p&gt;</comment>
                            <comment id="15898266" author="jasobrown" created="Mon, 6 Mar 2017 22:22:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;we were supposed to mark those as dropped&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We probably should count them as dropped as we are dropping them, huh &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; fwiw, looks like it&apos;s always been implemented this way, since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3005&quot; title=&quot;OutboundTcpConnection&amp;#39;s sending queue grows unboundedly without any backpressure logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3005&quot;&gt;&lt;del&gt;CASSANDRA-3005&lt;/del&gt;&lt;/a&gt;. So, yes, please update the counter.&lt;/p&gt;</comment>
                            <comment id="15899773" author="cesken" created="Tue, 7 Mar 2017 17:01:10 +0000"  >&lt;p&gt;I added three changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Implemented unit test&lt;/li&gt;
	&lt;li&gt;Count dropped messages if Cassandra cannot write to the socket&lt;/li&gt;
	&lt;li&gt;Fix the QueuedMessage.isTimedOut(), which was prone to a System.nanoTime() wrap bug, as it used a check of type: aNanos &amp;lt; bNanos&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15900005" author="aweisberg" created="Tue, 7 Mar 2017 19:27:56 +0000"  >&lt;p&gt;Awesome.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This needs to be configurable from the YAML and via JMX. Add it to &lt;tt&gt;StorageProxyMBean&lt;/tt&gt;/&lt;tt&gt;StorageProxy&lt;/tt&gt;, store the value in &lt;tt&gt;Config&lt;/tt&gt; then get it from &lt;tt&gt;DatabaseDescriptor&lt;/tt&gt; it will need to be a volatile field in &lt;tt&gt;Config&lt;/tt&gt;. Add a setter and a getter. I have the setter return the previous value, but a lot of the existing ones don&apos;t. 10 seconds is also way too high as a default. I propose 200 milliseconds. It&apos;s an improvement over today, but still aggressive at trying to free memory. Also use &lt;tt&gt;java.util.concurrent.TimeUnit&lt;/tt&gt; to convert to the value you want.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;It should include drained messages as well. To be 100% correct you would have to count how many messages you have iterated over and sent and then subtract.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Typo, &quot;thus letting&quot;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Extra line break&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c16fff43d2aafe61a4219656d1ab6f9eR26&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;We don&apos;t do/allow author tags&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c16fff43d2aafe61a4219656d1ab6f9eR36&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Use TimeUnit&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c16fff43d2aafe61a4219656d1ab6f9eR118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;It isn&apos;t using the constant.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c16fff43d2aafe61a4219656d1ab6f9eR33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Just in case maybe assert the droppable/non-droppable status of the verbs. Or does it not matter since the tests will fail anyways?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I had a sad and unfortunate thought. We are going about expiring wrong by counting messages. We really want to expire based on the weight of the queue. Also I really really hate that bounded queues that aren&apos;t weighted are a thing. Let&apos;s not do that here though since I want to backport this to other versions.&lt;/p&gt;</comment>
                            <comment id="15901047" author="cesken" created="Wed, 8 Mar 2017 10:36:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;It should include drained messages as well&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;OMG, right. I thought about that, and concluded it is correct to exclude. But obviously the messages are already drained from the queue, so they must be added.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We don&apos;t do/allow author tags&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;OOPS, always this oversmart IDE &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This needs to be configurable&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Oh. Even more work. This is getting bigger than anticipated, but I am happy to do it. Thanks for the hints on how do do the Configuration. I will work on it later this day or tomorrow.&lt;/p&gt;</comment>
                            <comment id="15901414" author="cesken" created="Wed, 8 Mar 2017 15:22:12 +0000"  >&lt;p&gt;I will update the status while working on the individual topics:&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    This needs to be configurable from the YAML and via JMX. &lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    It should include drained messages as well.&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    Typo, &quot;thus letting&quot;&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    Extra line break&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    We don&apos;t do/allow author tags&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    Use TimeUnit&lt;br/&gt;
  =&amp;gt; Additionally I am now determining the timeout value automatic&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    It isn&apos;t using the constant.&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    Just in case maybe assert the droppable/non-droppable status of the verbs. Or does it not matter since the tests will fail anyways?&lt;br/&gt;
   =&amp;gt; It wouldn&apos;t matter, but I added a check make it more explicit.&lt;/p&gt;</comment>
                            <comment id="15901495" author="cesken" created="Wed, 8 Mar 2017 16:13:56 +0000"  >&lt;p&gt;I pushed the changes noted in the former comment.&lt;br/&gt;
I am plannig to do &quot;Configurabilty and default value&quot; tomorrow.&lt;/p&gt;</comment>
                            <comment id="15904949" author="cesken" created="Fri, 10 Mar 2017 11:45:27 +0000"  >&lt;p&gt;I am nearly done with the configuration, and have two questions about it:&lt;/p&gt;

&lt;p&gt;1.  How to handle the default value? My approach is to pre-configure the default value in Config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; otc_backlog_expiration_interval_in_ms_default = 200;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; otc_backlog_expiration_interval_in_ms = otc_backlog_expiration_interval_in_ms_default;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Additionally I will handle null values, that might have been set via JMX in the getter of DatabaseDescriptor:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; getOtcBacklogExpirationInterval()
    {
        &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; confValue = conf.otc_backlog_expiration_interval_in_ms;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; confValue != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? confValue : Config.otc_backlog_expiration_interval_in_ms_default;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is that OK? Should I also handle other illegal values in that getter (negative values), or reject them in the setter?  I have not found a  code example in Cassandra that handles bad values uniformly for MBean and Config.&lt;/p&gt;

&lt;p&gt;2. How to read the config value? I am seeing some &lt;tt&gt;Integer.getInteger(propName, defaultValue)&lt;/tt&gt;, but this looks strange to me. I think changes from JMX would not even be reflected. Thus I am calling the getter from above: &lt;tt&gt;DatabaseDescriptor.getOtcBacklogExpirationInterval()&lt;/tt&gt;. Is the latter OK?&lt;/p&gt;</comment>
                            <comment id="15905409" author="cesken" created="Fri, 10 Mar 2017 17:05:25 +0000"  >&lt;p&gt;I committed the change containing the configuration, as I would like some feedback whether I am on the right path. Please note that I did not yet have time for tests (planned for next Monday), but I thought it is better to give a chance to review the current changes.&lt;/p&gt;

&lt;p&gt;I also had to add back &quot;AtomicBoolean backlogExpirationActive&quot; Otherwise I cannot guarantee that only a single Thread is iterating the Queue, especially if a small expiration interval (1ms, or 0ms) is configured. The &quot;AtomicLong backlogNextExpirationTime&quot; could now be &quot;volatile long&quot;.&lt;/p&gt;</comment>
                            <comment id="15907493" author="cesken" created="Mon, 13 Mar 2017 13:56:06 +0000"  >&lt;p&gt;The change is now finished, including configuration, MBean and testing. I also tested an interval of 0 ms, which is close to what Cassandra does today.&lt;/p&gt;

&lt;p&gt;Please have  a look. What is the recommended way of getting this into the official Cassandra repo?  A patch, or would someone with write access take it directly from Github? This also has impact on how the merge conflicts will be resolved, as there are now 3 files with merge conflicts according to &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;. I did not want to rebase my branch without asking.&lt;/p&gt;</comment>
                            <comment id="15908545" author="aweisberg" created="Mon, 13 Mar 2017 17:44:40 +0000"  >&lt;p&gt;The right way to do it is create a branch for all the versions where this is going to be fixed. Start at 2.2, merge to 3.0, merge to 3.11, then merge to trunk. &lt;/p&gt;

&lt;p&gt;You can get away with one field. Check the next expiration time, CAS it to &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt;, then when you are done store the next expiration time in it. Doing it with two fields also works. I wouldn&apos;t bother changing it.&lt;/p&gt;

&lt;p&gt;If you set the default value via a property it will work fine. It will set it once when it loads the class at startup and then overwrite it with YAML contents or JMX invocations. Generally we do set the default value in config via assignment. Doing it via property gives yet another way to set the value, but it&apos;s the least important. It&apos;s more useful for things which aren&apos;t in the YAML. Adding YAML properties adds a bit of boiler plate.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-bdaab1104a93e723ce0b609a6477c9c4R992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;A smaller value could potentially expire messages slightly sooner at the expense of more CPU time and queue contention while iterating the backlog of messages.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-a8a9935b164cd23da473fd45784fd1ddR1973&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;You shouldn&apos;t need the check for null? Usually we &quot;just&quot; make sure its not null and skip the boilerplate.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-a8a9935b164cd23da473fd45784fd1ddL2034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Avoid unrelated whitespace changes.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;I still think it&apos;s a good idea to avoid hard coding this kind of value so operators have options without recompiling.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Fun fact. You don&apos;t need &lt;tt&gt;backlogNextExpirationTime&lt;/tt&gt; to be volatile. You can piggyback on &lt;tt&gt;backlogExpirationActive&lt;/tt&gt; to get the desired effects from the Java memory model. A store to &lt;tt&gt;backlogExpirationActive&lt;/tt&gt; makes a prior stores (by the current thread) to &lt;tt&gt;backlogNextExpirationTime&lt;/tt&gt; visible. A read of &lt;tt&gt;backlogExpirationActive&lt;/tt&gt; would make prior stores to &lt;tt&gt;backlogNextExpirationTimeVisible&lt;/tt&gt; by the last writer to &lt;tt&gt;backlogExpirationActive&lt;/tt&gt; visible. The volatile read is close to free so I wouldn&apos;t change it just so it&apos;s not sensitive to the order the fields are accessed in.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R600&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Breaking out the uber bike shedding this could be maybeExpireMessages.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R636&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Swap the order of these two stores so it doesn&apos;t do extra expirations.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-097eb77c5d9d80a48e7547fbb81822caR62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Using a boxed integer makes it a bit confusing because now everyone has to know how null is handled. What&apos;s the diff between null and 0? Better to let 0 be disabled and not have null.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This is not quite correct you can&apos;t count drainCount as dropped because some of the drained messages may have been sent during iteration.&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15923915" author="cesken" created="Tue, 14 Mar 2017 10:05:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is not quite correct you can&apos;t count drainCount as dropped because some of the drained messages may have been sent during iteration.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I looked in more detail, and I think this a flaw in the original code &quot;suggested&quot; me to do this:  &lt;tt&gt;drainedMessages.clear()&lt;/tt&gt; is called twice, and one time would be enough. IMO it would be better to only keep the one at the end of the method and also do the drop-counting for the drained messages there. This would also cover a rather exotic case of the &lt;tt&gt;catch (Exception e)&lt;/tt&gt; in the &lt;tt&gt;run()&lt;/tt&gt; method. If an Exception is thrown, then there is a danger of nothing being counted.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Using a boxed integer&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;You shouldn&apos;t need the check for null?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;From a brief check, this refers to a similar point. I saw many configuration options to allow null and followed that route. I am absolutely happy to make it non-boxed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The right way to do it is create a branch for all the versions where this is going to be fixed. Start at 2.2, merge to 3.0, merge to 3.11, then merge to trunk. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;At Github? I can do so. But no PR, right? I saw it mentioned that one should not open PR&apos;s for Cassandra on Github as they cannot be handled (it&apos;s just a mirror).&lt;/p&gt;</comment>
                            <comment id="15924135" author="cesken" created="Tue, 14 Mar 2017 13:05:29 +0000"  >&lt;p&gt;Done. Hint: Not everything is committed yet, as I have to remove my debug code from it.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; A smaller value could potentially ...&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  You shouldn&apos;t need the check for null? Usually we &quot;just&quot; make sure its not null&lt;br/&gt;
    OK.  I thought it might be possible to set this to null, but even JConsole refuses it.&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Using a boxed integer makes it a bit confusing ...&lt;br/&gt;
  ACK. Happily changed that. Looks like I followed bad examples.&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Avoid unrelated whitespace changes.&lt;br/&gt;
  OK. I missed that after moving the field.&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  I still think it&apos;s a good idea to avoid hard coding this kind of value so operators have options without recompiling.&lt;br/&gt;
 I would like BACKLOG_PURGE_SIZE to be kept hard coded for now. It has been there for quite some time hard coded, and in the long term I do not think it should be kept as-is. For example it would better to purge on the number of actually DROPPABLE messages in the queue (or their weight if you want to extend even further)&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Fun fact. You don&apos;t need backlogNextExpirationTime to be volatile. You can piggyback on backlogExpirationActive to get the desired effects from the Java memory model. &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; I wouldn&apos;t change it ...&lt;br/&gt;
Yes.  I am  aware of that and using that technique often. Here I did not like it as visibility effects would not be obvious, unless explicitly documented. You are probably aware what Brian Goetz says about piggybacking in his JCIP book. BTW: A more obvious usage is for me in status fields, e.g. to make the results of a Future visible. I won&apos;t change it either, so marking this as done.&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    Breaking out the uber bike shedding this could be maybeExpireMessages.&lt;br/&gt;
Nope, I am not going back that road. I had expireMessagesConditionally() before and changed it on request. If we do this, then a Set should not have an add() method but only a maybeAdd(), because it might not add the entry. Also I added clear documentation, so it should be fine. &lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;    Swap the order of these two stores so it doesn&apos;t do extra expirations.&lt;br/&gt;
  Ouch. That hurts. I wanted to protect from Exceptions inside the throw-Block which would disable expiration infinitely. I was quite tired yesterday. I am swapping it back, TimeUnit conversions never throw Exceptions, so it is safe. :-|&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  This is not quite correct you can&apos;t count drainCount as dropped because some of the drained messages may have been sent during iteration.&lt;br/&gt;
  In progress. I am wondering if we should include fixing the drop count it in this patch, as it will likely create even more conflicts. OTOH I have to touch some related methods anyhow. I will think about it.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15924658" author="aweisberg" created="Tue, 14 Mar 2017 17:40:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would like BACKLOG_PURGE_SIZE to be kept hard coded for now. It has been there for quite some time hard coded, and in the long term I do not think it should be kept as-is. For example it would better to purge on the number of actually DROPPABLE messages in the queue (or their weight if you want to extend even further)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree but I don&apos;t want to add more to this change set and I want to backport it to at least 2.2. I suggest it primarily because it&apos;s very low effort to add a property as opposed to a full YAML + JMX config option.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At Github? I can do so. But no PR, right? I saw it mentioned that one should not open PR&apos;s for Cassandra on Github as they cannot be handled (it&apos;s just a mirror).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Project policy is to not use PRs even for comments. Code review comments go in JIRA. What I and some others do is link to a compare view of what we intend to merge. Don&apos;t delete the branches your links point to because it invalidates the information in JIRA.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I looked in more detail, and I think this a flaw in the original code &quot;suggested&quot; me to do this: drainedMessages.clear() is called twice, and one time would be enough. IMO it would be better to only keep the one at the end of the method and also do the drop-counting for the drained messages there. This would also cover a rather exotic case of the catch (Exception e) in the run() method. If an Exception is thrown, then there is a danger of nothing being counted.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So there is the issue of not counting drops as they happen. The thread can block for a long time writing messages so if we wait to count drops they won&apos;t show up quite as promptly. Not a huge deal, but I think we should log the drops especially due to timeouts as they happen rather than at the end. It&apos;s definitely true that we don&apos;t need to clear the backlog twice and we could log the drops due to items remaining in the backlog there. The loop decrements a counter every time it runs so you know how many remaining elements are being dropped if you hit break inner.&lt;/p&gt;</comment>
                            <comment id="15925815" author="cesken" created="Wed, 15 Mar 2017 09:49:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s very low effort to add a property&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I see. I thought it would just clutter the cassanda.yaml, as nobody ever would change the value. But if you feel it is important enough, I can do so.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Not a huge deal, but I think we should log the drops especially due to timeouts as they happen&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;OK. I can follow your argument. I will rewrite it, also adding comments with explanation. &lt;/p&gt;

&lt;p&gt;PS: I will be soon on vacation for two weeks, so please don&apos;t wonder why you do not see any updates from me.&lt;/p&gt;</comment>
                            <comment id="15926015" author="aweisberg" created="Wed, 15 Mar 2017 12:05:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;I see. I thought it would just clutter the cassanda.yaml, as nobody ever would change the value. But if you feel it is important enough, I can do so.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So not a property in the YAML. A java property. So something like &quot;Integer.getInteger(&quot;property&quot;, 1024);&quot; instead of just &quot;1024&quot;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;PS: I will be soon on vacation for two weeks, so please don&apos;t wonder why you do not see any updates from me.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Enjoy&lt;/p&gt;</comment>
                            <comment id="15926348" author="cesken" created="Wed, 15 Mar 2017 15:20:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;I still think it&apos;s a good idea to avoid hard coding this kind of value so operators have options without recompiling. &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; A java property. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; static final int BACKLOG_PURGE_SIZE = Integer.getInteger(&quot;OTC_BACKLOG_PURGE_SIZE&quot;, 1024);&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think we should log the drops especially due to timeouts as they happen rather than at the end.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I agree, and I did not change that. After the loop I simply add the unprocessed messages, which happen due to &lt;tt&gt;break inner;&lt;/tt&gt;. I&apos;ll push today, so you have a chance to see that. &lt;/p&gt;</comment>
                            <comment id="15928300" author="aweisberg" created="Thu, 16 Mar 2017 15:44:01 +0000"  >&lt;p&gt;Great! Almost there.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-c7ef124561c4cde1c906f28ad3883a88R139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Use Config.PROPERTY_PREFIX with the property name.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-71f06c193f5b5e270cf8ac695164f43aR2685&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Still using big I integer here.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/95/files#diff-097eb77c5d9d80a48e7547fbb81822caR62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;And here.&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After that the last step is to create 2.2, 3.0, and 3.11 branches. Then I&apos;ll run the tests for each of the branches and if they look good I&apos;ll commit.&lt;/p&gt;</comment>
                            <comment id="15963095" author="cesken" created="Mon, 10 Apr 2017 16:13:22 +0000"  >&lt;p&gt;Done. My highest priority is the 3.0 branch. I created a patch (single file, squashed) for 3.0, that I also applied to my Github fork &lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-3.0&lt;/a&gt; . I attached the patch using the Submit Patch button on the top.&lt;/p&gt;</comment>
                            <comment id="15963102" author="cesken" created="Mon, 10 Apr 2017 16:17:36 +0000"  >&lt;p&gt;From 6bd3f3fc3b2da3a66b53a94a819446a9ea8ea2cf Mon Sep 17 00:00:00 2001&lt;br/&gt;
From: Christian Esken &amp;lt;Christian.Esken@trivago.com&amp;gt;&lt;br/&gt;
Date: Wed, 1 Mar 2017 15:56:36 +0100&lt;br/&gt;
Subject: &lt;span class=&quot;error&quot;&gt;&amp;#91;PATCH&amp;#93;&lt;/span&gt; Expire OTC messages by a single Thread&lt;/p&gt;

&lt;p&gt;This patch consists of the following aspects related to OutboundTcpConnection:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Backlog queue expiration by a single Thread&lt;/li&gt;
	&lt;li&gt;Drop count statistics&lt;/li&gt;
	&lt;li&gt;QueuedMessage.isTimedOut() fix&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When backlog queue expiration is done, one single Thread is elected to do the&lt;br/&gt;
work. Previously, all Threads would go in and do the same work,&lt;br/&gt;
producing high lock contention. The Thread reading from the Queue could&lt;br/&gt;
even be starved by not be able to acquire the read lock.&lt;br/&gt;
Backlog queue is inspected every otc_backlog_expiration_interval_ms&lt;br/&gt;
milliseconds if its size exceeds BACKLOG_PURGE_SIZE. Added unit tests&lt;br/&gt;
for OutboundTcpConnection.&lt;/p&gt;

&lt;p&gt;Timed out messages are counted in the dropped statistics. Additionally&lt;br/&gt;
count the dropped messages when it is not possible to write to the&lt;br/&gt;
socket, e.g. if there is no connection because a target node is down.&lt;/p&gt;

&lt;p&gt;Fix QueuedMessage.isTimedOut(), which had used a &quot;a &amp;lt; b&quot; comparison on&lt;br/&gt;
nano time values, which can be wrong due to wrapping of System.nanoTime().&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13265&quot; title=&quot;Expiration in OutboundTcpConnection can block the reader Thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13265&quot;&gt;&lt;del&gt;CASSANDRA-13265&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
 conf/cassandra.yaml                                |   9 ++&lt;br/&gt;
 src/java/org/apache/cassandra/config/Config.java   |   6 +&lt;br/&gt;
 .../cassandra/config/DatabaseDescriptor.java       |  10 ++&lt;br/&gt;
 .../cassandra/net/OutboundTcpConnection.java       | 113 +++++++++++---&lt;br/&gt;
 .../org/apache/cassandra/service/StorageProxy.java |  10 +-&lt;br/&gt;
 .../cassandra/service/StorageProxyMBean.java       |   3 +&lt;br/&gt;
 .../cassandra/net/OutboundTcpConnectionTest.java   | 170 +++++++++++++++++++++&lt;br/&gt;
 7 files changed, 294 insertions&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/add.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, 27 deletions&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/forbidden.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
 create mode 100644 test/unit/org/apache/cassandra/net/OutboundTcpConnectionTest.java&lt;/p&gt;

&lt;p&gt;diff --git a/conf/cassandra.yaml b/conf/cassandra.yaml&lt;br/&gt;
index 790dfd743b..9c1510b66a 100644&lt;br/&gt;
&amp;#8212; a/conf/cassandra.yaml&lt;br/&gt;
+++ b/conf/cassandra.yaml&lt;br/&gt;
@@ -985,3 +985,12 @@ windows_timer_interval: 1&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Do not try to coalesce messages if we already got that many messages. This should be more than 2 and less than 128.&lt;/li&gt;
	&lt;li&gt;otc_coalescing_enough_coalesced_messages: 8&lt;br/&gt;
+&lt;br/&gt;
+# How many milliseconds to wait between two expiration runs on the backlog (queue) of the OutboundTcpConnection.&lt;br/&gt;
+# Expiration is done if messages are piling up in the backlog. Droppable messages are expired to free the memory&lt;br/&gt;
+# taken by expired messages. The interval should be between 0 and 1000, and in most installations the default value&lt;br/&gt;
+# will be appropriate. A smaller value could potentially expire messages slightly sooner at the expense of more CPU&lt;br/&gt;
+# time and queue contention while iterating the backlog of messages.&lt;br/&gt;
+# An interval of 0 disables any wait time, which is the behavior of former Cassandra versions.&lt;br/&gt;
+#&lt;br/&gt;
+# otc_backlog_expiration_interval_ms: 200&lt;br/&gt;
diff --git a/src/java/org/apache/cassandra/config/Config.java b/src/java/org/apache/cassandra/config/Config.java&lt;br/&gt;
index 9aaf7ae33e..6a99cd3cbd 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/src/java/org/apache/cassandra/config/Config.java&lt;br/&gt;
+++ b/src/java/org/apache/cassandra/config/Config.java&lt;br/&gt;
@@ -298,6 +298,12 @@ public class Config&lt;br/&gt;
     public int otc_coalescing_window_us = otc_coalescing_window_us_default;&lt;br/&gt;
     public int otc_coalescing_enough_coalesced_messages = 8;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * Backlog expiration interval in milliseconds for the OutboundTcpConnection.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static final int otc_backlog_expiration_interval_ms_default = 200;&lt;br/&gt;
+    public volatile int otc_backlog_expiration_interval_ms = otc_backlog_expiration_interval_ms_default;&lt;br/&gt;
+ &lt;br/&gt;
     public int windows_timer_interval = 0;&lt;/p&gt;

&lt;p&gt;     public boolean enable_user_defined_functions = false;&lt;br/&gt;
diff --git a/src/java/org/apache/cassandra/config/DatabaseDescriptor.java b/src/java/org/apache/cassandra/config/DatabaseDescriptor.java&lt;br/&gt;
index 602214f3c6..e9e54c3e20 100644&lt;br/&gt;
&amp;#8212; a/src/java/org/apache/cassandra/config/DatabaseDescriptor.java&lt;br/&gt;
+++ b/src/java/org/apache/cassandra/config/DatabaseDescriptor.java&lt;br/&gt;
@@ -1967,6 +1967,16 @@ public class DatabaseDescriptor&lt;br/&gt;
         conf.otc_coalescing_enough_coalesced_messages = otc_coalescing_enough_coalesced_messages;&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    public static int getOtcBacklogExpirationInterval()&lt;br/&gt;
+    &lt;/p&gt;
{
+        return conf.otc_backlog_expiration_interval_ms;
+    }
&lt;p&gt;+&lt;br/&gt;
+    public static void setOtcBacklogExpirationInterval(int intervalInMillis)&lt;br/&gt;
+    &lt;/p&gt;
{
+        conf.otc_backlog_expiration_interval_ms = intervalInMillis;
+    }
&lt;p&gt;+ &lt;br/&gt;
     public static int getWindowsTimerInterval()&lt;br/&gt;
     {&lt;br/&gt;
         return conf.windows_timer_interval;&lt;br/&gt;
diff --git a/src/java/org/apache/cassandra/net/OutboundTcpConnection.java b/src/java/org/apache/cassandra/net/OutboundTcpConnection.java&lt;br/&gt;
index 46083994df..99ad194b94 100644&lt;br/&gt;
&amp;#8212; a/src/java/org/apache/cassandra/net/OutboundTcpConnection.java&lt;br/&gt;
+++ b/src/java/org/apache/cassandra/net/OutboundTcpConnection.java&lt;br/&gt;
@@ -31,6 +31,7 @@ import java.util.concurrent.BlockingQueue;&lt;br/&gt;
 import java.util.concurrent.CountDownLatch;&lt;br/&gt;
 import java.util.concurrent.LinkedBlockingQueue;&lt;br/&gt;
 import java.util.concurrent.TimeUnit;&lt;br/&gt;
+import java.util.concurrent.atomic.AtomicBoolean;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicInteger;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicLong;&lt;br/&gt;
 import java.util.zip.Checksum;&lt;br/&gt;
@@ -62,6 +63,7 @@ import org.xerial.snappy.SnappyOutputStream;&lt;br/&gt;
 import org.apache.cassandra.config.Config;&lt;br/&gt;
 import org.apache.cassandra.config.DatabaseDescriptor;&lt;/p&gt;

&lt;p&gt;+import com.google.common.annotations.VisibleForTesting;&lt;br/&gt;
 import com.google.common.util.concurrent.Uninterruptibles;&lt;/p&gt;

&lt;p&gt; public class OutboundTcpConnection extends Thread&lt;br/&gt;
@@ -116,9 +118,14 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
         if (coalescingWindow &amp;lt; 0)&lt;br/&gt;
             throw new ExceptionInInitializerError(&lt;br/&gt;
                     &quot;Value provided for coalescing window must be greather than 0: &quot; + coalescingWindow);&lt;br/&gt;
+&lt;br/&gt;
+        int otc_backlog_expiration_interval_in_ms = DatabaseDescriptor.getOtcBacklogExpirationInterval();&lt;br/&gt;
+        if (otc_backlog_expiration_interval_in_ms != Config.otc_backlog_expiration_interval_ms_default)&lt;br/&gt;
+            logger.info(&quot;OutboundTcpConnection backlog expiration interval set to to {}ms&quot;, otc_backlog_expiration_interval_in_ms);&lt;br/&gt;
+&lt;br/&gt;
     }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final MessageOut CLOSE_SENTINEL = new MessageOut(MessagingService.Verb.INTERNAL_RESPONSE);&lt;br/&gt;
+    private static final MessageOut&amp;lt;?&amp;gt; CLOSE_SENTINEL = new MessageOut&amp;lt;MessagingService.Verb&amp;gt;(MessagingService.Verb.INTERNAL_RESPONSE);&lt;br/&gt;
     private volatile boolean isStopped = false;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private static final int OPEN_RETRY_DELAY = 100; // ms between retries&lt;br/&gt;
@@ -128,6 +135,11 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
     static final int LZ4_HASH_SEED = 0x9747b28c;&lt;/p&gt;

&lt;p&gt;     private final BlockingQueue&amp;lt;QueuedMessage&amp;gt; backlog = new LinkedBlockingQueue&amp;lt;&amp;gt;();&lt;br/&gt;
+    private static final String BACKLOG_PURGE_SIZE_PROPERTY = PREFIX + &quot;otc_backlog_purge_size&quot;;&lt;br/&gt;
+    @VisibleForTesting&lt;br/&gt;
+    static final int BACKLOG_PURGE_SIZE = Integer.getInteger(BACKLOG_PURGE_SIZE_PROPERTY, 1024);&lt;br/&gt;
+    private final AtomicBoolean backlogExpirationActive = new AtomicBoolean(false);&lt;br/&gt;
+    private volatile long backlogNextExpirationTime;&lt;/p&gt;

&lt;p&gt;     private final OutboundTcpConnectionPool poolReference;&lt;/p&gt;

&lt;p&gt;@@ -164,11 +176,11 @@ public class OutboundTcpConnection extends Thread&lt;/p&gt;

&lt;p&gt;     public void enqueue(MessageOut&amp;lt;?&amp;gt; message, int id)&lt;br/&gt;
     {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (backlog.size() &amp;gt; 1024)&lt;/li&gt;
	&lt;li&gt;expireMessages();&lt;br/&gt;
+        long nanoTime = System.nanoTime();&lt;br/&gt;
+        expireMessages(nanoTime);&lt;br/&gt;
         try
         {
-            backlog.put(new QueuedMessage(message, id));
+            backlog.put(new QueuedMessage(message, id, nanoTime));
         }
&lt;p&gt;         catch (InterruptedException e)&lt;/p&gt;
         {
@@ -176,6 +188,18 @@ public class OutboundTcpConnection extends Thread
         }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * This is a helper method for unit testing. Disclaimer: Do not use this method outside unit tests, as&lt;br/&gt;
+     * this method is iterating the queue which can be an expensive operation (CPU time, queue locking).&lt;br/&gt;
+     * &lt;br/&gt;
+     * @return true, if the queue contains at least one expired element&lt;br/&gt;
+     */&lt;br/&gt;
+    @VisibleForTesting // (otherwise = VisibleForTesting.NONE)&lt;br/&gt;
+    boolean backlogContainsExpiredMessages(long nowNanos)&lt;br/&gt;
+    &lt;/p&gt;
{
+        return backlog.stream().anyMatch(entry -&amp;gt; entry.isTimedOut(nowNanos));
+    }
&lt;p&gt;+&lt;br/&gt;
     void closeSocket(boolean destroyThread)&lt;/p&gt;
     {
         isStopped = destroyThread; // Exit loop to stop the thread
@@ -214,9 +238,8 @@ public class OutboundTcpConnection extends Thread
                 throw new AssertionError(e);
             }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;currentMsgBufferCount = drainedMessages.size();&lt;br/&gt;
+            int count = currentMsgBufferCount = drainedMessages.size();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int count = drainedMessages.size();&lt;br/&gt;
             //The timestamp of the first message has already been provided to the coalescing strategy&lt;br/&gt;
             //so skip logging it.&lt;br/&gt;
             inner:&lt;br/&gt;
@@ -233,14 +256,16 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
                         continue;&lt;br/&gt;
                     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (qm.isTimedOut())&lt;br/&gt;
+                    if (qm.isTimedOut(System.nanoTime()))&lt;br/&gt;
                         dropped.incrementAndGet();&lt;br/&gt;
                     else if (socket != null || connect())&lt;br/&gt;
                         writeConnected(qm, count == 1 &amp;amp;&amp;amp; backlog.isEmpty());&lt;br/&gt;
                     else
                     {
-                        // clear out the queue, else gossip messages back up.
-                        drainedMessages.clear();
+                        // Not connected! Clear out the queue, else gossip messages back up. Update dropped
+                        // statistics accordingly. Hint: The statistics may be slightly too low, if messages
+                        // are added between the calls of backlog.size() and backlog.clear()
+                        dropped.addAndGet(backlog.size());
                         backlog.clear();
                         break inner;
                     }
&lt;p&gt;@@ -254,6 +279,8 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
                 }&lt;br/&gt;
                 currentMsgBufferCount = --count;&lt;br/&gt;
             }&lt;br/&gt;
+            // Update dropped statistics by the number of unprocessed drainedMessages&lt;br/&gt;
+            dropped.addAndGet(currentMsgBufferCount);&lt;br/&gt;
             drainedMessages.clear();&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -343,7 +370,7 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeInternal(MessageOut message, int id, long timestamp) throws IOException&lt;br/&gt;
+    private void writeInternal(MessageOut&amp;lt;?&amp;gt; message, int id, long timestamp) throws IOException
     {
         out.writeInt(MessagingService.PROTOCOL_MAGIC);
 
@@ -563,18 +590,53 @@ public class OutboundTcpConnection extends Thread
         return version.get();
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void expireMessages()&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Expire elements from the queue if the queue is pretty full and expiration is not already in progress.&lt;br/&gt;
+     * This method will only remove droppable expired entries. If no such element exists, nothing is removed from the queue.&lt;br/&gt;
+     * &lt;br/&gt;
+     * @param timestampNanos The current time as from System.nanoTime()&lt;br/&gt;
+     */&lt;br/&gt;
+    @VisibleForTesting&lt;br/&gt;
+    void expireMessages(long timestampNanos)&lt;br/&gt;
     {&lt;/li&gt;
	&lt;li&gt;Iterator&amp;lt;QueuedMessage&amp;gt; iter = backlog.iterator();&lt;/li&gt;
	&lt;li&gt;while (iter.hasNext())&lt;br/&gt;
+        if (backlog.size() &amp;lt;= BACKLOG_PURGE_SIZE)&lt;br/&gt;
+            return; // Plenty of space&lt;br/&gt;
+&lt;br/&gt;
+        if (backlogNextExpirationTime - timestampNanos &amp;gt; 0)&lt;br/&gt;
+            return; // Expiration is not due.&lt;br/&gt;
+&lt;br/&gt;
+        /**&lt;br/&gt;
+         * Expiration is an expensive process. Iterating the queue locks the queue for both writes and&lt;br/&gt;
+         * reads during iter.next() and iter.remove(). Thus letting only a single Thread do expiration.&lt;br/&gt;
+         */&lt;br/&gt;
+        if (backlogExpirationActive.compareAndSet(false, true))&lt;br/&gt;
         {&lt;/li&gt;
	&lt;li&gt;QueuedMessage qm = iter.next();&lt;/li&gt;
	&lt;li&gt;if (!qm.droppable)&lt;/li&gt;
	&lt;li&gt;continue;&lt;/li&gt;
	&lt;li&gt;if (!qm.isTimedOut())&lt;/li&gt;
	&lt;li&gt;return;&lt;/li&gt;
	&lt;li&gt;iter.remove();&lt;/li&gt;
	&lt;li&gt;dropped.incrementAndGet();&lt;br/&gt;
+            try&lt;br/&gt;
+            {&lt;br/&gt;
+                Iterator&amp;lt;QueuedMessage&amp;gt; iter = backlog.iterator();&lt;br/&gt;
+                while (iter.hasNext())&lt;br/&gt;
+                
{
+                    QueuedMessage qm = iter.next();
+                    if (!qm.droppable)
+                        continue;
+                    if (!qm.isTimedOut(timestampNanos))
+                        continue;
+                    iter.remove();
+                    dropped.incrementAndGet();
+                }
&lt;p&gt;+&lt;br/&gt;
+                if (logger.isTraceEnabled())&lt;br/&gt;
+                {&lt;br/&gt;
+                    long duration = TimeUnit.NANOSECONDS.toMicros(System.nanoTime() - timestampNanos);&lt;br/&gt;
+                    logger.trace(&quot;Expiration of {} took {}&#956;s&quot;, getName(), duration);&lt;br/&gt;
+                }&lt;br/&gt;
+            }&lt;br/&gt;
+            finally&lt;br/&gt;
+            &lt;/p&gt;
{
+                long backlogExpirationIntervalNanos = TimeUnit.MILLISECONDS.toNanos(DatabaseDescriptor.getOtcBacklogExpirationInterval());
+                backlogNextExpirationTime = timestampNanos + backlogExpirationIntervalNanos;
+                backlogExpirationActive.set(false);
+            }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -586,18 +648,19 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
         final long timestampNanos;&lt;br/&gt;
         final boolean droppable;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;QueuedMessage(MessageOut&amp;lt;?&amp;gt; message, int id)&lt;br/&gt;
+        QueuedMessage(MessageOut&amp;lt;?&amp;gt; message, int id, long timestampNanos)
         {
             this.message = message;
             this.id = id;
-            this.timestampNanos = System.nanoTime();
+            this.timestampNanos = timestampNanos;
             this.droppable = MessagingService.DROPPABLE_VERBS.contains(message.verb);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         /** don&apos;t drop a non-droppable message just because it&apos;s timestamp is expired */&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;boolean isTimedOut()&lt;br/&gt;
+        boolean isTimedOut(long nowNanos)
         {
-            return droppable &amp;amp;&amp;amp; timestampNanos &amp;lt; System.nanoTime() - TimeUnit.MILLISECONDS.toNanos(message.getTimeout());
+            long messageTimeoutNanos = TimeUnit.MILLISECONDS.toNanos(message.getTimeout());
+            return droppable &amp;amp;&amp;amp; nowNanos - timestampNanos  &amp;gt; messageTimeoutNanos;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         boolean shouldRetry()&lt;br/&gt;
@@ -615,7 +678,7 @@ public class OutboundTcpConnection extends Thread&lt;br/&gt;
     {&lt;br/&gt;
         RetriedQueuedMessage(QueuedMessage msg)&lt;/p&gt;
         {
-            super(msg.message, msg.id);
+            super(msg.message, msg.id, msg.timestampNanos);
         }

&lt;p&gt;         boolean shouldRetry()&lt;br/&gt;
diff --git a/src/java/org/apache/cassandra/service/StorageProxy.java b/src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
index cffd63cd8d..ea082d5f20 100644&lt;br/&gt;
&amp;#8212; a/src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
+++ b/src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
@@ -72,8 +72,6 @@ import org.apache.cassandra.triggers.TriggerExecutor;&lt;br/&gt;
 import org.apache.cassandra.utils.*;&lt;br/&gt;
 import org.apache.cassandra.utils.AbstractIterator;&lt;/p&gt;

&lt;p&gt;-import static com.google.common.collect.Iterables.contains;&lt;br/&gt;
-&lt;br/&gt;
 public class StorageProxy implements StorageProxyMBean&lt;br/&gt;
 {&lt;br/&gt;
     public static final String MBEAN_NAME = &quot;org.apache.cassandra.db:type=StorageProxy&quot;;&lt;br/&gt;
@@ -2683,4 +2681,12 @@ public class StorageProxy implements StorageProxyMBean&lt;br/&gt;
     public long getReadRepairRepairedBackground() &lt;/p&gt;
{
         return ReadRepairMetrics.repairedBackground.getCount();
     }
&lt;p&gt;+&lt;br/&gt;
+    public int getOtcBacklogExpirationInterval() &lt;/p&gt;
{
+        return DatabaseDescriptor.getOtcBacklogExpirationInterval();
+    }
&lt;p&gt;+&lt;br/&gt;
+    public void setOtcBacklogExpirationInterval(int intervalInMillis) &lt;/p&gt;
{
+        DatabaseDescriptor.setOtcBacklogExpirationInterval(intervalInMillis);
+    }
&lt;p&gt; }&lt;br/&gt;
diff --git a/src/java/org/apache/cassandra/service/StorageProxyMBean.java b/src/java/org/apache/cassandra/service/StorageProxyMBean.java&lt;br/&gt;
index 0db0ca60ff..ee82a5b1dd 100644&lt;br/&gt;
&amp;#8212; a/src/java/org/apache/cassandra/service/StorageProxyMBean.java&lt;br/&gt;
+++ b/src/java/org/apache/cassandra/service/StorageProxyMBean.java&lt;br/&gt;
@@ -59,6 +59,9 @@ public interface StorageProxyMBean&lt;br/&gt;
     public long getReadRepairRepairedBlocking();&lt;br/&gt;
     public long getReadRepairRepairedBackground();&lt;/p&gt;

&lt;p&gt;+    public int getOtcBacklogExpirationInterval();&lt;br/&gt;
+    public void setOtcBacklogExpirationInterval(int intervalInMillis);&lt;br/&gt;
+&lt;br/&gt;
     /** Returns each live node&apos;s schema version */&lt;br/&gt;
     public Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt; getSchemaVersions();&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/test/unit/org/apache/cassandra/net/OutboundTcpConnectionTest.java b/test/unit/org/apache/cassandra/net/OutboundTcpConnectionTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 0000000000..c09ae0f07e&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/test/unit/org/apache/cassandra/net/OutboundTcpConnectionTest.java&lt;br/&gt;
@@ -0,0 +1,170 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.cassandra.net;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.cassandra.config.DatabaseDescriptor;&lt;br/&gt;
+import org.apache.cassandra.net.MessagingService.Verb;&lt;br/&gt;
+import org.junit.BeforeClass;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+import static org.junit.Assert.assertFalse;&lt;br/&gt;
+import static org.junit.Assert.assertTrue;&lt;br/&gt;
+&lt;br/&gt;
+import java.net.InetAddress;&lt;br/&gt;
+import java.net.UnknownHostException;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
+import java.util.concurrent.atomic.AtomicInteger;&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * The tests check whether Queue expiration in the OutboundTcpConnection behaves properly for droppable and&lt;br/&gt;
+ * non-droppable messages.&lt;br/&gt;
+ */&lt;br/&gt;
+public class OutboundTcpConnectionTest&lt;br/&gt;
+{&lt;br/&gt;
+    AtomicInteger messageId = new AtomicInteger(0);&lt;br/&gt;
+&lt;br/&gt;
+    final static Verb VERB_DROPPABLE = Verb.MUTATION; // Droppable, 2s timeout&lt;br/&gt;
+    final static Verb VERB_NONDROPPABLE = Verb.GOSSIP_DIGEST_ACK; // Not droppable&lt;br/&gt;
+&lt;br/&gt;
+    final static long NANOS_FOR_TIMEOUT = TimeUnit.MILLISECONDS.toNanos(DatabaseDescriptor.getTimeout(VERB_DROPPABLE)*2);&lt;br/&gt;
+&lt;br/&gt;
+    &lt;br/&gt;
+    /**&lt;br/&gt;
+     * Verifies our assumptions whether a Verb can be dropped or not. The tests make use of droppabilty, and&lt;br/&gt;
+     * may produce wrong test results if their droppabilty is changed. &lt;br/&gt;
+     */&lt;br/&gt;
+    @BeforeClass&lt;br/&gt;
+    public static void assertDroppability()&lt;br/&gt;
+    &lt;/p&gt;
{
+        if (!MessagingService.DROPPABLE_VERBS.contains(VERB_DROPPABLE))
+            throw new AssertionError(&quot;Expected &quot; + VERB_DROPPABLE + &quot; to be droppable&quot;);
+        if (MessagingService.DROPPABLE_VERBS.contains(VERB_NONDROPPABLE))
+            throw new AssertionError(&quot;Expected &quot; + VERB_NONDROPPABLE + &quot; not to be droppable&quot;);
+    }
&lt;p&gt;+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Tests that non-droppable messages are never expired&lt;br/&gt;
+     */&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testNondroppable() throws UnknownHostException&lt;br/&gt;
+    &lt;/p&gt;
{
+        OutboundTcpConnection otc = getOutboundTcpConnectionForLocalhost();
+        long nanoTimeBeforeEnqueue = System.nanoTime();
+
+        assertFalse(&quot;Fresh OutboundTcpConnection contains expired messages&quot;,
+                otc.backlogContainsExpiredMessages(nanoTimeBeforeEnqueue));
+
+        fillToPurgeSize(otc, VERB_NONDROPPABLE);
+        fillToPurgeSize(otc, VERB_NONDROPPABLE);
+        otc.expireMessages(expirationTimeNanos());
+
+        assertFalse(&quot;OutboundTcpConnection with non-droppable verbs should not expire&quot;,
+                otc.backlogContainsExpiredMessages(expirationTimeNanos()));
+    }
&lt;p&gt;+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Tests that droppable messages will be dropped after they expire, but not before.&lt;br/&gt;
+     * &lt;br/&gt;
+     * @throws UnknownHostException&lt;br/&gt;
+     */&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testDroppable() throws UnknownHostException&lt;br/&gt;
+    &lt;/p&gt;
{
+        OutboundTcpConnection otc = getOutboundTcpConnectionForLocalhost();
+        long nanoTimeBeforeEnqueue = System.nanoTime();
+
+        initialFill(otc, VERB_DROPPABLE);
+        assertFalse(&quot;OutboundTcpConnection with droppable verbs should not expire immediately&quot;,
+                otc.backlogContainsExpiredMessages(nanoTimeBeforeEnqueue));
+
+        otc.expireMessages(nanoTimeBeforeEnqueue);
+        assertFalse(&quot;OutboundTcpConnection with droppable verbs should not expire with enqueue-time expiration&quot;,
+                otc.backlogContainsExpiredMessages(nanoTimeBeforeEnqueue));
+
+        // Lets presume, expiration time have passed =&amp;gt; At that time there shall be expired messages in the Queue
+        long nanoTimeWhenExpired = expirationTimeNanos();
+        assertTrue(&quot;OutboundTcpConnection with droppable verbs should have expired&quot;,
+                otc.backlogContainsExpiredMessages(nanoTimeWhenExpired));
+
+        // Using the same timestamp, lets expire them and check whether they have gone
+        otc.expireMessages(nanoTimeWhenExpired);
+        assertFalse(&quot;OutboundTcpConnection should not have expired entries&quot;,
+                otc.backlogContainsExpiredMessages(nanoTimeWhenExpired));
+
+        // Actually the previous test can be done in a harder way: As expireMessages() has run, we cannot have
+        // ANY expired values, thus lets test also against nanoTimeBeforeEnqueue
+        assertFalse(&quot;OutboundTcpConnection should not have any expired entries&quot;,
+                otc.backlogContainsExpiredMessages(nanoTimeBeforeEnqueue));
+
+    }
&lt;p&gt;+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Fills the given OutboundTcpConnection with (1 + BACKLOG_PURGE_SIZE), elements. The first&lt;br/&gt;
+     * BACKLOG_PURGE_SIZE elements are non-droppable, the last one is a message with the given Verb and can be&lt;br/&gt;
+     * droppable or non-droppable.&lt;br/&gt;
+     */&lt;br/&gt;
+    private void initialFill(OutboundTcpConnection otc, Verb verb)&lt;br/&gt;
+    &lt;/p&gt;
{
+        assertFalse(&quot;Fresh OutboundTcpConnection contains expired messages&quot;,
+                otc.backlogContainsExpiredMessages(System.nanoTime()));
+
+        fillToPurgeSize(otc, VERB_NONDROPPABLE);
+        MessageOut&amp;lt;?&amp;gt; messageDroppable10s = new MessageOut&amp;lt;&amp;gt;(verb);
+        otc.enqueue(messageDroppable10s, nextMessageId());
+        otc.expireMessages(System.nanoTime());
+    }
&lt;p&gt;+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Returns a nano timestamp in the far future, when expiration should have been performed for VERB_DROPPABLE.&lt;br/&gt;
+     * The offset is chosen as 2 times of the expiration time of VERB_DROPPABLE.&lt;br/&gt;
+     * &lt;br/&gt;
+     * @return The future nano timestamp&lt;br/&gt;
+     */&lt;br/&gt;
+    private long expirationTimeNanos()&lt;br/&gt;
+    &lt;/p&gt;
{
+        return System.nanoTime() + NANOS_FOR_TIMEOUT;
+    }
&lt;p&gt;+&lt;br/&gt;
+    private int nextMessageId()&lt;br/&gt;
+    &lt;/p&gt;
{
+        return messageId.incrementAndGet();
+    }
&lt;p&gt;+&lt;br/&gt;
+    /**&lt;br/&gt;
+     * Adds BACKLOG_PURGE_SIZE messages to the queue. Hint: At BACKLOG_PURGE_SIZE expiration starts to work.&lt;br/&gt;
+     * &lt;br/&gt;
+     * @param otc&lt;br/&gt;
+     *            The OutboundTcpConnection&lt;br/&gt;
+     * @param verb&lt;br/&gt;
+     *            The verb that defines the message type&lt;br/&gt;
+     */&lt;br/&gt;
+    private void fillToPurgeSize(OutboundTcpConnection otc, Verb verb)&lt;br/&gt;
+    {&lt;br/&gt;
+        for (int i = 0; i &amp;lt; OutboundTcpConnection.BACKLOG_PURGE_SIZE; i++)&lt;br/&gt;
+        &lt;/p&gt;
{
+            otc.enqueue(new MessageOut&amp;lt;&amp;gt;(verb), nextMessageId());
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    private OutboundTcpConnection getOutboundTcpConnectionForLocalhost() throws UnknownHostException&lt;br/&gt;
+    &lt;/p&gt;
{
+        InetAddress lo = InetAddress.getByName(&quot;127.0.0.1&quot;);
+        OutboundTcpConnectionPool otcPool = new OutboundTcpConnectionPool(lo);
+        OutboundTcpConnection otc = new OutboundTcpConnection(otcPool);
+        return otc;
+    }
&lt;p&gt;+}&lt;br/&gt;
&amp;#8211; &lt;br/&gt;
2.12.0&lt;/p&gt;
</comment>
                            <comment id="15963230" author="aweisberg" created="Mon, 10 Apr 2017 17:32:40 +0000"  >&lt;p&gt;Great! Most regular contributors are linking to a branch in their fork, but there are issues with that (people force update, delete branches). You don&apos;t have to attach a patch to get it to submit patch. &lt;/p&gt;

&lt;p&gt;I do need a patch for each branch. 2.2, 3.0, 3.11 and trunk. We try to push the work of dealing with the merge conflicts to the assignees over the committers. Use whatever method you prefer to submit the code.&lt;/p&gt;

&lt;p&gt;When you have all of the patches I&apos;ll kick off test runs. It&apos;s going to take a while for the dtests to run right now.&lt;/p&gt;</comment>
                            <comment id="15964522" author="cesken" created="Tue, 11 Apr 2017 15:28:57 +0000"  >&lt;p&gt;Done.  2 organizational topics left:&lt;/p&gt;

&lt;p&gt;I will add the required line to the commit message. Looks OK?!?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;patch by Christian Esken; reviewed by Ariel Weisberg  and Jason Brown for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13265&quot; title=&quot;Expiration in OutboundTcpConnection can block the reader Thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13265&quot;&gt;&lt;del&gt;CASSANDRA-13265&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My proposals for the CHANGES.txt would be the following text. Can you do that, Ariel? I do not know in which versions to add that, as they are upcoming versions.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Expire OutboundTcpConnection messages by a single Thread &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Here are the branches.The cassandra-3.0 is already squashed. If that branch is OK, I will also squash the other 3 branches.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-3.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-3.11&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/trunk&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-2.2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15964613" author="aweisberg" created="Tue, 11 Apr 2017 16:34:07 +0000"  >&lt;p&gt;Squashing is preferred, but I like to keep the history. When I squash I create a second -squashed branch to hold the squash commit. I never delete branches and tolerate the cluttered namespace. If we used pull requests I would delete branches since the pull request preserves the information, but we don&apos;t &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Since people tend to work on multiple tickets they don&apos;t name the branch cassandra-3.0 they do something like cassandra-13625-3.0. The commit process I follow is &lt;a href=&quot;http://cassandra.apache.org/doc/latest/development/how_to_commit.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassandra.apache.org/doc/latest/development/how_to_commit.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;For the commit message don&apos;t list multiple reviewers just the one in the JIRA (me). I have been told that line is automatically parsed so we want to stick to the expected format. Also some OCD people want a line break in between the first and last line of the commit message.&lt;/p&gt;

&lt;p&gt;Having CHANGES.TXT in the patch is helpful so I don&apos;t forget to add it in one branch. If it&apos;s not there and I follow the commit process I have to add it at each branch. For the entry also include the ticket number in parens at the end.&lt;/p&gt;

&lt;p&gt;I&apos;ll kick off the tests now.&lt;/p&gt;</comment>
                            <comment id="15964943" author="aweisberg" created="Tue, 11 Apr 2017 20:50:37 +0000"  >&lt;p&gt;There seem to be some build issues in various branches? Maybe because I rebased?&lt;/p&gt;

&lt;p&gt;You should register with CircleCI so it will automatically build and run the unit tests for you out of your repo when you commit. When you rebase there will be a circle.yml in each branch that will automatically have it run the build.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Code&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;utests&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;dtests&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/aweisberg/cassandra/pull/new/cassandra-13265-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/aweisberg/cassandra/tree/cassandra-13265-2%2E2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/aweisberg/cassandra/pull/new/cassandra-13265-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/aweisberg/cassandra/tree/cassandra-13265-3%2E0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/aweisberg/cassandra/pull/new/cassandra-13265-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/aweisberg/cassandra/tree/cassandra-13265-3%2E11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/aweisberg/cassandra/pull/new/cassandra-13265-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/aweisberg/cassandra/tree/cassandra-13265-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15967484" author="cesken" created="Thu, 13 Apr 2017 11:57:18 +0000"  >&lt;p&gt;There were different reasons why the build failed, e.g. somehow Eclipse did not pick up the build parameters for 2.2 after &quot;ant generate-eclipse-files&quot; and the build was done with Java 8 language level (lambdas). Looks like building and testing in Eclipse alone is not enough, so I redid everything manually in the console and fixed the issues. As you recommended, I have created branches that follow your naming  (cassandra-13625-3.0) with squashed commits. The new branches are:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13625-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13625-2.2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13625-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13625-3.11&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13625-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13625-3.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13625-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13625-trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;About CHANGES.TXT: I added changes in the &quot;matching&quot; release versions that were listed in the individual branches. Please check, as the naming conventions within Cassandra are still not clear to me (e.g. there exists a 3.11 branch, a 3.0.11 release and a 3.11.0 changelog entry).&lt;/p&gt;</comment>
                            <comment id="15967857" author="aweisberg" created="Thu, 13 Apr 2017 16:44:27 +0000"  >&lt;p&gt;OK, don&apos;t forget to get set up with CircleCI and post the block with the test results.&lt;/p&gt;

&lt;p&gt;Also you transposed 13625 and 13265 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15967870" author="aweisberg" created="Thu, 13 Apr 2017 16:50:21 +0000"  >&lt;p&gt;Nevermind I&apos;ll run them. I have to anyways for the dtests until we get the dtests running in CircleCI. I updated my copies. &lt;/p&gt;

&lt;p&gt;For CHANGES.TXT the entry should go at the top of the list of entries for the version the change is for. I don&apos;t know why.&lt;/p&gt;</comment>
                            <comment id="15974590" author="cesken" created="Wed, 19 Apr 2017 13:00:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;For CHANGES.TXT the entry should go at the top of the list of entries for the version the change is for. I don&apos;t know why.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I also haven&apos;t seen this mentioned. Probably someone could add that to &lt;a href=&quot;https://wiki.apache.org/cassandra/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/cassandra/HowToContribute&lt;/a&gt; or &lt;a href=&quot;http://cassandra.apache.org/doc/latest/development/how_to_commit.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassandra.apache.org/doc/latest/development/how_to_commit.html&lt;/a&gt; . Anyhow I have fixed that.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;set up with CircleCI &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; Also you transposed 13625 and 13265 &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I changed the branches to correct the transposing 13625 and 13265. I didn&apos;t find any other place than the branch names. I will try to find out about how to do the CircleCI stuff. Meanwhile here are the updated links:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13265-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13265-2.2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13265-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13265-3.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13265-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13265-3.11&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/christian-esken/cassandra/commits/cassandra-13265-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commits/cassandra-13265-trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15974671" author="aweisberg" created="Wed, 19 Apr 2017 13:35:55 +0000"  >&lt;p&gt;Sorry I just had a really busy week last week and I&apos;ve been trying to get Circle to the point it can run the dtests. I&apos;m mostly there it&apos;s just a few failing tests that remain.&lt;/p&gt;</comment>
                            <comment id="15974885" author="cesken" created="Wed, 19 Apr 2017 15:13:30 +0000"  >&lt;p&gt;No problem. I was away for Easter, so I did not even notice you being busy. &lt;br/&gt;
I just started my CircleCI test for the first time. Its working on the first branch (trunk) for an hour and is not complete yet, so I guess with all the branches it can take a day to complete. I have restarted the build with more parallelism and hopefully that will create a more acceptable turnaround time. I will send an update whenever that is complete.  &lt;a href=&quot;https://circleci.com/gh/christian-esken/cassandra/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/christian-esken/cassandra/3&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15976279" author="cesken" created="Thu, 20 Apr 2017 08:08:33 +0000"  >&lt;p&gt;Unfortunately some test failed, not because of bugs but due to technical issues, mostly with &quot;com.datastax.driver.core.exceptions.NoHostAvailableException&quot;. Are these the &quot;dtest&quot; issues in CircleCI you mentioned?&lt;/p&gt;

&lt;p&gt;I tried to run the tests locally, but even &quot;ant test&quot; runs &amp;gt; 1 hour and keeps failing  with Timeout, NoHostAvailableException, or similar. I don&apos;t know why the tests fail, as my Laptop should be capable of doing it. I am frequently running a 3-node Cassandra on it via ccm and that works properly.&lt;/p&gt;

&lt;p&gt;Currently I think I did all I can do. Let me know if I can check something else. What is your proposal how do we continue here?&lt;/p&gt;</comment>
                            <comment id="15976867" author="aweisberg" created="Thu, 20 Apr 2017 15:08:43 +0000"  >&lt;p&gt;That circle.yml is broken. For instance OutboundTcpConnectionTest failed to start because it NPEed in DatabaseDescriptor but it&apos;s not in the summary. Or maybe it&apos;s Circle. I&apos;m not sure. I&apos;m also not sure why your are only getting builds for trunk.&lt;/p&gt;

&lt;p&gt;If you fix the unit test I think it&apos;s ready to commit. The dtests ran on Apache Jenkins for everything except trunk. Trunk timed out on one test so I&apos;m going to try it again.&lt;/p&gt;</comment>
                            <comment id="15977067" author="aweisberg" created="Thu, 20 Apr 2017 16:57:01 +0000"  >&lt;p&gt;The branches are out of date. 3.11 ones doesn&apos;t have a circle.yml. They really need to be rebased onto something relatively recent so they can run in Circle.&lt;/p&gt;</comment>
                            <comment id="15978730" author="cesken" created="Fri, 21 Apr 2017 13:28:16 +0000"  >&lt;p&gt;Hmm, I rebased on 2.2 and trunk. I am surprised that 3.11 is not current, as 3.11 is not that old. I will now clean my repo, including deleting the bad &quot;13625&quot; branches and rebasing 3.0 and 3.11. &lt;/p&gt;</comment>
                            <comment id="15978748" author="cesken" created="Fri, 21 Apr 2017 13:39:35 +0000"  >&lt;p&gt;I pulled the changes, fixed the CHANGES.txt and pushed everything again. Now CircleCI is kicking off the builds for the branches. Looks like we are getting somewhere. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15981236" author="cesken" created="Mon, 24 Apr 2017 14:31:25 +0000"  >&lt;p&gt;First here is a summary and the question I have: The tests work if I add &quot;DatabaseDescriptor.daemonInitialization();&quot; to the unit test of the affected branches. Is this a good idea, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;Now the long story:&lt;/p&gt;

&lt;p&gt;This is the status for branch cassandra-13265-3.0:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Running unit tests in Eclipse: Works&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;/&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; CircleCI: All normal tests work fine. &quot;Your build ran 4754 tests in junit with 0 failures&quot;.  The build fails for me with: Target &quot;stress-test&quot; does not exist in the project &quot;apache-cassandra&quot;. As &quot;ant test&quot; worked, I would guess that the patch is fine. I will reverify the specific unit test locally&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;This is the status for branch cassandra-13265-3.11 and cassandra-13265-trunk:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Running unit tests in Eclipse: Works&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Running unit tests with CircleCI or &quot;ant test&quot; fails, due to non-initialized DatabaseDescriptor.&lt;br/&gt;
  When I add the following to the unit test of cassandra-13265-3.11, the unit test works. 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   DatabaseDescriptor.daemonInitialization();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    [junit] Null Test:  Caused an ERROR
    [junit] &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
    [junit] java.lang.ExceptionInInitializerError
    [junit]     at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
    [junit]     at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:264)
    [junit] Caused by: java.lang.NullPointerException
    [junit]     at org.apache.cassandra.config.DatabaseDescriptor.getWriteRpcTimeout(DatabaseDescriptor.java:1400)
    [junit]     at org.apache.cassandra.net.MessagingService$Verb$1.getTimeout(MessagingService.java:121)
    [junit]     at org.apache.cassandra.net.OutboundTcpConnectionTest.&amp;lt;clinit&amp;gt;(OutboundTcpConnectionTest.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15985008" author="aweisberg" created="Wed, 26 Apr 2017 15:31:54 +0000"  >&lt;p&gt;I think the stress-test target just doesn&apos;t exist in 3.0.&lt;/p&gt;

&lt;p&gt;Adding &lt;tt&gt;DatabaseDescriptor.daemonInitialization()&lt;/tt&gt; is the correct fix I think.&lt;/p&gt;

&lt;p&gt;I a struggling to just get a run of the dtests for 2.2 and trunk before I merge. This runs output seems corrupted &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/30/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/30/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The trunk trunk run doesn&apos;t even appear.&lt;/p&gt;</comment>
                            <comment id="15986426" author="cesken" created="Thu, 27 Apr 2017 11:48:14 +0000"  >&lt;p&gt;I am fixing the branches, while you work on the dtests. I will continue updating this comment as long as I work on it.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; sqaushed? &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Unit Tests OK? &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  cassandra-13265-3.0 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  yes &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; / &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; No stress-test in build.xml. I patched circle.yml to match that: &lt;a href=&quot;https://github.com/christian-esken/cassandra/commit/1a776e299c76093eb3edf20e0d9054e14549a667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/christian-esken/cassandra/commit/1a776e299c76093eb3edf20e0d9054e14549a667&lt;/a&gt; . CircleCI still kicks off a 4th test, which fails but can likely be ignored for now. &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  cassandra-13265-3.11 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; yes &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; CircleCI  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  cassandra-13265-2.2  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; yes &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant test   &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; CicrleCI hasn&apos;t kicked off tests for the branch &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  cassandra-13265-trunk  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; yes &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; CircleCI &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; / &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; My unit test works. But there is a strange unrelated unit test failure: ClassNotFoundException: org.apache.cassandra.stress.CompactionStress &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15986786" author="aweisberg" created="Thu, 27 Apr 2017 15:06:51 +0000"  >&lt;p&gt;You don&apos;t need to get all the tests passing. Only the ones broken specifically by your changes. So you have to run the tests on the base branch (cassandra-2.2, cassandra-3.0, cassandra-3.11, cassandra-trunk) or compare the results to &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-2.2-test-all/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-2.2-test-all/&lt;/a&gt; or the one specific to the version of your branch.&lt;/p&gt;

&lt;p&gt;You also need to be aware that a test might just be unreliable in CircleCI. The unit tests seem to be reliable to me when I was running them with my circle.yml, but I am not sure about the one on trunk.&lt;/p&gt;

&lt;p&gt;Certainly it runs additional tests which weren&apos;t running all the time before Circle and I don&apos;t think they were reliable when we started running them.&lt;/p&gt;</comment>
                            <comment id="15989517" author="aweisberg" created="Fri, 28 Apr 2017 22:02:55 +0000"  >&lt;p&gt;trunk&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Test Result (12 failures / +2)
auth_test.TestAuth.system_auth_ks_is_alterable_test
bootstrap_test.TestBootstrap.decommissioned_wiped_node_can_join_test
paging_test.TestPagingWithDeletions.test_ttl_deletions
repair_tests.incremental_repair_test.TestIncRepair.sstable_repairedset_test
repair_tests.incremental_repair_test.TestIncRepair.sstable_repairedset_test
snapshot_test.TestSnapshot.test_snapshot_and_restore_dropping_a_column
repair_tests.incremental_repair_test.TestIncRepair.multiple_full_repairs_lcs_test
repair_tests.incremental_repair_test.TestIncRepair.multiple_full_repairs_lcs_test
sstableutil_test.SSTableUtilTest.compaction_test
topology_test.TestTopology.size_estimates_multidc_test
topology_test.TestTopology.size_estimates_multidc_test
bootstrap_test.TestBootstrap.simultaneous_bootstrap_test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2.2&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Test Result (4 failures / -8)
batch_test.TestBatch.logged_batch_throws_uae_test
snapshot_test.TestSnapshot.test_snapshot_and_restore_dropping_a_column
topology_test.TestTopology.size_estimates_multidc_test
bootstrap_test.TestBootstrap.simultaneous_bootstrap_test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15991146" author="aweisberg" created="Mon, 1 May 2017 17:31:22 +0000"  >&lt;p&gt;So the dtests failing on the branch don&apos;t match the failures on trunk, but I looked at some of the other branches and they are also failing similar random tests. So I am running trunk using the branch job to see what the test failures look like in that scenario. I don&apos;t think you broke anything it&apos;s just doing due diligence is a pain right now.&lt;/p&gt;

&lt;p&gt;I looked at the utests and they look fine. Right now it runs 4 containers, but the first container is most important as that is where the tests are closest to zero failures since we only used to run those on every commit. The others failures don&apos;t look related (famous last words).&lt;/p&gt;

&lt;p&gt;Meanwhile can you squash the branches that aren&apos;t squashed?&lt;/p&gt;</comment>
                            <comment id="15994820" author="cesken" created="Wed, 3 May 2017 13:04:58 +0000"  >&lt;p&gt;Done. Squashed and pushed. &lt;/p&gt;

&lt;p&gt;I also removed my &quot;stress-test&quot; patch in the 3.0 branch, as it is not related and also does not look like a proper fix. As a reference, here is the patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-    - &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; $CIRCLE_NODE_INDEX in 0) ant eclipse-warnings; ant test ;; 1) ant &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;-test ;; 2) ant test-compression ;; 3) ant stress-test ;;esac:
+    - &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; $CIRCLE_NODE_INDEX in 0) ant eclipse-warnings; ant test ;; 1) ant &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;-test ;; 2) ant test-compression ;;esac:
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15995667" author="aweisberg" created="Wed, 3 May 2017 20:55:34 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/617c8ebadb6c4df99c35a913184760e82172b1f5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;617c8ebadb6c4df99c35a913184760e82172b1f5&lt;/a&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="15996322" author="cesken" created="Thu, 4 May 2017 08:03:13 +0000"  >&lt;p&gt;Thanks. I have seen your commit in three branches. I did not yet see the changes in cassandra-2.2, when looking at  &lt;a href=&quot;https://github.com/apache/cassandra/commits/cassandra-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commits/cassandra-2.2&lt;/a&gt; . Is this an omission, or is the github repo is not current?&lt;/p&gt;</comment>
                            <comment id="15996951" author="aweisberg" created="Thu, 4 May 2017 15:47:05 +0000"  >&lt;p&gt;I decided to start from 3.0 because 2.2 is really critical fixes only and this issue has been broken since 2.1 without eliciting a lot of complaints until now. It&apos;s a judgement call. I took a quick poll and the response was that 3.0+ was the place to start.&lt;/p&gt;

&lt;p&gt;Is this something that&apos;s impacting you in 2.2?&lt;/p&gt;</comment>
                            <comment id="15998277" author="cesken" created="Fri, 5 May 2017 12:37:41 +0000"  >&lt;p&gt;It is fine, I do not use 2.2. I was just wondering because you asked me to start with 2.2, which required more effort and made things a bit more complicated. If you hadn&apos;t asked, I would have done patches just for the HEAD of version 3 (cassandra-3.0) and version 4 (trunk). &lt;/p&gt;

&lt;p&gt;So, mission complete. Thanks Ariel for guiding me through my first Cassandra patch. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15998310" author="aweisberg" created="Fri, 5 May 2017 13:17:39 +0000"  >&lt;p&gt;I&apos;m sorry &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ll try to get a more concrete handle on fix versions earlier next time. It&apos;s always been something I&apos;ve struggled calibrating because different committers are all over the map in terms of how far back they will backport things.&lt;/p&gt;</comment>
                            <comment id="16195765" author="githubbot" created="Sat, 7 Oct 2017 15:51:17 +0000"  >&lt;p&gt;Github user jeffjirsa commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @christian-esken , &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13265&quot; title=&quot;Expiration in OutboundTcpConnection can block the reader Thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13265&quot;&gt;&lt;del&gt;CASSANDRA-13265&lt;/del&gt;&lt;/a&gt; has been merged, do you mind closing this PR? (we can&apos;t close it for you)&lt;/p&gt;
</comment>
                            <comment id="16197193" author="githubbot" created="Mon, 9 Oct 2017 16:02:03 +0000"  >&lt;p&gt;Github user christian-esken commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closing PR, as it has been merged in all relevant banches. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13265&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-13265&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16197194" author="githubbot" created="Mon, 9 Oct 2017 16:02:04 +0000"  >&lt;p&gt;Github user christian-esken closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16197195" author="cesken" created="Mon, 9 Oct 2017 16:02:34 +0000"  >&lt;p&gt;PR closed: &lt;a href=&quot;https://github.com/apache/cassandra/pull/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/95&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13038235">CASSANDRA-13159</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12865631" name="cassandra-13265-2.2-dtest_stdout.txt" size="28100" author="aweisberg" created="Fri, 28 Apr 2017 22:02:55 +0000"/>
                            <attachment id="12865632" name="cassandra-13265-trun-dtest_stdout.txt" size="108512" author="aweisberg" created="Fri, 28 Apr 2017 22:02:55 +0000"/>
                            <attachment id="12854505" name="cassandra.pb-cache4-dus.2017-02-17-19-36-26.chist.xz" size="28612" author="cesken" created="Fri, 24 Feb 2017 16:38:35 +0000"/>
                            <attachment id="12854504" name="cassandra.pb-cache4-dus.2017-02-17-19-36-26.td.xz" size="13048" author="cesken" created="Fri, 24 Feb 2017 16:38:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[cesken]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12994" cascade-level="1"><![CDATA[Unavailable]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3al5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>