<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9572] DateTieredCompactionStrategy fails to combine SSTables correctly when TTL is used.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9572</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;DateTieredCompaction works correctly when data is dumped for a certain time period in short SSTables in time manner and then compacted together. However, if TTL is applied to the data columns the DTCS fails to compact files correctly in timely manner. In our opinion the problem is caused by two issues:&lt;/p&gt;

&lt;p&gt;A) During the DateTieredCompaction process the getFullyExpiredSStables is called twice. First from the DateTieredCompactionStrategy class and second time from the CompactionTask class. On the first time the target is to find out fully expired SStables that are not overlapping with any non-fully expired SSTables. That works correctly. When the getFullyExpiredSSTables is called second time from CompactionTask class the selection of fully expired SSTables is modified compared to the first selection.&lt;/p&gt;

&lt;p&gt;B) The minimum timestamp of the new SSTables created by combining together fully expired SSTable and files from the most interesting bucket is not correct.&lt;/p&gt;

&lt;p&gt;These two issues together cause problems for the DTCS process when it combines together SSTables having overlap in time and TTL for the column. This is demonstrated by generating test data first without compactions and showing the timely distribution of files. When the compaction is enabled the DCTS combines files together, but the end result is not something to be expected. This is demonstrated in the file motivation_jira.txt&lt;/p&gt;

&lt;p&gt;Attachments contain following material:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Motivation_jira.txt: Practical examples how the DTCS behaves with TTL&lt;/li&gt;
	&lt;li&gt;Explanation_jira.txt: gives more details, explains test cases and demonstrates the problems in the compaction process&lt;/li&gt;
	&lt;li&gt;Logfile file for the compactions in the first test case (compaction_stage_test01_jira.log)&lt;/li&gt;
	&lt;li&gt;Logfile file for the compactions in the seconnd test case (compaction_stage_test02_jira.log)&lt;/li&gt;
	&lt;li&gt;source code zip file for version 2.1.5 with additional comment statements (src_2.1.5_with_debug.zip)&lt;/li&gt;
	&lt;li&gt;Python script to generate test data (datagen.py)&lt;/li&gt;
	&lt;li&gt;Python script to read metadata from SStables (cassandra_sstable_metadata_reader.py)&lt;/li&gt;
	&lt;li&gt;Python script to generate timeline representation of SSTables (cassandra_sstable_timespan_graph.py)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12836815">CASSANDRA-9572</key>
            <summary>DateTieredCompactionStrategy fails to combine SSTables correctly when TTL is used.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="anissinen">Antti Nissinen</reporter>
                        <labels>
                            <label>dtcs</label>
                    </labels>
                <created>Wed, 10 Jun 2015 12:01:40 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:08 +0000</updated>
                            <resolved>Fri, 12 Jun 2015 16:53:39 +0000</resolved>
                                        <fixVersion>2.0.16</fixVersion>
                    <fixVersion>2.1.7</fixVersion>
                    <fixVersion>2.2.0 rc2</fixVersion>
                    <fixVersion>3.0 alpha 1</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14580442" author="krummas" created="Wed, 10 Jun 2015 12:21:53 +0000"  >&lt;p&gt;to summarize (mostly so that I understand your report correctly):&lt;/p&gt;

&lt;p&gt;1. dtcs adds a bunch of fully expired sstables to the compaction&lt;br/&gt;
2. second call to getFullyExpiredSSTables does not agree that those are actually expired and combines a fully expired sstable with the non-expired ones, messing up the timestamps of the sstables&lt;/p&gt;</comment>
                            <comment id="14580498" author="anissinen" created="Wed, 10 Jun 2015 12:56:23 +0000"  >&lt;p&gt;In the DataTieredCompactionStrategy class (method getNextBackgroundSSTables) is the first call to the getFullyExpiredSSTables. It will return all such SSTables that are fully expired, but do not overlap with any of the non-fully expired SSTables. In the next phases the most interesting bucket is composed from SSTables that are not yet fully expired and are not under any other compaction thread. These two sets are combined and given as argument to create a new CompactionTask.&lt;/p&gt;

&lt;p&gt;In the CompactionTask (method runMayThrow) is a line where a variable &quot;actuallyCompact&quot; is assigned by taking a difference between the list of SSTables used to create the CompactionTask (contains SSTables that fully expired and do not overlap with any of the non-fully expired SStables AND SSTables from the most interesting bucket) and the set returned by method call getFullyExpiredSSTables without any arguments. Since the getFullyExpiredSSTables is called without arguments &quot;compacting&quot; variable contains the set of fully-expired files and files in the most interesting bucket. The set of overlapping files contain files including one of the fully expired files that was previously overlapping with one of the non-fully expired SSTables.&lt;/p&gt;

&lt;p&gt;Now the second round finds out that the previously discarded fully expired file overlaps with one of the fully expired files and it will discard one more fully expired file even if that does not actually overlap with any of the non-fully expired files. That means that one potentially droppable fully expired SSTable is missed from deletion.&lt;/p&gt;

&lt;p&gt;Now the files for the &quot;actuallyCompact&quot; variable has been selected and they will be compacted together. All files in the original list will then be deleted from the disk. The compaction puts together fully expired files and newer files from the most interesting bucket. All the data from the fully expired file should be discarded in the compaction and the minimum time stamp for the new file should be the one belonging to the oldest file in the most interesting bucket. However, the minimum timestamp for the new file is the minimum timestamp belonging to the file discarded on the second round getFullyExpiredSSTables (missed case in the previous paragraph).  This happens on the first compaction round. On later compaction rounds the minimum timestamp does not follow that rule and I don&apos;t know where it takes the minimum timestamp for the new file. This will lead to SStables that are suppose to have data from a long time window and it will mess up later compactions because files containing only new data will be selected to the compacted with older files.&lt;/p&gt;

&lt;p&gt;Hopefully this clarifies the original report.&lt;/p&gt;</comment>
                            <comment id="14581490" author="anissinen" created="Thu, 11 Jun 2015 05:53:11 +0000"  >&lt;p&gt;I tried to make a simplified example of the issue:&lt;/p&gt;

&lt;p&gt;z = expired data&lt;br/&gt;
x = valid data&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;example&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1   zzzzzz
2       zzzzzz
3           zzzzzz
4               zzzzzz
5                   zzzxxx
6                       xxxxxx
7                           xxxxxx
8                               xxxxxx
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;First round of getFullyExpiredSStables will select files 1-3. 4 is discarded since it overlaps with one of the non-fully expired files.&lt;br/&gt;
Let&apos;s assume that the most interesting bucket will be files 7 -8&lt;/p&gt;

&lt;p&gt;Files 1-3 and 7-8 will be fed to the compactionTask&lt;/p&gt;

&lt;p&gt;In the second call to getFullyExpiredSStables the overlapping files will include file 4. File number 3 will be dropped since it overlaps with file number 4. getFullyExpiredSSTables will return files 1,2&lt;/p&gt;

&lt;p&gt;Variable actuallyCompact is a difference between set 1,2,3,7,8  and set 1,2.&lt;br/&gt;
Compaction will be done for files 3,7,8 and in the end all files (1,2,3,7,8) will be deleted from the disc.&lt;/p&gt;

&lt;p&gt;The problem is that file number 3 ends up to the compaction (should be dropped) and the starttime of the new file (number 9) is not the starttime of file number 7. Currently the starttime of new SSTable is same as starttime of file number 4.&lt;/p&gt;

</comment>
                            <comment id="14581544" author="krummas" created="Thu, 11 Jun 2015 06:47:38 +0000"  >&lt;p&gt;thanks for the report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anissinen&quot; class=&quot;user-hover&quot; rel=&quot;anissinen&quot;&gt;anissinen&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;patch that should fix it here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/9572&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/9572&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bj0rn&quot; class=&quot;user-hover&quot; rel=&quot;Bj0rn&quot;&gt;Bj0rn&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14581706" author="anissinen" created="Thu, 11 Jun 2015 09:16:22 +0000"  >&lt;p&gt;Thank you for the batch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;! First results look promising!&lt;br/&gt;
I added a new file to attachments showing the time lines with and without TTL (first_results_after_patch.txt)&lt;/p&gt;</comment>
                            <comment id="14581760" author="bj0rn" created="Thu, 11 Jun 2015 10:06:07 +0000"  >&lt;p&gt;Looks like the right solution to this (except refactoring to avoid calling getFullyExpiredSSTables twice). But why is the sort still there (line 115/120)? It&apos;s redundant since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8243&quot; title=&quot;DTCS can leave time-overlaps, limiting ability to expire entire SSTables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8243&quot;&gt;&lt;del&gt;CASSANDRA-8243&lt;/del&gt;&lt;/a&gt;, and was removed in 2.1+.&lt;/p&gt;</comment>
                            <comment id="14583313" author="anissinen" created="Fri, 12 Jun 2015 12:01:01 +0000"  >&lt;p&gt;I ran the test again and looked at the log file in detail. Now it works as expected. Thank you very much for all involved!&lt;/p&gt;</comment>
                            <comment id="14583465" author="slebresne" created="Fri, 12 Jun 2015 14:34:08 +0000"  >&lt;p&gt;patch lgtm&lt;/p&gt;</comment>
                            <comment id="14583692" author="krummas" created="Fri, 12 Jun 2015 16:53:39 +0000"  >&lt;p&gt;ok, committed, thanks everyone&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12738804" name="cassandra_sstable_metadata_reader.py" size="5491" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12738805" name="cassandra_sstable_timespan_graph.py" size="2683" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12738801" name="compaction_stage_test01_jira.log" size="352465" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12738802" name="compaction_stage_test02_jira.log" size="321796" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12738803" name="datagen.py" size="5796" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12738800" name="explanation_jira.txt" size="91942" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12739020" name="first_results_after_patch.txt" size="20380" author="anissinen" created="Thu, 11 Jun 2015 09:16:42 +0000"/>
                            <attachment id="12738799" name="motivation_jira.txt" size="20764" author="anissinen" created="Wed, 10 Jun 2015 12:01:40 +0000"/>
                            <attachment id="12738819" name="src_2.1.5_with_debug.zip" size="2462573" author="anissinen" created="Wed, 10 Jun 2015 12:59:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fvkf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>