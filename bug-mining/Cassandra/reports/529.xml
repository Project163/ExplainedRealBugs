<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:17:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1661] Use of ByteBuffer limit() must account for arrayOffset()</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1661</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There are a few places in the code where it loops across a byte buffers backing array wrong:&lt;/p&gt;


&lt;p&gt;        for (int i=bytes.position()&lt;ins&gt;bytes.arrayOffset(); i&amp;lt;bytes.limit(); i&lt;/ins&gt;+)&lt;/p&gt;

&lt;p&gt;This is incorrect as the limit() does not account for arrayOffset()&lt;/p&gt;

&lt;p&gt;              for (int i=bytes.position()&lt;ins&gt;bytes.arrayOffset(); i&amp;lt;bytes.limit()+bytes.arrayOffset(); i&lt;/ins&gt;+)&lt;/p&gt;

&lt;p&gt;is the correct code.&lt;/p&gt;

&lt;p&gt;There is also a few places where the unit tests would fail if we used non wrapped byte arrays.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12478239">CASSANDRA-1661</key>
            <summary>Use of ByteBuffer limit() must account for arrayOffset()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjake">T Jake Luciani</assignee>
                                    <reporter username="tjake">T Jake Luciani</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Oct 2010 15:06:39 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:14 +0000</updated>
                            <resolved>Tue, 26 Oct 2010 03:14:43 +0000</resolved>
                                        <fixVersion>0.7 beta 3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12924587" author="stuhood" created="Mon, 25 Oct 2010 15:09:51 +0000"  >&lt;p&gt;Regarding failing unit tests: a utility function that calls the allocator from 1651 would probably shorten the code and catch a lot of these.&lt;/p&gt;</comment>
                            <comment id="12924588" author="tjake" created="Mon, 25 Oct 2010 15:21:58 +0000"  >&lt;p&gt;good idea, I&apos;ll address it with that ticket&lt;/p&gt;</comment>
                            <comment id="12924612" author="stuhood" created="Mon, 25 Oct 2010 16:24:54 +0000"  >&lt;ul&gt;
	&lt;li&gt;A few of the loops involving direct array access (in particular the one in RandomPartitioner) could be simplified with judicious use of mark() and get()&lt;/li&gt;
	&lt;li&gt;Adding the follow function and using it in the tests would clarify things a lot: CFSTest looks like it exploded.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ByteBuffer bytes(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s) { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ByteBuffer.wrap(s.getBytes(UTF_8)); }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Converting BytesToken to ByteBuffer storage would clean up a ton of special casing (should probably be tackled in a separate issue though)&lt;/li&gt;
	&lt;li&gt;ByteBufferTest is literally a test of ByteBuffers: I don&apos;t think it should be in C*&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12924617" author="jbellis" created="Mon, 25 Oct 2010 16:29:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;simplified with judicious use of mark() and get()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I worry that we&apos;re going to introduce very very tricky bugs if we don&apos;t treat position as immutable.  If BB/Thrift were sane about using offset to represent the start of what we&apos;re allowed to mess with, that would be another story, but it&apos;s not &amp;#8211; Thrift uses wrap to generate the BB it gives us, so position is the only indication we have of what a given BB is supposed to cover.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;ByteBufferTest is literally a test of ByteBuffers: I don&apos;t think it should be in C*&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OTOH ByteBuffer is a tricky enough API (see: this ticket &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; that I don&apos;t mind having BBT as an illustration of what is going on if not exactly a test.&lt;/p&gt;

&lt;p&gt;Maybe docstring in BBUtil instead of actual tests?&lt;/p&gt;</comment>
                            <comment id="12924619" author="jbellis" created="Mon, 25 Oct 2010 16:30:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;Converting BytesToken to ByteBuffer storage&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As background, this is an artifact of MerkleTree requiring serializable Tokens.  Using byte[] there was the easiest way to get that.  (Not necessarily the best, I agree.)&lt;/p&gt;</comment>
                            <comment id="12924620" author="tjake" created="Mon, 25 Oct 2010 16:32:27 +0000"  >&lt;ul&gt;
	&lt;li&gt;A few of the loops involving direct array access (in particular the one in RandomPartitioner) could be simplified with judicious use of mark() and get()&lt;br/&gt;
   &lt;b&gt;A previous version of the BB patch did exactly this, but Johnathan thought it would be better to treat ByteBuffers as immutable so avoid changing position and mark.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;ul&gt;
	&lt;li&gt;Adding the follow function and using it in the tests would clarify things a lot: CFSTest looks like it exploded.&lt;br/&gt;
     &lt;b&gt;I agree this is a mess, if you think it should be fixed in this patch ok, but it seems like a small issue.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Converting BytesToken to ByteBuffer storage would clean up a ton of special casing (should probably be tackled in a separate issue though)&lt;br/&gt;
     &lt;b&gt;I had also done this in a previous patch but it broke MerkleTree serialization&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;ByteBufferTest is literally a test of ByteBuffers: I don&apos;t think it should be in C&lt;br/&gt;
     &lt;b&gt;I put it in there incase others have questions about how ByteBuffers work.&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="12924626" author="jbellis" created="Mon, 25 Oct 2010 16:40:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Adding the follow function and using it in the tests would clarify things a lot&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 doing this.&lt;/p&gt;</comment>
                            <comment id="12924628" author="stuhood" created="Mon, 25 Oct 2010 16:43:34 +0000"  >&lt;p&gt;&amp;gt; better to treat ByteBuffers as immutable so avoid changing position and mark&lt;br/&gt;
In cases where the buffer should be immutable, you&apos;d need to duplicate() it first.&lt;/p&gt;

&lt;p&gt;&amp;gt; should be fixed in this patch ok, but it seems like a small issue&lt;br/&gt;
It&apos;s a small function: waiting any longer to add it isn&apos;t worth it, imo.&lt;/p&gt;

&lt;p&gt;&amp;gt; I put it in there incase others have questions about how ByteBuffers work.&lt;br/&gt;
I&apos;m out-numbered on this one I guess.&lt;/p&gt;</comment>
                            <comment id="12924670" author="tjake" created="Mon, 25 Oct 2010 18:31:47 +0000"  >&lt;p&gt;New version:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Puts BB test in BBUtil javadoc&lt;/li&gt;
	&lt;li&gt;Cleans up tests with new BBUtil call&lt;/li&gt;
	&lt;li&gt;Fixes Pig and word count&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12924675" author="stuhood" created="Mon, 25 Oct 2010 18:43:25 +0000"  >&lt;p&gt;+1 All that is left is nitpicks, which you can choose to ignore:&lt;/p&gt;

&lt;p&gt;&amp;gt; Cleans up tests with new BBUtil call&lt;br/&gt;
A static import might be the last bit of sugar to make this a real win.&lt;/p&gt;

&lt;p&gt;Code style dictates that there should be spaces around operators.&lt;/p&gt;</comment>
                            <comment id="12924826" author="jbellis" created="Tue, 26 Oct 2010 03:14:43 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457974" name="1661_v1.txt" size="32780" author="tjake" created="Mon, 25 Oct 2010 15:07:43 +0000"/>
                            <attachment id="12457989" name="1661_v2.txt" size="152358" author="tjake" created="Mon, 25 Oct 2010 18:31:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20245</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g6lz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92501</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stuhood</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stuhood]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>