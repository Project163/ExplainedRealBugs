<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5699] Streaming (2.0) can deadlock</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5699</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The new streaming implementation (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5286&quot; title=&quot;Streaming 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5286&quot;&gt;&lt;del&gt;CASSANDRA-5286&lt;/del&gt;&lt;/a&gt;) creates 2 threads per host for streaming, one for the incoming stream and one for the outgoing one. However, both currently share the same socket, but since we use synchronous I/O, a read can block a write, which can result in a deadlock if 2 nodes are both blocking on a read a the same time, thus blocking their respective writes (this is actually fairly easy to reproduce with a simple repair).&lt;/p&gt;

&lt;p&gt;So instead attaching a patch that uses one socket per thread.&lt;/p&gt;

&lt;p&gt;The patch also correct the stream throughput throttling calculation that was 8000 times lower than what it should be.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12654745">CASSANDRA-5699</key>
            <summary>Streaming (2.0) can deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jun 2013 14:57:51 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:10 +0000</updated>
                            <resolved>Wed, 3 Jul 2013 17:56:00 +0000</resolved>
                                        <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13696170" author="jbellis" created="Sat, 29 Jun 2013 18:21:39 +0000"  >&lt;p&gt;Is the &quot;stream lifecycle&quot; documented anywhere the way we did in 1.2 StreamOut?&lt;/p&gt;

&lt;p&gt;NB: this patches StreamingRepairTask, which does not exist in current trunk.&lt;/p&gt;</comment>
                            <comment id="13696727" author="slebresne" created="Mon, 1 Jul 2013 11:05:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is the &quot;stream lifecycle&quot; documented anywhere&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yuki had written &lt;a href=&quot;https://gist.github.com/yukim/5672508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/yukim/5672508&lt;/a&gt;. The one thing this patch changes compared to that &quot;design document&quot; is that the initialization phase is slightly more complex since we need to create 2 connection. So the first node sends a StreamInit to the other end to create the first connection (as was done previously), but then the remote side creates a connection back sending a StreamInit message of it&apos;s own. Then and only then do we go to the prepare phase.&lt;/p&gt;

&lt;p&gt;In any case, we probably want that lifecycle to be documented in the javadoc or we&apos;ll lose track of it, so I&apos;ve described this in relative detail at the head of StreamSession.&lt;/p&gt;

&lt;p&gt;So updated the patch with those added comments and the modification to StreamRepairTask cleaned up.&lt;/p&gt;</comment>
                            <comment id="13697341" author="jbellis" created="Mon, 1 Jul 2013 23:48:36 +0000"  >&lt;p&gt;It&apos;s somewhat confusing that we use StreamInit both as leader and as follower, to mean different things, but I get how the MessagingService architecture makes it difficult to do otherwise.  As a minor improvement, suggest renaming isInitiator to sentByInitiator.&lt;/p&gt;

&lt;p&gt;What is going on with the switch from &lt;tt&gt;Set&amp;lt;UUID&amp;gt; ongoingSessions&lt;/tt&gt; to &lt;tt&gt;Map&amp;lt;InetAddress, StreamSession&amp;gt; ongoingSessions&lt;/tt&gt; in SRF?&lt;/p&gt;

&lt;p&gt;Nit: onConnect could mean &quot;leader connects to follower&quot; or &lt;span class=&quot;error&quot;&gt;&amp;#91;what it actually means&amp;#93;&lt;/span&gt; &quot;stream is fully connected.&quot;  Suggest renaming, e.g. onSessionEstablished.&lt;/p&gt;

&lt;p&gt;Other comments on new Streaming:&lt;/p&gt;

&lt;p&gt;Somewhat confused by logic in complete() &amp;#8211; &quot;I received a Complete message.  If I&apos;m already waiting for a complete message, close the session.  Otherwise, wait for &lt;span class=&quot;error&quot;&gt;&amp;#91;another&amp;#93;&lt;/span&gt; Complete message&quot; ?&lt;/p&gt;

&lt;p&gt;It looks like there may be synchronization issues with &quot;state;&quot; some accesses are synchronized and some are not.&lt;/p&gt;

&lt;p&gt;Why is init broken out from construction?  Makes some things awkward, e.g. streamResult which is final-post-init but we have to null-check until then.&lt;/p&gt;

&lt;p&gt;Why do we include a String description in SIM?&lt;/p&gt;

&lt;p&gt;When does follower immediately have something to stream to leader, is this a Repair optimization?&lt;/p&gt;
</comment>
                            <comment id="13697644" author="slebresne" created="Tue, 2 Jul 2013 09:50:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s somewhat confusing that we use StreamInit both as leader and as follower, to mean different things&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I guess, though if you see StreamInit as a way for both node to open/initialize their outgoing connection to the other node (which is what this is doing), it&apos;s not really that different. And it&apos;s somewhat consistent with the rest of the protocol, where each side will sent a Prepare and then finally a Complete.  Anyway, updated the patch with the sentByInitiator renaming.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What is going on with the switch from Set&amp;lt;UUID&amp;gt; ongoingSessions to Map&amp;lt;InetAddress, StreamSession&amp;gt; ongoingSessions in SRF?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ongoingSession only role initialy was to track how many sessions for a StreamResultFuture were live to know when we&apos;re done (SRF.maybeComplete()). In the original patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5286&quot; title=&quot;Streaming 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5286&quot;&gt;&lt;del&gt;CASSANDRA-5286&lt;/del&gt;&lt;/a&gt;, it wasn&apos;t even there, and there was just an AtomicInteger decremented each time a session completed. I was slightly afraid that a race could have us counting the same session done twice, so I changed it to a Set&amp;lt;UUID&amp;gt; and added a simple UUID per session that was only used for that purpose (it was never send to the other side or anything). Anyway, that UUID addition was stupid in the first place since for a SRF, there is only one StreamSession per remote host, so it should have been a Set&amp;lt;InetAddress&amp;gt; to start with and we have no use for a StreamSession UUID.&lt;/p&gt;

&lt;p&gt;But on top of that, this patch add the need to be able to find back a StreamSession in a SRF given the remote endpoint (in IncomingStreamConnection, when the initiator gets the other side StreamInit), so we really need a map now.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Suggest renaming, e.g. onSessionEstablished&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, though I&apos;ve renamed to onInitializationComplete to be consistent with the wording of the javadoc.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Somewhat confused by logic in complete() &#8211; &quot;I received a Complete message. If I&apos;m already waiting for a complete message, close the session. Otherwise, wait for &lt;span class=&quot;error&quot;&gt;&amp;#91;another&amp;#93;&lt;/span&gt; Complete message&quot; ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Each side will send a CompleteMessage to say &quot;I&apos;m done on my side&quot;, and the session will be considered really complete (and closed) when we got the Complete for both side. So WAIT_COMPLETE means &quot;I&apos;ve seen only one complete message so far&quot;. Hence the logic of complete() is &quot;I just received a complete from the other side, if I had already completed my side, close the session, otherwise move to the &quot;I&apos;m waiting for the other complete&quot; state&quot;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It looks like there may be synchronization issues with &quot;state;&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we&apos;re good, because the only case where we can race to set a state is during the completion phase, for WAIT_COMPLETE and COMPLETE, and those are protected. For other states, there are set sequentially on each node by construction.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why is init broken out from construction?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;SRF takes his StreamSession in his ctor so we can&apos;t have StreamSessions take their SRF without some other refactor.  Now don&apos;t get me wrong, it bugs me too. And I do think there is a few things we can do to make that whole new streaming API simpler/cleaner (including probably renaming StreamRepairFuture). And I&apos;m volonteering to give to a shot to that. But in another follow ticket because:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I really think that kind of code cleanup shouldn&apos;t block beta1 (but this ticket, the fact that streaming deadlock, do is a blocker)&lt;/li&gt;
	&lt;li&gt;I&apos;ve already rewrote quite a bit of Yuki&apos;s code without him having the change to chime in. Would feel fair to wait to him to be back before refactoring parts that are not really crucial for beta1.&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;Why do we include a String description in SIM?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This the description of what the operation is doing (&quot;Repair&quot;, &quot;Bootstrap&quot;, &quot;Restore replica count&quot;, ...)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;When does follower immediately have something to stream to leader&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A StreamSession in the initiator handle both incoming and outgoing streams. Sometimes we only have outgoing ones (Unbootstrap/Restore replica count/Bulkloading), sometimes only&lt;br/&gt;
incoming ones (Bootstrap) and sometimes both (Repair indeed but also the SS.RangeRelocator for moves and vnodes tokens relocation). Does that answer your question?&lt;/p&gt;</comment>
                            <comment id="13699097" author="jbellis" created="Wed, 3 Jul 2013 15:47:08 +0000"  >&lt;p&gt;Ship it!&lt;/p&gt;</comment>
                            <comment id="13699255" author="slebresne" created="Wed, 3 Jul 2013 17:56:00 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12590400" name="5699.txt" size="49827" author="slebresne" created="Tue, 2 Jul 2013 09:50:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>335022</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lsgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>335346</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>