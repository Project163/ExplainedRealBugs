<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10424] Altering base table column with materialized view causes unexpected server error.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10424</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When attempting to alter column type of base table which has a corresponding  materialized view we get an exception from the server.&lt;/p&gt;

&lt;p&gt;Steps to reproduce.&lt;/p&gt;

&lt;p&gt;1. Create a base table&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE test.scores(
                        user TEXT,
                        game TEXT,
                        year INT,
                        month INT,
                        day INT,
                        score TEXT,
                        PRIMARY KEY (user, game, year, month, day)
                        )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. Create a corresponding materialized view&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE MATERIALIZED VIEW test.monthlyhigh AS
                SELECT game, year, month, score, user, day FROM test.scores
                WHERE game IS NOT NULL AND year IS NOT NULL AND month IS NOT NULL AND score IS NOT NULL AND user IS NOT NULL AND day IS NOT NULL
                PRIMARY KEY ((game, year, month), score, user, day)
                WITH CLUSTERING ORDER BY (score DESC, user ASC, day ASC)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Attempt to Alter the base table &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ALTER TABLE test.scores ALTER score TYPE blob
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the python driver we see the following exception returned from the server&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Ignoring schedule_unique &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; already-scheduled task: (&amp;lt;bound method ControlConnection.refresh_schema of &amp;lt;cassandra.cluster.ControlConnection object at 0x100f72c50&amp;gt;&amp;gt;, (), ((&lt;span class=&quot;code-quote&quot;&gt;&apos;keyspace&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&apos;target_type&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;KEYSPACE&apos;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&apos;change_type&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;UPDATED&apos;&lt;/span&gt;)))
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;stdin&amp;gt;&quot;&lt;/span&gt;, line 1, in &amp;lt;module&amp;gt;
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;./cassandra/cluster.py&quot;&lt;/span&gt;, line 1623, in execute
    result = &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.result()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;./cassandra/cluster.py&quot;&lt;/span&gt;, line 3205, in result
    raise self._final_exception
cassandra.protocol.ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).&quot;&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the server I see the following stack trace&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  [MigrationStage:1] 2015-09-30 11:45:47,457 ColumnFamilyStore.java:825 - Enqueuing flush of keyspaces: 512 (0%) on-heap, 0 (0%) off-heap
INFO  [MemtableFlushWriter:11] 2015-09-30 11:45:47,457 Memtable.java:362 - Writing Memtable-keyspaces@1714565887(0.146KiB serialized bytes, 1 ops, 0%/0% of on/off-heap limit)
INFO  [MemtableFlushWriter:11] 2015-09-30 11:45:47,463 Memtable.java:395 - Completed flushing /Users/gregbestland/.ccm/tests/node1/data/system_schema/keyspaces-abac5682dea631c5b535b3d6cffd0fb6/ma-54-big-Data.db (0.109KiB) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1443623481894, position=9812)
INFO  [MigrationStage:1] 2015-09-30 11:45:47,472 ColumnFamilyStore.java:825 - Enqueuing flush of columns: 877 (0%) on-heap, 0 (0%) off-heap
INFO  [MemtableFlushWriter:12] 2015-09-30 11:45:47,472 Memtable.java:362 - Writing Memtable-columns@771367282(0.182KiB serialized bytes, 1 ops, 0%/0% of on/off-heap limit)
INFO  [MemtableFlushWriter:12] 2015-09-30 11:45:47,478 Memtable.java:395 - Completed flushing /Users/gregbestland/.ccm/tests/node1/data/system_schema/columns-24101c25a2ae3af787c1b40ee1aca33f/ma-51-big-Data.db (0.107KiB) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1443623481894, position=9812)
INFO  [MigrationStage:1] 2015-09-30 11:45:47,490 ColumnFamilyStore.java:825 - Enqueuing flush of views: 2641 (0%) on-heap, 0 (0%) off-heap
INFO  [MemtableFlushWriter:11] 2015-09-30 11:45:47,490 Memtable.java:362 - Writing Memtable-views@1740452585(0.834KiB serialized bytes, 1 ops, 0%/0% of on/off-heap limit)
INFO  [MemtableFlushWriter:11] 2015-09-30 11:45:47,496 Memtable.java:395 - Completed flushing /Users/gregbestland/.ccm/tests/node1/data/system_schema/views-9786ac1cdd583201a7cdad556410c985/ma-22-big-Data.db (0.542KiB) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1443623481894, position=9812)
ERROR [MigrationStage:1] 2015-09-30 11:45:47,507 CassandraDaemon.java:195 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MigrationStage:1,5,main]
org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at org.apache.cassandra.config.CFMetaData.validateCompatility(CFMetaData.java:789) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:744) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:729) ~[main/:na]
	at org.apache.cassandra.config.Schema.updateView(Schema.java:677) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace$2.onUpdated(SchemaKeyspace.java:587) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.diffSchema(SchemaKeyspace.java:701) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeViews(SchemaKeyspace.java:573) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:515) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:481) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$1.runMayThrow(MigrationManager.java:502) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_45]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
ERROR [SharedPool-Worker-1] 2015-09-30 11:45:47,508 QueryMessage.java:128 - Unexpected error during query
java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:368) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:483) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announceViewUpdate(MigrationManager.java:389) ~[main/:na]
	at org.apache.cassandra.cql3.statements.AlterTableStatement.announceMigration(AlterTableStatement.java:359) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SchemaAlteringStatement.execute(SchemaAlteringStatement.java:93) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:205) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:236) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:221) ~[main/:na]
	at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:115) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:507) [main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:401) [main/:na]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_45]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
Caused by: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_45]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:364) ~[main/:na]
	... 18 common frames omitted
Caused by: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at org.apache.cassandra.config.CFMetaData.validateCompatility(CFMetaData.java:789) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:744) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:729) ~[main/:na]
	at org.apache.cassandra.config.Schema.updateView(Schema.java:677) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace$2.onUpdated(SchemaKeyspace.java:587) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.diffSchema(SchemaKeyspace.java:701) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeViews(SchemaKeyspace.java:573) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:515) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:481) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$1.runMayThrow(MigrationManager.java:502) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_45]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_45]
	... 1 common frames omitted
ERROR [SharedPool-Worker-1] 2015-09-30 11:45:47,508 ErrorMessage.java:336 - Unexpected exception during request
java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:368) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:483) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announceViewUpdate(MigrationManager.java:389) ~[main/:na]
	at org.apache.cassandra.cql3.statements.AlterTableStatement.announceMigration(AlterTableStatement.java:359) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SchemaAlteringStatement.execute(SchemaAlteringStatement.java:93) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:205) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:236) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:221) ~[main/:na]
	at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:115) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:507) [main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:401) [main/:na]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_45]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
Caused by: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_45]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:364) ~[main/:na]
	... 18 common frames omitted
Caused by: org.apache.cassandra.exceptions.ConfigurationException: Column family comparators &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match or are not compatible (found ClusteringComparator; expected ClusteringComparator).
	at org.apache.cassandra.config.CFMetaData.validateCompatility(CFMetaData.java:789) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:744) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:729) ~[main/:na]
	at org.apache.cassandra.config.Schema.updateView(Schema.java:677) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace$2.onUpdated(SchemaKeyspace.java:587) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.diffSchema(SchemaKeyspace.java:701) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeViews(SchemaKeyspace.java:573) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:515) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:481) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$1.runMayThrow(MigrationManager.java:502) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_45]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_45]
	... 1 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It would appear as though the base table column was migrated, as it now seems to be of type blob, but I&apos;m not sure internally what state its in.&lt;/p&gt;</description>
                <environment>&lt;p&gt;cassandra-3.0.0-rc1, with python driver 3.0-alpha&lt;/p&gt;</environment>
        <key id="12901636">CASSANDRA-10424</key>
            <summary>Altering base table column with materialized view causes unexpected server error.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlyeks">Carl Yeksigian</assignee>
                                    <reporter username="greg.bestland">Greg Bestland</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Sep 2015 16:54:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:54 +0000</updated>
                            <resolved>Thu, 8 Oct 2015 10:07:27 +0000</resolved>
                                        <fixVersion>3.0.0 rc2</fixVersion>
                                    <component>Feature/Materialized Views</component>
                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14937967" author="carlyeks" created="Wed, 30 Sep 2015 17:44:20 +0000"  >&lt;p&gt;This is caused by us not validating the changes that we are making to the view table.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed &lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/10424/3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a branch&lt;/a&gt; which validates the changes before applying them for all of the views and the base table.&lt;/p&gt;

&lt;p&gt;cassci: &lt;a href=&quot;http://cassci.datastax.com/job/carlyeks-ticket-10424-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 utest&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/carlyeks-ticket-10424-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 dtest&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/carlyeks-ticket-10424-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk utest&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/carlyeks-ticket-10424-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtest&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="14941184" author="slebresne" created="Fri, 2 Oct 2015 14:16:32 +0000"  >&lt;p&gt;We definitively should validate the changes to the view table, though what confuses me in that particular example is that it switches from &lt;tt&gt;text&lt;/tt&gt; to &lt;tt&gt;blob&lt;/tt&gt; and to the best of my knowledge, this should be a valid conversion, even for a clustering column (basically, &lt;tt&gt;BytesType.isCompatibleWith(UTF8Type) == true&lt;/tt&gt;). What am I missing?&lt;/p&gt;

&lt;p&gt;Otherwise, can you:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;add unit tests for this.&lt;/li&gt;
	&lt;li&gt;use that opportunity to fix the error message that was throw. &quot;found ClusteringComparator; expected ClusteringComparator&quot; is not very helpful.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14941376" author="carlyeks" created="Fri, 2 Oct 2015 16:50:25 +0000"  >&lt;p&gt;The cause is that the column is a reversed type, which &lt;tt&gt;isCompatibleWith&lt;/tt&gt; fails for. This happens with a normal CQL table as well, but we allow different clustering orders in the MV which is why this manifested itself here.&lt;/p&gt;

&lt;p&gt;Pushed a new commit to the branch which adds a few unit tests to test different alters on clustering columns and fixes the errors messages. We previously had normal alter tests as part of &lt;tt&gt;testAccessAndSchema&lt;/tt&gt;, but not ones that tested the reversed types. Changed the error message from alter to show whether the type is reversed or not.&lt;/p&gt;</comment>
                            <comment id="14941565" author="slebresne" created="Fri, 2 Oct 2015 18:55:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;The cause is that the column is a reversed type, which isCompatibleWith fails for.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, that make sense. Still, that&apos;s a bug, we shouldn&apos;t be failing that &lt;tt&gt;ALTER&lt;/tt&gt; since it&apos;s perfectly valid and there is not reason to not support it. The fact the user used a &lt;tt&gt;DESC&lt;/tt&gt; clustering order in its definition shouldn&apos;t prevent any type of altering. So what we should do, I think, is to detect that the type is reversed in the clustering and properly reverse the new type if so.&lt;/p&gt;</comment>
                            <comment id="14941742" author="carlyeks" created="Fri, 2 Oct 2015 20:53:38 +0000"  >&lt;p&gt;I&apos;ve pushed a fix for allowing &lt;tt&gt;ALTER&lt;/tt&gt; on reversed types, and added a test to show that it is now working.&lt;/p&gt;

&lt;p&gt;That also fixes the MV alter tests, since we&apos;re handling the cases of altering an MV type properly. It makes sense to keep the validation in there since we are calling different methods that might diverge over time, but right now there shouldn&apos;t be a case where we validate on the base table but not the view, I think. If there is, it&apos;d be good to add that as a test.&lt;/p&gt;</comment>
                            <comment id="14943005" author="slebresne" created="Mon, 5 Oct 2015 07:28:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;there shouldn&apos;t be a case where we validate on the base table but not the view, I think.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is, if the type we alter to is &quot;value-compatible&quot; with the old type but not &quot;compatible&quot; (that is, all values of the old type are valid for the new type, but the new type don&apos;t sort like the old one). In that case, altering the base table would be ok (since the column is not a clustering column), but altering the view wouldn&apos;t. An example of such transition is int -&amp;gt; blob. Can you add a test for that.&lt;/p&gt;

&lt;p&gt;Two other small remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In the &lt;tt&gt;ALTER TABLE&lt;/tt&gt; tests, there is this comment before every MV creation: &lt;tt&gt;// Cannot use SELECT &amp;#42;, as those are always handled by the includeAll shortcut in View.updateAffectsView&lt;/tt&gt;.  Could you explain how this has any impact on &lt;tt&gt;ALTER&lt;/tt&gt;? If it doesn&apos;t, then we should probably remove the comment and switch back to &lt;tt&gt;&amp;#42;&lt;/tt&gt; so no-one thinks there is something subtle. If it does make a difference, we should still test the &lt;tt&gt;&amp;#42;&lt;/tt&gt; case additionally since it should be working anyway.&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;AlterTableStatement.validateAlter&lt;/tt&gt;, I think we should revert the change to the error message relating to printing &lt;tt&gt;reversed(%s)&lt;/tt&gt;. That information makes not sense for a CQL3 user and there should be no reason to add it anyway since we silently add the &lt;tt&gt;ReversedType&lt;/tt&gt; if necessary.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14943622" author="carlyeks" created="Mon, 5 Oct 2015 16:36:47 +0000"  >&lt;p&gt;Pushed a new commit that addresses the latest comment.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added an int -&amp;gt; blob alter test&lt;/li&gt;
	&lt;li&gt;That was a bad copy-paste job, removed and switched back to *&lt;/li&gt;
	&lt;li&gt;Removed the &lt;tt&gt;reversed()&lt;/tt&gt; part of the text&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14948421" author="slebresne" created="Thu, 8 Oct 2015 10:07:27 +0000"  >&lt;p&gt;+1, committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mgp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332955">3.0.0 rc1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>