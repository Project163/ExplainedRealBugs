<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18366] Test failure: org.apache.cassandra.distributed.test.FailingRepairTest - testFailingMessage[VALIDATION_REQ/parallel/true]</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18366</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;First seen &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/928/workflows/f4e93a72-d4aa-47a2-996f-aa3fb018d848/jobs/16206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; this test times out for me consistently on both j8 and j11 where 4.1 and trunk do not.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13530031">CASSANDRA-18366</key>
            <summary>Test failure: org.apache.cassandra.distributed.test.FailingRepairTest - testFailingMessage[VALIDATION_REQ/parallel/true]</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djatnieks">dan jatnieks</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Mar 2023 19:45:08 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:39 +0000</updated>
                            <resolved>Mon, 4 Sep 2023 08:32:54 +0000</resolved>
                                        <fixVersion>4.0.12</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17704802" author="edimitrova" created="Fri, 24 Mar 2023 20:20:20 +0000"  >&lt;p&gt;Info for whoever assigns the ticket - Butler says it started failing with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18294&quot; title=&quot;die disk failure policy will not kill jvm as documented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18294&quot;&gt;&lt;del&gt;CASSANDRA-18294&lt;/del&gt;&lt;/a&gt;. I can see it also failing in the run posted on that ticket.&lt;br/&gt;
But I did not see it in the previous ticket runs &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18125&quot; title=&quot;Improve memtable allocator accounting when updating AtomicBTreePartition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18125&quot;&gt;&lt;del&gt;CASSANDRA-18125&lt;/del&gt;&lt;/a&gt;. So I guess possibly coming from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18294&quot; title=&quot;die disk failure policy will not kill jvm as documented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18294&quot;&gt;&lt;del&gt;CASSANDRA-18294&lt;/del&gt;&lt;/a&gt;, but it has to be confirmed with proper bisecting&lt;br/&gt;
CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17704809" author="smiklosovic" created="Fri, 24 Mar 2023 20:59:56 +0000"  >&lt;p&gt;That test class is parameterized. What is interesting is that if that test is run in isolation (or when test is parameterized once), that test passes.&lt;/p&gt;</comment>
                            <comment id="17704821" author="smiklosovic" created="Fri, 24 Mar 2023 21:29:10 +0000"  >&lt;p&gt;4.0 currently has this in DefaultFSErrorHandler&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleCorruptSSTable(CorruptSSTableException e)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!StorageService.instance.isDaemonSetupCompleted())
            handleStartupFSError(e);

        &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (DatabaseDescriptor.getDiskFailurePolicy())
        {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; die:
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; stop_paranoid:
                &lt;span class=&quot;code-comment&quot;&gt;// exception not logged here on purpose as it is already logged
&lt;/span&gt;                logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopping transports as disk_failure_policy is &quot;&lt;/span&gt; + DatabaseDescriptor.getDiskFailurePolicy());
                StorageService.instance.stopTransports();
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&quot;case: die&quot; was added in 18294.&lt;/p&gt;

&lt;p&gt;Now, when I remove this &quot;case die:&quot;, all tests pass. &lt;/p&gt;

&lt;p&gt;However, when I do this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleCorruptSSTable(CorruptSSTableException e)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!StorageService.instance.isDaemonSetupCompleted())
            handleStartupFSError(e);

        &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (DatabaseDescriptor.getDiskFailurePolicy())
        {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; die:
                &lt;span class=&quot;code-comment&quot;&gt;// exception not logged here on purpose as it is already logged
&lt;/span&gt;                logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopping transports as disk_failure_policy is &quot;&lt;/span&gt; + DatabaseDescriptor.getDiskFailurePolicy());
                StorageService.instance.stopTransports();
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; stop_paranoid:
                &lt;span class=&quot;code-comment&quot;&gt;// exception not logged here on purpose as it is already logged
&lt;/span&gt;                logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopping transports as disk_failure_policy is &quot;&lt;/span&gt; + DatabaseDescriptor.getDiskFailurePolicy());
                StorageService.instance.stopTransports();
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails again, obviously. Basically, when we hit &quot;die&quot; and we stop transports, for some unknow-yet reason, the code in FailingRepairTest which waits for this loops forever:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        IInvokableInstance replicaInstance = CLUSTER.get(replica);
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (replicaInstance.killAttempts() &amp;lt;= 0)
            Uninterruptibles.sleepUninterruptibly(50, TimeUnit.MILLISECONDS);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;EDIT:&lt;/p&gt;

&lt;p&gt;The next test fails because we stop the transports in the very first one when we hit &quot;die&quot;. Cluster is created statically so while the first test just passes fine, it will stop transports and then the second test prints:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 21:55:19 Repair 916278f0-ca8e-11ed-8125-8104d0e5c44e failed:
java.lang.RuntimeException: Endpoint not alive: /127.0.0.1:7012
	at org.apache.cassandra.service.ActiveRepairService.failRepair(ActiveRepairService.java:665)
	at org.apache.cassandra.service.ActiveRepairService.prepareForRepair(ActiveRepairService.java:597)
	at org.apache.cassandra.repair.RepairRunnable.prepare(RepairRunnable.java:393)
	at org.apache.cassandra.repair.RepairRunnable.runMayThrow(RepairRunnable.java:269)
	at org.apache.cassandra.repair.RepairRunnable.run(RepairRunnable.java:241)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:750)
ERROR [node2_Repair-Task:1] node2 2023-03-24 22:55:19,186 RepairRunnable.java:178 - Repair 916278f0-ca8e-11ed-8125-8104d0e5c44e failed:
java.lang.RuntimeException: Endpoint not alive: /127.0.0.1:7012
	at org.apache.cassandra.service.ActiveRepairService.failRepair(ActiveRepairService.java:665)
	at org.apache.cassandra.service.ActiveRepairService.prepareForRepair(ActiveRepairService.java:597)
	at org.apache.cassandra.repair.RepairRunnable.prepare(RepairRunnable.java:393)
	at org.apache.cassandra.repair.RepairRunnable.runMayThrow(RepairRunnable.java:269)
	at org.apache.cassandra.repair.RepairRunnable.run(RepairRunnable.java:241)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:750)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That seems like the transport is not available on the &quot;previously killed&quot; node so repair will fail to send repair messages hence nothing is killed so it keeps looping.&lt;/p&gt;

&lt;p&gt;There are some non-trivial changes in 4.1 in this test which patches other internal stuff, Instance, AbstractCluster .... bunch of internal services, just to accommodate this test. &lt;/p&gt;

&lt;p&gt;I tried to port it to 4.0 but no luck yet. I think we might also rewrite this test so cluster is created per test method instead of having it parameterized. &lt;/p&gt;</comment>
                            <comment id="17705432" author="smiklosovic" created="Mon, 27 Mar 2023 16:18:00 +0000"  >&lt;p&gt;I am not able to fix this. What I have is this: (1)&lt;/p&gt;

&lt;p&gt;In 4.0, the logic around &quot;catching exceptions&quot; is pretty much broken. This stuff (2) is not called at all. The problem is that when InstanceShutdown is thrown in InstanceKiller, it is actually never caught by anything. The patch in (1) locally passes 5 out of 6 tests, the last one always fails on &quot;OutOfMemory&quot;. It seems like we are not cleaning up after test is finished properly and it just crushes at the end on not enough memory.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/290c44a9fcc8270511ecf9e18b7c11dc4f891c47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/290c44a9fcc8270511ecf9e18b7c11dc4f891c47&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java#L149&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java#L149&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; any hint would be highly appreciated! I see you were touching some before / after  / waiting stuff lastly in this test in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15332&quot; title=&quot;When repair is running with tracing, if a CorruptSSTableException is thrown while building Merkle Trees the DiskFailurePolicy does not get applied&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15332&quot;&gt;&lt;del&gt;CASSANDRA-15332&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17116&quot; title=&quot;When streaming sees a ClosedChannelException this triggers the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17116&quot;&gt;&lt;del&gt;CASSANDRA-17116&lt;/del&gt;&lt;/a&gt; but it was never done to 4.0.&lt;/p&gt;</comment>
                            <comment id="17706444" author="brandon.williams" created="Wed, 29 Mar 2023 15:21:10 +0000"  >&lt;p&gt;It seems to me that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17116&quot; title=&quot;When streaming sees a ClosedChannelException this triggers the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17116&quot;&gt;&lt;del&gt;CASSANDRA-17116&lt;/del&gt;&lt;/a&gt; could be a contender with a sincever of 4.0 and fixver of 4.1, maybe it just never bit 4.0 until now.&lt;/p&gt;</comment>
                            <comment id="17719574" author="dcapwell" created="Fri, 5 May 2023 00:30:08 +0000"  >&lt;p&gt;sorry, just improved my filters and saw I was pinged....&lt;/p&gt;

&lt;p&gt;Double checking, is this ticket for the fact junit timed out the test, or that it is flakey in-general?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18366?focusedCommentId=17704821&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17704821&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-18366?focusedCommentId=17704821&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17704821&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; have not looked much at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18294&quot; title=&quot;die disk failure policy will not kill jvm as documented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18294&quot;&gt;&lt;del&gt;CASSANDRA-18294&lt;/del&gt;&lt;/a&gt;, but &quot;die&quot; should kill the jvm, stopping messaging is the wrong behavior...  I thought we even test that this happens in jvm-dtest (we mock out how instances die and make sure that they do try...).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It fails again, obviously. Basically, when we hit &quot;die&quot; and we stop transports, for some unknow-yet reason, the code in FailingRepairTest which waits for this loops forever:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;git says I replaced this behavior in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17116&quot; title=&quot;When streaming sees a ClosedChannelException this triggers the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17116&quot;&gt;&lt;del&gt;CASSANDRA-17116&lt;/del&gt;&lt;/a&gt;, and that I use isShutdown and not replicaInstance.killAttempts... I don&apos;t know why I made this change, it actually feels wrong as the test causes a sstable to be corrupted, and the policy is &quot;die&quot;... so we just stopped validating that the die policy was properly handled?  If I look at org.apache.cassandra.service.DefaultFSErrorHandler#handleCorruptSSTable this isn&apos;t where we handle die, so not sure why &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18294&quot; title=&quot;die disk failure policy will not kill jvm as documented&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18294&quot;&gt;&lt;del&gt;CASSANDRA-18294&lt;/del&gt;&lt;/a&gt; changed that... we handle die in org.apache.cassandra.utils.JVMStabilityInspector#inspectThrowable(java.lang.Throwable, java.util.function.Consumer&amp;lt;java.lang.Throwable&amp;gt;)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (DatabaseDescriptor.getDiskFailurePolicy() == Config.DiskFailurePolicy.die)
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FSError || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CorruptSSTableException)
                isUnstable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

        &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file handle exhaustion
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FileNotFoundException || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FileSystemException || t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SocketException)
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t.getMessage() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; t.getMessage().contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;Too many open files&quot;&lt;/span&gt;))
                isUnstable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isUnstable)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!StorageService.instance.isDaemonSetupCompleted())
                FileUtils.handleStartupFSError(t);
            killer.killCurrentJVM(t);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Now, if the issue is not that the tests are failing and just that we keep timing out... I sadly feel the best solution is to do what we always do (sigh)... split the test cross different class files....&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Parameters(name = &lt;span class=&quot;code-quote&quot;&gt;&quot;{0}/{1}/{2}&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; messages()
    {
        List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; tests = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (RepairParallelism parallelism : RepairParallelism.values())
        {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; withTracing : Arrays.asList(&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.FALSE))
            {
                tests.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]{ Verb.VALIDATION_REQ, parallelism, withTracing, failingReaders(Verb.VALIDATION_REQ, parallelism, withTracing) });
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; tests;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is 3 * 2 = 6 tests... we prob want to split it at the RepairParallelism level so we have 3 top level tests that do 2 different cases (w/, and w/o tracing)&lt;/p&gt;
</comment>
                            <comment id="17719901" author="brandon.williams" created="Fri, 5 May 2023 14:57:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;Double checking, is this ticket for the fact junit timed out the test, or that it is flakey in-general?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For me at least, it seems to time out every time.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I sadly feel the best solution is to do what we always do (sigh)... split the test cross different class files....&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That sounds like a solution to me too.&lt;/p&gt;</comment>
                            <comment id="17761371" author="djatnieks" created="Fri, 1 Sep 2023 18:23:36 +0000"  >&lt;p&gt;I ran into this issue and found that when &lt;tt&gt;DefaultFSErrorHandler&lt;/tt&gt; handles &lt;tt&gt;die&lt;/tt&gt; it stops transports, including gossip. When the next test starts, gossip isn&apos;t running and the test hangs. The solution I found is to make sure gossip is started before starting each test.&lt;/p&gt;

&lt;p&gt;Here is a &lt;a href=&quot;https://github.com/apache/cassandra/pull/2659&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0 PR  &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17761376" author="brandon.williams" created="Fri, 1 Sep 2023 18:46:05 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-18366-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1258/workflows/c6824217-6d65-403a-aca7-6a12468a4cfb/jobs/50100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8-repeat&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1258/workflows/d2cfc387-51fb-4725-b14a-daa682b29b8c/jobs/50099&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11-repeat&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Do you know why this wasn&apos;t a problem on 4.1 or later?&lt;/p&gt;</comment>
                            <comment id="17761382" author="brandon.williams" created="Fri, 1 Sep 2023 19:17:27 +0000"  >&lt;p&gt;+1 from me&lt;/p&gt;</comment>
                            <comment id="17761384" author="djatnieks" created="Fri, 1 Sep 2023 19:27:50 +0000"  >&lt;p&gt;&amp;gt; Do you know why this wasn&apos;t a problem on 4.1 or later?&lt;/p&gt;

&lt;p&gt;tbh, I hadn&apos;t checked, but now that I take a look at the 4.1 version of &lt;tt&gt;FailingRepairTest&lt;/tt&gt;, I see a similar change there:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/20125c5053586ab46fa341ac71cc525b64932873/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java#L169-L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/20125c5053586ab46fa341ac71cc525b64932873/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java#L169-L172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s better to port that change back to 4.0 to keep things consistent?&lt;/p&gt;</comment>
                            <comment id="17761387" author="brandon.williams" created="Fri, 1 Sep 2023 19:31:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe it&apos;s better to port that change back to 4.0 to keep things consistent?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to that&lt;/p&gt;</comment>
                            <comment id="17761389" author="djatnieks" created="Fri, 1 Sep 2023 19:39:54 +0000"  >&lt;p&gt;Ok, I&apos;ll do that and submit a new PR.&lt;/p&gt;
</comment>
                            <comment id="17761408" author="djatnieks" created="Fri, 1 Sep 2023 22:31:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;the 4.1 version of FailingRepairTest, I see a similar change there:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/20125c5053586ab46fa341ac71cc525b64932873/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java#L169-L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/20125c5053586ab46fa341ac71cc525b64932873/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java#L169-L172&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s better to port that change back to 4.0 to keep things consistent?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Well, just porting that one change to &lt;tt&gt;FailingRepairTest&lt;/tt&gt; isn&apos;t going to work. It was part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17116&quot; title=&quot;When streaming sees a ClosedChannelException this triggers the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17116&quot;&gt;&lt;del&gt;CASSANDRA-17116&lt;/del&gt;&lt;/a&gt; which also added code to have the &lt;tt&gt;InstanceKiller&lt;/tt&gt; shutdown the instance when &lt;tt&gt;killCurrentJVM&lt;/tt&gt; is called.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/20125c5053586ab46fa341ac71cc525b64932873/test/distributed/org/apache/cassandra/distributed/impl/Instance.java#L683&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/20125c5053586ab46fa341ac71cc525b64932873/test/distributed/org/apache/cassandra/distributed/impl/Instance.java#L683&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Since that&apos;s not in 4.0, the instance is not shutdown, and porting just that change to &lt;tt&gt;FailingRepairTest&lt;/tt&gt; from 4.1 doesn&apos;t fix the test.&lt;/p&gt;

&lt;p&gt;So, unless we want to port all of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17116&quot; title=&quot;When streaming sees a ClosedChannelException this triggers the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17116&quot;&gt;&lt;del&gt;CASSANDRA-17116&lt;/del&gt;&lt;/a&gt; back to 4.0, the original change I proposed that just re-starts gossip should be okay for 4.0.&lt;/p&gt;
</comment>
                            <comment id="17761411" author="brandon.williams" created="Fri, 1 Sep 2023 23:03:30 +0000"  >&lt;p&gt;Alright, we&apos;ll stick with your original patch.&lt;/p&gt;</comment>
                            <comment id="17761719" author="smiklosovic" created="Mon, 4 Sep 2023 07:46:10 +0000"  >&lt;p&gt;Yes, there were quite a non-trivial changes introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17116&quot; title=&quot;When streaming sees a ClosedChannelException this triggers the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17116&quot;&gt;&lt;del&gt;CASSANDRA-17116&lt;/del&gt;&lt;/a&gt; which are not so straightforward to backport into 4.0 I think that if the current solution works, lets just ship it to 4.0.&lt;/p&gt;

&lt;p&gt;I see that the multiplexer was already run, so I am +1 on this.&lt;/p&gt;</comment>
                            <comment id="17761736" author="smiklosovic" created="Mon, 4 Sep 2023 08:32:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt; thank you for looking into this&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[djatnieks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1guds:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12352452">4.0.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/0b7310c010b84e5eefeb42057725d1da05a4e9cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/0b7310c010b84e5eefeb42057725d1da05a4e9cd&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Started CircleCI pre-commit tests here (w/limited resources):&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/djatnieks/cassandra?branch=CASSANDRA-18366&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/djatnieks/cassandra?branch=CASSANDRA-18366&lt;/a&gt;&lt;/p&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>