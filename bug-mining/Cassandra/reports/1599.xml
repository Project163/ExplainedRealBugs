<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4205] SSTables are not updated with max timestamp on upgradesstables/compaction leading to non-optimal performance.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4205</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We upgraded from 0.7.9 to 1.0.7 on a cluster with a heavy update load. After converting all the reads to named column reads instead of get_slice calls, we noticed that we still weren&apos;t getting the performance improvements implemented in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2498&quot; title=&quot;Improve read performance in update-intensive workload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2498&quot;&gt;&lt;del&gt;CASSANDRA-2498&lt;/del&gt;&lt;/a&gt;. A single named column read was still touching multiple SSTables according to nodetool cfhistograms. &lt;/p&gt;

&lt;p&gt;To verify whether or not this was a reporting issue or a real issue, we ran multiple tests with stress and noticed that it worked as expected. After changing stress so that it ran the read/write test directly in the CF having issues (3 times stress &amp;amp; flush), we noticed that stress also touched multiple SSTables (according to cfhistograms).&lt;/p&gt;

&lt;p&gt;So, the root of the problem is &quot;something&quot; left over from our pre-1.0 days. All SSTables were upgraded with upgradesstables, and have been written and compacted many times since the upgrade (4 months ago). The usage pattern for this CF is that it is constantly read and updated (overwritten), but no deletes. &lt;/p&gt;

&lt;p&gt;After discussing the problem with Brandon Williams on #cassandra, it seems the problem might be because a max timestamp has never been written for the old SSTables that were upgraded from pre 1.0. They have only been compacted, and the max timestamp is not recorded during compactions. &lt;/p&gt;

&lt;p&gt;A suggested fix is to special case this in upgradesstables so that a max timestamp always exists for all SSTables. &lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;06:08 &amp;lt; driftx&amp;gt; thorkild_: tx.  The thing is we don&apos;t record the max timestamp on compactions, but we can do it specially for upgradesstables.&lt;br/&gt;
06:08 &amp;lt; driftx&amp;gt; so, nothing in... nothing out.&lt;br/&gt;
06:10 &amp;lt; thorkild_&amp;gt; driftx: ah, so when you upgrade from before the metadata was written, and that data is only feed through upgradesstables and compactions -&amp;gt; never properly written?&lt;br/&gt;
06:10 &amp;lt; thorkild_&amp;gt; that makes sense.&lt;br/&gt;
06:11 &amp;lt; driftx&amp;gt; right, we never create it, we just reuse it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12553450">CASSANDRA-4205</key>
            <summary>SSTables are not updated with max timestamp on upgradesstables/compaction leading to non-optimal performance.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="thorkild">Thorkild Stray </reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 May 2012 04:26:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:34 +0000</updated>
                            <resolved>Thu, 3 May 2012 23:04:39 +0000</resolved>
                                        <fixVersion>1.0.10</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13266621" author="jbellis" created="Wed, 2 May 2012 15:05:58 +0000"  >&lt;p&gt;We have a related but more serious bug, as noted by Sam Tunnicliffe in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4116&quot; title=&quot;check most recent TS values in SSTables when a row tombstone has already been encountered&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4116&quot;&gt;&lt;del&gt;CASSANDRA-4116&lt;/del&gt;&lt;/a&gt;: CF.maxTimestamp isn&apos;t including row tombstones.  This can result in incorrect results being returned by the collationcontroller code.&lt;/p&gt;</comment>
                            <comment id="13266705" author="jbellis" created="Wed, 2 May 2012 16:55:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;A suggested fix is to special case this in upgradesstables so that a max timestamp always exists for all SSTables. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Looking at the code, scrub and upgradesstables and user-defined compactions all force deserialize + maxtimestamp computation.  The only operation that does not is cleanup.&lt;/p&gt;</comment>
                            <comment id="13266712" author="jbellis" created="Wed, 2 May 2012 17:06:38 +0000"  >&lt;p&gt;patch to add version hd indicating row tombstones have been computed correctly&lt;/p&gt;</comment>
                            <comment id="13266746" author="brandon.williams" created="Wed, 2 May 2012 17:36:29 +0000"  >&lt;p&gt;I can reproduce, upgrading from 0.7 to 1.0 and running upgradesstables afterward.&lt;/p&gt;</comment>
                            <comment id="13266855" author="jbellis" created="Wed, 2 May 2012 19:38:39 +0000"  >&lt;p&gt;Checked Brandon&apos;s sstables with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4211&quot; title=&quot;Add sstablemetadata debugging tool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4211&quot;&gt;&lt;del&gt;CASSANDRA-4211&lt;/del&gt;&lt;/a&gt;.  One had a max timestamp of 1335979912016 after upgradesstables, the other 1335979951175.  cfhistograms showed about 20% of reads hit both sstables.&lt;/p&gt;

&lt;p&gt;This sounds about right; it&apos;s reasonable that the sstable w/ higher max timestamp, will contain &lt;b&gt;some&lt;/b&gt; rows w/ actually an older version than the other sstable&apos;s max.  The &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2498&quot; title=&quot;Improve read performance in update-intensive workload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2498&quot;&gt;&lt;del&gt;CASSANDRA-2498&lt;/del&gt;&lt;/a&gt; approach will always start with the newer sstable, but it will only skip the older one if the first-seen version of the columns requested have a timestamp newer than the max on the older sstable.&lt;/p&gt;

&lt;p&gt;So, I think there is no bug here related to upgraded timestamps, it just isn&apos;t a magic bullet to prevent all multiple sstable reads.&lt;/p&gt;

&lt;p&gt;The patch for creating a new version to represent &quot;we have &lt;b&gt;correct&lt;/b&gt; timestamps including row tombstones&quot; is still relevant, though.&lt;/p&gt;</comment>
                            <comment id="13267690" author="yukim" created="Thu, 3 May 2012 18:58:51 +0000"  >&lt;p&gt;Jonathan,&lt;/p&gt;

&lt;p&gt;Re: patch, you have to bump up CURRENT_VERSION to &quot;hd&quot; but otherwise looking good to me.&lt;/p&gt;</comment>
                            <comment id="13267923" author="jbellis" created="Thu, 3 May 2012 23:04:39 +0000"  >&lt;p&gt;good catch, committed w/ current version fix&lt;/p&gt;</comment>
                            <comment id="13268115" author="thorkild" created="Fri, 4 May 2012 04:24:04 +0000"  >&lt;p&gt;The original description is wrong (as we now know). Backporting the tool from 4211 and testing shows that the SSTables do indeed have the correct settings, and everything is updated correctly during the various compaction/upgradesstables etc.&lt;/p&gt;

&lt;p&gt;After further debugging I found that the reason why I was hitting all the SSTables was due to the CollationController falling back to calling collectAllData(). This was due to the filter not being an instance of NamesQueryFilter:&lt;/p&gt;


&lt;p&gt;CollationController.java:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
public ColumnFamily getTopLevelColumns()
    {
        return filter.filter instanceof NamesQueryFilter
               &amp;amp;&amp;amp; (cfs.metadata.cfType == ColumnFamilyType.Standard || filter.path.superColumnName != null)
               &amp;amp;&amp;amp; cfs.metadata.getDefaultValidator() != CounterColumnType.instance
               ? collectTimeOrderedData()
               : collectAllData();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This makes sense, but I struggled to find out why that happened on some CFs, and not on other. After tracing it, I found that the trigger is whether or not the CF has the row-cache enabled. If the row-cache is enabled, ColumnFamilyStore.cacheRow(..) is called, and if you then get a cache-miss, it&apos;ll end up calling CoumnFamilyStore.getTopLevelColumns(...), which again creates a new CollationController with an IdentityFilter filter as argument, and thus end up using collectAllData().&lt;/p&gt;

&lt;p&gt;In our case, we have a lot of cache-misses since the update frequency is so high and often we only read an entry once before it is replaced. &lt;/p&gt;

&lt;p&gt;Testing with &apos;stress&apos; before and after showed it moved from using all sstables for every query, to 100% reads satisfied with a single SSTable read (according to cfhistograms).&lt;/p&gt;

&lt;p&gt;I tested a preliminary configuration with row-cache in production, and it looked like a lot more of the queries were served by a single sstable. We still have stragglers using more, but that can easily be because of the randomization size-tiered compaction will lead to in this case. &lt;/p&gt;

&lt;p&gt;I don&apos;t see an easy way to fix this properly, though, without changing the row cache to be a row+filter cache (covered by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1956&quot; title=&quot;Convert row cache to row+filter cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1956&quot;&gt;&lt;del&gt;CASSANDRA-1956&lt;/del&gt;&lt;/a&gt; it seems). Since you need to load the whole row into the row cache, you can&apos;t use named columns. &lt;/p&gt;</comment>
                            <comment id="13268436" author="jbellis" created="Fri, 4 May 2012 15:16:38 +0000"  >&lt;p&gt;Thanks for following up, Thorkild.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525327" name="4205.txt" size="3070" author="jbellis" created="Wed, 2 May 2012 17:06:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237612</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gt7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96164</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>