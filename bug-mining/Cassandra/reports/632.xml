<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:18:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1463] Failed bootstrap can cause NPE in batch_mutate on every node, taking down the entire cluster</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1463</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In adding a node to the cluster, the bootstrap failed (still investigating the cause). An hour later, the entire cluster failed, preventing any writes from being accepted. This exception started being printed to the logs:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Timer-0&amp;#93;&lt;/span&gt; 2010-09-03 12:23:33,282 Gossiper.java (line 402) FatClient /10.251.243.191 has been silent for 3600000ms, removing from gossip&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Timer-0&amp;#93;&lt;/span&gt; 2010-09-03 12:23:33,318 Gossiper.java (line 99) Gossip error&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.Hashtable$Enumerator.next(Hashtable.java:1048)&lt;br/&gt;
        at org.apache.cassandra.gms.Gossiper.doStatusCheck(Gossiper.java:383)&lt;br/&gt;
        at org.apache.cassandra.gms.Gossiper$GossipTimerTask.run(Gossiper.java:93)&lt;br/&gt;
        at java.util.TimerThread.mainLoop(Timer.java:534)&lt;br/&gt;
        at java.util.TimerThread.run(Timer.java:484)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-69153&amp;#93;&lt;/span&gt; 2010-09-03 12:23:33,857 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.cassandra.gms.FailureDetector.isAlive(FailureDetector.java:135)&lt;br/&gt;
        at org.apache.cassandra.locator.AbstractReplicationStrategy.getHintedEndpoints(AbstractReplicationStrategy.java:85)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy.mutateBlocking(StorageProxy.java:204)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.batch_mutate(CassandraServer.java:415)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$batch_mutate.process(Cassandra.java:1651)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.java:1166)&lt;br/&gt;
        at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:167)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-69154&amp;#93;&lt;/span&gt; 2010-09-03 12:23:33,869 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.cassandra.gms.FailureDetector.isAlive(FailureDetector.java:135)&lt;br/&gt;
        at org.apache.cassandra.locator.AbstractReplicationStrategy.getHintedEndpoints(AbstractReplicationStrategy.java:85)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy.mutateBlocking(StorageProxy.java:204)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.batch_mutate(CassandraServer.java:415)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$batch_mutate.process(Cassandra.java:1651)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.java:1166)&lt;br/&gt;
        at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:167)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;After a large number of iterations of that (at least thousands), the printed exception was shortened (this shortening is what made me mistakenly file #1462) to&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-68869&amp;#93;&lt;/span&gt; 2010-09-03 12:39:22,857 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-68869&amp;#93;&lt;/span&gt; 2010-09-03 12:39:22,883 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-68869&amp;#93;&lt;/span&gt; 2010-09-03 12:39:22,894 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-68970&amp;#93;&lt;/span&gt; 2010-09-03 12:39:22,985 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-68970&amp;#93;&lt;/span&gt; 2010-09-03 12:39:23,084 Cassandra.java (line 1659) Internal error processing batch_mutate&lt;br/&gt;
java.lang.NullPointerException&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Rolling a restart over the cluster fixed it, but every node had to be restarted before it started accepting writes again.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12473282">CASSANDRA-1463</key>
            <summary>Failed bootstrap can cause NPE in batch_mutate on every node, taking down the entire cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="ketralnis">David King</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Sep 2010 20:50:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:17 +0000</updated>
                            <resolved>Sat, 4 Sep 2010 20:34:19 +0000</resolved>
                                        <fixVersion>0.6.6</fixVersion>
                    <fixVersion>0.7 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12906087" author="brandon.williams" created="Fri, 3 Sep 2010 20:56:12 +0000"  >&lt;p&gt;Fixed in 0.7 by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-757&quot; title=&quot;FatClient removal causes ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-757&quot;&gt;&lt;del&gt;CASSANDRA-757&lt;/del&gt;&lt;/a&gt;, but the approach we took for 0.6 was &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1289&quot; title=&quot;GossipTimerTask stops running if an Exception occurs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1289&quot;&gt;&lt;del&gt;CASSANDRA-1289&lt;/del&gt;&lt;/a&gt;.  My guess is so many batch_mutate errors were being logged, logging consumed all the cpu before the gossiper timer could run again, which would have solved it.  I&apos;m not sure how to solve this in 0.6 in a less invasive way than the 0.7 approach.&lt;/p&gt;</comment>
                            <comment id="12906097" author="jbellis" created="Fri, 3 Sep 2010 21:10:22 +0000"  >&lt;p&gt;the CME is a red herring, the real problem is the NPE (caused by the IP being cleared out of the gossip records as indicated in the log, but not out of the pending ranges)&lt;/p&gt;

&lt;p&gt;attached patch should fix the NPE, looking at how much of a bitch it would be to fix the root cause (the PR orphan)&lt;/p&gt;</comment>
                            <comment id="12906213" author="jbellis" created="Sat, 4 Sep 2010 03:30:38 +0000"  >&lt;p&gt;v2 adds an onRemove callback to the gossiper interface, to do the remove from TokenMetadata.&lt;/p&gt;</comment>
                            <comment id="12906214" author="jbellis" created="Sat, 4 Sep 2010 03:31:29 +0000"  >&lt;p&gt;patch is against 0.6, i will handle rebase to 0.7 afterwards&lt;/p&gt;</comment>
                            <comment id="12906218" author="brandon.williams" created="Sat, 4 Sep 2010 04:01:04 +0000"  >&lt;p&gt;v2 fails to compile:     &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; /srv/cassandra/src/java/org/apache/cassandra/service/StorageLoadBalancer.java:49: org.apache.cassandra.service.StorageLoadBalancer is not abstract and does not override abstract method onRemove(java.net.InetAddress) in org.apache.cassandra.gms.IEndPointStateChangeSubscriber&lt;/p&gt;</comment>
                            <comment id="12906219" author="jbellis" created="Sat, 4 Sep 2010 04:14:51 +0000"  >&lt;p&gt;corrected v2.  (is it just me or is &quot;ant&quot; w/o &quot;clean&quot; getting worse at dependency discovery as we add more classes?)&lt;/p&gt;</comment>
                            <comment id="12906225" author="brandon.williams" created="Sat, 4 Sep 2010 05:32:30 +0000"  >&lt;p&gt;v2 produces this:&lt;/p&gt;


&lt;p&gt; INFO 05:26:36,245 FatClient /10.179.65.102 has been silent for 3600000ms, removing from gossip&lt;br/&gt;
ERROR 05:26:36,247 Uncaught exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Timer-0,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
        at org.apache.cassandra.locator.TokenMetadata.removeEndpoint(TokenMetadata.java:192)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.onRemove(StorageService.java:879)&lt;br/&gt;
        at org.apache.cassandra.gms.Gossiper.removeEndPoint(Gossiper.java:221)&lt;br/&gt;
        at org.apache.cassandra.gms.Gossiper.doStatusCheck(Gossiper.java:407)&lt;br/&gt;
        at org.apache.cassandra.gms.Gossiper$GossipTimerTask.run(Gossiper.java:93)&lt;br/&gt;
        at java.util.TimerThread.mainLoop(Timer.java:534)&lt;br/&gt;
        at java.util.TimerThread.run(Timer.java:484)&lt;/p&gt;

&lt;p&gt;But that is all I see, with constant insert pressure.&lt;/p&gt;</comment>
                            <comment id="12906248" author="jbellis" created="Sat, 4 Sep 2010 15:02:51 +0000"  >&lt;p&gt;v3 removes obsolete assertion and adds call to calculatePendingRanges in onRemove.&lt;/p&gt;</comment>
                            <comment id="12906269" author="brandon.williams" created="Sat, 4 Sep 2010 18:28:10 +0000"  >&lt;p&gt;Looks good now. +1&lt;/p&gt;</comment>
                            <comment id="12906285" author="jbellis" created="Sat, 4 Sep 2010 20:34:19 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12975379" author="hudson" created="Mon, 27 Dec 2010 23:30:11 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #121 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/121/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/121/&lt;/a&gt;)&lt;br/&gt;
    Java-based stress util.  Patch by Pavel Yaskevich, reviewed by&lt;br/&gt;
brandonwilliams for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1463&quot; title=&quot;Failed bootstrap can cause NPE in batch_mutate on every node, taking down the entire cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1463&quot;&gt;&lt;del&gt;CASSANDRA-1463&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12453859" name="1463-v2.txt" size="3950" author="jbellis" created="Sat, 4 Sep 2010 04:14:51 +0000"/>
                            <attachment id="12453867" name="1463-v3.txt" size="5021" author="jbellis" created="Sat, 4 Sep 2010 15:02:51 +0000"/>
                            <attachment id="12453827" name="1463.txt" size="631" author="jbellis" created="Fri, 3 Sep 2010 21:10:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20154</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g57r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92275</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>