<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13216] testall failure in org.apache.cassandra.net.MessagingServiceTest.testDroppedMessages</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13216</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-3.11_testall/81/testReport/org.apache.cassandra.net/MessagingServiceTest/testDroppedMessages&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-3.11_testall/81/testReport/org.apache.cassandra.net/MessagingServiceTest/testDroppedMessages&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Error Message

expected:&amp;lt;... dropped latency: 27[30 ms and Mean cross-node dropped latency: 2731] ms&amp;gt; but was:&amp;lt;... dropped latency: 27[28 ms and Mean cross-node dropped latency: 2730] ms&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stacktrace

junit.framework.AssertionFailedError: expected:&amp;lt;... dropped latency: 27[30 ms and Mean cross-node dropped latency: 2731] ms&amp;gt; but was:&amp;lt;... dropped latency: 27[28 ms and Mean cross-node dropped latency: 2730] ms&amp;gt;
	at org.apache.cassandra.net.MessagingServiceTest.testDroppedMessages(MessagingServiceTest.java:83)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13042588">CASSANDRA-13216</key>
            <summary>testall failure in org.apache.cassandra.net.MessagingServiceTest.testDroppedMessages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="sean.mccarthy">Sean McCarthy</reporter>
                        <labels>
                            <label>test-failure</label>
                            <label>testall</label>
                    </labels>
                <created>Mon, 13 Feb 2017 14:51:43 +0000</created>
                <updated>Fri, 15 May 2020 08:02:37 +0000</updated>
                            <resolved>Tue, 13 Jun 2017 09:27:56 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15871587" author="ifesdjeen" created="Fri, 17 Feb 2017 10:08:43 +0000"  >&lt;p&gt;Problem is that when the test is running subsequently or there was some test that has already modified values of dropped messages metrics, since they&apos;re stored in mbean, they&apos;ll still be retrieved. &lt;/p&gt;

&lt;p&gt;For example, on the subsequent run we&apos;d get the following metrics: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; {READ=7500, RANGE_SLICE=7500... }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead, we should have just gotten 0es. &lt;/p&gt;

&lt;p&gt;Unfortunately, dropwizard metrics does not give any simple mechanism for resetting the metrics. The path of least resistance I&apos;ve currently found is just to assign a unique name to the scope while testing the metrics that have to be test-unique and resettable.&lt;/p&gt;</comment>
                            <comment id="15896850" author="ifesdjeen" created="Mon, 6 Mar 2017 07:49:23 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15904461" author="mkjellman" created="Fri, 10 Mar 2017 05:23:50 +0000"  >&lt;p&gt;who&apos;s reviewing this? would be great to get all our tests passing on trunk! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; I agree this seems like a reasonable approach because MessagingService is a singleton and we can&apos;t reset most of the metrics core objects.... without any other ideas on this i&apos;m +1 on alex&apos;s commit.&lt;/p&gt;</comment>
                            <comment id="15905182" author="jasobrown" created="Fri, 10 Mar 2017 14:35:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman&quot; class=&quot;user-hover&quot; rel=&quot;mkjellman&quot;&gt;mkjellman&lt;/a&gt; Looks like you are reviewing it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I&apos;ll give this look over, as well.&lt;/p&gt;</comment>
                            <comment id="15905190" author="jasobrown" created="Fri, 10 Mar 2017 14:39:48 +0000"  >&lt;p&gt;OK, looked it over, and I&apos;m +1, as well.&lt;/p&gt;</comment>
                            <comment id="15930848" author="jjirsa" created="Fri, 17 Mar 2017 22:44:32 +0000"  >&lt;p&gt;Since this was routinely breaking unit tests, I&apos;ve gone ahead and committed it as &lt;tt&gt;1dcb3131a4d7417634551456f1fe3f519fa17fd0&lt;/tt&gt; . Hope nobody minds.&lt;/p&gt;</comment>
                            <comment id="15945273" author="mshuler" created="Tue, 28 Mar 2017 14:32:53 +0000"  >&lt;p&gt;Reopening, since this was so recent. Trunk run that just finished recently shows a similar error on&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/trunk_testall/1477/testReport/org.apache.cassandra.net/MessagingServiceTest/testDroppedMessages_compression/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_testall/1477/testReport/org.apache.cassandra.net/MessagingServiceTest/testDroppedMessages_compression/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error Message

expected:&amp;lt;...dropped latency: 227[8] ms&amp;gt; but was:&amp;lt;...dropped latency: 227[7] ms&amp;gt;
Stacktrace

junit.framework.AssertionFailedError: expected:&amp;lt;...dropped latency: 227[8] ms&amp;gt; but was:&amp;lt;...dropped latency: 227[7] ms&amp;gt;
	at org.apache.cassandra.net.MessagingServiceTest.testDroppedMessages(MessagingServiceTest.java:114)
Standard Output

ERROR [main] 2017-03-28 11:07:24,199 SubstituteLogger.java:250 - SLF4J: stderr
INFO  [main] 2017-03-28 11:07:24,668 YamlConfigurationLoader.java:89 - Configuration location: file:/home/automaton/cassandra/test/conf/cassandra.yaml
DEBUG [main] 2017-03-28 11:07:24,669 YamlConfigurationLoader.java:108 - Loading settings from file:/home/automaton/cassandra/test/conf/cassandra.yaml
INFO  [main] 2017-03-28 11:07:25,547 Config.java:446 - Node configuration:[allocate_tokens_for_keyspace=null; authentica
...[truncated 10545 chars]...
close for /127.0.0.250
DEBUG [main] 2017-03-28 11:07:28,551 MessagingService.java:698 - Not resetting pool for /127.0.0.250 because internode authenticator said not to connect
DEBUG [main] 2017-03-28 11:07:28,583 OutboundTcpConnection.java:184 - Enqueuing socket close for /127.0.0.2
DEBUG [main] 2017-03-28 11:07:28,583 OutboundTcpConnection.java:184 - Enqueuing socket close for /127.0.0.2
DEBUG [main] 2017-03-28 11:07:28,584 OutboundTcpConnection.java:184 - Enqueuing socket close for /127.0.0.2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15945277" author="mshuler" created="Tue, 28 Mar 2017 14:34:18 +0000"  >&lt;p&gt;new log from above attached&lt;/p&gt;</comment>
                            <comment id="15946966" author="ifesdjeen" created="Wed, 29 Mar 2017 11:43:52 +0000"  >&lt;p&gt;This is extremely weird. I&apos;ve ran the test 100 times &lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-trunk-testall/lastCompletedBuild/consoleFull&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and it passed every time. Checked for the interference (by ensuring that each test class is running in it&apos;s own forked JVM), and confirmed it (by outputting and comparing PIDs of the processes in the log files). I&apos;ve checked for possible races / reordering and could not find any problem so far. Looks like we can only reproduce this issue when running a full test suite, not an individual test.&lt;/p&gt;</comment>
                            <comment id="15947038" author="ifesdjeen" created="Wed, 29 Mar 2017 12:39:33 +0000"  >&lt;p&gt;Found the problem. I didn&apos;t anticipate initially that this test is time-dependent. The initial fix is still applicable. It&apos;s reproducible quite easily by adding a &lt;tt&gt;sleep&lt;/tt&gt; of as few as 100 milliseconds around &lt;a href=&quot;https://github.com/apache/cassandra/blob/732d1af866b91e5ba63e7e2a467d99d4cb90e11f/test/unit/org/apache/cassandra/net/MessagingServiceTest.java#L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. YMMV with an exact sleep number. &lt;/p&gt;

&lt;p&gt;However, I do not think there&apos;s any way we can reliably fetch latency numbers, since dropwizard metrics reservoirs (used within &lt;a href=&quot;https://github.com/dropwizard/metrics/blob/15dde825de1843927898a7ad3c3bb11b2913a931/metrics-core/src/main/java/com/codahale/metrics/Timer.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;timers&lt;/a&gt; are tracking real time, and snapshots we&apos;re doing (however precise) won&apos;t ever be perfect. I&apos;ve mocked the clock:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-followup-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-followup-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;3.0 branch is not susceptible to this problem, since we use time-independent &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/metrics/DroppedMessageMetrics.java#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Meter&lt;/a&gt; instead of timer there.&lt;br/&gt;
Let&apos;s wait for 24 hours, I&apos;ve put the utest on retry.&lt;/p&gt;</comment>
                            <comment id="15948652" author="ifesdjeen" created="Thu, 30 Mar 2017 08:26:28 +0000"  >&lt;p&gt;CI looks good, no failures for this test in 10 builds. On trunk, 11th build contained 64 failures, but since there were no changes inbetween and given the nature of errors there I tend to believe it&apos;s an enviroment issue. &lt;/p&gt;</comment>
                            <comment id="15954247" author="mkjellman" created="Mon, 3 Apr 2017 22:19:45 +0000"  >&lt;p&gt;Yes, I can review again.&lt;/p&gt;</comment>
                            <comment id="16000427" author="ifesdjeen" created="Mon, 8 May 2017 08:23:49 +0000"  >&lt;p&gt;Do you think we can get that reviewed any time soon? It&apos;d be great, as this is one of the few test failures we get quite often.&lt;/p&gt;</comment>
                            <comment id="16001473" author="mkjellman" created="Mon, 8 May 2017 20:31:21 +0000"  >&lt;p&gt;Yup. I&apos;m really sorry I let this slip. I owe you a beer the next time I see you. Will do it today.&lt;/p&gt;</comment>
                            <comment id="16001619" author="mkjellman" created="Mon, 8 May 2017 21:54:19 +0000"  >&lt;p&gt;With this change, the &quot;mocked&quot; Clock in MessagingServiceTest will always return 0 for getTick()&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; time = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Clock clock = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Clock()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; getTick()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
        }

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; getTime()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; time;
        }
    };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But if we look at the implementation of time() in metrics-core Timer, it does the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Times and records the duration of event.
     *
     * @param event a {@link Callable} whose {@link Callable#call()} method &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; a process
     *              whose duration should be timed
     * @param &amp;lt;T&amp;gt;   the type of the value returned by {@code event}
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the value returned by {@code event}
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; {@code event} &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; an {@link Exception}
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &amp;lt;T&amp;gt; T time(Callable&amp;lt;T&amp;gt; event) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; startTime = clock.getTick();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; event.call();
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            update(clock.getTick() - startTime);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, from my understanding this means we will always just do 0-0 for the update() call on the Timer... right?&lt;/p&gt;

&lt;p&gt;However, I don&apos;t think any of this matters in retospect. Took a big step back and looked over the actual unit test and what this thing is testing with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; and all 3 of us think this magic number a bit questionable.&lt;/p&gt;

&lt;p&gt;If we look at the original patch that added these magic numbers in the first place for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10580&quot; title=&quot;Add latency metrics for dropped messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10580&quot;&gt;&lt;del&gt;CASSANDRA-10580&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/c9ef25fd81501005b6484baf064081efc557f3f4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pcmanus/cassandra/commit/c9ef25fd81501005b6484baf064081efc557f3f4&lt;/a&gt;) there is nothing in the ticket or test or commit that justifies testing for these magic numbers and it looks like this is just going to be dependent on how fast your system can iterate thru the logic 5000 times.&lt;/p&gt;

&lt;p&gt;So: I&apos;d like to propose that we throw away the 2nd assert in this test. The first and last are good (counting the number that we expect to get) but doing a literal string compare on the entire log message is kinda unhelpful. Instead, we should throw a regex here on the log message, parse out the times and just check that they are &amp;gt; 0. Thoughts?&lt;/p&gt;</comment>
                            <comment id="16001658" author="jjirsa" created="Mon, 8 May 2017 22:16:22 +0000"  >&lt;p&gt;+1 to killing magic numbers.&lt;/p&gt;</comment>
                            <comment id="16002410" author="ifesdjeen" created="Tue, 9 May 2017 09:58:58 +0000"  >&lt;p&gt;No problem, I was hesitant to remind as I realise you have a bunch of other things to do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;With this change, the &quot;mocked&quot; Clock in MessagingServiceTest will always return 0 for getTick()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is exactly what we do, yes. Main reason for that change was because we do not rely on the wall clock, otherwise because of interference the test ends up taking more time and was time-dependent. &lt;/p&gt;

&lt;p&gt;Replaced string comparisons with parsing and number checks, looks cleaner now.&lt;/p&gt;</comment>
                            <comment id="16002415" author="mkjellman" created="Tue, 9 May 2017 10:01:24 +0000"  >&lt;p&gt;Awesome! Are you going to push that to the same 13216-followup-3.11 branch on your GitHub fork?&lt;/p&gt;</comment>
                            <comment id="16002539" author="ifesdjeen" created="Tue, 9 May 2017 11:40:36 +0000"  >&lt;p&gt;Oh yes I already did, was just waiting for CI results (which by now came clean):&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-followup-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/13216-followup-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13216-followup-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16012614" author="mkjellman" created="Tue, 16 May 2017 15:47:52 +0000"  >&lt;p&gt;Looks great! +1 Thanks Alex&lt;/p&gt;</comment>
                            <comment id="16047640" author="ifesdjeen" created="Tue, 13 Jun 2017 09:27:31 +0000"  >&lt;p&gt;Thank you! &lt;/p&gt;

&lt;p&gt;Committed to 3.11 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/d8fb9349df818659c54d57b2d2c95ebbd0405d49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d8fb9349df818659c54d57b2d2c95ebbd0405d49&lt;/a&gt; and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/09c837f75b5814fc92d3d1576f698537ef28ee2c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12860880" name="TEST-org.apache.cassandra.net.MessagingServiceTest.log" size="9961" author="mshuler" created="Tue, 28 Mar 2017 14:34:18 +0000"/>
                            <attachment id="12852364" name="TEST-org.apache.cassandra.net.MessagingServiceTest.log" size="59218" author="sean.mccarthy" created="Mon, 13 Feb 2017 14:51:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39zyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mkjellman</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mkjellman]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>