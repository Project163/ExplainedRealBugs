<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14896] 3.0 schema migration pulls from later version incompatible nodes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14896</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I saw this in upgrade tests. The checks in 3.0 and 3.11 are slightly different and 3.0 in some scenarios it is pulling schema from a later version. This causes upgrade tests to have errors in the logs due to additional columns from configurable storage port.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Failed: Error details: 
Errors seen in logs for: node2
node2: ERROR [MessagingService-Incoming-/127.0.0.1] 2018-11-15 21:17:46,739 CassandraDaemon.java:207 - Exception in thread Thread[MessagingService-Incoming-/127.0.0.1,5,main]
java.lang.RuntimeException: Unknown column additional_write_policy during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:433) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:440) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:686) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:674) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:337) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:346) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:641) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:624) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.17.jar:3.0.17]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.17.jar:3.0.17]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13198747">CASSANDRA-14896</key>
            <summary>3.0 schema migration pulls from later version incompatible nodes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                            <label>4.0-pre-rc-bugs</label>
                    </labels>
                <created>Thu, 15 Nov 2018 21:45:01 +0000</created>
                <updated>Fri, 15 May 2020 08:06:38 +0000</updated>
                            <resolved>Fri, 30 Nov 2018 21:18:49 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16702323" author="aweisberg" created="Wed, 28 Nov 2018 19:38:45 +0000"  >&lt;p&gt;4.0 is providing the wrong max version when connecting to other nodes which causes them to think that 4.0 nodes are older version nodes.&lt;/p&gt;</comment>
                            <comment id="16702486" author="jasobrown" created="Wed, 28 Nov 2018 22:56:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; is correct. On the third (and last) message of the internode messaging handshake, the node is &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/async/OutboundHandshakeHandler.java#L180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;incorrectly sending back&lt;/a&gt; the messaging version is received from the peer; it should be sending back it&apos;s own &lt;tt&gt;MessagingService.current_version&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Here&apos;s a one-line fix for sending the correct messaging version in &lt;tt&gt;ThirdHandshakeMessage&lt;/tt&gt; as well as fixing the unit test that ensures the version being sent from &lt;tt&gt;OutboundHandshakeHandler&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;14896&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/14896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/14896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16702490" author="aweisberg" created="Wed, 28 Nov 2018 23:00:58 +0000"  >&lt;p&gt;+1 to that fix. I&apos;ve tested it and it worked for me.&lt;/p&gt;</comment>
                            <comment id="16702503" author="jasobrown" created="Wed, 28 Nov 2018 23:15:12 +0000"  >&lt;p&gt;The only utest that failed was &lt;tt&gt;DistributedReadWritePathTest.writeWithSchemaDisagreement&lt;/tt&gt;, which failed with &quot;Forked Java VM exited abnormally&quot;. I ran locally and all was fine, so chalking it up to a testing fluke. Will commit shortly.&lt;/p&gt;</comment>
                            <comment id="16702516" author="jasobrown" created="Wed, 28 Nov 2018 23:26:22 +0000"  >&lt;p&gt;Committed as sha {&lt;/p&gt;
{c5dee08dfb791ba28fecc8ca8b25a4a4d7e9cb07}
&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="16703296" author="tommy_s" created="Thu, 29 Nov 2018 14:53:40 +0000"  >&lt;p&gt;I&apos;m not sure why but this seams to course some problems when upgrading 3.x-&amp;gt;4.0 with server encryption enabled. The 4.0 node can&apos;t connect to any 3.x node, if I build 4.0 without this patch I get the issue reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14848&quot; title=&quot;When upgrading 3.11.3-&amp;gt;4.0 using SSL 4.0 nodes does not connect to old non seed nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14848&quot;&gt;&lt;del&gt;CASSANDRA-14848&lt;/del&gt;&lt;/a&gt; and the 4.0 node connects to one of the 3.x nodes. My patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14848&quot; title=&quot;When upgrading 3.11.3-&amp;gt;4.0 using SSL 4.0 nodes does not connect to old non seed nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14848&quot;&gt;&lt;del&gt;CASSANDRA-14848&lt;/del&gt;&lt;/a&gt; does not help so I&apos;m not sure what the problem is.&lt;/p&gt;</comment>
                            <comment id="16703474" author="aweisberg" created="Thu, 29 Nov 2018 16:40:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tommy_s&quot; class=&quot;user-hover&quot; rel=&quot;tommy_s&quot;&gt;tommy_s&lt;/a&gt; unfortunate this didn&apos;t help. &lt;/p&gt;

&lt;p&gt;I will probably get to the SSL issue soon if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; doesn&apos;t just because the upgrade tests have SSL tests so I will hit it there.&lt;/p&gt;</comment>
                            <comment id="16703717" author="aweisberg" created="Thu, 29 Nov 2018 19:50:51 +0000"  >&lt;p&gt;I +1ed the wrong fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The version in the constructor needs to be the peer&apos;s version. It&apos;s &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/async/HandshakeProtocol.java#L248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line here&lt;/a&gt; that needs to specify the current version.&lt;/p&gt;</comment>
                            <comment id="16703901" author="jasobrown" created="Thu, 29 Nov 2018 22:21:38 +0000"  >&lt;p&gt;The problem&#160;with my first patch is&#160;that we need the peer&apos;s messaging version in order serialize the &lt;tt&gt;InetaddressAndPort&lt;/tt&gt; correctly to the peer. We still need to write the local node&apos;s messaging version into the message, however.&lt;/p&gt;

&lt;p&gt;Patch here:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;v2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/14896-v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/14896-v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16703918" author="aweisberg" created="Thu, 29 Nov 2018 22:29:46 +0000"  >&lt;p&gt;The comment on writing the max version to the message should specify that it&apos;s the maximum supported version of this node. As opposed to the supported to the version it&apos;s using to connect.&lt;/p&gt;

&lt;p&gt;Other then that +1&lt;/p&gt;</comment>
                            <comment id="16705289" author="jasobrown" created="Fri, 30 Nov 2018 21:18:49 +0000"  >&lt;p&gt;Committed v2 patch as &lt;tt&gt;f3609995c09570d523527d9bd0fd69c2bc65d986&lt;/tt&gt; with updated comments per &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;&apos;s recommendation.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00jxs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>