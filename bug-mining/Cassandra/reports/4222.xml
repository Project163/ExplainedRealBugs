<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11548] Anticompaction not removing old sstables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11548</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;1. 12/29/15 &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10831&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-10831&lt;/a&gt;&lt;br/&gt;
Moved markCompactedSSTablesReplaced out of the loop ```for (SSTableReader sstable : repairedSSTables)```&lt;/p&gt;

&lt;p&gt;2. 1/18/16 &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10829&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-10829&lt;/a&gt;&lt;br/&gt;
Added unmarkCompacting into the loop. ```for (SSTableReader sstable : repairedSSTables)```&lt;/p&gt;

&lt;p&gt;I think the effect of those above change might cause the markCompactedSSTablesReplaced fail on &lt;/p&gt;

&lt;p&gt;DataTracker.java&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;           assert newSSTables.size() + newShadowed.size() == newSSTablesSize :
                String.format(&quot;Expecting new size of %d, got %d while replacing %s by %s in %s&quot;,
                          newSSTablesSize, newSSTables.size() + newShadowed.size(), oldSSTables, replacements, this);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since change &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10831&quot; title=&quot;Fix the way we replace sstables after anticompaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10831&quot;&gt;&lt;del&gt;CASSANDRA-10831&lt;/del&gt;&lt;/a&gt; moved it out. This AssertError won&apos;t be caught, leaving the oldsstables not removed. (Then this might cause row out of order error when doing incremental repair if there are L1 un-repaired sstables.)&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1.13&lt;/p&gt;</environment>
        <key id="12957942">CASSANDRA-11548</key>
            <summary>Anticompaction not removing old sstables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ruoranwang">Ruoran Wang</assignee>
                                    <reporter username="ruoranwang">Ruoran Wang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Apr 2016 01:40:18 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:36 +0000</updated>
                            <resolved>Tue, 19 Apr 2016 13:57:41 +0000</resolved>
                                        <fixVersion>2.1.14</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15236430" author="ruoranwang" created="Tue, 12 Apr 2016 01:57:27 +0000"  >&lt;p&gt;I only tried unit test for this. Still trying to figure out dtest.&lt;/p&gt;</comment>
                            <comment id="15246776" author="pauloricardomg" created="Mon, 18 Apr 2016 23:42:32 +0000"  >&lt;p&gt;Good catch! I think this makes sense and there could be a race where an sstable is removed from the compacting set during anti-compaction, and meanwhile is removed from the &lt;tt&gt;DataTracker&lt;/tt&gt; by a concurrent compaction, and when &lt;tt&gt;cfs.getDataTracker().markCompactedSSTablesReplaced(successfullyAntiCompactedSSTables, anticompactedSSTables, OperationType.ANTICOMPACTION);&lt;/tt&gt; is called at the end of the anti-compaction, the &lt;tt&gt;java.lang.AssertionError: Expecting new size of 95, got 96 while replacing XXX by XXX&lt;/tt&gt; is thrown, causing the sstable to be silently not replaced after compaction, but still picked up by a subsequent repair and cause the &lt;tt&gt;received out of order AssertionError&lt;/tt&gt; on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9935&quot; title=&quot;Repair fails with RuntimeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9935&quot;&gt;&lt;del&gt;CASSANDRA-9935&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;On 2.2+ this is fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8568&quot; title=&quot;Extend Transactional API to sstable lifecycle management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8568&quot;&gt;&lt;del&gt;CASSANDRA-8568&lt;/del&gt;&lt;/a&gt;, that extended the transactional API to sstables so no need to the apply the patch there.&lt;/p&gt;

&lt;p&gt;I did some minor update on the patch (removed unnecessary map &lt;tt&gt;successfullyAntiCompactedSSTables&lt;/tt&gt;) and added a unit test to reproduce the issue. CI tests will be available shortly below:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-11548&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11548-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11548-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; could you have a quick look to double check this makes sense and we haven&apos;t missed anything?&lt;/p&gt;

&lt;p&gt;While this will fix the root cause of the issue, on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9935&quot; title=&quot;Repair fails with RuntimeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9935&quot;&gt;&lt;del&gt;CASSANDRA-9935&lt;/del&gt;&lt;/a&gt; I will add a protection to prevent the &lt;tt&gt;received out of order AssertionError&lt;/tt&gt; when a bug like this causes an sstable not to be removed correctly.&lt;/p&gt;</comment>
                            <comment id="15247292" author="krummas" created="Tue, 19 Apr 2016 07:10:31 +0000"  >&lt;p&gt;It looks good, +1, could you prepare it for commit and I&apos;ll push it?&lt;/p&gt;</comment>
                            <comment id="15247563" author="pauloricardomg" created="Tue, 19 Apr 2016 11:09:44 +0000"  >&lt;p&gt;I prepared for commit on 2.1.15 on two commits (to preserve authors), please hold commit until there is a decision if this can still go on 2.1.14 (which is already tagged).&lt;/p&gt;

&lt;p&gt;Also, when you have time could you have a look on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9935&quot; title=&quot;Repair fails with RuntimeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9935&quot;&gt;&lt;del&gt;CASSANDRA-9935&lt;/del&gt;&lt;/a&gt; which is complementary to this?&lt;/p&gt;

&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15247785" author="krummas" created="Tue, 19 Apr 2016 13:57:41 +0000"  >&lt;p&gt;Committed to 2.1.14 (changed CHANGES.txt on commit) and merged up with -s ours&lt;/p&gt;

&lt;p&gt;thanks!&lt;/p&gt;</comment>
                            <comment id="15248413" author="pauloricardomg" created="Tue, 19 Apr 2016 18:54:30 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;. Good job &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ruoranwang&quot; class=&quot;user-hover&quot; rel=&quot;ruoranwang&quot;&gt;ruoranwang&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15251053" author="ruoranwang" created="Thu, 21 Apr 2016 01:18:06 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;. May I ask about the release schedule for 2.1.14?&lt;/p&gt;</comment>
                            <comment id="15256471" author="pauloricardomg" created="Mon, 25 Apr 2016 15:21:00 +0000"  >&lt;p&gt;vote was already called so it should be out in the next few days (this week for sure)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12798168" name="0001-cassandra-2.1.13-potential-fix.patch" size="2305" author="ruoranwang" created="Tue, 12 Apr 2016 01:57:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ruoranwang]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vyvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pauloricardomg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>