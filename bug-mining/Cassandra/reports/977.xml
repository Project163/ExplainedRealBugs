<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2773] &quot;Index manager cannot support deleting and inserting into a row in the same mutation&quot;</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2773</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I use hector 0.8.0-1 and cassandra 0.8.&lt;/p&gt;

&lt;p&gt;1. create mutator by using hector api, &lt;br/&gt;
2. Insert a few columns into the mutator for key &quot;key1&quot;, cf &quot;standard&quot;. &lt;br/&gt;
3. add a deletion to the mutator to delete the record of &quot;key1&quot;, cf &quot;standard&quot;.&lt;br/&gt;
4. repeat 2 and 3&lt;br/&gt;
5. execute the mutator.&lt;/p&gt;

&lt;p&gt;the result: the connection seems to be held by the sever forever, it never returns. when I tried to restart the cassandra I saw unsupportedexception : &quot;Index manager cannot support deleting and inserting into a row in the same mutation&quot;. and the cassandra is dead forever, unless I delete the commitlog. &lt;/p&gt;

&lt;p&gt;I would expect to get an exception when I execute the mutator, not after I restart the cassandra.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12510393">CASSANDRA-2773</key>
            <summary>&quot;Index manager cannot support deleting and inserting into a row in the same mutation&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="yulinyen">Boris Yen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Jun 2011 03:10:33 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:57 +0000</updated>
                            <resolved>Thu, 30 Jun 2011 01:02:54 +0000</resolved>
                                        <fixVersion>0.7.7</fixVersion>
                    <fixVersion>0.8.2</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13049592" author="jbellis" created="Wed, 15 Jun 2011 03:33:29 +0000"  >&lt;p&gt;Like it says, you will have to send your deletes and mutations in different mutations.&lt;/p&gt;</comment>
                            <comment id="13049598" author="yulinyen" created="Wed, 15 Jun 2011 03:45:46 +0000"  >&lt;p&gt;sure, I know what you mean.&lt;/p&gt;

&lt;p&gt;however, when the user uses it the wrong way, the server should at least response an error or exception... not just hold the connection and do nothing...&lt;/p&gt;

&lt;p&gt;In addition, the server should not be dead forever, when this kind of exception occurs. &lt;/p&gt;</comment>
                            <comment id="13049599" author="jbellis" created="Wed, 15 Jun 2011 03:51:07 +0000"  >&lt;p&gt;You&apos;re right, there&apos;s a validation problem here.&lt;/p&gt;</comment>
                            <comment id="13051205" author="jbellis" created="Fri, 17 Jun 2011 17:17:30 +0000"  >&lt;p&gt;we could add some valdation logic but it looks like it&apos;s almost as easy to just remove this limitation.  patch to do this attached.&lt;/p&gt;</comment>
                            <comment id="13051871" author="slebresne" created="Mon, 20 Jun 2011 09:19:58 +0000"  >&lt;p&gt;Hum, we cannot remove the column from cf in ignoreObsoleteMutations() because cf is the original column family from the row mutation and that&apos;s racy with commit log write (&#224; la &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2604&quot; title=&quot;EOFException on commitlogs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2604&quot;&gt;&lt;del&gt;CASSANDRA-2604&lt;/del&gt;&lt;/a&gt;). We should clone the column family, but maybe it&apos;s simpler to add validation logic after all ? In any case, it could be worth it adding some comment in Table.apply() or Table.ignoreObsoleteMutations(). &lt;/p&gt;</comment>
                            <comment id="13052060" author="jbellis" created="Mon, 20 Jun 2011 16:49:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;we cannot remove the column from cf in ignoreObsoleteMutations()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right.  Fortunately I don&apos;t think that&apos;s actually necessary.  v2 attached.&lt;/p&gt;</comment>
                            <comment id="13052063" author="slebresne" created="Mon, 20 Jun 2011 16:53:32 +0000"  >&lt;p&gt;Right, +1. I still think we should add a comment somewhere saying we shouldn&apos;t change cf (and that there is no reason to change it anyway).&lt;/p&gt;</comment>
                            <comment id="13053941" author="jbellis" created="Thu, 23 Jun 2011 16:00:59 +0000"  >&lt;p&gt;Committed, with comment.  (I wish CF objects could be immutable AND efficient...)&lt;/p&gt;</comment>
                            <comment id="13053989" author="hudson" created="Thu, 23 Jun 2011 17:27:14 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #187 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/187/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/187/&lt;/a&gt;)&lt;br/&gt;
    allow deleting a rowand updating indexed columns init in the same mutation&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2773&quot; title=&quot;&amp;quot;Index manager cannot support deleting and inserting into a row in the same mutation&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2773&quot;&gt;&lt;del&gt;CASSANDRA-2773&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1138959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1138959&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/Table.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13054115" author="jancona" created="Thu, 23 Jun 2011 21:32:28 +0000"  >&lt;p&gt;We are experiencing this issue on a cluster running 0.7.6-2. Once this occurs on a server, the same message is repeated over and over again in system.log. When we attempted to restart the box it failed. I will attach the log to this issue.&lt;/p&gt;</comment>
                            <comment id="13054117" author="jancona" created="Thu, 23 Jun 2011 21:34:46 +0000"  >&lt;p&gt;Log of failed restart attempt&lt;/p&gt;</comment>
                            <comment id="13054552" author="jancona" created="Fri, 24 Jun 2011 17:04:55 +0000"  >&lt;p&gt;Marked as critical, because when this occurs the server will not restart without removing commitlog and attending loss of data.&lt;/p&gt;</comment>
                            <comment id="13054582" author="jbellis" created="Fri, 24 Jun 2011 17:55:05 +0000"  >&lt;p&gt;I explained on-list that I&apos;m not comfortable committing this to 0.7.  The critical thing we need to deliver in 0.7 at this stage is stability.  &lt;/p&gt;

&lt;p&gt;The rarity of the problem combined with the complexity of the code involved leads me to conclude that it&apos;s better to live with a bug we know how to avoid, than risk introducing new ones.  Remember, the risk of new bugs affects &lt;em&gt;everyone&lt;/em&gt;, while the fix can only benefit those who were generating the unusual mutation pattern here.  It&apos;s our responsibility to take a balanced view.&lt;/p&gt;

&lt;p&gt;For the rare people who do find themselves affected here, your options include&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stay on &amp;lt; 0.7.6&lt;/li&gt;
	&lt;li&gt;drain the commitlog with an earlier version before upgrading, then re-upgrade to 0.7.6 after fixing your code to not generate problematic mutations&lt;/li&gt;
	&lt;li&gt;run an unofficial build with this patch included&lt;/li&gt;
	&lt;li&gt;upgrade to 0.8.2 when released&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13054630" author="jancona" created="Fri, 24 Jun 2011 19:03:21 +0000"  >&lt;p&gt;I disagree. This is a bug which allows a client to make a cluster unresponsive by performing a seemingly innocuous series of operations. If that happens, the cluster is un-restartable without loss of data. I wouldn&apos;t call a release where this can occur &quot;stable&quot;. So if the goal for 0.7 is stability...&lt;/p&gt;

&lt;p&gt;WRT &quot;fixing your code to not generate problematic mutations,&quot; this may be difficult to do. I have so far identified code that does deletes followed by updates in the same mutation, but I haven&apos;t yet found any updates followed by deletes. Are we sure that only the update-followed-by-delete scenario is problematic?&lt;/p&gt;

&lt;p&gt;In any case, even after reviewing all our code for the relevant scenarios, I would not feel comfortable deploying an 0.7 release with this vulnerability to production. The risk of a catastrophic failure is too great.&lt;/p&gt;</comment>
                            <comment id="13055611" author="slebresne" created="Mon, 27 Jun 2011 15:54:14 +0000"  >&lt;p&gt;Actually, there isn&apos;t really much risk for data loss given that as Jonathan said, if you hit that, it&apos;s fairly easy to go back to 0.7.5, fix client code and upgrade again. Granted this is not user friendly and not something you should expect from a minor upgrade, but let at least set the record straight on the data loss part.&lt;/p&gt;

&lt;p&gt;That being said, I don&apos;t think the patch on this ticket could screw up indexes more that we use to prior to 0.7.6, so maybe we can commit to 0.7.7 on that ground.&lt;/p&gt;

&lt;p&gt;I&apos;d still suggest fixing client code in the meantime. &lt;/p&gt;</comment>
                            <comment id="13055615" author="jbellis" created="Mon, 27 Jun 2011 16:02:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think the patch on this ticket could screw up indexes more that we use to prior to 0.7.6&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a valid way to frame the issue.&lt;/p&gt;

&lt;p&gt;I&apos;m good to commit for 0.7.7 if Jim can test the patch first, since he&apos;s the only one we&apos;ve heard of hitting this in 0.7.x.  (Specifically, we want to make sure that if we query &quot;WHERE foo = X&quot; we don&apos;t get results back where foo is something other than X.  Ideally you&apos;d start with an empty database, or at least drop + recreate indexes first to make sure the results aren&apos;t contaminated w/ corrupt entries from pre-0.7.6.)&lt;/p&gt;</comment>
                            <comment id="13055721" author="jancona" created="Mon, 27 Jun 2011 20:03:06 +0000"  >&lt;p&gt;I applied the 0.8 patch and added a couple of tests to ColumnFamilyStoreTest. The tests trigger the UnsupportedOperationException in 0.7.6 and return the correct values with the patch applied. Would you like me to test the same scenario against an actual patched server?&lt;/p&gt;</comment>
                            <comment id="13055771" author="jbellis" created="Mon, 27 Jun 2011 21:27:58 +0000"  >&lt;p&gt;Thanks for the test case, Jim.&lt;/p&gt;

&lt;p&gt;If by the same scenario, you mean the workload that left your commitlog throwing exceptions, then yes please.&lt;/p&gt;</comment>
                            <comment id="13057298" author="jancona" created="Wed, 29 Jun 2011 15:35:01 +0000"  >&lt;p&gt;We have deployed and tested 0.7.6 plus this patch to the affected cluster. The cluster restarted successfully and the tests that caused the original failure ran successfully. In addition, functional tests of our applications show no regressions. I also reviewed the Cassandra system logs after the testing and saw no errors or obvious problems.&lt;/p&gt;</comment>
                            <comment id="13057574" author="jbellis" created="Thu, 30 Jun 2011 01:02:54 +0000"  >&lt;p&gt;committed.  Thanks, Jim!&lt;/p&gt;</comment>
                            <comment id="13057580" author="hudson" created="Thu, 30 Jun 2011 02:18:15 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #519 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.7/519/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.7/519/&lt;/a&gt;)&lt;br/&gt;
    add additional tests for #2773&lt;br/&gt;
patch by Jim Ancona; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2773&quot; title=&quot;&amp;quot;Index manager cannot support deleting and inserting into a row in the same mutation&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2773&quot;&gt;&lt;del&gt;CASSANDRA-2773&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
allow deleting and inserting into an indexed row in the same mutation&lt;br/&gt;
patch by jbellis; reviewed by slebresne and tested by Jim Ancona for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2773&quot; title=&quot;&amp;quot;Index manager cannot support deleting and inserting into a row in the same mutation&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2773&quot;&gt;&lt;del&gt;CASSANDRA-2773&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1141354&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1141354&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/test/unit/org/apache/cassandra/db/ColumnFamilyStoreTest.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1141353&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1141353&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/db/Table.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483172" name="2773-v2.txt" size="1417" author="jbellis" created="Mon, 20 Jun 2011 16:49:14 +0000"/>
                            <attachment id="12482957" name="2773.txt" size="1339" author="jbellis" created="Fri, 17 Jun 2011 17:17:30 +0000"/>
                            <attachment id="12483997" name="ASF.LICENSE.NOT.GRANTED--v1-0001-allow-deleting-a-rowand-updating-indexed-columns-init-.txt" size="2846" author="jancona" created="Mon, 27 Jun 2011 20:00:10 +0000"/>
                            <attachment id="12483998" name="ASF.LICENSE.NOT.GRANTED--v1-0002-CASSANDRA-2773-Add-unit-tests-to-verfy-fix-cherry-pick.txt" size="1947" author="jancona" created="Mon, 27 Jun 2011 20:00:11 +0000"/>
                            <attachment id="12483644" name="cassandra.log" size="79410" author="jancona" created="Thu, 23 Jun 2011 21:34:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20820</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gddb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93596</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>