<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:15:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14773] Overflow of 32-bit integer during compaction.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14773</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In scope of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13444&quot; title=&quot;Fast and garbage-free Streaming Histogram&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13444&quot;&gt;&lt;del&gt;CASSANDRA-13444&lt;/del&gt;&lt;/a&gt; the compaction was significantly improved from CPU and memory perspective. Hovewer this improvement introduces the bug in rounding. When rounding the expriration time which is close to&#160;&#160;&lt;b&gt;Cell.MAX_DELETION_TIME&lt;/b&gt;(it is just &lt;b&gt;Integer.MAX_VALUE&lt;/b&gt;) the math overflow happens(because in scope of &lt;del&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13444&quot; title=&quot;Fast and garbage-free Streaming Histogram&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13444&quot;&gt;&lt;del&gt;CASSANDRA-13444&lt;/del&gt;&lt;/a&gt;&lt;/del&gt;) data type for point was changed from Long to Integer in order to reduce memory footprint), as result point became negative and acts as silent poison for internal structures of&#160;StreamingTombstoneHistogramBuilder like&#160;&lt;b&gt;DistanceHolder&lt;/b&gt; and&#160;&lt;b&gt;DataHolder&lt;/b&gt;. Then depending of point intervals:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The TombstoneHistogram produces wrong values when interval of points is less then binSize, it is not critical.&lt;/li&gt;
	&lt;li&gt;Compaction crashes with&#160;ArrayIndexOutOfBoundsException if amount of point intervals is great then&#160;&#160;binSize, this case is very critical.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is pull request &lt;a href=&quot;https://github.com/apache/cassandra/pull/273&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/273&lt;/a&gt;&#160;that reproduces the issue and provides the fix.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The stacktrace when running(on codebase without fix) &lt;b&gt;testMathOverflowDuringRoundingOfLargeTimestamp&lt;/b&gt;&#160;without -ea JVM flag&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ArrayIndexOutOfBoundsException
at java.lang.System.arraycopy(Native Method)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder$DistanceHolder.add(StreamingTombstoneHistogramBuilder.java:208)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.flushValue(StreamingTombstoneHistogramBuilder.java:140)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder$$Lambda$1/1967205423.consume(Unknown Source)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder$Spool.forEach(StreamingTombstoneHistogramBuilder.java:574)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.flushHistogram(StreamingTombstoneHistogramBuilder.java:124)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.build(StreamingTombstoneHistogramBuilder.java:184)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilderTest.testMathOverflowDuringRoundingOfLargeTimestamp(StreamingTombstoneHistogramBuilderTest.java:183)
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.lang.reflect.Method.invoke(Method.java:497)
at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:44)
at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:180)
at org.junit.runners.ParentRunner.access$000(ParentRunner.java:41)
at org.junit.runners.ParentRunner$1.evaluate(ParentRunner.java:173)
at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
at org.junit.runners.ParentRunner.run(ParentRunner.java:220)
at org.junit.runner.JUnitCore.run(JUnitCore.java:159)
at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The stacktrace when running(on codebase without fix)&#160;&#160;&lt;b&gt;testMathOverflowDuringRoundingOfLargeTimestamp&lt;/b&gt;&#160;with enabled -ea JVM flag&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ava.lang.AssertionError: point2 should follow point1

at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder$DataHolder.merge(StreamingTombstoneHistogramBuilder.java:324)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.mergeBin(StreamingTombstoneHistogramBuilder.java:158)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.flushValue(StreamingTombstoneHistogramBuilder.java:145)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder$$Lambda$1/1967205423.consume(Unknown Source)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder$Spool.forEach(StreamingTombstoneHistogramBuilder.java:574)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.flushHistogram(StreamingTombstoneHistogramBuilder.java:124)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilder.build(StreamingTombstoneHistogramBuilder.java:184)
at org.apache.cassandra.utils.streamhist.StreamingTombstoneHistogramBuilderTest.testMathOverflowDuringRoundingOfLargeTimestamp(StreamingTombstoneHistogramBuilderTest.java:183)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13186592">CASSANDRA-14773</key>
            <summary>Overflow of 32-bit integer during compaction.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fcofdezc">Francisco Fernandez</assignee>
                                    <reporter username="vladimir.bukhtoyarov">Vladimir Bukhtoyarov</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 21 Sep 2018 10:58:56 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:51 +0000</updated>
                            <resolved>Thu, 9 Apr 2020 13:23:19 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16623425" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 11:16:13 +0000"  >&lt;p&gt;Feel free to ask any questions about&#160;StreamingTombstoneHistogramBuilder, I spent a four days in attempt to understand how it works, and looks like I have achieved full understanding about each line of code of this class.&lt;/p&gt;</comment>
                            <comment id="16623445" author="benedict" created="Fri, 21 Sep 2018 11:40:33 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;.  Thanks for the bug report and patch.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t look like the correct way to saturate this addition, however.  We should ensure that we never go past &lt;tt&gt;MAX_DELETION&lt;/tt&gt;; by saturating to &lt;tt&gt;NO_DELETION&lt;/tt&gt;, we are effectively removing the TTL.&lt;/p&gt;</comment>
                            <comment id="16623456" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 11:48:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;no problem, I will replace Cell.NO_DELETION by max possible value, please wait a few minutes&lt;/p&gt;</comment>
                            <comment id="16623469" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 12:02:50 +0000"  >&lt;p&gt;Request has been updated according your note.&lt;/p&gt;</comment>
                            <comment id="16623496" author="benedict" created="Fri, 21 Sep 2018 12:17:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A couple of points:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Since &lt;tt&gt;NO_DELETION_TIME&lt;/tt&gt; &amp;gt; &lt;tt&gt;MAX_DELETION_TIME&lt;/tt&gt;, we need to check &lt;tt&gt;if (point &amp;lt; 0 || point == Cell.NO_DELETION_TIME)&lt;/tt&gt;, or perhaps more simply &lt;tt&gt;if (point + 1 &amp;lt;= 0)&lt;/tt&gt; - though we would need a nice comment explaining the &lt;tt&gt;+ 1&lt;/tt&gt; in this case&lt;/li&gt;
	&lt;li&gt;I&apos;m not sure we need to compute the max rounded deletion time - since this is an optimisation to minimise the number of buckets and merges, I think we&apos;d be OK straightforwardly saturating to &lt;tt&gt;Cell.MAX_DELETION_TIME&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It might be nice also to assert that we are never provided a value equal to &lt;tt&gt;Cell.NO_DELETION_TIME&lt;/tt&gt;, since this &lt;b&gt;should&lt;/b&gt; be impossible and would be a bug (both for it to appear in the stream, and also in how this method would behave)&lt;/p&gt;</comment>
                            <comment id="16623570" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 12:57:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;or perhaps more simply &lt;tt&gt;if (point + 1 &amp;lt;= 0)&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;the code become too hard for understanding, so I decided to write two independent if statements(each marked by independent comment that describes the reason of choosing Cell.MAX_DELETION_TIME&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also I fixed the case when result of rounding will be &lt;tt&gt;Cell.NO_DELETION_TIME&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16623581" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 13:02:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;according to assertion for incoming data. Are you sure that it would be better to just add assert statements&#160; instead of throwing IllegalArgumentException when client of StreamingTombstoneHistogramBuilder tries to pass Cell.NO_DELETION_TIME? Usually &lt;b&gt;-ea&lt;/b&gt; flag is turned off on production, so the problem will not be detected.&lt;/p&gt;</comment>
                            <comment id="16623754" author="benedict" created="Fri, 21 Sep 2018 15:11:45 +0000"  >&lt;p&gt;You should probably be testing &lt;tt&gt;if (point &amp;gt; Cell.MAX_DELETION_TIME)&lt;/tt&gt; - your first clause right now is a no-op.&lt;/p&gt;

&lt;p&gt;I don&apos;t really mind if it&apos;s an assertion or an exception, but it&apos;s fairly normal to run C* with exceptions enabled, and as a project we perform a lot of checks through assertions (perhaps too many).  In this case, it seems more an exception than not, to me; we seem to always be ensuring this never happens already.&lt;/p&gt;

&lt;p&gt;While we&apos;re here, in &lt;tt&gt;merge&lt;/tt&gt;, it might be worth ensuring that we cast to &lt;tt&gt;long&lt;/tt&gt; the denominator for the &lt;tt&gt;newPoint&lt;/tt&gt; calculation too.&lt;/p&gt;
</comment>
                            <comment id="16623837" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 16:22:31 +0000"  >&lt;p&gt;Ok, I have added assert for incoming values and several unit tests.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;According overflow on merging two points;&lt;/p&gt;

&lt;p&gt;When x1,x2,y1,y1&amp;lt;=Integer.MAX_VALUE the expression &lt;b&gt;(x1*y1 + x2*y2)/(y1+y2)&lt;/b&gt; can lead to overflow of 64-bit long there&#160; &lt;b&gt;(x1*y1 + x2*y2)&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;However if rewrite the expression to &lt;b&gt;x1*y1/(y1+y2) + x2*y2/(y1+y2)&lt;/b&gt;&#160;then overflow will never happen. What do you think about this fix?&lt;/p&gt;</comment>
                            <comment id="16623841" author="benedict" created="Fri, 21 Sep 2018 16:25:00 +0000"  >&lt;p&gt;It&apos;s OK to overflow to &lt;tt&gt;long&lt;/tt&gt;, the issue is that the &lt;tt&gt;y1+y2&lt;/tt&gt; remain integers until they are added; we should cast one of them to a &lt;tt&gt;long&lt;/tt&gt; upfront, so that they do not overflow before dividing the numerator.&lt;/p&gt;</comment>
                            <comment id="16623843" author="benedict" created="Fri, 21 Sep 2018 16:25:51 +0000"  >&lt;p&gt;Have you pushed your latest changes?  I still see the issue with the first clause of the if statement.&lt;/p&gt;</comment>
                            <comment id="16623849" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 16:31:15 +0000"  >&lt;p&gt;Yes, I have pushed all that I want to be included.&lt;/p&gt;</comment>
                            <comment id="16623927" author="benedict" created="Fri, 21 Sep 2018 17:37:04 +0000"  >&lt;p&gt;I&apos;ve left a couple of comments on your pull request.&lt;/p&gt;</comment>
                            <comment id="16624055" author="vladimir.bukhtoyarov" created="Fri, 21 Sep 2018 19:13:46 +0000"  >&lt;p&gt;I have fixed all notes on request, also new test-case testThatPointIsNotMissedBecauseOfRoundingToNoDeletionTime has been added.&lt;font color=&quot;#ffc66d&quot;&gt;&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="16626799" author="vladimir.bukhtoyarov" created="Tue, 25 Sep 2018 05:39:33 +0000"  >&lt;p&gt;Is any action required from me?&lt;/p&gt;</comment>
                            <comment id="16627177" author="benedict" created="Tue, 25 Sep 2018 11:19:22 +0000"  >&lt;p&gt;No, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;.  I think it&apos;s complete.  I just need to find time to run it through CI and do a final review before committing.&lt;/p&gt;</comment>
                            <comment id="16690788" author="cscotta" created="Sun, 18 Nov 2018 03:48:57 +0000"  >&lt;p&gt;Marking &quot;Patch&#160;Available on behalf of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;:&#160; &lt;a href=&quot;https://github.com/apache/cassandra/pull/273&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/273&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16696090" author="benedict" created="Thu, 22 Nov 2018 16:25:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;: very sorry for letting this languish for so long.&lt;/p&gt;

&lt;p&gt;This breaks some unit tests - these seem to be issues with the tests, but I wonder if you would be willing to take a look? &#160;If not, I will find some time next week to resolve them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://circleci.com/gh/belliottsmith/cassandra/981#tests/containers/14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/belliottsmith/cassandra/981#tests/containers/14&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16700315" author="vladimir.bukhtoyarov" created="Tue, 27 Nov 2018 12:09:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; from quick look failures should not be related to this pull request, I made this conclusion by analyzing test names. I can take detailed look at next week.&lt;/p&gt;</comment>
                            <comment id="16700317" author="benedict" created="Tue, 27 Nov 2018 12:11:36 +0000"  >&lt;p&gt;They are related to this change - several of the tests at least are supplying negative local deletion times in order to produce corrupt range tombstones. &#160;This is very easily argued to be a bug with the test, but we can&apos;t commit this with test breakages&lt;/p&gt;</comment>
                            <comment id="16813323" author="snazy" created="Tue, 9 Apr 2019 12:19:09 +0000"  >&lt;p&gt;TBH, I doubt that the changes in the proposed PR are enough to fix the existing issues in &lt;tt&gt;StreamingTombstoneHistogramBuilder&lt;/tt&gt;. Some comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Nit: the method &lt;tt&gt;roundKey&lt;/tt&gt; should be called &lt;tt&gt;ceilKey&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The overall benefit of &lt;tt&gt;DistanceHolder&lt;/tt&gt; is probably outweighed by the overhead to manage this structure. Maybe it&apos;s better to revert to the previous way (iterate to find the shortest distance). Removing &lt;tt&gt;DistanceHolder&lt;/tt&gt; would also simplify the code a lot.&lt;/li&gt;
	&lt;li&gt;The calculation of &lt;tt&gt;sum&lt;/tt&gt; in &lt;tt&gt;merge()&lt;/tt&gt; is prone to an int overflow. Better make &lt;tt&gt;sum&lt;/tt&gt;&#160;a &lt;tt&gt;long&lt;/tt&gt;&#160;and guard the calculation of &lt;tt&gt;newPoint&lt;/tt&gt; with &lt;tt&gt;Math.toExactInt()&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;wrap&lt;/tt&gt; should&#160;take &lt;tt&gt;value&lt;/tt&gt; as a &lt;tt&gt;long&lt;/tt&gt;&#160;and prevent&#160;getting a negative result (int overflow).&lt;/li&gt;
	&lt;li&gt;The code sequence &lt;tt&gt;boxed().map()&lt;/tt&gt; found in the class can be simplified to &lt;tt&gt;mapToObj()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The calculations in &lt;tt&gt;roundKey&lt;/tt&gt; should use {{long}}s and&#160;use a saturating cast (limit return values to 0..Cell.MAX_DELETION_TIME)&lt;/li&gt;
	&lt;li&gt;Deserialization in TombstoneHistogram is also prone to int overflows and should use a saturating cast (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;tryCell&lt;/tt&gt; should also not just blindly do a &lt;tt&gt;+=&lt;/tt&gt; but a saturating cast of the old value + delta&lt;/li&gt;
	&lt;li&gt;Test cases for all the possible int overflows are missing&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16813332" author="benedict" created="Tue, 9 Apr 2019 12:24:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; see also &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14775&quot; title=&quot;StreamingTombstoneHistogramBuilder overflows if &amp;gt; 2B in a single bucket/sstable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14775&quot;&gt;&lt;del&gt;CASSANDRA-14775&lt;/del&gt;&lt;/a&gt;, which necessitates slightly more fundamental revisiting of the new structure IMO, during which I hoped we would address these wider issues.  Certainly appreciate you pointing some of them out here, though.&lt;/p&gt;</comment>
                            <comment id="17014474" author="benedict" created="Mon, 13 Jan 2020 17:02:20 +0000"  >&lt;p&gt;FYI, I deliberately unassigned this to help track the likely need for another contributor to complete the work.&lt;/p&gt;</comment>
                            <comment id="17029050" author="edimitrova" created="Mon, 3 Feb 2020 15:52:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;&#160;and&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Maybe I can contribute to this one? As far as I see from the latest 2019 updates failing tests had to be fixed at first?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.bukhtoyarov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.bukhtoyarov&quot;&gt;vladimir.bukhtoyarov&lt;/a&gt;&#160;are you still working on this one?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17029159" author="vladimir.bukhtoyarov" created="Mon, 3 Feb 2020 18:20:09 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;No, I am not working on this.&lt;/p&gt;</comment>
                            <comment id="17067731" author="fcofdezc" created="Thu, 26 Mar 2020 14:37:20 +0000"  >&lt;p&gt;I&apos;ve pushed a patch following the same ideas proposed originally and I&apos;ve simplified the code as well. I think we&apos;re covering all overflows now.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/491&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/491&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;&#160;can you take a look?&#160;&lt;/p&gt;</comment>
                            <comment id="17076163" author="fcofdezc" created="Mon, 6 Apr 2020 09:12:50 +0000"  >&lt;p&gt;I&apos;ve updated the patch including more test coverage.&lt;/p&gt;</comment>
                            <comment id="17079309" author="blerer" created="Thu, 9 Apr 2020 12:59:58 +0000"  >&lt;p&gt;Jenkins test failures seems unrelated &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/31/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Jenkins&lt;/a&gt;&lt;br/&gt;
and the circleCI test looks good.&lt;/p&gt;</comment>
                            <comment id="17079333" author="blerer" created="Thu, 9 Apr 2020 13:23:19 +0000"  >&lt;p&gt;Committed into trunk at 00fb6d76d0a97af06ba27c1180d6dcddfa337fea&lt;/p&gt;</comment>
                            <comment id="17079334" author="blerer" created="Thu, 9 Apr 2020 13:23:40 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fcofdezc&quot; class=&quot;user-hover&quot; rel=&quot;fcofdezc&quot;&gt;fcofdezc&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13186651">CASSANDRA-14775</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13063724">CASSANDRA-13444</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13186651">CASSANDRA-14775</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[fcofdezc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ychz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/00fb6d76d0a97af06ba27c1180d6dcddfa337fea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/00fb6d76d0a97af06ba27c1180d6dcddfa337fea&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Unit tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>