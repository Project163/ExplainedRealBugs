<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5099] Since 1.1, get_count sometimes returns value smaller than actual column count</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5099</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a CF where rows have thousands of TTLd columns. The columns are continually added at a regular rate, and TTL out after 15 minutes. We continually run a &apos;get_count&apos; on these keys to get a count of the number of live columns.&lt;/p&gt;

&lt;p&gt;Since we upgrade from 1.0 to 1.1.7, &quot;get_count&quot; regularly returns much smaller values than are possible. For example, with  roughly 15,000 columns that have well-distributed TTLs, running a get_count 10 times will result in 1 or 2 results that are up to half the actual column count. Using a normal &apos;get&apos; to count those columns always results in proper values. &lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;

&lt;p&gt;(all of these counts were ran within a second or less of eachother)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@reddit] count  AccountsActiveBySR[&lt;span class=&quot;code-quote&quot;&gt;&apos;2qh0u&apos;&lt;/span&gt;];
13665 columns
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@reddit] count  AccountsActiveBySR[&lt;span class=&quot;code-quote&quot;&gt;&apos;2qh0u&apos;&lt;/span&gt;];
13665 columns
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@reddit] count  AccountsActiveBySR[&lt;span class=&quot;code-quote&quot;&gt;&apos;2qh0u&apos;&lt;/span&gt;];
13666 columns
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@reddit] count  AccountsActiveBySR[&lt;span class=&quot;code-quote&quot;&gt;&apos;2qh0u&apos;&lt;/span&gt;];
3069 columns
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@reddit] count  AccountsActiveBySR[&lt;span class=&quot;code-quote&quot;&gt;&apos;2qh0u&apos;&lt;/span&gt;];
13660 columns
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@reddit] count  AccountsActiveBySR[&lt;span class=&quot;code-quote&quot;&gt;&apos;2qh0u&apos;&lt;/span&gt;];
13661 columns
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I should note that this issue happens much more frequently with larger (&amp;gt;10k columns) rows than smaller rows. It never seems to happen with rows having fewer than 1k columns.&lt;/p&gt;

&lt;p&gt;There are no supercolumns in use. The key names and column names are very short, and there are no column values. The CF is LCS, and due to the TTL only hovers around a few MB in size. GC grace is normally at zero, but the problem is consistent with non-zero gc grace times.&lt;/p&gt;


&lt;p&gt;It appears that there was an issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4833&quot; title=&quot;get_count with &amp;#39;count&amp;#39; param between 1024 and ~actual column count fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4833&quot;&gt;&lt;del&gt;CASSANDRA-4833&lt;/del&gt;&lt;/a&gt;) fixed in 1.1.7 regarding get_count. Some logic was added to prevent an infinite loop case. Could that change have resulted in this problem somehow? I can&apos;t find any other relevant 1.1 changes that might explain this issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12625743">CASSANDRA-5099</key>
            <summary>Since 1.1, get_count sometimes returns value smaller than actual column count</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="alienth">Jason Harvey</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Jan 2013 22:51:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:20 +0000</updated>
                            <resolved>Fri, 11 Jan 2013 17:06:25 +0000</resolved>
                                        <fixVersion>1.1.9</fixVersion>
                    <fixVersion>1.2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13542517" author="alienth" created="Wed, 2 Jan 2013 22:56:23 +0000"  >&lt;p&gt;Also found &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3798&quot; title=&quot;get_count paging often asks for a page uselessly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3798&quot;&gt;&lt;del&gt;CASSANDRA-3798&lt;/del&gt;&lt;/a&gt; which altered the get_count logic between 1.0 and 1.1.&lt;/p&gt;</comment>
                            <comment id="13544373" author="alienth" created="Sat, 5 Jan 2013 00:06:15 +0000"  >&lt;p&gt;Confirmed that this problem is consistent on both LCS and SizeTiered.&lt;/p&gt;</comment>
                            <comment id="13545698" author="alienth" created="Mon, 7 Jan 2013 08:26:30 +0000"  >&lt;p&gt;I&apos;ve ported the 1.0.11 get_count code from CassandraServer.java to 1.1.7. Doing so resolves this issue.&lt;/p&gt;</comment>
                            <comment id="13549230" author="yukim" created="Thu, 10 Jan 2013 00:29:22 +0000"  >&lt;p&gt;Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4833&quot; title=&quot;get_count with &amp;#39;count&amp;#39; param between 1024 and ~actual column count fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4833&quot;&gt;&lt;del&gt;CASSANDRA-4833&lt;/del&gt;&lt;/a&gt; assumes that only last page from get_slice has columns less than requested, and if that happens, returns the column count collected.&lt;br/&gt;
But in case of ttl, it is possible to have less columns at the middle of the pagenation.&lt;/p&gt;

&lt;p&gt;Attached patch changes loop termination check so that it does not depend on column count, which is what we had in 1.0.&lt;/p&gt;</comment>
                            <comment id="13549531" author="slebresne" created="Thu, 10 Jan 2013 10:53:09 +0000"  >&lt;p&gt;In fact, I think that this point out to a more serious problem with TTL.&lt;/p&gt;

&lt;p&gt;Because even get_count aside, if I do a get_slice with a particular count n, I expect that if I get less than n values in my result, it means there is no more value matching whatever replica I&apos;ve provided. I&apos;d say that any other behavior is a bug. But with TTL, if a column expires while the query is processed, we may fail that count argument (which is exactly what hits us here).&lt;/p&gt;

&lt;p&gt;In other words, I&apos;m not sure reintroducing the inefficiency of always doing one last almost always useless query to make sure the paging is indeed over is the right fix, because I doubt people that do manual row paging using get_slice actually implement that &quot;do one last query just in case the previous query lied on the count returned&quot;.&lt;/p&gt;

&lt;p&gt;What I would suggest instead would be to have CassandraServer save the current time before doing a get_slice, and use that time in thriftifyColumns when deciding if a column is considered expired or not. That way we won&apos;t skip an expiring column from the result set if it had been counted as live during the actual internal query.&lt;/p&gt;

</comment>
                            <comment id="13549765" author="slebresne" created="Thu, 10 Jan 2013 16:36:12 +0000"  >&lt;p&gt;I&apos;ll note that the solution I&apos;m suggesting is 1) slightly painful to implement because deserialization change expiring columns into tombstones so we would have have to pass the expireBefore all the way down the stack and 2) this only really work correctly if we actually send that expireBefore to other nodes along with the read request to use as reference. In particular 2) makes such solution pretty much out of scope for 1.1 and even 1.2 (since it&apos;s a protocol change). That being said, I do think this is probably the &quot;right&quot; solution in the long run (unless someone has a better idea of course).&lt;/p&gt;

&lt;p&gt;Note that I don&apos;t oppose committing the &quot;let&apos;s do one more request&quot; to 1.1 to fix get_count if we have nothing better, but that doesn&apos;t change the fact that the get_slice count is potentially broken when TTLs are involved. I just don&apos;t see a quick fix right off the bat.&lt;/p&gt;</comment>
                            <comment id="13549837" author="jbellis" created="Thu, 10 Jan 2013 17:52:10 +0000"  >&lt;p&gt;Sounds to me like we should commit the &quot;one more request&quot; fix and open a new ticket to address mid-request ttl expiration for 1.2 only.&lt;/p&gt;</comment>
                            <comment id="13550473" author="yukim" created="Thu, 10 Jan 2013 21:52:59 +0000"  >&lt;p&gt;I&apos;m +1 to commit this patch for 1.1.9 and open new ticket for 1.2.&lt;br/&gt;
So, is the patch looking good?&lt;/p&gt;</comment>
                            <comment id="13551185" author="slebresne" created="Fri, 11 Jan 2013 15:32:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;So, is the patch looking good?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, +1. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5149&quot; title=&quot;Respect slice count even if column expire mid-request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5149&quot;&gt;&lt;del&gt;CASSANDRA-5149&lt;/del&gt;&lt;/a&gt; for the follow up.&lt;/p&gt;</comment>
                            <comment id="13551269" author="yukim" created="Fri, 11 Jan 2013 17:06:25 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12564063" name="5099-1.1.txt" size="955" author="yukim" created="Thu, 10 Jan 2013 00:29:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302294</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16zyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248961</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>