<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7088] Zero length BigInteger exception causing processing to freeze</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7088</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We attempted to migrate our developers to Cassandra 2.0.7 from 1.2.&lt;/p&gt;

&lt;p&gt;Everything worked perfectly, but we have experienced a massive drop in developer velocity.&lt;/p&gt;

&lt;p&gt;We run integration tests with Cucumber BDD and 1000 BDDs went from 7 minutes (Cassandra 1.2) to 15 minutes (2.0.7),&lt;br/&gt;
This is when we run Cassandra of the ramdisk (/dev/shm) to make it run faster on dev boxes.&lt;/p&gt;

&lt;p&gt;When we tried pointed to actual drives  the difference was dramatic: the entire suite took over 70 minutes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; vs 15 in Cassandra 1.2.&lt;/p&gt;

&lt;p&gt;After investigation, we found that most of the time is spent in the truncation logic between every scenario, where we truncate all the column families and start with a clean DB for the next test case.&lt;/p&gt;

&lt;p&gt;This used to be super fast in 1.2, is now very slow in 2.0.&lt;/p&gt;

&lt;p&gt;It may not seem important, but upgrading to 2.0 has basically cut down developer velocity by 100%, just by more than doubling the time it takes to run our BDD suite.&lt;/p&gt;

&lt;p&gt;We truncate the CFs using the Ruby driver:&lt;/p&gt;

&lt;p&gt;  $cassandra.column_families.each do |column_family|&lt;br/&gt;
        name = column_family&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;.to_s&lt;br/&gt;
        $cassandra.truncate! name&lt;br/&gt;
  end&lt;/p&gt;

&lt;p&gt;I am attaching our cassandra.yaml. Please note we already switched off auto_compaction before truncate, just as we did in 1.2 for dev boxes, Made no difference.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Linux Mint 16&lt;/p&gt;</environment>
        <key id="12710438">CASSANDRA-7088</key>
            <summary>Zero length BigInteger exception causing processing to freeze</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jfurmankiewicz">Jacek Furmankiewicz</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Apr 2014 21:40:38 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:47 +0000</updated>
                            <resolved>Thu, 8 May 2014 16:05:53 +0000</resolved>
                                        <fixVersion>2.0.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13980347" author="jfurmankiewicz" created="Thu, 24 Apr 2014 21:45:25 +0000"  >&lt;p&gt;Sorry I meant&lt;/p&gt;

&lt;p&gt;auto_snapshot: false&lt;/p&gt;

&lt;p&gt;not auto_compaction&lt;/p&gt;</comment>
                            <comment id="13980384" author="jfurmankiewicz" created="Thu, 24 Apr 2014 22:10:32 +0000"  >&lt;p&gt;We also see a lot of exceptions like this at a time when our test suite seems to freeze waiting for Cassandra:&lt;/p&gt;

&lt;p&gt;k 16ms for 3394 cells&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage:82&amp;#93;&lt;/span&gt; 2014-04-24 17:09:31,843 CassandraDaemon.java (line 198) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage:82,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.NumberFormatException: Zero length BigInteger&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1920)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:744)&lt;br/&gt;
Caused by: java.lang.NumberFormatException: Zero length BigInteger&lt;br/&gt;
	at java.math.BigInteger.&amp;lt;init&amp;gt;(BigInteger.java:190)&lt;br/&gt;
	at org.apache.cassandra.serializers.IntegerSerializer.deserialize(IntegerSerializer.java:32)&lt;br/&gt;
	at org.apache.cassandra.serializers.IntegerSerializer.deserialize(IntegerSerializer.java:26)&lt;br/&gt;
	at org.apache.cassandra.db.marshal.AbstractType.getString(AbstractType.java:156)&lt;br/&gt;
	at org.apache.cassandra.db.marshal.AbstractCompositeType.getString(AbstractCompositeType.java:242)&lt;br/&gt;
	at org.apache.cassandra.db.filter.SliceQueryFilter.collectReducedColumns(SliceQueryFilter.java:219)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateColumns(QueryFilter.java:122)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:80)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:72)&lt;br/&gt;
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:297)&lt;br/&gt;
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:53)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1540)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1369)&lt;br/&gt;
	at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:327)&lt;br/&gt;
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1352)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1916)&lt;br/&gt;
	... 3 more&lt;/p&gt;</comment>
                            <comment id="13980398" author="jfurmankiewicz" created="Thu, 24 Apr 2014 22:22:53 +0000"  >&lt;p&gt;I can validate that while watching our test suite run and seeing where it freezes all of a sudden...nearly every time that exception appears if I am doing a tail -f on /var/log/cassandra/system.log&lt;/p&gt;

&lt;p&gt;so they definitely seem correlated&lt;/p&gt;</comment>
                            <comment id="13980946" author="brandon.williams" created="Fri, 25 Apr 2014 12:23:34 +0000"  >&lt;p&gt;If you can give us simple steps to reproduce the error (not ruby code) perhaps we can get somewhere.&lt;/p&gt;</comment>
                            <comment id="13981074" author="jfurmankiewicz" created="Fri, 25 Apr 2014 14:48:41 +0000"  >&lt;p&gt;Hm, so it&apos;s not so simple.&lt;/p&gt;

&lt;p&gt;Basically we run regular BDD tests against the app (many REST calls back and forth) that result in many read/writes from Cassandra in the back.&lt;br/&gt;
Between every test we truncate the DB to start clean for the next integration test.&lt;/p&gt;

&lt;p&gt;So I would basically need to give you the whole app, which is rather impossible.&lt;/p&gt;

&lt;p&gt;If there is anything we could trace through on our end I would be more than happy to do it.&lt;/p&gt;

&lt;p&gt;a) Is there anything you could think of that changed between 1.2 and 2.0 that could cause CF truncation to be much slower? (is auto_snapshot: false still respected?)&lt;/p&gt;

&lt;p&gt;b) any idea what could cause the Zero length BigInteger exception?&lt;/p&gt;

&lt;p&gt;Thank you&lt;/p&gt;</comment>
                            <comment id="13981079" author="brandon.williams" created="Fri, 25 Apr 2014 14:54:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there anything you could think of that changed between 1.2 and 2.0 that could cause CF truncation to be much slower?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;any idea what could cause the Zero length BigInteger exception?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not without a clear way to reproduce it, or at least know what the query was.&lt;/p&gt;</comment>
                            <comment id="13981113" author="jfurmankiewicz" created="Fri, 25 Apr 2014 15:17:38 +0000"  >&lt;p&gt;Here is what I can see.&lt;/p&gt;

&lt;p&gt;The error occurs mostly after test cases where do a lot of multi-threaded mass inserts.&lt;/p&gt;

&lt;p&gt;We have loaders for reference data that can accept a CSV file (let&apos;s say with 10,000 records). We parse it line by line and parallelize the writes to various Cassandra tables (so just lots of runnable in an Executor all dumping data to Cassandra across many concurrent threads).&lt;/p&gt;

&lt;p&gt;Then as part of the validation we fetch a single column from a row (which has data as a byte array document). After 2-3 queries like that that are invoked from these test cases I can see the BigInteger exception pop up...and then the entire test suite just freezes for a few second waiting for Cassandra to proceed.&lt;/p&gt;

&lt;p&gt;Just by manually tailing system.log while watching the test suite execute I can see that this errors occurs every time we execute a test that has massive concurrent writes.&lt;/p&gt;</comment>
                            <comment id="13981156" author="brandon.williams" created="Fri, 25 Apr 2014 15:34:38 +0000"  >&lt;p&gt;My suggestion then is to turn on tracing, which will make it slower, but we&apos;ll be able to see what&apos;s going on post facto.&lt;/p&gt;</comment>
                            <comment id="13981199" author="jfurmankiewicz" created="Fri, 25 Apr 2014 16:14:10 +0000"  >&lt;p&gt;We are digging into it more and more. It does not seem to be the TRUNCATE after all.&lt;/p&gt;

&lt;p&gt;It seems that after many writes, we try to query (just before our BDD ends, so it looked like it is stuck trying to start a new one, hence our initial truncate suspicion).&lt;br/&gt;
Then we get this exception on a regular basis and everything just freezes for a while.&lt;/p&gt;

&lt;p&gt;We run in DEBUG mode to see what is going on and are getting this:&lt;/p&gt;

&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,403 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,403 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,404 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,418 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,419 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,419 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;OptionalTasks:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,437 ColumnFamilyStore.java (line 298) retryPolicy for sessions is 0.99&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;OptionalTasks:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,439 ColumnFamilyStore.java (line 298) retryPolicy for events is 0.99&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,533 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,533 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,534 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,534 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,534 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,535 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,535 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,536 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,536 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,536 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,537 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,537 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,537 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,538 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,538 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,538 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,539 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,539 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,539 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,540 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,540 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,540 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,541 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,541 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,541 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,542 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,542 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,542 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,543 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,543 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,543 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,544 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,544 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,544 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,544 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,545 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,545 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,545 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,545 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,546 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,546 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,546 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,546 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,547 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,547 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,547 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,548 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,548 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,548 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,548 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,549 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,549 CassandraServer.java (line 313) get_slice&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,549 StorageProxy.java (line 1226) Read: 0 ms.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,550 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:3&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,983 ReadCallback.java (line 103) Read timeout: org.apache.cassandra.exceptions.ReadTimeoutException: Operation timed out - received only 0 responses.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:3&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,984 StorageProxy.java (line 1243) Read timeout; received 0 of 1 responses&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:3&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,984 Tracing.java (line 159) request complete&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:4&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,984 CassandraServer.java (line 313) get_slice&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage:21&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,987 CassandraDaemon.java (line 198) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage:21,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.NumberFormatException: Zero length BigInteger&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1920)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:744)&lt;br/&gt;
Caused by: java.lang.NumberFormatException: Zero length BigInteger&lt;br/&gt;
	at java.math.BigInteger.&amp;lt;init&amp;gt;(BigInteger.java:190)&lt;br/&gt;
	at org.apache.cassandra.serializers.IntegerSerializer.deserialize(IntegerSerializer.java:32)&lt;br/&gt;
	at org.apache.cassandra.serializers.IntegerSerializer.deserialize(IntegerSerializer.java:26)&lt;br/&gt;
	at org.apache.cassandra.db.marshal.AbstractType.getString(AbstractType.java:156)&lt;br/&gt;
	at org.apache.cassandra.db.marshal.AbstractCompositeType.getString(AbstractCompositeType.java:242)&lt;br/&gt;
	at org.apache.cassandra.db.filter.SliceQueryFilter.collectReducedColumns(SliceQueryFilter.java:219)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateColumns(QueryFilter.java:122)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:80)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:72)&lt;br/&gt;
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:297)&lt;br/&gt;
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:53)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1540)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1369)&lt;br/&gt;
	at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:327)&lt;br/&gt;
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1352)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1916)&lt;br/&gt;
	... 3 more&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:7&amp;#93;&lt;/span&gt; 2014-04-25 11:10:49,990 CustomTThreadPoolServer.java (line 211) Thrift transport error occurred during processing of message.&lt;br/&gt;
org.apache.thrift.transport.TTransportException&lt;br/&gt;
	at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)&lt;br/&gt;
	at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)&lt;br/&gt;
	at org.apache.thrift.transport.TFramedTransport.readFrame(TFramedTransport.java:129)&lt;br/&gt;
	at org.apache.thrift.transport.TFramedTransport.read(TFramedTransport.java:101)&lt;br/&gt;
	at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)&lt;br/&gt;
	at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:362)&lt;br/&gt;
	at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:284)&lt;br/&gt;
	at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:191)&lt;br/&gt;
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:27)&lt;br/&gt;
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:201)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:744)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:2&amp;#93;&lt;/span&gt; 2014-04-25 11:10:50,404 CassandraServer.java (line 313) get_slice&lt;/p&gt;</comment>
                            <comment id="13981201" author="jfurmankiewicz" created="Fri, 25 Apr 2014 16:15:01 +0000"  >&lt;p&gt;I changed the JIRA title to reflect more accurately our suspicion.&lt;/p&gt;
</comment>
                            <comment id="13981204" author="jfurmankiewicz" created="Fri, 25 Apr 2014 16:17:29 +0000"  >&lt;p&gt;Since we do not get any exception on the Java side it is a bit complicated to figure out which query is causing this. I suspect it is a regular background query we have to a wide row with composite column, that we use as a sort of internal message queue for piping data from Cassandra to an external destination later.&lt;/p&gt;

&lt;p&gt;I will try to run our app in DEBUG mode as well to see which query correlates with this one and see if my suspicions are correct.&lt;/p&gt;

&lt;p&gt;if the stack trace above gives you any hints, let us know&lt;/p&gt;

&lt;p&gt;thank you&lt;/p&gt;</comment>
                            <comment id="13981248" author="jfurmankiewicz" created="Fri, 25 Apr 2014 17:00:05 +0000"  >&lt;p&gt;Hi Brandon, we have good news. I am not sure if you still want to treat it as an issue or not.&lt;/p&gt;

&lt;p&gt;The core underlying problem is that we had a mismatch between a composite column type in our Astyanax code (long,long,String) &lt;br/&gt;
vs how the the actual CF was created (CompositeType(LongType,LongType,IntegerType)).&lt;/p&gt;

&lt;p&gt;Now one ever noticed because it worked just fine in 1.2 (how I am not sure....it should have bombed on the first query....I suspect Astyanax did some raw binary serialization that somehow hid this underlying problem).&lt;/p&gt;

&lt;p&gt;However, once we moved to 2.0, Cassandra must have detected that something does not make sense in the query vs the underlying data representation and hence the zero length BigInteger error.&lt;/p&gt;

&lt;p&gt;So it is definitely an issue on our side.&lt;/p&gt;

&lt;p&gt;The only potential issue on the Cassandra side is that this error caused the entire query to freeze  until we got an operation timeout exception, which sort of hid the underlying issue for a while.&lt;/p&gt;

&lt;p&gt;I will leave  it up to you if you want to leave that particular issue open for further investigation on your side or close it.&lt;/p&gt;

&lt;p&gt;Thank you for your help along the way.&lt;/p&gt;</comment>
                            <comment id="13981479" author="brandon.williams" created="Fri, 25 Apr 2014 19:23:52 +0000"  >&lt;p&gt;Thanks Jacek!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The only potential issue on the Cassandra side is that this error caused the entire query to freeze until we got an operation timeout exception, which sort of hid the underlying issue for a while.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, we have a validation problem here and should be throwing InvalidRequestException.&lt;/p&gt;</comment>
                            <comment id="13990508" author="slebresne" created="Tue, 6 May 2014 10:20:30 +0000"  >&lt;p&gt;This is not a query validation problem. The fundamental problem is that we  made the mistake a long time ago of accepting an empty ByteBuffer as a valid value for any type, and we now have to live with this. Except that &lt;tt&gt;IntegerType.getString()&lt;/tt&gt; was not handling it properly (more precisely, it&apos;s &lt;tt&gt;IntegerSerializer.deserialize()&lt;/tt&gt; that is called by &lt;tt&gt;AbstractType.getString()&lt;/tt&gt; that was not handling it). And the reason the &lt;tt&gt;getString()&lt;/tt&gt; method was called in the first place is because of the tombstone log warning in &lt;tt&gt;SliceQueryFilter.collectReducedColumns()&lt;/tt&gt; (which is why 1.2 is not affected, that code is not there and we were never calling the &lt;tt&gt;getString()&lt;/tt&gt; method except maybe at DEBUG/TRACE).&lt;/p&gt;

&lt;p&gt;So the proper fix is to handle empty values in &lt;tt&gt;IntegerSerialize.deserialize()&lt;/tt&gt; and attaching a patch for this. The patch also clean up a bit the handling of null for getString/toString: most serializer were handling it properly and using &lt;tt&gt;&quot;&quot;&lt;/tt&gt; as representation, but &lt;tt&gt;AbstractType.getString()&lt;/tt&gt; was somewhat overriding that behavior using &lt;tt&gt;&quot;null&quot;&lt;/tt&gt; as representation. Now, an empty string (&lt;tt&gt;&quot;&quot;&lt;/tt&gt;) is kind of a better representation since that&apos;s how cqlsh will represent such value for instance, so the patch fix that too by removing the special casing of null in &lt;tt&gt;AbstractType.getString()&lt;/tt&gt; (since it&apos;s the job of the serializer to handle it) and make sure all serializer do handle it properly.&lt;/p&gt;</comment>
                            <comment id="13991474" author="jbellis" created="Wed, 7 May 2014 02:03:06 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13992874" author="slebresne" created="Thu, 8 May 2014 16:05:53 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12643532" name="7088.txt" size="5038" author="slebresne" created="Tue, 6 May 2014 10:20:30 +0000"/>
                            <attachment id="12641803" name="cassandra.yaml" size="31425" author="jfurmankiewicz" created="Thu, 24 Apr 2014 21:40:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>388759</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uysn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>389009</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>