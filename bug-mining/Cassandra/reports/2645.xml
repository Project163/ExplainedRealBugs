<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6733] Upgrade of 1.2.11 to 2.0.5 make IllegalArgumentException in Buffer.limit on read of a super column family</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6733</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a super column family which was first created with a 1.0.x. Then upgraded to 1.1.x, then to 1.2.11, and now to 2.0.5.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:QaUser&amp;gt; desc table user_view;
CREATE TABLE user_view (
  key bigint,
  column1 varint,
  column2 text,
  value counter,
  PRIMARY KEY (key, column1, column2)
) WITH COMPACT STORAGE AND
  bloom_filter_fp_chance=0.010000 AND
  caching=&apos;KEYS_ONLY&apos; AND
  comment=&apos;&apos; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  index_interval=128 AND
  read_repair_chance=1.000000 AND
  replicate_on_write=&apos;true&apos; AND
  populate_io_cache_on_flush=&apos;false&apos; AND
  default_time_to_live=0 AND
  speculative_retry=&apos;99.0PERCENTILE&apos; AND
  memtable_flush_period_in_ms=0 AND
  compaction={&apos;class&apos;: &apos;SizeTieredCompactionStrategy&apos;} AND
  compression={&apos;sstable_compression&apos;: &apos;SnappyCompressor&apos;};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With cqlsh, the following query was doing a timeout:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select * from user_view where key = 3 and column1 = 1 and column2 = &apos;20130218&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the log of cassandra, we could read:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [ReadStage:1385] 2014-02-19 14:45:19,549 CassandraDaemon.java (line 192) Exception in thread Thread[ReadStage:1385,5,main]
java.lang.IllegalArgumentException
        at java.nio.Buffer.limit(Buffer.java:267)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.getBytes(AbstractCompositeType.java:55)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.getWithShortLength(AbstractCompositeType.java:64)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:82)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:35)
        at org.apache.cassandra.db.marshal.AbstractType$1.compare(AbstractType.java:63)
        at org.apache.cassandra.db.marshal.AbstractType$1.compare(AbstractType.java:60)
        at java.util.Collections.indexedBinarySearch(Collections.java:377)
        at java.util.Collections.binarySearch(Collections.java:365)
        at org.apache.cassandra.io.sstable.IndexHelper.indexFor(IndexHelper.java:144)
        at org.apache.cassandra.db.columniterator.IndexedSliceReader$IndexedBlockFetcher.setNextSlice(IndexedSliceReader.java:262)
        at org.apache.cassandra.db.columniterator.IndexedSliceReader$IndexedBlockFetcher.&amp;lt;init&amp;gt;(IndexedSliceReader.java:255)
        at org.apache.cassandra.db.columniterator.IndexedSliceReader.&amp;lt;init&amp;gt;(IndexedSliceReader.java:91)
        at org.apache.cassandra.db.columniterator.SSTableSliceIterator.createReader(SSTableSliceIterator.java:65)
        at org.apache.cassandra.db.columniterator.SSTableSliceIterator.&amp;lt;init&amp;gt;(SSTableSliceIterator.java:42)
        at org.apache.cassandra.db.filter.SliceQueryFilter.getSSTableColumnIterator(SliceQueryFilter.java:167)
        at org.apache.cassandra.db.filter.QueryFilter.getSSTableColumnIterator(QueryFilter.java:62)
        at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:250)
        at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:53)
        at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1560)
        at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)
        at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:327)
        at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)
        at org.apache.cassandra.db.ReadVerbHandler.doVerb(ReadVerbHandler.java:47)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:60)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:724)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tried launching repair on our 2 nodes, nothing improved.&lt;br/&gt;
I tried launching a major compaction on this column family, the query doesn&apos;t fail anymore and return expected results;&lt;/p&gt;

&lt;p&gt;This happens on our cluster which is used for integration and test purpose, not much activity on it. There are only 2 nodes and the replication factor is at 1. Since it is our test cluster, I have a quite small (2 x ~500K) snapshot done before the upgrade of the cluster I could share, if needed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12695964">CASSANDRA-6733</key>
            <summary>Upgrade of 1.2.11 to 2.0.5 make IllegalArgumentException in Buffer.limit on read of a super column family</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="hibou">Nicolas Lalev&#233;e</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Feb 2014 14:18:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:53 +0000</updated>
                            <resolved>Tue, 4 Mar 2014 10:56:48 +0000</resolved>
                                        <fixVersion>2.0.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13906754" author="slebresne" created="Thu, 20 Feb 2014 08:28:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;I have a quite small (2 x ~500K) snapshot done before the upgrade of the cluster I could share, if needed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If it&apos;s no problem for you (and feel free to send it to me privately if you prefer), that would definitively simplify checking what&apos;s wrong (if you can share the original thrift table definition for completeness sake, that would be perfect).&lt;/p&gt;</comment>
                            <comment id="13907368" author="hibou" created="Thu, 20 Feb 2014 19:27:48 +0000"  >&lt;p&gt;See attached the compressed tar of the snapshot on the failing column family for both nodes.&lt;/p&gt;

&lt;p&gt;For the creation of the column family, it was done via Hector:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ColumnFamilyDefinition cfViewDef = HFactory.createColumnFamilyDefinition(keyspaceName, columnFamilyName);
cfViewDef.setColumnType(ColumnType.SUPER);
cfViewDef.setComparatorType(ComparatorType.INTEGERTYPE);
cfViewDef.setSubComparatorType(ComparatorType.UTF8TYPE);
cfViewDef.setDefaultValidationClass(ComparatorType.COUNTERTYPE.getClassName());
cluster.getCluster().addColumnFamily(cfViewDef, true);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then along the life of this column family, some manual operations were done via the cassandra-cli, like changing the compression, and setting a key validation class.&lt;/p&gt;</comment>
                            <comment id="13914455" author="slebresne" created="Thu, 27 Feb 2014 12:37:13 +0000"  >&lt;p&gt;Thanks Nicolas for the sstables and repro steps.&lt;/p&gt;

&lt;p&gt;The main problem is here that while we do translate super-columns from pre-2.0 sstable to their new composite encoding on the fly, we don&apos;t handle the index for those sstable (more precisely, we don&apos;t handle the &quot;promoted&quot; column index part of the index).&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a relatively simple patch to fix that. It&apos;s not excessively pretty, but we really only need that code for 2.0 since it&apos;s a mandatory stop before 2.1 and once the old sstable are rewritten we don&apos;t need that anymore (this is why compaction, which rewrite the sstables, fix that).&lt;/p&gt;

&lt;p&gt;I&apos;ll note that even with that patch and using the sstables attached above, the query mentioned in the description (&lt;tt&gt;select * from user_view where key = 3 and column1 = 1 and column2 = &apos;2013-02-18&apos;&lt;/tt&gt;) still doesn&apos;t work properly. It doesn&apos;t timeout anymore but return no results while it shouldn&apos;t. The reason for that is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6778&quot; title=&quot;FBUtilities.singleton() should use the CF comparator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6778&quot;&gt;&lt;del&gt;CASSANDRA-6778&lt;/del&gt;&lt;/a&gt; because it happens that the super column names in the sstable are all 8 bytes long even when they wouldn&apos;t need to.&lt;/p&gt;
</comment>
                            <comment id="13914661" author="hibou" created="Thu, 27 Feb 2014 15:41:14 +0000"  >&lt;p&gt;Thank you for the feedback. I&apos;ll revert my test cluster to the data of the snapshot before the upgrade, and revert to 1.2.11. I&apos;ll try an upgrade again as soon as a fix is released.&lt;/p&gt;</comment>
                            <comment id="13917961" author="slebresne" created="Mon, 3 Mar 2014 11:18:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vijay2win%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;vijay2win@yahoo.com&quot;&gt;vijay2win@yahoo.com&lt;/a&gt; marking you as reviewer since you were reviewer on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3237&quot; title=&quot;refactor super column implmentation to use composite column names instead&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3237&quot;&gt;&lt;del&gt;CASSANDRA-3237&lt;/del&gt;&lt;/a&gt; which this is basically a left-over. Feel free to complain if you don&apos;t have time to look at it (but it&apos;s not really a big patch).&lt;/p&gt;</comment>
                            <comment id="13919091" author="vijay2win@yahoo.com" created="Tue, 4 Mar 2014 07:32:37 +0000"  >&lt;p&gt;Hi Sylvain, No Problem and would love to do so.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Not sure why we do redundant checks on metadata.isSuper() inside SuperColumns.getComparatorFor()... (Not introduced by this patch though).&lt;br/&gt;
Nit: looks like isAfterSliceFinish is not used any more...&lt;/p&gt;</comment>
                            <comment id="13919177" author="iamaleksey" created="Tue, 4 Mar 2014 09:25:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m attaching a relatively simple patch to fix that. It&apos;s not excessively pretty, but we really only need that code for 2.0 since it&apos;s a mandatory stop before 2.1 and once the old sstable are rewritten we don&apos;t need that anymore (this is why compaction, which rewrite the sstables, fix that).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do we? We don&apos;t seem to require full upgradesstables on 2.0 for the 2.1 migration, or at least it&apos;s not there in NEWS.txt.&lt;/p&gt;</comment>
                            <comment id="13919179" author="iamaleksey" created="Tue, 4 Mar 2014 09:30:00 +0000"  >&lt;p&gt;(Should at least require it for super-CFs)&lt;/p&gt;</comment>
                            <comment id="13919214" author="slebresne" created="Tue, 4 Mar 2014 10:11:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;We don&apos;t seem to require full upgradesstables on 2.0 for the 2.1 migration&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oh, you&apos;re right, for some reason I though we had got rid of all SC compat code in 2.1 but that&apos;s just the MessagingService stuff. That being said, since we do require users to stop to 2.0 before into 2.1, I wonder if requiring them to upgrade their sstable is a huge deal, which would let us get rid of said compatibility code. Not a big deal though and we can decide that in another ticket (the patch here is not excessively pretty because it&apos;s a special case, but it&apos;s rather simple really, so not the end of the world if we have it in 2.1 too).&lt;/p&gt;</comment>
                            <comment id="13919218" author="iamaleksey" created="Tue, 4 Mar 2014 10:22:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;I wonder if requiring them to upgrade their sstable is a huge deal, which would let us get rid of said compatibility code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not a huge deal as long as it&apos;s limited to super columnfamilies only, since it wouldn&apos;t affect most anyone, relatively. That said, I prefer this to go into both 2.0 and 2.1, now that I realised that this affects &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6506&quot; title=&quot;counters++ split counter context shards into separate cells&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6506&quot;&gt;CASSANDRA-6506&lt;/a&gt; as well, which I now have to update (once this is pushed to 2.1). And not, it&apos;s not ugly.&lt;/p&gt;</comment>
                            <comment id="13919241" author="slebresne" created="Tue, 4 Mar 2014 10:56:40 +0000"  >&lt;p&gt;Committed, thanks (I&apos;ve merge the code to 2.1, we can decide when we want to drop compatibility with pre-2.0 sstables another time).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Not sure why we do redundant checks on metadata.isSuper() inside SuperColumns.getComparatorFor()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;They are not redundant in most call of this method, and we could have inlined the relevant part of this method for the sake of this patch, but it felt like reuse that method was cleaner and it&apos;s not like the redundant test will matter in practice.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Nit: looks like isAfterSliceFinish is not used any more&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Removed in commit, thanks.&lt;/p&gt;</comment>
                            <comment id="13940437" author="hibou" created="Wed, 19 Mar 2014 12:35:37 +0000"  >&lt;p&gt;I tried again the upgrade but with 2.0.6 on our test cluster, it was not straight forward (I&apos;ll ask for some insights on cassandra-user), but it was successful.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12631518" name="6733.txt" size="6358" author="slebresne" created="Thu, 27 Feb 2014 12:37:13 +0000"/>
                            <attachment id="12630125" name="QaUser_user_view_node1.tgz" size="164829" author="hibou" created="Thu, 20 Feb 2014 19:27:48 +0000"/>
                            <attachment id="12630126" name="QaUser_user_view_node2.tgz" size="78480" author="hibou" created="Thu, 20 Feb 2014 19:27:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>374442</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1siyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>374742</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325761">2.0.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vijay2win@yahoo.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>