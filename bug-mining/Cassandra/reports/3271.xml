<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8383] Memtable flush may expire records from the commit log that are in a later memtable</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8383</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is a pretty obvious bug with any care of thought, so not sure how I managed to introduce it. We use OpOrder to ensure all writes to a memtable have finished before flushing, however we also use this OpOrder to direct writes to the correct memtable. However this is insufficient, since the OpOrder is only a partial order; an operation from the &quot;future&quot; (i.e. for the next memtable) could still interleave with the &quot;past&quot; operations in such a way that they grab a CL entry inbetween the &quot;past&quot; operations. Since we simply take the max ReplayPosition of those in the past, this would mean any interleaved future operations would be expired even though they haven&apos;t been persisted to disk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12758212">CASSANDRA-8383</key>
            <summary>Memtable flush may expire records from the commit log that are in a later memtable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                            <label>commitlog</label>
                    </labels>
                <created>Thu, 27 Nov 2014 12:55:00 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:27 +0000</updated>
                            <resolved>Fri, 12 Dec 2014 13:22:42 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14227622" author="benedict" created="Thu, 27 Nov 2014 12:58:51 +0000"  >&lt;p&gt;Initial patch &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/8383-bug-clexpirereorder&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We should also introduce a commit log correctness stress test, so we can reproduce this, be certain it is fixed, and so we can be sure to avoid this or similar scenarios in future. &lt;/p&gt;</comment>
                            <comment id="14229478" author="jbellis" created="Mon, 1 Dec 2014 07:09:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14232130" author="aweisberg" created="Tue, 2 Dec 2014 21:11:38 +0000"  >&lt;p&gt;Does this deserve a regression test? I almost wish ReplayPosition implemented method wrappers for GT, GTE, LT, LTE, rather then using compareTo. For me there is mental overhead in parsing that kind of condition.&lt;/p&gt;

&lt;p&gt;If I understand correctly if this race occurs and the writing thread loses it will be kicked forward to the next memtable despite the fact that the op group says it could go into the current memtable.&lt;/p&gt;

&lt;p&gt;So for a memtable to accept a write (either no barrier must exist || the barrier exists but is after the op group) &amp;amp;&amp;amp; if a last replay position is set it must be &amp;gt;= the replay position of the write&lt;br/&gt;
If it is not set the replay position will be updated by the writer so the flusher gets the position of the last write to the memtable correctly.&lt;br/&gt;
If the replay position is finalized even though the op group says that the write could go into this memtable it is kicked into the next one which is harmless and op order still works since it chains dependencies in order.&lt;/p&gt;

&lt;p&gt;In effect the last replay position is frozen earlier so that when the second op group is created and starts interleaving in the CL anything beyond the frozen position is not considered for truncation after the memtable flushes.&lt;/p&gt;

&lt;p&gt;I think this does what I just said and I think that fixes the problem that is described where upon create of the next op group CL entries from different op groups interleave with the truncation point used for the CL. Freezing the truncation point before creating the second op group solves the problem.&lt;/p&gt;</comment>
                            <comment id="14232824" author="benedict" created="Wed, 3 Dec 2014 09:47:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does this deserve a regression test? &lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;We should also introduce a commit log correctness stress test, so we can reproduce this, be certain it is fixed, and so we can be sure to avoid this or similar scenarios in future.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, absolutely. However I have been tasked with other pressing things - I only took time out to file and address this because it is an obvious and dangerous potential failure of correctness. We should file a follow up ticket for introducing rigorous randomized testing to tease out any potential correctness issues from this codepath, which either can be looked at immediately by somebody else, or I can take a look at once my current workload is dealt with. But doing this well requires a bit of time and focus, which I didn&apos;t want holding up a fix.&lt;/p&gt;</comment>
                            <comment id="14244120" author="benedict" created="Fri, 12 Dec 2014 13:22:42 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22ulb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>