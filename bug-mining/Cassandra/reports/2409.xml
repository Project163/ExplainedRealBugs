<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6097] nodetool repair randomly hangs.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6097</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;nodetool repair randomly hangs. This is not the same issue where repair hangs if a stream is disrupted. This can be reproduced on a single-node cluster where no streaming takes place, so I think this may be a JMX connection or timeout issue. Thread dumps show that nodetool is waiting on a JMX response and there are no repair-related threads running in Cassandra. Nodetool main thread waiting for JMX response:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=5 tid=7ffa4b001800 nid=0x10aedf000 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [10aede000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	- waiting on &amp;lt;7f90d62e8&amp;gt; (a org.apache.cassandra.utils.SimpleCondition)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
	at org.apache.cassandra.utils.SimpleCondition.await(SimpleCondition.java:34)
	- locked &amp;lt;7f90d62e8&amp;gt; (a org.apache.cassandra.utils.SimpleCondition)
	at org.apache.cassandra.tools.RepairRunner.repairAndWait(NodeProbe.java:976)
	at org.apache.cassandra.tools.NodeProbe.forceRepairAsync(NodeProbe.java:221)
	at org.apache.cassandra.tools.NodeCmd.optionalKSandCFs(NodeCmd.java:1444)
	at org.apache.cassandra.tools.NodeCmd.main(NodeCmd.java:1213)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When nodetool hangs, it does not print out the following message:&lt;/p&gt;

&lt;p&gt;&quot;Starting repair command #XX, repairing 1 ranges for keyspace XXX&quot;&lt;/p&gt;

&lt;p&gt;However, Cassandra logs that repair in system.log:&lt;/p&gt;

&lt;p&gt;1380033480.95  INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-154&amp;#93;&lt;/span&gt; 10:38:00,882 Starting repair command #X, repairing X ranges for keyspace XXX&lt;/p&gt;

&lt;p&gt;This suggests that the repair command was received by Cassandra but the connection then failed and nodetool didn&apos;t receive a response.&lt;/p&gt;

&lt;p&gt;Obviously, running repair on a single-node cluster is pointless but it&apos;s the easiest way to demonstrate this problem. The customer who reported this has also seen the issue on his real multi-node cluster.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;Note: I reproduced this once on the official DataStax AMI with DSE 3.1.3 (Cassandra 1.2.6+patches).  I was unable to reproduce on my Mac using the same version, and subsequent attempts to reproduce it on the AMI were unsuccessful. The customer says he is able is able to reliably reproduce on his Mac using DSE 3.1.3 and occasionally reproduce it on his real cluster. &lt;/p&gt;

&lt;p&gt;1) Deploy an AMI using the DataStax AMI at &lt;a href=&quot;https://aws.amazon.com/amis/datastax-auto-clustering-ami-2-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://aws.amazon.com/amis/datastax-auto-clustering-ami-2-2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2) Create a test keyspace&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create keyspace test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3) Run an endless loop that runs nodetool repair repeatedly:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; nodetool repair -pr test; done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4) Wait until repair hangs. It may take many tries; the behavior is random.&lt;/p&gt;</description>
                <environment>&lt;p&gt;DataStax AMI&lt;/p&gt;</environment>
        <key id="12670530">CASSANDRA-6097</key>
            <summary>nodetool repair randomly hangs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="jblangston@datastax.com">J.B. Langston</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Sep 2013 17:54:21 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:04 +0000</updated>
                            <resolved>Wed, 9 Oct 2013 15:40:04 +0000</resolved>
                                        <fixVersion>1.2.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13778048" author="brandon.williams" created="Wed, 25 Sep 2013 20:39:54 +0000"  >&lt;p&gt;It took a few thousands of iterations to reproduce, but it did happen (on my own machine, not in AWS or using the AMI)  Netstat shows one connection from nodetool to the jmx port that stays connected, and another one that connects, gets disconnected after a short while, then the process repeats.  This sounds like jmx doing it&apos;s double connection dance, but whatever reason the server rejects the second one.  I&apos;m not sure there&apos;s anything we can do about this except say what we already know: jmx kinda sucks.&lt;/p&gt;

&lt;p&gt;One odd thing I did notice occasionally get printed straight to stdout/err while running the loop:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Sep 25, 2013 7:55:52 PM ServerCommunicatorAdmin reqIncoming
WARNING: The server has decided to close this client connection.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However it didn&apos;t correlate to the iteration that hung.&lt;/p&gt;</comment>
                            <comment id="13781504" author="jblangston@datastax.com" created="Sun, 29 Sep 2013 21:07:11 +0000"  >&lt;p&gt;If I&apos;m reading &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/tools/NodeProbe.java#L1036-L1039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; correctly, the condition that nodetool repair is waiting on won&apos;t get signaled if the status returned to the NotificationListener is SESSION_FAILED. Could that explain why it&apos;s hanging?&lt;/p&gt;</comment>
                            <comment id="13781515" author="yukim" created="Sun, 29 Sep 2013 22:25:02 +0000"  >&lt;p&gt;Repair should send back FINISHED at the end of the repair even if session failed. &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L2414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L2414&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13782397" author="jblangston@datastax.com" created="Mon, 30 Sep 2013 23:08:07 +0000"  >&lt;p&gt;I think the ease with which this can be reproduced is dependent on the number of keyspaces.  I started up a stock 3.1.3 AMI in hadoop mode so that DSE would create the cfs/HiveMetaStore/dse_system keyspaces and also created an additional keyspace using the customer&apos;s schema. Now I am able to reproduce the issue very readily by running nodetool repair -pr in a loop.  I thought that it might have been something to do with having hadoop enabled, so i disabled it again, but I am still able to reproduce the issue.  On the other hand, if I give repair a specific keyspace name, it takes much longer to reproduce, if at all.&lt;/p&gt;</comment>
                            <comment id="13782482" author="mishail" created="Tue, 1 Oct 2013 00:33:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jblangston%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;jblangston@datastax.com&quot;&gt;jblangston@datastax.com&lt;/a&gt; do you have a full thread dump for the problem?&lt;/p&gt;</comment>
                            <comment id="13782956" author="jblangston@datastax.com" created="Tue, 1 Oct 2013 14:08:58 +0000"  >&lt;p&gt;Stack trace for nodetool and cassandra attached.&lt;/p&gt;</comment>
                            <comment id="13783136" author="mishail" created="Tue, 1 Oct 2013 17:10:53 +0000"  >&lt;p&gt;I suspect it could be infamous hang at &lt;tt&gt;SocketInputStream.socketRead0&lt;/tt&gt;. And the only way I know to work around is to limit &lt;tt&gt;sun.net.client.defaultReadTimeout&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;ClientNotifForwarder-5&quot;&lt;/span&gt; daemon prio=10 tid=0x00007f133c2e4000 nid=0x7549 runnable [0x00007f13389de000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.read(SocketInputStream.java:129)
	at java.io.BufferedInputStream.fill(BufferedInputStream.java:218)
	at java.io.BufferedInputStream.read(BufferedInputStream.java:237)
	- locked &amp;lt;0x00000000ff562dc0&amp;gt; (a java.io.BufferedInputStream)
	at java.io.DataInputStream.readByte(DataInputStream.java:248)
	at sun.rmi.transport.StreamRemoteCall.executeCall(StreamRemoteCall.java:195)
	at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:142)
	at com.sun.jmx.remote.internal.PRef.invoke(Unknown Source)
	at javax.management.remote.rmi.RMIConnectionImpl_Stub.fetchNotifications(Unknown Source)
	at javax.management.remote.rmi.RMIConnector$RMINotifClient.fetchNotifs(RMIConnector.java:1306)
	at com.sun.jmx.remote.internal.ClientNotifForwarder$NotifFetcher.fetchNotifs(ClientNotifForwarder.java:554)
	at com.sun.jmx.remote.internal.ClientNotifForwarder$NotifFetcher.doRun(ClientNotifForwarder.java:437)
	at com.sun.jmx.remote.internal.ClientNotifForwarder$NotifFetcher.run(ClientNotifForwarder.java:418)
	at com.sun.jmx.remote.internal.ClientNotifForwarder$LinearExecutor$1.run(ClientNotifForwarder.java:88)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13783281" author="jblangston@datastax.com" created="Tue, 1 Oct 2013 20:05:46 +0000"  >&lt;p&gt;The JMX documentation &lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/tech/best-practices-jsp-136021.html#mozTocId387765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;states&lt;/a&gt; that notifications are not guaranteed to always be delivered.  The API only guarantees that a client either receives all notifications for which it is listening, or can discover that notifications may have been lost. A client can discover when notifications are lost by registering a listener using JMXConnector.addConnectionNotificationListener. It looks like nodetool isn&apos;t doing this last part. Seems like we should register a ConnectionNotificationListener and if a notification fails, signal the condition so that nodetool doesn&apos;t hang. Maybe have nodetool query for the status of the repair at that point via separate JMX call, or just print a warning that &quot;The status of the repair command can&apos;t be determined, please check the log.&quot; or something like that.&lt;/p&gt;

&lt;p&gt;I would disagree with prioritizing this as trivial. It&apos;s not critical but I have had many customers express frustration with the  nodetool repair&apos;s proclivity for hanging.  It makes automating repairs painful because they can&apos;t count on nodetool to ever return.&lt;/p&gt;</comment>
                            <comment id="13785324" author="yukim" created="Thu, 3 Oct 2013 16:34:14 +0000"  >&lt;p&gt;JB is right. We need to handle cases where connection got lost.&lt;br/&gt;
Attaching patch to listen to JMXConnectionNotification.&lt;/p&gt;

&lt;p&gt;There are 2 cases handled. One is for &quot;notification lost&quot;. In this case, We cannot tell if repair finished, so log message to check server log and go on to next keyspace for repair. The other one is for &quot;connection closed&quot;, and in this case we throw exception to stop further processing of repair.&lt;/p&gt;</comment>
                            <comment id="13786948" author="jbellis" created="Sat, 5 Oct 2013 05:37:05 +0000"  >&lt;p&gt;Tagging Sylvain for review since he also reviewed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4767&quot; title=&quot;Need some indication of node repair success or failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4767&quot;&gt;&lt;del&gt;CASSANDRA-4767&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13790412" author="slebresne" created="Wed, 9 Oct 2013 14:47:32 +0000"  >&lt;p&gt;I&apos;ve tried reproducing but lost patience when it didn&apos;t reproduce after &amp;gt; 1K iterations, so can&apos;t say I&apos;ve &quot;tested&quot; the fix, but the JMX documentation makes it pretty clear we should handle those notifications and that it&apos;s very likely the source of the problem here. A few minor nits on the patch though:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Is there a reason JMXConnectionNotification.FAILED is not handled? Feels like it would be a good to catch it too just in case.&lt;/li&gt;
	&lt;li&gt;May want to mention in the error message for CLOSED/FAILED that we&apos;re not starting repair for the other keyspaces not yet started.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But lgtm otherwise&lt;/p&gt;</comment>
                            <comment id="13790526" author="yukim" created="Wed, 9 Oct 2013 15:40:04 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
Committed with above nits fix.&lt;/p&gt;</comment>
                            <comment id="13790844" author="jblangston@datastax.com" created="Wed, 9 Oct 2013 20:49:00 +0000"  >&lt;p&gt;Customer compiled Cassandra from git and ran the resulting nodetool against his DSE installation. He reported that the hang is still reproducible.  I haven&apos;t tried to duplicate this myself yet.&lt;/p&gt;</comment>
                            <comment id="13793704" author="yukim" created="Sun, 13 Oct 2013 16:52:25 +0000"  >&lt;p&gt;I think the issue they are having is platform specific.&lt;br/&gt;
Try setting sun.net.client.defaultReadTimeout system property (-Dsun.net.client.defaultReadTimeout=&amp;lt;timeout in millisec&amp;gt;) as suggested by Mikhail above to avoid stuck on socket read.&lt;br/&gt;
(&lt;a href=&quot;http://docs.oracle.com/javase/6/docs/technotes/guides/net/properties.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/technotes/guides/net/properties.html&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13793708" author="brandon.williams" created="Sun, 13 Oct 2013 17:00:37 +0000"  >&lt;p&gt;After this patch, I could not reproduce the problem after 10K iterations.&lt;/p&gt;</comment>
                            <comment id="13793710" author="jbellis" created="Sun, 13 Oct 2013 17:04:37 +0000"  >&lt;p&gt;(Unless this was already fine in 2.0, we should tag fixversion appropriately.)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12606597" name="6097-1.2.txt" size="5615" author="yukim" created="Thu, 3 Oct 2013 16:34:14 +0000"/>
                            <attachment id="12606104" name="dse.stack" size="44394" author="jblangston@datastax.com" created="Tue, 1 Oct 2013 14:08:58 +0000"/>
                            <attachment id="12606103" name="nodetool.stack" size="6504" author="jblangston@datastax.com" created="Tue, 1 Oct 2013 14:08:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350359</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1oerr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350652</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>