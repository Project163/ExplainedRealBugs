<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:18:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14834] Avoid keeping StreamingTombstoneHistogramBuilder.Spool in memory during the whole compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14834</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13444&quot; title=&quot;Fast and garbage-free Streaming Histogram&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13444&quot;&gt;&lt;del&gt;CASSANDRA-13444&lt;/del&gt;&lt;/a&gt; &lt;tt&gt;StreamingTombstoneHistogramBuilder.Spool&lt;/tt&gt; is allocated to keep around an array with 131072 * 2 * 2 integers &lt;b&gt;per written sstable&lt;/b&gt; during the whole compaction. With LCS at times creating 1000s of sstables during a compaction it kills the node.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13192860">CASSANDRA-14834</key>
            <summary>Avoid keeping StreamingTombstoneHistogramBuilder.Spool in memory during the whole compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aholmber">Adam Holmberg</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Oct 2018 14:28:36 +0000</created>
                <updated>Wed, 20 Jan 2021 22:28:51 +0000</updated>
                            <resolved>Wed, 20 Jan 2021 22:28:51 +0000</resolved>
                                        <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17242683" author="aholmber" created="Wed, 2 Dec 2020 20:08:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; I was thinking of taking a look at this, but I see you&apos;re assigned. Do you have something in mind already? Intend to work on this?&lt;/p&gt;</comment>
                            <comment id="17243272" author="aholmber" created="Thu, 3 Dec 2020 15:27:42 +0000"  >&lt;p&gt;I looked at it for a few minutes yesterday and at first blush it looked like it should be a simple solution to release the large buffer when metadata is &quot;finalized&quot;. However, this &lt;a href=&quot;https://github.com/apache/cassandra/blob/00fb6d76d0a97af06ba27c1180d6dcddfa337fea/src/java/org/apache/cassandra/utils/streamhist/StreamingTombstoneHistogramBuilder.java#L138-L140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;comment&lt;/a&gt; gives me pause.&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;Creates a &apos;finished&apos; snapshot of the current state of the historgram, but leaves this builder instance&lt;/li&gt;
	&lt;li&gt;open for subsequent additions to the histograms. Basically, this allows us to have some degree of sanity&lt;/li&gt;
	&lt;li&gt;wrt sstable early open.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;It seems to suggest that we have instances being updated after finalization. Will have to dig into that a bit more. It might still be possible to update the histogram without the large buffers, but I need to understand how impactful that would be (or indeed, if the comment is still valid).&lt;/p&gt;

&lt;p&gt;Not moving this ticket yet due to a handful of other things in-flight.&lt;/p&gt;</comment>
                            <comment id="17249297" author="aholmber" created="Mon, 14 Dec 2020 20:52:54 +0000"  >&lt;p&gt;I got a chance to look at this and I think the comment above may be overreaching. I was hoping that the buffer could be released on finalize, but it&apos;s not quite that simple. I did find that MetricsCollector#finalizeMetadata (which calls build on the histo) is called several times in the lifecycle, which is makes the &quot;finalize&quot; semantics a bit confusing. I looked into memoizing the result, but found that the metrics can actually be &lt;a href=&quot;https://github.com/apache/cassandra/blob/4c103447af3c4829e3a1c733bed3952fd059af08/src/java/org/apache/cassandra/io/compress/CompressedSequentialWriter.java#L355&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updated&lt;/a&gt; between the first and last call. I did not, however, find any instance of the histogram being updated after the first call to finalize/build. Therefore, my proposal is to drop the buffers as soon as we switch to a new writer (and will have no further samples to update on the previous writer), but leave the collector in a state that things can still be updated and metrics rebuilt repeatedly. The patch does this by adding a simple call chain to explicitly &quot;release&quot; the metadata overhead when writing is done.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/aholmberg/cassandra/pull/24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/aholmberg/cassandra?branch=CASSANDRA-14834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ci&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17261379" author="michaelsembwever" created="Fri, 8 Jan 2021 15:39:20 +0000"  >&lt;p&gt;ci-cassandra CI &#8211;&#160;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/281/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/281/pipeline&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17268886" author="michaelsembwever" created="Wed, 20 Jan 2021 21:43:43 +0000"  >&lt;p&gt;latest circleci also looks good &lt;a href=&quot;https://app.circleci.com/pipelines/github/aholmberg/cassandra?branch=CASSANDRA-14834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17268898" author="michaelsembwever" created="Wed, 20 Jan 2021 22:28:51 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/5e8f7f591dfec5a61d8eb2e9e977ec29f3a2bbe4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5e8f7f591dfec5a61d8eb2e9e977ec29f3a2bbe4&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aholmber]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zeyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/5e8f7f591dfec5a61d8eb2e9e977ec29f3a2bbe4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/5e8f7f591dfec5a61d8eb2e9e977ec29f3a2bbe4&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;No doc.&lt;br/&gt;
I didn&apos;t come with a test that would prove that we would not OOM because of this. I&apos;m open to suggestions.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>