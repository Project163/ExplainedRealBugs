<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3085] Race condition in sstable reference counting</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3085</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;DataTracker gives us an atomic View of memtable/sstables, but acquiring references is not atomic.  So it is possible to acquire references to an SSTableReader object that is no longer valid, as in this example:&lt;/p&gt;

&lt;p&gt;View V contains sstables &lt;/p&gt;
{A, B}
&lt;p&gt;.  We attempt a read in thread T using this View.&lt;br/&gt;
Meanwhile, A and B are compacted to &lt;/p&gt;
{C}
&lt;p&gt;, yielding View W.  No references exist to A or B so they are cleaned up.&lt;br/&gt;
Back in thread T we acquire references to A and B.  This does not cause an error, but it will when we attempt to read from them next.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12520293">CASSANDRA-3085</key>
            <summary>Race condition in sstable reference counting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Aug 2011 19:22:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:52 +0000</updated>
                            <resolved>Mon, 29 Aug 2011 20:29:48 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13092043" author="jbellis" created="Fri, 26 Aug 2011 20:59:34 +0000"  >&lt;p&gt;Turns out this is only a problem for where we&apos;re operating on sub-View granularity post-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1608&quot; title=&quot;Redesigned Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1608&quot;&gt;&lt;del&gt;CASSANDRA-1608&lt;/del&gt;&lt;/a&gt;: CFS.markCurrentViewReferenced was correctly retrying until it got a consistent set of references.&lt;/p&gt;</comment>
                            <comment id="13092559" author="jbellis" created="Sun, 28 Aug 2011 21:56:38 +0000"  >&lt;p&gt;v2 encapsulates the lockless atomic acquisition in CFS.markReferenced(Interval).&lt;/p&gt;

&lt;p&gt;Not 100% sure how important the changes to the getRangeSlice tokens were, that I took out. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;If we need those, we might need to make getRangeSlice loop manually w/o the encapsulation, since we need the view to compute the Interval, but we need the Interval to search for sstables.&lt;/p&gt;</comment>
                            <comment id="13092928" author="slebresne" created="Mon, 29 Aug 2011 15:55:07 +0000"  >&lt;ul&gt;
	&lt;li&gt;The try of the try...finally block should start just after the markReferenced to be safe in CollationControler.&lt;/li&gt;
	&lt;li&gt;In CFS.getRangeSlice, I am not confortable using the same try...finally block for both the view and the iterator. RowIteratorFactory.getIterator() does make seeks and could throw an error that would leave a bunch of sstable referenced.&lt;/li&gt;
	&lt;li&gt;Nit: Maybe we could use a plain old DataTracker.View instead of introducing ViewFragment, since the View constructor is accessible to CFS anyway ?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13092938" author="jbellis" created="Mon, 29 Aug 2011 16:02:52 +0000"  >&lt;p&gt;It seems weird to me to overload the purpose of a full View for this: it&apos;s not meant to be updated, nor does it contain the full set of sstables.  I think I&apos;d rather use a different class so that View&apos;s purpose remains clear.&lt;/p&gt;</comment>
                            <comment id="13092949" author="slebresne" created="Mon, 29 Aug 2011 16:16:36 +0000"  >&lt;p&gt;I would argue that even now a View is not meant to be updated either (we pick new Views but a View itself is fixed), nor does it really ensure that it contains the full set of sstables in a way since that set is a moving target. But I suppose this is just a matter of perspective on what View is, and I&apos;m fine with ViewFragment. &lt;/p&gt;</comment>
                            <comment id="13093166" author="jbellis" created="Mon, 29 Aug 2011 20:29:34 +0000"  >&lt;p&gt;committed with requested fixes, fix for interval computation involving stopAt.isEmpty(), and javadoc for CFS.markReferenced&lt;/p&gt;</comment>
                            <comment id="13093215" author="hudson" created="Mon, 29 Aug 2011 21:17:27 +0000"  >&lt;p&gt;Integrated in Cassandra #1055 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/1055/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/1055/&lt;/a&gt;)&lt;br/&gt;
    fix race condition in sstable reference counting&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3085&quot; title=&quot;Race condition in sstable reference counting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3085&quot;&gt;&lt;del&gt;CASSANDRA-3085&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1162988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1162988&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/CollationController.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/RowIteratorFactory.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13104993" author="yangyangyyy" created="Wed, 14 Sep 2011 23:17:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;but it will when we attempt to read from them next.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Jonathan: since the sstable deletion code is wrapped inside SSTableReader.releaseReference(), I thought as long as anyone is holding a reference to the SSTableReader, the file would not be deleted? could you please explain a bit?&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Yang&lt;/p&gt;</comment>
                            <comment id="13105018" author="jbellis" created="Wed, 14 Sep 2011 23:58:41 +0000"  >&lt;p&gt;Right.  A sstable starts with one reference.  When we do a read, we acquire a reference, then release when we&apos;re done.  When we compact it, we release a reference.  &lt;/p&gt;

&lt;p&gt;So we can do arbitrary numbers of reads w/o reference count getting to zero, but once we compact, either the compact release or a read release will drop it to zero. This last release will unmap and delete it, whether from compaction or a read.&lt;/p&gt;</comment>
                            <comment id="13105212" author="yangyangyyy" created="Thu, 15 Sep 2011 08:37:41 +0000"  >&lt;p&gt;Thanks Jonathan.&lt;/p&gt;

&lt;p&gt;but I still can&apos;t see why the old code would cause errors, could you please see if the following reasoning makes sense?&lt;/p&gt;



&lt;p&gt;if you look at the operations of +1 and -1 by read paths and the compaction path, either the read path or the compaction can be seen as the following sequence&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;//access the SSTableReader&lt;/p&gt;

&lt;p&gt;-1&lt;/p&gt;


&lt;p&gt;where for the compaction the &quot;+1&quot; happens at creation of the SSTableReader; for read paths the &quot;+1&quot; happens at acquireReference()&lt;/p&gt;

&lt;p&gt;since every path (either compaction or reader) does one +1 and one -1, by the time a path finishes, the ref count will be equal to the number of live code paths&lt;/p&gt;

&lt;p&gt;if the file is removed, the ref count must be 0, hence live paths count at that moment must be 0. if there are no future paths to run, it&apos;s all good. if there are , the path would access a file already removed and we have a problem. but this is impossible because: if  the +1 comes after compaction.release(), because &lt;b&gt;compaction.release() comes after the view change in DataTracker.replace()&lt;/b&gt;, then reader path +1 comes after DataTracker.replace(),  but this is impossible because the read path can not see that SSTableReader in its view.&lt;/p&gt;
</comment>
                            <comment id="13105646" author="jbellis" created="Thu, 15 Sep 2011 19:59:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;since every path (either compaction or reader) does one +1 and one -1&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not so &amp;#8211; you&apos;re missing the &quot;this sstable is compacted and is obsolete&quot; release done by DataTracker.&lt;/p&gt;</comment>
                            <comment id="13105922" author="yangyangyyy" created="Fri, 16 Sep 2011 07:35:07 +0000"  >
&lt;blockquote&gt;&lt;p&gt;Not so &#8211; you&apos;re missing the &quot;this sstable is compacted and is obsolete&quot; release done by DataTracker.&lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;do you mean this part in DataTracker ? (line 262)&lt;/p&gt;

&lt;p&gt;    private void replace(Collection&amp;lt;SSTableReader&amp;gt; oldSSTables, Iterable&amp;lt;SSTableReader&amp;gt; replacements)&lt;br/&gt;
    {&lt;br/&gt;
        View currentView, newView;&lt;br/&gt;
        do&lt;/p&gt;
        {
            currentView = view.get();
            newView = currentView.replace(oldSSTables, replacements);
        }
&lt;p&gt;        while (!view.compareAndSet(currentView, newView));&lt;/p&gt;

&lt;p&gt;        addNewSSTablesSize(replacements);&lt;br/&gt;
        removeOldSSTablesSize(oldSSTables); //&amp;lt;==== this calls releaseReference() &lt;/p&gt;

&lt;p&gt;        notifySSTablesChanged(replacements, oldSSTables);&lt;br/&gt;
        cfstore.updateCacheSizes();&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;the SSTableReaders which do a releaseReference() are all in the &quot;oldSSTables&quot; set, the newView takes out all the oldSSTables in the newView computation. Since the view change is done atomically in view.compareAndSet(), each SSTableReader can invoke the releaseReference() only once in this path, since once it&apos;s called releaseReference(), it must have been removed from the view.&lt;/p&gt;

&lt;p&gt;so, for this path, each SSTableReader can invoke the releaseReference() once in its life time. that&apos;s what I   mean: you can &quot;view&quot; the compaction path as  doing  a &quot;+&quot; at the construction of SSTableReader, and doing a corresponding &quot;-&quot; at the code above.&lt;/p&gt;


&lt;p&gt;also &lt;br/&gt;
StreamingOutSession.close() calls releaseReference() without acquireReference(), would that cause a problem ? similar calls are StreamingOut.createPendingFiles() , StreamingOutSession.startNext()&lt;/p&gt;


&lt;p&gt;Thanks a lot for your patience, please pardon my numerous questions, I just want to make sure that I thoroughly understand it and there are no hidden issues.&lt;/p&gt;</comment>
                            <comment id="13105950" author="slebresne" created="Fri, 16 Sep 2011 08:39:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;but I still can&apos;t see why the old code would cause errors&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think it was, the report of this issue is not totally correct, but the code was fairly ugly: badly encapsulated and potentially more inefficient that it needs to.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;StreamingOutSession.close() calls releaseReference() without acquireReference(), would that cause a problem ? similar calls are StreamingOut.createPendingFiles() , StreamingOutSession.startNext()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s not a problem because those releaseReference calls do are paired with acquireReference calls (or rather they are supposed to be and last time I checked all seemed ok). The only thing is that in that case, the acquireReference calls are unfortunately not near (from a code point of view) to their paired releaseReference. But we have no choice with how the code of streaming is structured right now. Typically for a streamOutSession, references are acquired in either StreamingRepairTask or StreamOut.transferRanges and released as soon as the sstable is not needed, that is either in createPendingFiles() if it happens the sstable has none of the ranges we want to stream or in next()/close() when the sstable has been fully streamed (and thus won&apos;t been accessed by this streamOutSession).&lt;/p&gt;

&lt;p&gt;The only small annoying thing with Streaming is that since acquire/release is not enclosed within a try ... finally block, we could leave a sstable marked forever if an error occurs during streaming. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3112&quot; title=&quot;Make repair fail when an unexpected error occurs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3112&quot;&gt;&lt;del&gt;CASSANDRA-3112&lt;/del&gt;&lt;/a&gt; includes code that would basically allow to deal with this. &lt;/p&gt;</comment>
                            <comment id="13106953" author="yangyangyyy" created="Sat, 17 Sep 2011 00:26:54 +0000"  >&lt;p&gt;thanks guys, I&apos;m clear now&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12492015" name="3085-v2.txt" size="16920" author="jbellis" created="Sun, 28 Aug 2011 21:58:27 +0000"/>
                            <attachment id="12491836" name="3085.txt" size="22927" author="jbellis" created="Fri, 26 Aug 2011 20:59:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20962</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gfhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93940</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>