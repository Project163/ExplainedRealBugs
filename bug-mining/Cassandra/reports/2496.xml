<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:41:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6284] Wrong tracking of minLevel in Leveled Compaction Strategy causing serious performance problems</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6284</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;since version 2.0.0 (incl. beta), Leveled Compaction Strategy contains a hard-to-spot bug in choosing of sstable candidates to be compacted with tables in higher level. It always chooses first sstable in L1 and only first 1/10 of sstables in other higher levels.&lt;/p&gt;

&lt;p&gt;This is caused by an error when determining &quot;minLevel&quot; of compacted tables in replace() function in LeveledManifest.java which is then used as an index to lastCompactedKeys array to ensure sort of &quot;round robin&quot; selection of SStables for compaction in each level. In the newer versions the minLevel is computed as the minimum of levels of newly created sstables instead of the old sstables. &lt;br/&gt;
Typically compaction takes one table from L(X), compacts it with N tables in L(X+1) and produces M tables in L(X+1). Thus, the lastCompactedKey is improperly accounted to one level higher then it should be.&lt;/p&gt;

&lt;p&gt;This causes serious performance problems as the uniform token range distribution across sstables in one level is broken.&lt;br/&gt;
In L1, the first SStable is always chosen to be compacted with overlapping tables in L2. Since a newly created tables in L0 contains practically whole range of keys of a given node, and the rest of ~9 tables in L1 are never pushed to the higher levels, they tend to contain higher and higher keys over time in very narrow token range. As a direct consequence, the first (the chosen) SStable in L1 (after a compaction of L1 tables with the L0 table) thus contains much wider range than anticipated ~1/10 , which forces compaction with many more tables in L2 than normally expected due to bigger overlap.&lt;br/&gt;
The similar problem appears in higher levels as well.&lt;/p&gt;

&lt;p&gt;We noticed gradual performance degradation since we upgraded C* from 1.2.9 to 2.0.0 aprox. 1 month ago which we tracked down to increased compaction activity. We noticed that the number of sstables processed in one compaction is much higher than expected. The compaction IO activity in our case is more than 5 higher than in 1.2.9 version and only becomes worse.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677083">CASSANDRA-6284</key>
            <summary>Wrong tracking of minLevel in Leveled Compaction Strategy causing serious performance problems</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="JiriHorky">Jiri Horky</assignee>
                                    <reporter username="JiriHorky">Jiri Horky</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Fri, 1 Nov 2013 15:15:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:01 +0000</updated>
                            <resolved>Fri, 22 Nov 2013 23:07:58 +0000</resolved>
                                        <fixVersion>2.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13811334" author="jirihorky" created="Fri, 1 Nov 2013 15:21:05 +0000"  >&lt;p&gt;The attached patch fixes this bug. The patch applies to 2.0.0. as well as to 2.0.2.&lt;/p&gt;</comment>
                            <comment id="13811439" author="jbellis" created="Fri, 1 Nov 2013 16:52:42 +0000"  >&lt;p&gt;Patch LGTM.  Can you add a test case to LeveledCompactionStrategyTest?&lt;/p&gt;</comment>
                            <comment id="13811606" author="rcoli" created="Fri, 1 Nov 2013 20:05:40 +0000"  >&lt;p&gt;Is 2.0.0 beta is the correct &quot;since&quot; for this ticket?&lt;/p&gt;</comment>
                            <comment id="13811626" author="jbellis" created="Fri, 1 Nov 2013 20:30:08 +0000"  >&lt;p&gt;Probably.  Git annotate if you&apos;re not sure.&lt;/p&gt;</comment>
                            <comment id="13811676" author="rcoli" created="Fri, 1 Nov 2013 21:26:32 +0000"  >&lt;p&gt;For the record :&lt;/p&gt;

&lt;p&gt;git annotate says &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4872&quot; title=&quot;Move manifest into sstable metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4872&quot;&gt;&lt;del&gt;CASSANDRA-4872&lt;/del&gt;&lt;/a&gt; introduces the MAX_LEVEL line fixed in the second part of the patch.&lt;/p&gt;

&lt;p&gt;So &quot;since&quot; 2.0.1 beta 1 is correct. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13812718" author="jirihorky" created="Mon, 4 Nov 2013 09:56:15 +0000"  >&lt;p&gt;Regarding adding the test case - I think that the right test should  insert enough data to have something in L3, and then try to go through all tables in L1 and L2 and see 1) whether all sstables contain more or less the right token range (1/10 for L1 and 1/100 for L2) with some (possibly relatively high) tolerance and 2) that both levels effectively contain the whole token range the node is responsible for. Unfortunately, I won&apos;t be able to contribute that sooner than in a week and can&apos;t really promise that it will be good enough afterwards (I am not a Java programmer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13830397" author="jbellis" created="Fri, 22 Nov 2013 23:07:58 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12611617" name="LeveledManifest.bug.6284.patch" size="1436" author="JiriHorky" created="Fri, 1 Nov 2013 15:23:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[JiriHorky]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356459</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pg93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12322954">2.0 beta 1</customfieldvalue>
    <customfieldvalue id="12324760">2.0 beta 2</customfieldvalue>
    <customfieldvalue id="12324787">2.0 rc1</customfieldvalue>
    <customfieldvalue id="12324946">2.0 rc2</customfieldvalue>
    <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    <customfieldvalue id="12324542">2.0.1</customfieldvalue>
    <customfieldvalue id="12325023">2.0.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12322954">2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>