<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2872] While dropping and recreating an index, incremental snapshotting can hang</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2872</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When creating a hard link (at list with JNA), link() hang if the target of the&lt;br/&gt;
link already exists. In theory though, we should not hit that situation&lt;br/&gt;
because we use a new directory for each manual snapshot and the generation&lt;br/&gt;
number of the sstables should prevent this from hapenning with increment&lt;br/&gt;
snapshot.&lt;/p&gt;

&lt;p&gt;However, when you drop, then recreate a secondary index, if the sstables are&lt;br/&gt;
deleted after the drop and before we recreate the index, the recreated index&lt;br/&gt;
sstables will start with a generation to 0. Thus, when we start backuping them&lt;br/&gt;
incrementally, it will conflict with the sstables of the previously dropped&lt;br/&gt;
index.&lt;/p&gt;

&lt;p&gt;First, we should check for the target existance because calling link() to at&lt;br/&gt;
least avoid hanging. But then we must make sure that when we drop, then&lt;br/&gt;
recreate an index, we will either not name the sstables the same way or the&lt;br/&gt;
incremental snapshot use a different directory.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12513235">CASSANDRA-2872</key>
            <summary>While dropping and recreating an index, incremental snapshotting can hang</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Jul 2011 08:59:40 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:56 +0000</updated>
                            <resolved>Tue, 19 Jul 2011 18:08:19 +0000</resolved>
                                        <fixVersion>0.7.8</fixVersion>
                    <fixVersion>0.8.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13064236" author="slebresne" created="Tue, 12 Jul 2011 23:43:15 +0000"  >&lt;p&gt;One option could be to have some kind of &quot;index&quot; generation that we would persist in the system tables. What I mean here is that if you create a index on say column &apos;birthdate&apos; for some CF test, the index would start being called test.birthdate.1 (or just test.birthdate for compatibility sake), then if you drop it and recreate it, it would be called test.birthdate.2. That way, we would avoid the name clash during the incremental backup.&lt;/p&gt;</comment>
                            <comment id="13064240" author="jbellis" created="Tue, 12 Jul 2011 23:49:10 +0000"  >&lt;p&gt;I really don&apos;t like messing with the name.  That feels like the implementation is leaking too much into something user-visible.&lt;/p&gt;</comment>
                            <comment id="13067775" author="jbellis" created="Tue, 19 Jul 2011 15:06:51 +0000"  >&lt;p&gt;Remind me why simply making sstable generation global doesn&apos;t fix this?&lt;/p&gt;

&lt;p&gt;It&apos;s not like there&apos;s so much contention on that AtomicInteger that we need to partition it.&lt;/p&gt;</comment>
                            <comment id="13067783" author="slebresne" created="Tue, 19 Jul 2011 15:22:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Remind me why simply making sstable generation global doesn&apos;t fix this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you drop an index, then shutdown the node, then restart and recreate the index. Upon restart and crawling of the existing data files, it could be that the first available generation is the one of a sstable of the dropped index.&lt;/p&gt;

&lt;p&gt;I guess there is two reasonably simple solutions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;scan the (incremental) snapshot directories for the generation number too. If we do that, I guess we don&apos;t even have to make the generation global as long as we do this scanning each time a ColumnFamilyStore is created.&lt;/li&gt;
	&lt;li&gt;make the generation number persistent in the system tables (again, no need to make the number global for that).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think I prefer the second solution because it&apos;s more general and feels more elegant. But we would still have to scan the data dir and take the max(what we found during scan, what&apos;s in the system table) in case people force-feed data files that weren&apos;t created on that node (or the system tables are wiped).&lt;/p&gt;

&lt;p&gt;That being said, I totally agree that the generation number don&apos;t have to be partitioned if we don&apos;t want to. But not sure it&apos;s a big deal that way either.&lt;/p&gt;</comment>
                            <comment id="13067808" author="jbellis" created="Tue, 19 Jul 2011 16:07:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;we would still have to scan the data dir and take the max(what we found during scan, what&apos;s in the system table) in case people force-feed data files that weren&apos;t created on that node (or the system tables are wiped).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s why I prefer the scan approach &amp;#8211; I&apos;d rather have a single reliable source of truth (the contents of the fs) than an unreliable one that we have to supplement with the reliable one anyway.&lt;/p&gt;

&lt;p&gt;Patch attached.&lt;/p&gt;</comment>
                            <comment id="13067838" author="slebresne" created="Tue, 19 Jul 2011 16:54:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;That&apos;s why I prefer the scan approach&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I kind of wrote my comment before as things were coming to me, in particular I wrote that I was preferring the second solution before realizing we would still need to scan. Agreeing that the scan approach is cleaner/easier.&lt;/p&gt;

&lt;p&gt;On the patch, shouldn&apos;t we only include the sstables for the column family we&apos;re creating. I know it&apos;s ok to take the max for all cfs, but it feels a bit random unless we have only one global generation. And could be worst avoiding 2-3 mails on the mailing of people wondering why that has changed (I mean, I&apos;m sure someone will remark it) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. &lt;/p&gt;</comment>
                            <comment id="13067845" author="jbellis" created="Tue, 19 Jul 2011 17:06:10 +0000"  >&lt;p&gt;v2 restricts to the CF in question.&lt;/p&gt;</comment>
                            <comment id="13067849" author="slebresne" created="Tue, 19 Jul 2011 17:13:19 +0000"  >&lt;p&gt;lgtm +1&lt;/p&gt;

&lt;p&gt;And I can confirm that this fix the failing test of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2521&quot; title=&quot;Move away from Phantom References for Compaction/Memtable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2521&quot;&gt;&lt;del&gt;CASSANDRA-2521&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="13067871" author="jbellis" created="Tue, 19 Jul 2011 18:08:19 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13067911" author="hudson" created="Tue, 19 Jul 2011 19:41:05 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #531 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.7/531/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.7/531/&lt;/a&gt;)&lt;br/&gt;
    fix re-using index CF sstable names after drop/recreate&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2872&quot; title=&quot;While dropping and recreating an index, incremental snapshotting can hang&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2872&quot;&gt;&lt;del&gt;CASSANDRA-2872&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1148466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1148466&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12504814">CASSANDRA-2521</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12487033" name="2872-v2.txt" size="5004" author="jbellis" created="Tue, 19 Jul 2011 17:06:10 +0000"/>
                            <attachment id="12487019" name="2872.txt" size="4917" author="jbellis" created="Tue, 19 Jul 2011 16:08:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20875</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gdyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93693</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>