<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3006] Enormous counter</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3006</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have two-node cluster with the following keyspace and column family settings.&lt;/p&gt;

&lt;p&gt;Cluster Information:&lt;br/&gt;
   Snitch: org.apache.cassandra.locator.SimpleSnitch&lt;br/&gt;
   Partitioner: org.apache.cassandra.dht.RandomPartitioner&lt;br/&gt;
   Schema versions: &lt;br/&gt;
	63fda700-c243-11e0-0000-2d03dcafebdf: &lt;span class=&quot;error&quot;&gt;&amp;#91;172.17.19.151, 172.17.19.152&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Keyspace: test:&lt;br/&gt;
  Replication Strategy: org.apache.cassandra.locator.NetworkTopologyStrategy&lt;br/&gt;
  Durable Writes: true&lt;br/&gt;
    Options: &lt;span class=&quot;error&quot;&gt;&amp;#91;datacenter1:2&amp;#93;&lt;/span&gt;&lt;br/&gt;
  Column Families:&lt;br/&gt;
    ColumnFamily: testCounter (Super)&lt;br/&gt;
    &quot;APP status information.&quot;&lt;br/&gt;
      Key Validation Class: org.apache.cassandra.db.marshal.BytesType&lt;br/&gt;
      Default column value validator: org.apache.cassandra.db.marshal.CounterColumnType&lt;br/&gt;
      Columns sorted by: org.apache.cassandra.db.marshal.BytesType/org.apache.cassandra.db.marshal.BytesType&lt;br/&gt;
      Row cache size / save period in seconds: 0.0/0&lt;br/&gt;
      Key cache size / save period in seconds: 200000.0/14400&lt;br/&gt;
      Memtable thresholds: 1.1578125/1440/247 (millions of ops/MB/minutes)&lt;br/&gt;
      GC grace seconds: 864000&lt;br/&gt;
      Compaction min/max thresholds: 4/32&lt;br/&gt;
      Read repair chance: 1.0&lt;br/&gt;
      Replicate on write: true&lt;br/&gt;
      Built indexes: []&lt;/p&gt;

&lt;p&gt;Then, I use a test program based on hector to add a counter column (testCounter&lt;span class=&quot;error&quot;&gt;&amp;#91;sc&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;column&amp;#93;&lt;/span&gt;) 1000 times. In the middle the adding process, I intentional shut down the node 172.17.19.152. In addition to that, the test program is smart enough to switch the consistency level from Quorum to One, so that the following adding actions would not fail. &lt;/p&gt;

&lt;p&gt;After all the adding actions are done, I start the cassandra on 172.17.19.152, and I use cassandra-cli to check if the counter is correct on both nodes, and I got a result 1001 which should be reasonable because hector will retry once. However, when I shut down 172.17.19.151 and after 172.17.19.152 is aware of 172.17.19.151 is down, I try to start the cassandra on 172.17.19.151 again. Then, I check the counter again, this time I got a result 481387 which is so wrong.&lt;/p&gt;

&lt;p&gt;I use 0.8.3 to reproduce this bug, but I think this also happens on 0.8.2 or before also. &lt;/p&gt;</description>
                <environment>&lt;p&gt;ubuntu 10.04&lt;/p&gt;</environment>
        <key id="12518299">CASSANDRA-3006</key>
            <summary>Enormous counter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="yulinyen">Boris Yen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Aug 2011 09:41:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:54 +0000</updated>
                            <resolved>Wed, 10 Aug 2011 15:31:46 +0000</resolved>
                                        <fixVersion>0.8.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13081545" author="yulinyen" created="Tue, 9 Aug 2011 09:43:08 +0000"  >&lt;p&gt;I forgot the mention that the counter is out of sync between these two nodes, one shows 481387 and the other one shows 20706.&lt;/p&gt;</comment>
                            <comment id="13081660" author="slebresne" created="Tue, 9 Aug 2011 14:28:19 +0000"  >&lt;p&gt;I&apos;ve haven&apos;t had luck with reproducing so far. I&apos;ve tried to stick with the description above but did not used hector (not saying it is hector fault though, maybe it is the way it does retry that I don&apos;t emulate well). If you are able to share a minimal hector script with which you reproduce this easily, that would be very helpful.&lt;/p&gt;</comment>
                            <comment id="13082091" author="yulinyen" created="Wed, 10 Aug 2011 01:57:27 +0000"  >&lt;p&gt;Here is the test program I am using now. the hector version is 0.8.0-2.&lt;br/&gt;
Hope this will be helpful.&lt;br/&gt;
------------------------------------------------&lt;/p&gt;

&lt;p&gt;import java.util.Arrays;&lt;/p&gt;

&lt;p&gt;import me.prettyprint.cassandra.model.AllOneConsistencyLevelPolicy;&lt;br/&gt;
import me.prettyprint.cassandra.serializers.StringSerializer;&lt;br/&gt;
import me.prettyprint.cassandra.service.CassandraHostConfigurator;&lt;br/&gt;
import me.prettyprint.cassandra.service.ThriftCluster;&lt;br/&gt;
import me.prettyprint.hector.api.Keyspace;&lt;br/&gt;
import me.prettyprint.hector.api.beans.HCounterColumn;&lt;br/&gt;
import me.prettyprint.hector.api.factory.HFactory;&lt;br/&gt;
import me.prettyprint.hector.api.mutation.Mutator;&lt;/p&gt;

&lt;p&gt;import org.slf4j.Logger;&lt;br/&gt;
import org.slf4j.LoggerFactory;&lt;/p&gt;


&lt;p&gt;public class CounterTest {&lt;br/&gt;
	private Logger logger = LoggerFactory.getLogger(CounterTest.class) ;&lt;br/&gt;
	private static final Integer COUNTER_NUM = 1000 ;&lt;br/&gt;
	private static final StringSerializer ss = StringSerializer.get();&lt;br/&gt;
	private static final String HOST = &quot;172.17.19.151:9160&quot; ;&lt;br/&gt;
	private ThriftCluster cluster ;&lt;/p&gt;

&lt;p&gt;	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param args&lt;br/&gt;
	 */&lt;br/&gt;
	public static void main(String[] args) {&lt;br/&gt;
		CounterTest tc = new CounterTest() ;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;		try &lt;/p&gt;
{
			tc.testAlarmCounter() ;
		}
&lt;p&gt; catch (InterruptedException e) {&lt;/p&gt;

&lt;p&gt;		}&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;	public CounterTest()&lt;/p&gt;
{
		CassandraHostConfigurator chc = new CassandraHostConfigurator(HOST) ;
		chc.setMaxActive(100) ;
		chc.setMaxIdle(10) ;
		chc.setCassandraThriftSocketTimeout(60000) ;
		
		cluster = new ThriftCluster(&quot;Test Cluster&quot;, chc) ;
	}

&lt;p&gt;	public void testAlarmCounter() throws InterruptedException{&lt;br/&gt;
		int successCounter = 0 ;&lt;br/&gt;
		int cl = 0;&lt;/p&gt;

&lt;p&gt;		for(int i=0; i&amp;lt;COUNTER_NUM; i++){&lt;br/&gt;
			try&lt;/p&gt;
{
				logger.info(&quot;count: &quot;+i) ;
				
				Mutator&amp;lt;String&amp;gt; mutator = HFactory.createMutator(getKeyspace(cl), StringSerializer.get());
				
				HCounterColumn&amp;lt;String&amp;gt; column = HFactory.createCounterColumn(&quot;testSC&quot;, 1L) ;
				mutator.addCounter(&quot;sc&quot;, &quot;testCounter&quot;, HFactory.createCounterSuperColumn(&quot;testC&quot;, Arrays.asList(column), ss, ss));
				mutator.execute() ;
				
				successCounter++ ;
			}
&lt;p&gt; catch(Exception e)&lt;/p&gt;
{
				logger.info(&quot;Error! Change consistency level to 1.&quot;, e) ;
				cl=1 ;
			}

&lt;p&gt;			Thread.sleep(50) ;&lt;br/&gt;
		}&lt;/p&gt;

&lt;p&gt;		logger.info(&quot;\nsuccess counter: &quot;+successCounter) ;&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;	private Keyspace getKeyspace(int cl)&lt;/p&gt;
{
		if(cl == 1)
			return HFactory.createKeyspace(&quot;test&quot;, cluster, new AllOneConsistencyLevelPolicy()) ;
		else
			return HFactory.createKeyspace(&quot;test&quot;, cluster) ; // default consistency level is Quorum
	}
&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="13082122" author="yulinyen" created="Wed, 10 Aug 2011 03:32:13 +0000"  >&lt;p&gt;In order to make it easier to reproduce this issue, I document how I recreate this issue step by step.&lt;/p&gt;

&lt;p&gt;1. clean any thing that is inside /var/lib/cassandra on node 172.17.19.151&lt;/p&gt;

&lt;p&gt;2. start cassandra on node 172.17.19.151.&lt;/p&gt;

&lt;p&gt;3. clean any thing that is inside /var/lib/cassnadra on node 172.17.19.152&lt;/p&gt;

&lt;p&gt;4. modify the cassandra.yaml of 172.17.19.152 and add 172.17.19.151 as a seed.&lt;/p&gt;

&lt;p&gt;5. start cassandra on node 172.17.19.152, I could see two node has formed a cluster, I also double check that using nodetool.&lt;/p&gt;

&lt;p&gt;6. on node 172.17.19.151, I use cassandra-cli: to connect 172.17.19.151/9160, and execute commands -&amp;gt; &lt;/p&gt;

&lt;p&gt;create keyspace test&lt;br/&gt;
with placement_strategy = &apos;org.apache.cassandra.locator.NetworkTopologyStrategy&apos;&lt;br/&gt;
and strategy_options = [&lt;/p&gt;
{datacenter1:2}
&lt;p&gt;];&lt;/p&gt;

&lt;p&gt;create column family testCounter&lt;br/&gt;
    with column_type = Super&lt;br/&gt;
    and default_validation_class = CounterColumnType&lt;br/&gt;
    and replicate_on_write = true&lt;br/&gt;
    and comparator = BytesType&lt;br/&gt;
    and subcomparator = BytesType&lt;br/&gt;
    and comment = &apos;APP status information.&apos;;&lt;/p&gt;

&lt;p&gt;7. use the test program to add the counter 1000 times. between each adding action the program will pause 50 millisecond.&lt;/p&gt;

&lt;p&gt;8. in the middle of the adding process, shut down the cassandra on node 172.17.19.152, (let&apos;s say I shut down node 172.17.19.152 when count is 200.). Because the test program changes the consistency level to One when it encounters an exception (timeout exception to be exact), the following adding actions will still be success.&lt;/p&gt;

&lt;p&gt;9. wait for the overall adding process to complete. I saw &quot;success counter: 999&quot; due to one exception. &lt;/p&gt;

&lt;p&gt;10. use the cassandra-cli to connect to 172.17.19.151 and 172.17.19.152 and check the counter value, the value is 1001 on both nodes. It shows 1001 because hector will retry when it encounters the timeout exception. &lt;/p&gt;

&lt;p&gt;11. shutdown the cassandra on 172.17.19.151, wait for a few seconds, I saw &quot;InetAddress /172.17.19.151 is now dead&quot; on node 172.17.19.152.&lt;/p&gt;

&lt;p&gt;12. after seeing &quot;InetAddress /172.17.19.151 is now dead&quot;, restart the cassandra on node 172.17.19.151.&lt;/p&gt;

&lt;p&gt;13. check the counter again with cassandra-cli on both nodes, this time the counter should no longer be 1001, it should be other weird number.&lt;/p&gt;

&lt;p&gt;Hope someone else could recreate it by these steps.&lt;/p&gt;</comment>
                            <comment id="13082319" author="slebresne" created="Wed, 10 Aug 2011 13:24:03 +0000"  >&lt;p&gt;Thanks, that helps a lot.&lt;/p&gt;

&lt;p&gt;The problem is due to the RowMutation optimization that keeps the serialized data received on the wire to use in the commit log. This is wrong for counters because we use the deserialization of the RowMutation to clean the delta on the counter columns.&lt;/p&gt;

&lt;p&gt;At least in the script to reproduce, this was a hint problem. The first node was creating a hint for the second one and was storing it himself (and the value of this hints was not cleared because of the bug above).&lt;/p&gt;

&lt;p&gt;Patch attached to fix this. This basically disable the optimization for RowMutation that contains counter. I don&apos;t pretend this is particularly clean but I don&apos;t see any other simple solution.&lt;/p&gt;</comment>
                            <comment id="13082385" author="jbellis" created="Wed, 10 Aug 2011 15:02:19 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;(nit: we can break from the loop once we find a counter)&lt;/p&gt;</comment>
                            <comment id="13082400" author="slebresne" created="Wed, 10 Aug 2011 15:31:46 +0000"  >&lt;p&gt;Committed with breaking early change.&lt;/p&gt;</comment>
                            <comment id="13082439" author="hudson" created="Wed, 10 Aug 2011 16:21:20 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #267 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/267/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/267/&lt;/a&gt;)&lt;br/&gt;
    Force deserialization of RowMutation for counters&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3006&quot; title=&quot;Enormous counter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3006&quot;&gt;&lt;del&gt;CASSANDRA-3006&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156221&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/RowMutation.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13083978" author="yulinyen" created="Fri, 12 Aug 2011 06:40:29 +0000"  >&lt;p&gt;Just tried 0.8.4. It seems much better now, but I still got value that is not what I expected.&lt;/p&gt;

&lt;p&gt;Follow the same steps above, after step 11, I check the counter on .152, the counter values changes from 1001 to 200. And then I follow the steps 12 and 13. The counter value of .151 is still 1001, but the counter value of .152 is still 200. After  changing the consistencylevel to quorum and do the read again, this time the counter value of .152 became 1001.&lt;/p&gt;

&lt;p&gt;I am kind of confused, because at step 10, I can get 1001 on both nodes, how come the value of .152 changes to 200 when .151 is down. Is this the right behavior of current design? &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12489971" name="3006.patch" size="1318" author="slebresne" created="Wed, 10 Aug 2011 13:24:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20933</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gesv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93828</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>