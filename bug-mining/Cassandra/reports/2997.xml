<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:46:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7390] MoveTest fails intermittently</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7390</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Reproduce with:&lt;br/&gt;
for i in `seq 1 50`; do runTest MoveTest &amp;gt;&amp;gt; moveTestFailures.txt;done&lt;/p&gt;

&lt;p&gt;Looks to fail roughly once out of every 5 runs or so&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;failure&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[junit] Testcase: newTestWriteEndpointsDuringMove(org.apache.cassandra.service.MoveTest):   FAILED
[junit] mismatched number of moved token expected:&amp;lt;0&amp;gt; but was:&amp;lt;1&amp;gt;
[junit] junit.framework.AssertionFailedError: mismatched number of moved token expected:&amp;lt;0&amp;gt; but was:&amp;lt;1&amp;gt;
[junit]     at org.apache.cassandra.service.MoveTest.newTestWriteEndpointsDuringMove(MoveTest.java:140)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Edit: had this as Windows-only - turns out it&apos;s failing on on *nix as well&lt;/p&gt;</description>
                <environment></environment>
        <key id="12720949">CASSANDRA-7390</key>
            <summary>MoveTest fails intermittently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="jmckenzie">Josh McKenzie</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jun 2014 19:13:21 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:07 +0000</updated>
                            <resolved>Wed, 9 Jul 2014 21:00:21 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14029961" author="jmckenzie" created="Thu, 12 Jun 2014 22:53:00 +0000"  >&lt;p&gt;PendingRangeCalculatorService.instance.blockUntilFinished() doesn&apos;t actually block until all operations are complete as we can have a race between the pendingRangeTask and of whomever was blocking on the prior function.  A simple 100ms sleep on the unit test resolves the problem, however we have 3 places in StorageService that are relying on completion of blockUntilFinished() that now seem like prime targets for this race.&lt;/p&gt;

&lt;p&gt;I&apos;m thinking a refcount between update() and PendingRangeTask() w/an atomic inside PendingRangeCalculatorService to have blockUntilFinished() actually do what it claims to do should resolve this but I&apos;m not too keen on adding that in there unless absolutely necessary.&lt;/p&gt;</comment>
                            <comment id="14029978" author="jmckenzie" created="Thu, 12 Jun 2014 23:09:27 +0000"  >&lt;p&gt;Just noticed - the logic inside blockUntilFinished &lt;b&gt;does&lt;/b&gt; check for pending jobs, so my previous comment about the function racing w/pendingRangeTasks is incorrect.  That being said, there definitely is still a race in play here.&lt;/p&gt;</comment>
                            <comment id="14037940" author="jmckenzie" created="Thu, 19 Jun 2014 21:43:02 +0000"  >&lt;p&gt;Looks like I opened Pandora&apos;s Box on this one.  A couple patches:&lt;/p&gt;

&lt;p&gt;7390_conservative_v1.txt: cleans up a few underlying issues causing failures in MoveTest.  The logic on PendingRangeCalculatorService.blockUntilFinished() relied on ThreadPoolExecutor.getActiveCount() to determine the # of running threads - checking the documentation shows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;getActiveCount&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
* Returns the approximate number of threads that are actively
* executing tasks.
*
* @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the number of threads
*/
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getActiveCount() {...}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Changing that to an AtomicBoolean sentinel and getting rid of the now unnecessary DiscardPolicy for extra threads took care of one race.&lt;/p&gt;

&lt;p&gt;Also cleaned up the inter-test StorageService / TokenMetadata reset logic in MoveTest.java, added some missing fields to TokenMetadata.resetUnsafe(), and added another blockUntilFinished between a couple of back-to-back onChange calls in testSimultaneousMove() that would infrequently race on PendingRangeCalculatorService.update() calls.&lt;/p&gt;

&lt;p&gt;With the above changes, unit test failure rate drops from 1 out of 5 runs to 1 out of 100 on average.&lt;/p&gt;

&lt;p&gt;I&apos;m a little wary of what that back-to-back onChange call seems to imply about the design of the PendingRangeCalculatorService&apos;s queue&apos;ing model - it looks like we can have a race where we hit the PendingRangeCalculatorService for an update while another one is already running, drop the new update() request with the expectation that it&apos;ll be caught by the PendingRangeTask that&apos;s in-flight, and have our logical update missed until the next update() call.  This may just be an artifact of unit-tests hitting onChange back-to-back being non-representative of real use-cases timing.&lt;/p&gt;

&lt;p&gt;7390_lockpendingcalc.txt: As to the final 1% failure - from my initial inspection of TokenMetadata code and flow, it looks like we&apos;re pulling out values from internal data structures in multiple discrete atomic steps in calculatePendingRanges. This leaves scheduling holes where other threads (variety of onChange paths, some nodetool commands, and brute-force unit-tests) can hop in, grab the write lock, and make changes to TokenMetadata while our pending calc is active:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;2 discrete read locks example&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;BiMultiValMap&amp;lt;Token, InetAddress&amp;gt; bootstrapTokens = tm.getBootstrapTokens();
&lt;span class=&quot;code-comment&quot;&gt;// No lock held here
&lt;/span&gt;Set&amp;lt;InetAddress&amp;gt; leavingEndpoints = tm.getLeavingEndpoints();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This patch migrates the pending range calculation inside TokenMetadata while holding a readlock for its entirety and addresses the potential race that occurs there (0 failures in &amp;gt; 1200 runs) - it also holds the readlock on TokenMetadata for a pretty long chunk of time (8-9000 usec on a trivial unit-test case on a laptop).  That being said, reads will still operate during these time windows and the infrequency of writes blocking / showing this race indicates to me that we shouldn&apos;t have serious contention with this change.  Attaching a separate patch for moving pending range calc to TokenMetadata as that&apos;s more invasive and might just be a race we&apos;re comfortable accepting to keep contention down in the structure.&lt;/p&gt;</comment>
                            <comment id="14046142" author="jbellis" created="Fri, 27 Jun 2014 16:58:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14046156" author="jmckenzie" created="Fri, 27 Jun 2014 17:08:55 +0000"  >&lt;p&gt;rebased&lt;/p&gt;</comment>
                            <comment id="14049028" author="thobbs" created="Tue, 1 Jul 2014 16:31:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;it looks like we can have a race where we hit the PendingRangeCalculatorService for an update while another one is already running, drop the new update() request with the expectation that it&apos;ll be caught by the PendingRangeTask that&apos;s in-flight&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The current code should actually be fine there.  It&apos;s using a single executor thread &lt;em&gt;and&lt;/em&gt; a queue of length one, so if an operation is already in flight, we will still queue up one more.  We just don&apos;t bother to queue more than one.  The 7390_conservative patch breaks that by not queuing a task if one is already in flight.&lt;/p&gt;

&lt;p&gt;The rest of that patch and the 7390_lockpendingcalc patch look good to me.  I think you&apos;re correct about contention not being an issue in realistic scenarios.&lt;/p&gt;</comment>
                            <comment id="14049034" author="brandon.williams" created="Tue, 1 Jul 2014 16:35:47 +0000"  >&lt;p&gt;I will mention that messing with the beast known as TMD makes me a bit nervous.&lt;/p&gt;</comment>
                            <comment id="14050604" author="jmckenzie" created="Wed, 2 Jul 2014 19:34:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s using a single executor thread and a queue of length one, so if an operation is already in flight, we will still queue up one more.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good call - I completely missed the fact that we were providing a workQueue for the thing to queue up jobs.  I&apos;ll pull that from the conservative and re-attach.&lt;/p&gt;

&lt;p&gt;As for messing with TMD - having dug through the code a bit I agree that modifying access patterns and synchronization on a component this complex opens the door to some unintended consequences.  Hopefully targeting 3.0 w/this change should give us plenty of time to bake this in.&lt;/p&gt;</comment>
                            <comment id="14050934" author="jmckenzie" created="Thu, 3 Jul 2014 00:55:58 +0000"  >&lt;p&gt;Attaching a combined v3 w/an atomic counter that gates update() calls to 1 in-flight, 1 in-queue as in original functionality.  We could rely on the RejectedExecutionHandler but I&apos;d prefer to keep us to a single abstraction to track the number of jobs we have in flight.&lt;/p&gt;

&lt;p&gt;Also took the opportunity to remove a bunch of dead includes that got shifted into TMD.&lt;/p&gt;</comment>
                            <comment id="14055120" author="thobbs" created="Tue, 8 Jul 2014 16:48:11 +0000"  >&lt;p&gt;The v3 patch still has a bit of a race condition:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updateJobs.get() &amp;lt; 2)
   {
       updateJobs.incrementAndGet();
       executor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PendingRangeTask());
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The increment and check need to happen atomically instead of in two separate calls.  For example, you could do:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updateJobs.incrementAndGet() &amp;lt;= 2)
       executor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PendingRangeTask());
   &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
       updateJobs.decrementAndGet();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Either that, or you could always increment and submit a task regardless of the current count and use the rejected execution handler to decrement the count.&lt;/p&gt;</comment>
                            <comment id="14055216" author="jmckenzie" created="Tue, 8 Jul 2014 18:01:54 +0000"  >&lt;p&gt;Good catch on the race - totally slipped by me.  I like the symmetry of &quot;whatever the thread pool does will take care of decrementing&quot; rather than branching on the update() call.  Attaching a v4 w/the race addressed and a new RejectedExecutionHandler.&lt;/p&gt;</comment>
                            <comment id="14056752" author="thobbs" created="Wed, 9 Jul 2014 21:00:21 +0000"  >&lt;p&gt;Thanks, v4 committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12991953">CASSANDRA-12281</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12651506" name="7390_conservative_v1.txt" size="6157" author="joshuamckenzie" created="Thu, 19 Jun 2014 21:43:02 +0000"/>
                            <attachment id="12652863" name="7390_conservative_v2.txt" size="6190" author="joshuamckenzie" created="Fri, 27 Jun 2014 17:08:55 +0000"/>
                            <attachment id="12651507" name="7390_lockpendingcalc.txt" size="14079" author="joshuamckenzie" created="Thu, 19 Jun 2014 21:43:02 +0000"/>
                            <attachment id="12653733" name="7390_v3_full.txt" size="20689" author="joshuamckenzie" created="Thu, 3 Jul 2014 00:55:58 +0000"/>
                            <attachment id="12654627" name="7390_v4_full.txt" size="20813" author="joshuamckenzie" created="Tue, 8 Jul 2014 18:01:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399148</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wpr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399263</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>