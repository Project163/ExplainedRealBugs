<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6514] Nodetool Refresh / CFS.loadNewSSTables() can Lose New SSTables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6514</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When nodetool refresh / CFS.loadNewSSTables() renames the newly loaded SSTables, it doesn&apos;t check to make sure the new name doesn&apos;t already exist.  It&apos;s easy for one of the newly loaded files themselves to have one of these names, so the rename will wipe out one of the SSTables you intended to load.&lt;/p&gt;

&lt;p&gt;For example, if you create a new, empty table, move two SSTables with generations 1 and 2 into the data directory, and then call &lt;tt&gt;nodetool refresh&lt;/tt&gt;, you might see this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO 15:37:42,587 Loading new SSTables for duration_test/ints...
 INFO 15:37:42,601 Renaming new SSTable /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-2 to /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-1
 INFO 15:37:42,605 Opening /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-1 (424005 bytes)
 INFO 15:37:42,614 Renaming new SSTable /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-1 to /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-2
 INFO 15:37:42,615 Opening /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-2 (424005 bytes)
 INFO 15:37:42,617 Loading new SSTables and building secondary indexes for duration_test/ints: [SSTableReader(path=&apos;/var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-1-Data.db&apos;), SSTableReader(path=&apos;/var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-2-Data.db&apos;)]
 INFO 15:37:42,618 Done loading load new SSTables for duration_test/ints
ERROR 15:38:09,428 Exception in thread Thread[ReadStage:40,5,main]
java.lang.RuntimeException: java.lang.RuntimeException: java.io.FileNotFoundException: /var/lib/cassandra/data/duration_test/ints/duration_test-ints-jb-1-Data.db (No such file or directory)
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1939)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:724)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12685696">CASSANDRA-6514</key>
            <summary>Nodetool Refresh / CFS.loadNewSSTables() can Lose New SSTables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Dec 2013 22:40:05 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:57 +0000</updated>
                            <resolved>Tue, 18 Mar 2014 23:17:53 +0000</resolved>
                                        <fixVersion>2.0.7</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                    <component>Tool/nodetool</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13853410" author="thobbs" created="Thu, 19 Dec 2013 22:43:13 +0000"  >&lt;p&gt;Attached patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-6514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) checks for conflicts when renaming the loaded SSTables and includes a unit test that exercises this.&lt;/p&gt;</comment>
                            <comment id="13853421" author="jbellis" created="Thu, 19 Dec 2013 22:50:14 +0000"  >&lt;p&gt;I&apos;m not sure it&apos;s worth special-casing the rename, since flush/compaction can still error out here.  Either we need to solve it everywhere or tell people, &quot;come up with generation ids high enough that they won&apos;t conflict with new sstables until long after loading is done.&quot;&lt;/p&gt;</comment>
                            <comment id="13853426" author="jbellis" created="Thu, 19 Dec 2013 22:57:12 +0000"  >&lt;p&gt;Maybe it would be best to add some kind of &quot;staging&quot; directory so we don&apos;t need to worry about conflicts at all.  Fundamentally it&apos;s kind of broken to encourage people to manually edit the live data directories.&lt;/p&gt;</comment>
                            <comment id="13853428" author="thobbs" created="Thu, 19 Dec 2013 22:59:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe it would be best to add some kind of &quot;staging&quot; directory so we don&apos;t need to worry about conflicts at all. Fundamentally it&apos;s kind of broken to encourage people to manually edit the live data directories.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I agree that that would be the proper fix, this was just a quick solution to avoid a (probably) more common case.&lt;/p&gt;</comment>
                            <comment id="13853430" author="thobbs" created="Thu, 19 Dec 2013 23:01:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;&quot;come up with generation ids high enough that they won&apos;t conflict with new sstables until long after loading is done.&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did think about that, but in this case, the generations didn&apos;t conflict with newly flushed sstables, so it was particularly unexpected. &lt;/p&gt;</comment>
                            <comment id="13932325" author="jbellis" created="Wed, 12 Mar 2014 20:35:27 +0000"  >&lt;p&gt;+1, although I&apos;d caution not to make it sounds like there is no race at all anyore in CHANGES&lt;/p&gt;</comment>
                            <comment id="13939887" author="thobbs" created="Tue, 18 Mar 2014 22:21:35 +0000"  >&lt;p&gt;I ended up needing to adjust the tests a bit to ensure SSTables were cleared off disk and there were new duplicate hardlinks due to incremental backups.  The v2 patch includes those &lt;a href=&quot;https://github.com/thobbs/cassandra/commit/d060d9ec9dc460c21aa151f37f59badf9d25150a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;changes&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13939914" author="jbellis" created="Tue, 18 Mar 2014 22:44:40 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13939948" author="thobbs" created="Tue, 18 Mar 2014 23:17:53 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12675900">CASSANDRA-6245</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12635417" name="6514-2.0-v2.patch" size="6444" author="thobbs" created="Tue, 18 Mar 2014 22:21:35 +0000"/>
                            <attachment id="12619682" name="6514-2.0.patch" size="4973" author="thobbs" created="Thu, 19 Dec 2013 22:43:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>364771</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qvgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365071</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>