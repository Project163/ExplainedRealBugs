<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5925] Race condition in update lightweight transaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5925</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m building some tests for a Cassandra PoC.  One scenario I need to test is consumption of 1 time tokens.  These tokens must be consumed exactly once.  The cluster involved is a 3 node cluster.  All queries are run with ConsistencyLevel.QUORUM. I&apos;m using the following queries:&lt;/p&gt;

&lt;p&gt;CREATE KEYSPACE IF NOT EXISTS test WITH replication = &lt;/p&gt;
{ &apos;class&apos; : &apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 3 }
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;CREATE TABLE IF NOT EXISTS tkns (tkn blob, consumed boolean, PRIMARY KEY (tkn));&lt;/p&gt;

&lt;p&gt;INSERT INTO tkns (tkn, consumed) VALUES (?,FALSE) USING TTL 30;&lt;/p&gt;

&lt;p&gt;UPDATE tkns USING TTL 1 SET consumed = TRUE WHERE tkn = ? IF consumed = FALSE;&lt;/p&gt;

&lt;p&gt;I use the &apos;&lt;span class=&quot;error&quot;&gt;&amp;#91;applied&amp;#93;&lt;/span&gt;&apos; column in the result set of the update statement to determine whether the token has been successfully consumed or if the token is being replayed.&lt;/p&gt;

&lt;p&gt;My test involves concurrently executing many sets of 1 insert and 2 update statements (using Session#execute on BoundStatemnts) then checking to make sure that only one of the updates was applied.&lt;/p&gt;

&lt;p&gt;When I run this test with relatively few iterations (~100) my results are  what I expect (exactly 1 update succeeds).  At ~1000 iterations, I start seeing both updates reporting success in 1-2% of cases.  While my test is running, I see corresponding error entries in the Cassandra log:&lt;/p&gt;

&lt;p&gt;ERROR 15:34:53,583 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:522,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR 15:34:53,584 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:474,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR 15:34:53,584 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:536,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR 15:34:53,729 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:480,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
ERROR 15:34:53,729 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:534,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;/p&gt;


&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what&apos;s going on with the logging the the dev release.  I grabbed the rc2 source and built that.  The resultant log is a bit more informative:&lt;/p&gt;

&lt;p&gt;ERROR 11:53:38,967 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:114,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.cassandra.serializers.UUIDSerializer.deserialize(UUIDSerializer.java:32)&lt;br/&gt;
	at org.apache.cassandra.serializers.UUIDSerializer.deserialize(UUIDSerializer.java:26)&lt;br/&gt;
	at org.apache.cassandra.db.marshal.AbstractType.compose(AbstractType.java:142)&lt;br/&gt;
	at org.apache.cassandra.cql3.UntypedResultSet$Row.getUUID(UntypedResultSet.java:131)&lt;br/&gt;
	at org.apache.cassandra.db.SystemKeyspace.loadPaxosState(SystemKeyspace.java:785)&lt;br/&gt;
	at org.apache.cassandra.service.paxos.PaxosState.commit(PaxosState.java:118)&lt;br/&gt;
	at org.apache.cassandra.service.paxos.CommitVerbHandler.doVerb(CommitVerbHandler.java:34)&lt;br/&gt;
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;</description>
                <environment>&lt;p&gt;3 node Cassandra 2.0.0-rc2 cluster. Java driver 1.0.2.&lt;/p&gt;</environment>
        <key id="12665142">CASSANDRA-5925</key>
            <summary>Race condition in update lightweight transaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="ppersad">Phil Persad</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Thu, 22 Aug 2013 23:17:31 +0000</created>
                <updated>Fri, 25 Oct 2019 13:11:56 +0000</updated>
                            <resolved>Wed, 28 Aug 2013 10:33:54 +0000</resolved>
                                        <fixVersion>2.0.0</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13748373" author="slebresne" created="Fri, 23 Aug 2013 07:43:19 +0000"  >&lt;p&gt;Don&apos;t you have more stack trace in the log? To have a NPE in the MutationStage is definitively a bug, but it would be immensely easier to find what&apos;s the problem with a stack trace. And there should be a trace. &lt;/p&gt;</comment>
                            <comment id="13748698" author="ppersad" created="Fri, 23 Aug 2013 16:49:22 +0000"  >&lt;p&gt;I&apos;m a little puzzled by that myself.  What I&apos;ve posted is exactly what I see in the log output.  The exception seems to be being logged by the UncaughtExceptionHandler set at CassandraDaemon:129.  That&apos;s the only place in the code base where I can find a matching exception message.  That call looks like it should have a full stack trace, but I&apos;m not seeing it in the log.&lt;/p&gt;</comment>
                            <comment id="13748869" author="ppersad" created="Fri, 23 Aug 2013 18:59:31 +0000"  >&lt;p&gt;I&apos;ve updated the ticket with a more complete stack trace.&lt;/p&gt;</comment>
                            <comment id="13749945" author="slebresne" created="Mon, 26 Aug 2013 09:36:28 +0000"  >&lt;p&gt;Thanks for the full stack.&lt;/p&gt;

&lt;p&gt;Not completely sure what triggers that NPE however. I do see one scenario where the paxos state on-disk could not be empty but the there&apos;s no &quot;in_progress_ballot&quot; column (hence triggering that NPE): since savePaxosPromise only write the &quot;proposal&quot; and not the &quot;in_progress_ballot&quot;, and since we set TTL on inserts, it sounds possible to end up in a case where a paxos row only has the &quot;proposal&quot; column but everything else has expired. I do am attaching a simple patch to always write &quot;in_progress_ballot&quot; to avoid that, but given that paxos TTL is at least 3 hours, I doubt that&apos;s the scenario you are running into in your test. So not sure what&apos;s going on (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;, if you have a brilliant idea...).&lt;/p&gt;

&lt;p&gt;Phil, if you could check if the attached patch fixes it by any chance, that could be helpful. If it doesn&apos;t (likely), would you be able to provide a simple test script that reproduce this?&lt;/p&gt;</comment>
                            <comment id="13750334" author="ppersad" created="Mon, 26 Aug 2013 18:04:30 +0000"  >&lt;p&gt;JUnit test to demonstrate the issue.&lt;/p&gt;</comment>
                            <comment id="13750340" author="ppersad" created="Mon, 26 Aug 2013 18:07:52 +0000"  >&lt;p&gt;I applied the patch and it did indeed make the NPEs go away.  However the double-consumption of tokens persists.  See the attached JUnit test class (the CassandraClient mentioned in the test is just a simple wrapper that creates a Cluster and Session and sets a default consistency of QUORUM on every query).&lt;/p&gt;</comment>
                            <comment id="13751268" author="slebresne" created="Tue, 27 Aug 2013 13:53:14 +0000"  >&lt;p&gt;Thanks for the test.&lt;/p&gt;

&lt;p&gt;There is indeed 2 problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the NPE while loading the paxos state. Contrarily to my first reading, the fact that savePaxosProposal doesn&apos;t save the inProgress ballot is not only a problem due to expiration. We may call that method if our own inProgress is older than the proposal, so given a node received a proposal without having seen the prepare first (and without having a previous state), we&apos;d end up with a state where just the &apos;proposal&apos; column is set. Note that technically, I don&apos;t think it breaks Paxos not to update the ballot when saving a proposal so we could just fix loadPaxosState to not NPE in that case, but it feels saner/simpler to me to write the proposal ballot when we save a proposal value.&lt;/li&gt;
	&lt;li&gt;the reason Phil test fails is different however. The problem is that when we were building the &apos;expected&apos; ColumnFamily for the cas() call in CQL3, we were using the full parameters of the statement, including (which was the problem) the TTL. In that test, the TTL is 1 second, so it&apos;s possible (and even not that unlikely since we only have up to 1 second accuracy internally) that when we were comparing &apos;expected&apos; to &apos;current&apos; the expected column was considered deleted. So, if when the 2nd update to a row was processed the first one had expired (again, not unlikely given the 1 second ttl), the 2nd CAS update was comparing both a deleted &apos;expected&apos; and a deleted &apos;current&apos;, thus succeeding.  So anyway, the fix is to not use the TTL for the conditions in ModificationStatement.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So attaching patch that fix both issue.&lt;/p&gt;</comment>
                            <comment id="13751553" author="ppersad" created="Tue, 27 Aug 2013 18:26:54 +0000"  >&lt;p&gt;I applied the patch and it does seem to improve the situation.  Unfortunately, I&apos;m still seeing double consumptions.  However, the occurrence has dropped from 1-2% to 0.002%-0.04%.  That rate is low enough that it may not show up with the sample size of 40,000 in the test I posted.  Increasing the iterations by 10-20 times should serve to demonstrate the issue.&lt;/p&gt;

&lt;p&gt;For the sake of exploration, after I patched I tried running the test both with and without the TTL in the update statement an saw no appreciable difference in the number of failures. It looks like there may be yet a third problem.&lt;/p&gt;</comment>
                            <comment id="13751555" author="jbellis" created="Tue, 27 Aug 2013 18:32:15 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13751565" author="slebresne" created="Tue, 27 Aug 2013 18:38:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;I applied the patch and it does seem to improve the situation. Unfortunately, I&apos;m still seeing double consumptions. However, the occurrence has dropped from 1-2% to 0.002%-0.04%&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Forgot to say, your test is actually broken in theory because it picks random keys. It is thus possible for an insert of one of the jobs to interleave with the updates of another one, thus making both update apply (and presumably both update of the other job fail, but the test don&apos;t check for that). So I&apos;d suggest first re-running with guaranteed unique keys. If it still fails, I&apos;m happy to look at it more deeply, though we did fixed 2 problem so let&apos;s commit those and open a separate ticket if a 3rd problem there is indeed (and if there is 3rd that take more than 40K iterations to manifest itself, chances are it will be tricky to track down, so it&apos;s not worth holding on the initial fixes). &lt;/p&gt;</comment>
                            <comment id="13751653" author="ppersad" created="Tue, 27 Aug 2013 20:02:09 +0000"  >&lt;p&gt;I take your point and I&apos;ll tweak my test to check for duplicate keys.  That being said, even without the use of SecureRandom, I seriously doubt that I&apos;m getting collisions on a 64 Byte key.&lt;/p&gt;

&lt;p&gt;I&apos;ll create a new ticket once I&apos;ve had time to update my test.&lt;/p&gt;</comment>
                            <comment id="13751750" author="ppersad" created="Tue, 27 Aug 2013 21:29:10 +0000"  >&lt;p&gt;I&apos;ve updated my test to ensure uniqueness of the tokens and am still experiencing failures.  I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5945&quot; title=&quot;CAS transactions permitting multiple updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5945&quot;&gt;&lt;del&gt;CASSANDRA-5945&lt;/del&gt;&lt;/a&gt; to track the issue so that the fixes here can be committed.&lt;/p&gt;</comment>
                            <comment id="13752275" author="slebresne" created="Wed, 28 Aug 2013 10:33:54 +0000"  >&lt;p&gt;Alright, committed, thanks, we&apos;ll followup on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5945&quot; title=&quot;CAS transactions permitting multiple updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5945&quot;&gt;&lt;del&gt;CASSANDRA-5945&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12665793">CASSANDRA-5945</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12600165" name="5925.txt" size="3823" author="slebresne" created="Tue, 27 Aug 2013 13:53:14 +0000"/>
                            <attachment id="12599991" name="TokenConsumptionTest.java" size="2516" author="ppersad" created="Mon, 26 Aug 2013 18:04:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345083</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nibj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345384</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324946">2.0 rc2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>