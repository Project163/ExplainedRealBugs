<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14823] Legacy sstables with range tombstones spanning multiple index blocks create invalid bound sequences on 3.0+</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14823</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;During upgrade from 2.1 to 3.0, reading old sstables in reverse order would generate invalid sequences of range tombstone bounds if their range tombstones spanned multiple column index blocks. The read fails in different ways depending on whether the 2.1 tables were produced by a flush or a compaction.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13191299">CASSANDRA-14823</key>
            <summary>Legacy sstables with range tombstones spanning multiple index blocks create invalid bound sequences on 3.0+</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="bdeggleston">Blake Eggleston</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Oct 2018 21:01:02 +0000</created>
                <updated>Fri, 2 Aug 2019 02:50:13 +0000</updated>
                            <resolved>Tue, 16 Oct 2018 19:52:31 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16648594" author="bdeggleston" created="Fri, 12 Oct 2018 23:46:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/14823-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 fix&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/14823-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 sstable generator&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/bdeggleston/workflows/cassandra/tree/cci%2F14823-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This fixes a few bugs related to range tombstones and iterating over legacy sstables in reverse.&lt;/p&gt;

&lt;p&gt;First, in 2.1, range tombstones spanning multiple indexed blocks are rewritten at the beginning of each block they partially cover. 3.0 expects open markers to be noted in the column index, so it treats these as normal range tombstones, which will lead to duplicate start bounds being emitted, and incorrect dropping of rows in some cases. When generated by memtable flush, the repeated range tombstone open marker is less than the current index block first name. When generated by compaction, the index block first name is set to the repeated tombstone&apos;s open bound, which is less than the preceding index block&apos;s last name. Fixing this complicates the logic of determining if the contents of a row span multiple index blocks and correctly handling them, so that&apos;s been modified here as well.&lt;/p&gt;

&lt;p&gt;Next, since the open and closing bound of a range tombstone are stored together on disk, we stash the closing bound in memory to read out later. However we use the file pointer to figure out when we should stop reading an index block. So any rt closing bound that should be the last thing we emit for an index block gets dropped, leading to an open ended closing bound being emitted. That&apos;s fixed here as well.&lt;/p&gt;</comment>
                            <comment id="16648595" author="bdeggleston" created="Fri, 12 Oct 2018 23:47:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; would one (or both) of you mind taking a look at this as well?&lt;/p&gt;</comment>
                            <comment id="16649460" author="beobal" created="Sun, 14 Oct 2018 16:50:09 +0000"  >&lt;p&gt;This is a nasty one. The patch essentially LGTM, though I&apos;ve pushed a couple of tiny commits with minor suggestions &lt;a href=&quot;https://github.com/beobal/cassandra/commits/14823-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The first fixes a couple of typos, tweaks the comments slightly in SSTRI and changes a param name. The second switches from using Guava &lt;tt&gt;Preconditions&lt;/tt&gt; to &lt;tt&gt;Verify&lt;/tt&gt;, which is not a big deal at all, but seems marginally better aligned semantically. e.g.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If checking whether the &lt;em&gt;caller&lt;/em&gt; has violated your method or constructor&apos;s contract (such as by passing an invalid argument), use the utilities of the Preconditions class instead.&quot;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;from &lt;a href=&quot;https://google.github.io/guava/releases/18.0/api/docs/com/google/common/base/Verify.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the Verify doc&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;One last thing to note is that the merge to 3.11 is not entirely clean but it is trivially resolvable and tests do pass once merged.&lt;/p&gt;</comment>
                            <comment id="16650286" author="beobal" created="Mon, 15 Oct 2018 14:24:13 +0000"  >&lt;p&gt;I realised that I&apos;d overlooked one additional aspect here: that a 2.1 has the potential to have multiple repeated RTs following a block boundary. So I&apos;ve updated the test data generator to do that, though I could only figure out how to do it via the compaction path. While I was at it, I changed the naming of the test tables slightly from &lt;tt&gt;...&amp;#95;compact&amp;#95;...&lt;/tt&gt; to &lt;tt&gt;...&amp;#95;compacted&amp;#95;...&lt;/tt&gt; to avoid potential confusion due to the existing test tables named that way to indicate that they use &lt;tt&gt;COMPACT STORAGE&lt;/tt&gt;. &lt;br/&gt;
&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14823-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 branch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/beobal/cassandra/commit/420457c3192952206e07276be7c2edf86aa79a7e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 sstable generator&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/beobal/workflows/cassandra/tree/cci%2F14823-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16650833" author="bdeggleston" created="Mon, 15 Oct 2018 21:46:33 +0000"  >&lt;p&gt;Changes look good to me. Pulled in, merged to 3.11 and started another run of tests:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/14823-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/fd588958-4771-4d4e-8569-772415523c88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/14823-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/37a12a6a-f2ab-4591-a5c7-83b926ba655a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16652070" author="beobal" created="Tue, 16 Oct 2018 17:00:30 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16652227" author="iamaleksey" created="Tue, 16 Oct 2018 18:45:57 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="16652349" author="bdeggleston" created="Tue, 16 Oct 2018 19:52:31 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/285153f621a1e67212ef61686188eff3e9c80a4e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;285153f621a1e67212ef61686188eff3e9c80a4e &lt;/a&gt;, thanks&lt;/p&gt;</comment>
                            <comment id="16657414" author="madega" created="Fri, 19 Oct 2018 20:49:17 +0000"  >&lt;p&gt;Does this fix apply to 3.11.3 release?&lt;/p&gt;</comment>
                            <comment id="16684469" author="jjirsa" created="Mon, 12 Nov 2018 23:18:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=madega&quot; class=&quot;user-hover&quot; rel=&quot;madega&quot;&gt;madega&lt;/a&gt; yes, it will impact 3.11.3, and will be fixed with 3.11.4 when it&apos;s released.&lt;/p&gt;</comment>
                            <comment id="16702747" author="michaelsembwever" created="Thu, 29 Nov 2018 05:52:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;, correct me if i&apos;m wrong please&#8230;&lt;/p&gt;

&lt;p&gt;For this to impact a user all the following must be true:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;upgrading from 2.1,&lt;/li&gt;
	&lt;li&gt;clients&#160;were performing partition or multi-row deletes, creating range tombstones,&lt;/li&gt;
	&lt;li&gt;partitions&#160;have&#160;multiple rows and are &lt;tt&gt;&amp;gt;64KB&lt;/tt&gt; (ie has IndexInfo column index blocks),&lt;/li&gt;
	&lt;li&gt;before the post-upgrade &lt;tt&gt;`nodetool upgradesstables`&lt;/tt&gt; is complete, clients perform reads with an ordering clause (that reverses the clustering column&apos;s ordering on disk).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That is a data-model that does not do &lt;tt&gt;DELETEs&lt;/tt&gt; (or only does single-row or column &lt;tt&gt;DELETEs&lt;/tt&gt;) will not be affected by this bug.&lt;br/&gt;
 Likewise a data-model that never specifies&#160;the&#160;&quot;&lt;tt&gt;ORDER BY&quot;&lt;/tt&gt; clause in any &lt;tt&gt;SELECTs&lt;/tt&gt; will not be affected by this bug.&lt;/p&gt;</comment>
                            <comment id="16703447" author="bdeggleston" created="Thu, 29 Nov 2018 16:27:01 +0000"  >&lt;p&gt;That&#8217;s correct Mick, it almost definitely affects people upgrading from 2.2 as well.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12972"><![CDATA[Fuzz Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z5dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>