<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9519] CASSANDRA-8448 Doesn&apos;t seem to be fixed</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9519</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Still seeing the &quot;Comparison method violates its general contract!&quot; in 2.1.5&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalArgumentException: Comparison method violates its general contract!
	at java.util.TimSort.mergeHi(TimSort.java:895) ~[na:1.8.0_45]
	at java.util.TimSort.mergeAt(TimSort.java:512) ~[na:1.8.0_45]
	at java.util.TimSort.mergeCollapse(TimSort.java:437) ~[na:1.8.0_45]
	at java.util.TimSort.sort(TimSort.java:241) ~[na:1.8.0_45]
	at java.util.Arrays.sort(Arrays.java:1512) ~[na:1.8.0_45]
	at java.util.ArrayList.sort(ArrayList.java:1454) ~[na:1.8.0_45]
	at java.util.Collections.sort(Collections.java:175) ~[na:1.8.0_45]
	at org.apache.cassandra.locator.AbstractEndpointSnitch.sortByProximity(AbstractEndpointSnitch.java:49) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.locator.DynamicEndpointSnitch.sortByProximityWithScore(DynamicEndpointSnitch.java:158) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.locator.DynamicEndpointSnitch.sortByProximityWithBadness(DynamicEndpointSnitch.java:187) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.locator.DynamicEndpointSnitch.sortByProximity(DynamicEndpointSnitch.java:152) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.service.StorageProxy.getLiveSortedEndpoints(StorageProxy.java:1530) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.service.StorageProxy.getRangeSlice(StorageProxy.java:1688) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:256) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:209) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:63) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:238) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:260) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:272) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12833927">CASSANDRA-9519</key>
            <summary>CASSANDRA-8448 Doesn&apos;t seem to be fixed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jeremiah">Jeremiah Jordan</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 May 2015 01:08:39 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:57 +0000</updated>
                            <resolved>Thu, 16 Jul 2015 13:23:51 +0000</resolved>
                                        <fixVersion>2.0.17</fixVersion>
                    <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14618637" author="kenfailbus" created="Wed, 8 Jul 2015 14:11:52 +0000"  >&lt;p&gt;I see this error in 2.0.14 version of cassandra also.&lt;/p&gt;</comment>
                            <comment id="14618929" author="brandon.williams" created="Wed, 8 Jul 2015 16:59:11 +0000"  >&lt;p&gt;I think this should be enough to fix it.&lt;/p&gt;</comment>
                            <comment id="14620367" author="slebresne" created="Thu, 9 Jul 2015 11:45:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think this should be enough to fix it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If it is, I don&apos;t understand why, so you might want to elaborate what the problem is and why that fixes it.&lt;/p&gt;


&lt;p&gt;What I personally think the problem is is that while &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8448&quot; title=&quot;&amp;quot;Comparison method violates its general contract&amp;quot; in AbstractEndpointSnitch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8448&quot;&gt;&lt;del&gt;CASSANDRA-8448&lt;/del&gt;&lt;/a&gt; made the &lt;tt&gt;scores&lt;/tt&gt; map copy-on-write, we&apos;re still accessing the volatile/shared &lt;tt&gt;scores&lt;/tt&gt; reference in &lt;tt&gt;compareEndpoints&lt;/tt&gt;, so successive calls to that method may return different results for the same inputs (because scores have changed) and to the best of my knowledge that&apos;s the &quot;contract&quot; that &lt;tt&gt;Collections.sort&lt;/tt&gt; bitch about breaking. In other words, we need to ensure that during a given call to &lt;tt&gt;Collections.sort&lt;/tt&gt;, the result of &lt;tt&gt;compareEndpoints&lt;/tt&gt; should be stable (return the same output for the same inputs). In other words, all calls to &lt;tt&gt;compareEndpoints&lt;/tt&gt; used by a call to &lt;tt&gt;sortByProximity&lt;/tt&gt; should use the same scores. Meaning that we should grabe a reference to the &lt;tt&gt;scores&lt;/tt&gt; map at the beginning of &lt;tt&gt;sortByProximity&lt;/tt&gt; and only use that.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a patch doing that &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. It&apos;s worth noting that we can&apos;t do that with the &lt;tt&gt;compareEndpoints&lt;/tt&gt; signature exposed by &lt;tt&gt;IEndpointSnitch&lt;/tt&gt; since we need to pass it the (immutable) &lt;tt&gt;scores&lt;/tt&gt; map. So the public &lt;tt&gt;DynamicEndpointSnitch.compareEndpoints()&lt;/tt&gt; method now throw an &lt;tt&gt;UnsupportedOperationException&lt;/tt&gt;. Which, is worth noting, could be a problem if custom snitch implementation are wrapping the dynamic snitch and use that &lt;tt&gt;compareEndpoints&lt;/tt&gt; method (or if something wrap a dynamic snitch with a dynamic snitch, but I think we&apos;re cool with refusing that). I don&apos;t see why you&apos;d wrap the dynamic snitch so it&apos;s probably fine, but worth mentioning nonetheless.&lt;/p&gt;</comment>
                            <comment id="14620655" author="brandon.williams" created="Thu, 9 Jul 2015 15:21:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;If it is, I don&apos;t understand why, so you might want to elaborate what the problem is and why that fixes it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My take from the stacktrace was that DES.sortByProximityWithScore was calling super to AES.sortByProximity which then had a problem with the array changing while being sorted.  AES.getSortedListByProximity doesn&apos;t have this problem because it copies the array before calling AES.sortByProximity, so it seemed like a simple solution to just make sortByProximity do this itself.  That said, your theory seems plausible as well.  It would be nice if we had a test that could reproduce this so we don&apos;t have to play guessing games, but I&apos;m not sure how feasible that is.&lt;/p&gt;</comment>
                            <comment id="14622321" author="slebresne" created="Fri, 10 Jul 2015 13:53:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;My take from the stacktrace was that DES.sortByProximityWithScore was calling super to AES.sortByProximity which then had a problem with the array changing while being sorted. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, the whole point of &lt;tt&gt;sortByProximity&lt;/tt&gt; is to sort the list input in place, so if the caller changes the input behind our back, we have a very serious problem (and a quick scan of the call site indicates we do no such thing). In fact, your patch break &lt;tt&gt;sortByProximity&lt;/tt&gt; plain and simple since it make it sort a local copy of the list that nobody ever gets (and the list that should be sorted isn&apos;t).&lt;/p&gt;

&lt;p&gt;Besides, the error message strongly suggests the problem is with the comparison method.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It would be nice if we had a test that could reproduce this so we don&apos;t have to play guessing games&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s actually not all that hard. I&apos;ve push on &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;my branch&lt;/a&gt; a test that on my box fail pretty reliably without the patch but haven&apos;t failed with it&lt;/p&gt;</comment>
                            <comment id="14626588" author="slebresne" created="Tue, 14 Jul 2015 16:24:32 +0000"  >&lt;p&gt;Putting &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; as reviewer since he was the original one on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8448&quot; title=&quot;&amp;quot;Comparison method violates its general contract&amp;quot; in AbstractEndpointSnitch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8448&quot;&gt;&lt;del&gt;CASSANDRA-8448&lt;/del&gt;&lt;/a&gt;, but fine if someone else want to take the review token.&lt;/p&gt;</comment>
                            <comment id="14626594" author="benedict" created="Tue, 14 Jul 2015 16:29:41 +0000"  >&lt;p&gt;Hmm. Yes, +1. Apologies for not spotting that snaffoo first time around (it&apos;s all fine and good we were not modifying the original map, but swapping it while we&apos;re using it is equally as bad)&lt;/p&gt;</comment>
                            <comment id="14627964" author="slebresne" created="Wed, 15 Jul 2015 12:31:57 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                            <comment id="14628217" author="mshuler" created="Wed, 15 Jul 2015 15:19:22 +0000"  >&lt;p&gt;DynamicEndpointSnitchTest appears to have been broken on 2.2 with this - will check 2.1&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.2_testall/112/testReport/junit/org.apache.cassandra.locator/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.2_testall/112/testReport/junit/org.apache.cassandra.locator/&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14628222" author="mshuler" created="Wed, 15 Jul 2015 15:21:14 +0000"  >&lt;p&gt;2.1 testall is running on this commit now, so should have results soon&lt;/p&gt;</comment>
                            <comment id="14629708" author="slebresne" created="Thu, 16 Jul 2015 13:23:42 +0000"  >&lt;p&gt;The problem is with the added test. We&apos;re trying to a race where scores are updated while the endpoint list is sorted, so the biggest the list to sort is, the more change we have to catch (and thus test) this bug. And since I didn&apos;t wanted the test to be too long, I&apos;ve initially used a very big list with few iterations. Apparently, that&apos;s too big for cassci. So I&apos;ve followed &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&apos;s suggestion from irc and moved the new test to a long test, reducing the size of the tested list, but increasing the number of iterations. Hopefully the test will retain its ability to catch this issue if it is ever re-introduce (or if it turns out to not be fully fixed).&lt;/p&gt;

&lt;p&gt;As a side note, there was a failure of the other existing test in &lt;tt&gt;DynamicEndpointSnitchTest&lt;/tt&gt;, but that&apos;s due to the first test failure: the new test changes the badness (it has to) and reset it to its original value at the end, but I had forgotten to put the resetting in a finally block, so a failure of the new test was messing with the old one.&lt;/p&gt;

&lt;p&gt;Closing this because I&apos;m relatively confident this is the only problems there was (and I&apos;ll forget to close that if I don&apos;t do it now) but feel free to re-open if I&apos;m wrong on that.&lt;/p&gt;</comment>
                            <comment id="14629968" author="JIRAUSER308715" created="Thu, 16 Jul 2015 16:30:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; the original issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8448&quot; title=&quot;&amp;quot;Comparison method violates its general contract&amp;quot; in AbstractEndpointSnitch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8448&quot;&gt;&lt;del&gt;CASSANDRA-8448&lt;/del&gt;&lt;/a&gt;) was in 2.0.x, should this be applied there as well?&lt;/p&gt;</comment>
                            <comment id="14631083" author="slebresne" created="Fri, 17 Jul 2015 09:21:17 +0000"  >&lt;p&gt;I&apos;ll admit I just went with the &apos;fix version&apos; of that issue. If &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8448&quot; title=&quot;&amp;quot;Comparison method violates its general contract&amp;quot; in AbstractEndpointSnitch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8448&quot;&gt;&lt;del&gt;CASSANDRA-8448&lt;/del&gt;&lt;/a&gt; wasn&apos;t committed to 2.0 as the fix version imply, we would need to fix that too since it has part of the fix of the actual problem, but I don&apos;t know what was the rational for not committing it to 2.0 in the first place (if it was deemed not worth the risk, no reason for that to have changed).&lt;/p&gt;</comment>
                            <comment id="14631184" author="JIRAUSER308715" created="Fri, 17 Jul 2015 10:55:55 +0000"  >&lt;p&gt;8448 went in to 2.0.13 per the fix version?&lt;/p&gt;</comment>
                            <comment id="14631190" author="slebresne" created="Fri, 17 Jul 2015 11:03:36 +0000"  >&lt;p&gt;Hum, indeed. Who does put 2.0.13 &lt;em&gt;after&lt;/em&gt; 2.1.3?! That&apos;s outrageous, I can&apos;t work in these conditions!&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this to 2.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12760560">CASSANDRA-8448</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12744263" name="9519.txt" size="1205" author="brandon.williams" created="Wed, 8 Jul 2015 16:59:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fekf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329874">2.1.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>