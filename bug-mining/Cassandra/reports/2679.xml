<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6841] ConcurrentModificationException in commit-log-writer after local schema reset</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6841</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO [RMI TCP Connection(38)-192.168.36.171] 2014-03-12 11:37:54,013 MigrationManager.java (line 329) Starting local schema reset...
 INFO [RMI TCP Connection(38)-192.168.36.171] 2014-03-12 11:37:54,016 ColumnFamilyStore.java (line 785) Enqueuing flush of Memtable-local@394448776(114/1140 serialized/live bytes, 3 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,016 Memtable.java (line 331) Writing Memtable-local@394448776(114/1140 serialized/live bytes, 3 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,182 Memtable.java (line 371) Completed flushing /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-398-Data.db (145 bytes) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1394620057452, position=33159822)
 INFO [RMI TCP Connection(38)-192.168.36.171] 2014-03-12 11:37:54,185 ColumnFamilyStore.java (line 785) Enqueuing flush of Memtable-local@1087210140(62/620 serialized/live bytes, 1 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,185 Memtable.java (line 331) Writing Memtable-local@1087210140(62/620 serialized/live bytes, 1 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,357 Memtable.java (line 371) Completed flushing /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-399-Data.db (96 bytes) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1394620057452, position=33159959)
 INFO [RMI TCP Connection(38)-192.168.36.171] 2014-03-12 11:37:54,361 ColumnFamilyStore.java (line 785) Enqueuing flush of Memtable-local@768887091(62/620 serialized/live bytes, 1 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,361 Memtable.java (line 331) Writing Memtable-local@768887091(62/620 serialized/live bytes, 1 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,516 Memtable.java (line 371) Completed flushing /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-400-Data.db (96 bytes) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1394620057452, position=33160096)
 INFO [CompactionExecutor:38] 2014-03-12 11:37:54,517 CompactionTask.java (line 115) Compacting [SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-398-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-400-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-399-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-397-Data.db&apos;&lt;/span&gt;)]
 INFO [RMI TCP Connection(38)-192.168.36.171] 2014-03-12 11:37:54,519 ColumnFamilyStore.java (line 785) Enqueuing flush of Memtable-local@271993477(62/620 serialized/live bytes, 1 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,519 Memtable.java (line 331) Writing Memtable-local@271993477(62/620 serialized/live bytes, 1 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:54,794 Memtable.java (line 371) Completed flushing /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-401-Data.db (96 bytes) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1394620057452, position=33160233)
 INFO [RMI TCP Connection(38)-192.168.36.171] 2014-03-12 11:37:54,799 MigrationManager.java (line 357) Local schema reset is complete.
 INFO [CompactionExecutor:38] 2014-03-12 11:37:54,848 CompactionTask.java (line 275) Compacted 4 sstables to [/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/local/system-local-jb-402,].  6,099 bytes to 5,821 (~95% of original) in 330ms = 0.016822MB/s.  4 total partitions merged to 1.  Partition merge counts were {4:1, }
 INFO [OptionalTasks:1] 2014-03-12 11:37:55,110 ColumnFamilyStore.java (line 785) Enqueuing flush of Memtable-schema_columnfamilies@106276050(181506/509164 serialized/live bytes, 3276 ops)
 INFO [FlushWriter:6] 2014-03-12 11:37:55,110 Memtable.java (line 331) Writing Memtable-schema_columnfamilies@106276050(181506/509164 serialized/live bytes, 3276 ops)
 INFO [OptionalTasks:1] 2014-03-12 11:37:55,110 ColumnFamilyStore.java (line 785) Enqueuing flush of Memtable-schema_columns@252242773(185191/630698 serialized/live bytes, 3614 ops)
ERROR [COMMIT-LOG-WRITER] 2014-03-12 11:37:55,111 CassandraDaemon.java (line 196) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[COMMIT-LOG-WRITER,5,main]
java.util.ConcurrentModificationException
        at java.util.HashMap$HashIterator.nextEntry(HashMap.java:926)
        at java.util.HashMap$KeyIterator.next(HashMap.java:960)
        at org.apache.cassandra.db.commitlog.CommitLogAllocator.flushOldestKeyspaces(CommitLogAllocator.java:309)
        at org.apache.cassandra.db.commitlog.CommitLogAllocator.fetchSegment(CommitLogAllocator.java:147)
        at org.apache.cassandra.db.commitlog.CommitLog.activateNextSegment(CommitLog.java:299)
        at org.apache.cassandra.db.commitlog.CommitLog.access$100(CommitLog.java:49)
        at org.apache.cassandra.db.commitlog.CommitLog$LogRecordAdder.run(CommitLog.java:350)
        at org.apache.cassandra.db.commitlog.PeriodicCommitLogExecutorService$1.runMayThrow(PeriodicCommitLogExecutorService.java:51)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Linux 3.2.0 (Debian Wheezy) Cassandra 2.0.6, Oracle JVM 1.7.0_51&lt;/p&gt;

&lt;p&gt;Almost default cassandra.yaml (IPs and cluster name changed)&lt;/p&gt;

&lt;p&gt;This is the 2nd node in a 2-node ring. It has ~2500 keyspaces and very low traffic. (Only new keyspaces see reads and writes.)&lt;/p&gt;</environment>
        <key id="12700930">CASSANDRA-6841</key>
            <summary>ConcurrentModificationException in commit-log-writer after local schema reset</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="pasthelod">Pas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Mar 2014 10:50:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:51 +0000</updated>
                            <resolved>Tue, 22 Apr 2014 14:18:08 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                    <fixVersion>2.0.7</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13931884" author="jbellis" created="Wed, 12 Mar 2014 15:46:25 +0000"  >&lt;p&gt;Can you give more details regarding how you did this?&lt;/p&gt;</comment>
                            <comment id="13931897" author="benedict" created="Wed, 12 Mar 2014 15:58:25 +0000"  >&lt;p&gt;Without investigating &lt;em&gt;thoroughly&lt;/em&gt; to rule out anything else, I would guess the problem is with Keyspace.cfIdMap, which is not threadsafe. We should probably create it with two ConcurrentHashMap, instead of the default (plain HashMap)&lt;/p&gt;</comment>
                            <comment id="13932005" author="pasthelod" created="Wed, 12 Mar 2014 17:04:56 +0000"  >&lt;p&gt;To give more context. There was a single node ring used for running test of an application that uses, among other stores, Cassandra as a backend. It has a lot of small keyspaces (each with 1 or 2 CFs - supercolumn based), total data on the node was/is less than 300G. We are in the process of migrating away from supercolumns, so we&apos;re moving to CQL and composite primary keys and whatnot, so there are a few keyspaces already with this new schema.&lt;/p&gt;

&lt;p&gt;Then we tried to add a new node, setting its seed property to the old one. It failed to bootstrap with errors ( &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6565?focusedCommentId=13931732&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13931732&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-6565?focusedCommentId=13931732&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13931732&lt;/a&gt; ), but finally after a few tries it started and went from BOOT to NORMAL. Then we noticed that the new node has a different schema UUID (as indicated by gossipinfo), and tried to do resetlocalschema. (Which happened, according to system.log, but then we have observed no improvement, so we tried it again then the gossip stage appeared to have been deadlocked; but a restart solved it. See also &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6799?focusedCommentId=13931690&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13931690&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-6799?focusedCommentId=13931690&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13931690&lt;/a&gt; )&lt;/p&gt;
</comment>
                            <comment id="13932229" author="benedict" created="Wed, 12 Mar 2014 19:21:02 +0000"  >&lt;p&gt;Patch available &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/iss-6841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Looking at the stack trace, it looks like this problem is actually caused by the same basic problem I found with cfIdMap, but in another spot: CLS.cfLastWrite is a regular HashMap, and markClean can be called at any time by other threads (although in a critical section, so the map won&apos;t be left in a dodgy state), so I&apos;ve fixed both of these issues.&lt;/p&gt;

&lt;p&gt;Regrettably we can&apos;t just pass a pair of ConcurrentHashMaps to HashBiMap, as the constructor is private. So I&apos;ve created a new ConcurrentBiMap which synchronises on modification but uses ConcurrentHashMap so that we can permit unsynchronized access for reads. I&apos;ve replaced cfIdMap with this.&lt;/p&gt;</comment>
                            <comment id="13932336" author="carlyeks" created="Wed, 12 Mar 2014 20:42:39 +0000"  >&lt;p&gt;The patch LGTM, but it might help to have the two IllegalStateExceptions in the ConcurrentBiMap.put method commented.&lt;/p&gt;</comment>
                            <comment id="13933183" author="benedict" created="Thu, 13 Mar 2014 12:42:10 +0000"  >&lt;p&gt;Updated the tree. Also converted one of those ISE to an IAE check prior to modifying the map&lt;/p&gt;</comment>
                            <comment id="13933193" author="carlyeks" created="Thu, 13 Mar 2014 12:52:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13935382" author="jbellis" created="Fri, 14 Mar 2014 18:18:33 +0000"  >&lt;p&gt;committed.  might want to doublecheck my merge to 2.1; i kept the changes to Schema but the CL changes looked irrelevant&lt;/p&gt;</comment>
                            <comment id="13935813" author="benedict" created="Fri, 14 Mar 2014 23:25:30 +0000"  >&lt;p&gt;LGTM as far as I can tell, but a bit tricky as git diff includes some of the 2.0 patches in the 2.1 git log.&lt;/p&gt;

&lt;p&gt;The CL changes weren&apos;t necessary for 2.1 anyway, you&apos;re right, and it looks like they&apos;re missing from 2.1 so I&apos;m happy.&lt;/p&gt;</comment>
                            <comment id="13956945" author="jblangston@datastax.com" created="Tue, 1 Apr 2014 19:38:10 +0000"  >&lt;p&gt;Reopening to get a backport for 1.2.&lt;/p&gt;</comment>
                            <comment id="13962140" author="benedict" created="Mon, 7 Apr 2014 18:54:42 +0000"  >&lt;p&gt;Applied mostly cleanly to 1.2&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a version stripped of the ConcurrentBiMap change, as that&apos;s probably a much rarer bug and a more invasive change, so probably best to leave it for 2.x&lt;/p&gt;</comment>
                            <comment id="13976813" author="jbellis" created="Tue, 22 Apr 2014 14:18:08 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13981084" author="wtmitchell3" created="Fri, 25 Apr 2014 15:02:50 +0000"  >&lt;p&gt;Although not the author, I ran into this symptom of the ConcurrentModificationException at line 309 in the CommitLogAllocator more than once this week on 2.0.6, on an 8-core Windows desktop.  After downloading and installing 2.0.7 yesterday, I have not seen this problem reappear.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12639038" name="6841.12.txt" size="3227" author="benedict" created="Mon, 7 Apr 2014 18:54:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379276</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tcon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379568</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326170">2.0.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>