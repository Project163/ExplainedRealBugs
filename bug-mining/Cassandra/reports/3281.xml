<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8399] Reference Counter exception when dropping user type</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8399</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running the dtest &lt;tt&gt;user_types_test.py:TestUserTypes.test_type_keyspace_permission_isolation&lt;/tt&gt; with the current 2.1-HEAD code, very frequently, but not always, when dropping a type, the following exception is seen:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [MigrationStage:1] 2014-12-01 13:54:54,824 CassandraDaemon.java:170 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MigrationStage:1,5,main]
java.lang.AssertionError: Reference counter -1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/folders/v3/z4wf_34n1q506_xjdy49gb780000gn/T/dtest-eW2RXj/test/node2/data/system/schema_keyspaces-b0f2235744583cdb9631c43e59ce3676/system-sche
ma_keyspaces-ka-14-Data.db
        at org.apache.cassandra.io.sstable.SSTableReader.releaseReference(SSTableReader.java:1662) ~[main/:na]
        at org.apache.cassandra.io.sstable.SSTableScanner.close(SSTableScanner.java:164) ~[main/:na]
        at org.apache.cassandra.utils.MergeIterator.close(MergeIterator.java:62) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore$8.close(ColumnFamilyStore.java:1943) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.filter(ColumnFamilyStore.java:2116) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.getRangeSlice(ColumnFamilyStore.java:2029) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.getRangeSlice(ColumnFamilyStore.java:1963) ~[main/:na]
        at org.apache.cassandra.db.SystemKeyspace.serializedSchema(SystemKeyspace.java:744) ~[main/:na]
        at org.apache.cassandra.db.SystemKeyspace.serializedSchema(SystemKeyspace.java:731) ~[main/:na]
        at org.apache.cassandra.config.Schema.updateVersion(Schema.java:374) ~[main/:na]
        at org.apache.cassandra.config.Schema.updateVersionAndAnnounce(Schema.java:399) ~[main/:na]
        at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:167) ~[main/:na]
        at org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:49) ~[main/:na]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_67]
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_67]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_67]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_67]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.7.0_67]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Log of the node with the error is attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12758721">CASSANDRA-8399</key>
            <summary>Reference Counter exception when dropping user type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="philipthompson">Philip Thompson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Dec 2014 18:58:17 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:04 +0000</updated>
                            <resolved>Wed, 7 Jan 2015 20:14:21 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14230252" author="philipthompson" created="Mon, 1 Dec 2014 19:01:13 +0000"  >&lt;p&gt;I&apos;m not finished with the git bisect yet, but I cannot reproduce this on 2.1.2&lt;/p&gt;</comment>
                            <comment id="14230301" author="philipthompson" created="Mon, 1 Dec 2014 19:35:30 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git bisect bad
3484181e2b68ce04acfe4e9028d5d1d76335094a is the first bad commit
commit 3484181e2b68ce04acfe4e9028d5d1d76335094a
Author: Joshua McKenzie &amp;lt;jmckenzie@apache.org&amp;gt;
Date:   Thu Nov 13 11:56:34 2014 -0600

    Fix ordering on SSTableScanner / SSTableReader close

    Patch by jmckenzie; reviewed by marcuse &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CASSANDRA-8019

:040000 040000 c531fe46ad6f617c04820259f23108ee07dbf60c 451e6a8d71f4f27c570e674f5e9b593c84999238 M	src
:040000 040000 8b1c610e65110fd9e0941d040de812b1a62f8664 f142aedd5606e67981826cc8133cfd581d401434 M	test&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14231195" author="krummas" created="Tue, 2 Dec 2014 09:04:15 +0000"  >&lt;p&gt;could you have a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14231803" author="jmckenzie" created="Tue, 2 Dec 2014 17:42:12 +0000"  >&lt;p&gt;An initial scan of the code surrounding the creation and closing of MergeIterators in the above code path doesn&apos;t pop up with any likely culprits.  The iterators are fairly cleanly created, nobody mutates / calls close on the contents of the iterator list inside the mergeiterator while it&apos;s in use, and they&apos;re then closed in a finally block.&lt;/p&gt;

&lt;p&gt;I&apos;ll reproduce locally and put in some stack tracing around the ref counting to see where our culprit is.&lt;/p&gt;</comment>
                            <comment id="14232301" author="jmckenzie" created="Tue, 2 Dec 2014 23:30:11 +0000"  >&lt;p&gt;Apparently I won&apos;t reproduce locally.  About 0 for 50 or so on attempting to get it to fire locally, clean pull / build of 2.1, ubuntu 14.10 w/new ccm pull and dtest.&lt;/p&gt;

&lt;p&gt;Speaking w/Philip offline - he&apos;s on OSX where this is occurring.  I&apos;ll see if I can reproduce on Windows and/or OSX.&lt;/p&gt;</comment>
                            <comment id="14232385" author="jmckenzie" created="Wed, 3 Dec 2014 00:28:44 +0000"  >&lt;p&gt;0 for 20 reproducing on OSX, 0 for 10 on Windows.  I&apos;m unable to reproduce this error on 2.1 HEAD on any of these three platforms, and a cursory inspection of CI environment shows it&apos;s not throwing the exception either.&lt;/p&gt;</comment>
                            <comment id="14238112" author="jmckenzie" created="Mon, 8 Dec 2014 17:24:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt; Any updates on this?  Are you still reproducing this locally or was it transient?&lt;/p&gt;</comment>
                            <comment id="14238134" author="philipthompson" created="Mon, 8 Dec 2014 17:48:21 +0000"  >&lt;p&gt;I can still reproduce this locally. What additional information could help you debug? My jdk is &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java -version
java version &lt;span class=&quot;code-quote&quot;&gt;&quot;1.7.0_67&quot;&lt;/span&gt;
Java(TM) SE &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment (build 1.7.0_67-b01)
Java HotSpot(TM) 64-Bit Server VM (build 24.65-b04, mixed mode)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14238315" author="philipthompson" created="Mon, 8 Dec 2014 19:27:28 +0000"  >&lt;p&gt;I have reproduced on Ubuntu 12.04 with jdk 1.7.0_45, so it does not appear to be OS or jdk specific. I will attach the ubuntu logs. It was much harder to reproduce on ubuntu, it took about 7 runs rather than the 2 or 3 I was using. If Josh ran it 50 times though, that should have been more than enough.&lt;/p&gt;</comment>
                            <comment id="14238408" author="jmckenzie" created="Mon, 8 Dec 2014 20:13:09 +0000"  >&lt;p&gt;Finally got a few repro locally on 1.7.0_72, ubuntu 14.04 - not sure why I couldn&apos;t earlier but I&apos;ll go with it.&lt;/p&gt;</comment>
                            <comment id="14244765" author="jmckenzie" created="Fri, 12 Dec 2014 20:56:50 +0000"  >&lt;p&gt;Capturing the stack on the SSTR ref counting shows 4 getRangeSlice creation and 5 MergeIterator releases in one example however I can&apos;t find any mismatches from reading through the MergeIterator code.  Taking that a step further, I traced the sstable acquire/release calls in the SSTableScanner with an atomic int count to throw assertion on non-zero count on close() and the call that&apos;s throwing the assertion looks to be correctly paired with an acquire, implying that the unbalanced release on the SSTR is coming from another source and the scanner close() assertion is simply exposing it:&lt;/p&gt;

&lt;p&gt;I haven&apos;t been able to reproduce the assertion w/out the reference counting on the SSTableScanner.&lt;/p&gt;</comment>
                            <comment id="14246851" author="jmckenzie" created="Mon, 15 Dec 2014 17:07:01 +0000"  >
&lt;p&gt;When making the change for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8019&quot; title=&quot;Windows Unit tests and Dtests erroring due to sstable deleting task error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8019&quot;&gt;&lt;del&gt;CASSANDRA-8019&lt;/del&gt;&lt;/a&gt;, I failed to check the return value for SSTR.acquireReference in the SSTableScanner constructor which can race with SSTR&apos;s being cleaned up and lead to the -1 ref on close().  Patch to fix this is &lt;a href=&quot;https://github.com/josh-mckenzie/cassandra/compare/8399&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;b&gt;Available Here&lt;/b&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Renamed/moved SSTableReader.EmptyCompactionScanner to SSTableScanner.EmptySSTableScanner&lt;/li&gt;
	&lt;li&gt;Renamed/refactored ICompactionScanner to ISSTableScanner, moved to io.sstable package&lt;/li&gt;
	&lt;li&gt;Made constructors in SSTableScanner private and added getScanner method which attempts to acquire ref on sstable and returns EmptySSTableScanner on failure&lt;/li&gt;
	&lt;li&gt;Moved #5249 optimization into getScanner call&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;unit tests come out clean, dtests come out clean.  Patch looks a lot bigger than it is due to rename/refactor, but the meat of it is really in SSTableScanner.getScanner calls.&lt;/p&gt;

&lt;p&gt;I&apos;m open to debate on whether the abstraction should be an ICompactionScanner rather than ISSTableScanner if there&apos;s some reasoning I don&apos;t know about with that.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;: any chance you&apos;d be up for review?&lt;/p&gt;</comment>
                            <comment id="14246854" author="krummas" created="Mon, 15 Dec 2014 17:12:03 +0000"  >&lt;p&gt;sure!&lt;/p&gt;</comment>
                            <comment id="14248286" author="krummas" created="Tue, 16 Dec 2014 14:30:00 +0000"  >&lt;p&gt;patch is +1 from me, could you make sure you can&apos;t repro after this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14248365" author="philipthompson" created="Tue, 16 Dec 2014 15:19:26 +0000"  >&lt;p&gt;+1 from me. So far I&apos;m unable to reproduce after the patch.&lt;/p&gt;</comment>
                            <comment id="14248949" author="jmckenzie" created="Tue, 16 Dec 2014 21:14:26 +0000"  >&lt;p&gt;committed.&lt;/p&gt;</comment>
                            <comment id="14253564" author="benedict" created="Fri, 19 Dec 2014 15:53:26 +0000"  >&lt;p&gt;I think this simply replaces one bug with another. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8513&quot; title=&quot;SSTableScanner may not acquire reference, but will still release it when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8513&quot;&gt;&lt;del&gt;CASSANDRA-8513&lt;/del&gt;&lt;/a&gt; for what I think is the actual bug. The SSTableScanner does not need to successfully acquire a reference if it is being performed by a normal read, since it will be guarded by an OpOrder. However if it fails to do so it should not release a reference. The change here means that there won&apos;t be bad reference counting, but range queries could erroneously return no data.&lt;/p&gt;</comment>
                            <comment id="14256213" author="jmckenzie" created="Mon, 22 Dec 2014 21:30:47 +0000"  >&lt;p&gt;Good catch; the role of the readOrdering in CFS w/regards to deletion of sstables wasn&apos;t clear to me prior and the possibility of a race between OpOrder start and sstable ref count decrement was subtle enough that I missed it.&lt;/p&gt;

&lt;p&gt;Attached a patch that replicates &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8513&quot; title=&quot;SSTableScanner may not acquire reference, but will still release it when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8513&quot;&gt;&lt;del&gt;CASSANDRA-8513&lt;/del&gt;&lt;/a&gt; for current 2.1.  &lt;/p&gt;

&lt;p&gt;Ultimately, it feels like the right solution is to untangle the various getScanner calls in SSTR and have a separate getReadScanner and getCompactionScanner path, one without reference counting and one with.  This current workaround loses the return of an empty SSTableScanner on the compaction path and also enforces ref counting on range queries which is not ideal.  I&apos;ll create another ticket for these changes.&lt;/p&gt;

&lt;p&gt;I don&apos;t like us having two separate paradigms for resource tracking / protection on SSTableReaders (OpOrder and ref counting) as mentally modelling state and potential races becomes considerably more difficult with different primitives used on different paths.&lt;/p&gt;</comment>
                            <comment id="14256225" author="benedict" created="Mon, 22 Dec 2014 21:45:30 +0000"  >&lt;p&gt;The real question is: why are we even trying to obtain a reference here?&lt;/p&gt;

&lt;p&gt;Creating and using a scanner is a protected operation; it can be protected by either reference counting or the OpOrder. But this should be ensured by the operation that creates the scanner, not the scanner itself. We are leaking resource management into the scanner code that shouldn&apos;t be there. &lt;/p&gt;

&lt;p&gt;We should remove the reference counting all together from this area of code. The fact that we were blindly acquiring before means that we knew it had to succeed, meaning that it also was not necessary.&lt;/p&gt;

&lt;p&gt;Having two mechanisms for resource management is fine, so long as we don&apos;t mix them. A macro operation needs to be protected by one or the other, and sub-operations should rely on these macro operations to ensure their protection.&lt;/p&gt;</comment>
                            <comment id="14260288" author="jmckenzie" created="Mon, 29 Dec 2014 18:15:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;this should be ensured by the operation that creates the scanner, not the scanner itself. We are leaking resource management into the scanner code that shouldn&apos;t be there.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree.  At the time I first changed this code, I wasn&apos;t aware of the OpOrder -&amp;gt; SSTableScanner protection relationship so the design was more appropriate.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We should remove the reference counting all together from this area of code. The fact that we were blindly acquiring before means that we knew it had to succeed, meaning that it also was not necessary.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I partially agree.  While we don&apos;t strictly need to ref count to protect, we do need to document and/or codify the relationship between scanners and sstr&apos;s - the change in the CompactionTask with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7932&quot; title=&quot;Corrupt SSTable Cleanup Leak Resources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7932&quot;&gt;&lt;del&gt;CASSANDRA-7932&lt;/del&gt;&lt;/a&gt; uncovered the fact that we were relying on an undocumented ordering relationship between SSTR closing and SSTableScanner closing for the operation to work on Windows.  This relationship needs to be formalized if we&apos;re to move forward with supporting mmap&apos;ed I/O on Windows as the same strict file close ordering restrictions apply in that context (i.e. it&apos;s not fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4050&quot; title=&quot;Rewrite RandomAccessReader to use FileChannel / nio to address Windows file access violations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4050&quot;&gt;&lt;del&gt;CASSANDRA-4050&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Having two mechanisms for resource management is fine, so long as we don&apos;t mix them. A macro operation needs to be protected by one or the other, and sub-operations should rely on these macro operations to ensure their protection.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I believe this claim needs more context to be justified; having two methods to accomplish the same thing is error prone, considerably more difficult to maintain and reason about, and needs to be offset by other substantial gains to justify duplication.  In this case (OpOrder vs. ref-counting) I believe it&apos;s justified from the performance gains, however the code-structure (methods / flow) doesn&apos;t make this relationship immediately clear to others coming into the code modified for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5549&quot; title=&quot;Remove Table.switchLock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5549&quot;&gt;&lt;del&gt;CASSANDRA-5549&lt;/del&gt;&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6689&quot; title=&quot;Partially Off Heap Memtables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6689&quot;&gt;&lt;del&gt;CASSANDRA-6689&lt;/del&gt;&lt;/a&gt;.  Clear in retrospect, but the current structure of the code doesn&apos;t &quot;self-document&quot; this relationship at this time.  Perhaps wrapping an interface around readOrdering in SSTR rather than having it be public and accessible would help clarify the object&apos;s role when working with loosely related code.&lt;/p&gt;

&lt;p&gt;Regardless - 8399_v2.txt attached that moves the scope closing in CompactionTask, documents the temporal coupling, and removes ref counting from within SSTableScanner.  Errors on Windows remain suppressed w/regards to compaction file access and the dtest ran clean on 50 runs.&lt;/p&gt;</comment>
                            <comment id="14260300" author="benedict" created="Mon, 29 Dec 2014 18:29:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;having two methods to accomplish the same thing is error prone, considerably more difficult to maintain and reason about&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Given how awfully error prone the ref counting has proven itself to be (see the number of linked issues in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7705&quot; title=&quot;Safer Resource Management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7705&quot;&gt;&lt;del&gt;CASSANDRA-7705&lt;/del&gt;&lt;/a&gt;), and the age-old maxim that the simplest explanation is the best, it is pretty reasonable to think that ref counting is simply hard to get right by itself. There isn&apos;t much evidence that the OpOrder makes this appreciably harder. Personally, I think the more places we can use OpOrder the better since it is easier to reason about, having a simple open/close for the entire operation. But this is fairly off topic.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I agree. At the time I first changed this code, I wasn&apos;t aware of the OpOrder -&amp;gt; SSTableScanner protection relationship so the design was more appropriate.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was not attempting to criticise your work, but the current (and historic) state of this class in abstraction. The presence of reference counting here seems testament to the problematic relationship we have with reference counting as a whole, since there seems to be no good reason for it - that is unless we expect to construct a scanner, finish the protected operation that opened it and then pass that scanner to another unprotected operation. But this would seem to me to be an avoidable and dangerous design that should itself by avoided rather than introducing unconditional (and hence dangerous) reference counting, or making assumptions about correct behaviour if the count is unobtainable.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;he change in the CompactionTask with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7932&quot; title=&quot;Corrupt SSTable Cleanup Leak Resources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7932&quot;&gt;&lt;del&gt;CASSANDRA-7932&lt;/del&gt;&lt;/a&gt; uncovered the fact that we were relying on an undocumented ordering relationship between SSTR closing and SSTableScanner closing for the operation to work on Windows... relationship needs to be formalized &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not familiar with the ordering relationship you&apos;re alluding to, but formalisation is always a good thing.&lt;/p&gt;</comment>
                            <comment id="14260306" author="jmckenzie" created="Mon, 29 Dec 2014 18:39:30 +0000"  >&lt;p&gt;SSTableScanner contains a handle to the ifile and dfile that it pulls from within the SSTR, so if we decrement the counter on the SSTR and go to tidy it up while a scanner still has those files open, we get the &quot;Unable to delete&quot; errors on Windows when we attempt to delete those files.  This is largely resolved by the nio changes unless we memory-map in which case we&apos;re right back to needing to enforce strict ordering (i.e. don&apos;t try to delete if anyone has a handle open / memory mapped segment).&lt;/p&gt;</comment>
                            <comment id="14260310" author="benedict" created="Mon, 29 Dec 2014 18:47:19 +0000"  >&lt;p&gt;This sounds like it would benefit from the formalisation I proposed before then: an SSTableScanner must exist wholly within the lifetime of a protected operation. This &lt;em&gt;should&lt;/em&gt; already be the case. Scanning the dialogue on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8019&quot; title=&quot;Windows Unit tests and Dtests erroring due to sstable deleting task error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8019&quot;&gt;&lt;del&gt;CASSANDRA-8019&lt;/del&gt;&lt;/a&gt; I&apos;m still not sure why this is occurring, since the CompactionTask should have taken an extra reference to the sstable it is obsoleting which  doesn&apos;t get decremented until the entire compaction task completes (after the scanner is closed). So we should find out why this is occurring, since &lt;em&gt;that&lt;/em&gt; sounds like the real underlying bug on that front.&lt;/p&gt;</comment>
                            <comment id="14261044" author="benedict" created="Tue, 30 Dec 2014 11:59:20 +0000"  >&lt;p&gt;Ah. I now see that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8019&quot; title=&quot;Windows Unit tests and Dtests erroring due to sstable deleting task error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8019&quot;&gt;&lt;del&gt;CASSANDRA-8019&lt;/del&gt;&lt;/a&gt; was the source of these woes, which was itself triggered by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7932&quot; title=&quot;Corrupt SSTable Cleanup Leak Resources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7932&quot;&gt;&lt;del&gt;CASSANDRA-7932&lt;/del&gt;&lt;/a&gt;. I didn&apos;t have the context. It looks to me like the underlying problem is that the set of &quot;iscompacting&quot; can be disjoint from the set of &quot;isreferenced&quot;, and we should ensure it is always a subset. What I mean by this is that if an sstable is marked compacting, it should not be possible for it to be considered unreferenced. So I propose always acquiring a reference prior to successfully marking compacting, and releasing on unmarking. &lt;/p&gt;

&lt;p&gt;To relate to what you were saying about multiple concepts: we actually have three right now, not two, and two of these are extremely similar. By making one of the two similar concepts a subset of the other, we reduce the potential for mistakes. I have no doubt the 7932 mistake was down to my belief that a reference was maintained by AbstractCompactionTask, when in fact it is only the iscompacting state.&lt;/p&gt;</comment>
                            <comment id="14262498" author="jmckenzie" created="Wed, 31 Dec 2014 23:48:16 +0000"  >&lt;p&gt;While I agree that the Right Thing here seems to be to protect the entire compaction operation by holding a reference, I&apos;m not sure that the 2.X line is appropriate for this change at the DataTracker level.  While acquiring and releasing within a single SSTableScanner is a cleanly tied together RAII operation that should be an &quot;invisible&quot; change from a logical flow / API perspective, pushing that operation into markCompacting and unmarkCompacting means we have over 10 upstream users of those methods that are having an assumption (and contract) changed on them - namely, that if they fail to acquire references on the SSTables in question markCompacting will return false.  Correct me if I&apos;m wrong on that - if there&apos;s some other more appropriate place to make this change than in the DataTracker (haven&apos;t worked much in this section of the code-base).&lt;/p&gt;

&lt;p&gt;A naive change in DataTracker.markCompacting leads to infinite loops (it looks like from multiple insertion points) so we&apos;d need to go upstream and fiddle with the various marking operations in order to accommodate entries in the SSTableReader collections being &quot;unmarkable&quot;.  My preference here would be to go with _v2 which resolves the ordering problems introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7932&quot; title=&quot;Corrupt SSTable Cleanup Leak Resources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7932&quot;&gt;&lt;del&gt;CASSANDRA-7932&lt;/del&gt;&lt;/a&gt; without introducing a ref count on the read path and create a separate ticket for 3.0 to pursue the more invasive change of reference counting all compacting sstables.&lt;/p&gt;

&lt;p&gt;As you&apos;ve mentioned several times, reference counting is tricky to get right.  The idea of promoting it up to the abstraction of the data tracker for compaction marking strikes me as a risky change when we already have quite a few failing unit tests on 2.X and bugs to resolve.  I definitely think it&apos;s the right thing long-term.&lt;/p&gt;</comment>
                            <comment id="14262576" author="benedict" created="Thu, 1 Jan 2015 15:21:09 +0000"  >&lt;p&gt;But surely we have a bug if we&apos;re trying to compact an obsoleted sstable? If markCompacting fails to acquire a reference we really shouldn&apos;t be compacting it, as we&apos;re either duplicating data or reintroducing dropped data. The comment on markCompacting even states this is a valid option, but decides against it based on slightly erroneous logic:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     * Note that we could acquire references on the marked sstables and release them in
     * unmarkCompacting, but since we will never call markObsolete on a sstable marked
     * as compacting (unless there is a serious bug), we can skip this.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This justification for not doing this doesn&apos;t seem sufficient, because markObsolete is unrelated to releaseReference. If it&apos;s also not true that it can be done safely without an infinite loop, it&apos;s doubly wrong &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; For 2.0 I could see us not wanting to risk new behaviour, but for 2.1 I think we should try to get on the case and deal with it since it is essentially a bug. &lt;/p&gt;

&lt;p&gt;One possible way of dealing with this without acquiring a reference, at least to begin with, is to releaseReference() in unmarkCompacting(), NOT in markCompactedSSTablesReplaced, IFF the sstable is marked obsolete. i.e. we simply markObsolete each of the sstables, then let unmarkCompacting cleanup. &lt;/p&gt;

&lt;p&gt;Long term, I think we could do with redesigning and formalising this whole process a lot more clearly. Objects that encapsulate only correct behaviour are much better than ensuring a plethora of different but related methods are correctly interleaved, as it&apos;s hard to retain at any one time what the behaviour of every other possible method call is.&lt;/p&gt;</comment>
                            <comment id="14262677" author="benedict" created="Thu, 1 Jan 2015 22:20:27 +0000"  >&lt;p&gt;That said, I think if we cannot guarantee we are able to take a reference at the time we markCompacting, we should also file a bug and fix this. It seems like it would be a pretty serious problem, even for 2.0, since we could cleanup before compaction actually begins - and at the very least we would have an assertion failure once compaction completes due to decrementing count below zero.&lt;/p&gt;</comment>
                            <comment id="14262940" author="jmckenzie" created="Fri, 2 Jan 2015 15:18:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;: If we&apos;re going to go the route of surgical tinkering inside DataTracker would you be willing to take over this ticket?  Given the complexity and lack of formality surrounding these relationships I&apos;d prefer not to make these changes personally as I don&apos;t currently have full context / expertise in this area of the code-base.&lt;/p&gt;

&lt;p&gt;If these are indeed indicative of bugs in our current implementation, if we can get a fix in for them quickly (i.e. pre 2.1.5+)  that would probably be best.&lt;/p&gt;</comment>
                            <comment id="14263265" author="benedict" created="Fri, 2 Jan 2015 21:59:29 +0000"  >&lt;p&gt;Sure. I&apos;ll take a look soon.&lt;/p&gt;</comment>
                            <comment id="14265268" author="benedict" created="Mon, 5 Jan 2015 22:51:08 +0000"  >&lt;p&gt;OK, after looking at this some more, I have decided DataTracker has become horrendous, and it is at least partially my fault (SSTableReader early replacement makes it even harder than it was before to cleanly impose desired behaviour). This is largely because we use the functionality subtly differently in every location it&apos;s invoked. &lt;/p&gt;

&lt;p&gt;I think the best option is to go with your most recent patch, since it is very simple and touches the least things, and should work. Then, following &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7705&quot; title=&quot;Safer Resource Management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7705&quot;&gt;&lt;del&gt;CASSANDRA-7705&lt;/del&gt;&lt;/a&gt;, I propose reengineering data tracker (along with sstablereader replacement management) heavily to impose a less fragmented API, a declarative one in which an object encapsulates any intent, ensuring it is used correctly, and safely detecting any scenarios in which it isn&apos;t (as far as possible fixing it, complaining loudly all the while).&lt;/p&gt;</comment>
                            <comment id="14267890" author="jmckenzie" created="Wed, 7 Jan 2015 17:16:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; You good to take review and +1, or should we drag &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; in as an impartial 3rd party?  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14267994" author="benedict" created="Wed, 7 Jan 2015 18:35:43 +0000"  >&lt;p&gt;Yep, looks good to me. +1.&lt;/p&gt;</comment>
                            <comment id="14268150" author="jmckenzie" created="Wed, 7 Jan 2015 20:14:21 +0000"  >&lt;p&gt;v2 committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12762629">CASSANDRA-8513</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12762629">CASSANDRA-8513</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12744723">CASSANDRA-8019</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12688722" name="8399_fix_empty_results.txt" size="2874" author="joshuamckenzie" created="Mon, 22 Dec 2014 21:30:47 +0000"/>
                            <attachment id="12689356" name="8399_v2.txt" size="9083" author="joshuamckenzie" created="Mon, 29 Dec 2014 18:15:46 +0000"/>
                            <attachment id="12684458" name="node2.log" size="101571" author="philipthompson" created="Mon, 1 Dec 2014 18:58:17 +0000"/>
                            <attachment id="12685829" name="ubuntu-8399.log" size="133903" author="philipthompson" created="Mon, 8 Dec 2014 19:32:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22xov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>