<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9457] Empty INITCOND treated as null in aggregate</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9457</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Given the following test data:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; create table foo(k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, primary key(k,v));
cqlsh:test&amp;gt; insert into foo(k,v) values(1,1);
cqlsh:test&amp;gt; insert into foo(k,v) values(1,2);
cqlsh:test&amp;gt; insert into foo(k,v) values(1,3);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And the following aggregate definition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; CREATE FUNCTION cat(s text, v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
            RETURNS NULL ON NULL INPUT
            RETURNS text 
            LANGUAGE java
            AS &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; s + v;&apos;&lt;/span&gt;;
cqlsh:test&amp;gt; CREATE AGGREGATE cats(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) SFUNC cat STYPE text INITCOND &apos;&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The following should return &apos;123&apos;, but it returns null:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; select cats(v) from foo where k = 1;

 test.cats(v)
---------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The empty INITCOND is treated as null, and the SFUNC is never called.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12832168">CASSANDRA-9457</key>
            <summary>Empty INITCOND treated as null in aggregate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="omichallat">Olivier Michallat</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 May 2015 14:12:18 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:10 +0000</updated>
                            <resolved>Thu, 4 Jun 2015 14:03:01 +0000</resolved>
                                        <fixVersion>2.2.0 rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14557260" author="snazy" created="Sat, 23 May 2015 10:07:29 +0000"  >&lt;p&gt;It&apos;s caused by the &lt;tt&gt;parameter.remaining() == 0&lt;/tt&gt; check in &lt;tt&gt;UDFunction&lt;/tt&gt; &lt;a href=&quot;https://github.com/snazy/cassandra/blob/8473-udf-null-v2/src/java/org/apache/cassandra/cql3/functions/UDFunction.java#L143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That check is there to handle empty values in the same way as null values.&lt;br/&gt;
Question is, whether i can simply remove the &lt;tt&gt;parameter.remaining() == 0&lt;/tt&gt; check or whether it&apos;s better to add some &lt;em&gt;if type==String || type==Blob&lt;/em&gt; ?&lt;br/&gt;
Still some doubt about &quot;empty&quot; values.&lt;br/&gt;
/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14557455" author="iamaleksey" created="Sat, 23 May 2015 18:19:24 +0000"  >&lt;p&gt;A blanket &lt;tt&gt;parameter.remaining() == 0&lt;/tt&gt; check is a wrong thing to do here indeed. Should at least make an exception for all string types and blobs. As for what was decided about dealing empty values in general, I was out of the loop, sorry.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14558407" author="snazy" created="Mon, 25 May 2015 17:41:43 +0000"  >&lt;p&gt;Need to special case for empty values. Reason is that we cannot be sure, that a value is never empty (for types like &lt;tt&gt;int&lt;/tt&gt;, &lt;tt&gt;timestamp&lt;/tt&gt; etc).&lt;/p&gt;

&lt;p&gt;Patch does the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;empty INITCOND rejected with an exception&lt;/li&gt;
	&lt;li&gt;empty arguments are treated as null&lt;/li&gt;
	&lt;li&gt;allow empty values for text/ascii/blob&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Currently waiting for cassci builds:&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-9457-udf-empty-string-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall #2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-9457-udf-empty-string-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest #2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14558793" author="slebresne" created="Tue, 26 May 2015 07:38:37 +0000"  >&lt;p&gt;I&apos;m a bit uncomfortable special casing certain types like that, but I don&apos;t have a much better solution to suggest so I&apos;m fine with it. However, we at least need to accept empty values for &quot;custom&quot; type, so instead of having a whitelist of types for which empty values do make sense, I&apos;d prefer adding a blacklist of types that do accept them but for which it doesn&apos;t really make sense. In particular such blacklist won&apos;t ever have to be updated since from now on, when we add new types for which empty values don&apos;t make sense, we actually don&apos;t allow them in the first place, so empty value will be rejected by type-checking for these new types.&lt;/p&gt;

&lt;p&gt;I would also have a preference for adding some &lt;tt&gt;acceptEmptyValuesEvenThoughItDoesntReallyMakeSense()&lt;/tt&gt; method to &lt;tt&gt;AbstractType&lt;/tt&gt; rather hardcoding some list.&lt;/p&gt;
</comment>
                            <comment id="14559670" author="snazy" created="Tue, 26 May 2015 19:21:39 +0000"  >&lt;p&gt;Added a &lt;tt&gt;isEmptyValueMeaningless()&lt;/tt&gt; method to &lt;tt&gt;AbstractType&lt;/tt&gt;, which defaults to &lt;tt&gt;false&lt;/tt&gt; (and is overridden on old types to return &lt;tt&gt;true&lt;/tt&gt;).&lt;br/&gt;
Also added a unit test to check that behavior (incl a custom type).&lt;/p&gt;

&lt;p&gt;Waiting for build#5 on cassci.&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-9457-udf-empty-string-testall/5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall #5&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-9457-udf-empty-string-dtest/5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest #5&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14561127" author="jbellis" created="Wed, 27 May 2015 15:19:18 +0000"  >&lt;p&gt;Tagging &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; for review since he&apos;s already weighed in here.&lt;/p&gt;</comment>
                            <comment id="14564685" author="slebresne" created="Fri, 29 May 2015 12:12:00 +0000"  >&lt;p&gt;Some remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shouldn&apos;t we just assert that the value is neither null nor empty in the &lt;tt&gt;compose_*&lt;/tt&gt; methods (the ones for primitive types)? (haven&apos;t looked what the code currently does here, but if the function is called on nulls then we probably shouldn&apos;t allow unboxed primitives).&lt;/li&gt;
	&lt;li&gt;Not a fan of having &lt;tt&gt;testEmptyTypes&lt;/tt&gt; in &lt;tt&gt;UFTtest&lt;/tt&gt; as that extends &lt;tt&gt;CQLTester&lt;/tt&gt;, so let&apos;s move it to a simple &lt;tt&gt;UDHelperTest&lt;/tt&gt; class. We can also make it more readable by having list of list of types for which &lt;tt&gt;UDHelper.isNullOrEmpty&lt;/tt&gt; returns true and one for which it returns false.&lt;/li&gt;
	&lt;li&gt;It would be nice to at least add a test for aggregates &lt;tt&gt;INITCOND&lt;/tt&gt; since that&apos;s why this ticket has been created.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A few nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We shouldn&apos;t need to override &lt;tt&gt;isEmptyValueMeaningless&lt;/tt&gt; in &lt;tt&gt;FrozenType&lt;/tt&gt; so better not to do it (to avoid having people wonder why it&apos;s there).&lt;/li&gt;
	&lt;li&gt;Unneeded imports in UDHelper.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As a side note, providing a direct link to the actual branch to review would be a nice touch in the future.&lt;/p&gt;
</comment>
                            <comment id="14565308" author="snazy" created="Fri, 29 May 2015 19:59:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;assert that the value is neither null nor empty in the compose_* methods&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No - these methods are just for Java UDFs. Special compose implementations for primitive types.&lt;/p&gt;

&lt;p&gt;Addresses the other remarks and nits in the last commit.&lt;/p&gt;

&lt;p&gt;(Apologies for the forgotten link)&lt;/p&gt;</comment>
                            <comment id="14567021" author="slebresne" created="Mon, 1 Jun 2015 07:35:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;No - these methods are just for Java UDFs. Special compose implementations for primitive types.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m sure I&apos;m slow but I don&apos;t understand how that&apos;s a justification in itself. I think we should avoid silently defaulting to a non-null value like those method do and we shouldn&apos;t have to provided we only use unboxed types when &lt;tt&gt;RETURNS NULL ON NULL INPUT&lt;/tt&gt; is used, .&lt;/p&gt;</comment>
                            <comment id="14567111" author="snazy" created="Mon, 1 Jun 2015 09:46:55 +0000"  >&lt;p&gt;The intention of these special &lt;tt&gt;compose_&lt;/tt&gt; methods is that Java UDFs with &lt;tt&gt;RETURNS NULL ON NULL INPUT&lt;/tt&gt; get the primitive types in the signature.&lt;br/&gt;
It was more or less some kind of simplification for javassist. With ecj it&apos;s no longer necessary - so I think I can remove that special case for it and always pass the boxed values to Java UDFs.&lt;/p&gt;

&lt;p&gt;Comparison of Java UDF signatures (pseudo code):&lt;br/&gt;
&lt;tt&gt;CREATE FUNCTION foo(a int, b bigint) RETURNS NULL ON NULL INPUT&lt;/tt&gt; &lt;br/&gt;
&lt;tt&gt;executeUserDefined(int a, long b) ...&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;CREATE FUNCTION foo(a int, b bigint) CALLED ON NULL INPUT&lt;/tt&gt; &lt;br/&gt;
&lt;tt&gt;executeUserDefined(java.lang.Integer a, java.lang.Long b) ...&lt;/tt&gt;&lt;/p&gt;
</comment>
                            <comment id="14567124" author="slebresne" created="Mon, 1 Jun 2015 10:12:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;The intention of these special compose_ methods is that Java UDFs with RETURNS NULL ON NULL INPUT get the primitive types in the signature.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I understand that. What I&apos;m saying is that since those special compose are only ever use when the function uses &lt;tt&gt;RETURNS NULL ON NULL INPUT&lt;/tt&gt;, then those methods should never be effectively called with null/empty inputs (since the whole function should be bypassed before we reach the call to these methods). So why do these special compose methods test their inputs for null/empty and return some default value? It&apos;s useless and confusing. Instead they should assert that the input is not null/empty since it would be a bug.&lt;/p&gt;</comment>
                            <comment id="14567175" author="snazy" created="Mon, 1 Jun 2015 11:15:31 +0000"  >&lt;p&gt;Sorry - I totally misunderstood. Yes - you&apos;re right, that&apos;s confusing.&lt;/p&gt;</comment>
                            <comment id="14571653" author="snazy" created="Wed, 3 Jun 2015 21:12:35 +0000"  >&lt;p&gt;Fixed the checks in &lt;tt&gt;compose_*&lt;/tt&gt; methods (changed to assertions).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-9457-udf-empty-string-dtest/9/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-9457-udf-empty-string-testall/9/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14572745" author="slebresne" created="Thu, 4 Jun 2015 13:29:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14572803" author="snazy" created="Thu, 4 Jun 2015 14:03:01 +0000"  >&lt;p&gt;Committed as 4df4f79c563232285137ab2d506836de4e4efa1d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12737376" name="9457.txt" size="34003" author="snazy" created="Wed, 3 Jun 2015 21:15:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2f3wn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324945">2.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>