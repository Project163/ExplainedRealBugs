<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12997] Use timestamp from ClientState by default in AlterTableStatement</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12997</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/trunk_testall/1298/testReport/org.apache.cassandra.cql3.validation.operations/AlterTest/testDropListAndAddListWithSameName&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_testall/1298/testReport/org.apache.cassandra.cql3.validation.operations/AlterTest/testDropListAndAddListWithSameName&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Error Message

Invalid value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row 0 column 2 (mycollection of type list&amp;lt;text&amp;gt;), expected &amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&amp;gt; but got &amp;lt;[first element]&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stacktrace

junit.framework.AssertionFailedError: Invalid value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row 0 column 2 (mycollection of type list&amp;lt;text&amp;gt;), expected &amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&amp;gt; but got &amp;lt;[first element]&amp;gt;
	at org.apache.cassandra.cql3.CQLTester.assertRows(CQLTester.java:908)
	at org.apache.cassandra.cql3.validation.operations.AlterTest.testDropListAndAddListWithSameName(AlterTest.java:87)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13025644">CASSANDRA-12997</key>
            <summary>Use timestamp from ClientState by default in AlterTableStatement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="sean.mccarthy">Sean McCarthy</reporter>
                        <labels>
                            <label>test-failure</label>
                            <label>testall</label>
                    </labels>
                <created>Mon, 5 Dec 2016 14:20:50 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:13 +0000</updated>
                            <resolved>Mon, 16 Jan 2017 09:51:53 +0000</resolved>
                                        <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15725815" author="slebresne" created="Tue, 6 Dec 2016 15:28:21 +0000"  >&lt;p&gt;That test seem to have failed only once from CI history and I haven&apos;t been able to reproduce in 100+ local runs, so I can theorize about what happened, but it&apos;s just that, theory.&lt;/p&gt;

&lt;p&gt;The test insert a value for a column, drop the column, add it back (same type), and query it. It expects the value to be &lt;tt&gt;null&lt;/tt&gt; since it has remove through the drop, and that&apos;s what it gets, except for that one run when it got the initial value back on the read.&lt;/p&gt;

&lt;p&gt;My best theory is that it&apos;s a timestamp issue. Somehow, the initial insertion ended up with a higher timestamp than the timestamp used for the &lt;tt&gt;DROP&lt;/tt&gt;, so that on a read the old value is considered post-&lt;tt&gt;DROP&lt;/tt&gt;. Which, and I&apos;m still in the realm of theories, could happen if on CI nptd kicked in just at the wrong moment. It&apos;s a stretch, but as that has only even happened once that I can tell, this could be a case of bad luck.&lt;/p&gt;

&lt;p&gt;There is another reason why this could happen: inserts use &lt;tt&gt;ClientState.getTimestamp()&lt;/tt&gt; to generate their timestamp, which ensure that inserts coordinated by the same node always get strictly increasing timestamps, and do so by adding &quot;fake&quot; microseconds when it has to generate multiple timestamps in the same milliseconds. &lt;tt&gt;ALTER TABLE DROP&lt;/tt&gt; simply relies on &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt; however, so if multiple inserts, followed by a &lt;tt&gt;DROP&lt;/tt&gt; happen in the same milliseconds, all but the first insert will actually have a higher timestamp than the drop one. This is also a bit of a stretch because the test does only a single insert, so while a prior test insert could interfer, that would be pretty timing. But it seems to be what this is ultimately so ....&lt;/p&gt;

&lt;p&gt;Anyway, the previous point is the crux of the patch I&apos;m attaching below: it uses the &lt;tt&gt;ClientState.getTimestamp()&lt;/tt&gt; mechanism for &lt;tt&gt;ALTER TABLE DROP&lt;/tt&gt; too. This ensures that the drop will always get a higher timestamp than any previous insert (coordinated by the same node), thus avoiding both theoretical problem above. It feels kind of the right thing to do anyway. The one annoyance is that we have to pass the &lt;tt&gt;QueryState&lt;/tt&gt; to &lt;tt&gt;announceMigration()&lt;/tt&gt; which is overriden by all schema altering statement, which is why the patch is more than 2 lines (but it&apos;s 2 lines of non automatic change).&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/12997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12997&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12997-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12997-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;ll note lastly that the patch is against trunk, as was the test failure, but assuming my theories above are indeed the reason for that one failure, this could happen on pretty much any version. That said, it&apos;s really just to make the test happy as no-one in real life will even run into this, so I don&apos;t see the point of taking any kind of risk.&lt;/p&gt;</comment>
                            <comment id="15804604" author="iamaleksey" created="Fri, 6 Jan 2017 14:05:55 +0000"  >&lt;p&gt;TBH this feels just a tiny bit heavy-handed and not really fixing the issue (for cases with multiple nodes).&lt;/p&gt;

&lt;p&gt;Nor do I think that this is a big issue to be fixed, in general. So the only real thing we should address here is the flakiness of the test.&lt;/p&gt;

&lt;p&gt;For that I see two slightly simpler options:&lt;/p&gt;

&lt;p&gt;1. (Uglier) Just use &lt;tt&gt;System.currentTimeMillis() + 1&lt;/tt&gt; in &lt;tt&gt;AlterTableStatement&lt;/tt&gt;&lt;br/&gt;
2. (Prettier) Now that we have &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7190&quot; title=&quot;Add schema to snapshot manifest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7190&quot;&gt;&lt;del&gt;CASSANDRA-7190&lt;/del&gt;&lt;/a&gt;, in the test itself pass explicit timestamp to &lt;tt&gt;ALTER TABLE DROP&lt;/tt&gt; via &lt;tt&gt;USING TIMESTAMP&lt;/tt&gt;, and do the same for inserts. This would make the test fully deterministic.&lt;/p&gt;</comment>
                            <comment id="15804639" author="slebresne" created="Fri, 6 Jan 2017 14:27:23 +0000"  >&lt;p&gt;I think it&apos;s unfair to call it heavy-handed. The bulk of the patch is just passing &lt;tt&gt;QueryState&lt;/tt&gt; to &lt;tt&gt;announceMigration&lt;/tt&gt;, which honestly we could well need for any other reason in the future anyway. The only real change here is to use &lt;tt&gt;QueryState.getTimestamp()&lt;/tt&gt; for the drop timestamp, which is pretty trivial and is, I claim, TheRightThingToDo&#8482;, as the drop timestamp whole point is to be compared to cell timestamps and thus by using the same generator for both is just good hygiene. That&apos;s the important point here: I don&apos;t care about the test in practice, but I think drop should have reused our usual way to generate timestamps for queries in the first place, and it&apos;s high time we do this properly. Don&apos;t get me wrong, none of this is terribly important, but I just don&apos;t want to focus on a crappy test when we can actually ever so slightly improve the code.&lt;/p&gt;</comment>
                            <comment id="15804664" author="iamaleksey" created="Fri, 6 Jan 2017 14:38:41 +0000"  >&lt;p&gt;Sorry. Heavy-handed was an unnecessary exaggeration.&lt;/p&gt;

&lt;p&gt;But this way in a multiple-node cluster the outcome would still depend on which node gets the schema statement, and that node&apos;s &lt;tt&gt;lastTimestampMicros&lt;/tt&gt; value, making it generally non-deterministic. So this change doesn&apos;t fundamentally fix the problem, just feels a bit more right.&lt;/p&gt;

&lt;p&gt;That said, who really cares? Go ahead with either option. +1 to the original patch.&lt;/p&gt;</comment>
                            <comment id="15823700" author="slebresne" created="Mon, 16 Jan 2017 09:51:53 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37673:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>