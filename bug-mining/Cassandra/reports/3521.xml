<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9194] Delete-only workloads crash Cassandra</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9194</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The size of a tombstone is not properly accounted for in the memtable. A memtable which has only tombstones will never get flushed. It will grow until the JVM runs out of memory. The following program easily demonstrates the problem.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		Cluster.Builder builder = Cluster.builder();
		
		Cluster c = builder.addContactPoints(&lt;span class=&quot;code-quote&quot;&gt;&quot;cas121.devf3.com&quot;&lt;/span&gt;).build();
		
		Session s = c.connect();
			
		s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE IF NOT EXISTS test WITH replication = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : 1 }&quot;&lt;/span&gt;);

		s.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE IF NOT EXISTS test.test(id INT PRIMARY KEY)&quot;&lt;/span&gt;);

		PreparedStatement stmt = s.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM test.test WHERE id = :id&quot;&lt;/span&gt;);

		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; id = 0;
		
		&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
		{
			s.execute(stmt.bind(id));
			
			id++;
		}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This program should run forever, but eventually Cassandra runs out of heap and craps out. You needn&apos;t wait for Cassandra to crash. If you run &quot;nodetool cfstats test.test&quot; while it is running, you&apos;ll see Memtable cell count grow, but Memtable data size will remain 0.&lt;/p&gt;

&lt;p&gt;This issue was fixed once before. I received a patch for version 2.0.5 (I believe), which contained the fix, but the fix has apparently been lost, because it is clearly broken, and I don&apos;t see the fix in the change logs.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.0.14&lt;/p&gt;</environment>
        <key id="12821137">CASSANDRA-9194</key>
            <summary>Delete-only workloads crash Cassandra</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="rwille@fold3.com">Robert Wille</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Apr 2015 12:41:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:14 +0000</updated>
                            <resolved>Fri, 1 May 2015 10:35:34 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                    <fixVersion>2.2.0 rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14496535" author="philipthompson" created="Wed, 15 Apr 2015 17:13:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt; will bisect the issue.&lt;/p&gt;</comment>
                            <comment id="14497058" author="mambocab" created="Wed, 15 Apr 2015 21:38:46 +0000"  >&lt;p&gt;Thanks for the test, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rwille%40fold3.com&quot; class=&quot;user-hover&quot; rel=&quot;rwille@fold3.com&quot;&gt;rwille@fold3.com&lt;/a&gt;. I&apos;ve rewritten it &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;as a dtest&lt;/a&gt; and reproduced the error, though not to an OOM. It &lt;a href=&quot;https://gist.github.com/mambocab/08577841f4f74a722910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fails&lt;/a&gt; on all 2.0 and 2.1 releases.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rwille%40fold3.com&quot; class=&quot;user-hover&quot; rel=&quot;rwille@fold3.com&quot;&gt;rwille@fold3.com&lt;/a&gt;, any luck finding the patch you were using? Looks like it was never merged into a released version.&lt;/p&gt;</comment>
                            <comment id="14497104" author="mambocab" created="Wed, 15 Apr 2015 22:05:42 +0000"  >&lt;p&gt;Assigning &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; because this issue is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6655&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;#6655&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14497440" author="rwille@fold3.com" created="Thu, 16 Apr 2015 01:36:17 +0000"  >&lt;p&gt;I actually haven&apos;t run it to OOM either, although I assume it would. The JVM becomes impossibly slow with 30 second GC&apos;s.&lt;/p&gt;

&lt;p&gt;Actually, I dug around some more in my email and I found a conversation I had with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; who fixed this problem back in 2.0.6. My email confirmed that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6655&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-6655&lt;/a&gt; is the ticket that contained the patch that fixed my woes a year ago. Now I&apos;m more confused than ever why this bug still happens.&lt;/p&gt;</comment>
                            <comment id="14497464" author="benedict" created="Thu, 16 Apr 2015 02:12:41 +0000"  >&lt;p&gt;It looks like partition level deletes aren&apos;t accounted for, since we only compare the delta between the before/after deletionInfo, and both have the deletion timestamp. This is already behaving properly in 2.1, since we track actual memory used. For 2.0, the amount we track is kind of arbitrary in this scenario, so I&apos;ve just got it to add 1 for the first partition, so we never track zero for an otherwise empty update, but so that we have the minimal impact on all other workloads (we&apos;ll be dependent upon the liveRatio here, as always in 2.0, to have sensible behaviour).&lt;/p&gt;</comment>
                            <comment id="14497491" author="jbellis" created="Thu, 16 Apr 2015 02:56:56 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14503090" author="mambocab" created="Mon, 20 Apr 2015 16:07:12 +0000"  >&lt;p&gt;I&apos;m afraid I don&apos;t follow.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This is already behaving properly in 2.1&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/mambocab/08577841f4f74a722910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;The results&lt;/a&gt; of &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/blob/master/deletion_test.py#L44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the dtest&lt;/a&gt; show that the tracked memtable size is 0 in 2.1 after performing 100 deletions &amp;#8211; &lt;tt&gt;MemtableLiveDataSize&lt;/tt&gt; is reported as 0 over JMX even when &lt;tt&gt;MemtableColumnsCount&lt;/tt&gt; is 100. Is that behavior correct? I may not have been clear, but that test fails on all released 2.0 and 2.1 versions.&lt;/p&gt;

&lt;p&gt;Also, I don&apos;t understand why the amount of memory to track for tombstones is arbitrary in 2.0.&lt;/p&gt;</comment>
                            <comment id="14505033" author="benedict" created="Tue, 21 Apr 2015 14:32:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;: thanks for being diligent about this. In 2.1 we &lt;em&gt;do&lt;/em&gt; account for its on-heap size (if you check), which is what this bug is indicating we do not track. The deletion itself is not counted towards the live data size though (i.e. the proportion of heap that is actually data). This is because the space used is already used. I&apos;m not sure we care enough to special case this, as we need to check if the deletiontime &lt;em&gt;was&lt;/em&gt; live and is now &lt;em&gt;not&lt;/em&gt; live and add 8 in this case, but even this is kind of arbitrary. This live size in general is kind of an arbitrary measure, so perhaps we can just add 8 to live bytes when we first insert a row, since there will always be some overhead. &lt;/p&gt;

&lt;p&gt;Since the value we&apos;re reporting is kind of a fabrication, I&apos;m sanguine about leaving it as is, or changing it to some other arbitrary value. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; got any opinion either way, since you +1&apos;d the first patch?&lt;/p&gt;</comment>
                            <comment id="14505760" author="jbellis" created="Tue, 21 Apr 2015 21:05:20 +0000"  >&lt;p&gt;I figured that in 2.0 it will self-correct via liveRatio, so it doesn&apos;t really matter what constant we use.&lt;/p&gt;</comment>
                            <comment id="14505980" author="mambocab" created="Tue, 21 Apr 2015 23:10:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; I think I understand now; thanks for the explanation.&lt;/p&gt;

&lt;p&gt;I&apos;ve &lt;a href=&quot;https://github.com/mambocab/cassandra-dtest/commit/25ee5b7050e96a85cd4e33eadc41a21cec7da393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;changed the test&lt;/a&gt; so that it checks &lt;tt&gt;MemtableOnHeapSize&lt;/tt&gt; for versions &amp;gt;= 2.1 and &lt;tt&gt;MemtableDataSize&lt;/tt&gt; for 2.0. As you indicated, it passes on 2.1.4 and trunk. It currently fails on 2.0.4. Does that sound right to you?&lt;/p&gt;

&lt;p&gt;I can&apos;t seem to apply your patch to 2.0; it looks like it was written for 2.1? But I&apos;m +1 on the same logic applied to 2.0 if it passes the dtest.&lt;/p&gt;</comment>
                            <comment id="14507133" author="benedict" created="Wed, 22 Apr 2015 14:06:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;: I was referring to the behaviour in 2.1, in which we still track the live size from 2.0, but only for informational purposes. It&apos;s kind of arbitrary and definitely storage layer dependent (so subject to change), whereas in 2.0 I wanted to affect existing behaviour minimally. I&apos;m a little tempted to suggest we drop the live size tracking entirely in 3.0. In the meantime we could just always count 8 bytes for the row marker, although arguably we should really be counting the partition key bytes as well. I have literally no opinion for once.&lt;/p&gt;</comment>
                            <comment id="14507136" author="benedict" created="Wed, 22 Apr 2015 14:09:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;: Looks like I did mess-up my base for that patch. Try this one.&lt;/p&gt;</comment>
                            <comment id="14507191" author="mambocab" created="Wed, 22 Apr 2015 14:49:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Great, thanks. That patch applies cleanly to 2.0.14, and my test fails on the unpatched version and passes on the patched version. &lt;/p&gt;

&lt;p&gt;The dtest checks &lt;tt&gt;MemtableOnHeapSize&lt;/tt&gt; for versions &amp;gt;= 2.1 and &lt;tt&gt;MemtableDataSize&lt;/tt&gt; for 2.0. If you can confirm that that&apos;s the right metric to use, I&apos;m +1 on the patch.&lt;/p&gt;</comment>
                            <comment id="14517622" author="mambocab" created="Tue, 28 Apr 2015 18:35:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Have you decided how to count the size of the data? and is &lt;tt&gt;MemtableOnHeapSize&lt;/tt&gt; for 2.1 and up/&lt;tt&gt;MemtableDataSize&lt;/tt&gt; for 2.0 the right JMX metric to use to check correctness? Thanks.&lt;/p&gt;</comment>
                            <comment id="14523017" author="benedict" created="Fri, 1 May 2015 10:35:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;: I&apos;ve committed to trunk. Those metrics are indeed correct, I was just waiting for an opinion on how to account for live data size in 2.1 (which is not a matter of correctness, so is only slightly related to this bug but should be dealt with at the same time). I opted to treat it as 8 bytes in 2.1, for the record.&lt;/p&gt;</comment>
                            <comment id="14523336" author="mambocab" created="Fri, 1 May 2015 15:38:05 +0000"  >&lt;p&gt;Awesome, thanks!&lt;/p&gt;

&lt;p&gt;For posterity: The dtest for this was committed &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and the metrics used were corrected &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12727236" name="9194.2.txt" size="1255" author="benedict" created="Wed, 22 Apr 2015 14:09:33 +0000"/>
                            <attachment id="12725762" name="9194.txt" size="1425" author="benedict" created="Thu, 16 Apr 2015 02:12:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2da33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mambocab</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>