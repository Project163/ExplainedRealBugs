<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3872] Sub-columns removal is broken in 1.1</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3872</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3716&quot; title=&quot;Clean up isMarkedForDelete / getLocalDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3716&quot;&gt;&lt;del&gt;CASSANDRA-3716&lt;/del&gt;&lt;/a&gt; actually broke sub-columns deletion. The reason is that in QueryFilter.isRelevant, we&apos;ve switched in checking getLocalDeletionTime() only (without looking for isMarkedForDelete). But for columns containers (in this case SuperColumn), the default local deletion time when not deleted is Integer.MIN_VALUE. In other words, a SC with only non-gcable tombstones will be considered as not relevant (while it should).&lt;/p&gt;

&lt;p&gt;This is caught by two unit tests (RemoveSuperColumnTest and RemoveSubColumnTest) that are failing currently.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12541652">CASSANDRA-3872</key>
            <summary>Sub-columns removal is broken in 1.1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Feb 2012 16:56:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:40 +0000</updated>
                            <resolved>Tue, 14 Feb 2012 11:01:22 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13202538" author="slebresne" created="Tue, 7 Feb 2012 17:06:27 +0000"  >&lt;p&gt;Attaching patch for this. The idea is to make containers use MAX_VALUE instead of MIN_VALUE  for localDeleteionTime. There is however two things to consider:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;for containers, we do serialize the localDeletionTime, so we have to be careful for upgrade (mixed version cluster). What the patch does is to recognize when someone provided MIN_VALUE and transforming to MAX_VALUE. This only work when old node send use MIN_VALUE, however &lt;b&gt;I think&lt;/b&gt; it is actually OK to send MAX_VALUE to old node (pre-1.1 code uses markedForDeleteAt to decide if a container is deleted, not localDeletionTime, so we shouldn&apos;t break anything).&lt;/li&gt;
	&lt;li&gt;CFS.removeDeleted has to be able to distinguish between an empty container that is marked for deletion (but not gcable) and one that is not marked for deletion. In the former, we should keep the container, not in the latter. This means that this patch actually reintroduce the use of isMarkedForDelete() for containers in CFS.removeDeleted (for containers, isMarkedForDelete is not timing dependent).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note that there would likely be other ways to fix this issue (reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3716&quot; title=&quot;Clean up isMarkedForDelete / getLocalDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3716&quot;&gt;&lt;del&gt;CASSANDRA-3716&lt;/del&gt;&lt;/a&gt; would be one).&lt;/p&gt;

&lt;p&gt;In any case, the patch fixes the two unit tests.&lt;/p&gt;</comment>
                            <comment id="13202983" author="jbellis" created="Tue, 7 Feb 2012 23:54:21 +0000"  >&lt;p&gt;Could we do a simpler fix by turning column.mostRecentLiveChangeAt into column.mostRecentChangeAt? I don&apos;t think restricting to live columns is actually useful here (although it is in SQF, so we&apos;d need a new method instead of replacing mRLCA).&lt;/p&gt;</comment>
                            <comment id="13203476" author="slebresne" created="Wed, 8 Feb 2012 11:11:38 +0000"  >&lt;p&gt;Apologies, I didn&apos;t realized that there was actually kind of 2 problems and I mixed both, so let&apos;s be more precise.&lt;/p&gt;

&lt;p&gt;The regression that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3716&quot; title=&quot;Clean up isMarkedForDelete / getLocalDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3716&quot;&gt;&lt;del&gt;CASSANDRA-3716&lt;/del&gt;&lt;/a&gt; introduced and that is making the tests fail is that a &lt;b&gt;live&lt;/b&gt; super column with only non-gcable tombstones is now considered irrelevant, while it is relevant in say 1.0.&lt;/p&gt;

&lt;p&gt;That led me to realize that containers are using MIN_VALUE for gLDT when not deleted. Now, leaving aside the tests failure, I do think we should change that. Post-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3716&quot; title=&quot;Clean up isMarkedForDelete / getLocalDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3716&quot;&gt;&lt;del&gt;CASSANDRA-3716&lt;/del&gt;&lt;/a&gt;, we&apos;ve made sure that for normal columns, testing &lt;tt&gt;getLocalDeletionTime() &amp;lt; gcbefore&lt;/tt&gt; allows us solely to decide whether the column is gcable (and thus by extension tombstoned) or not. I think it&apos;s a good thing, the local deletion time is here for the tombstone gc and so that makes sense. But currently, this is not true for SuperColumns nor ColumnFamily (but it&apos;s worst for SC since they actually are IColumn), where &lt;tt&gt;getLocalDeletionTime() &amp;lt; gcbefore&lt;/tt&gt; means &apos;either gcable or not deleted at all&apos;. Leaving things that way would be very error-prone imho and defeat the purpose of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3716&quot; title=&quot;Clean up isMarkedForDelete / getLocalDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3716&quot;&gt;&lt;del&gt;CASSANDRA-3716&lt;/del&gt;&lt;/a&gt; since we&apos;re reintroducing subtle differences that are hard to work with.&lt;/p&gt;

&lt;p&gt;Now, as it happens, I think we have an old bug in QF.isRelevant (i.e. including in 0.8 and probably before that). Namely that a &lt;b&gt;live&lt;/b&gt; SC with only non-gcable tombstones is considered relevant, but a &lt;b&gt;gcable&lt;/b&gt; SC with only non-gcable is considered irrelevant but I don&apos;t think it should. To fix that, we can indeed do the mostRecentChangeAt change (and that would fix the unit tests in particular but as said above, I think we should still do the MIN_VALUE-&amp;gt;MAX_VALUE change for other reasons). However, that would imply that &lt;b&gt;gcable&lt;/b&gt; SC with only &lt;b&gt;gcable&lt;/b&gt; tombstones would be considered relevant (if the max tombstone timestamp is greater than the SC timestamp), so maybe we want to switch to a column.mostRecentNonGcableChangeAt() instead.&lt;br/&gt;
I&apos;ll open a separate ticket for that change, as this affect previous version too. I&apos;m leaving this one open to focus on the MIN_VALUE-&amp;gt;MAX_VALUE change.&lt;/p&gt;</comment>
                            <comment id="13205881" author="jbellis" created="Fri, 10 Feb 2012 23:46:36 +0000"  >&lt;p&gt;Isn&apos;t this patch kind of a wash?  The MIN_VALUE checks go away but in return we need to add extra isMarkedForDelete checks.&lt;/p&gt;</comment>
                            <comment id="13206806" author="slebresne" created="Mon, 13 Feb 2012 11:15:17 +0000"  >&lt;p&gt;I do not pretend this reduce line of codes, but I do think that it makes it easier to not make subtle mistakes.&lt;/p&gt;

&lt;p&gt;Currently, there is a mismatch between how Column (the class) and the two IColumnContainer classes (CF and SC) handles getLocalDeletionTime() for non-deleted. The former uses MAX_VALUE, the latter uses MIN_VALUE. The lack of consistency alone is annoying but as long as SC lives it is made much worst by the fact that SC is both a IColumn and a IColumnContainer.&lt;/p&gt;

&lt;p&gt;The attached patch tries to make things more consistent. The localDeletionTime is here for the purpose of tombstone garbage collection, so it seems to me that it is cleaner to use it for that purpose and that purpose only. In other words, with this patch, &lt;tt&gt;(getLocalDeletionTime() &amp;lt; gcbefore)&lt;/tt&gt; tells you without ambiguity if you&apos;re dealing with a gcable tombstone or not.&lt;/p&gt;

&lt;p&gt;Now there is the fact that live but empty containers are not returned to the user. I believe that was one of the reason of using MIN_VALUE for live containers. But imho this is a hack and it&apos;s much more clear in removeDeleted to read:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (cf.getColumnCount() == 0 &amp;amp;&amp;amp; (!cf.isMarkedForDelete() || cf.getLocalDeletionTime() &amp;lt; gcBefore))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which directly translate into: if the cf is empty and it&apos;s either a gcable tombstone or a live cf, we can skip it, rather that having to check the code of ColumnFamily to understand why that does skip live empty CF &lt;b&gt;and&lt;/b&gt; to have to remember each time you use CF.localDeletionTime that it may be MIN_VALUE for non-deleted CF and assert if it matters or not.&lt;/p&gt;</comment>
                            <comment id="13207371" author="jbellis" created="Mon, 13 Feb 2012 23:59:15 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Can you add a reference to this ticket to the &quot;new default is MAX_VALUE&quot; comment on commit?&lt;/p&gt;</comment>
                            <comment id="13207632" author="slebresne" created="Tue, 14 Feb 2012 11:01:22 +0000"  >&lt;p&gt;Committed (with added link to the issue), thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12513634" name="3872.patch" size="4330" author="slebresne" created="Tue, 7 Feb 2012 17:06:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226939</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gp93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95521</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>