<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10593] Unintended interactions between commitlog archiving and commitlog recycling</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10593</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently the comments in commitlog_archiving.properties suggest using either cp or ln for the archive_command.  &lt;/p&gt;

&lt;p&gt;Using ln is problematic because commitlog recycling marks segments as recycled once the corresponding memtables are flushed and Cassandra will no longer replay them. This means it&apos;s only possible to do PITR on any records that were written since the last flush.&lt;/p&gt;

&lt;p&gt;Using cp works, and this is currently how OpsCenter does for PITR, however &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; has pointed out this could have some performance impact because of the additional I/O overhead of copying the commitlog segments.&lt;/p&gt;

&lt;p&gt;Starting in 2.1, we can disable commit log recycling in cassandra.yaml so I thought this would allow me to do PITR without the extra overhead of using cp.  However, when I disable commitlog recycling and try to do a PITR, Cassandra blows up when trying to replay the restored commit logs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR 16:56:42  Exception encountered during startup
java.lang.IllegalStateException: Cannot safely construct descriptor &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; segment, as name and header descriptors &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match ((4,1445878452545) vs (4,1445876822565)): /opt/dse/backup/CommitLog-4-1445876822565.log
	at org.apache.cassandra.db.commitlog.CommitLogArchiver.maybeRestoreArchive(CommitLogArchiver.java:207) ~[cassandra-all-2.1.9.791.jar:2.1.9.791]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:116) ~[cassandra-all-2.1.9.791.jar:2.1.9.791]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:352) ~[cassandra-all-2.1.9.791.jar:2.1.9.791]
	at com.datastax.bdp.server.DseDaemon.setup(DseDaemon.java:335) ~[dse-core-4.8.0.jar:4.8.0]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:537) ~[cassandra-all-2.1.9.791.jar:2.1.9.791]
	at com.datastax.bdp.DseModule.main(DseModule.java:75) [dse-core-4.8.0.jar:4.8.0]
java.lang.IllegalStateException: Cannot safely construct descriptor &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; segment, as name and header descriptors &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match ((4,1445878452545) vs (4,1445876822565)): /opt/dse/backup/CommitLog-4-1445876822565.log
	at org.apache.cassandra.db.commitlog.CommitLogArchiver.maybeRestoreArchive(CommitLogArchiver.java:207)
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:116)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:352)
	at com.datastax.bdp.server.DseDaemon.setup(DseDaemon.java:335)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:537)
	at com.datastax.bdp.DseModule.main(DseModule.java:75)
Exception encountered during startup: Cannot safely construct descriptor &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; segment, as name and header descriptors &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match ((4,1445878452545) vs (4,1445876822565)): /opt/dse/backup/CommitLog-4-1445876822565.log
INFO  16:56:42  DSE shutting down...
INFO  16:56:42  All plugins are stopped.
ERROR 16:56:42  Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2,5,main]
java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.gms.Gossiper.addLocalApplicationState(Gossiper.java:1403) ~[cassandra-all-2.1.9.791.jar:2.1.9.791]
	at com.datastax.bdp.gms.DseState.setActiveStatus(DseState.java:196) ~[dse-core-4.8.0.jar:4.8.0]
	at com.datastax.bdp.server.DseDaemon.preStop(DseDaemon.java:426) ~[dse-core-4.8.0.jar:4.8.0]
	at com.datastax.bdp.server.DseDaemon.safeStop(DseDaemon.java:436) ~[dse-core-4.8.0.jar:4.8.0]
	at com.datastax.bdp.server.DseDaemon$1.run(DseDaemon.java:676) ~[dse-core-4.8.0.jar:4.8.0]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.8.0_31]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the sake of completeness, I also tested using cp for the archive_command and commitlog recycling disabled, and PITR works as expected, but this of course defeats the point.&lt;/p&gt;

&lt;p&gt;It would be good to have some guidance on what is supported here. If ln isn&apos;t expected to work at all, it shouldn&apos;t be documented as an acceptable option for the archive_command in commitlog_archiving.properties.  If it should work with commitlog recycling disabled, the bug causing the IllegalStateException needs to be fixed. &lt;/p&gt;

&lt;p&gt;It would also be good to do some testing and quantify the performance impact of enabling commitlog archiving using cp as the archve_command.&lt;/p&gt;

&lt;p&gt;I realize there are several different issues described here, so maybe they should be separate JIRAs, but first I wanted to just clarify whether we want to support ln at all, and we can go from there.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12907979">CASSANDRA-10593</key>
            <summary>Unintended interactions between commitlog archiving and commitlog recycling</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="jblangston@datastax.com">J.B. Langston</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Oct 2015 17:15:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:52 +0000</updated>
                            <resolved>Fri, 18 Dec 2015 23:41:19 +0000</resolved>
                                        <fixVersion>2.1.13</fixVersion>
                    <fixVersion>2.2.5</fixVersion>
                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.2</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14994165" author="mambocab" created="Fri, 6 Nov 2015 18:33:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; could you diagnose this? I&apos;m not sure what&apos;s expected here.&lt;/p&gt;</comment>
                            <comment id="15004247" author="iamaleksey" created="Fri, 13 Nov 2015 16:42:54 +0000"  >&lt;p&gt;Closing as Won&apos;t FIx, as recycling&apos;s already been removed in 2.2+, and there is a workaround for 2.1.&lt;/p&gt;</comment>
                            <comment id="15004660" author="brandon.williams" created="Fri, 13 Nov 2015 20:25:44 +0000"  >&lt;p&gt;I don&apos;t think &quot;use cp instead of ln&quot; is an acceptable workaround, a copy of a file and a hard link are quite different, especially in terms of creation cost.&lt;/p&gt;</comment>
                            <comment id="15036790" author="aweisberg" created="Wed, 2 Dec 2015 22:36:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jblangston%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;jblangston@datastax.com&quot;&gt;jblangston@datastax.com&lt;/a&gt; I was unable to reproduce this? &lt;/p&gt;

&lt;p&gt;My test procedure using the attached config files was as follows&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Start Cassandra&lt;/li&gt;
	&lt;li&gt;Run stress&lt;/li&gt;
	&lt;li&gt;nodetool flush&lt;/li&gt;
	&lt;li&gt;kill cassandra&lt;/li&gt;
	&lt;li&gt;delete the data directory for C* containing all the data files and commitlog files&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I could reproduce the issue by trying to do the PITR a second time. That makes me wonder if on restart after the PITR the server had modified the archived commit log segments that it just used for the replay. I wonder if using ln to archive but cp to restart would work. Going to try a few more permutations.&lt;/p&gt;</comment>
                            <comment id="15038408" author="aweisberg" created="Thu, 3 Dec 2015 19:28:38 +0000"  >&lt;p&gt;There seem to be two blockers. One is that issue where archiving existing segments at startup fails if they have already been archived. The other is that even when segment recycling is disabled we recycle segments after commit log replay instead of deleting them. Since they were hard linked into the archive directory we end up modifying the header and now the name and header no longer match and we have blown away the contents of the archived segment.&lt;/p&gt;</comment>
                            <comment id="15038770" author="aweisberg" created="Thu, 3 Dec 2015 22:58:19 +0000"  >&lt;p&gt;Proposed fix including a new dtest. I still need to evaluate what happens in 2.2+ to see how much of this if any is going to be necessary in later versions.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...aweisberg:CASSANDRA-10593-2.1?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/697&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10593-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10593-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...aweisberg:CASSANDRA-10593-2.2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/697&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10593-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10593-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15045714" author="aweisberg" created="Mon, 7 Dec 2015 20:57:29 +0000"  >&lt;p&gt;Turns out there is still the minor issue in 2.2+ where startup tries to archive segments that are already archived and fails. Brought that fix forward from 2.1 as a separate branch.&lt;/p&gt;

&lt;p&gt;I also needed to update the dtest to load a bit more data to get enough commit log segments for the test to work.&lt;/p&gt;</comment>
                            <comment id="15057992" author="blambov" created="Tue, 15 Dec 2015 12:36:43 +0000"  >&lt;p&gt;Both branches look good to me.&lt;/p&gt;</comment>
                            <comment id="15064976" author="iamaleksey" created="Fri, 18 Dec 2015 23:40:53 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/3740f815c21254bd625ad1cbe8d47aa657727a83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3740f815c21254bd625ad1cbe8d47aa657727a83&lt;/a&gt; to 2.1 and merged with 2.2, 3.0, and trunk. Thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12702932">CASSANDRA-6904</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12775414" name="cassandra.yaml" size="38395" author="aweisberg" created="Wed, 2 Dec 2015 22:36:45 +0000"/>
                            <attachment id="12775415" name="commitlog_archiving.properties" size="2442" author="aweisberg" created="Wed, 2 Dec 2015 22:36:45 +0000"/>
                            <attachment id="12775416" name="system.log" size="122629" author="aweisberg" created="Wed, 2 Dec 2015 22:36:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nj87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332984">2.1.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>