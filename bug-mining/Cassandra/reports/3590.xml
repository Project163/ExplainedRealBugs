<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9478] SSTables are not always properly marked suspected</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9478</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There is 2 problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;During compaction, &lt;tt&gt;SSTableIdentityIterator&lt;/tt&gt; doesn&apos;t always mark sstables suspect (nor always throws &lt;tt&gt;CorruptSSTableException&lt;/tt&gt; in 2.0) This affects versions at least since 2.0 and up to trunk.&lt;/li&gt;
	&lt;li&gt;Since 2.1, with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-916&quot; title=&quot;StreamingServiceMBean doesn&amp;#39;t update status when a node is receiving stream data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-916&quot;&gt;&lt;del&gt;CASSANDRA-916&lt;/del&gt;&lt;/a&gt;, &lt;tt&gt;SSTableReader.cloneWithNewStart&lt;/tt&gt; doesn&apos;t preserve the isSuspect flag. This a problem because when a &lt;tt&gt;CorruptSSTableException&lt;/tt&gt; is thrown, the &lt;tt&gt;SSTableRewriter&lt;/tt&gt; is aborted, which replace &lt;tt&gt;SSTableReader&lt;/tt&gt; by a clone of themselves and for the sstables that have just been marked suspected this (wrongly) clears the flag.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The reason none of this has be caught so far is that the test that tests sstable blacklisting, &lt;tt&gt;BlacklistingCompactionsTest&lt;/tt&gt;, always corrupts the very beginning of sstables (the first 3 bytes). This conspire in hiding the 2 problems above because:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the &lt;tt&gt;CorruptSSTableException&lt;/tt&gt; is always thrown when we read the very first partition key, which is actually properly covered in &lt;tt&gt;SSTableIdentityIterator&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;due to &lt;tt&gt;MergeIterator&lt;/tt&gt; greediness, the exception is throw in &lt;tt&gt;CompactionTask.runMayThrow&lt;/tt&gt; on the creation of the iterator (on &lt;tt&gt;Iterator&amp;lt;AbstractCompactedRow&amp;gt; iter = ci.iterator()&lt;/tt&gt;), which is before the &lt;tt&gt;SSTableRewriter&lt;/tt&gt; is even created, and so it&apos;s not aborted (and the suspected flag is not cleared).&lt;br/&gt;
I&apos;ve made some simple changes to &lt;tt&gt;BlacklistingCompactionsTest&lt;/tt&gt; so it corrupts files a little bit more randomly. At least on 2.1, the updated test pretty reliably find the 2 problems above. On 2.2/trunk however, this doesn&apos;t find the 2nd one because since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8568&quot; title=&quot;Extend Transactional API to sstable lifecycle management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8568&quot;&gt;&lt;del&gt;CASSANDRA-8568&lt;/del&gt;&lt;/a&gt;, &lt;tt&gt;SSTableRewriter.doAbort&lt;/tt&gt; do nothing if no early opening was actually perform, which will be the case in the test. We would need a fancier test that ensure the corruption is far enough in the file that some early opening has been done when it&apos;s thrown. But I don&apos;t have time for writing that test right now so I&apos;m gonna push that to a follow-up ticket.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12832676">CASSANDRA-9478</key>
            <summary>SSTables are not always properly marked suspected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 May 2015 09:22:54 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:09 +0000</updated>
                            <resolved>Tue, 2 Jun 2015 13:29:15 +0000</resolved>
                                        <fixVersion>2.0.16</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                    <fixVersion>2.2.0 rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14558918" author="slebresne" created="Tue, 26 May 2015 09:30:01 +0000"  >&lt;p&gt;I&apos;ve pushed patches for these for &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9478-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9478-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; and &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9478-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; (the 2.2 patch applies cleanly to trunk). CI for those branches should be available &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/pcmanus/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; soonish.&lt;/p&gt;</comment>
                            <comment id="14567499" author="benedict" created="Mon, 1 Jun 2015 16:11:57 +0000"  >&lt;p&gt;One nit: should just use &lt;tt&gt;replacement.isSuspect.set()&lt;/tt&gt;, not &lt;tt&gt;replacement.isSuspect.getAndSet()&lt;/tt&gt;  (this latter involves an atomic operation unnecessarily). In fact we could happily use &lt;tt&gt;lazySet&lt;/tt&gt;, but that&apos;s not so important.&lt;/p&gt;

&lt;p&gt;We could also switch the early open interval and ColumnIndex size very low, so that during BlacklistingCompactionTest it&apos;s more likely to have happened at some point in 2.2 (and so we would at least hopefully get an intermittent failure).&lt;/p&gt;</comment>
                            <comment id="14569093" author="slebresne" created="Tue, 2 Jun 2015 13:29:15 +0000"  >&lt;p&gt;Committed with the nit fixed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We could also switch the early open interval and ColumnIndex size very low&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes. Though the open interval is in MB so we need quite a bit bigger sstables and when I tried that I ran into &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9530&quot; title=&quot;SSTable corruption can trigger OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9530&quot;&gt;&lt;del&gt;CASSANDRA-9530&lt;/del&gt;&lt;/a&gt;. And since I don&apos;t want to spend too much time on that test right now (nor rush the changes and end up with a test that doesn&apos;t test what I think it does), I&apos;ll push improving &lt;tt&gt;BlacklistingCompactionTest&lt;/tt&gt; to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9530&quot; title=&quot;SSTable corruption can trigger OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9530&quot;&gt;&lt;del&gt;CASSANDRA-9530&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12781460">CASSANDRA-8960</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2f6yv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>