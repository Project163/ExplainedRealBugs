<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:41:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6275] 2.0.x leaks file handles</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6275</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Looks like C* is leaking file descriptors when doing lots of CAS operations.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ sudo cat /proc/15455/limits
Limit                     Soft Limit           Hard Limit           Units    
Max cpu time              unlimited            unlimited            seconds  
Max file size             unlimited            unlimited            bytes    
Max data size             unlimited            unlimited            bytes    
Max stack size            10485760             unlimited            bytes    
Max core file size        0                    0                    bytes    
Max resident set          unlimited            unlimited            bytes    
Max processes             1024                 unlimited            processes
Max open files            4096                 4096                 files    
Max locked memory         unlimited            unlimited            bytes    
Max address space         unlimited            unlimited            bytes    
Max file locks            unlimited            unlimited            locks    
Max pending signals       14633                14633                signals  
Max msgqueue size         819200               819200               bytes    
Max nice priority         0                    0                   
Max realtime priority     0                    0                   
Max realtime timeout      unlimited            unlimited            us 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like the problem is not in limits.&lt;/p&gt;

&lt;p&gt;Before load test:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cassandra-test0 ~]$ lsof -n | grep java | wc -l
166

cassandra-test1 ~]$ lsof -n | grep java | wc -l
164

cassandra-test2 ~]$ lsof -n | grep java | wc -l
180
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After load test:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cassandra-test0 ~]$ lsof -n | grep java | wc -l
967

cassandra-test1 ~]$ lsof -n | grep java | wc -l
1766

cassandra-test2 ~]$ lsof -n | grep java | wc -l
2578
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Most opened files have names like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java      16890 cassandra 1636r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1637r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1638r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1639r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1640r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1641r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1642r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1643r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1644r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1645r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1646r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1647r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1648r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1649r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1650r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1651r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1652r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1653r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1654r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
java      16890 cassandra 1655r      REG             202,17 161158485     655420 /var/lib/cassandra/data/system/paxos/system-paxos-jb-255-Data.db
java      16890 cassandra 1656r      REG             202,17  88724987     655520 /var/lib/cassandra/data/system/paxos/system-paxos-jb-644-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, when that happens it&apos;s not always possible to shutdown server process via SIGTERM. Have to use SIGKILL.&lt;/p&gt;

&lt;p&gt;p.s. See mailing thread for more context information &lt;a href=&quot;https://www.mail-archive.com/user@cassandra.apache.org/msg33035.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.mail-archive.com/user@cassandra.apache.org/msg33035.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;java version &quot;1.7.0_25&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_25-b15)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 23.25-b01, mixed mode)&lt;br/&gt;
Linux cassandra-test1 2.6.32-279.el6.x86_64 #1 SMP Thu Jun 21 15:00:18 EDT 2012 x86_64 x86_64 x86_64 GNU/Linux&lt;/p&gt;</environment>
        <key id="12676842">CASSANDRA-6275</key>
            <summary>2.0.x leaks file handles</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="graham.sanderson">graham sanderson</assignee>
                                    <reporter username="ash2k">Mikhail Mazursky</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Oct 2013 11:14:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:01 +0000</updated>
                            <resolved>Wed, 20 Nov 2013 16:53:46 +0000</resolved>
                                        <fixVersion>2.0.3</fixVersion>
                                        <due></due>
                            <votes>6</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="13810143" author="ash2k" created="Thu, 31 Oct 2013 11:16:15 +0000"  >&lt;p&gt;Attaching thread dump of process when it is not possible to shutdown it cleanly.&lt;/p&gt;</comment>
                            <comment id="13810180" author="brandon.williams" created="Thu, 31 Oct 2013 12:03:49 +0000"  >&lt;p&gt;This does look rather damning, and I know &lt;em&gt;something&lt;/em&gt; is up here because we can&apos;t run 2.0 with ccm on debug, so maybe this is it.&lt;/p&gt;</comment>
                            <comment id="13810358" author="baldrick" created="Thu, 31 Oct 2013 15:49:34 +0000"  >&lt;p&gt;Part of system.log showing lots of memtable flush messages.&lt;/p&gt;</comment>
                            <comment id="13810360" author="baldrick" created="Thu, 31 Oct 2013 15:50:18 +0000"  >&lt;p&gt;We had to downgrade from 2.0.2 to 1.2.11 due to C* leaking vast numbers of file descriptors (same issue in 2.0.1), approximately 50 a second.  We didn&apos;t have any trouble shutting down servers, we also were &lt;b&gt;not&lt;/b&gt; using Paxos, so might be a different issue.  Like in this report, the same sstable files had been opened again and again (and again) only they were from one of our own column families, not from a system column family.  This table was being polled repeatedly (once per second per program) by about 20 programs using the native protocol; the polling was doing a range slice.  I haven&apos;t been able to reproduce the file descriptor leak in our test environment.&lt;/p&gt;

&lt;p&gt;One thing I noticed is that the system logs were chock-a-block with memtable flushing messages, many many more than we would get with 1.2.11 (I&apos;ve attached a snippet).&lt;/p&gt;</comment>
                            <comment id="13810590" author="mishail" created="Thu, 31 Oct 2013 19:29:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, when that happens it&apos;s not always possible to shutdown server process via SIGTERM. Have to use SIGKILL.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As far as I understand here &lt;b&gt;what&lt;/b&gt; is happening&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;SIGTERM handler&lt;/tt&gt; waits for &lt;tt&gt;StorageServiceShutdownHook&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;StorageServiceShutdownHook&lt;/tt&gt; waits (up to &lt;b&gt;3600 sec == 1hr&lt;/b&gt;) for &lt;tt&gt;mutationStage&lt;/tt&gt; threads to complete.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;&quot;MutationStage:2718&quot;&lt;/tt&gt; thread performs &lt;tt&gt;ColumnFamilyStore.forceBlockingFlush&lt;/tt&gt; initiated by &lt;tt&gt;TruncateVerbHandler.doVerb&lt;/tt&gt; and waits for &lt;tt&gt;&quot;MemtablePostFlusher:1&quot;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;&quot;MemtablePostFlusher:1&quot;&lt;/tt&gt; is waiting on &lt;tt&gt;CountDownLatch.await&lt;/tt&gt; (in &lt;tt&gt;WrappedRunnable&lt;/tt&gt; returned from &lt;tt&gt;ColumnFamilyStore.switchMemtable)&lt;/tt&gt;.  It will wait until the latch is counted down to zero.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There is also another call to &lt;tt&gt;ColumnFamilyStore.forceBlockingFlush&lt;/tt&gt; from &lt;tt&gt;&quot;OptionalTasks:1&quot;:BatchlogManager.cleanup()&lt;/tt&gt; . &lt;/p&gt;</comment>
                            <comment id="13810647" author="jbellis" created="Thu, 31 Oct 2013 20:10:48 +0000"  >&lt;p&gt;Hmm.  It&apos;s possible that we shouldn&apos;t be running Truncate on the Mutation stage.  But, I don&apos;t think Duncan or Mikhail mentioned running truncate so there is probably something else wrong as well.&lt;/p&gt;</comment>
                            <comment id="13810664" author="mishail" created="Thu, 31 Oct 2013 20:34:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; still there is &lt;tt&gt;TruncateVerbHandler.doVerb&lt;/tt&gt; in Mikhail&apos;s &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12611371/12611371_cassandra_jstack.txt&quot; title=&quot;cassandra_jstack.txt attached to CASSANDRA-6275&quot;&gt;cassandra_jstack.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13810674" author="brandon.williams" created="Thu, 31 Oct 2013 20:42:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=baldrick&quot; class=&quot;user-hover&quot; rel=&quot;baldrick&quot;&gt;baldrick&lt;/a&gt; are you using the native protocol?&lt;/p&gt;</comment>
                            <comment id="13810714" author="baldrick" created="Thu, 31 Oct 2013 21:13:41 +0000"  >&lt;p&gt;Yes, I&apos;m using the native protocol.  No use of truncate on my part.&lt;/p&gt;</comment>
                            <comment id="13810735" author="jbellis" created="Thu, 31 Oct 2013 21:34:23 +0000"  >&lt;p&gt;Let&apos;s create a new ticket for the truncate hang then.&lt;/p&gt;</comment>
                            <comment id="13810995" author="ash2k" created="Fri, 1 Nov 2013 02:51:12 +0000"  >&lt;p&gt;My load test uses TRUNCATE before it starts. I will check if that leak happens without it.&lt;/p&gt;</comment>
                            <comment id="13811002" author="ash2k" created="Fri, 1 Nov 2013 03:14:28 +0000"  >&lt;p&gt;I tried without TRUNCATE - no leaking (test TRUNCATEs 3 tables before it starts).&lt;/p&gt;

&lt;p&gt;Before test:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[root@cassandra-test0 ~]$ lsof -n | grep java | wc -l
169

[root@cassandra-test1 ~]$ lsof -n | grep java | wc -l
167

[root@cassandra-test2 ~]# lsof -n | grep java | wc -l
173
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After test:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[root@cassandra-test0 ~]$ lsof -n | grep java | wc -l
172

[root@cassandra-test1 ~]$ lsof -n | grep java | wc -l
172

[root@cassandra-test2 ~]# lsof -n | grep java | wc -l
183
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13811112" author="baldrick" created="Fri, 1 Nov 2013 08:30:22 +0000"  >&lt;p&gt;In my case I didn&apos;t use truncate, however I did do one exotic operation: I used alter table to drop a no longer needed column a few days before I noticed this issue.&lt;/p&gt;

&lt;p&gt;Before downgrading I made a copy of the entire contents of /var/lib/cassandra/, so I could try recreating the 2.0.2 cluster and the problem in some virtual machines using these.&lt;/p&gt;</comment>
                            <comment id="13811114" author="baldrick" created="Fri, 1 Nov 2013 08:34:51 +0000"  >&lt;p&gt;I also changed sstable_compression from SnappyCompressor to LZ4Compressor.&lt;/p&gt;</comment>
                            <comment id="13819144" author="gianlucaborello" created="Mon, 11 Nov 2013 17:34:03 +0000"  >&lt;p&gt;We are experiencing a similar issue in 2.0.2.&lt;/p&gt;

&lt;p&gt;It started happening after we set a TTL for all our columns in a very limited datastore (just a few GBs).&lt;/p&gt;

&lt;p&gt;We can easily see the fd count rapidly increase to 100000+, and the majority of fds are (from lsof):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java      13168       cassandra  267r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
java      13168       cassandra  268r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
java      13168       cassandra  269r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
java      13168       cassandra  270r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
java      13168       cassandra  271r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
java      13168       cassandra  272r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
java      13168       cassandra  273r      REG                9,0   273129  671089723 /raid0/cassandra/data/draios/process_counters_by_exe/draios-process_counters_by_exe-jb-231-Data.db (deleted)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m attaching the log of the exception (leak.log). You can see the exceptions, and then Cassandra eventually shuts down. We had to temporarily downgrade to 1.2.11&lt;/p&gt;</comment>
                            <comment id="13819357" author="jbellis" created="Mon, 11 Nov 2013 20:45:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ash2k&quot; class=&quot;user-hover&quot; rel=&quot;ash2k&quot;&gt;ash2k&lt;/a&gt; or others, can you verify if this is also a problem in 1.2.11?&lt;/p&gt;</comment>
                            <comment id="13819363" author="gianlucaborello" created="Mon, 11 Nov 2013 20:49:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;, FWIW 1.2.11 is working fine for us (I have one week of uptime so far since the downgrade).&lt;/p&gt;</comment>
                            <comment id="13819376" author="jbellis" created="Mon, 11 Nov 2013 20:55:59 +0000"  >&lt;p&gt;Can you have a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="13819884" author="baldrick" created="Tue, 12 Nov 2013 06:51:24 +0000"  >&lt;p&gt;All our leaked fd&apos;s were for a large table that uses TTL.  We also don&apos;t have any problems with 1.2.11 (which we had to downgrade to, just like Gianluca).&lt;/p&gt;</comment>
                            <comment id="13819890" author="ash2k" created="Tue, 12 Nov 2013 07:14:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; my test workload uses LWT so it cannot be run on 1.2.x. The written columns themself do not use TTL but AFAIK Paxos table uses TTL. And in my case I see a lot of open Paxos-related files. So, taking into account what others said above, looks like the problem is somehow connected to TTL.&lt;/p&gt;</comment>
                            <comment id="13820376" author="krummas" created="Tue, 12 Nov 2013 19:30:05 +0000"  >&lt;p&gt;been looking at this a bit and can&apos;t really reproduce, suspected &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5228&quot; title=&quot;Track maximum ttl and use to expire entire sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5228&quot;&gt;&lt;del&gt;CASSANDRA-5228&lt;/del&gt;&lt;/a&gt; - but that seems to work (or, found a bug, but unrelated to this, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6337&quot; title=&quot;Set minTimestamp correctly to be able to drop expired sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6337&quot;&gt;&lt;del&gt;CASSANDRA-6337&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;slog.gz looks a bit like what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman&quot; class=&quot;user-hover&quot; rel=&quot;mkjellman&quot;&gt;mkjellman&lt;/a&gt; reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5241&quot; title=&quot;Fix forceBlockingFlush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5241&quot;&gt;&lt;del&gt;CASSANDRA-5241&lt;/del&gt;&lt;/a&gt; (looping flushing of system tables) but that was resolved a long time ago.&lt;/p&gt;

&lt;p&gt;does anyone have a way to reproduce? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ash2k&quot; class=&quot;user-hover&quot; rel=&quot;ash2k&quot;&gt;ash2k&lt;/a&gt; would it be possible to post your load test?&lt;/p&gt;</comment>
                            <comment id="13820839" author="rcoli" created="Wed, 13 Nov 2013 02:11:22 +0000"  >&lt;p&gt;A brief note to mention that when durable_writes are disabled, handling of clean shutdown (via SIGTERM/StorageServiceShutdownHook) has additional blocking while waiting for drain. If one is investigating and/or modifying the behavior of the shutdown hook, they should be aware that there are two different cases to test. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2958&quot; title=&quot;Flush memtables on shutdown when durable writes are disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2958&quot;&gt;&lt;del&gt;CASSANDRA-2958&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13820875" author="ash2k" created="Wed, 13 Nov 2013 03:01:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; sorry, I cannot post that code. The scenario is something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;TRUNCATE table1;
TRUNCATE table2;
TRUNCATE table3;
loop {
    SELECT FROM table1 WHERE key=&lt;span class=&quot;code-quote&quot;&gt;&apos;xxx&apos;&lt;/span&gt; (quorum);
    INSERT INTO table2 (quorum);
    INSERT INTO table3 IF NOT EXISTS; (should sometimes fail)
    UPDATE table1 WHERE  key = &lt;span class=&quot;code-quote&quot;&gt;&apos;someid&apos;&lt;/span&gt; IF column=&lt;span class=&quot;code-quote&quot;&gt;&apos;zzz&apos;&lt;/span&gt;; (should sometimes fail)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As I said, if I remove TRUNCATEs it do not leak.&lt;/p&gt;</comment>
                            <comment id="13821328" author="baldrick" created="Wed, 13 Nov 2013 13:30:48 +0000"  >&lt;p&gt;OK, here is how you can reproduce.&lt;/p&gt;

&lt;p&gt;1) Create this keyspace:&lt;/p&gt;

&lt;p&gt;CREATE KEYSPACE all_production WITH replication = &lt;/p&gt;
{&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: 1}
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;2) Create a table as follows:&lt;/p&gt;

&lt;p&gt;use all_production;&lt;br/&gt;
CREATE TABLE position_hints (shard int, date text, when timeuuid, sequence bigint, syd int, broker uuid, engine uuid, confirmed bigint, open_buy bigint, open_sell bigint, PRIMARY KEY ((shard, date), when)) with clustering order by (when desc);&lt;/p&gt;

&lt;p&gt;3) Stop Cassandra.  Untar the attached file in /var/lib/cassandra/data/all_production/ to populate the position_hints table.&lt;/p&gt;

&lt;p&gt;4) Start Cassandra.&lt;/p&gt;

&lt;p&gt;5) Prepare a large number of queries as follows:&lt;/p&gt;

&lt;p&gt;for (( i = 0 ; i &amp;lt; 1000000 ; i = i + 1 )) ; do echo &quot;select * from position_hints where shard=1 and date=&apos;2013-10-30&apos; and when&amp;gt;ba719c52-4182-11e3-a471-003048feded4 limit 1;&quot; ; done &amp;gt; /tmp/queries&lt;/p&gt;

&lt;p&gt;6) In cqlsh:&lt;/p&gt;

&lt;p&gt;use all_production;&lt;br/&gt;
source &apos;/tmp/queries&apos;;&lt;/p&gt;

&lt;p&gt;7) Enjoy watching the number of fd&apos;s used by Cassandra go up and up.&lt;/p&gt;</comment>
                            <comment id="13821329" author="baldrick" created="Wed, 13 Nov 2013 13:32:16 +0000"  >&lt;p&gt;Untar this to populate the position_hints table.&lt;/p&gt;</comment>
                            <comment id="13821419" author="jbellis" created="Wed, 13 Nov 2013 15:28:25 +0000"  >&lt;p&gt;Can you reproduce the above on 2.0.2 or 2.0.2 HEAD, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13823106" author="mshuler" created="Thu, 14 Nov 2013 23:29:03 +0000"  >&lt;p&gt;Reproduced in 2.0.2.&lt;br/&gt;
On m1.medium, running C*, the open files were about 910.  My query is still running, and I&apos;m at &amp;gt;3500 open files.&lt;br/&gt;
(I&apos;ll work on cassandra-2.0 branch HEAD, next)&lt;/p&gt;</comment>
                            <comment id="13823171" author="mshuler" created="Fri, 15 Nov 2013 00:54:14 +0000"  >&lt;p&gt;Same results on cassandra-2.0 HEAD.&lt;/p&gt;</comment>
                            <comment id="13823197" author="mshuler" created="Fri, 15 Nov 2013 01:39:09 +0000"  >&lt;p&gt;c_file-descriptors_strace.tbz is a strace of the C* java process and children while running the query to about 27k open files.  This was on the cassandra-2.0 branch in git.&lt;/p&gt;</comment>
                            <comment id="13823796" author="krummas" created="Fri, 15 Nov 2013 16:49:19 +0000"  >&lt;p&gt;ok, this is what i have so far, i can also reproduce on an m1.medium in EC2, ubuntu 13.10 which has 3.11.x kernel.&lt;/p&gt;

&lt;p&gt;i cannot reproduce on my laptop (debian squeeze) or my server (rhel 6), both run kernel 2.6.x. (jdk7u45 on all)&lt;/p&gt;

&lt;p&gt;it happens with trivial tables/data as well, so seems unrelated to TTL or truncate etc&lt;/p&gt;

&lt;p&gt;just starting cassandra up shows ~50 open FDs for the same Data.db-file&lt;/p&gt;</comment>
                            <comment id="13823805" author="baldrick" created="Fri, 15 Nov 2013 16:55:15 +0000"  >&lt;p&gt;I originally saw the issue on Ubuntu 10.04 (kernel 2.6.32) and reproduced it on Ubuntu 13.10 (kernel 3.11.0).&lt;/p&gt;</comment>
                            <comment id="13823806" author="pieterc" created="Fri, 15 Nov 2013 16:56:37 +0000"  >&lt;p&gt;I also have the problem on Ubuntu 12.04 (Linux de-cass00 3.8.0-30-generic #44~precise1-Ubuntu SMP Fri Aug 23 18:32:41 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux)&lt;/p&gt;

&lt;p&gt;Posted something om mailing list because I was not sure if it was a bug... (Here you can find more info, In some cases I hade a deleted file more than 50k times open)&lt;br/&gt;
&lt;a href=&quot;http://www.mail-archive.com/user@cassandra.apache.org/msg32999.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@cassandra.apache.org/msg32999.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Temporary fix was to raise the nofile limit to 1kk...&lt;/p&gt;</comment>
                            <comment id="13823814" author="mshuler" created="Fri, 15 Nov 2013 17:03:06 +0000"  >&lt;p&gt;My tests were on Ubuntu precise, same kernel as above, with JVM version 1.7_25.&lt;/p&gt;</comment>
                            <comment id="13825856" author="jre" created="Mon, 18 Nov 2013 22:24:57 +0000"  >&lt;p&gt;We recently ran into this issue after upgrading to OpsCenter-4.0.0, it is quite easy to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Install Cassandra-2.0.2&lt;/li&gt;
	&lt;li&gt;Install OpsCenter-4.0.0 on above cluster.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I upgraded OpsCenter on Friday, and by Sunday I had reached 1 Million open file handles.  I had to kill -9 the Cassandra processes as it wouldn&apos;t respond to sockets, DSC20 restart scripts reported successfully killing the processes but in fact did not.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[root@cassandra2 ~]# lsof -u cassandra|wc -l
175416
[root@cassandra2 ~]# lsof -u cassandra|grep -c OpsCenter
174474
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Most of the handles show as &quot;deleted&quot;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[root@cassandra2 ~]# lsof -u cassandra|grep -c deleted
174449
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13825892" author="graham sanderson" created="Mon, 18 Nov 2013 22:52:52 +0000"  >&lt;p&gt;Note also, that most if not all of the deleted files are of the form&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java    14018 cassandra  586r   REG               8,33   8792499       1251 /data/1/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-4656-Data.db (deleted)
java    14018 cassandra  587r   REG               8,33  27303760       1254 /data/1/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-4655-Data.db (deleted)
java    14018 cassandra  588r   REG               8,33   8792499       1251 /data/1/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-4656-Data.db (deleted)
java    14018 cassandra  589r   REG               8,33  27303760       1254 /data/1/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-4655-Data.db (deleted)
java    14018 cassandra  590r   REG               8,33  10507214        936 /data/1/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-4657-Data.db (deleted)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We have 7 data disks per node (don&apos;t know if this contributes to the problem), and the number of such (open but) deleted files is very ill balanced with 93% on two of the 7 disks (on this particular node)... the distribution of live data file size for OpsCenter/rollups60 is a little uneven with the same data mounts that have more deleted files having more actual live data, but the deleted file counts per mount point vary by several order of magnitudes whereas the data size itself does not.&lt;/p&gt;</comment>
                            <comment id="13826531" author="jbellis" created="Tue, 19 Nov 2013 14:00:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt; Can you reproduce in 1.2?  How about 2.0.0?&lt;/p&gt;

&lt;p&gt;If in the latter but not the former it&apos;s going to be a bitch to bisect but I don&apos;t have any better ideas.&lt;/p&gt;</comment>
                            <comment id="13826633" author="capncrunch4me" created="Tue, 19 Nov 2013 16:04:17 +0000"  >&lt;p&gt;Environment Centos 6.4 ~ Kernel 3.10 (elrepo) ~ Cassandra 2.0.2 ~ Opscenter 4.0.&lt;/p&gt;

&lt;p&gt;Noted that Opscenter extremely exacerbates the issue, as the roll-up CFs cause open files to grow at an incredible pace. Turning Opscenter off causes rate to slow and/or stop. After stopping opscenter, the opscenter open files on all C* nodes never release although the open files dont continue to grow.&lt;/p&gt;

&lt;p&gt;There are 10&apos;s of thousands of these open:&lt;/p&gt;

&lt;p&gt;/data/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-15491-Data.db (deleted)&lt;br/&gt;
/data/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-15491-Data.db (deleted)&lt;br/&gt;
/data/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-15491-Data.db (deleted)&lt;br/&gt;
/data/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-15491-Data.db (deleted)&lt;/p&gt;

&lt;p&gt;A restart of cassandra and keeping opscenter off will keep file descriptors within a comfortable range. &lt;/p&gt;
</comment>
                            <comment id="13826912" author="graham sanderson" created="Tue, 19 Nov 2013 20:37:44 +0000"  >&lt;p&gt;Yes I believe we can mitigate the problem in the OpCenter case, however it is a good test bed since it makes the problem easy to spot - note it seems to be worse under high read/write activity on tracked keyspaces/CFs, however that makes sense.&lt;/p&gt;

&lt;p&gt;Note I was poking (somewhat blindly) thru the (2.0.2) code (partly out of interest) looking for what might be leaking these file handles, and I also took a heap dump. I discovered what turned out to be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6358&quot; title=&quot;SSTable read meter sync not cancelled when reader is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6358&quot;&gt;&lt;del&gt;CASSANDRA-6358&lt;/del&gt;&lt;/a&gt; which leaks FileDescriptors though their refCounts all seemed to be 0. In any case there weren&apos;t enough (total FileDescriptors - in the heap dump) to account for the problem. They were also for mem-mapped files (the ifile in SSTableReader) and none of the leaked deleted file handles were mem-mapped (since they were compressed data files)&lt;/p&gt;

&lt;p&gt;That said &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6358&quot; title=&quot;SSTable read meter sync not cancelled when reader is closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6358&quot;&gt;&lt;del&gt;CASSANDRA-6358&lt;/del&gt;&lt;/a&gt; was pinning the SSTableReaders in memory (since the Runnable was an anonymous inner class), so someone with more knowledge of the code might have a better idea if this might be a problem (other than the memory leak)&lt;/p&gt;

&lt;p&gt;I don&apos;t have an environment yet where I can easily build and install code changes, though we could downgrade our system test environment to 2.0.0 to see if we can reproduce the problem there - unsure if we can downgrade to 1.2.X easily given our current testing.&lt;/p&gt;

&lt;p&gt;Note while I was looking at the code I came across &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5555&quot; title=&quot;Allow sstableloader to handle a larger number of files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5555&quot;&gt;&lt;del&gt;CASSANDRA-5555&lt;/del&gt;&lt;/a&gt;... What caught my eye was the interaction between FileCacheService and RAR.deallocate, but more specifically related to the fact that this change, added a concurrent structure inside another separate concurrent structure, and it seemed like there might be a case where a RAR was recycled into a concurrent queue that was already removed and drained, in which case it would get GCed without close, presumably causing a file handle leak on the native side. Though I couldn&apos;t come up with any significantly convincing interactions that would cause this to happen without some very very unlucky things happening (and my knowledge of the google cache implementation was even more limited!), so this is unlikely the cause of this issue (especially if the issue doesn&apos;t happen in the 1.2.7+ branch), because I think nearly all deleted data files are being leakd, and finally because there is no particular correlation with TTL.&lt;/p&gt;</comment>
                            <comment id="13826938" author="mishail" created="Tue, 19 Nov 2013 21:08:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;What caught my eye was the interaction between FileCacheService and RAR.deallocate, but more specifically related to the fact that this change, added a concurrent structure inside another separate concurrent structure, and it seemed like there might be a case where a RAR was recycled into a concurrent queue that was already removed and drained, in which case it would get GCed without close, presumably causing a file handle leak on the native side&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I might be wrong, but what are you saying correlates with observations from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6283&quot; title=&quot;Windows 7 data files kept open / can&amp;#39;t be deleted after compaction.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6283&quot;&gt;&lt;del&gt;CASSANDRA-6283&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andie78&quot; class=&quot;user-hover&quot; rel=&quot;Andie78&quot;&gt;Andie78&lt;/a&gt; experiminted and &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;found out, that a finalizer fixes the problem. So after GC the files will be deleted (not optimal, but working fine). It runs now 2 days continously without problem. Possible fix/test:I wrote the following finalizer at the end of class org.apache.cassandra.io.util.RandomAccessReader: { deallocate(); super.finalize(); } }&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13826955" author="mishail" created="Tue, 19 Nov 2013 21:23:59 +0000"  >&lt;p&gt;I wonder what would happen with {{file_cache_size_in_mb: 0 }}. RAR should be explicitly deallocated then.&lt;/p&gt;</comment>
                            <comment id="13827120" author="graham sanderson" created="Tue, 19 Nov 2013 23:50:53 +0000"  >&lt;p&gt;Trying that now (one node with that setting)&lt;/p&gt;</comment>
                            <comment id="13827162" author="jre" created="Wed, 20 Nov 2013 00:16:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mishail&quot; class=&quot;user-hover&quot; rel=&quot;mishail&quot;&gt;mishail&lt;/a&gt; We (Graham Sanderson and I work together) added &apos;file_cache_size_in_mb: 0&apos; to cassandra.yaml on one of the nodes, and restarted that node plus another with the default (unspecified) file_cache_size_in_mb setting to run an A/B test.  Both nodes still leak file handles, however, the node with the default setting leaks much faster (about 3-4x the leak rate).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6283&quot; title=&quot;Windows 7 data files kept open / can&amp;#39;t be deleted after compaction.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6283&quot;&gt;&lt;del&gt;CASSANDRA-6283&lt;/del&gt;&lt;/a&gt; appears to be an exact duplicate of this problem, Windows and Linux JVMs appear to exhibit the exact same file handle leak behavior.&lt;/p&gt;</comment>
                            <comment id="13827173" author="graham sanderson" created="Wed, 20 Nov 2013 00:25:49 +0000"  >&lt;p&gt;Note that this would tend to imply that I was wrong (at least about the particular code path), and the change in leak rate may be attributable to less throughput without the file cache. Note the leak rate does seem quite related to how hard we are hitting the server as mentioned before, so a threading bug elsewhere might be the cause.&lt;/p&gt;

&lt;p&gt;Note nominally buffer in RAR should be volatile, but then any code path thru close where buffer&apos;s latest value is stale would end up calling deallocate anyway (at least in the case that file_cache_size_in_mb is off; I didn&apos;t think through the other case.&lt;/p&gt;

&lt;p&gt;So given the finalizer fix - which we can try and build here to test out (unless someone has it pre-built) - seems to imply that it is just someone failing to call close() under load conditions.&lt;/p&gt;</comment>
                            <comment id="13827305" author="graham sanderson" created="Wed, 20 Nov 2013 04:00:58 +0000"  >&lt;p&gt;We were able to confirm the finalizer fix stopped the leak&lt;/p&gt;</comment>
                            <comment id="13827308" author="graham sanderson" created="Wed, 20 Nov 2013 04:09:32 +0000"  >&lt;p&gt;Note I believe the problem is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5514&quot; title=&quot;Track min/max clustered values per sstable to optimize reads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5514&quot;&gt;&lt;del&gt;CASSANDRA-5514&lt;/del&gt;&lt;/a&gt; (2.0 beta 1)&lt;/p&gt;

&lt;p&gt;I don&apos;t have a patch because I don&apos;t know the exact patch for reasons below&lt;/p&gt;

&lt;p&gt;Here is CollationController.java starting at line 264: (as of current 2.0 branch and 2.0.2)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row tombstone in the skipped sstables
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (skippedSSTables != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SSTableReader sstable : skippedSSTables)
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sstable.getMaxTimestamp() &amp;lt;= minTimestamp)
                        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;

                    sstable.incrementReadCount();
                    OnDiskAtomIterator iter = filter.getSSTableColumnIterator(sstable);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iter.getColumnFamily() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;

                    ColumnFamily cf = iter.getColumnFamily();
                    &lt;span class=&quot;code-comment&quot;&gt;// we are only interested in row-level tombstones here, and only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; markedForDeleteAt is larger than minTimestamp
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cf.deletionInfo().getTopLevelDeletion().markedForDeleteAt &amp;gt; minTimestamp)
                    {
                        includedDueToTombstones++;
                        iterators.add(iter);
                        returnCF.delete(cf.deletionInfo().getTopLevelDeletion());
                        sstablesIterated++;
                    }
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note if the last &quot;if&quot; test does not succeed, then &quot;iter&quot; is neither closed, nor is it added to the &quot;iterators&quot; list to be closed in the finally section at the end - it would have been easy for me to add it always to &quot;iterators&quot; list except that &quot;iterators&quot; is referenced lower in the function:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iterators.isEmpty())
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

            Tracing.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Merging data from memtables and {} sstables&quot;&lt;/span&gt;, sstablesIterated);
            filter.collateOnDiskAtom(returnCF, iterators, gcBefore);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Being new to the code, I cannot say whether it should be in &quot;iterators&quot; at that point, or just have been closed (quietly) above&lt;/p&gt;</comment>
                            <comment id="13827322" author="graham sanderson" created="Wed, 20 Nov 2013 04:32:13 +0000"  >&lt;p&gt;Also note stack trace for all leaked files we saw - someone can perhaps use this to help figure out what this actually affects (i.e. some of the iter&apos;s RARs may have been owned by someone else in which case AOK)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Finalizer] 2013-11-20 03:43:42,129 RandomAccessReader.java (line 399) LEAK finalizer had to clean up
java.lang.Exception: RAR &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /data/5/cassandra/OpsCenter/rollups60/OpsCenter-rollups60-jb-6882-Data.db allocated
	at org.apache.cassandra.io.util.RandomAccessReader.&amp;lt;init&amp;gt;(RandomAccessReader.java:66)
	at org.apache.cassandra.io.compress.CompressedRandomAccessReader.&amp;lt;init&amp;gt;(CompressedRandomAccessReader.java:76)
	at org.apache.cassandra.io.compress.CompressedRandomAccessReader.open(CompressedRandomAccessReader.java:43)
	at org.apache.cassandra.io.util.CompressedPoolingSegmentedFile.createReader(CompressedPoolingSegmentedFile.java:48)
	at org.apache.cassandra.io.util.PoolingSegmentedFile.getSegment(PoolingSegmentedFile.java:39)
	at org.apache.cassandra.io.sstable.SSTableReader.getFileDataInput(SSTableReader.java:1182)
	at org.apache.cassandra.db.columniterator.IndexedSliceReader.setToRowStart(IndexedSliceReader.java:108)
	at org.apache.cassandra.db.columniterator.IndexedSliceReader.&amp;lt;init&amp;gt;(IndexedSliceReader.java:84)
	at org.apache.cassandra.db.columniterator.SSTableSliceIterator.createReader(SSTableSliceIterator.java:65)
	at org.apache.cassandra.db.columniterator.SSTableSliceIterator.&amp;lt;init&amp;gt;(SSTableSliceIterator.java:42)
	at org.apache.cassandra.db.filter.SliceQueryFilter.getSSTableColumnIterator(SliceQueryFilter.java:167)
	at org.apache.cassandra.db.filter.QueryFilter.getSSTableColumnIterator(QueryFilter.java:62)
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:273)
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:53)
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1467)
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1286)
	at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:332)
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)
	at org.apache.cassandra.db.ReadVerbHandler.doVerb(ReadVerbHandler.java:47)
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13827342" author="jbellis" created="Wed, 20 Nov 2013 05:07:53 +0000"  >&lt;p&gt;Nailed it.  (It should be closed.)  Patch attached.&lt;/p&gt;</comment>
                            <comment id="13827371" author="jre" created="Wed, 20 Nov 2013 05:47:08 +0000"  >&lt;p&gt;I accidentally hit the &quot;Testing&quot; button, and don&apos;t see a way to revert.  I&apos;ve build cassandra-2.0.2 with just this patch applied, and we are testing it now, but I didn&apos;t mean to change the status.&lt;/p&gt;</comment>
                            <comment id="13827606" author="jbellis" created="Wed, 20 Nov 2013 12:42:46 +0000"  >&lt;p&gt;(Reject takes it back to Open.)&lt;/p&gt;</comment>
                            <comment id="13827682" author="mshuler" created="Wed, 20 Nov 2013 14:19:21 +0000"  >&lt;p&gt;I will test this out this morning!&lt;/p&gt;</comment>
                            <comment id="13827705" author="jre" created="Wed, 20 Nov 2013 14:35:09 +0000"  >&lt;p&gt;So we&apos;ve been running this all night, have written a few hundred GB of data with some products we&apos;re developing, all the while OpsCenter 4.0.0 was doing TTL&apos;d rollups and what not.  Deleted file count remained at 1 the entire time, never increasing, and total file count remained below 1000.&lt;/p&gt;

&lt;p&gt;FYI, the single undeleted file looks like some temporary file randomly generated on Cassandra startup that gets deleted but not closed for the processes&apos; duration, example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java    1925 cassandra   44u   REG              253,4      4096         13 /tmp/ffi441Hpl (deleted)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13827723" author="brandon.williams" created="Wed, 20 Nov 2013 14:54:13 +0000"  >&lt;p&gt;That&apos;s probably JNA, or snappy.&lt;/p&gt;</comment>
                            <comment id="13827793" author="slebresne" created="Wed, 20 Nov 2013 16:04:25 +0000"  >&lt;p&gt;That patch lgtm, +1.&lt;/p&gt;</comment>
                            <comment id="13827802" author="mshuler" created="Wed, 20 Nov 2013 16:11:58 +0000"  >&lt;p&gt;Patch works for me, too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13827837" author="jbellis" created="Wed, 20 Nov 2013 16:53:46 +0000"  >&lt;p&gt;committed.  thanks everyone!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12680632">CASSANDRA-6392</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12614790" name="6275.txt" size="1461" author="jbellis" created="Wed, 20 Nov 2013 05:07:53 +0000"/>
                            <attachment id="12613994" name="c_file-descriptors_strace.tbz" size="6409982" author="mshuler" created="Fri, 15 Nov 2013 01:39:09 +0000"/>
                            <attachment id="12611371" name="cassandra_jstack.txt" size="38704" author="ash2k" created="Thu, 31 Oct 2013 11:16:15 +0000"/>
                            <attachment id="12613184" name="leak.log" size="9767" author="gianlucaborello" created="Mon, 11 Nov 2013 17:34:03 +0000"/>
                            <attachment id="12613598" name="position_hints.tgz" size="6327983" author="baldrick" created="Wed, 13 Nov 2013 13:32:16 +0000"/>
                            <attachment id="12611411" name="slog.gz" size="33896" author="baldrick" created="Thu, 31 Oct 2013 15:49:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[graham.sanderson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356218</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1perj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356506</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324542">2.0.1</customfieldvalue>
    <customfieldvalue id="12325023">2.0.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>