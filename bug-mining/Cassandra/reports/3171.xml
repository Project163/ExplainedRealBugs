<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7734] Schema pushes (seemingly) randomly not happening</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7734</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have been seeing problems since upgrade to 2.0.9 from 2.0.5.&lt;/p&gt;

&lt;p&gt;Basically after a while, new schema changes (we periodically add tables) start propagating very slowly to some nodes and fast to others. It looks from the logs and trace that in this case the &quot;push&quot; of the schema never happens (note a node has decided not to push to another node, it doesn&apos;t seem to start again) from the originating node to some of the other nodes. In this case though, we do see the other node end up pulling the schema some time later when it notices its schema is out of date.&lt;/p&gt;

&lt;p&gt;Here is code from 2.0.9 MigrationManager.announce&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InetAddress endpoint : Gossiper.instance.getLiveMembers())
        {
            &lt;span class=&quot;code-comment&quot;&gt;// only push schema to nodes with known and equal versions
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!endpoint.equals(FBUtilities.getBroadcastAddress()) &amp;amp;&amp;amp;
                    MessagingService.instance().knowsVersion(endpoint) &amp;amp;&amp;amp;
                    MessagingService.instance().getRawVersion(endpoint) == MessagingService.current_version)
                pushSchemaMutation(endpoint, schema);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and from 2.0.5&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InetAddress endpoint : Gossiper.instance.getLiveMembers())
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (endpoint.equals(FBUtilities.getBroadcastAddress()))
                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// we&apos;ve dealt with localhost already
&lt;/span&gt;
            &lt;span class=&quot;code-comment&quot;&gt;// don&apos;t send schema to the nodes with the versions older than current major
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (MessagingService.instance().getVersion(endpoint) &amp;lt; MessagingService.current_version)
                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;

            pushSchemaMutation(endpoint, schema);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the old getVersion() call would return MessagingService.current_version if the version was unknown, so the push would occur in this case. I don&apos;t have logging to prove this, but have strong suspicion that the version may end up null in some cases (which would have allowed schema propagation in 2.0.5, but not by somewhere after that and &amp;lt;= 2.0.9)&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12733119">CASSANDRA-7734</key>
            <summary>Schema pushes (seemingly) randomly not happening</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="graham sanderson">graham sanderson</reporter>
                        <labels>
                    </labels>
                <created>Sun, 10 Aug 2014 19:37:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:37 +0000</updated>
                            <resolved>Tue, 7 Oct 2014 15:46:27 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14092167" author="graham sanderson" created="Sun, 10 Aug 2014 19:44:21 +0000"  >&lt;p&gt;There seem to be a bunch of other related issues&lt;/p&gt;</comment>
                            <comment id="14092169" author="graham sanderson" created="Sun, 10 Aug 2014 19:53:21 +0000"  >&lt;p&gt;Note this is not a problem &lt;em&gt;during&lt;/em&gt; the upgrade; it is a problem after the upgrade with all nodes successfully on 2.0.9&lt;/p&gt;

&lt;p&gt;I&apos;m a bit confused from a technical perspective, so would welcome any comments from others who have been near this code: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m not sure the lifecycle of IncomingTcpConnection... but there is code there (close method)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;MessagingService.instance().resetVersion(from);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That unsets the (staticly scoped) version for an endpoint when closing... I would assume there could be overlapping connections for an endpoint, so this seems undesirable?&lt;/p&gt;

&lt;p&gt;Also&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;MessagingService.instance().knowsVersion(endpoint) &amp;amp;&amp;amp;
MessagingService.instance().getRawVersion(endpoint) == MessagingService.current_version)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since the endpoint-&amp;gt;version mapping is static global and concurrent, we shouldn&apos;t be checking it twice&lt;/p&gt;

&lt;p&gt;Also &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6700&quot; title=&quot;Use real node messaging versions for schema exchange decisions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6700&quot;&gt;&lt;del&gt;CASSANDRA-6700&lt;/del&gt;&lt;/a&gt; changes&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; knowsVersion(InetAddress endpoint)
     {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; versions.get(endpoint) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; versions.containsKey(endpoint);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However it is not clear that the map can ever contain a null value, and the getVersion() method still does the check the old way (versions.get(endpoint) != null)&lt;/p&gt;

&lt;p&gt;In any case, I&apos;m partly confused because I&apos;m not quite sure how this endpoint version tracking is supposed to work, and the current state seems to have evolved as a result of lots of different issues (I don&apos;t think I&apos;ve captured all of them here).&lt;/p&gt;</comment>
                            <comment id="14092174" author="graham sanderson" created="Sun, 10 Aug 2014 19:58:05 +0000"  >&lt;p&gt;I will add some logging to verify, but it seems to me (unless you are lucky) that IncomingTcpConnection.close() could easily unset the version number at some point.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t look like it would have had much effect on 2.0.5, but it certainly feels wrong now&lt;/p&gt;</comment>
                            <comment id="14093698" author="graham sanderson" created="Tue, 12 Aug 2014 03:59:01 +0000"  >&lt;p&gt;Note totality of related logging from 172.16.26.11 (the first node in a six node cluster)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;date
Tue Aug 12 05:56:52 CEST 2014
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grep &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log*
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-10] 2014-08-11 06:43:38,440 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-11] 2014-08-11 06:43:38,441 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-12] 2014-08-11 06:43:38,445 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.14
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-11] 2014-08-11 06:43:38,461 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-12] 2014-08-11 06:43:38,462 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.14
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-13] 2014-08-11 06:43:38,464 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.14
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-10] 2014-08-11 06:43:38,468 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-15] 2014-08-11 06:43:38,472 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-16] 2014-08-11 06:43:38,475 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19] 2014-08-11 06:43:38,538 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-20] 2014-08-11 06:43:38,591 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.15
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-20] 2014-08-11 06:43:38,618 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.15
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-21] 2014-08-11 06:43:38,621 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.15
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19] 2014-08-11 06:43:39,221 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-23] 2014-08-11 06:43:39,225 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-24] 2014-08-11 06:51:55,694 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-37] 2014-08-11 06:53:26,679 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-37] 2014-08-11 06:53:26,836 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-38] 2014-08-11 06:53:26,839 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.12
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-16] 2014-08-11 06:54:28,603 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-43] 2014-08-11 06:55:41,762 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-43] 2014-08-11 06:55:41,833 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-44] 2014-08-11 06:55:41,843 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.13
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-14] 2014-08-11 06:57:32,128 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.14
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-49] 2014-08-11 06:58:35,688 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.14
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-21] 2014-08-11 07:00:01,122 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.15
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-53] 2014-08-11 07:01:01,692 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.15
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-15] 2014-08-11 07:01:26,955 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-57] 2014-08-11 07:02:48,342 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-57] 2014-08-11 07:02:48,637 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-58] 2014-08-11 07:02:48,641 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/log/cassandra/system.log:INFO  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-92] 2014-08-11 07:29:34,332 MessagingService.java (line 767) Updating version &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; -&amp;gt; 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.11
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thus far, there are periods (but not prolonged periods) where the version is null. That said, I don&apos;t think this endpoint-&amp;gt;version mapping acts the way the recent code updates expect&lt;/p&gt;</comment>
                            <comment id="14093701" author="graham sanderson" created="Tue, 12 Aug 2014 03:59:54 +0000"  >&lt;p&gt;Note my new logging only reports a change in the value&lt;/p&gt;</comment>
                            <comment id="14094061" author="iamaleksey" created="Tue, 12 Aug 2014 13:50:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=graham+sanderson&quot; class=&quot;user-hover&quot; rel=&quot;graham sanderson&quot;&gt;graham sanderson&lt;/a&gt; thanks for digging. This isn&apos;t being ignored - I will get to it soon-ish. Assigning to self, to not forget.&lt;/p&gt;</comment>
                            <comment id="14094604" author="graham sanderson" created="Tue, 12 Aug 2014 20:15:03 +0000"  >&lt;p&gt;Thanks, I appreciate that... we have patched our production 2.0.9 to use the old (as of 2.0.5) checking code for schema push for now (since we know we&apos;re not mixing major versions yet). I am off on vacation today, if I seem a little quiet from our end!&lt;/p&gt;</comment>
                            <comment id="14117613" author="graham sanderson" created="Mon, 1 Sep 2014 18:16:34 +0000"  >&lt;p&gt;Additional data point - while investigating 2 errors in production, I noticed that in each case the exception is next to a transition of the version to null. Note it is always the same thread and time, so it seems like it must be the same request&lt;/p&gt;

&lt;p&gt;e.g.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-46312] 2014-09-01 07:05:26,055 MessagingService.java (line 782) Reseting version 7 -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.16.26.16
ERROR [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-46312] 2014-09-01 07:05:26,055 CassandraDaemon.java (line 199) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-46312,5,main]
java.lang.NullPointerException
        at org.apache.cassandra.db.SliceByNamesReadCommandSerializer.deserialize(SliceByNamesReadCommand.java:150)
        at org.apache.cassandra.db.ReadCommandSerializer.deserialize(ReadCommand.java:175)
        at org.apache.cassandra.db.ReadCommandSerializer.deserialize(ReadCommand.java:134)
        at org.apache.cassandra.net.MessageIn.read(MessageIn.java:99)
        at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:153)
        at org.apache.cassandra.net.IncomingTcpConnection.handleModernVersion(IncomingTcpConnection.java:130)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14152041" author="graham sanderson" created="Mon, 29 Sep 2014 18:42:18 +0000"  >&lt;p&gt;Giving this a little nudge - I am happy to take a look, but I don&apos;t really understand what the intention is with the original code (i.e. lifecycle of &lt;tt&gt;IncomingTcpConnection&lt;/tt&gt;)&lt;/p&gt;</comment>
                            <comment id="14159120" author="iamaleksey" created="Sat, 4 Oct 2014 13:47:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;However it is not clear that the map can ever contain a null value, and the getVersion() method still does the check the old way (versions.get(endpoint) != null)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It can&apos;t have a null value - we only ever set it in MS#setVersion(), and it&apos;s always an int there (resetVersion() does remove()).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;That unsets the (staticly scoped) version for an endpoint when closing... I would assume there could be overlapping connections for an endpoint, so this seems undesirable?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There could be, and that&apos;s an issue. Maybe we simply shouldn&apos;t reset the versions at all on connections closing.&lt;/p&gt;</comment>
                            <comment id="14159178" author="iamaleksey" created="Sat, 4 Oct 2014 15:47:36 +0000"  >&lt;p&gt;Seems like removing the resetVersion() call from ITC#close() solves the issue.&lt;/p&gt;

&lt;p&gt;It&apos;s also safe now to do it now, because we always negotiate the &lt;b&gt;true&lt;/b&gt; version in the very beginning of OTC/ITC lifecyle (both nodes&apos; MS.current_version-s), hence &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2860&quot; title=&quot;Versioning works *too* well&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2860&quot;&gt;&lt;del&gt;CASSANDRA-2860&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3166&quot; title=&quot;Rolling upgrades from 0.7 to 0.8 not possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3166&quot;&gt;&lt;del&gt;CASSANDRA-3166&lt;/del&gt;&lt;/a&gt; won&apos;t become an issue again, even w/out the resetVersion() call.&lt;/p&gt;

&lt;p&gt;The only exception is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8057&quot; title=&quot;Record the real messaging version in all cases in OutboundTcpConnection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8057&quot;&gt;&lt;del&gt;CASSANDRA-8057&lt;/del&gt;&lt;/a&gt;, but it&apos;s minor and Patch Available already, and we&apos;ll get it in next week.&lt;/p&gt;

&lt;p&gt;Setting &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; as the reviewer b/c he was the author of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3166&quot; title=&quot;Rolling upgrades from 0.7 to 0.8 not possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3166&quot;&gt;&lt;del&gt;CASSANDRA-3166&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14160104" author="krummas" created="Mon, 6 Oct 2014 08:45:15 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14162017" author="iamaleksey" created="Tue, 7 Oct 2014 15:46:27 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12721610">CASSANDRA-7406</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12668972">CASSANDRA-6038</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12512897">CASSANDRA-2860</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12522418">CASSANDRA-3166</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12670520">CASSANDRA-6095</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12695031">CASSANDRA-6700</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12745921">CASSANDRA-8057</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12672940" name="7734.txt" size="4240" author="aleksey" created="Sat, 4 Oct 2014 15:37:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411147</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yqgv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411139</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>