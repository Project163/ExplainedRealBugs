<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5831] Running sstableupgrade on C* 1.0 data dir, before starting C* 1.2 for the first time breaks stuff</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5831</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If you try to upgrade from C* 1.0.X to 1.2.X and run offline sstableupgrade to try and migrate the sstables before starting 1.2.X for the first time, it messes up the system folder, because it doesn&apos;t migrate it right, and then C* 1.2 can&apos;t start.&lt;br/&gt;
sstableupgrade should either refuse to run against a C* 1.0 data folder, or migrate stuff the right way.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12660765">CASSANDRA-5831</key>
            <summary>Running sstableupgrade on C* 1.0 data dir, before starting C* 1.2 for the first time breaks stuff</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="jeremiah">Jeremiah Jordan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Jul 2013 19:55:27 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Wed, 7 Aug 2013 23:05:43 +0000</resolved>
                                        <fixVersion>1.2.9</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13724355" author="jbellis" created="Tue, 30 Jul 2013 20:23:56 +0000"  >&lt;p&gt;I think all we need to do here is &quot;don&apos;t run upgradesstables if the ks/cf/ heirarchy doesn&apos;t exist already for the system tables.&quot;&lt;/p&gt;

&lt;p&gt;In particular, upgradesstables against a 1.1 install should be fine.&lt;/p&gt;</comment>
                            <comment id="13725523" author="thobbs" created="Wed, 31 Jul 2013 18:10:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think all we need to do here is &quot;don&apos;t run upgradesstables if the ks/cf/ heirarchy doesn&apos;t exist already for the system tables.&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If I&apos;m interpreting you correctly, we&apos;ll just want upgradesstables to error out in that case and mention something about starting Cassandra 1.1+ before running upgradesstables again, is that correct?&lt;/p&gt;</comment>
                            <comment id="13725527" author="jbellis" created="Wed, 31 Jul 2013 18:12:21 +0000"  >&lt;p&gt;Right.&lt;/p&gt;</comment>
                            <comment id="13725698" author="thobbs" created="Wed, 31 Jul 2013 20:45:54 +0000"  >&lt;p&gt;Attached patch 0001 does exactly that.&lt;/p&gt;</comment>
                            <comment id="13725810" author="jbellis" created="Wed, 31 Jul 2013 23:07:18 +0000"  >&lt;p&gt;I think we probably want to decouble sstableNeedsMigration from its caller in CassandraDaemon, it throws a bunch of exceptions that are probably not expected.&lt;/p&gt;

&lt;p&gt;However, I also note that StandaloneScrubber calls sNM, so maybe making upgradesstables able to perform the migration automagically isn&apos;t as painful as I thought.&lt;/p&gt;</comment>
                            <comment id="13726698" author="thobbs" created="Thu, 1 Aug 2013 18:19:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we probably want to decouble sstableNeedsMigration from its caller in CassandraDaemon, it throws a bunch of exceptions that are probably not expected.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you just referring to the RuntimeExceptions around the total path length on Windows?  If not, can you clarify?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;However, I also note that StandaloneScrubber calls sNM, so maybe making upgradesstables able to perform the migration automagically isn&apos;t as painful as I thought.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I noticed that with only a few minor changes to &lt;tt&gt;migrateSSTables()&lt;/tt&gt;, the upgrader should be able to do this pretty easily.  Do you want me to add that in?&lt;/p&gt;</comment>
                            <comment id="13726736" author="jbellis" created="Thu, 1 Aug 2013 18:49:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;Are you just referring to the RuntimeExceptions&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;with only a few minor changes to migrateSSTables(), the upgrader should be able to do this pretty easily&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s go ahead and do that, then.&lt;/p&gt;</comment>
                            <comment id="13727011" author="thobbs" created="Thu, 1 Aug 2013 22:40:59 +0000"  >&lt;p&gt;Hmm, there&apos;s one complication: &lt;tt&gt;sstableupgrade&lt;/tt&gt; requires a keyspace and table to be specified, whereas the data directory migration is normally done all at once.  Changing the directory layout for only a single CF feels strange, but changing the layout for other keyspaces and CFs that you didn&apos;t specify also feels wrong.&lt;/p&gt;</comment>
                            <comment id="13727052" author="jbellis" created="Thu, 1 Aug 2013 23:14:08 +0000"  >&lt;p&gt;How does scrub deal with this?&lt;/p&gt;</comment>
                            <comment id="13727067" author="thobbs" created="Thu, 1 Aug 2013 23:27:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;How does scrub deal with this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. It just runs the full migration.  That still seems less-than-perfect, but at least the behavior would be consistent.&lt;/p&gt;</comment>
                            <comment id="13727073" author="jbellis" created="Thu, 1 Aug 2013 23:29:46 +0000"  >&lt;p&gt;Seems like if they&apos;re running upgrade then they&apos;ve signaled their intent to be on the new version, so maybe just add a notice that we&apos;re moving &lt;b&gt;everything&lt;/b&gt; to the new directory structure and call it good.&lt;/p&gt;</comment>
                            <comment id="13727078" author="JIRAUSER308715" created="Thu, 1 Aug 2013 23:31:13 +0000"  >&lt;p&gt;Agreed.  Also, if you want to add a &quot;migrate all keyspaces&quot; option, I don&apos;t think anyone would complain.&lt;/p&gt;</comment>
                            <comment id="13727131" author="thobbs" created="Fri, 2 Aug 2013 00:07:59 +0000"  >&lt;p&gt;The new 0001 patch adds a &lt;tt&gt;&amp;#45;&amp;#45;migrate&lt;/tt&gt; option to &lt;tt&gt;sstableupgrade&lt;/tt&gt; and &lt;tt&gt;sstablescrub&lt;/tt&gt;.  If that option is not used and a pre-1.1 layout is detected, both tools will error out and mention the &lt;tt&gt;&amp;#45;&amp;#45;migrate&lt;/tt&gt; option.  If the option is used, all keyspaces and column families will be migrated.&lt;/p&gt;</comment>
                            <comment id="13731600" author="JIRAUSER308715" created="Wed, 7 Aug 2013 03:17:44 +0000"  >&lt;p&gt;Something more needs to happen on migration for 1.2.  Both sstableupgrade and sstablescrub create a broken set of system tables.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 22:11:40,896 Fatal exception during initialization
org.apache.cassandra.exceptions.ConfigurationException: Found system table files, but they couldn&apos;t be loaded!
	at org.apache.cassandra.db.SystemTable.checkHealth(SystemTable.java:440)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:243)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:447)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:490)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Works fine if I just run ./cassandra to do the upgrade.&lt;/p&gt;</comment>
                            <comment id="13732230" author="thobbs" created="Wed, 7 Aug 2013 18:03:36 +0000"  >&lt;p&gt;Patch 0002 alters the failing health check to also look for a saved cluster name in &lt;tt&gt;System.LocationInfo&lt;/tt&gt;, which indicates that the system data has not been migrated yet (it happens at the end of the startup process, whereas the health check is early in the startup process).&lt;/p&gt;

&lt;p&gt;I also have a &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-5831&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; that contains the two patches.&lt;/p&gt;</comment>
                            <comment id="13732805" author="JIRAUSER308715" created="Wed, 7 Aug 2013 21:58:32 +0000"  >&lt;p&gt;Still not sure what is really going on here.  &quot;Directories.migrateSSTables();&quot; is called before &quot;SystemTable.checkHealth()&quot; on a regular C* startup.  All sstablescrub and sstableupgrade do is call Directories.migrateSSTables();, then call DatabaseDescriptor.loadSchemas();, so why does &quot;SystemTable.checkHealth&quot; fail after that?  SystemTable.finishStartup(); which does the table upgrade doesn&apos;t get called until well after checkHealth.  Is calling DatabaseDescriptor.loadSchemas(); in the sstable* scripts doing something that breaks checkHealth?  I don&apos;t know that the answer should be &quot;change check health&quot;.  Should we call upgrade tables from the migration stuff in sstable* scripts?&lt;/p&gt;

&lt;p&gt;Regular C* startup does:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Directories.migrateSSTables();
SystemTable.checkHealth();
DatabaseDescriptor.loadSchemas();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;sstable* do:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Directories.migrateSSTables();
DatabaseDescriptor.loadSchemas();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So if you run sstable* then start c* the order is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Directories.migrateSSTables();
DatabaseDescriptor.loadSchemas();
SystemTable.checkHealth();
DatabaseDescriptor.loadSchemas();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13732861" author="JIRAUSER308715" created="Wed, 7 Aug 2013 22:38:04 +0000"  >&lt;p&gt;So after going through it some more I think the health check change is fine.  Looks like the issue is that loadSchemas is causing empty new tables to be made, so those get checked for stuff.&lt;/p&gt;

&lt;p&gt;Everything looks good now.  +1 from me.&lt;/p&gt;</comment>
                            <comment id="13732895" author="jbellis" created="Wed, 7 Aug 2013 23:05:43 +0000"  >&lt;p&gt;Committed (to 1.2 only), thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12595521" name="0001-Handle-pre-1.1-data-directory-layout.patch" size="7385" author="thobbs" created="Fri, 2 Aug 2013 00:07:59 +0000"/>
                            <attachment id="12596668" name="0002-Handle-old-system-data-in-health-check.patch" size="4819" author="thobbs" created="Wed, 7 Aug 2013 18:03:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340954</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1msz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>341272</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jjordan</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjordan]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>