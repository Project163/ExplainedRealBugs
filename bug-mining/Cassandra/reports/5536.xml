<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16228] TableMetrics are exposed before ColumnFamilyStore is fully initialized</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16228</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt; exposes the &lt;tt&gt;TableMetrics&lt;/tt&gt; before it is fully initialized, due to that it is possible to perform a call via the metrics that access uninitialized part of the &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt;.&#160;&lt;/p&gt;

&lt;p&gt;The following test can be added to ColumnFamilyMetricTest to show the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testStartupRaceConditionOnMetricListeners()
{
 &lt;span class=&quot;code-comment&quot;&gt;// Since the ColumnFamilyStore instance reference escapes during the construction
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// we have a race condition and listeners can see an instance that is in an unknown state.
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// This test just check that all callbacks can access the data without throwing any exception.
&lt;/span&gt; registerMetricListener();
 SchemaLoader.createKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Keyspace2&quot;&lt;/span&gt;,
 KeyspaceParams.simple(1),
 SchemaLoader.standardCFMD(&lt;span class=&quot;code-quote&quot;&gt;&quot;Keyspace2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Standard2&quot;&lt;/span&gt;));
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void registerMetricListener()
{
 CassandraMetricsRegistry.Metrics.addListener(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetricRegistryListener.Base()
 {
 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onGaugeAdded(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, Gauge&amp;lt;?&amp;gt; gauge)
 {
 gauge.getValue();
 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onGaugeRemoved(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
 {

 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onCounterAdded(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, Counter counter)
 {
 counter.getCount();
 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onCounterRemoved(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
 {

 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onHistogramAdded(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, Histogram histogram)
 {
 histogram.getCount();
 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onHistogramRemoved(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
 {

 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onMeterAdded(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, Meter meter)
 {
 meter.getCount();
 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onMeterRemoved(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
 {

 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onTimerAdded(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, Timer timer)
 {
 timer.getCount();
 }

 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onTimerRemoved(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
 {

 }
 });&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While looking into that ticket we also discovered a problem with the used of &lt;tt&gt;Metered&lt;/tt&gt; in &lt;tt&gt;CacheMetrics&lt;/tt&gt;.&lt;br/&gt;
Metrics reporter looks for metrics classes that are instance of the standard codahale classes. Due to that, other Metered implementations are not be exposed through the reporter. This ticket will also address that issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13337449">CASSANDRA-16228</key>
            <summary>TableMetrics are exposed before ColumnFamilyStore is fully initialized</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="edimitrova">Ekaterina Dimitrova</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Oct 2020 14:46:50 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:41 +0000</updated>
                            <resolved>Tue, 10 Nov 2020 13:06:35 +0000</resolved>
                                        <fixVersion>3.0.24</fixVersion>
                    <fixVersion>3.11.10</fixVersion>
                    <fixVersion>4.0-beta4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Observability/Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17221755" author="edimitrova" created="Tue, 27 Oct 2020 21:06:15 +0000"  >&lt;p&gt;The patch adds a &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/612d71cd09967e725770895ebfcf528f11353bd4#diff-3b7425b96625eda53b205ad149edea919df71b29ef01efc602d8ce28b86f3f59R122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test&lt;/a&gt; to cover the mentioned race condition.&lt;/p&gt;

&lt;p&gt;In 4.0, as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14628&quot; title=&quot;Clean up cache-related metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14628&quot;&gt;&lt;del&gt;CASSANDRA-14628&lt;/del&gt;&lt;/a&gt;, requests implementation in CacheMetrics was changed but this change (the 2nd suggestion &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14626?focusedCommentId=16587227&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16587227&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt; ) prevents us from using the codahale &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/612d71cd09967e725770895ebfcf528f11353bd4#diff-3b7425b96625eda53b205ad149edea919df71b29ef01efc602d8ce28b86f3f59R136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;addListener() &lt;/a&gt;. That is why I reverted the requests implementation to the original &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/c66e6641a5a5f7e9241212a8193feb6a66771d3f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;version &lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14628&quot; title=&quot;Clean up cache-related metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14628&quot;&gt;&lt;del&gt;CASSANDRA-14628&lt;/del&gt;&lt;/a&gt;, changing its type from Metered to Meter and using the mark method.&lt;/p&gt;

&lt;p&gt;The race condition was fixed itself in 3.0, 3.11, 4.0.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/pull/67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0 pull request &lt;/a&gt; | &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/450/workflows/8df700c5-1775-433f-8dfc-3b3391f3d0ae&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA 8 CI &lt;/a&gt; | &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/450/workflows/4f8946b5-6448-4dd6-b231-8f288c861f34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA 11 CI &lt;/a&gt; &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/144/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Jenkins CI &lt;/a&gt;&lt;br/&gt;
 &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/898880b5f6d7635cddc4eec1f19513fe61de5b43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 branch &lt;/a&gt; | &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/145/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI &lt;/a&gt;&lt;br/&gt;
 &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/146/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 CI &lt;/a&gt;&lt;br/&gt;
 &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/898880b5f6d7635cddc4eec1f19513fe61de5b43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch &lt;/a&gt; to be merged also to 3.11 and 4.0 &lt;b&gt;after&lt;/b&gt; applying first this &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/c66e6641a5a5f7e9241212a8193feb6a66771d3f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch &lt;/a&gt; to 4.0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17221914" author="edimitrova" created="Wed, 28 Oct 2020 02:34:46 +0000"  >&lt;p&gt;The CI results are out. The only failure that grabbed my attention was  the one of &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/450/workflows/8df700c5-1775-433f-8dfc-3b3391f3d0ae/jobs/2606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_table_metric_mbeans - jmx_test.TestJMX &lt;/a&gt; . &lt;/p&gt;

&lt;p&gt;But it looks like it was random, unrelated, CircleCI resource related(I also looped the test locally several times and it completed successfully; it also didn&apos;t fail in Jenkins):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stdout = b&lt;span class=&quot;code-quote&quot;&gt;&quot;Couldn&lt;span class=&quot;code-quote&quot;&gt;&apos;t start agent &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; PID 6894\nPossible reason could be that port &apos;&lt;/span&gt;8778&apos; is already occupied.\nPlease check the standard output of the target process &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a detailed error message.\n&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17221916" author="edimitrova" created="Wed, 28 Oct 2020 02:35:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, do you think you will have the time to make a review?&lt;/p&gt;</comment>
                            <comment id="17229196" author="blerer" created="Tue, 10 Nov 2020 12:57:31 +0000"  >&lt;p&gt;The patches looks good.&lt;/p&gt;</comment>
                            <comment id="17229201" author="blerer" created="Tue, 10 Nov 2020 13:06:35 +0000"  >&lt;p&gt;Patch committed into cassandra-3.0 at 548ef438568fe3216e39235fc054202709c542ca and merged into cassandra-3.11 and trunk.&lt;/p&gt;

&lt;p&gt;The patch for the metric reported issue was merged into trunk at 32874dd04ae6c8dc9cc98d63717b8f94f4485378&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[edimitrova]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k1oo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/548ef438568fe3216e39235fc054202709c542ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/548ef438568fe3216e39235fc054202709c542ca&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16228?focusedCommentId=17221755&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17221755&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-16228?focusedCommentId=17221755&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17221755&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>