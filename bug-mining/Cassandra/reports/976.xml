<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2468] Clean up after failed compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2468</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;(Started in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2088&quot; title=&quot;Clean up after failed (repair) streaming operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2088&quot;&gt;&lt;del&gt;CASSANDRA-2088&lt;/del&gt;&lt;/a&gt;.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12504212">CASSANDRA-2468</key>
            <summary>Clean up after failed compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amorton">Aaron Morton</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Apr 2011 21:05:58 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:02 +0000</updated>
                            <resolved>Thu, 23 Jun 2011 05:49:56 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13026981" author="slebresne" created="Fri, 29 Apr 2011 14:01:35 +0000"  >&lt;p&gt;@Aaron: are you still working on this ? It would be nice to fix this quickly. And we should probably target 0.7 for that one.&lt;/p&gt;</comment>
                            <comment id="13027205" author="amorton" created="Fri, 29 Apr 2011 21:51:15 +0000"  >&lt;p&gt;should have time this weekend. &lt;/p&gt;</comment>
                            <comment id="13027453" author="amorton" created="Sun, 1 May 2011 11:16:28 +0000"  >&lt;p&gt;Attached patches for 0.7 and 0.8 rely on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2588&quot; title=&quot;Descriptor.equals() ignores the temporary flag&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2588&quot;&gt;&lt;del&gt;CASSANDRA-2588&lt;/del&gt;&lt;/a&gt; to correctly detect sstables on disk. &lt;/p&gt;

&lt;p&gt;Added closeAndDeleteQuietly() to SSTableWriter and SSTableWriter.Builder to close open files and delete the SSTable files found on disk.&lt;/p&gt;

&lt;p&gt;Checks for failures in CompactionManager doCompaction(), doScrub() and doCleanupCompaction() and submitSSTableBuild() &lt;/p&gt;

&lt;p&gt;Does not check in CompactionManager.submitIndexBuild() because the builder works against memtables and does not use an SSTableWriter. &lt;/p&gt;

&lt;p&gt;Checks for failures in Memtable.writeSortedContents()&lt;/p&gt;</comment>
                            <comment id="13028135" author="slebresne" created="Tue, 3 May 2011 09:59:01 +0000"  >&lt;p&gt;Comment:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I&apos;m uncomfortable with having closeAndDeleteQuietly() delete the non tmp files (those really do not belong to the writer). Sure the calls are always conditioned so that we shouldn&apos;t messed up, but I&apos;m not sure it&apos;s worth the risk of foot-shooting (it makes the function harder to use). I&apos;d rather remove that part, rename closeAndDeleteQuietly() to something like cleanupIfNecessary() and call it every time in the finally block (which would remove the need to check if the reader was successfully created every damn time).&lt;/li&gt;
	&lt;li&gt;Nitpick: I&apos;d prefer moving the code for SSTableWriter.Builder inside build() itself.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13028167" author="amorton" created="Tue, 3 May 2011 11:50:59 +0000"  >&lt;p&gt;The check to delete the non temp files was to cover the unlikely event that rename() threw an IOError part way through renaming the files. I thought about potentially deleting the wrong files but nothing else see the non temp files until the SSTR is returned. &lt;/p&gt;

&lt;p&gt;Happy to make the change tomorrow if you still want, it makes things a little safer. &lt;/p&gt;</comment>
                            <comment id="13028174" author="slebresne" created="Tue, 3 May 2011 12:05:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Happy to make the change tomorrow if you still want, it makes things a little safer.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks, I prefer safer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; (I&apos;m not too worried about rename failing)&lt;/p&gt;</comment>
                            <comment id="13028917" author="amorton" created="Wed, 4 May 2011 19:42:29 +0000"  >&lt;p&gt;Updated patches with suggested changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;only deletes temp files&lt;/li&gt;
	&lt;li&gt;cleanupIfNecessary() used&lt;/li&gt;
	&lt;li&gt;SSTW.Builder.build() cleans up self&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;NOTE: requires &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2602&quot; title=&quot;Add check in SSTable.componentsFor() for temp files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2602&quot;&gt;&lt;del&gt;CASSANDRA-2602&lt;/del&gt;&lt;/a&gt; to detect temp files correctly.&lt;/p&gt;</comment>
                            <comment id="13029334" author="slebresne" created="Thu, 5 May 2011 13:59:47 +0000"  >&lt;p&gt;Looks good but this needs rebasing (at least for 0.7, don&apos;t bother too much with 0.8, I&apos;ll try to merge it unless this is a pain)&lt;/p&gt;</comment>
                            <comment id="13029704" author="amorton" created="Fri, 6 May 2011 02:57:37 +0000"  >&lt;p&gt;rebased both the v07 and v08&lt;/p&gt;</comment>
                            <comment id="13043002" author="stuhood" created="Thu, 2 Jun 2011 19:18:46 +0000"  >&lt;p&gt;What&apos;s shakin&apos; here?&lt;/p&gt;</comment>
                            <comment id="13044675" author="amorton" created="Mon, 6 Jun 2011 01:59:43 +0000"  >&lt;p&gt;rebased the v08 version today, attached as 0001-clean-up-temp-files-after-failed-compaction-v08-2&lt;/p&gt;

&lt;p&gt;Have not updated v07, let me know if you need it.  &lt;/p&gt;</comment>
                            <comment id="13045026" author="stuhood" created="Mon, 6 Jun 2011 18:52:43 +0000"  >&lt;ul&gt;
	&lt;li&gt;SSTable.delete will throw an IOError on IOException, which might kill cleanupIfNecessary... should we consider having delete throw IOException? I&apos;d prefer not to catch IOError.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SSTable.tempComponentsFor&lt;/tt&gt; could probably be merged with componentsFor and an enum &lt;tt&gt;LIVE&lt;/tt&gt;, &lt;tt&gt;TEMP&lt;/tt&gt; or &lt;tt&gt;LIVE | TEMP&lt;/tt&gt;? Not a blocker, just sugar.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After the IOError is fixed, +1 from me. Thanks Aaron!&lt;/p&gt;</comment>
                            <comment id="13045032" author="jbellis" created="Mon, 6 Jun 2011 19:00:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;SSTable.tempComponentsFor could probably be merged with componentsFor&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I prefer the distinct, flag-less methods.&lt;/p&gt;</comment>
                            <comment id="13045046" author="stuhood" created="Mon, 6 Jun 2011 19:43:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;I prefer the distinct, flag-less methods.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;componentsFor already has a boolean flag... my suggestion was to make it a ternary flag. Again, no big deal.&lt;/p&gt;</comment>
                            <comment id="13045077" author="jbellis" created="Mon, 6 Jun 2011 20:34:23 +0000"  >&lt;p&gt;Eh, you&apos;re right.  Then flags is probably better than flags AND multiple methods. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13045880" author="amorton" created="Wed, 8 Jun 2011 10:11:00 +0000"  >&lt;p&gt;version 3 for v0.8 modified SSTable.delete() to raise an IOException so cleanupIfNecessary() can catch it. Also changes componentsFor to accept an enum. &lt;/p&gt;

&lt;p&gt;Do we want this in 0.7?&lt;/p&gt;</comment>
                            <comment id="13047348" author="stuhood" created="Fri, 10 Jun 2011 18:20:17 +0000"  >&lt;p&gt;+1 on the patch for 0.8/trunk&lt;br/&gt;
Thanks Aaron!&lt;/p&gt;</comment>
                            <comment id="13048255" author="stuhood" created="Sun, 12 Jun 2011 06:29:09 +0000"  >&lt;p&gt;Rebased for post-1610-trunk as v4.&lt;/p&gt;</comment>
                            <comment id="13052996" author="stuhood" created="Wed, 22 Jun 2011 02:03:33 +0000"  >&lt;p&gt;Rebased for trunk (assuming r1138084 is reverted).&lt;/p&gt;</comment>
                            <comment id="13053664" author="jbellis" created="Thu, 23 Jun 2011 05:49:56 +0000"  >&lt;p&gt;committed, thanks all!&lt;/p&gt;</comment>
                            <comment id="13053677" author="hudson" created="Thu, 23 Jun 2011 07:09:36 +0000"  >&lt;p&gt;Integrated in Cassandra #936 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/936/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/936/&lt;/a&gt;)&lt;br/&gt;
    clean up tmpfiles after failed compaction&lt;br/&gt;
patch by Aaron Morton; reviewed by slebresne and Stu Hood for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2468&quot; title=&quot;Clean up after failed compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2468&quot;&gt;&lt;del&gt;CASSANDRA-2468&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1138740&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1138740&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/sstable/SSTable.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/compaction/CompactionTask.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/Memtable.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/sstable/Descriptor.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/util/FileUtils.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/io/sstable/SSTableTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/sstable/SSTableReader.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/compaction/CompactionManager.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/sstable/SSTableDeletingReference.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/sstable/SSTableWriter.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12505364">CASSANDRA-2576</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12506653">CASSANDRA-2629</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12506150">CASSANDRA-2602</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12483390" name="0001-CASSANDRA-2468-clean-up-temp-files-after-failed-compac.txt" size="31871" author="stuhood" created="Wed, 22 Jun 2011 02:03:33 +0000"/>
                            <attachment id="12481527" name="0001-clean-up-temp-files-after-failed-compaction-v08-2.patch" size="23468" author="amorton" created="Mon, 6 Jun 2011 01:59:43 +0000"/>
                            <attachment id="12481796" name="0001-clean-up-temp-files-after-failed-compaction-v08-3.patch" size="30985" author="amorton" created="Wed, 8 Jun 2011 10:11:00 +0000"/>
                            <attachment id="12478361" name="0001-clean-up-temp-files-after-failed-compaction-v08.patch" size="24280" author="amorton" created="Fri, 6 May 2011 02:57:37 +0000"/>
                            <attachment id="12478360" name="0001-cleanup-temp-files-after-failed-compaction-v07.patch" size="27923" author="amorton" created="Fri, 6 May 2011 02:57:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[amorton]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20642</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93302</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stuhood</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stuhood]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>