<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8316] &quot;Did not get positive replies from all endpoints&quot; error on incremental repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8316</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;ve got an issue with incremental repairs on our production 15 nodes 2.1.2 (new cluster, not yet loaded, RF=3)&lt;/p&gt;

&lt;p&gt;After having successfully performed an incremental repair (-par -inc) on 3 nodes, I started receiving &quot;Repair failed with error Did not get positive replies from all endpoints.&quot; from nodetool on all remaining nodes :&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-11-14 09:12:36,488&amp;#93;&lt;/span&gt; Starting repair command #3, repairing 108 ranges for keyspace xxxx (seq=false, full=false)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-11-14 09:12:47,919&amp;#93;&lt;/span&gt; Repair failed with error Did not get positive replies from all endpoints.&lt;/p&gt;

&lt;p&gt;All the nodes are up and running and the local system log shows that the repair commands got started and that&apos;s it.&lt;/p&gt;

&lt;p&gt;I&apos;ve also noticed that soon after the repair, several nodes started having more cpu load indefinitely without any particular reason (no tasks / queries, nothing in the logs). I then restarted C* on these nodes and retried the repair on several nodes, which were successful until facing the issue again.&lt;/p&gt;

&lt;p&gt;I tried to repro on our 3 nodes preproduction cluster without success&lt;/p&gt;

&lt;p&gt;It looks like I&apos;m not the only one having this issue: &lt;a href=&quot;http://www.mail-archive.com/user%40cassandra.apache.org/msg39145.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user%40cassandra.apache.org/msg39145.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Any idea?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Loic&lt;/p&gt;</description>
                <environment>&lt;p&gt;cassandra 2.1.2&lt;/p&gt;</environment>
        <key id="12755300">CASSANDRA-8316</key>
            <summary>&quot;Did not get positive replies from all endpoints&quot; error on incremental repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="llambiel">Loic Lambiel</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Nov 2014 09:20:00 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:28 +0000</updated>
                            <resolved>Wed, 21 Jan 2015 09:40:36 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14212045" author="krummas" created="Fri, 14 Nov 2014 09:24:47 +0000"  >&lt;p&gt;any exceptions on any other nodes?&lt;/p&gt;</comment>
                            <comment id="14212055" author="llambiel" created="Fri, 14 Nov 2014 09:40:15 +0000"  >&lt;p&gt;Nope, nothing special noticed on other nodes (except load on few nodes)&lt;/p&gt;</comment>
                            <comment id="14212063" author="krummas" created="Fri, 14 Nov 2014 09:44:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt; can your team reproduce? running with -inc and -par on a ~15 node cluster with vnodes&lt;/p&gt;</comment>
                            <comment id="14212103" author="llambiel" created="Fri, 14 Nov 2014 10:38:33 +0000"  >&lt;p&gt;I forgot to mention that I&apos;m using LCS, in case of&lt;/p&gt;</comment>
                            <comment id="14224896" author="aboudreault" created="Tue, 25 Nov 2014 17:43:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=llambiel&quot; class=&quot;user-hover&quot; rel=&quot;llambiel&quot;&gt;llambiel&lt;/a&gt; I have been able to reproduce this issue many times. However, not sure exactly where the problem is. I&apos;ve attached a small bash script that I used to test:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I run a cluster of 8 nodes&lt;/li&gt;
	&lt;li&gt;I set the cluster loglevel to TRACE (very important to reproduce the issue, we have to slow things)&lt;/li&gt;
	&lt;li&gt;I stress with n=500000 with RF=3&lt;/li&gt;
	&lt;li&gt;I start 3 &quot;nodetool repair -par -inc&quot; in parallel  (Important, starting only 2 repairs doesn&apos;t produce the issue everytime. it depends on the system load I guess)&lt;/li&gt;
	&lt;li&gt;The issue is related to incremental repair. I can&apos;t reproduce the issue with seq repair and/or par not incremental repair.&lt;/li&gt;
	&lt;li&gt;The compaction strategy is not related. I can reproduce the issue with LCS and STCS.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Basically, the issue happens when the system is very busy and doesn&apos;t response enough fast. In then function sendRR of MessagingService.java, a callback is added withn a timeout of 10 seconds. The endpoint doesn&apos;t response in 10 seconds, so we get the error. However, even if we increase that timeout to 100 seconds in example, the system doesn&apos;t get better and the load is still very high. We just get the error message &quot;Lost notification, check server log for repair state of keyspace ...&quot; instead of &quot;Repair failed with error Did not get positive replies from all endpoints.&quot;. When the load is high (event after the repair), I checked quickly with yourkit and what taking a lot of cpu time is the AntiEntropyStage thread, so the ActiveRepairService that never ends?&lt;/p&gt;

&lt;p&gt;Let me know if you I go deeper in the profiling, perhaps I could get a better profiling by enabling a cassandra agent + yourkit.&lt;/p&gt;</comment>
                            <comment id="14225125" author="aboudreault" created="Tue, 25 Nov 2014 20:05:41 +0000"  >&lt;p&gt;Here is a yourkit snapshot of what&apos;s going on AFTER all repair commands finished with the error message. The process is working hard at 100% of the cpu in &#180;htop&#180;. &lt;/p&gt;</comment>
                            <comment id="14229587" author="llambiel" created="Mon, 1 Dec 2014 09:30:50 +0000"  >&lt;p&gt;Hi guys,&lt;/p&gt;

&lt;p&gt;Any chance to get this issue fixed for 2.1.3 ? On our side we face this issue on almost all incremental repairs&lt;/p&gt;</comment>
                            <comment id="14230222" author="philipthompson" created="Mon, 1 Dec 2014 18:46:45 +0000"  >&lt;p&gt;We are currently investigating the issue.&lt;/p&gt;</comment>
                            <comment id="14230269" author="aboudreault" created="Mon, 1 Dec 2014 19:12:51 +0000"  >&lt;p&gt;This issue seems to be effectively critical. I reproduced the issues on all inc repairs while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366&quot; title=&quot;Repair grows data on nodes, causes load to become unbalanced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8366&quot;&gt;&lt;del&gt;CASSANDRA-8366&lt;/del&gt;&lt;/a&gt; and have seen very inconsistent results in storage size.&lt;/p&gt;</comment>
                            <comment id="14230299" author="krummas" created="Mon, 1 Dec 2014 19:34:05 +0000"  >&lt;p&gt;Storage size issue is probably &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8386&quot; title=&quot;Make sure we release references to sstables after incremental repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8386&quot;&gt;&lt;del&gt;CASSANDRA-8386&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8267&quot; title=&quot;Only stream from unrepaired sstables during incremental repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8267&quot;&gt;&lt;del&gt;CASSANDRA-8267&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14230776" author="yukim" created="Tue, 2 Dec 2014 00:47:26 +0000"  >&lt;p&gt;Looking at Alan&apos;s yourkit snapshot, I noticed that anti compaction (actually, markCompacting loop before anti-compaction) is long-running on AntiEntropyStage.&lt;br/&gt;
This causes prepare phase from subsequent incremental repair to fail because single-threaded AntiEntropyStage is occupied still.&lt;/p&gt;

&lt;p&gt;We should just dispatch to another thread from AntiEntropyStage so that nothing will block there.&lt;/p&gt;</comment>
                            <comment id="14231530" author="aboudreault" created="Tue, 2 Dec 2014 14:22:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; Thank you for taking a look at the snapshot. That&apos;s great if the patch is only a thread dispatching! I&apos;ll wait a patch from you, (or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; ?) And will re-run my entire tests. Let me know if I can do anything else to help.&lt;/p&gt;</comment>
                            <comment id="14232949" author="krummas" created="Wed, 3 Dec 2014 12:27:31 +0000"  >&lt;p&gt;attaching patch that moves the compacting-marking into the compaction executor&lt;/p&gt;

&lt;p&gt;It also disallows starting multiple repairs over the same set of sstables - since incremental repair is stateful (ie, we pick sstables to repair when we start, then anticompact those when we are done) we can&apos;t really run multiple repairs that touch the same sstables in parallel&lt;/p&gt;

&lt;p&gt;could you try it out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14234581" author="aboudreault" created="Thu, 4 Dec 2014 20:20:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; As mentionned on IRC, the patch dont&apos; to fix the issue in cassandra-2.1. In trunk (3.0), the following commit fixed the &quot;did not get positive....&quot; error:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/06f626acd27b051222616c0c91f7dd8d556b8d45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/06f626acd27b051222616c0c91f7dd8d556b8d45&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but this one is already in branch cassandra-2.1 and there are many additional major changes related to repair in 3.0. &lt;/p&gt;

&lt;p&gt;Any suggestion at this point ?&lt;/p&gt;</comment>
                            <comment id="14239473" author="yukim" created="Tue, 9 Dec 2014 14:42:44 +0000"  >&lt;p&gt;Can you get yourkit snapshot for the patced 2.1?&lt;br/&gt;
It may show something.&lt;/p&gt;</comment>
                            <comment id="14239522" author="aboudreault" created="Tue, 9 Dec 2014 15:14:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; Yes, will do today during my bootcamp breaks. Something that I&apos;m thinking is - if the patch at least avoid the high CPU utilization on failure, it might bean acceptable fix. Will get back to you asap&lt;/p&gt;</comment>
                            <comment id="14241147" author="aboudreault" created="Wed, 10 Dec 2014 14:38:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; With some test runs, I cannot see the high CPU utilization issue again. However, I still see the error message. Also I&apos;ve noticed an important changes between with and without the patch. &lt;/p&gt;

&lt;p&gt;WITHOUT the patch: I can re-run the increment repairs. I might get again the error message on the node that initially failed, but things will get OK after the initial endpoints that failed are repaired.&lt;/p&gt;

&lt;p&gt;WITH the patch: I cannot do an incremental repairs anymore, even after a restart. This is what I get trying to run the repairs on my node:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;aboudreault@kovarro:~/dev/cstar/8316$ ccm node1 nodetool -- repair -par -inc
[2014-12-10 09:00:42,767] Starting repair command #1, repairing 3 ranges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace r1 (parallelism=PARALLEL, full=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
[2014-12-10 09:00:48,045] Repair session ee2a78c0-8074-11e4-9b59-bbfe19a8e904 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (4611686018427387904,6917529027641081856] finished
[2014-12-10 09:00:48,046] Repair session ef77e050-8074-11e4-9b59-bbfe19a8e904 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (2305843009213693952,4611686018427387904] finished
[2014-12-10 09:00:48,048] Repair session f06107d0-8074-11e4-9b59-bbfe19a8e904 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (6917529027641081856,-9223372036854775808] finished
[2014-12-10 09:00:48,078] Repair command #1 finished
[2014-12-10 09:00:48,088] Nothing to repair &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace &lt;span class=&quot;code-quote&quot;&gt;&apos;system&apos;&lt;/span&gt;
[2014-12-10 09:00:48,104] Starting repair command #2, repairing 2 ranges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace system_traces (parallelism=PARALLEL, full=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
[2014-12-10 09:00:58,916] Repair failed with error Did not get positive replies from all endpoints. List of failed endpoint(s): [127.0.0.2]
aboudreault@kovarro:~/dev/cstar/8316$ ccm node2 nodetool -- repair -par -inc
[2014-12-10 09:01:07,233] Starting repair command #1, repairing 3 ranges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace r1 (parallelism=PARALLEL, full=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
[2014-12-10 09:01:07,239] Repair failed with error Already repairing SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/home/aboudreault/.ccm/local/node2/data/r1/Standard1-c38dd6f0807111e494d8bbfe19a8e904/r1-Standard1-ka-5-Data.db&apos;&lt;/span&gt;), can not &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;.
[2014-12-10 09:01:07,247] Nothing to repair &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace &lt;span class=&quot;code-quote&quot;&gt;&apos;system&apos;&lt;/span&gt;
[2014-12-10 09:01:07,252] Starting repair command #2, repairing 2 ranges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace system_traces (parallelism=PARALLEL, full=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
[2014-12-10 09:01:07,254] Repair failed with error &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does this help?&lt;/p&gt;</comment>
                            <comment id="14241153" author="krummas" created="Wed, 10 Dec 2014 14:42:00 +0000"  >&lt;p&gt;yep, will have a look, seems that we don&apos;t clear out the parent repair session on this failure mode&lt;/p&gt;</comment>
                            <comment id="14241502" author="aboudreault" created="Wed, 10 Dec 2014 18:31:47 +0000"  >&lt;p&gt;Just pointing in case this ticket is related: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8291&quot; title=&quot;Parent repair session is not removed in remote node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8291&quot;&gt;&lt;del&gt;CASSANDRA-8291&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14244234" author="krummas" created="Fri, 12 Dec 2014 15:04:53 +0000"  >&lt;p&gt;Attaching new patch, found the problem with compacting-marking - we fail marking compacting if one of the sstables is marked compacted, this makes sure we remove those before retrying (infinite loop otherwise)&lt;/p&gt;

&lt;p&gt;Also adds a try/catch around the switch(..) in RepairMessageVerbHandler, might be a bit much, but it makes sure we always remove the parent repair session on failures.&lt;/p&gt;

&lt;p&gt;With this + the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8458&quot; title=&quot;Don&amp;#39;t give out positions in an sstable beyond its first/last tokens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8458&quot;&gt;&lt;del&gt;CASSANDRA-8458&lt;/del&gt;&lt;/a&gt; i&apos;m able continuously run incremental repairs on a heavily loaded 6 node cluster.&lt;/p&gt;</comment>
                            <comment id="14244294" author="aboudreault" created="Fri, 12 Dec 2014 15:50:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, I will run my tests today if possible, otherwise during the weekend and get back to you.&lt;/p&gt;</comment>
                            <comment id="14246153" author="aboudreault" created="Sun, 14 Dec 2014 21:58:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, unfortunately, I&apos;m still getting the initial issue AND the issue introduced on multiple nodes with the v2 patch + &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8458&quot; title=&quot;Don&amp;#39;t give out positions in an sstable beyond its first/last tokens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8458&quot;&gt;&lt;del&gt;CASSANDRA-8458&lt;/del&gt;&lt;/a&gt;. 8 nodes cluster and cassandra-stress with n=1000000&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;aboudreault@kovarro:~/dev/cstar/8316$ ccm node3 nodetool -- repair -par -inc 
[2014-12-14 16:30:48,037] Starting repair command #1, repairing 3 ranges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace r1 (parallelism=PARALLEL, full=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
[2014-12-14 16:30:48,040] Repair failed with error Already repairing SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/home/aboudreault/.ccm/local/node3/data/r1/Standard1-d11383e083d411e4869ab56034537865/r1-Standard1-ka-38-Data.db&apos;&lt;/span&gt;), can not &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In addition, I  noticed that it took 20 minutes restart my cluster this time. Not sure if it&apos;s related to this issue but I&apos;ve attached a yourkit snapshot.&lt;/p&gt;

&lt;p&gt;Let me know if I can anything else.&lt;/p&gt;</comment>
                            <comment id="14246358" author="krummas" created="Mon, 15 Dec 2014 06:18:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt; how do you reproduce this?&lt;/p&gt;

&lt;p&gt;The &quot;Repair failed with error Already repairing&quot;-error is supposed to happen if you start several repairs over the same sstables&lt;/p&gt;</comment>
                            <comment id="14246666" author="aboudreault" created="Mon, 15 Dec 2014 14:14:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I use my &lt;span class=&quot;error&quot;&gt;Unable to embed resource: test.sh of type application/x-sh&lt;/span&gt; script, but with n=1000000. You can see that my 3 repairs are sent in parallel. The first 2 failed quickly with &lt;b&gt;no positive replies&lt;/b&gt; error and the last one run for while then failed. At this point the cluster cannot be repaired anymore.&lt;/p&gt;</comment>
                            <comment id="14246673" author="krummas" created="Mon, 15 Dec 2014 14:23:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt; ok, I suspect there could be a race when you start repairs at exactly the same time over the same sstables&lt;/p&gt;

&lt;p&gt;Could you try upping the cluster to 9 nodes and avoiding starting repairs over the same sstables? I&apos;ll check the above issue&lt;/p&gt;</comment>
                            <comment id="14246704" author="aboudreault" created="Mon, 15 Dec 2014 14:48:16 +0000"  >&lt;p&gt;Note that I just tried to run my test without sending my 3 repair commands in background, so the repair are executed one after one, Same results.&lt;/p&gt;</comment>
                            <comment id="14246899" author="aboudreault" created="Mon, 15 Dec 2014 17:47:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; Is it worth running the test you ask earlier, if we got the same result without pushing repairs as background task? I suppose that if it happens with a single inc repair command too... it&apos;s something wrong internally with inc repair, and not necessarily a race condition of running different repair commands on the same sstable.&lt;/p&gt;</comment>
                            <comment id="14246951" author="krummas" created="Mon, 15 Dec 2014 18:18:50 +0000"  >&lt;p&gt;yeah, i&apos;ll have another look tomorrow&lt;/p&gt;</comment>
                            <comment id="14249690" author="krummas" created="Wed, 17 Dec 2014 10:25:54 +0000"  >&lt;p&gt;I think we are simply timing out the Prepare message when TRACE is enabled (I can&apos;t even start a 8 node cluster with TRACE on)&lt;/p&gt;

&lt;p&gt;One solution could be to increase the timeout for this message, but we use the same timeout for snapshot creation and that would be just as likely to fail on a heavily loaded cluster, wdyt &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;Also, note, that in your test you repair all ranges, meaning, when you repair node5 for example, you actually include node3,4,5,6,7, so you can&apos;t repair any of those at the same time&lt;/p&gt;</comment>
                            <comment id="14251628" author="krummas" created="Thu, 18 Dec 2014 13:13:31 +0000"  >&lt;p&gt;To summarize this;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we had a bug in compaction marking that could make a node end up in an infinite loop, fixed in branch linked above&lt;/li&gt;
	&lt;li&gt;we allowed multiple repairs over the same sstables, fixed&lt;/li&gt;
	&lt;li&gt;we had a situation where we didn&apos;t remove the parent repair sessions, fixed&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And, to describe the &quot;final&quot; problem:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Node A sends a PrepareMessage to overloaded Node B&lt;/li&gt;
	&lt;li&gt;B starts preparing&lt;/li&gt;
	&lt;li&gt;A times out waiting for B to prepare&lt;/li&gt;
	&lt;li&gt;B finishes preparing and marks a bunch of sstables as being repaired&lt;/li&gt;
	&lt;li&gt;User retries the repair on node A&lt;/li&gt;
	&lt;li&gt;B gets the new PrepareMessage but sees that the sstables it wants to repair are already being repaired, and refuses to start&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;One solution could be to have A send out a cancel message, another solution could be to have B remove any parent repair sessions after 5 (or something) minutes if it hasn&apos;t received a validation message before that. Need &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; input.&lt;/p&gt;</comment>
                            <comment id="14266614" author="yukim" created="Tue, 6 Jan 2015 19:33:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;4. B finishes preparing and marks a bunch of sstables as being repaired&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;B does not mark sstables as repaired for just receiving prepare message, doesn&apos;t it?&lt;/p&gt;

&lt;p&gt;I understand that the current issue we have is prepared repair session is left on replica nodes when preparing timed out on coordinator.&lt;br/&gt;
(In that case, user can work around by doing &quot;forceTerminateRepairSession&quot; manually.)&lt;/p&gt;

&lt;p&gt;I prefer sending cancel message, though adding new message may be difficult in minor release. Also we have to make sure message won&apos;t get dropped since AntiEntropyStage may be still busy preparing when cancel message arrives.&lt;/p&gt;

&lt;p&gt;Alternatively, I think the right solution to automatically remove left sessions is to track repair status as we do in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5839&quot; title=&quot;Save repair data to system table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5839&quot;&gt;&lt;del&gt;CASSANDRA-5839&lt;/del&gt;&lt;/a&gt; and use that to determine which prepared session can be removed.&lt;/p&gt;

&lt;p&gt;Either way, I think we can move this to resolve in 3.0 if I didn&apos;t miss the severity of the issue.&lt;/p&gt;</comment>
                            <comment id="14267561" author="krummas" created="Wed, 7 Jan 2015 12:11:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;B does not mark sstables as repaired for just receiving prepare message, doesn&apos;t it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;no - but it keeps the sstables in a set to make sure that we don&apos;t start multiple repairs including the same sstables - this would be pretty pointless as the sstables will be gone after anticompaction and can&apos;t be marked&lt;/p&gt;

&lt;p&gt;I also think it is &apos;good enough&apos; for now to let it fail and let users clean up manually (since incremental repairs are not default in 2.1)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; could you review the patch as well? Pushed rebased here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8316&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8316&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14268355" author="aboudreault" created="Wed, 7 Jan 2015 22:08:54 +0000"  >&lt;p&gt;I did more tests during the afternoon and it looks like I can get the cluster in a correct state after getting the issues. Either by using forceTerminateAllRepairSessions, restarting the cluster or running more repairs. Failed repairs seem to get fixed at a certain point.&lt;/p&gt;

&lt;p&gt;I think we are good with that patch then! BTW, I&apos;ve attached a v3 patch, which simply add a import line so we can get the compilation ok.&lt;/p&gt;</comment>
                            <comment id="14273795" author="yukim" created="Mon, 12 Jan 2015 17:20:26 +0000"  >&lt;p&gt;LGTM. +1.&lt;/p&gt;</comment>
                            <comment id="14284346" author="aboudreault" created="Tue, 20 Jan 2015 20:21:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;, is it planned to include this one in 2.1.3 release?&lt;/p&gt;</comment>
                            <comment id="14284349" author="krummas" created="Tue, 20 Jan 2015 20:23:42 +0000"  >&lt;p&gt;oops, yes, will get it committed tomorrow&lt;/p&gt;</comment>
                            <comment id="14285410" author="krummas" created="Wed, 21 Jan 2015 09:40:36 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12757352">CASSANDRA-8366</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12826038">CASSANDRA-9266</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12787842">CASSANDRA-9109</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12684882" name="0001-patch.patch" size="7719" author="marcuse" created="Wed, 3 Dec 2014 12:27:42 +0000"/>
                            <attachment id="12686855" name="8316-v2.patch" size="18268" author="marcuse" created="Fri, 12 Dec 2014 15:04:53 +0000"/>
                            <attachment id="12690639" name="8316-v3.patch" size="18031" author="aboudreault" created="Wed, 7 Jan 2015 22:08:54 +0000"/>
                            <attachment id="12683640" name="CassandraDaemon-2014-11-25-2.snapshot.tar.gz" size="3550666" author="aboudreault" created="Tue, 25 Nov 2014 20:05:41 +0000"/>
                            <attachment id="12687143" name="CassandraDaemon-2014-12-14.snapshot.tar.gz" size="8456403" author="aboudreault" created="Sun, 14 Dec 2014 21:58:02 +0000"/>
                            <attachment id="12683604" name="test.sh" size="407" author="aboudreault" created="Tue, 25 Nov 2014 17:43:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22ddz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aboudreault</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>