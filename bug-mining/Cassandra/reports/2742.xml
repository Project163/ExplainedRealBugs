<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6818] SSTable references not released if stream session fails before it starts</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6818</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I observed a large number of &apos;orphan&apos; SSTables - SSTables that are in the data directory but not loaded by Cassandra - on a 1.1.12 node that had a large stream fail before it started. These orphan files are particularly dangerous because if the node is restarted and picks up these SSTables it could bring data back to life if tombstones have been GCed. To confirm the SSTables are orphan, I created a snapshot and it didn&apos;t contain these files. I can see in the logs that they have been compacted so should have been deleted.&lt;/p&gt;

&lt;p&gt;The log entries for the stream are:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2014-02-21 19:41:48,742 StreamOut.java (line 115) Beginning transfer to /10.0.0.1&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2014-02-21 19:41:48,743 StreamOut.java (line 96) Flushing memtables for &lt;span class=&quot;error&quot;&gt;&amp;#91;CFS(Keyspace=&amp;#39;ks&amp;#39;, ColumnFamily=&amp;#39;cf1&amp;#39;), CFS(Keyspace=&amp;#39;ks&amp;#39;, ColumnFamily=&amp;#39;cf2&amp;#39;)&amp;#93;&lt;/span&gt;...&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;GossipTasks:1&amp;#93;&lt;/span&gt; 2014-02-21 19:41:49,239 AbstractStreamSession.java (line 113) Stream failed because /10.0.0.1 died or was restarted/removed (streams may still be active in background, but further streams won&apos;t be started)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2014-02-21 19:41:51,783 StreamOut.java (line 161) Stream context metadata &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; 2267 sstables.&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2014-02-21 19:41:51,789 StreamOutSession.java (line 182) Streaming to /10.0.0.1&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Streaming to /10.0.0.1:1&amp;#93;&lt;/span&gt; 2014-02-21 19:42:02,218 FileStreamTask.java (line 99) Found no stream out session at end of file stream task - this is expected if the receiver went down&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;After digging in the code, here&apos;s what I think the issue is:&lt;/p&gt;

&lt;p&gt;1. StreamOutSession.transferRanges() creates a streaming session, which is registered with the failure detector in AbstractStreamSession&apos;s constructor.&lt;br/&gt;
2. Memtables are flushed, potentially taking a long time.&lt;br/&gt;
3. The remote node fails, convict() is called and the StreamOutSession is closed. However, at this time StreamOutSession.files is empty because it&apos;s still waiting for the memtables to flush.&lt;br/&gt;
4. Memtables finish flusing, references are obtained to SSTables to be streamed and the PendingFiles are added to StreamOutSession.files.&lt;br/&gt;
5. The first stream fails but the StreamOutSession isn&apos;t found so is never closed and the references are never released.&lt;/p&gt;

&lt;p&gt;This code is more or less the same on 1.2 so I would expect it to reproduce there. I looked at 2.0 and can&apos;t even see where SSTable references are released when the stream fails.&lt;/p&gt;

&lt;p&gt;Some possible fixes for 1.1/1.2:&lt;/p&gt;

&lt;p&gt;1. Don&apos;t register with the failure detector until after the PendingFiles are set up. I think this is the behaviour in 2.0 but I don&apos;t know if it was done like this to avoid this issue.&lt;br/&gt;
2. Detect the above case in (e.g.) StreamOutSession.begin() by noticing the session has been closed with care to avoid double frees.&lt;br/&gt;
3. Add some synchronization so closeInternal() doesn&apos;t race with setting up the session.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12699420">CASSANDRA-6818</key>
            <summary>SSTable references not released if stream session fails before it starts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="rlow">Richard Low</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Mar 2014 14:08:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:52 +0000</updated>
                            <resolved>Thu, 3 Apr 2014 21:20:34 +0000</resolved>
                                        <fixVersion>1.2.16</fixVersion>
                    <fixVersion>2.0.7</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13923898" author="jasobrown" created="Fri, 7 Mar 2014 14:19:56 +0000"  >&lt;p&gt;We fixed this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6503&quot; title=&quot;sstables from stalled repair sessions become live after a reboot and can resurrect deleted data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6503&quot;&gt;&lt;del&gt;CASSANDRA-6503&lt;/del&gt;&lt;/a&gt;, but that was only patched for 1.2 and above. As we&apos;re not really maintaining 1.1 any longer, I suggest you take the 1.2 patch from that ticket and apply to 1.1 (it should be reasonably easily).&lt;/p&gt;</comment>
                            <comment id="13923916" author="rlow" created="Fri, 7 Mar 2014 14:37:15 +0000"  >&lt;p&gt;We do see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6503&quot; title=&quot;sstables from stalled repair sessions become live after a reboot and can resurrect deleted data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6503&quot;&gt;&lt;del&gt;CASSANDRA-6503&lt;/del&gt;&lt;/a&gt; as another source of orphans, but I think there are two separate issues. In particular, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6503&quot; title=&quot;sstables from stalled repair sessions become live after a reboot and can resurrect deleted data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6503&quot;&gt;&lt;del&gt;CASSANDRA-6503&lt;/del&gt;&lt;/a&gt; creates orphans on failed stream in whereas this issue creates orphans on failed stream out. &lt;/p&gt;</comment>
                            <comment id="13924048" author="yukim" created="Fri, 7 Mar 2014 16:53:07 +0000"  >&lt;p&gt;I think Richard is right, and the same thing can happen to 2.0+.&lt;br/&gt;
Considering fixing up to trunk, I think our option is No.2 on the above list.&lt;/p&gt;</comment>
                            <comment id="13926397" author="yukim" created="Mon, 10 Mar 2014 22:57:49 +0000"  >&lt;p&gt;Attaching patch for 1.2 and 2.0(and later).&lt;/p&gt;

&lt;p&gt;For 1.2, I decided to go with No.1 of Richard&apos;s proposal, defer register to FD and Gossiper until files are set up. 2.0 already does this and it is easy to fix the problem.&lt;br/&gt;
the &lt;br/&gt;
Although 2.0 defers FD/Gossiper registration, the way it releases reference can cause problem. Right now it releases immediately after the file is sent, so when the retry or session failure happens reference will not be released. So for 2.0, I changed to release reference when sender receives  ACK from receiver or when StreamSession fails for whatever reason.&lt;/p&gt;</comment>
                            <comment id="13929966" author="jbellis" created="Tue, 11 Mar 2014 05:15:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kohlisankalp&quot; class=&quot;user-hover&quot; rel=&quot;kohlisankalp&quot;&gt;kohlisankalp&lt;/a&gt; to review?&lt;/p&gt;</comment>
                            <comment id="13930038" author="kohlisankalp" created="Tue, 11 Mar 2014 07:19:33 +0000"  >&lt;p&gt;Sure. &lt;/p&gt;</comment>
                            <comment id="13930187" author="rlow" created="Tue, 11 Mar 2014 10:19:24 +0000"  >&lt;p&gt;I looked at the 1.2 patch, it looks fine. I&apos;ll see if I can reproduce the original issue to verify.&lt;/p&gt;

&lt;p&gt;In StreamInSession.get, there is a minor memory leak - if another thread simultaneously creates the same session, the one that is discarded remains registered with the gossiper. This was present before, but we could easily fix it in this patch by delaying the registration until after the putIfAbsent succeeds.&lt;/p&gt;</comment>
                            <comment id="13935072" author="rlow" created="Fri, 14 Mar 2014 14:31:12 +0000"  >&lt;p&gt;I reproduced on 1.2 by inserting a sleep to delay the flushing. I killed a bootstrapping node during the sleep and references were leaked. With this patch, no references were leaked. So +1 for the 1.2 patch.&lt;/p&gt;</comment>
                            <comment id="13935193" author="jbellis" created="Fri, 14 Mar 2014 16:11:26 +0000"  >&lt;p&gt;Can you also look at the 2.0 patch, Richard?&lt;/p&gt;</comment>
                            <comment id="13935504" author="rlow" created="Fri, 14 Mar 2014 19:29:02 +0000"  >&lt;p&gt;Sure, I&apos;ll do a similar test next week.&lt;/p&gt;</comment>
                            <comment id="13941087" author="rlow" created="Wed, 19 Mar 2014 22:28:06 +0000"  >&lt;p&gt;I reproduced the original problem in the same way, and the patch fixed it.&lt;/p&gt;

&lt;p&gt;But I&apos;m concerned about moving the reference release to StreamTransferTask.complete(). This is only called when the receiver sends a completed message, which may never occur. In this case I think the streaming session hangs, so we would never release the reference. However, the original behavior was also wrong because a retry could be requested after a successful transfer. The reference will have been released so the file may have been removed.&lt;/p&gt;

&lt;p&gt;We could add a timeout to catch the case when the completed message gets lost. If the node requests a retry after this time, there may be no reference so the stream would fail. That&apos;s probably OK in this rare case though.&lt;/p&gt;</comment>
                            <comment id="13943750" author="yukim" created="Sat, 22 Mar 2014 00:03:31 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rlow&quot; class=&quot;user-hover&quot; rel=&quot;rlow&quot;&gt;rlow&lt;/a&gt;.&lt;br/&gt;
I attached v2 to schedule timeout to release reference when not received ack after file is sent. I put hard coded 30min for timeout, but maybe we can set it longer.&lt;/p&gt;</comment>
                            <comment id="13944974" author="yukim" created="Mon, 24 Mar 2014 12:45:57 +0000"  >&lt;p&gt;Committed 1.2. version to be released in 1.2.16.&lt;/p&gt;</comment>
                            <comment id="13945924" author="rlow" created="Tue, 25 Mar 2014 00:40:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; I think this is a good approach, but I think there are some issues:&lt;/p&gt;

&lt;p&gt;1. If the timeout runnable races with complete() then the SSTable could be freed twice and cause it to be incorrectly deleted. This is unlikely, but the impact is pretty bad.&lt;br/&gt;
2. The timeout should remove the file from files (and files should become a thread-safe data structure) and call session.taskCompleted if files.isEmpty().&lt;br/&gt;
3. I&apos;m not sure, but I think timeoutExecutor should be shutdown otherwise there is a risk the non-daemon thread will stop the JVM exiting.&lt;/p&gt;</comment>
                            <comment id="13957134" author="yukim" created="Tue, 1 Apr 2014 23:19:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rlow&quot; class=&quot;user-hover&quot; rel=&quot;rlow&quot;&gt;rlow&lt;/a&gt; Thanks for reviewing.&lt;br/&gt;
I attached updated version that I hope will clear concurrency issue your pointed out.&lt;/p&gt;</comment>
                            <comment id="13957537" author="krummas" created="Wed, 2 Apr 2014 11:01:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; could this be the cause of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6568&quot; title=&quot;sstables incorrectly getting marked as &amp;quot;not live&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6568&quot;&gt;&lt;del&gt;CASSANDRA-6568&lt;/del&gt;&lt;/a&gt; as well?&lt;/p&gt;</comment>
                            <comment id="13957667" author="yukim" created="Wed, 2 Apr 2014 14:01:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; This can make SSTables that are compacted but not deleted. But for the SSTable in system/hints that cburroughs saw is different story since there should be no stream involved.&lt;/p&gt;</comment>
                            <comment id="13957886" author="rlow" created="Wed, 2 Apr 2014 16:58:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; looking better, a couple more issues though:&lt;/p&gt;

&lt;p&gt;1. The timeoutExecutor shouldn&apos;t be static any more now it&apos;s per task&lt;br/&gt;
2. When the timeout occurs, inside StreamTransferTask.complete, timeoutTask.cancel is called while running the task. It&apos;s unclear from the java.util.concurrent code how safe this is. Did you test it? If it doesn&apos;t work a simple solution is to remove the task from timeoutTasks from within the runnable before calling complete.&lt;/p&gt;</comment>
                            <comment id="13958483" author="yukim" created="Thu, 3 Apr 2014 03:16:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rlow&quot; class=&quot;user-hover&quot; rel=&quot;rlow&quot;&gt;rlow&lt;/a&gt; Good catch.&lt;br/&gt;
I removed static from timeoutExecutor and moved task removal code.&lt;br/&gt;
I also added task cancel to createMessageForRetry since we want reschedule time out for that retry message.&lt;br/&gt;
Other change I made is set time out time to 12 hours instead of 30 min which is too short for sending large file.&lt;/p&gt;

&lt;p&gt;Patch also includes simple unit test.&lt;/p&gt;</comment>
                            <comment id="13959007" author="rlow" created="Thu, 3 Apr 2014 17:28:14 +0000"  >&lt;p&gt;Great, +1.&lt;/p&gt;</comment>
                            <comment id="13959237" author="yukim" created="Thu, 3 Apr 2014 21:20:34 +0000"  >&lt;p&gt;Committed, thanks for review!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12732175">CASSANDRA-7704</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12633805" name="6818-1.2.txt" size="3374" author="yukim" created="Mon, 10 Mar 2014 22:57:49 +0000"/>
                            <attachment id="12636150" name="6818-2.0-v2.txt" size="6533" author="yukim" created="Sat, 22 Mar 2014 00:03:31 +0000"/>
                            <attachment id="12638151" name="6818-2.0-v3.txt" size="6641" author="yukim" created="Tue, 1 Apr 2014 23:19:07 +0000"/>
                            <attachment id="12638403" name="6818-2.0-v4.txt" size="10214" author="yukim" created="Thu, 3 Apr 2014 03:16:36 +0000"/>
                            <attachment id="12633806" name="6818-2.0.txt" size="3848" author="yukim" created="Mon, 10 Mar 2014 22:57:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>377767</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1t3e7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>378059</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324332">1.1.12</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rlow</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[rlow]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324332">1.1.12</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>