<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4402] Atomicity violation bugs because of misusing concurrent collections</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4402</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;My name is Yu Lin. I&apos;m a Ph.D. student in the CS department at&lt;br/&gt;
UIUC. I&apos;m currently doing research on mining Java concurrent library&lt;br/&gt;
misusages. I found some misusages of ConcurrentHashMap in Cassandra&lt;br/&gt;
1.1.1, which may result in potential atomicity violation bugs or harm&lt;br/&gt;
the performance.&lt;/p&gt;

&lt;p&gt;The code below is a snapshot of the code in file&lt;br/&gt;
src/java/org/apache/cassandra/db/Table.java from line 348 to 369&lt;/p&gt;

&lt;p&gt;L348        if (columnFamilyStores.containsKey(cfId))&lt;br/&gt;
L349        &lt;/p&gt;
{
L350            // this is the case when you reset local schema
L351            // just reload metadata
L352            ColumnFamilyStore cfs = columnFamilyStores.get(cfId);
L353            assert cfs.getColumnFamilyName().equals(cfName);
            ...
L364        }
&lt;p&gt;L365        else&lt;br/&gt;
L366        &lt;/p&gt;
{
L367            columnFamilyStores.put(cfId, ColumnFamilyStore.createColumnFamilyStore(this, cfName));
L368        }

&lt;p&gt;In the code above, an atomicity violation may occur between line 348&lt;br/&gt;
and 352. Suppose thread T1 executes line 348 and finds that the&lt;br/&gt;
concurrent hashmap &quot;columnFamilyStores&quot; contains the key&lt;br/&gt;
&quot;cfId&quot;. Before thread T1 executes line 352, another thread T2 removes&lt;br/&gt;
the &quot;cfId&quot; key from &quot;columnFamilyStores&quot;. Now thread T1 resumes&lt;br/&gt;
execution at line 352 and will get a null value for &quot;cfs&quot;. Then the&lt;br/&gt;
next line will throw a NullPointerException when invoking the method&lt;br/&gt;
on &quot;cfs&quot;.&lt;/p&gt;

&lt;p&gt;Second, the snapshot above has another atomicity violation. Let&apos;s look&lt;br/&gt;
at lines 348 and 367. Suppose a thread T1 executes line 348 and finds&lt;br/&gt;
out the concurrent hashmap does not contain the key &quot;cfId&quot;. Before it&lt;br/&gt;
gets to execute line 367, another thread T2 puts a pair &amp;lt;cfid, v&amp;gt; in&lt;br/&gt;
the concurrent hashmap &quot;columnFamilyStores&quot;. Now thread T1 resumes&lt;br/&gt;
execution and it will overwrite the value written by thread T2. Thus,&lt;br/&gt;
the code no longer preserves the &quot;put-if-absent&quot; semantics.&lt;/p&gt;

&lt;p&gt;I found some similar misusages in other files:&lt;/p&gt;

&lt;p&gt;In src/java/org/apache/cassandra/gms/Gossiper.java, similar atomicity&lt;br/&gt;
violation may occur if thread T2 puts a value to map&lt;br/&gt;
&quot;endpointStateMap&quot; between lines &amp;lt;1094 and 1099&amp;gt;, &amp;lt;1173 and 1178&amp;gt;. Another&lt;br/&gt;
atomicity violation may occur if thread T2 removes the value on key&lt;br/&gt;
&quot;endpoint&quot; between lines &amp;lt;681 and 683&amp;gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596739">CASSANDRA-4402</key>
            <summary>Atomicity violation bugs because of misusing concurrent collections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jacklondongood">Yu Lin</assignee>
                                    <reporter username="jacklondongood">Yu Lin</reporter>
                        <labels>
                            <label>gossip</label>
                    </labels>
                <created>Mon, 2 Jul 2012 20:40:27 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:31 +0000</updated>
                            <resolved>Fri, 9 Nov 2012 22:09:19 +0000</resolved>
                                        <fixVersion>1.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="1814400">504h</timeoriginalestimate>
                            <timeestimate seconds="1814400">504h</timeestimate>
                                        <comments>
                            <comment id="13405386" author="jacklondongood" created="Mon, 2 Jul 2012 22:15:24 +0000"  >&lt;p&gt;This is the patch that may fix the atomicity violation problem.&lt;/p&gt;</comment>
                            <comment id="13405421" author="jbellis" created="Mon, 2 Jul 2012 23:03:15 +0000"  >&lt;p&gt;Thanks for the patch, Yu.  The getExpireTimeForEndpoint is the most serious since we can fairly easily have concurrent contains with remove calls.  maybeInitializeLocalState shouldn&apos;t be called concurrently but it doesn&apos;t hurt to clean that up too.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what to do about Table.initCf, though.  It seems like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2963&quot; title=&quot;Add a convenient way to reset a node&amp;#39;s schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2963&quot;&gt;&lt;del&gt;CASSANDRA-2963&lt;/del&gt;&lt;/a&gt; has made that inherently unsafe.  A &quot;mechanical&quot; fix like the one here won&apos;t help since if two CFS objects are created for the same CF, they will conflict on the mbean definition as well.  I&apos;ll follow up on that over on the 2963 ticket.&lt;/p&gt;

&lt;p&gt;In the meantime, v2 is attached with some cleanup.&lt;/p&gt;</comment>
                            <comment id="13493219" author="slebresne" created="Thu, 8 Nov 2012 14:30:37 +0000"  >&lt;p&gt;That v2 patch lgtm on principle from reading the patch, but it&apos;ll need to be rebased.&lt;/p&gt;</comment>
                            <comment id="13494350" author="jbellis" created="Fri, 9 Nov 2012 22:09:19 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13494352" author="jbellis" created="Fri, 9 Nov 2012 22:11:25 +0000"  >&lt;p&gt;(with comments explaining the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2963&quot; title=&quot;Add a convenient way to reset a node&amp;#39;s schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2963&quot;&gt;&lt;del&gt;CASSANDRA-2963&lt;/del&gt;&lt;/a&gt; situation)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12534477" name="4402-v2.txt" size="6173" author="jbellis" created="Mon, 2 Jul 2012 23:03:15 +0000"/>
                            <attachment id="12534467" name="cassandra-1.1.1-4402.txt" size="4144" author="jacklondongood" created="Mon, 2 Jul 2012 22:21:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jacklondongood]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>255954</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fw9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>