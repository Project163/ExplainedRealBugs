<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6648] Race condition during node bootstrapping</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6648</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When bootstrapping a new node, data is &quot;missing&quot; as if the new node didn&apos;t actually bootstrap, which I tracked down to the following scenario:&lt;/p&gt;

&lt;p&gt;1) New node joins token ring and waits for schema to be settled before actually bootstrapping.&lt;br/&gt;
2) The schema scheck somewhat passes and it starts bootstrapping.&lt;br/&gt;
3) Bootstrapping doesn&apos;t find the ks/cf that should have received from the other node.&lt;br/&gt;
4) Queries at this point cause NPEs, until when later they &quot;recover&quot; but data is missed.&lt;/p&gt;

&lt;p&gt;The problem seems to be caused by a race condition between the migration manager and the bootstrapper, with the former running after the latter.&lt;br/&gt;
I think this is supposed to protect against such scenarios:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            while (!MigrationManager.isReadyForBootstrap())
            {
                setMode(Mode.JOINING, &quot;waiting for schema information to complete&quot;, true);
                Uninterruptibles.sleepUninterruptibly(1, TimeUnit.SECONDS);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But MigrationManager.isReadyForBootstrap() implementation is quite fragile and doesn&apos;t take into account &quot;slow&quot; schema propagation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12693094">CASSANDRA-6648</key>
            <summary>Race condition during node bootstrapping</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sbtourist">Sergio Bossa</assignee>
                                    <reporter username="sbtourist">Sergio Bossa</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Tue, 4 Feb 2014 12:37:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:55 +0000</updated>
                            <resolved>Wed, 5 Feb 2014 00:37:41 +0000</resolved>
                                        <fixVersion>1.2.15</fixVersion>
                    <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13890618" author="brandon.williams" created="Tue, 4 Feb 2014 12:40:25 +0000"  >&lt;p&gt;How many keyspaces/CFs are defined when this occurs?&lt;/p&gt;</comment>
                            <comment id="13890621" author="sbtourist" created="Tue, 4 Feb 2014 12:45:06 +0000"  >&lt;p&gt;I reproduced running cassandra-stress: two times in a row by running a local node, inserting 1000 keys, and then bootstrapping a second node.&lt;/p&gt;</comment>
                            <comment id="13890793" author="sbtourist" created="Tue, 4 Feb 2014 16:02:30 +0000"  >&lt;p&gt;The race condition is caused by a change applied in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6615&quot; title=&quot;Changing the IP of a node on a live cluster leaves gossip infos and throws Exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6615&quot;&gt;&lt;del&gt;CASSANDRA-6615&lt;/del&gt;&lt;/a&gt;, which doesn&apos;t check for the endpoint to be &quot;not alive&quot; in order to be a fat client.&lt;/p&gt;

&lt;p&gt;As a consequence, during bootstrap, the seed node is considered a fat client (because it &lt;b&gt;is&lt;/b&gt; alive but has no tokens yet), and no schema pull is executed by the MigrationManager.&lt;/p&gt;

&lt;p&gt;This patch fixes the Gossiper by adding back the &quot;isAlive&quot; check (it shouldn&apos;t cause any actual problems, but given my limited understanding of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6615&quot; title=&quot;Changing the IP of a node on a live cluster leaves gossip infos and throws Exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6615&quot;&gt;&lt;del&gt;CASSANDRA-6615&lt;/del&gt;&lt;/a&gt;, I could be totally wrong), and makes the MigrationManager more robust against such race conditions by having the isReadyForBootstrap method check the schema version against the pre-bootstrap empty one, so that the bootstrap process will not make any progress if the schema is not correctly pulled (which is imho a big improvement over silently failing).&lt;/p&gt;</comment>
                            <comment id="13890834" author="brandon.williams" created="Tue, 4 Feb 2014 16:41:42 +0000"  >&lt;p&gt;v2 builds on Sergio&apos;s patch, but changes the gossiper&apos;s own fat client check (not isFatClient) to ignore epstate.isAlive and just rely on the timestamp of the last update and membership.&lt;/p&gt;</comment>
                            <comment id="13890843" author="sbtourist" created="Tue, 4 Feb 2014 16:51:36 +0000"  >&lt;p&gt;Works for me.&lt;/p&gt;</comment>
                            <comment id="13891217" author="brandon.williams" created="Tue, 4 Feb 2014 21:15:44 +0000"  >&lt;p&gt;Thinking about this a bit more, I&apos;m inclined to think that a) isFatClient should never have checked epState.isAlive, since a fat client can be either alive or dead, and neither make it more or less of a fat client, and thus b) onAlive is the wrong event for MM to be looking at to decide on pulling schema, since potentially &lt;b&gt;every&lt;/b&gt; node actually IS a fat client when first seen.  The true source of &apos;fatclientness&apos; or not is TMD.isMember, but SS hasn&apos;t processed the onJoin event yet when onAlive is called.  We could possibly fix this by having isFatClient check for the presence of TOKENS, which a fat client shouldn&apos;t have, or we could make SS.onJoin trigger MM.maybeScheduleSchemaPull after it has processed the join event.&lt;/p&gt;</comment>
                            <comment id="13891351" author="brandon.williams" created="Tue, 4 Feb 2014 22:54:13 +0000"  >&lt;p&gt;v3, influenced by my last comment, removes the MM subscription to gossip and instead is notified by SS after it has completed any onAlive/onJoin events.  isFatClient doesn&apos;t check aliveness, and MM.passiveAnnounce remains since that&apos;s the only way the schema state gets populated in gossip.&lt;/p&gt;</comment>
                            <comment id="13891414" author="enigmacurry" created="Tue, 4 Feb 2014 23:23:50 +0000"  >&lt;p&gt;Both 6648-v3.txt and 6648-v3-1.2.txt are +1 from me.&lt;/p&gt;

&lt;p&gt;Tested with the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm create bootstrap_bug
ccm populate -n 3
ccm start
ccm node1 stress -n 10000

# Bootstrap a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; node:
ccm add -b node4 -t 127.0.0.4:9160 -l 127.0.0.4:7000 -j 7400 --binary-itf 127.0.0.4:9042
ccm node4 start

# Query data from the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; node:
ccm node4 cqlsh

cqlsh&amp;gt;  select * from &lt;span class=&quot;code-quote&quot;&gt;&quot;Keyspace1&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;Standard1&quot;&lt;/span&gt; limit 10;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pre-patch, they both errored out saying &quot;Bad Request: Keyspace Keyspace1 does not exist&quot;. Now they come back with the data.&lt;/p&gt;</comment>
                            <comment id="13891446" author="sbtourist" created="Tue, 4 Feb 2014 23:45:14 +0000"  >&lt;p&gt;I&apos;ll have a better look tomorrow, but I think Schema.instance.updateVersionAndAnnounce() should be removed from StorageService#joinTokenRing, as it isn&apos;t really needed and could race by being concurrently called with schema merges.&lt;/p&gt;</comment>
                            <comment id="13891495" author="thobbs" created="Wed, 5 Feb 2014 00:22:09 +0000"  >&lt;p&gt;+1 on 6648-v3 and 6648-v3-1.2&lt;/p&gt;</comment>
                            <comment id="13891524" author="brandon.williams" created="Wed, 5 Feb 2014 00:37:41 +0000"  >&lt;p&gt;Committed, since v3 didn&apos;t change any logic with updateVersionAndAnnounce, just rearranged the event order.  If there&apos;s a race there let&apos;s open a new ticket for it.&lt;/p&gt;</comment>
                            <comment id="13891898" author="slebresne" created="Wed, 5 Feb 2014 07:52:21 +0000"  >&lt;p&gt;If this is a regression of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6615&quot; title=&quot;Changing the IP of a node on a live cluster leaves gossip infos and throws Exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6615&quot;&gt;&lt;del&gt;CASSANDRA-6615&lt;/del&gt;&lt;/a&gt;, it doesn&apos;t affect 2.0.4, does it? (asking because of the current &apos;reproduced in&apos;).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt; would be great if you could push that test of yours above as a dtest.&lt;/p&gt;</comment>
                            <comment id="13891958" author="sbtourist" created="Wed, 5 Feb 2014 09:51:19 +0000"  >&lt;p&gt;Works for me.&lt;/p&gt;

&lt;p&gt;Regarding the Schema.instance.updateVersionAndAnnounce() call inside StorageService#joinTokenRing, it&apos;s definitely race-prone with regard to Gossiper notifications causing a major state change and a schema update (which I reproduced by using breakpoints on the two concurrent threads): but, even if a lost update can occur and re-establish an empty version, I verified the correct schema version is later recomputed by another schema pull, hence this shouldn&apos;t cause any actual problems.&lt;/p&gt;</comment>
                            <comment id="13892214" author="enigmacurry" created="Wed, 5 Feb 2014 15:15:52 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Ryan McGuire would be great if you could push that test of yours above as a dtest.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/17e8f3f5680f6d78755577d8817b1eeb64b642d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Done&lt;/a&gt;. We already have a few different tests to catch this, but all were being masked for one reason or another &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12693248">CASSANDRA-6650</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12626896" name="6648-v2.txt" size="3755" author="brandon.williams" created="Tue, 4 Feb 2014 16:41:42 +0000"/>
                            <attachment id="12627020" name="6648-v3-1.2.txt" size="5628" author="brandon.williams" created="Tue, 4 Feb 2014 23:14:46 +0000"/>
                            <attachment id="12627010" name="6648-v3.txt" size="5814" author="brandon.williams" created="Tue, 4 Feb 2014 22:54:13 +0000"/>
                            <attachment id="12626888" name="CASSANDRA-6648.patch" size="3377" author="sbtourist" created="Tue, 4 Feb 2014 16:02:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sbtourist]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371680</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s20n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371980</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325746">1.2.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325746">1.2.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>enigmacurry</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>