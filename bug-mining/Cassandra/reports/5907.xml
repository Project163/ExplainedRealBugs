<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:23:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14898] Key cache loading is very slow when there are many SSTables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14898</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While dealing with a production issue today where some 3.0.17 nodes had close to ~8k sstables on disk due to excessive write pressure, we had a few nodes crash due to OOM and then they took close to 17 minutes to load the key cache and recover. This excessive key cache load significantly increased the duration of the outage (to mitigate we just removed the saved key cache files). For example here is one example taking 17 minutes to load 10k keys, or about 10 keys per second (which is ... very slow):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [pool-3-thread-1] 2018-11-15 21:50:21,885 AutoSavingCache.java:190 - reading saved cache /mnt/data/cassandra/saved_caches/KeyCache-d.db
INFO  [pool-3-thread-1] 2018-11-15 22:07:16,490 AutoSavingCache.java:166 - Completed loading (1014606 ms; 10103 keys) KeyCache cache
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;ve witnessed similar behavior in the past with large LCS clusters, and indeed it appears that any time the number of sstables is large, KeyCache loading takes a &lt;em&gt;really&lt;/em&gt; long time. Today I got a flame graph and I believe that I found the issue and I think it&apos;s reasonably easy to fix. From what I can tell the &lt;tt&gt;KeyCacheSerializer::deserialize&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/06209037ea56b5a2a49615a99f1542d6ea1b2947/src/java/org/apache/cassandra/service/CacheService.java#L445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;method&#160;&lt;/a&gt;&#160;which is called for every&#160;key is linear in the number of sstables due to the &lt;a href=&quot;https://github.com/apache/cassandra/blob/06209037ea56b5a2a49615a99f1542d6ea1b2947/src/java/org/apache/cassandra/service/CacheService.java#L459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;call&lt;/a&gt; to &lt;tt&gt;ColumnFamilyStore::getSSTables&lt;/tt&gt; which ends up calling &lt;tt&gt;View::select&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/06209037ea56b5a2a49615a99f1542d6ea1b2947/src/java/org/apache/cassandra/db/lifecycle/View.java#L139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The &lt;tt&gt;View::select&lt;/tt&gt; call is linear in the number of sstables and causes a &lt;em&gt;lot&lt;/em&gt; of &lt;tt&gt;HashSet&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/06209037ea56b5a2a49615a99f1542d6ea1b2947/src/java/org/apache/cassandra/db/lifecycle/View.java#L139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;resizing&lt;/a&gt; when the number of sstables is much greater than 16 (the default size of the backing &lt;tt&gt;HashMap&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;As we see in the attached flamegraph we spend 50% of our CPU time in these &lt;tt&gt;getSSTable&lt;/tt&gt; calls, of which 36% is spent adding sstables to the HashSet in &lt;tt&gt;View::select&lt;/tt&gt; and 17% is spent just iterating the sstables in the first place. A full 16% of CPU time is spent &lt;em&gt;just resizing the HashMap&lt;/em&gt;. Then another 4% is spend calling&#160;&lt;tt&gt;CacheService::findDesc&lt;/tt&gt; which does &lt;a href=&quot;https://github.com/apache/cassandra/blob/06209037ea56b5a2a49615a99f1542d6ea1b2947/src/java/org/apache/cassandra/service/CacheService.java#L475&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a linear search&lt;/a&gt; for the sstable generation.&lt;/p&gt;

&lt;p&gt;I believe that this affects at least Cassandra 3.0.17 and trunk, and could be pretty easily fixed by either caching the getSSTables call or at the very least pre-sizing the &lt;tt&gt;HashSet&lt;/tt&gt; in &lt;tt&gt;View::select&lt;/tt&gt; to be the size of the sstables map.&lt;/p&gt;</description>
                <environment>&lt;p&gt;AWS i3.2xlarge, 4 physical cores (8 threads), 60GB of RAM, loading about 8MB of KeyCache with 10k keys in it.&lt;/p&gt;</environment>
        <key id="13198826">CASSANDRA-14898</key>
            <summary>Key cache loading is very slow when there are many SSTables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="n.v.harikrishna">n.v.harikrishna</assignee>
                                    <reporter username="jolynch">Joey Lynch</reporter>
                        <labels>
                            <label>Performance</label>
                            <label>low-hanging-fruit</label>
                    </labels>
                <created>Fri, 16 Nov 2018 05:37:32 +0000</created>
                <updated>Wed, 16 Mar 2022 08:53:04 +0000</updated>
                            <resolved>Thu, 9 Dec 2021 15:51:01 +0000</resolved>
                                        <fixVersion>3.0.26</fixVersion>
                    <fixVersion>3.11.12</fixVersion>
                    <fixVersion>4.0.2</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>14</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="16689062" author="djoshi3" created="Fri, 16 Nov 2018 06:07:36 +0000"  >&lt;p&gt;Interesting find. Have you tried pre-sizing the Map?&lt;/p&gt;</comment>
                            <comment id="16689081" author="jolynch" created="Fri, 16 Nov 2018 06:31:47 +0000"  >&lt;p&gt;Yup, pre-sizing the map should help some (~25% faster most likely), but I&apos;m currently looking into how hard it would be to just evaluate the &lt;tt&gt;getSSTables&lt;/tt&gt; call once and pass in a cached &lt;tt&gt;generation&lt;/tt&gt; -&amp;gt; &lt;tt&gt;SSTableReader&lt;/tt&gt; map to each de-serialize call. I can either add a lazily instantiated &lt;tt&gt;Map&amp;lt;Integer SSTableReader&amp;gt; sstableGenerationToReader&lt;/tt&gt; map to the &lt;tt&gt;KeyCacheSerializer&lt;/tt&gt; static class or I can add it to the &lt;tt&gt;CacheSerializer&lt;/tt&gt; interface (even though counter nor row would use it). I think the first one is maybe cleaner code but it does involve stateful serializers which is pretty meh as we have to somehow cleanup the HashMap.&lt;/p&gt;

&lt;p&gt;I&apos;m playing around a bit on how to test this change as well, the existing &lt;tt&gt;AutoSavingCacheTest&lt;/tt&gt; unit test is somewhat minimal from what I can tell, and I think for something like this a microbenchmark that creates like 10k sstables and just dumps the cache and then loads it a bunch might be a better way to test it.&lt;/p&gt;</comment>
                            <comment id="16693413" author="jolynch" created="Tue, 20 Nov 2018 16:10:23 +0000"  >&lt;p&gt;Started exploring caching the &lt;tt&gt;getSSTables&lt;/tt&gt;&#160;call in &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...jolynch:CASSANDRA-14898_30x&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a 3.0 branch&lt;/a&gt;. The strategy I ended up using was to add an optional &lt;tt&gt;cleanupAfterDeserialize&lt;/tt&gt; method to the &lt;tt&gt;CacheSerializer&lt;/tt&gt; interface that cleans up any cached state after deserializations because I felt it was the least invasive change that allowed us to fix this problem. I also considered splitting the &lt;tt&gt;CacheSerializer&lt;/tt&gt; interface into a &lt;tt&gt;CacheSerializer&lt;/tt&gt; and &lt;tt&gt;CacheDeserializer&lt;/tt&gt; class since that way the Deserializers wouldn&apos;t have to be static and could just throw away their state naturally at the end of a deserialization (since we only use them once afaik at startup) but I felt it was a more invasive change.&lt;/p&gt;

&lt;p&gt;I also wrote a quick &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...jolynch:CASSANDRA-14898_30x#diff-51c5d5cb6842a1aedbff457ba77dd424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;microbenchmark&lt;/a&gt; that creates 1000 small sstables and then does a keycache load and as expected my branch is about two orders of magnitude faster. I&apos;d expect it to reduce by the number of sstables which it did so that&apos;s good. Benchmark results:&lt;/p&gt;

&lt;p&gt;status quo:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                                     Mode  Cnt    Score    Error  Units
CacheLoaderBench.keyCacheLoadTest                           sample   25  167.458 &#177; 24.430  ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.00    sample       125.436           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.50    sample       164.364           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.90    sample       216.583           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.95    sample       231.106           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.99    sample       236.454           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.999   sample       236.454           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.9999  sample       236.454           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p1.00    sample       236.454           ms/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Pre-allocating the Hashmap:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                                     Mode  Cnt    Score    Error  Units
CacheLoaderBench.keyCacheLoadTest                           sample   28  149.801 &#177; 11.483  ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.00    sample       114.426           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.50    sample       147.980           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.90    sample       168.401           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.95    sample       181.941           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.99    sample       190.317           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.999   sample       190.317           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.9999  sample       190.317           ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p1.00    sample       190.317           ms/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Caching the entire &lt;tt&gt;getSSTables&lt;/tt&gt; call and using a generation map for O(1) lookup:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                                     Mode   Cnt   Score   Error  Units
CacheLoaderBench.keyCacheLoadTest                           sample  1101   3.190 &#177; 0.108  ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.00    sample         1.876          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.50    sample         2.863          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.90    sample         4.615          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.95    sample         5.161          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.99    sample         6.750          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.999   sample        14.178          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p0.9999  sample        14.205          ms/op
CacheLoaderBench.keyCacheLoadTest:keyCacheLoadTest&#183;p1.00    sample        14.205          ms/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So this would seem to indicate that the production traces are correct and the &lt;tt&gt;O&amp;#40;n&amp;#41;&lt;/tt&gt; traversal of the &lt;tt&gt;getSSTables&lt;/tt&gt; is the dominating factor.&lt;/p&gt;</comment>
                            <comment id="17266161" author="n.v.harikrishna" created="Fri, 15 Jan 2021 16:15:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; can I pick this ticket? I&#8217;m working on preparing a patch for this.&lt;/p&gt;</comment>
                            <comment id="17266171" author="jolynch" created="Fri, 15 Jan 2021 16:26:26 +0000"  >&lt;p&gt;Of course! I would be happy to review and merge the patch as well.&lt;/p&gt;</comment>
                            <comment id="17267041" author="n.v.harikrishna" created="Mon, 18 Jan 2021 06:49:40 +0000"  >&lt;p&gt;Changes are here:&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/nvharikrishna/cassandra/commit/c090ed640440b284686131ac73b3a6295cea27c0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nvharikrishna/cassandra/commit/c090ed640440b284686131ac73b3a6295cea27c0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Circle CI: &lt;a href=&quot;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra?branch=14898-keycache-performance-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra?branch=14898-keycache-performance-fix&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Tested locally in my laptop with 5000+ SSTables and these are the results observed:&lt;/p&gt;

&lt;p&gt;Before:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Test 1:
INFO [pool-3-thread-1] 2021-01-07 15:40:24,767 AutoSavingCache.java:177 - Completed loading (148997 ms; 589886 keys) KeyCache cache
Test 2:
INFO [pool-3-thread-1] 2021-01-07 16:55:23,327 AutoSavingCache.java:177 - Completed loading (99441 ms; 396405 keys) KeyCache cache
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO [pool-3-thread-1] 2021-01-08 17:54:11,402 AutoSavingCache.java:177 - Completed loading (8502 ms; 401358 keys) KeyCache cache&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17267071" author="n.v.harikrishna" created="Mon, 18 Jan 2021 08:06:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;&#160;I took your micro bench test and added it my branch: &lt;a href=&quot;https://github.com/nvharikrishna/cassandra/commits/14898-keycache-performance-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nvharikrishna/cassandra/commits/14898-keycache-performance-fix&lt;/a&gt;&#160;. Ran the test in my laptop without and with my changes and here are the results:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Without fix:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[java] Result &quot;org.apache.cassandra.test.microbench.CacheLoaderBench.keyCacheLoadTest&quot;:
 [java] N = 33
 [java] mean = 125.885 ?(99.9%) 5.067 ms/op
 [java]
 [java] Histogram, ms/op:
 [java] [110.000, 115.000) = 0
 [java] [115.000, 120.000) = 2
 [java] [120.000, 125.000) = 19
 [java] [125.000, 130.000) = 8
 [java] [130.000, 135.000) = 2
 [java] [135.000, 140.000) = 0
 [java] [140.000, 145.000) = 1
 [java] [145.000, 150.000) = 0
 [java] [150.000, 155.000) = 0
 [java] [155.000, 160.000) = 0
 [java] [160.000, 165.000) = 1
 [java]
 [java] Percentiles, ms/op:
 [java] p(0.0000) = 118.358 ms/op
 [java] p(50.0000) = 123.863 ms/op
 [java] p(90.0000) = 131.990 ms/op
 [java] p(95.0000) = 148.347 ms/op
 [java] p(99.0000) = 163.578 ms/op
 [java] p(99.9000) = 163.578 ms/op
 [java] p(99.9900) = 163.578 ms/op
 [java] p(99.9990) = 163.578 ms/op
 [java] p(99.9999) = 163.578 ms/op
 [java] p(100.0000) = 163.578 ms/op&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With fix:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[java] Result &quot;org.apache.cassandra.test.microbench.CacheLoaderBench.keyCacheLoadTest&quot;:
 [java] N = 277
 [java] mean = 14.093 ?(99.9%) 0.530 ms/op
 [java]
 [java] Histogram, ms/op:
 [java] [10.000, 11.250) = 0
 [java] [11.250, 12.500) = 118
 [java] [12.500, 13.750) = 50
 [java] [13.750, 15.000) = 27
 [java] [15.000, 16.250) = 16
 [java] [16.250, 17.500) = 20
 [java] [17.500, 18.750) = 23
 [java] [18.750, 20.000) = 16
 [java] [20.000, 21.250) = 6
 [java] [21.250, 22.500) = 1
 [java] [22.500, 23.750) = 0
 [java] [23.750, 25.000) = 0
 [java] [25.000, 26.250) = 0
 [java] [26.250, 27.500) = 0
 [java] [27.500, 28.750) = 0
 [java]
 [java] Percentiles, ms/op:
 [java] p(0.0000) = 11.289 ms/op
 [java] p(50.0000) = 13.238 ms/op
 [java] p(90.0000) = 18.468 ms/op
 [java] p(95.0000) = 19.218 ms/op
 [java] p(99.0000) = 20.588 ms/op
 [java] p(99.9000) = 22.053 ms/op
 [java] p(99.9900) = 22.053 ms/op
 [java] p(99.9990) = 22.053 ms/op
 [java] p(99.9999) = 22.053 ms/op
 [java] p(100.0000) = 22.053 ms/op&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17267378" author="jolynch" created="Mon, 18 Jan 2021 15:47:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt;&#160;thank you for the patch! I just took a quick look at it (it&apos;s a holiday here but I will review more closely tomorrow), but is the gist of the patch that we skip copying the sstables into a new hash set (by just pushing the filter down to the View) but still perform a &lt;tt&gt;O( n )&lt;/tt&gt;&#160;scan over those tables just within the View?&lt;/p&gt;

&lt;p&gt;I think the API that&apos;s been introduced into View isn&apos;t problematic in that it seems generic and useful, but I&apos;m curious is there a reason you preferred that to the generation cache approach in the initial proof of concept patch? I guess the tradeoff is making the CacheService implementations potentially stateful (introducing a new contract that AutoSavingCache will call a function at the end)?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17268097" author="n.v.harikrishna" created="Tue, 19 Jan 2021 18:03:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;is the gist of the patch that we skip copying the sstables into a new hash set (by just pushing the filter down to the View) but still perform a &lt;tt&gt;O(  n  )&lt;/tt&gt;&#160;scan over those tables just within the View?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, wanted to avoid copying lots of SSTables to hash set when we need only one. View&apos;s &lt;em&gt;find&lt;/em&gt; method don&apos;t do O( n ) scans all the times. In a normal case, find method stops at the fist entry (all SSTables generation would be same). I think it will require ( O( n ) scans for entry) in the case of upgrade and required generation SSTable is at end of the list. Added 60s for &lt;em&gt;get&lt;/em&gt; to avoid waiting forever.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I guess the tradeoff is making the CacheService implementations potentially stateful (introducing a new contract that AutoSavingCache will call a function at the end)?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thought of avoiding state across calls.&#160;&lt;em&gt;CacheService&#160;deserialize&lt;/em&gt; method is called for each entry. Things would have been easier if&#160;&lt;em&gt;deserialize&lt;/em&gt; method returns all keys instead of single key value pair (no need to maintain state across calls).&lt;/p&gt;</comment>
                            <comment id="17277761" author="n.v.harikrishna" created="Wed, 3 Feb 2021 07:30:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;&#160;Taking a step back and re-looking at my patch. Give me sometime.&lt;/p&gt;</comment>
                            <comment id="17296524" author="n.v.harikrishna" created="Sat, 6 Mar 2021 11:32:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;&#160;sorry, took long time to get back on this. I took your patch and tried it in my local env (with even more SStables: around 11k+) and it performed better than my patch. It loaded 400k+ keys with in a second where as my code changes took 8 to 9 seconds. It is worth maintaining state for this performance gain. I am fine with dropping my patch. Though I made a small change on top of your patch which is similar to my patch. Replaced find method with generic collect method so that copying SSTables into a new map can be avoided (&lt;a href=&quot;https://github.com/nvharikrishna/cassandra/commit/b26b5f17877b5d89698840e42a3c77a6629594f5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nvharikrishna/cassandra/commit/b26b5f17877b5d89698840e42a3c77a6629594f5&lt;/a&gt;). Probably splitting the CacheSerializer is an alternative (which you mentioned earlier) if not this solution.&lt;/p&gt;

&lt;p&gt;I have also tried to time bound the key and row cache loading by calling get method with specific time and cancelling it (may leave key cache entries in invalid state if not cancelled when compaction starts) if it couldn&apos;t finish. Cancelling it lead to serious problem. Cancelling the task interrupted the&#160;deserializer -&amp;gt; DataInputStream -&amp;gt; ChannelProxy which is throwing&#160; &lt;em&gt;java.nio.channels.ClosedByInterruptException&lt;/em&gt; as&#160;&lt;em&gt;org.apache.cassandra.io.FSReadError&lt;/em&gt;. FSReadError is treated as disk failure and instance is getting stopped as per disk failure policy. Pasting the stack trace here for reference.&#160;After looking at the performance improvement, I am not sure if it is worth digging down the path of modifying ChannelProxy to handle this case (not treating java.nio.channels.ClosedByInterruptException as error). So reverted the changes.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN [main] 2021-03-06 12:58:29,926 CassandraDaemon.java:346 - Cache did not load in given time. Cancelled loading of key and row cache. isCancelled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
ERROR [pool-3-thread-1] 2021-03-06 12:58:29,928 DefaultFSErrorHandler.java:104 - Exiting forcefully due to file system exception on startup, disk failure policy &lt;span class=&quot;code-quote&quot;&gt;&quot;stop&quot;&lt;/span&gt;
org.apache.cassandra.io.FSReadError: java.nio.channels.ClosedByInterruptException
 at org.apache.cassandra.io.util.ChannelProxy.read(ChannelProxy.java:143)
 at org.apache.cassandra.io.util.SimpleChunkReader.readChunk(SimpleChunkReader.java:41)
 at org.apache.cassandra.io.util.ChecksummedRebufferer.rebuffer(ChecksummedRebufferer.java:45)
 at org.apache.cassandra.io.util.RandomAccessReader.reBufferAt(RandomAccessReader.java:65)
 at org.apache.cassandra.io.util.RandomAccessReader.reBuffer(RandomAccessReader.java:59)
 at org.apache.cassandra.io.util.RebufferingInputStream.read(RebufferingInputStream.java:90)
 at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)
 at java.io.BufferedInputStream.read1(BufferedInputStream.java:286)
 at java.io.BufferedInputStream.read(BufferedInputStream.java:345)
 at org.apache.cassandra.io.util.LengthAvailableInputStream.read(LengthAvailableInputStream.java:57)
 at java.io.DataInputStream.readFully(DataInputStream.java:195)
 at java.io.DataInputStream.readFully(DataInputStream.java:169)
 at org.apache.cassandra.utils.ByteBufferUtil.read(ByteBufferUtil.java:433)
 at org.apache.cassandra.service.CacheService$KeyCacheSerializer.deserialize(CacheService.java:453)
 at org.apache.cassandra.cache.AutoSavingCache.loadSaved(AutoSavingCache.java:227)
 at org.apache.cassandra.cache.AutoSavingCache$3.call(AutoSavingCache.java:168)
 at org.apache.cassandra.cache.AutoSavingCache$3.call(AutoSavingCache.java:164)
 at com.google.common.util.concurrent.TrustedListenableFutureTask$TrustedFutureInterruptibleTask.runInterruptibly(TrustedListenableFutureTask.java:125)
 at com.google.common.util.concurrent.InterruptibleTask.run(InterruptibleTask.java:57)
 at com.google.common.util.concurrent.TrustedListenableFutureTask.run(TrustedListenableFutureTask.java:78)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.nio.channels.ClosedByInterruptException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:202)
 at sun.nio.ch.FileChannelImpl.readInternal(FileChannelImpl.java:740)
 at sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:721)
 at org.apache.cassandra.io.util.ChannelProxy.read(ChannelProxy.java:139)
 ... 22 common frames omitted&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17417675" author="jolynch" created="Mon, 20 Sep 2021 14:13:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt;&#160;Thank you for the patch! Would you like to get this into 3.0/3.11/4.0 and trunk? If so I think we need patches against each branch (the metadata variable names have changed slightly so I think separate patches might be easiest rather than one patch that we merge up); I am happy to do the minor changes on each branch if you like as well.&lt;/p&gt;

&lt;p&gt;Review of patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I think introducing a little bit of state here is wise, if we want to be extra careful do you think we could use &lt;a href=&quot;https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AutoCloseable&lt;/a&gt; somehow to ensure the state is cleaned up? Seems reasonable for &lt;tt&gt;close&lt;/tt&gt; to just cleanup the state used during load or dump.&lt;/li&gt;
	&lt;li&gt;Did you mean to remove RowIndexEntry.Serializer.skipForCache(input); on line 453 ?&lt;/li&gt;
	&lt;li&gt;Do you think we could improve the tests in AutoSavingCacheTest to have a case where a few sstables are created across different ks/table and we want to confirm the key cache is loaded properly with more than one keyspace/table?&lt;/li&gt;
	&lt;li&gt;Regarding the deadline approach that is an interesting idea and I like it, I&apos;d recommend you implement it in the while loop in AutoSavingCache.loadSaved (the while in.available loop) instead of by cancelling the future at the high level.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17418254" author="n.v.harikrishna" created="Tue, 21 Sep 2021 17:51:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; Thanks for the review!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Would you like to get this into 3.0/3.11/4.0 and trunk?&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will create three different patches&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Did you mean to remove RowIndexEntry.Serializer.skipForCache(input); on line 453 ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, looks like some mistake happened from my side before pushing the changes. Will revert it. Thanks for pointing it out.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If we want to be extra careful do you think we could use&#160;&lt;a href=&quot;https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AutoCloseable&lt;/a&gt;&#160;somehow to ensure the state is cleaned up?&lt;/p&gt;

&lt;p&gt;Do you think we could improve the tests in AutoSavingCacheTest...&lt;/p&gt;

&lt;p&gt;Regarding the deadline approach ... implement it in the while loop in AutoSavingCache.loadSaved ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will make these changes and upload patches as soon as I can.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17433131" author="n.v.harikrishna" created="Fri, 22 Oct 2021 19:10:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;&#160;I had updated the patch for trunk &amp;amp; here is the pr: &lt;a href=&quot;https://github.com/apache/cassandra/pull/1287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1287&lt;/a&gt;&#160; &amp;amp; CI is here:&#160;&lt;a href=&quot;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra/41/workflows/7fb33758-2a6d-464a-bcc5-8b5709d1d997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra/41/workflows/7fb33758-2a6d-464a-bcc5-8b5709d1d997&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I did not made changes to implement AutoCloseable as closing the resource generally gives the impression that resource it not usable any more but&#160;CacheSerializer later used for serialising too. Using normal method to clear up the map.&lt;/li&gt;
	&lt;li&gt;Added few tests to KeyCacheTest as it has more tests related to key cache.&lt;/li&gt;
	&lt;li&gt;Added limit on cache load time which is configurable through&#160;max_cache_load_time param (defaults to 30 sec).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Sorry for the delay. Would appreciate your review on the code changes. Please give me a day or two for making changes to other branches.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17434487" author="n.v.harikrishna" created="Tue, 26 Oct 2021 17:39:26 +0000"  >&lt;p&gt;Here are the changes:&#160;&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra/41/workflows/7fb33758-2a6d-464a-bcc5-8b5709d1d997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra/42/workflows/e7cdd28d-9d2e-4445-9157-e2b68ca0ef47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1290&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/nvharikrishna/cassandra/46/workflows/a2baf042-657d-44c2-8890-b52215f9f0cf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17434495" author="jolynch" created="Tue, 26 Oct 2021 17:54:49 +0000"  >&lt;p&gt;Thank you for the patches, will review asap!&lt;/p&gt;</comment>
                            <comment id="17454018" author="krummas" created="Mon, 6 Dec 2021 13:41:33 +0000"  >&lt;p&gt;this lgtm, just a few minor comments on the 3.0 PR above (but the comments apply on all branches)&lt;/p&gt;</comment>
                            <comment id="17454080" author="n.v.harikrishna" created="Mon, 6 Dec 2021 15:30:41 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; ! Taking a look.&lt;/p&gt;</comment>
                            <comment id="17454128" author="jolynch" created="Mon, 6 Dec 2021 16:46:42 +0000"  >&lt;p&gt;Also lg2m, let&apos;s iron out the configuration name since that&apos;s a public interface but I think the rest of the feedback is straightforward.&lt;/p&gt;

&lt;p&gt;in-jvm dtest flakes seem unrelated to me&lt;/p&gt;</comment>
                            <comment id="17455898" author="jolynch" created="Wed, 8 Dec 2021 17:38:01 +0000"  >&lt;p&gt;+1 . Left a few minor suggestions on the 3.0 PR (apply to other branches as well).&lt;/p&gt;

&lt;p&gt;When you&apos;re ready please rebase to a single commit for each branch with a commit that looks something like&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ git log -1
commit ...
Author: Venkata Harikrishna Nukala &amp;lt;n.v.harikrishna.apache@gmail.com&amp;gt;
Date: ...

Fix slow keycache load which blocks startup for tables with many sstables. 

Patch by Venkata Harikrishna Nukala; reviewed by Marcus Eriksson and Joseph Lynch for CASSANDRA-14898 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Important part is your name is attributed as author (if you want it to be), and we note the patch author, reviewers and ticket in the last line.&lt;/p&gt;</comment>
                            <comment id="17455938" author="n.v.harikrishna" created="Wed, 8 Dec 2021 19:03:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt;&#160; Addressed review comments, squashed the commits for each branch.&#160;&lt;/p&gt;</comment>
                            <comment id="17455946" author="krummas" created="Wed, 8 Dec 2021 19:25:45 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17456145" author="jolynch" created="Thu, 9 Dec 2021 04:51:22 +0000"  >&lt;p&gt;Cherry picked the trunk branch back to 4.0 and applied a fixup or two to get &lt;a href=&quot;https://github.com/jolynch/cassandra/commit/ae5954b1c513337484c43b575f09a0229464a33e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ae5954b1&lt;/a&gt;.&#160; I&apos;ve kicked off circleci precommit runs for 3.0, 3.11, 4.0 and trunk. If those come back green will commit.&lt;/p&gt;</comment>
                            <comment id="17456489" author="jolynch" created="Thu, 9 Dec 2021 15:02:42 +0000"  >&lt;p&gt;&lt;b&gt;trunk&lt;/b&gt; - &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/67/workflows/6a98bc38-3021-4763-906b-f84099157ba0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 11 CI&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/67/workflows/06b843ac-a0f9-4123-b14a-965dc8f22755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 CI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4 dtest failures in:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(J8) test_bootstrap_with_reset_bootstrap_state - bootstrap_test.TestBootstrap&lt;/li&gt;
	&lt;li&gt;(J8) test_compression_cql_options - compression_test.TestCompression&lt;/li&gt;
	&lt;li&gt;(J11) test_multiple_repair - repair_tests.incremental_repair_test.TestIncRepair&lt;/li&gt;
	&lt;li&gt;(J11, marked flakey) test_bootstrap_with_reset_bootstrap_state - bootstrap_test.TestBootstrap&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1 JVM dtest failure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(J8): readWriteDuringBootstrapTest - org.apache.cassandra.distributed.test.ring.BootstrapTest&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;4.0&lt;/b&gt; - &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/68/workflows/2fe689eb-1938-42fd-b5cb-abab32cf0d1f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 11 CI&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/68/workflows/7929a6c9-cc9c-4c5e-b271-cc276fc1d9a1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 CI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1 JVM dtest failure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(J8, J11) readWriteDuringBootstrapTest - org.apache.cassandra.distributed.test.ring.BootstrapTest&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;3.11&lt;/b&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/65/workflows/6e86d386-4057-4d83-aab1-4d3731023f5d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 CI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1 JVM dtest failure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(J8) bootstrapTest - org.apache.cassandra.distributed.test.BootstrapTest&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;3.0&lt;/b&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/64/workflows/5f7095bf-5031-465f-9d82-d574991e21ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 CI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1 JVM dtest failure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(J8) bootstrapTest - org.apache.cassandra.distributed.test.BootstrapTest&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Looking at the tests that failed I don&apos;t think any of these look related to the change. A local run of readWriteDuringBootstrapTest passes on 4.0 and bootstrapTest passed on 3.0, plus I&apos;m running a trunk &lt;a href=&quot;https://app.circleci.com/pipelines/github/jolynch/cassandra/69/workflows/58cdf28a-8e13-4920-94a2-870d0fe00790&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt; run to see if readWriteDuringBootstrapTest flakes on trunk as well without the patch.&lt;/p&gt;

&lt;p&gt;I believe this is ready to commit.&lt;/p&gt;</comment>
                            <comment id="17456521" author="jolynch" created="Thu, 9 Dec 2021 15:51:38 +0000"  >&lt;p&gt;Committed to 3.0, 3.11, 4.0 and trunk. Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt; for your contribution!&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
trunk: &lt;a href=&quot;https://github.com/apache/cassandra/commit/97b47c3b5f845097181130125752bd6efc1e1e47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;97b47c3b&lt;/a&gt;&lt;br/&gt;
4.0: &lt;a href=&quot;https://github.com/apache/cassandra/commit/e73d05bf858fa195ac2f2778027ef0d2ebcd3abd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e73d05bf&lt;/a&gt;&lt;br/&gt;
3.11: &lt;a href=&quot;https://github.com/apache/cassandra/commit/1fce84f9833bd62227dbf8f5d063935457dbc18e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1fce84f9&lt;/a&gt;&lt;br/&gt;
3.0: &lt;a href=&quot;https://github.com/apache/cassandra/commit/1911a887e8316d343c9bfe3aca3f9d143e9f4a61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1911a887&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13351782">CASSANDRA-16380</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12948454" name="key_cache_load_slow.svg" size="444953" author="jolynch" created="Fri, 16 Nov 2018 05:37:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[n.v.harikrishna]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00kf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332541">3.0.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jolynch]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/97b47c3b5f845097181130125752bd6efc1e1e47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/97b47c3b5f845097181130125752bd6efc1e1e47&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Pre-commit tests on 3.0, 3.11, 4.0 and trunk.&lt;/p&gt;

&lt;p&gt;Included microbench shows reduction from ~140ms / to 20ms / load in keycache loading with 1000 sstables.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>