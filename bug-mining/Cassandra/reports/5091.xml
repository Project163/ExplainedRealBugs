<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14763] Fail incremental repair prepare phase if it encounters sstables from un-finalized sessions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14763</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Raised in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14685&quot; title=&quot;Incremental repair 4.0 : SSTables remain locked forever if the coordinator dies during streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14685&quot;&gt;CASSANDRA-14685&lt;/a&gt;. If we encounter sstables from other IR sessions during an IR prepare phase, we should fail the new session. If we don&apos;t,&#160;the expectation that all data received before a repair session is consistent when it completes wouldn&apos;t always be true.&lt;/p&gt;

&lt;p&gt;In more detail:&#160;&lt;br/&gt;
We don&#8217;t have a foolproof way of determining if a repair session has hung. To prevent hung repair sessions from locking up sstables indefinitely, incremental repair sessions will auto-fail after 24 hours. During this time, the sstables for this session will remain isolated from the rest of the data set. Afterwards, the sstables are moved back into the unrepaired set.&lt;br/&gt;
&#160;&lt;br/&gt;
During the prepare phase of an incremental repair, we isolate the data to be repaired. However, we ignore other sstables marked pending repair for the same token range. I think the intention here was to prevent a hung repair from locking up incremental repairs for 24 hours without manual intervention. Assuming the session succeeds, it&#8217;s data will be moved to repaired. &lt;em&gt;However the data from a hung session will eventually be moved back to unrepaired.&lt;/em&gt; This means that you can&#8217;t use the most recent successful incremental repair as the high water mark for fully repaired data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13185903">CASSANDRA-14763</key>
            <summary>Fail incremental repair prepare phase if it encounters sstables from un-finalized sessions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="bdeggleston">Blake Eggleston</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Sep 2018 21:00:23 +0000</created>
                <updated>Fri, 15 May 2020 08:02:20 +0000</updated>
                            <resolved>Fri, 21 Sep 2018 17:05:32 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16619773" author="bdeggleston" created="Tue, 18 Sep 2018 21:47:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/14763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/workflow-run/03a36dfd-74b9-40e7-9284-b079f931f991&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16620283" author="krummas" created="Wed, 19 Sep 2018 08:25:39 +0000"  >&lt;p&gt;a few comments;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The error message given by the failing nodetool could be a bit better: &lt;tt&gt;Repair job has failed with the error message: &lt;span class=&quot;error&quot;&gt;&amp;#91;2018-09-19 10:01:51,386&amp;#93;&lt;/span&gt; null&lt;/tt&gt; maybe we could add that the user should have a look in the logs for further details&lt;/li&gt;
	&lt;li&gt;a comment about isPending() on the commit on github&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;wrote a dtest making sure that we throw an exception if this happens: &lt;a href=&quot;https://github.com/krummas/cassandra-dtest/commits/marcuse/14763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra-dtest/commits/marcuse/14763&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;also looks like a few repair dtests needs fixing&lt;/p&gt;</comment>
                            <comment id="16620926" author="bdeggleston" created="Wed, 19 Sep 2018 17:32:58 +0000"  >&lt;p&gt;Pushed up fixes and started a new circle run.&lt;/p&gt;

&lt;p&gt;Good catch with the race condition. I realized there&#8217;s another race where another pending anti-compaction could complete after we&#8217;d filtered our sstables and before we locked the sstables, potentially leaking data from one session to another which I fixed in AcquisitionCallback.&lt;/p&gt;</comment>
                            <comment id="16621589" author="krummas" created="Thu, 20 Sep 2018 07:04:51 +0000"  >&lt;p&gt;pushed a few fixes: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/blake/14763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/blake/14763&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;re-added the range intersection check&lt;/li&gt;
	&lt;li&gt;Iterables.filter is &quot;lazy&quot; - we would have to iterate over the sstables returned to populate &lt;tt&gt;conflictingSessions&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;tests running here: &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/tree/blake%2F14763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/krummas/cassandra/tree/blake%2F14763&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16621669" author="krummas" created="Thu, 20 Sep 2018 08:38:06 +0000"  >&lt;p&gt;seems repair_tests.py test_dead_coordinator is a legit failure&lt;/p&gt;</comment>
                            <comment id="16622249" author="bdeggleston" created="Thu, 20 Sep 2018 15:59:14 +0000"  >&lt;p&gt;Ok dead coordinator test needed to be updated to cancel the hung repair session, that&apos;s fixed (and pulled in your dtest changes) here: &lt;a href=&quot;https://github.com/bdeggleston/cassandra-dtest/tree/14763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bdeggleston/cassandra-dtest/tree/14763&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;New run here: &lt;a href=&quot;https://circleci.com/workflow-run/9d4564d2-acbb-4c5a-b296-aa7977d66da4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/9d4564d2-acbb-4c5a-b296-aa7977d66da4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16622428" author="krummas" created="Thu, 20 Sep 2018 17:59:16 +0000"  >&lt;p&gt;LGTM, +1&lt;/p&gt;</comment>
                            <comment id="16623887" author="bdeggleston" created="Fri, 21 Sep 2018 17:05:32 +0000"  >&lt;p&gt;Thanks, committed to trunk as &lt;a href=&quot;https://github.com/apache/cassandra/commit/167ebbcf4304512fa538e9cfc18da4295511d16c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;167ebbcf4304512fa538e9cfc18da4295511d16c&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12989" cascade-level="1"><![CDATA[Consistency]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3y89j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>