<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6722] cross-partition ordering should have warning or be disallowed when paging</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6722</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;consider this schema/data/query:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE paging_test (
    id int,
    value text,
    PRIMARY KEY (id, value)
) WITH CLUSTERING ORDER BY (value ASC)

            |id|value|
            |1 |a    |
            |2 |b    |
            |1 |c    |
            |2 |d    | 
            |1 |e    | 
            |2 |f    | 
            |1 |g    | 
            |2 |h    |
            |1 |i    |
            |2 |j    |

select * from paging_test where id in (1,2) order by value asc;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When paging the above query I get the sorted results from id=1 first, then the sorted results from id=2 after that. I was testing this because I was curious if the paging system could somehow globally sort the results but it makes sense that we can&apos;t do that, since that would require all results to be collated up front.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12695794">CASSANDRA-6722</key>
            <summary>cross-partition ordering should have warning or be disallowed when paging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="rhatch">Russ Hatch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Feb 2014 21:29:07 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:53 +0000</updated>
                            <resolved>Fri, 21 Feb 2014 13:07:50 +0000</resolved>
                                        <fixVersion>2.0.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13905561" author="slebresne" created="Wed, 19 Feb 2014 15:34:24 +0000"  >&lt;p&gt;Good catch. We can&apos;t indeed properly do post-query reordering in general if we page. Note that currently, there is 2 cases where we do post-query reordering:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;with a IN on the partition key and an ORDER BY (the example above).&lt;/li&gt;
	&lt;li&gt;if there is an IN on the last clustering column of a compact table.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The 2nd case is actually a bit weird. The reason we order post-query is so the resultset follows the order of the IN in the query, i.e. if you have the table above but COMPACT and do&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT value FROM paging_test WHERE id=1 AND value IN (&apos;b&apos;, &apos;a&apos;, &apos;c&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;you will get [ &apos;b&apos;, &apos;a&apos;, &apos;c&apos; ] in that order as a result set. So far, why not, but there is 2 problems in practice:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we only do that for compact tables. For non-compact ones, we just return results in clustering order (we don&apos;t do the post-query ordering). That inconsistency is an historical accident.&lt;/li&gt;
	&lt;li&gt;this actually take precedence over ORDER BY, which is completely broken. I.e. even if you add &apos;ORDER BY value&apos; in the query above, the results will not be properly ordered.&lt;/li&gt;
	&lt;li&gt;this is even more broken than that: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6701&quot; title=&quot;IN on the last clustering columns + ORDER BY DESC yield no results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6701&quot;&gt;&lt;del&gt;CASSANDRA-6701&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
This case is a mess. So because it&apos;s a problem in the context of this ticket and because there is no reason to guarantee any special ordering of the result set if there is no ORDER BY, I suggest we just remove the behavior for compact storage (it was an implementation detail so far) to make it in line with the non-compact case, thus avoiding us to have to deal with it here.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Back to the more interesting case of the example in the description: a IN on the partition key with ORDER BY. In that case, we could almost support paging properly: the reason it&apos;s broken is that the pager queries partitions of the IN one after the other.  But the pager could, in theory, page over each partition simultaneously, querying them all little by little and doing a merge sort.&lt;/p&gt;

&lt;p&gt;It is however not all that easy in practice. If you query a full page of each partition and there is many partitions in the IN, you&apos;ll load tons of data in memory, defeating in large parts the goal of paging. If you instead query less than the page size of each partition, you now may need to re-query some of the partitions depending on what the merge sort yield on those first pages. Not only would that require serious refactor of the current code to properly handle, but it&apos;s rather unclear how efficient this would really be in general. I&apos;m not sure it&apos;s really worth it in the end. &lt;/p&gt;

&lt;p&gt;But in any case, such solution is way out of scope for 2.0 (and probably even for 2.1 at this point). So we need a quick solution for now and it probably mean that we should throw an IRE if the query requires post-query paging and paging is on.&lt;/p&gt;

&lt;p&gt;Taking a step back, I wonder if allowing post-query reordering by default was a good idea, and if the same way we have ALLOW FILTERING, we shouldn&apos;t have required an ALLOW IN-MEMORY REORDERING for such queries. Of course, it&apos;s harder to change that now, but maybe we could still do it by adding such flag, deprecate queries that don&apos;t use it by logging a warning like we&apos;ve done in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6649&quot; title=&quot;CQL: disallow counter update with &amp;quot;USING TIMESTAMP&amp;quot; and &amp;quot;USING TTL&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6649&quot;&gt;&lt;del&gt;CASSANDRA-6649&lt;/del&gt;&lt;/a&gt; for 1 or 2 versions, and forbid it completely afterwards?&lt;/p&gt;</comment>
                            <comment id="13905562" author="slebresne" created="Wed, 19 Feb 2014 15:34:44 +0000"  >&lt;p&gt;Attaching a patch that does 2 things:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;remove the ordering of results for compact tables when a IN is on the last clustering column (see discussion above) so the only case where we do post-query reordering is with IN on partition key + ORDER BY.&lt;/li&gt;
	&lt;li&gt;throw IRE if the query needs post-query reordering and paging is on.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13907463" author="iamaleksey" created="Thu, 20 Feb 2014 20:39:27 +0000"  >&lt;p&gt;LGTM, +1.&lt;/p&gt;</comment>
                            <comment id="13908279" author="slebresne" created="Fri, 21 Feb 2014 13:07:51 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12629787" name="6722.txt" size="5217" author="slebresne" created="Wed, 19 Feb 2014 15:34:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>374301</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1si3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>374601</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>