<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5137] Make sure SSTables left over from compaction get deleted and logged</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5137</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When opening ColumnFamily, cassandra checks SSTable files&apos; ancestors and skips loading already compacted ones. Those files are expected to be deleted, but currently that never happens.&lt;br/&gt;
Also, there is no indication of skipping loading file in the log, so it is confusing especially doing upgradesstables.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12626804">CASSANDRA-5137</key>
            <summary>Make sure SSTables left over from compaction get deleted and logged</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="yukim">Yuki Morishita</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Jan 2013 17:31:33 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:20 +0000</updated>
                            <resolved>Fri, 11 Jan 2013 19:18:16 +0000</resolved>
                                        <fixVersion>1.1.9</fixVersion>
                    <fixVersion>1.2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13548707" author="yukim" created="Wed, 9 Jan 2013 17:32:47 +0000"  >&lt;p&gt;We need to mark skipping SSTable as compacted to be removed.&lt;/p&gt;</comment>
                            <comment id="13548749" author="jbellis" created="Wed, 9 Jan 2013 17:58:34 +0000"  >&lt;p&gt;Hmm.&lt;/p&gt;

&lt;p&gt;This patch is correct as far as it goes but I think the existing assumption is broken: that if we have any sstable with ancestor X, then X is safe to delete.&lt;/p&gt;

&lt;p&gt;Specifically, LCS will create multiple sstables from a given set of ancestors, so unless we know that we finished the compaction (and finished writing all the resulting descendant sstables), we could lose data if we delete the ancestors themselves.&lt;/p&gt;

&lt;p&gt;One possible fix:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Add a flag to SSTM for &quot;this was the final sstable in the compaction&quot;&lt;/li&gt;
	&lt;li&gt;When we scan sstables, we can delete ancestors if we find that marker in any of the descendants&lt;/li&gt;
	&lt;li&gt;Otherwise, we should delete the &lt;b&gt;descendants&lt;/b&gt; and leave the ancestors alone (so we don&apos;t doublecount data for counters)&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13548758" author="slebresne" created="Wed, 9 Jan 2013 18:13:52 +0000"  >&lt;p&gt;I think you&apos;re right.&lt;/p&gt;

&lt;p&gt;A fourth pseudo-solution could be to wait the end of the compaction to rename all the newly created writers (i.e remove the tmp markers). It&apos;s not bulletproof though as I don&apos;t think we can rename multiple files atomically but just wanted to mention it.&lt;/p&gt;

&lt;p&gt;Maybe at least for 1.1, 3. is the best/simplest option. On the longer term, maybe 1. is better.&lt;/p&gt;</comment>
                            <comment id="13548791" author="jbellis" created="Wed, 9 Jan 2013 18:33:09 +0000"  >&lt;p&gt;You&apos;re right, you don&apos;t actually need a marker since if compaction completes the next step is to remove the ancestors.  I think &quot;if ancestors are still alive, assume compaction didn&apos;t finish and delete the descendants&quot; is good enough.&lt;/p&gt;</comment>
                            <comment id="13548824" author="slebresne" created="Wed, 9 Jan 2013 18:56:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think &quot;if ancestors are still alive, assume compaction didn&apos;t finish and delete the descendants&quot; is good enough.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yeah agreed.&lt;/p&gt;</comment>
                            <comment id="13548832" author="slebresne" created="Wed, 9 Jan 2013 19:01:26 +0000"  >&lt;p&gt;Hum wait, it only works if we have all ancestors though. What if just one ancestor don&apos;t get deleted for some reason (or only some of the SSTableDeletingTask have executed before a crash)? It&apos;s easy enough to check that we have &lt;b&gt;all&lt;/b&gt; ancestors, but what if we don&apos;t? We&apos;re back to square one &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13548944" author="jbellis" created="Wed, 9 Jan 2013 20:13:36 +0000"  >&lt;p&gt;You&apos;re right.  Guess we need a compaction-finished flag after all.&lt;/p&gt;

&lt;p&gt;Instead of storing it in sstable metadata, maybe we could store it in system.local the way we do with truncation information.  Unfortunately 1.1 doesn&apos;t support Maps so we&apos;d be doing two separate implementations for 1.1 and 1.2.&lt;/p&gt;

&lt;p&gt;Should we just say that for 1.1 we&apos;ll retain all sstables (counter users will get overcounts, everyone else just gets extra compaction work) and fix it better in 1.2?&lt;/p&gt;</comment>
                            <comment id="13548947" author="jbellis" created="Wed, 9 Jan 2013 20:16:44 +0000"  >&lt;p&gt;Something like this...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create table compaction_log (
  id uuid primary key,
  inputs set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;,
  outputs set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When we start a compaction, we add it to the log.  When we finish, we remove it.  If we restart and compaction_log is not empty, we remove any sstables from the outputs set.&lt;/p&gt;</comment>
                            <comment id="13549448" author="slebresne" created="Thu, 10 Jan 2013 08:57:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Should we just say that for 1.1 we&apos;ll retain all sstables&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For 1.1, I&apos;d suggest doing my fourth pseudo-solution above, i.e. moving the renaming of newly created writes at the end of the compaction (it&apos;s trivial). Then at startup, we could indeed retain all sstables for normal CF, but for counter we would keep removing the predecessors as we do now. It wouldn&apos;t totally fix the risk of losing counters, but it would make it very unlikely (you&apos;d need to fail exactly in the middle of the bulk renaming a newly create sstable writers), while just retaining all sstables would make it very easy to have overcounts.&lt;/p&gt;

&lt;p&gt;For 1.2, you compaction_log solution does seem reasonable.&lt;/p&gt;</comment>
                            <comment id="13550466" author="yukim" created="Thu, 10 Jan 2013 21:49:18 +0000"  >&lt;p&gt;V2 implements Sylvain&apos;s idea that renames written SSTables at the end of compaction.&lt;/p&gt;

&lt;p&gt;For 1.2, let&apos;s open different issue for Jonathan&apos;s suggestion.&lt;/p&gt;</comment>
                            <comment id="13551163" author="slebresne" created="Fri, 11 Jan 2013 15:17:29 +0000"  >&lt;p&gt;The code of v2 looks alright, but let&apos;s also disable the filtering in ColumnFamilyStore.ctor for non-counter CFs so we take zero chance of losing data (and since reusing an already compacted sstable is a bit inefficient but harmless).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For 1.2, let&apos;s open different issue for Jonathan&apos;s suggestion&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;/p&gt;</comment>
                            <comment id="13551299" author="yukim" created="Fri, 11 Jan 2013 17:38:02 +0000"  >&lt;p&gt;Attached v3 that also changes the filtering part only for counter CF.&lt;/p&gt;</comment>
                            <comment id="13551317" author="slebresne" created="Fri, 11 Jan 2013 17:47:48 +0000"  >&lt;p&gt;+1 (though do commit your v1 along the way, no way in keeping sstable we&apos;re not going to use, even if it&apos;s only for counters).&lt;/p&gt;</comment>
                            <comment id="13551422" author="yukim" created="Fri, 11 Jan 2013 19:18:16 +0000"  >&lt;p&gt;Committed v1 + v3, and opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5151&quot; title=&quot;Implement better way of eliminating compaction left overs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5151&quot;&gt;&lt;del&gt;CASSANDRA-5151&lt;/del&gt;&lt;/a&gt; for better solution.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12626115">CASSANDRA-5116</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12564275" name="5137-1.1-v2.txt" size="4001" author="yukim" created="Thu, 10 Jan 2013 21:49:18 +0000"/>
                            <attachment id="12564451" name="5137-1.1-v3.txt" size="6374" author="yukim" created="Fri, 11 Jan 2013 17:38:02 +0000"/>
                            <attachment id="12563965" name="5137-1.1.txt" size="1009" author="yukim" created="Wed, 9 Jan 2013 17:32:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>303422</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17b2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250763</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>