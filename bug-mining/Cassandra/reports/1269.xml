<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:26:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3178] Counter shard merging is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3178</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The first part of the counter shard merging process is done during counter replication. This was done there because it requires that all replica are made aware of the merging (we could only rely on nodetool repair for that but that seems much too fragile, it&apos;s better as just a safety net). However this part isn&apos;t thread safe as multiple threads can do the merging for the same shard at the same time (which shouldn&apos;t really &quot;corrupt&quot; the counter value per se, but result in an incorrect context).&lt;/p&gt;

&lt;p&gt;Synchronizing that part of the code would be very costly in term of performance, so instance I propose to move the part of the shard merging done during replication to compaction. It&apos;s a better place anyway. The only downside is that it means compaction will sometime send mutations to other node as a side effect, which doesn&apos;t feel very clean but is probably not a big deal either.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522749">CASSANDRA-3178</key>
            <summary>Counter shard merging is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                            <label>counters</label>
                    </labels>
                <created>Mon, 12 Sep 2011 14:58:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:51 +0000</updated>
                            <resolved>Mon, 7 Nov 2011 15:38:03 +0000</resolved>
                                        <fixVersion>0.8.8</fixVersion>
                    <fixVersion>1.0.3</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13102718" author="slebresne" created="Mon, 12 Sep 2011 15:04:54 +0000"  >&lt;p&gt;First patch move the code from counter replication to compaction (as described above). The second patch adapt the code to work correctly with the move to compaction but also simply and improve that code.&lt;/p&gt;</comment>
                            <comment id="13103708" author="slebresne" created="Tue, 13 Sep 2011 15:51:34 +0000"  >&lt;p&gt;Note that the removal of flush_after_mins in 1.0 is a problem for this patch. The reason is that we want to remove a shard corresponding to a NodeId for which we know no increment has been made after time t. For that removal to be safe, we must make sure that compaction includes everything that has been issued before time t. For that, current patch check that the compaction has started after time t + 2 * flush_after_mins. I&apos;ll update the patch to use the memtables creationTime instead.  &lt;/p&gt;</comment>
                            <comment id="13105241" author="slebresne" created="Thu, 15 Sep 2011 09:37:54 +0000"  >&lt;p&gt;Attaching v2, rebased and that remove the use of flush_after_mins.&lt;/p&gt;</comment>
                            <comment id="13138536" author="jbellis" created="Fri, 28 Oct 2011 17:08:06 +0000"  >&lt;p&gt;Yuki, can you review?&lt;/p&gt;</comment>
                            <comment id="13142240" author="yukim" created="Wed, 2 Nov 2011 16:08:08 +0000"  >&lt;p&gt;LGTM on 0.8 branch. I think it&apos;s safe to apply this on 1.0, but before that I want to make sure it works. Could you modify the patch so that I can test on 1.0?&lt;/p&gt;</comment>
                            <comment id="13143052" author="slebresne" created="Thu, 3 Nov 2011 11:49:15 +0000"  >&lt;p&gt;Attaching patches rebased against 1.0&lt;/p&gt;</comment>
                            <comment id="13143848" author="yukim" created="Fri, 4 Nov 2011 09:14:12 +0000"  >&lt;p&gt;+!. 1.0 patch also works fine.&lt;/p&gt;</comment>
                            <comment id="13145561" author="slebresne" created="Mon, 7 Nov 2011 15:38:03 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13145576" author="hudson" created="Mon, 7 Nov 2011 16:02:58 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #394 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/394/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/394/&lt;/a&gt;)&lt;br/&gt;
    patch by slebresne; reviewed by yukim for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3178&quot; title=&quot;Counter shard merging is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3178&quot;&gt;&lt;del&gt;CASSANDRA-3178&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1198725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1198725&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/config/CFMetaData.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/CounterColumn.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/CounterMutation.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/Memtable.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/CompactionController.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/LazilyCompactedRow.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/PrecompactedRow.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/context/CounterContext.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageProxy.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/test/unit/org/apache/cassandra/db/CounterMutationTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/test/unit/org/apache/cassandra/db/context/CounterContextTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12535364">CASSANDRA-3641</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12502133" name="0001-Move-shard-merging-completely-to-compaction-1.0.patch" size="15395" author="slebresne" created="Thu, 3 Nov 2011 11:49:15 +0000"/>
                            <attachment id="12494593" name="0001-Move-shard-merging-completely-to-compaction-v2.patch" size="15108" author="slebresne" created="Thu, 15 Sep 2011 09:37:53 +0000"/>
                            <attachment id="12494039" name="0001-Move-shard-merging-completely-to-compaction.patch" size="15600" author="slebresne" created="Mon, 12 Sep 2011 15:04:54 +0000"/>
                            <attachment id="12502134" name="0002-Simplify-improve-shard-merging-code-1.0.patch" size="32707" author="slebresne" created="Thu, 3 Nov 2011 11:49:15 +0000"/>
                            <attachment id="12494594" name="0002-Simplify-improve-shard-merging-code-v2.patch" size="26895" author="slebresne" created="Thu, 15 Sep 2011 09:37:53 +0000"/>
                            <attachment id="12494040" name="0002-Simplify-improve-shard-merging-code.patch" size="23059" author="slebresne" created="Mon, 12 Sep 2011 15:04:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14977</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ggr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94144</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>