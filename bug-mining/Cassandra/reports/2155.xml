<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5521] move IndexSummary off heap</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5521</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;IndexSummary can still use a lot of heap for narrow-row sstables.  (It can also contribute to memory fragmentation because of the large arrays it creates.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12645079">CASSANDRA-5521</key>
            <summary>move IndexSummary off heap</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vijay2win@yahoo.com">Vijay</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Sun, 28 Apr 2013 14:42:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:13 +0000</updated>
                            <resolved>Fri, 3 May 2013 08:42:43 +0000</resolved>
                                        <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13644123" author="vijay2win@yahoo.com" created="Sun, 28 Apr 2013 20:21:45 +0000"  >&lt;p&gt;Pushed the changes to &lt;a href=&quot;https://github.com/Vijay2win/cassandra/commits/5521&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Vijay2win/cassandra/commits/5521&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The idea is as mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5506&quot; title=&quot;Reduce memory consumption of IndexSummary&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5506&quot;&gt;&lt;del&gt;CASSANDRA-5506&lt;/del&gt;&lt;/a&gt; comments, Since this ticket is marked for 2.0 i took the liberty of changing the index summary file format.&lt;br/&gt;
I am going to spend sometime on testing the performance difference (If any). Thanks!&lt;/p&gt;</comment>
                            <comment id="13644229" author="jbellis" created="Mon, 29 Apr 2013 03:23:29 +0000"  >&lt;p&gt;Seems inefficient to make the &quot;get pair&quot; the unit of fetching memory, since usually you want the key or the position but not both.  (You wouldn&apos;t have to change the signature of getKey either, if you just fetched the key into a byte[] directly instead of wrapping half of it.)&lt;/p&gt;

&lt;p&gt;What&apos;s the upgrade path?  Would prefer &quot;automatically rebuilds old summaries&quot; to &quot;user has to manually blow away summaries or it dies trying to start.&quot;&lt;/p&gt;</comment>
                            <comment id="13644237" author="vijay2win@yahoo.com" created="Mon, 29 Apr 2013 03:37:26 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Seems inefficient to make the &quot;get pair&quot; the unit of fetching memory,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ahaa good point will fix it.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;What&apos;s the upgrade path? Would prefer &quot;automatically rebuilds old summaries&quot; to &quot;user has to manually blow away summaries or it dies trying to start.&quot;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is automatic, but until the user runs scrub or until the new SST&apos;s are created the startup will be slow.&lt;/p&gt;</comment>
                            <comment id="13645365" author="vijay2win@yahoo.com" created="Tue, 30 Apr 2013 07:51:07 +0000"  >&lt;p&gt;Pushed an update to &lt;a href=&quot;https://github.com/Vijay2win/cassandra/commits/5521_v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Vijay2win/cassandra/commits/5521_v2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This update doesn&apos;t use int[] which v1 used, v2 uses kind of offheap index over index summary which is stored at the beginning of the memory block... Moves index summary completely offheap... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I was not able to see any difference in performance between trunk and v2 using stress tool. &lt;br/&gt;
Micro benchmark shows v2 is 6 seconds slower for 20 Bilion get&apos;s hence it is was not noticeable in stress tool, but the real benefit is less pauses and more data a node can hold...&lt;/p&gt;</comment>
                            <comment id="13646352" author="xedin" created="Wed, 1 May 2013 03:53:32 +0000"  >&lt;p&gt;Have we considered using vint encoding on those arrays as we keep them in memory anyway to minimize space consumption?&lt;/p&gt;

&lt;p&gt;Edit: i remember now why that is not a good idea &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I wonder though how what could memory footprint be if we use TreeMap inside and keys and offsets (in vint encoding) saved in native memory...&lt;/p&gt;</comment>
                            <comment id="13646410" author="xedin" created="Wed, 1 May 2013 06:17:33 +0000"  >&lt;p&gt;I see v2 does byte[] allocation on every getKey(int) call which would be happening very frequently due to binary search which happens on very index lookup. So I don&apos;t think there is any real benefit in terms of GC friendliness from moving off-heap in this case as we have to copy data over multiple times anyway.&lt;/p&gt;

&lt;p&gt;As an alternative to Unsafe we can try hybrid approach - identify if JNA is present and put summaries off-heap (using JNA&apos;s Memory) in combination with Pointer.getByteBuffer() which doesn&apos;t copy any data around but instead creates direct ByteBuffer, otherwise have IndexSummary on-heap but split byte[][] and long[] into pages so we don&apos;t have to allocate contiguous space for big SSTables which would be much GC friendlier. &lt;/p&gt;
</comment>
                            <comment id="13646583" author="jbellis" created="Wed, 1 May 2013 13:46:38 +0000"  >&lt;p&gt;As Pavel notes, the most important use of getKey is the one in binarySearch.  But here we only care about the comparison, we don&apos;t actually need the artifact of a ByteBuffer.  So why not compare directly without creating a buffer first?  No buffer at all is even cheaper than a native buffer.&lt;/p&gt;

&lt;p&gt;(This would also mean that we only need to look at as many bytes as it takes before the first difference is found.)&lt;/p&gt;</comment>
                            <comment id="13646678" author="jbellis" created="Wed, 1 May 2013 16:12:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;So why not compare directly without creating a buffer first?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That doesn&apos;t quite work, since we need to compare the Token, not the key itself.&lt;/p&gt;

&lt;p&gt;So, revised suggestion: allow the partitioner to decorate a Memory location, instead of forcing us to create a ByteBuffer first.&lt;/p&gt;</comment>
                            <comment id="13647094" author="xedin" created="Wed, 1 May 2013 23:54:52 +0000"  >&lt;p&gt;if we do so we would have to change partitioner interface to decorateKey and getToken, DecoratedKey to have two &quot;key&quot; fields and change at least MurmurHash to accept both BB and M at the same time. I&apos;m my opinion it&apos;s just too many changes just because we don&apos;t require JNA but with hybrid approach we don&apos;t have to do any of that work. Besides mentioned users would want to run with JNA in production anyway.&lt;/p&gt;</comment>
                            <comment id="13647188" author="jbellis" created="Thu, 2 May 2013 01:58:51 +0000"  >&lt;p&gt;Just add a IPartitioner.compareToken method that does what we need, then.  Much better than creating extra objects that we don&apos;t care about.&lt;/p&gt;

&lt;p&gt;I like where we are now, with JNA being mostly optional (more so in 2.0 where we require Java7, so we don&apos;t need JNA for snapshot).  Remember, we don&apos;t support JNA at all on Windows.  I&apos;d rather use less JNA than more.&lt;/p&gt;</comment>
                            <comment id="13647197" author="xedin" created="Thu, 2 May 2013 02:11:54 +0000"  >&lt;p&gt;But don&apos;t you still have to generate token from Memory and make changes to getToken(BB) and underlying methods or was is proposed interface for compareToken?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I like where we are now, with JNA being mostly optional (more so in 2.0 where we require Java7, so we don&apos;t need JNA for snapshot). Remember, we don&apos;t support JNA at all on Windows. I&apos;d rather use less JNA than more.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I just to clarify, the only thing we need from JNA in this case is Pointer.getByteBuffer() which is actually a JNI method but unfortunately Unsafe doesn&apos;t have it somehow &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I agree tho that we should rely less on JNA but in this case we still pay the price of memory usage even putting off-heap so in non-JNA case we make it GC/allocation friendly it still makes a good improvement overall with almost no code changes.&lt;/p&gt;</comment>
                            <comment id="13647215" author="jbellis" created="Thu, 2 May 2013 02:37:56 +0000"  >&lt;p&gt;Thinking about it, &lt;tt&gt;getToken(Memory, offset, length)&lt;/tt&gt; is probably the right thing to add to IPartitioner.  The rest can live in IndexSummary.  That doesn&apos;t sound like a huge burden to me.  And as I said, creating no Buffer (or DK) objects is better than creating native ones. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13647226" author="xedin" created="Thu, 2 May 2013 03:08:22 +0000"  >&lt;p&gt;So tokens that keep bb around right now would have to keep Memory and offset, size references? I&apos;m not against this, just trying to clarify to myself if we would rather want to keep some kind of ROBuffer container for DK and Token to unify interface...&lt;/p&gt;</comment>
                            <comment id="13647236" author="jbellis" created="Thu, 2 May 2013 03:23:58 +0000"  >&lt;p&gt;No, the Token wouldn&apos;t share any bytes with the key (with the exception of BOP, and I don&apos;t care about optimizing for that case), so there&apos;s no reason to not create a regular, on-heap Token.&lt;/p&gt;

&lt;p&gt;Edit: keeping in mind that we don&apos;t actually need a full DK object, we just need a Token.&lt;/p&gt;</comment>
                            <comment id="13647264" author="vijay2win@yahoo.com" created="Thu, 2 May 2013 04:03:37 +0000"  >&lt;p&gt;Honestly, glad to see the thread going in the same thinking process which i went though.... &lt;/p&gt;

&lt;p&gt;Changing the Partitioner is a bigger change... but before we go there, wondering if this optimization is going to help us? &lt;br/&gt;
For BB is not cheap, but it is going to be good garbage which will live and die in young generation.&lt;/p&gt;

&lt;p&gt;I can think of 2 other options...&lt;br/&gt;
1) We can serialize and deserialize Token in IndexSummary we still need additional function to serialize and deserialize from memory (for BOP we can serialize the key/byte[], we have also removed the token calculation overhead) so we can also try and compare incrementally.&lt;br/&gt;
2) We can use MMappedFile instead and get ByteBuffer (this could work in our favor, for the new SST&apos;s which is never queried there is zero overhead in memory ) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13647289" author="xedin" created="Thu, 2 May 2013 04:56:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;For BB is not cheap, but it is going to be good garbage which will live and die in young generation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Indeed, those are just containers so actual data is not copied and those buffers pretty GC friendly as you mentioned. But I think that option with using Memory with token is ok if we can encapsulate it properly.&lt;/p&gt;</comment>
                            <comment id="13647664" author="jbellis" created="Thu, 2 May 2013 16:17:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;Changing the Partitioner is a bigger change&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It does get ugly since you&apos;d need to reimplement Murmur3.hash3_x64_128 on Memory objects.  (Not for the first time, I&apos;m pissed that ByteBuffer isn&apos;t an interface...)&lt;/p&gt;

&lt;p&gt;Let&apos;s go ahead and move forward with v2 and optimize later if we need to.&lt;/p&gt;

&lt;p&gt;Nits:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;rename hasSummaries to offHeapSummaries&lt;/li&gt;
	&lt;li&gt;InputStream.read has an overload that takes a length parameter, you don&apos;t need to realloc the buffer&lt;/li&gt;
	&lt;li&gt;The comment doesn&apos;t match the code here.  Also, getIndex should be private.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.       &lt;span class=&quot;code-comment&quot;&gt;// multiply by 4 and add the block start
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bytes.getInt(index &amp;lt;&amp;lt; 2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;We can easily inline DK.compareTo instead of actually creating a DK object (i.e., call partitioner.getToken instead, then compare the tokens and keys without the DK wrapper)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The rest LGTM.&lt;/p&gt;</comment>
                            <comment id="13648267" author="vijay2win@yahoo.com" created="Fri, 3 May 2013 08:42:43 +0000"  >&lt;p&gt;Committed to Trunk!&lt;/p&gt;

&lt;p&gt;Added following function to DK to support RowPosition&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; compareTo(IPartitioner partitioner, ByteBuffer key, RowPosition position)
    {
        &lt;span class=&quot;code-comment&quot;&gt;// delegate to Token.KeyBound &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; needed
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(position &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; DecoratedKey))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -position.compareTo(partitioner.decorateKey(key));

        DecoratedKey otherKey = (DecoratedKey) position;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; cmp = partitioner.getToken(key).compareTo(otherKey.getToken());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cmp == 0 ? ByteBufferUtil.compareUnsigned(key, otherKey.key) : cmp;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325441</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k59z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325786</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>