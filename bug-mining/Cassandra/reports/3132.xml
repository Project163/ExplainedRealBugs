<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6125] Race condition in Gossip propagation</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6125</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Gossip propagation has a race when concurrent VersionedValues are created and submitted/propagated, causing some updates to be lost, even if happening on different ApplicationStatuses.&lt;br/&gt;
That&apos;s what happens basically:&lt;br/&gt;
1) A new VersionedValue V1 is created with version X.&lt;br/&gt;
2) A new VersionedValue V2 is created with version Y = X + 1.&lt;br/&gt;
3) V2 is added to the endpoint state map and propagated.&lt;br/&gt;
4) Nodes register Y as max version seen.&lt;br/&gt;
5) At this point, V1 is added to the endpoint state map and propagated too.&lt;br/&gt;
6) V1 version is X &amp;lt; Y, so nodes do not ask for his value after digests.&lt;/p&gt;

&lt;p&gt;A possible solution would be to propagate/track per-ApplicationStatus versions, possibly encoding them to avoid network overhead.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12671644">CASSANDRA-6125</key>
            <summary>Race condition in Gossip propagation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="sbtourist">Sergio Bossa</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Oct 2013 19:01:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:04 +0000</updated>
                            <resolved>Thu, 18 Sep 2014 21:38:19 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13790471" author="brandon.williams" created="Wed, 9 Oct 2013 15:28:30 +0000"  >&lt;p&gt;Can you point me to a spot in code where step 5 happens?&lt;/p&gt;</comment>
                            <comment id="13790574" author="sbtourist" created="Wed, 9 Oct 2013 16:22:43 +0000"  >&lt;p&gt;Step 5 happens in Gossiper#addLocalApplicationState: it&apos;s all about concurrent state changes, and even if the race condition window may seem very small, it&apos;s actually there, and if it bites, it bites hard (as effects are very difficult to trace back).&lt;/p&gt;</comment>
                            <comment id="14078167" author="mshuler" created="Tue, 29 Jul 2014 18:57:37 +0000"  >&lt;p&gt;Setting fixVer to next 2.0/2.1 versions and assigning.&lt;/p&gt;</comment>
                            <comment id="14139458" author="brandon.williams" created="Thu, 18 Sep 2014 20:34:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;A possible solution would be to propagate/track per-ApplicationStatus versions, possibly encoding them to avoid network overhead&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a fairly invasive measure.  In practice there are very few instances where we update two application states together, and really only one case: STATUS and TOKENS.  Instead, we can just create a utility method that locks the gossip task, adds the states, and then releases it, so there can be no propagation in between.  Patch to do this.&lt;/p&gt;</comment>
                            <comment id="14139476" author="brandon.williams" created="Thu, 18 Sep 2014 20:40:28 +0000"  >&lt;p&gt;There&apos;s still a small window where a remote node could gossip with us and receive a partial state, but that looks confined to node replacement where we&apos;ll be in a dead state and nobody will initiate a round with us, so we just need to isolate our own propagation.&lt;/p&gt;</comment>
                            <comment id="14139550" author="jasobrown" created="Thu, 18 Sep 2014 21:30:55 +0000"  >&lt;p&gt;+1 on the patch, and I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&apos;s thoughts on keeping the protocol simple. As long as versioned values are added to the endpointState in the order in which you assign versions (which this patch provides), there should be no problem. This should be a low bar to clear for anyone who really wants to muck around in gossip-land &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="14139561" author="brandon.williams" created="Thu, 18 Sep 2014 21:38:19 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="14636139" author="peter-librato" created="Wed, 22 Jul 2015 02:48:04 +0000"  >&lt;p&gt;We&apos;ve seen this bug or something like it on 2.0.11 with 45 nodes in a fairly noisy AWS environment but other than &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8336&quot; title=&quot;Add shutdown gossip state to prevent timeouts during rolling restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8336&quot;&gt;&lt;del&gt;CASSANDRA-8336&lt;/del&gt;&lt;/a&gt; I don&apos;t see any fixes to gossip post 2.0.11.&lt;/p&gt;

&lt;p&gt;The nodetool status command doesn&apos;t list the node that does&apos;t have status info. It&apos;s not up or down, it&apos;s simply not there and this impacts % ownership.&lt;br/&gt;
In a recent instance of this 4 nodes had the same &quot;status hole&quot; but only 2 of the 4 had different nodetool ring output compared to the other 41 &quot;no status hole&quot; members of the ring.&lt;/p&gt;

&lt;p&gt;Restarting cassandra on the node that has a missing STATUS entry in gossip &quot;fixes&quot; the problem in that the hole goes away. This is something we used to see more commonly before 2.0.11 so it does appear this fix works but are there other places where a race might be happening?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/10.xx.yyy.169
  generation:1436544814
  heartbeat:2986679
  SEVERITY:0.0
  HOST_ID:7d22299f-b35b-4035-82bc-e2b603a655d7
  LOAD:2.555557836E11
  RACK:1e
  NET_VERSION:7
  DC:us-east
  RPC_ADDRESS:10.xx.yyy.169
  RELEASE_VERSION:2.0.11
  SCHEMA:0f72be52-2751-33a6-a172-8511e943b2ec
/10.xx.yyy.175
  generation:1419877470
  heartbeat:53496976
  SEVERITY:1.2787723541259766
  HOST_ID:c87ed8db-76b6-485a-ac2f-32c2822b1ef5
  LOAD:3.08812188602E11
  RACK:1e
  NET_VERSION:7
  STATUS:NORMAL,-1010822684895662807
  DC:us-east
  RPC_ADDRESS:10.xx.yyy.175
  RELEASE_VERSION:2.0.11
  SCHEMA:0f72be52-2751-33a6-a172-8511e943b2ec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12664859">CASSANDRA-5913</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12669797" name="6125.txt" size="7278" author="brandon.williams" created="Thu, 18 Sep 2014 20:34:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351354</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1okvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351646</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>