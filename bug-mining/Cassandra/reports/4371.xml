<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12220] utest RowIndexEntryTest.testC11206AgainstPreviousArray/Shallow failure</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12220</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The unit tests &lt;tt&gt;RowIndexEntryTest.testC11206AgainstPreviousArray&lt;/tt&gt; and &lt;tt&gt;RowIndexEntryTest.testC11206AgainstPreviousShallow&lt;/tt&gt; fail after &lt;a href=&quot;https://github.com/apache/cassandra/commit/70fd80ae43f3902e651c956b6d4d07cbc203d30a#diff-75146ba408a51071a0b19ffdfbb2bb3cL307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this single line change&lt;/a&gt; as shown in &lt;a href=&quot;http://cassci.datastax.com/view/trunk/job/trunk_testall/1044/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this build&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Reverting that line to &lt;tt&gt;new HashMap&amp;lt;&amp;gt;()&lt;/tt&gt; fixes the unit test issues - but &lt;em&gt;does not&lt;/em&gt; explain why it fails, since initializing a collection with the expected size should not change the overall behaviour. There seems to be something else being wrong.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dbrosius&quot; class=&quot;user-hover&quot; rel=&quot;dbrosius&quot;&gt;dbrosius&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12990247">CASSANDRA-12220</key>
            <summary>utest RowIndexEntryTest.testC11206AgainstPreviousArray/Shallow failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="snazy">Robert Stupp</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jul 2016 03:51:10 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:26 +0000</updated>
                            <resolved>Tue, 19 Jul 2016 08:12:01 +0000</resolved>
                                                            <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15381750" author="dbrosius" created="Mon, 18 Jul 2016 05:37:56 +0000"  >&lt;p&gt;odd. obstensibly, the difference is in &lt;/p&gt;

&lt;p&gt;UnfilteredSerializer.serializeRowBody&lt;/p&gt;

&lt;p&gt;where in the broken case, the row has column &lt;span class=&quot;error&quot;&gt;&amp;#91;ck&amp;#93;&lt;/span&gt;, when it should have column &lt;span class=&quot;error&quot;&gt;&amp;#91;val&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Thus the BTreeSearchIterator can&apos;t find it, and returns null&lt;/p&gt;

&lt;p&gt;        for (ColumnData data : row)&lt;br/&gt;
        {&lt;br/&gt;
            ColumnDefinition column = si.next(data.column());&lt;/p&gt;



&lt;p&gt;looking...&lt;/p&gt;</comment>
                            <comment id="15381904" author="slebresne" created="Mon, 18 Jul 2016 08:42:26 +0000"  >&lt;p&gt;Can we revert the commit in the meantime?&lt;/p&gt;</comment>
                            <comment id="15381963" author="dbrosius" created="Mon, 18 Jul 2016 09:18:05 +0000"  >&lt;p&gt;reverted, with 299ab74f4ae78319c9ca67ccd8251656078b798c&lt;/p&gt;</comment>
                            <comment id="15383526" author="dbrosius" created="Tue, 19 Jul 2016 03:27:30 +0000"  >&lt;p&gt;When the test works (new HashMap), CFMetaData.columnMetaData is laid out in memory as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;{java.nio.HeapByteBuffer[pos=0 lim=3 cap=3]=val, 
java.nio.HeapByteBuffer[pos=0 lim=2 cap=2]=pk, 
java.nio.HeapByteBuffer[pos=0 lim=2 cap=2]=ck}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When it doesn&apos;t work (Maps.newHashMapWithExpectedSize) the order is&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.nio.HeapByteBuffer[pos=0 lim=2 cap=2]=ck,
java.nio.HeapByteBuffer[pos=0 lim=2 cap=2]=pk,
{java.nio.HeapByteBuffer[pos=0 lim=3 cap=3]=val}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;given that this is a HashMap the difference is explained naturally by the different allocation size.&lt;/p&gt;

&lt;p&gt;The problem is then, that in TreeCursor.seekTo, it expects the columns to be visited in alphabetic order, where you see&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key == test) cmp = 0; &lt;span class=&quot;code-comment&quot;&gt;// check object identity first, since we utilise that in some places and it&apos;s very cheap
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; cmp = comparator.compare(test, key); &lt;span class=&quot;code-comment&quot;&gt;// order of provision matters &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; asymmetric comparators
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (forwards ? cmp &amp;gt;= 0 : cmp &amp;lt;= 0)
            {
                &lt;span class=&quot;code-comment&quot;&gt;// we&apos;ve either matched, or excluded the value from being present
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.cur = cur;
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cmp == 0;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in this case key (ck) is not test (val), and so jumps to the else, which forwards == true, and cmp == 1, and thus returns false for seekTo.&lt;/p&gt;

&lt;p&gt;This causes stuff to fail.&lt;/p&gt;

&lt;p&gt;I can only assume i&apos;m missing something else, because one would think this would be failing all over the place, and one assumes it&apos;s not.&lt;/p&gt;</comment>
                            <comment id="15383765" author="slebresne" created="Tue, 19 Jul 2016 08:11:52 +0000"  >&lt;p&gt;That&apos;s really just a test problem. The test was creating a cell using &lt;tt&gt;cfMeta.allColumns().iterator().next()&lt;/tt&gt;, which as the name imply, may return any column including a primary key one (and turns out whether it returned one or not was changing by pre-sizing the collection), while cells are only for non-primary key columns.&lt;/p&gt;

&lt;p&gt;Since that&apos;s only a test problem and a pretty trivial one at that, I took the liberty of ninja-committing the fix in commit  9659a389ca7fe8e96779a73448cb078375f0880a. I also added a assertion in &lt;tt&gt;BufferCell&lt;/tt&gt; so that kind of problem is much more easily detected next time. I haven&apos;t re-committed the collection pre-sizing patch though, and feel free to do so, but it could be nice to do a quick unit test run on it to check everything is now fine (I only quickly testing the test that failed here).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31413:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>