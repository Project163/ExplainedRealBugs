<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8516] NEW_NODE topology event emitted instead of MOVED_NODE by moving node</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8516</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As discovered in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8373&quot; title=&quot;MOVED_NODE Topology Change event is never emitted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8373&quot;&gt;&lt;del&gt;CASSANDRA-8373&lt;/del&gt;&lt;/a&gt;, when you move a node in a single-node cluster, a &lt;tt&gt;NEW_NODE&lt;/tt&gt; event is generated instead of a &lt;tt&gt;MOVED_NODE&lt;/tt&gt; event.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12762731">CASSANDRA-8516</key>
            <summary>NEW_NODE topology event emitted instead of MOVED_NODE by moving node</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Dec 2014 00:33:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:25 +0000</updated>
                            <resolved>Wed, 25 Mar 2015 15:13:05 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14339489" author="stefania" created="Fri, 27 Feb 2015 00:52:45 +0000"  >&lt;p&gt;At &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;, I think that the problematic call to &lt;tt&gt;updateNormalTokens&lt;/tt&gt; is in SS.&lt;tt&gt;setTokens()&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;Is it possible to rely on &lt;tt&gt;StorageService.operatingMode&lt;/tt&gt; (&lt;tt&gt;Mode.MOVING&lt;/tt&gt;) instead of or along with the moving tokens? I works if we call move on the local node but does it get called in other contexts too (e.g. Gossip)?&lt;/p&gt;

&lt;p&gt;Also, I reproduced the problem with &lt;tt&gt;nodetool move 123&lt;/tt&gt; but I kept on getting the exception below, which I could only bypass it by commenting it out:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getTokenMetadata().getTokens(localAddress).size() &amp;gt; 1)
         {
         logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid request to move(Token); This node has more than one token and cannot be moved thusly.&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsupportedOperationException(&lt;span class=&quot;code-quote&quot;&gt;&quot;This node has more than one token and cannot be moved thusly.&quot;&lt;/span&gt;);
         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Could I have the correct command or config to reproduce this issue on 2.1 along with any other suggested tests (single node / multiple node clusters), and do we need to test drivers too or is it enough to check that we call &lt;tt&gt;onMove&lt;/tt&gt; rather than &lt;tt&gt;onJoinCluster&lt;/tt&gt; in SS.&lt;tt&gt;handleStateNormal&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Thanks! &lt;/p&gt;</comment>
                            <comment id="14339560" author="brandon.williams" created="Fri, 27 Feb 2015 01:38:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, I reproduced the problem with nodetool move 123 but I kept on getting the exception below&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You need to set num_tokens: 1 in the yaml, vnodes don&apos;t support move.&lt;/p&gt;</comment>
                            <comment id="14340731" author="thobbs" created="Fri, 27 Feb 2015 20:03:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; I had a quick look at the code, and I think the root of the problem is that &lt;tt&gt;updateNormalTokens()&lt;/tt&gt; changes the node from the MOVING state to the NORMAL state.  Later, &lt;tt&gt;StorageService.handleStateNormal()&lt;/tt&gt; is also called for the node (this happens in response to gossip state changes); when it checks to see if the node&apos;s state was MOVING, it has already been changed, so it believes the node is joining.&lt;/p&gt;

&lt;p&gt;That makes me think this isn&apos;t only a problem for single-node clusters.  Instead, the moving node will always emit a NEW_NODE notification, and every other node will emit a MOVED_NODE notification.&lt;/p&gt;

&lt;p&gt;As far as testing goes, I was just using a python script with debug logging enabled, because the python driver will log any pushed notifications.  However, we do need a better testing method for this.  I&apos;ll work on getting a dtest environment set up for this real quick.&lt;/p&gt;</comment>
                            <comment id="14340788" author="thobbs" created="Fri, 27 Feb 2015 20:52:00 +0000"  >&lt;p&gt;I started a dtest suite here: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/blob/28dff082090932a047f4e74316d907fbe6df6aa9/pushed_notifications_test.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/blob/28dff082090932a047f4e74316d907fbe6df6aa9/pushed_notifications_test.py&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can run the test like so:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CASSANDRA_DIR=/path/to/cassandra DISABLE_VNODES=true nosetests pushed_notifications_test.py
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As I suspected, the test does fail with a multi-node cluster.&lt;/p&gt;</comment>
                            <comment id="14342875" author="stefania" created="Mon, 2 Mar 2015 07:29:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; thank you for the dtest.&lt;/p&gt;

&lt;p&gt;I was able to pass the test with two fixes, patches attached, one is trivial and one is a little bit more convoluted but perhaps safer:
&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Patch A, we just look at the operating mode in addition to the moving endpoints - this woks because &lt;tt&gt;setTokens()&lt;/tt&gt; only changes the operating mode to NORMAL at the very end and so the moving node can use this whilst the other nodes still look at the moving endpoints.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Patch B, we add a new &lt;tt&gt;VersionedValue&lt;/tt&gt; called &quot;MOVED&quot; and we GOSSIP this around so that we know if we are entering a normal state following a JOIN or a MOVE. It is set in SS.&lt;tt&gt;move&lt;/tt&gt; by passing a parameter to &lt;tt&gt;setTokens&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Both patches are for 2.1. Let me know if you are happy with one of the two or if I should look further, changing the behavior or calling points of &lt;tt&gt;updateNormalTokens()&lt;/tt&gt; looked a lot riskier, so I did not go down this route.&lt;/p&gt;

&lt;p&gt;I also attached another patch, for the dtest, at least with the latest git source code of the python driver, I had to specify that the connection is a control connection otherwise it wouldn&apos;t receive the notifications.&lt;/p&gt;</comment>
                            <comment id="14344765" author="stefania" created="Tue, 3 Mar 2015 09:03:11 +0000"  >&lt;p&gt;The dtest patch is available in this pull request: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/177&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14380031" author="brandon.williams" created="Wed, 25 Mar 2015 15:13:05 +0000"  >&lt;p&gt;I went with patch A and committed that.  If we want to revisit the B approach, let&apos;s do that for 3.0 in another ticket, otherwise I&apos;m satisfied.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12702681" name="8516-v2.1-a.txt" size="1040" author="stefania" created="Thu, 5 Mar 2015 02:55:26 +0000"/>
                            <attachment id="12702682" name="8516-v2.1-b.txt" size="8770" author="stefania" created="Thu, 5 Mar 2015 02:55:26 +0000"/>
                            <attachment id="12701814" name="cassandra_8516_dtest.txt" size="877" author="stefania" created="Mon, 2 Mar 2015 07:29:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23lof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>