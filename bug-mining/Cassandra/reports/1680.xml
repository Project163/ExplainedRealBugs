<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:33:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4321] stackoverflow building interval tree &amp; possible sstable corruptions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4321</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After upgrading to 1.1.1 (from 1.1.0) I have started experiencing StackOverflowError&apos;s resulting in compaction backlog and failure to restart. &lt;/p&gt;

&lt;p&gt;The ring currently consists of 6 DC&apos;s and 22 nodes using LCS &amp;amp; compression.  This issue was first noted on 2 nodes in one DC and then appears to have spread to various other nodes in the other DC&apos;s.  &lt;/p&gt;

&lt;p&gt;When the first occurrence of this was found I restarted the instance but it failed to start so I cleared its data and treated it as a replacement node for the token it was previously responsible for.  This node successfully streamed all the relevant data back but failed again a number of hours later with the same StackOverflowError and again was unable to restart. &lt;/p&gt;

&lt;p&gt;The initial stack overflow error on a running instance looks like this:&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:314&amp;#93;&lt;/span&gt; 2012-06-07 09:59:43,017 AbstractCassandraDaemon.java (line 134) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:314,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.StackOverflowError&lt;br/&gt;
        at java.util.Arrays.mergeSort(Arrays.java:1157)&lt;br/&gt;
        at java.util.Arrays.sort(Arrays.java:1092)&lt;br/&gt;
        at java.util.Collections.sort(Collections.java:134)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.findMinMedianMax(IntervalNode.java:114)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:49)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;snip - this repeats until stack overflow.  Compactions stop from this point onwards&amp;#93;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;I restarted this failing instance with DEBUG logging enabled and it throws the following exception part way through startup:&lt;/p&gt;

&lt;p&gt;ERROR 11:37:51,046 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;OptionalTasks:1,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.StackOverflowError&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.safeObjectAppend(MessageFormatter.java:307)&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.deeplyAppendParameter(MessageFormatter.java:276)&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.arrayFormat(MessageFormatter.java:230)&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.format(MessageFormatter.java:124)&lt;br/&gt;
        at org.slf4j.impl.Log4jLoggerAdapter.debug(Log4jLoggerAdapter.java:228)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:45)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;snip - this repeats until stack overflow&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalTree.&amp;lt;init&amp;gt;(IntervalTree.java:39)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.buildIntervalTree(DataTracker.java:560)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker$View.replace(DataTracker.java:617)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.replace(DataTracker.java:320)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.addInitialSSTables(DataTracker.java:259)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:234)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:331)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:309)&lt;br/&gt;
        at org.apache.cassandra.db.Table.initCf(Table.java:367)&lt;br/&gt;
        at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:299)&lt;br/&gt;
        at org.apache.cassandra.db.Table.open(Table.java:114)&lt;br/&gt;
        at org.apache.cassandra.db.Table.open(Table.java:97)&lt;br/&gt;
        at org.apache.cassandra.db.Table$2.apply(Table.java:574)&lt;br/&gt;
        at org.apache.cassandra.db.Table$2.apply(Table.java:571)&lt;br/&gt;
        at com.google.common.collect.Iterators$8.next(Iterators.java:751)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.all(ColumnFamilyStore.java:1625)&lt;br/&gt;
        at org.apache.cassandra.db.MeteredFlusher.countFlushingBytes(MeteredFlusher.java:118)&lt;br/&gt;
        at org.apache.cassandra.db.MeteredFlusher.run(MeteredFlusher.java:45)&lt;br/&gt;
        at org.apache.cassandra.concurrent.DebuggableScheduledThreadPoolExecutor$UncomplainingRunnable.run(DebuggableScheduledThreadPoolExecutor.java:79)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:351)&lt;br/&gt;
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:178)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:165)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:267)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;br/&gt;
DEBUG 11:37:51,052 Initializing ksU.cfS&lt;/p&gt;


&lt;p&gt;And then finally fails with the following:&lt;/p&gt;

&lt;p&gt;DEBUG 11:49:03,752 Creating IntervalNode from &lt;span class=&quot;error&quot;&gt;&amp;#91;Interval(DecoratedKey(104860264640932324846851821824650966808, 4fcc88eb0218216164673394), DecoratedKey(93975306025956344620001177071135439009, 4fc8fb042c98458c7a58bc3b)), Interval(DecoratedKey(104860264640932324846851821824650966808, 4fcc88eb0218216164673394), DecoratedKey(93975306025956344620001177071135439009, 4fc8fb042c98458c7a58bc3b)), Interval(DecoratedKey(104860264640932324846851821824650966808, 4fcc88eb0218216164673394), DecoratedKey(93975306025956344620001177071135439009, 4fc8fb042c98458c7a58bc3b)), Interval(DecoratedKey(104860264640932324846851821824650966808, 4fcc88eb0218216164673394), DecoratedKey(93975306025956344620001177071135439009, 4fc8fb042c98458c7a58bc3b)), Interval(DecoratedKey(104860264640932324846851821824650966808, 4fcc88eb0218216164673394), DecoratedKey(93975306025956344620001177071135439009, 4fc8fb042c98458c7a58bc3b)), Interval(DecoratedKey(104860264640932324846851821824650966808, 4fcc88eb0218216164673394), DecoratedKey(93975306025956344620001177071135439009, 4fc8fb042c98458c7a58bc3b))&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.reflect.InvocationTargetException&lt;br/&gt;
DEBUG 11:49:03,753 Configured datacenter replicas are dc1:2, dc2:2, dc3:2, dc4:2, dc5:0, dc6:2, dc7:0, dc8:0, dc9:2&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:616)&lt;br/&gt;
        at org.apache.commons.daemon.support.DaemonLoader.load(DaemonLoader.java:160)&lt;br/&gt;
Caused by: java.lang.StackOverflowError&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.safeObjectAppend(MessageFormatter.java:307)&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.deeplyAppendParameter(MessageFormatter.java:276)&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.arrayFormat(MessageFormatter.java:230)&lt;br/&gt;
        at org.slf4j.helpers.MessageFormatter.format(MessageFormatter.java:124)&lt;br/&gt;
        at org.slf4j.impl.Log4jLoggerAdapter.debug(Log4jLoggerAdapter.java:228)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:45)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;snip - this repeats until stack overflow&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)&lt;br/&gt;
        at org.apache.cassandra.utils.IntervalTree.IntervalTree.&amp;lt;init&amp;gt;(IntervalTree.java:39)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.buildIntervalTree(DataTracker.java:560)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker$View.replace(DataTracker.java:617)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.replace(DataTracker.java:320)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.addInitialSSTables(DataTracker.java:259)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:234)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:331)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:309)&lt;br/&gt;
        at org.apache.cassandra.db.Table.initCf(Table.java:367)&lt;br/&gt;
        at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:299)&lt;br/&gt;
        at org.apache.cassandra.db.Table.open(Table.java:114)&lt;br/&gt;
        at org.apache.cassandra.db.Table.open(Table.java:97)&lt;br/&gt;
        at org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:204)&lt;br/&gt;
        at org.apache.cassandra.service.AbstractCassandraDaemon.init(AbstractCassandraDaemon.java:254)&lt;br/&gt;
        ... 5 more&lt;br/&gt;
Cannot load daemon&lt;br/&gt;
Service exit with a return value of 3&lt;/p&gt;

&lt;p&gt;Running with assertions enabled allows me to start the instance but when doing so I get errors such as:&lt;/p&gt;

&lt;p&gt;ERROR 01:22:22,753 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;SSTableBatchOpen:2,5,main&amp;#93;&lt;/span&gt;java.lang.AssertionError: SSTable first key DecoratedKey(100294972947100949193477090306072672386, 4fcf051ef5067d7f17d9fc35) &amp;gt; last key DecoratedKey(90250429663386465697464050082134975058, 4fce996e3c1eed8c4b17dd66)&lt;br/&gt;
at org.apache.cassandra.io.sstable.SSTableReader.load(SSTableReader.java:412)&lt;br/&gt;
at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:187)&lt;br/&gt;
at org.apache.cassandra.io.sstable.SSTableReader$1.run(SSTableReader.java:225)&lt;br/&gt;
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:636)&lt;/p&gt;

&lt;p&gt;and:&lt;/p&gt;

&lt;p&gt;ERROR 01:27:58,946 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: Last written key DecoratedKey(81958437188197992567937826278457419048, 4fa1aebad23f81e4321d344d) &amp;gt;= current key DecoratedKey(64546479828744423263742604083767363606, 4fcafc0f19f6a8092d4d4f94) writing into /var/lib/XX/data/cassandra/ks1/cf1/ks1-cf1-tmp-hd-657317-Data.db&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:134)&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:153)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:159)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;/p&gt;

&lt;p&gt;Just like the initial errors compactions appear to stop occurring after this point.  &lt;/p&gt;

&lt;p&gt;Given the above this looks like sstables are getting corrupted.  By restarting nodes I am able to identify several hundred sstables exhibiting the same problem and this appears to be growing.&lt;/p&gt;

&lt;p&gt;I have tried scrubbing those affected nodes but the problem continues to occur.  If this is due to sstable corruptions is there another way of validating sstables for correctness?  Given that it has spread to various servers in other DC&apos;s it looks like this is directly related to the 1.1.1 upgrade recently performed on the ring.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12559783">CASSANDRA-4321</key>
            <summary>stackoverflow building interval tree &amp; possible sstable corruptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="awinter">Anton Winter</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Fri, 8 Jun 2012 02:00:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:32 +0000</updated>
                            <resolved>Fri, 29 Jun 2012 09:20:16 +0000</resolved>
                                        <fixVersion>1.1.2</fixVersion>
                                        <due></due>
                            <votes>5</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13291511" author="jbellis" created="Fri, 8 Jun 2012 02:31:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;SSTable first key DecoratedKey(100294972947100949193477090306072672386, 4fcf051ef5067d7f17d9fc35) &amp;gt; last key DecoratedKey(90250429663386465697464050082134975058, 4fce996e3c1eed8c4b17dd66)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Cassandra checks key ordering for correctness with every row that is added at write time, so unless you changed your partitioner (which is emphatically Not Supported), I&apos;m not sure how this can happen.  Whatever it is, it&apos;s unlikely to be related to the 1.1.1 upgrade.&lt;/p&gt;

&lt;p&gt;Scrub checks that the sstable content is well-formed and readable.  It doesn&apos;t check for out-of-order rows.  You can use a tool like sstablekeys to do that.&lt;/p&gt;</comment>
                            <comment id="13291520" author="awinter" created="Fri, 8 Jun 2012 02:48:57 +0000"  >&lt;p&gt;The partitioner (RP) was not changed.&lt;/p&gt;</comment>
                            <comment id="13291841" author="jsotelo" created="Fri, 8 Jun 2012 16:15:20 +0000"  >&lt;p&gt;We are also seeing this. We also upgraded from 1.1.0 to 1.1.1. This problem only started after the upgrade. Our cluster is smaller, two DCs of 3 nodes each.&lt;/p&gt;</comment>
                            <comment id="13291846" author="jsotelo" created="Fri, 8 Jun 2012 16:27:29 +0000"  >&lt;p&gt;Our stack overflow is a little different though:&lt;/p&gt;


&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:35&amp;#93;&lt;/span&gt; 2012-06-08 15:52:42,086 AbstractCassandraDaemon.java (line 134) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:35,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.StackOverflowError&lt;br/&gt;
        at java.util.AbstractList$Itr.hasNext(Unknown Source)&lt;br/&gt;
        at com.google.common.collect.Iterators$5.hasNext(Iterators.java:517)&lt;br/&gt;
        at com.google.common.collect.Iterators$3.hasNext(Iterators.java:114)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;repeats&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;        at com.google.common.collect.Iterators$5.hasNext(Iterators.java:517)&lt;br/&gt;
        at com.google.common.collect.Iterators$3.hasNext(Iterators.java:114)&lt;br/&gt;
        at com.google.common.collect.Iterators$7.computeNext(Iterators.java:614)&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)&lt;br/&gt;
        at com.google.common.collect.Iterators.size(Iterators.java:129)&lt;br/&gt;
        at com.google.common.collect.Sets$3.size(Sets.java:670)&lt;br/&gt;
        at com.google.common.collect.Iterables.size(Iterables.java:80)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.buildIntervalTree(DataTracker.java:557)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionController.&amp;lt;init&amp;gt;(CompactionController.java:79)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:105)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(Unknown Source)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)&lt;br/&gt;
        at java.lang.Thread.run(Unknown Source)&lt;/p&gt;
</comment>
                            <comment id="13291958" author="omid" created="Fri, 8 Jun 2012 20:17:12 +0000"  >&lt;p&gt;We&apos;re seeing the same issue after upgrading from 1.0.9 to 1.1.1 on only a single node in a 16 node cluster. Wiping the data off and bootstrapping again didn&apos;t help. Compaction looks to be not progressing (according to compactionstats) and I can reproduce this on every &quot;nodetool flush&quot;.&lt;/p&gt;</comment>
                            <comment id="13292773" author="jbellis" created="Mon, 11 Jun 2012 12:26:36 +0000"  >&lt;p&gt;Omid, just to verify &amp;#8211; are you also using LeveledCompactionStrategy?&lt;/p&gt;</comment>
                            <comment id="13292779" author="omid" created="Mon, 11 Jun 2012 12:34:42 +0000"  >&lt;p&gt;Jonathan, yes I use LeveledCompactionStrategy with non-default sstable_size_in_mb = 10&lt;/p&gt;</comment>
                            <comment id="13292844" author="slebresne" created="Mon, 11 Jun 2012 15:44:03 +0000"  >&lt;p&gt;I believe I may have an idea on what&apos;s going on here. When computing overlapping sstables, LeveledManifest was using Range, which excludes its left bound, but sstable intervals are fully inclusive. This means the computation is incorrect when multiple sstables have the same start token. But that in turn is very much possible across levels. This also seem to fit the stack traces above as those mention interval trees where all the sstable actually have the same first and last token.&lt;/p&gt;

&lt;p&gt;This is not really a new bug, but I believe that prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4142&quot; title=&quot;OOM Exception during repair session with LeveledCompactionStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4142&quot;&gt;&lt;del&gt;CASSANDRA-4142&lt;/del&gt;&lt;/a&gt;, this had less consequences.&lt;/p&gt;

&lt;p&gt;Attaching a patch that fixes this by using Bounds instead of Range. But since this but ended up creating sstables with out of order keys, I&apos;m also attaching a second patch that add the ability to scrub to detect this and &quot;repair&quot; the situation. This is far from perfect in that the way to &quot;repair&quot; consists in buffering the out of order rows and write them all in order in a new sstable. So this can easily OOM if the sstable has lots of out of order rows. But I suppose this is better than nothing. There is a unit test included to check that new feature of scrub.&lt;/p&gt;

&lt;p&gt;Note that I believe this patch (at least the first one) must be committed to 1.0 too.&lt;/p&gt;</comment>
                            <comment id="13292851" author="jbellis" created="Mon, 11 Jun 2012 15:53:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;this can easily OOM if the sstable has lots of out of order rows&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is that likely, given that Range vs Bounds is basically an off-by-one?&lt;/p&gt;</comment>
                            <comment id="13292855" author="jbellis" created="Mon, 11 Jun 2012 16:03:50 +0000"  >&lt;p&gt;Backing up: how does incorrect overlapping sets result in out-of-order key writes (that pass that last-written-key check)?&lt;/p&gt;</comment>
                            <comment id="13292856" author="slebresne" created="Mon, 11 Jun 2012 16:04:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is that likely, given that Range vs Bounds is basically an off-by-one&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The thing is, even an off-by-one is enough to have essentially 2 identical sstable on the same level. If so, our new by-level-iterator will happily write a new sstable that is a concatenation of both of those and we&apos;ll end up with half of the resulting sstable being out of order.&lt;/p&gt;

&lt;p&gt;That being said, now that you mention it, leveled limits the size of sstables so we should be good on that front.&lt;/p&gt;</comment>
                            <comment id="13292858" author="jbellis" created="Mon, 11 Jun 2012 16:04:44 +0000"  >&lt;p&gt;Comment on the patch itself: intersects is missing the case of &lt;tt&gt;that&lt;/tt&gt; entirely containing &lt;tt&gt;this&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13292937" author="slebresne" created="Mon, 11 Jun 2012 18:09:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;how does incorrect overlapping sets result in out-of-order key writes (that pass that last-written-key check)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The last-written-key check is an assertion, so if assertion are disabled this may happen. And the following excerpt of the description above make me believe assertions weren&apos;t enabled when the problem occured first:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Running with assertions enabled allows me to start the instance but when doing so I get errors such as:
ERROR 01:22:22,753 Exception in thread Thread[SSTableBatchOpen:2,5,main]java.lang.AssertionError: SSTable first key DecoratedKey(100294972947100949193477090306072672386, 4fcf051ef5067d7f17d9fc35) &amp;gt; last key DecoratedKey(90250429663386465697464050082134975058, 4fce996e3c1eed8c4b17dd66)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;intersects is missing the case of that entirely containing this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oups, you&apos;re right. Attaching a v2 of the first patch that fixes that and also turn the last-written-key check into a RuntimeException, since  this is an important check.&lt;/p&gt;</comment>
                            <comment id="13293005" author="jbellis" created="Mon, 11 Jun 2012 19:23:13 +0000"  >&lt;p&gt;v2 LGTM (nit: would like to rename variables to xBounds instead of xRange)&lt;/p&gt;

&lt;p&gt;re 0002, does this actually work w/ LCR?  &lt;/p&gt;</comment>
                            <comment id="13293412" author="awinter" created="Tue, 12 Jun 2012 07:35:53 +0000"  >&lt;p&gt;If I use the v2 patch startup stops with the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO [main] 2012-06-12 14:23:33,899 ColumnFamilyStore.java (line 633) Enqueuing flush of Memtable-LocationInfo@1141455324(41/51 serialized/live bytes, 1 ops)
 INFO [FlushWriter:2] 2012-06-12 14:23:33,903 Memtable.java (line 266) Writing Memtable-LocationInfo@1141455324(41/51 serialized/live bytes, 1 ops)
ERROR [FlushWriter:2] 2012-06-12 14:23:33,953 AbstractCassandraDaemon.java (line 134) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[FlushWriter:2,5,main]java.lang.RuntimeException: Last written key &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;gt;= current key DecoratedKey(61078635599166706937511052402724559481, 4c) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/cassandra/system/LocationInfo/system-LocationInfo-tmp-hd-65597-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Given the above I (probably incorrectly) scrubbed the system keyspace which removed all sstables, leaving only the snapshots eg:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; WARN [CompactionExecutor:5] 2012-06-12 14:29:41,672 CompactionManager.java (line 651) Row at 100 is unreadable; skipping to next
 WARN [CompactionExecutor:5] 2012-06-12 14:29:41,672 CompactionManager.java (line 602) Non-fatal error reading row (stacktrace follows)
java.lang.RuntimeException: Last written key &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;gt;= current key DecoratedKey(135285944860343992175601105924967452217, 63716c) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/data/cassandra/system/Versions/system-Versions-tmp-hd-37-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;..eventually resulting in&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN [CompactionExecutor:5] 2012-06-12 14:29:41,674 CompactionManager.java (line 692) No valid rows found &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; scrubbing SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/data/cassandra/system/Versions/system-Versions-hd-35-Data.db&apos;&lt;/span&gt;); it is marked &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion now. If you want to attempt manual recovery, you can find a copy in the pre-scrub snapshot
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A clean bootstrap also stops with similar errors:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: Last written key &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;gt;= current key DecoratedKey(61078635599166706937511052402724559481, 4c) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/data/cassandra/system/LocationInfo/system-LocationInfo-tmp-hd-1-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: Last written key &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;gt;= current key DecoratedKey(93220794208128599841715671226150005828, 746872696674) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/data/cassandra/system/Versions/system-Versions-tmp-hd-1-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13293453" author="slebresne" created="Tue, 12 Jun 2012 08:45:22 +0000"  >&lt;p&gt;My bad, I screwed up the assertion -&amp;gt; RuntimeException transition. Attaching v3 that fixes this and renames variables from xRange to xBounds.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;re 0002, does this actually work w/ LCR?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good question &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I honestly haven&apos;t tested it, but it should since LCR resets the underlying SSTableIdentityIterator before each iteration (it shouldn&apos;t make any difference that you reset while at the end of the row or at the end of the file).&lt;/p&gt;</comment>
                            <comment id="13293762" author="omid" created="Tue, 12 Jun 2012 16:52:52 +0000"  >&lt;p&gt;Tried the patch but the server still doesn&apos;t start. The StackOverFlow that gets thrown causes an already loaded column family to be loaded again:&lt;/p&gt;

&lt;p&gt;Load CF1:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;reading saved cache /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/saved_caches/SOMEKSP-CF1-KeyCache
2012-06-12_16:18:04.12387  INFO 16:18:04,123 Opening /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF1/SOMEKSP-CF1-hd-2248
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Load CF3 which has the corrupted sstables&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-12_15:31:20.56185  INFO 15:31:20,561 Opening /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-7924 (2372910 bytes)
2012-06-12_15:31:20.81897 ERROR 15:31:20,811 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[OptionalTasks:1,5,main]
2012-06-12_15:31:20.81901 java.lang.StackOverflowError
2012-06-12_15:31:20.81901 	at org.apache.cassandra.db.DecoratedKey.compareTo(DecoratedKey.java:90)
2012-06-12_15:31:20.81906 	at org.apache.cassandra.db.DecoratedKey.compareTo(DecoratedKey.java:38)
2012-06-12_15:31:20.81918 	at java.util.Arrays.mergeSort(Unknown Source)
2012-06-12_15:31:20.81927 	at java.util.Arrays.mergeSort(Unknown Source)
2012-06-12_15:31:20.81934 	at java.util.Arrays.mergeSort(Unknown Source)
2012-06-12_15:31:20.81940 	at java.util.Arrays.mergeSort(Unknown Source)
2012-06-12_15:31:20.81946 	at java.util.Arrays.mergeSort(Unknown Source)
2012-06-12_15:31:20.81954 	at java.util.Arrays.sort(Unknown Source)
2012-06-12_15:31:20.81960 	at java.util.Collections.sort(Unknown Source)
2012-06-12_15:31:20.81980 	at org.apache.cassandra.utils.IntervalTree.IntervalNode.findMinMedianMax(IntervalNode.java:114)
2012-06-12_15:31:20.81981 	at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:49)
2012-06-12_15:31:20.81990 	at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:62)

&lt;span class=&quot;code-comment&quot;&gt;// stacktrace goes on
&lt;/span&gt;
2012-06-12_15:31:20.88633 	at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)
2012-06-12_15:31:20.88643 	at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:64)
2012-06-12_15:31:20.88654 	at org.apache.cassandra.utils.IntervalTree.IntervalTree.&amp;lt;init&amp;gt;(IntervalTree.java:39)
2012-06-12_15:31:20.88664 	at org.apache.cassandra.db.DataTracker.buildIntervalTree(DataTracker.java:560)
2012-06-12_15:31:20.88673 	at org.apache.cassandra.db.DataTracker$View.replace(DataTracker.java:617)
2012-06-12_15:31:20.88683 	at org.apache.cassandra.db.DataTracker.replace(DataTracker.java:320)
2012-06-12_15:31:20.88692 	at org.apache.cassandra.db.DataTracker.addInitialSSTables(DataTracker.java:259)
2012-06-12_15:31:20.88702 	at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:234)
2012-06-12_15:31:20.88712 	at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:331)
2012-06-12_15:31:20.88723 	at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:309)
2012-06-12_15:31:20.88734 	at org.apache.cassandra.db.Table.initCf(Table.java:367)
2012-06-12_15:31:20.88742 	at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:299)
2012-06-12_15:31:20.88750 	at org.apache.cassandra.db.Table.open(Table.java:114)
2012-06-12_15:31:20.88758 	at org.apache.cassandra.db.Table.open(Table.java:97)
2012-06-12_15:31:20.88766 	at org.apache.cassandra.db.Table$2.apply(Table.java:574)
2012-06-12_15:31:20.88773 	at org.apache.cassandra.db.Table$2.apply(Table.java:571)
2012-06-12_15:31:20.88782 	at com.google.common.collect.Iterators$8.next(Iterators.java:751)
2012-06-12_15:31:20.88790 	at org.apache.cassandra.db.ColumnFamilyStore.all(ColumnFamilyStore.java:1625)
2012-06-12_15:31:20.88800 	at org.apache.cassandra.db.MeteredFlusher.countFlushingBytes(MeteredFlusher.java:118)
2012-06-12_15:31:20.88810 	at org.apache.cassandra.db.MeteredFlusher.run(MeteredFlusher.java:45)
2012-06-12_15:31:20.88818 	at org.apache.cassandra.concurrent.DebuggableScheduledThreadPoolExecutor$UncomplainingRunnable.run(DebuggableScheduledThreadPoolExecutor.java:79)
2012-06-12_15:31:20.88833 	at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)
2012-06-12_15:31:20.88842 	at java.util.concurrent.FutureTask$Sync.innerRunAndReset(Unknown Source)
2012-06-12_15:31:20.88851 	at java.util.concurrent.FutureTask.runAndReset(Unknown Source)
2012-06-12_15:31:20.88860 	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(Unknown Source)
2012-06-12_15:31:20.88870 	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(Unknown Source)
2012-06-12_15:31:20.88882 	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(Unknown Source)
2012-06-12_15:31:20.88892 	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
2012-06-12_15:31:20.88901 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
2012-06-12_15:31:20.88910 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then it tries to load CF1 again:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2012-06-12_15:33:52.92593  INFO 15:33:52,925 Opening /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF1/SOMEKSP-CF1-hd-3578 (2528503 bytes)
2012-06-12_15:33:52.92792  INFO 15:33:52,927 Opening /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF1/SOMEKSP-CF1-hd-2613 (3374796 bytes)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Therefore the server fails with the following exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-12_15:33:53.17913 ERROR 15:33:53,178 Exception encountered during startup
2012-06-12_15:33:53.17919 java.lang.RuntimeException: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=ColumnFamilies,keyspace=SOMEKSP,columnfamily=CF1
2012-06-12_15:33:53.17934 	at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:257)
2012-06-12_15:33:53.17940 	at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:331)
2012-06-12_15:33:53.17948 	at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:309)
2012-06-12_15:33:53.17956 	at org.apache.cassandra.db.Table.initCf(Table.java:367)
2012-06-12_15:33:53.17962 	at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:299)
2012-06-12_15:33:53.17967 	at org.apache.cassandra.db.Table.open(Table.java:114)
2012-06-12_15:33:53.17972 	at org.apache.cassandra.db.Table.open(Table.java:97)
2012-06-12_15:33:53.17979 	at org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:204)
2012-06-12_15:33:53.17987 	at org.apache.cassandra.service.AbstractCassandraDaemon.activate(AbstractCassandraDaemon.java:353)
2012-06-12_15:33:53.17996 	at org.apache.cassandra.thrift.CassandraDaemon.main(CassandraDaemon.java:106)
2012-06-12_15:33:53.18002 Caused by: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=ColumnFamilies,keyspace=SOMEKSP,columnfamily=CF1
2012-06-12_15:33:53.18013 	at com.sun.jmx.mbeanserver.Repository.addMBean(Unknown Source)
2012-06-12_15:33:53.18019 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.internal_addObject(Unknown Source)
2012-06-12_15:33:53.18028 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(Unknown Source)
2012-06-12_15:33:53.18038 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(Unknown Source)
2012-06-12_15:33:53.18045 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(Unknown Source)
2012-06-12_15:33:53.18053 	at com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(Unknown Source)
2012-06-12_15:33:53.18060 	at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:253)
2012-06-12_15:33:53.18067 	... 9 more
2012-06-12_15:33:53.18069 java.lang.RuntimeException: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=ColumnFamilies,keyspace=SOMEKSP,columnfamily=CF1
2012-06-12_15:33:53.18083 	at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:257)
2012-06-12_15:33:53.18092 	at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:331)
2012-06-12_15:33:53.18100 	at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:309)
2012-06-12_15:33:53.18109 	at org.apache.cassandra.db.Table.initCf(Table.java:367)
2012-06-12_15:33:53.18114 	at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:299)
2012-06-12_15:33:53.18119 	at org.apache.cassandra.db.Table.open(Table.java:114)
2012-06-12_15:33:53.18124 	at org.apache.cassandra.db.Table.open(Table.java:97)
2012-06-12_15:33:53.18129 	at org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:204)
2012-06-12_15:33:53.18139 	at org.apache.cassandra.service.AbstractCassandraDaemon.activate(AbstractCassandraDaemon.java:353)
2012-06-12_15:33:53.18148 	at org.apache.cassandra.thrift.CassandraDaemon.main(CassandraDaemon.java:106)
2012-06-12_15:33:53.18155 Caused by: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=ColumnFamilies,keyspace=SOMEKSP,columnfamily=CF1
2012-06-12_15:33:53.18167 	at com.sun.jmx.mbeanserver.Repository.addMBean(Unknown Source)
2012-06-12_15:33:53.18173 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.internal_addObject(Unknown Source)
2012-06-12_15:33:53.18181 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(Unknown Source)
2012-06-12_15:33:53.18191 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(Unknown Source)
2012-06-12_15:33:53.18198 	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(Unknown Source)
2012-06-12_15:33:53.18206 	at com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(Unknown Source)
2012-06-12_15:33:53.18212 	at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:253)
2012-06-12_15:33:53.18219 	... 9 more
2012-06-12_15:33:53.18221 Exception encountered during startup: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=ColumnFamilies,keyspace=SOMEKSP,columnfamily=CF1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Enabling assertions though causes the corrupted sstables to be ignored:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-12_16:25:43.32075  INFO 16:25:43,320 Opening /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hc-6965 (2105724 bytes)
2012-06-12_16:25:43.32562 ERROR 16:25:43,325 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SSTableBatchOpen:1,5,main]
2012-06-12_16:25:43.32577 java.lang.AssertionError: SSTable first key DecoratedKey(41255474878128469814942789647212295629, 31303132393937357c3337313730333536) &amp;gt; last key DecoratedKey(41219536226656199861610796307350537953, 31303234323538397c3331383436373338)
2012-06-12_16:25:43.32614   at org.apache.cassandra.io.sstable.SSTableReader.load(SSTableReader.java:412)
2012-06-12_16:25:43.32626   at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:187)
2012-06-12_16:25:43.32638   at org.apache.cassandra.io.sstable.SSTableReader$1.run(SSTableReader.java:225)
2012-06-12_16:25:43.32651   at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)
2012-06-12_16:25:43.32662   at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)
2012-06-12_16:25:43.32672   at java.util.concurrent.FutureTask.run(Unknown Source)
2012-06-12_16:25:43.32681   at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
2012-06-12_16:25:43.32692   at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
2012-06-12_16:25:43.32703   at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which leads to cassandra booting up. I wonder if scrub will pick up the ignored sstables.&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t the assertion above (SSTable first key &amp;gt; last key) turn into an exception and get handled properly?&lt;/p&gt;
</comment>
                            <comment id="13295171" author="omid" created="Thu, 14 Jun 2012 17:14:43 +0000"  >&lt;p&gt;Scrubbed the column family on a node which had booted up with assertions `on` and there were still corrupt sstables.&lt;/p&gt;</comment>
                            <comment id="13295286" author="al@ooyala.com" created="Thu, 14 Jun 2012 20:20:23 +0000"  >&lt;p&gt;I think I just hit the same thing. We&apos;re using reverse comparator with bytescomparator on the CF&apos;s that seem to be having trouble if that&apos;s relevant at all.&lt;/p&gt;

&lt;p&gt;Cluster is 1.1.1 on Ubuntu 12.04 and only has about 7GB per node at the moment.&lt;/p&gt;

&lt;p&gt;Stacktrace attached.&lt;/p&gt;</comment>
                            <comment id="13295290" author="al@ooyala.com" created="Thu, 14 Jun 2012 20:22:59 +0000"  >&lt;p&gt;BTW if somebody points me to a build, tag, or commit ID to test, I&apos;ll push it out right away. It&apos;s only a 3-node cluster and I can easily take a filesystem snapshot before running.&lt;/p&gt;</comment>
                            <comment id="13295704" author="slebresne" created="Fri, 15 Jun 2012 14:49:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Tried the patch but the server still doesn&apos;t start.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right. So the problem is, as you noticed, that there is really no way to start the server and having it load a broken sstable, which means there is no way to run scrub on it. Even without assertions, we rely on interval trees which breaks if the sstable first key is not before the last one.&lt;/p&gt;

&lt;p&gt;After having look a bit more closely on that problem, I think the cleaner way to solve this is to provide a way to run scrub &quot;offline&quot;, which allows to skip the interval trees. So attaching a 3rd patch that provide that. It adds a new binary &apos;sstablescrub&apos; that takes as argument a keyspace name and column family name and scrub the relevant sstables, and does this without breaking if the sstable have some out of order keys. I kind of think that having an offline scrub is not a bad idea anyway.&lt;/p&gt;

&lt;p&gt;With that, you should be able to stop the node, run &apos;sstablescrub ksname cfname&apos; and then restart the node and you should be good to go.&lt;/p&gt;</comment>
                            <comment id="13296040" author="al@ooyala.com" created="Sat, 16 Jun 2012 00:26:13 +0000"  >&lt;p&gt;What SHA / tag should these patches apply against? I&apos;ve tried trunk, 1.1.1 and 1.1.0 and can&apos;t get a clean apply. I&apos;ll try a manual merge tomorrow.&lt;/p&gt;</comment>
                            <comment id="13296042" author="jbellis" created="Sat, 16 Jun 2012 00:31:53 +0000"  >&lt;p&gt;cassandra-1.1 branch&lt;/p&gt;</comment>
                            <comment id="13396246" author="omid" created="Mon, 18 Jun 2012 21:04:18 +0000"  >&lt;p&gt;Thanks for the patch. Offline scrub is indeed very useful.&lt;/p&gt;

&lt;p&gt;Tried the v3 patches and the scrub didn&apos;t complete, possibly because of a different issue, with the following failed assertion:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.AssertionError: Unexpected empty index file: RandomAccessReader(filePath=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-tmp-hd-33827-Index.db&apos;&lt;/span&gt;, skipIOCache=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        at org.apache.cassandra.io.sstable.SSTable.estimateRowsFromIndex(SSTable.java:221)
        at org.apache.cassandra.io.sstable.SSTableReader.load(SSTableReader.java:376)
        at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:203)
        at org.apache.cassandra.io.sstable.SSTableReader.openNoValidation(SSTableReader.java:143)
        at org.apache.cassandra.tools.StandaloneScrubber.main(StandaloneScrubber.java:79)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which consequently, encountered corrupt SSTables during start-up:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-18_20:36:19.89543  INFO 20:36:19,895 Opening /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-24984 (1941993 bytes)
2012-06-18_20:36:19.90217 ERROR 20:36:19,900 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SSTableBatchOpen:9,5,main]
2012-06-18_20:36:19.90222 java.lang.IllegalStateException: SSTable first key DecoratedKey(41255474878128469814942789647212295629, 31303132393937357c3337313730333536) &amp;gt; last key DecoratedKey(41219536226656199861610796307350537953, 31303234323538397c3331383436373338)
2012-06-18_20:36:19.90261 	at org.apache.cassandra.io.sstable.SSTableReader.validate(SSTableReader.java:441)
2012-06-18_20:36:19.90275 	at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:208)
2012-06-18_20:36:19.90291 	at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:153)
2012-06-18_20:36:19.90309 	at org.apache.cassandra.io.sstable.SSTableReader$1.run(SSTableReader.java:245)
2012-06-18_20:36:19.90324 	at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)
2012-06-18_20:36:19.90389 	at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)
2012-06-18_20:36:19.90391 	at java.util.concurrent.FutureTask.run(Unknown Source)
2012-06-18_20:36:19.90391 	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
2012-06-18_20:36:19.90392 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
2012-06-18_20:36:19.90392 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;although didn&apos;t prevent Cassandra from starting up, but compaction failed subsequently:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-18_20:51:41.79122 ERROR 20:51:41,790 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:81,1,main]
2012-06-18_20:51:41.79131 java.lang.RuntimeException: Last written key DecoratedKey(12341204629749023303706929560940823070, 33363037353338) &amp;gt;= current key DecoratedKey(12167298275958419273792070792442127650, 31363431343537) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-tmp-hd-40992-Data.db
2012-06-18_20:51:41.79161 	at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:134)
2012-06-18_20:51:41.79169 	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:153)
2012-06-18_20:51:41.79180 	at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:159)
2012-06-18_20:51:41.79189 	at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)
2012-06-18_20:51:41.79199 	at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)
2012-06-18_20:51:41.79210 	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
2012-06-18_20:51:41.79218 	at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)
2012-06-18_20:51:41.79227 	at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)
2012-06-18_20:51:41.79235 	at java.util.concurrent.FutureTask.run(Unknown Source)
2012-06-18_20:51:41.79242 	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
2012-06-18_20:51:41.79250 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
2012-06-18_20:51:41.79259 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13396319" author="al@ooyala.com" created="Mon, 18 Jun 2012 22:34:31 +0000"  >&lt;p&gt;Offline scrub ran fine for me.  I downgraded to 1.1.0 and ran a compaction and it looks fine.  (edit) finished offline scrub on both affected nodes and they&apos;re back to normal.&lt;/p&gt;</comment>
                            <comment id="13396433" author="awinter" created="Tue, 19 Jun 2012 01:06:06 +0000"  >&lt;p&gt;I can confirm I also experienced the &quot;Unexpected empty index file&quot; errors on some of the nodes that I have run sstablescrub on.&lt;/p&gt;

&lt;p&gt;Other nodes had this error when running sstablescrub:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Scrub of SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/data/cassandra/KS/CF/KS-CF-hd-259648-Data.db&apos;&lt;/span&gt;) complete: 1592 rows in &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; sstable and 0 empty (tombstoned) rows dropped
EOF after 6 bytes out of 8
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Compactions stop with the &quot;java.lang.RuntimeException: Last written key DecoratedKey&quot; error on the nodes affected by either of the above 2 errors .&lt;/p&gt;

&lt;p&gt;Nodes that seem to have been repaired by the sstablescrub still continue to have &quot;java.lang.RuntimeException: Last written key DecoratedKey&quot; errors scattered through the logs but are still compacting.&lt;/p&gt;

&lt;p&gt;Is there any further information we can supply to help debug?&lt;/p&gt;</comment>
                            <comment id="13396551" author="slebresne" created="Tue, 19 Jun 2012 06:37:40 +0000"  >&lt;p&gt;My bad. Forgot to exclude temporary and compacted files from the scrubbed files.&lt;/p&gt;

&lt;p&gt;Attaching a v4 of last patch to fix. Hopefully this should fix the offline scrub.&lt;/p&gt;</comment>
                            <comment id="13396804" author="omid" created="Tue, 19 Jun 2012 14:28:54 +0000"  >&lt;p&gt;Tried v4 patch and offline scrub went through completely. Cassandra started without any error but compaction halted again:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-19_14:01:03.47432  INFO 14:01:03,474 Compacting [SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-67792-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-65607-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-63279-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-65491-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-68332-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-64720-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-65322-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-66557-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-64504-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-68179-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-hd-65005-Data.db&apos;&lt;/span&gt;)]
2012-06-19_14:01:08.73528 ERROR 14:01:08,733 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:11,1,main]
2012-06-19_14:01:08.73538 java.lang.RuntimeException: Last written key DecoratedKey(42351003983459534782466386414991462257, 313632303432347c3130303632313432) &amp;gt;= current key DecoratedKey(38276735926421753773204634663641518108, 31343638373735327c3439343837333932) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/abcd/data/SOMEKSP/CF3/SOMEKSP-CF3-tmp-hd-68399-Data.db
2012-06-19_14:01:08.73572 	at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:134)
2012-06-19_14:01:08.73581 	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:153)
2012-06-19_14:01:08.73590 	at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:159)
2012-06-19_14:01:08.73600 	at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)
2012-06-19_14:01:08.73611 	at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)
2012-06-19_14:01:08.73622 	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
2012-06-19_14:01:08.73633 	at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)
2012-06-19_14:01:08.73642 	at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)
2012-06-19_14:01:08.73650 	at java.util.concurrent.FutureTask.run(Unknown Source)
2012-06-19_14:01:08.73657 	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
2012-06-19_14:01:08.73665 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
2012-06-19_14:01:08.73672 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All SSTables that participated in compaction were new ones written by the offline scrub (according their timestamp and also id range.) although the first one didn&apos;t exist any more (already promoted before the exception?)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This is not really a new bug, but I believe that prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4142&quot; title=&quot;OOM Exception during repair session with LeveledCompactionStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4142&quot;&gt;&lt;del&gt;CASSANDRA-4142&lt;/del&gt;&lt;/a&gt;, &lt;b&gt;this had less consequences&lt;/b&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sylvain, could you please elaborate on this? I&apos;d like to know how pre-1.1.1 data is affected by the Range-vs-Bounds bug. Only overlapping/duplicate sstables on the same level leading to slower reads caused by unneeded sstable lookups?&lt;/p&gt;</comment>
                            <comment id="13396862" author="slebresne" created="Tue, 19 Jun 2012 15:40:30 +0000"  >&lt;p&gt;Just to make sure: you did apply 0001-Change-Range-Bounds-in-LeveledManifest.overlapping-v3.txt before restarting the server after having run the offline scrub, right?&lt;/p&gt;

&lt;p&gt;If so, that would mean we have yet another bug that generates out of order keys during compaction.&lt;/p&gt;</comment>
                            <comment id="13396895" author="omid" created="Tue, 19 Jun 2012 16:15:31 +0000"  >&lt;p&gt;Exactly.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Applied v3&lt;/li&gt;
	&lt;li&gt;Ran offline scrub and it failed because of tmp files.&lt;/li&gt;
	&lt;li&gt;Started Cassandra and saw failures.&lt;/li&gt;
	&lt;li&gt;Applied v4 to cassandra-1.1 branch.&lt;/li&gt;
	&lt;li&gt;Ran offline scrub successfully.&lt;/li&gt;
	&lt;li&gt;Started Cassandra successfully.&lt;/li&gt;
	&lt;li&gt;Compaction failed because of above error.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All done on the same instance.&lt;/p&gt;</comment>
                            <comment id="13396903" author="omid" created="Tue, 19 Jun 2012 16:25:37 +0000"  >&lt;p&gt;Let me know if I can provide more data.&lt;/p&gt;</comment>
                            <comment id="13396906" author="slebresne" created="Tue, 19 Jun 2012 16:33:05 +0000"  >&lt;p&gt;Did the new exception happened quickly after having started the node with the scrubbed files? Are you able to reproduce easily (i.e. if you restart the node and compact, do you still get the same error). If you are able to reproduce, would you be at liberty to provide a set of sstables that produce the error during compaction (in private for instance). It would be much more easy to tack that down with an easy way to reproduce.&lt;/p&gt;</comment>
                            <comment id="13397437" author="omid" created="Wed, 20 Jun 2012 11:44:46 +0000"  >&lt;p&gt;The exceptions happens not quickly afterwards but after some rounds of compaction on the CF. I had re-bootstrapped so there are tons of ~(1500) pending compaction tasks. If I restart the node and compact the problem happens again and I can reproduce it. I&apos;ll send you an email about the data.&lt;/p&gt;</comment>
                            <comment id="13397587" author="slebresne" created="Wed, 20 Jun 2012 15:40:32 +0000"  >&lt;p&gt;Alright, I think the problem may just be that my offline scrub was kind of broken in that it wasn&apos;t dealing with the leveled manifest correctly. Attaching a v5 that update the manifest correctly but also check that there is no overlapping sstables in the manifest (and send back sstables to L0 if that happens).&lt;/p&gt;

&lt;p&gt;So hopefully running this new version of the offline scrub should fix it (the 2 first patch are untouched, I only rebased them).&lt;/p&gt;</comment>
                            <comment id="13397632" author="omid" created="Wed, 20 Jun 2012 17:05:08 +0000"  >&lt;p&gt;Will try it again. LeveledCompactionStrategyTest:testValidationMultipleSSTablePerLevel fails because of junit timeout when I run it together with all other suits, but passes when I only run LeveledCompactionStrategyTest suit. Is it related?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    [junit] Testsuite: org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest
    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 0 sec
    [junit] 
    [junit] Testcase: org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest:testValidationMultipleSSTablePerLevel:	Caused an ERROR
    [junit] Timeout occurred. Please note the time in the report does not reflect the time until the timeout.
    [junit] junit.framework.AssertionFailedError: Timeout occurred. Please note the time in the report does not reflect the time until the timeout.
    [junit] 
    [junit] 
    [junit] Test org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest FAILED (timeout)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13397805" author="omid" created="Wed, 20 Jun 2012 19:37:54 +0000"  >&lt;p&gt;Got &quot;java.lang.OutOfMemoryError: Java heap space&quot; with -Xmx256M.&lt;/p&gt;

&lt;p&gt;Tried with -Xmx512M and the scrub failed with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Checking leveled manifest
d != org.apache.cassandra.io.sstable.SSTableReader
java.util.IllegalFormatConversionException: d != org.apache.cassandra.io.sstable.SSTableReader
        at java.util.Formatter$FormatSpecifier.failConversion(Formatter.java:3999)
        at java.util.Formatter$FormatSpecifier.printInteger(Formatter.java:2709)
        at java.util.Formatter$FormatSpecifier.print(Formatter.java:2661)
        at java.util.Formatter.format(Formatter.java:2433)
        at java.util.Formatter.format(Formatter.java:2367)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.java:2769)
        at org.apache.cassandra.tools.StandaloneScrubber.checkManifest(StandaloneScrubber.java:179)
        at org.apache.cassandra.tools.StandaloneScrubber.main(StandaloneScrubber.java:148)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13397808" author="jbellis" created="Wed, 20 Jun 2012 19:43:20 +0000"  >&lt;p&gt;Are you using Java6 or Java7?&lt;/p&gt;</comment>
                            <comment id="13397814" author="omid" created="Wed, 20 Jun 2012 19:51:13 +0000"  >&lt;p&gt;The above error is due to the %d in StandaloneScrubber.java:179&apos;s interpolation. Will fix and try again.&lt;/p&gt;

&lt;p&gt;Jonathan: Sun Java 6, 1.6.0_26&lt;/p&gt;</comment>
                            <comment id="13398206" author="awinter" created="Thu, 21 Jun 2012 05:34:39 +0000"  >&lt;p&gt;After working around the issue with the 0003 v5 patch that Omid refers I&apos;ve had an sstablescrub complete on one of my servers.  sstablescrub did detected several overlapping sstables, resetting them to L0, but no out of order keys.&lt;/p&gt;

&lt;p&gt;The Last written key DecoratedKey &amp;gt;= current key exception however resurfaces again after the first set of compactions, 5 minutes after startup, in the exact same manner as before.  The same exception occurs for various CF&apos;s until compactions stop completely.  compactionstats still shows a large number of pending compaction tasks after this event.&lt;/p&gt;</comment>
                            <comment id="13398326" author="slebresne" created="Thu, 21 Jun 2012 10:19:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;The above error is due to the %d in StandaloneScrubber.java:179&apos;s interpolation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, sorry for that typo. I&apos;ve updated the v5 patch to fix it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Got &quot;java.lang.OutOfMemoryError: Java heap space&quot; with -Xmx256M&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The last version of the offline scrub &quot;loads&quot; all sstable readers, which means in particular that it loads the summary of the key index and the sstable bloom filter. In other words, it does use a bit more memory, so it&apos;s not necessarily surprising that -Xmx256M is not enough.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;LeveledCompactionStrategyTest:testValidationMultipleSSTablePerLevel fails because of junit timeout when I run it together with all other suits, but passes when I only run LeveledCompactionStrategyTest suit. Is it related?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I doubt it. I&apos;ve already seen test timeout when run with the full suit but not alone. I wouldn&apos;t worry too much about that. At least that test is working fine on my machine.&lt;/p&gt;</comment>
                            <comment id="13398563" author="omid" created="Thu, 21 Jun 2012 16:40:15 +0000"  >&lt;p&gt;I experienced the same as Anton&apos;s. One observation is that the out-of-order key being wrongly iterated by CompactionIterable&apos;s MergeIterator which causes the exception, happen to be the start of an interval:&lt;/p&gt;

&lt;p&gt;DEBUG 18:10:41,693 Creating IntervalNode from [... Interval(DecoratedKey(33736808147257072541807562080745136438, ... ), &lt;/p&gt;

&lt;p&gt;which leads me to suspect if it&apos;s due to the &quot;Range&quot; (vs. Bounds) used in LeveledCompactionStrategy::getScanners. Any ideas?&lt;/p&gt;</comment>
                            <comment id="13399268" author="slebresne" created="Fri, 22 Jun 2012 11:38:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;which leads me to suspect if it&apos;s due to the &quot;Range&quot; (vs. Bounds) used in LeveledCompactionStrategy::getScanners. Any ideas?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, that Range is correct because this correspond to repair ranges and is correctly interpreted. And in fact, when doing compaction that range is actually null so that cannot be the problem.&lt;/p&gt;


&lt;p&gt;So Anton sent me some sstables that triggered an out-of-order exception when compacting them. What I did with that is:&lt;br/&gt;
1) apply the last version of the v5 patch on this issue on top of the current git cassandra-1.1 branch (using the release of CASSANDRA 1.1.1 would probably work too because I don&apos;t think there is any other related fix since 1.1.1 that went into the git branch but anyway, that&apos;s what I used).&lt;br/&gt;
2) I ran the offline scrub &lt;b&gt;while the node was stopped&lt;/b&gt;. I insist on that last part because that having the node run during the offline scrub would mess things up. I&apos;d actually like to make the offline scrub check if the node is running and refuse to work in that case but I&apos;m not sure of what is the best way to do that.&lt;br/&gt;
3) I restarted the node once the scrub was done&lt;/p&gt;

&lt;p&gt;I was then able to compact the node fully (i.e, I ran compaction until there was nothing more to compact) and this without hitting any more error.&lt;/p&gt;

&lt;p&gt;Was I lucky? Are you guys able to reproduce those steps and still get more errors?&lt;/p&gt;</comment>
                            <comment id="13399299" author="omid" created="Fri, 22 Jun 2012 13:03:21 +0000"  >&lt;p&gt;So I had offline-scrubbed the live Cassandra node and I had copied the sstables that participated in one of the failed compaction. Assuming the sstables had been offline-scrubbed, I had skipped step 2 above locally, so unfortunately I can&apos;t yet reproduce it locally with a limited set of data.&lt;/p&gt;</comment>
                            <comment id="13399760" author="awinter" created="Sat, 23 Jun 2012 00:44:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Was I lucky? Are you guys able to reproduce those steps and still get more errors?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As discussed, but repeated here just for the ticket&apos;s reference; I was patching and scrubbing in the same way as described above.  Once the scrubbed nodes were restarted in the cluster they were then under normal read/write load and experienced the exceptions again.  Given that the sstablescrub and subsequent compactions run fine in Sylvain&apos;s test, using my out of order sstables, means that the sstablescrub command appears to do its job fine.  The root cause, originally expected to be resolved with the 0001 patch, still appears to be occurring so Sylvain was going to investigate the code further.&lt;/p&gt;</comment>
                            <comment id="13401477" author="slebresne" created="Tue, 26 Jun 2012 16:09:06 +0000"  >&lt;p&gt;So, still not sure what would cause out of order keys outside of the bug fixed by the first patch on this issue. But I&apos;ve rebased the patch as v6 and added a small last patch to check for overlapping sstables in levels each time we modify the manifest.&lt;/p&gt;

&lt;p&gt;Could you try doing an offline scrub (while the node is shutdown) and then restart the node with all those patches. If the problem comes back, hopefully the last patch should give us a bit more info. So if the error reproduce and as soon as it does, it would be useful to get the error log as well as the manifest files (the 2 json files along the sstables).&lt;/p&gt;</comment>
                            <comment id="13401494" author="jbellis" created="Tue, 26 Jun 2012 16:28:20 +0000"  >&lt;p&gt;Could the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4341&quot; title=&quot;Small SSTable Segments Can Hurt Leveling Process&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4341&quot;&gt;&lt;del&gt;CASSANDRA-4341&lt;/del&gt;&lt;/a&gt; regression have caused what Anton saw, if he was running from the 1.1 branch?&lt;/p&gt;</comment>
                            <comment id="13401496" author="slebresne" created="Tue, 26 Jun 2012 16:31:28 +0000"  >&lt;p&gt;Hum, yes that&apos;s possible. I figured this wouldn&apos;t be the problem since they were using 1.1.1 but you are right that if they tried against the 1.1 branch that could have been it. Worth checking on current 1.1 branch I guess.&lt;/p&gt;</comment>
                            <comment id="13402518" author="jbellis" created="Wed, 27 Jun 2012 20:02:54 +0000"  >&lt;p&gt;CompactionsTest.testBlacklistingWithLeveledCompactionStrategy is currently failing in trunk because of a similar integrity check that I added to promote() for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1991&quot; title=&quot;CFS.maybeSwitchMemtable() calls CommitLog.instance.getContext(), which may block, under flusher lock write lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1991&quot;&gt;&lt;del&gt;CASSANDRA-1991&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.       DecoratedKey last = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        Collections.sort(generations[newLevel], SSTable.sstableComparator);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SSTableReader sstable : generations[newLevel])
        {
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; last == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || sstable.first.compareTo(last) &amp;gt; 0;
            last = sstable.last;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Patch 0001 does not fix that test failure.&lt;/p&gt;</comment>
                            <comment id="13402995" author="slebresne" created="Thu, 28 Jun 2012 10:39:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;CompactionsTest.testBlacklistingWithLeveledCompactionStrategy is currently failing in trunk because of a similar integrity check that I added to promote()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a bug in the integrity check in fact, that should skip the check if newLevel=0 (since we can have newLevel=0 following &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4341&quot; title=&quot;Small SSTable Segments Can Hurt Leveling Process&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4341&quot;&gt;&lt;del&gt;CASSANDRA-4341&lt;/del&gt;&lt;/a&gt;). With that fixed there is no more failure of that unit test (I&apos;ve committed the fix as 4725bf71e18550ac60f9).&lt;/p&gt;</comment>
                            <comment id="13403301" author="slebresne" created="Thu, 28 Jun 2012 17:54:20 +0000"  >&lt;p&gt;Alright, so I&apos;m pretty sure I&apos;ve found the root cause of all this. On top of the Range-&amp;gt;Bound problem we were not correctly computing the set of overlapping sstable in L1 when compacting multiple L0 files. Citing the comment of the attached fix (where sstables = &apos;sstables in L0 to compact&apos; and candidates = &apos;sstable in L1&apos;):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/*
 * Note that picking each sstable from candidates that overlap one of the sstable of sstables is not enough
 * because you could have the following situation:
 *   sstables = [ s1(a, c), s2(m, z) ]
 *   candidates = [ s3(e, g) ]
 * In that case, s2 overlaps none of s1 or s2, but if we compact s1 with s2, the resulting sstable will be
 * overlapping s3, so we must return s3.
 */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I&apos;m attaching a v7 of the patches with the fix for that in the first patch. The last patch (the integrity tests) was also breaking the offline scrub so that&apos;s fix in v7 too. Though I note that the integrity tests of the last patch is probably overkill and I didn&apos;t really intended to commit it (i.e. the integrity check that is in trunk is probably enough).&lt;/p&gt;</comment>
                            <comment id="13403349" author="jbellis" created="Thu, 28 Jun 2012 18:44:40 +0000"  >&lt;p&gt;Nice work, I think you nailed it!&lt;/p&gt;

&lt;p&gt;+1 from me, and agreed that I&apos;d rather backport the limited sanity check from trunk than use 0004 here.&lt;/p&gt;

&lt;p&gt;Also attached a cleanup patch (applies after 0001) to add javadoc, improve parameter names, and simplify &quot;overlapping&quot; by making union explicit when desired.&lt;/p&gt;</comment>
                            <comment id="13403764" author="awinter" created="Fri, 29 Jun 2012 07:59:59 +0000"  >&lt;p&gt;I&apos;ve applied the v7 patches and have successfully offline scrubbed &amp;amp; reinserted a number of nodes in my ring without further occurrence of the previous issues.  Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13403794" author="slebresne" created="Fri, 29 Jun 2012 09:20:16 +0000"  >&lt;p&gt;Great. So I committed the first 3 patches along with the cleanup patch and I backported the simpler integrity check from trunk.&lt;/p&gt;</comment>
                            <comment id="13404333" author="awinter" created="Sat, 30 Jun 2012 00:09:19 +0000"  >&lt;p&gt;Maybe I spoke too soon.  Overnight I&apos;ve seen the exceptions happen again on nodes that were v7 patched &amp;amp; scrubbed.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:1301] 2012-06-29 21:54:12,078 AbstractCassandraDaemon.java (line 134) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:1301,1,main]
java.lang.RuntimeException: Last written key DecoratedKey(116816802911061669023614481109871014436, 4faa631ca88ef85b8e26ddeb) &amp;gt;= current key DecoratedKey(115179899219377463875853982254751557438, 4fa892bf42d3f24479f627b6) writing into /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/XXXX/data/cassandra/KS/CF/KS-CF-tmp-hd-837655-Data.db
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:134)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:153)
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:159)
        at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)
        at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
        at java.util.concurrent.FutureTask.run(FutureTask.java:166)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:636)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13404336" author="jbellis" created="Sat, 30 Jun 2012 00:19:10 +0000"  >&lt;p&gt;To clarify, is this 1.1.1 release + patches, or 1.1 dev branch + patches?&lt;/p&gt;</comment>
                            <comment id="13404338" author="awinter" created="Sat, 30 Jun 2012 00:20:57 +0000"  >&lt;p&gt;1.1 dev branch + patches&lt;/p&gt;</comment>
                            <comment id="13406254" author="awinter" created="Wed, 4 Jul 2012 03:28:01 +0000"  >&lt;p&gt;I have repeatedly run sstablescrub across all my nodes and the exceptions do not occur as frequently now, however, the integrity check still throws exceptions and compactionstats shows a large number of pending tasks but no progression afterwards.&lt;/p&gt;

&lt;p&gt;Should this ticket be reopened or a new one raised?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:912] 2012-07-04 01:07:16,470 AbstractCassandraDaemon.java (line 134) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:912,1,main]
java.lang.AssertionError
        at org.apache.cassandra.db.compaction.LeveledManifest.promote(LeveledManifest.java:214)
        at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:158)
        at org.apache.cassandra.db.DataTracker.notifySSTablesChanged(DataTracker.java:531)
        at org.apache.cassandra.db.DataTracker.replaceCompactedSSTables(DataTracker.java:254)
        at org.apache.cassandra.db.ColumnFamilyStore.replaceCompactedSSTables(ColumnFamilyStore.java:978)
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:200)
        at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)
        at org.apache.cassandra.db.compaction.CompactionManager$1.runMayThrow(CompactionManager.java:150)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
        at java.util.concurrent.FutureTask.run(FutureTask.java:166)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:636)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13406395" author="slebresne" created="Wed, 4 Jul 2012 09:37:37 +0000"  >&lt;p&gt;Damn. Ok, since this has been released with 1.1.2 already, would you mind opening a new one?&lt;/p&gt;</comment>
                            <comment id="13406844" author="awinter" created="Thu, 5 Jul 2012 04:53:11 +0000"  >&lt;p&gt;New issue raised as requested: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4411&quot; title=&quot;Assertion with LCS compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4411&quot;&gt;&lt;del&gt;CASSANDRA-4411&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12533857" name="0001-Fix-overlapping-computation-v7.txt" size="6653" author="slebresne" created="Thu, 28 Jun 2012 17:54:20 +0000"/>
                            <attachment id="12533858" name="0002-Scrub-detects-and-repair-outOfOrder-rows-v7.txt" size="13524" author="slebresne" created="Thu, 28 Jun 2012 17:54:20 +0000"/>
                            <attachment id="12533859" name="0003-Create-standalone-scrub-v7.txt" size="71157" author="slebresne" created="Thu, 28 Jun 2012 17:54:20 +0000"/>
                            <attachment id="12533860" name="0004-Add-manifest-integrity-check-v7.txt" size="6463" author="slebresne" created="Thu, 28 Jun 2012 17:54:20 +0000"/>
                            <attachment id="12533865" name="cleanup.txt" size="5726" author="jbellis" created="Thu, 28 Jun 2012 18:44:40 +0000"/>
                            <attachment id="12532132" name="ooyala-hastur-stacktrace.txt" size="4796" author="al@ooyala.com" created="Thu, 14 Jun 2012 20:18:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249133</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0a4zr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57082</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>