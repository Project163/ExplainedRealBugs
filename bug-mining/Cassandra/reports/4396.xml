<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12228] Write performance regression in 3.x vs 3.0</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12228</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;ve been tracking down a performance issue in trunk vs cassandra-3.0 branch.&lt;/p&gt;

&lt;p&gt;I think I&apos;ve found it.  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt; changed the default memtable flush default to 1 vs the min of 2 in cassandra-3.0.&lt;/p&gt;

&lt;p&gt;I don&apos;t see any technical reason for this and we should add back the min of 2 sstable flushers per disk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12990544">CASSANDRA-12228</key>
            <summary>Write performance regression in 3.x vs 3.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="tjake">T Jake Luciani</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jul 2016 20:32:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:26 +0000</updated>
                            <resolved>Thu, 4 Aug 2016 12:33:40 +0000</resolved>
                                        <fixVersion>3.10</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15400133" author="aweisberg" created="Fri, 29 Jul 2016 22:28:06 +0000"  >&lt;p&gt;There are some remaining issues with thread pool sizes. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12071?focusedCommentId=15400086&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15400086&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-12071&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You still can&apos;t get multiple threads if you have a single disk due to TPE not spinning up additional threads if you are using an unbounded queue.  Seems like this would be a good place to address the related issue. I also don&apos;t think this is minor it&apos;s pretty crippling for performance and you can&apos;t work around it by changing configuration values.&lt;/p&gt;</comment>
                            <comment id="15400361" author="aweisberg" created="Sat, 30 Jul 2016 01:48:43 +0000"  >&lt;p&gt;I think there is also an issue I am stilling working on nailing down where memory accounting releases memory pinned by memtables too early or is just off by too much causing the heap to fill up with memtables that are waiting for the post flush executor. I can see the heap going to double the limit in a heap dump and things are falling apart server side.&lt;/p&gt;</comment>
                            <comment id="15402770" author="aweisberg" created="Mon, 1 Aug 2016 20:34:57 +0000"  >&lt;p&gt;I was incorrect. JMXEnabledThreadPoolExecutor automatically sets core pool threads to max if you only specify core pool threads. So I am running into some other pain point around memory accounting unrelated to flushing performance.&lt;/p&gt;</comment>
                            <comment id="15403197" author="aweisberg" created="Tue, 2 Aug 2016 01:41:46 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...aweisberg:CASSANDRA-12228-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-12228-trunk-testall/3/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-12228-trunk-dtest/3/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I set the default back to the calculation that existed before and updated the documentation. I would like to remove memtable_cleanup_threshold scoped as part of this ticket. I can&apos;t see why you would set that to anything other than the default calculation and removing it would help offset the additional lines of doc for memtable_flush_writers.&lt;/p&gt;

&lt;p&gt;Somewhat orthogonal regarding my earlier comments about too much memory utilization. I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12358&quot; title=&quot;Slow PostFlush execution due to 2i flushing can cause near OOM to OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12358&quot;&gt;&lt;del&gt;CASSANDRA-12358&lt;/del&gt;&lt;/a&gt; for that.&lt;/p&gt;</comment>
                            <comment id="15404054" author="tjake" created="Tue, 2 Aug 2016 14:15:28 +0000"  >&lt;p&gt;I&apos;m good with that, I&apos;ll wait to see what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; thinks&lt;/p&gt;</comment>
                            <comment id="15404078" author="krummas" created="Tue, 2 Aug 2016 14:27:55 +0000"  >&lt;p&gt;Since 6696 the configuration sets how many flush writers there should be &lt;b&gt;per data directory&lt;/b&gt; - so factoring in the number of data directories in the calculation is probably wrong (ie, with 10 data directories and 2 memtable flush writers you would get 20 threads actually doing writing to disk and 2 threads waiting on the writing, meaning we can flush 2 memtables concurrently)&lt;/p&gt;

&lt;p&gt;edit: re-read your yaml comment where you explain exactly what I wrote above &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - but why would we want more threads per data directory if we have more data directories?&lt;/p&gt;</comment>
                            <comment id="15404434" author="aweisberg" created="Tue, 2 Aug 2016 17:27:37 +0000"  >&lt;p&gt;I think the default can be really simple. If there are multiple data directories use a value of 1 so concurrency will be # of data directories and there will be a single memtable flush. If there is a single directory set it to 2 so there can be two concurrent memtable flushes to the single data directory.&lt;/p&gt;

&lt;p&gt;If the user specifies a # of concurrent memtable flushes we honor that by providing enough threads to wait on the flushes as well as enough threads per disk that each memtable can flush concurrently.&lt;/p&gt;

&lt;p&gt;I pushed an updated version reflecting this change. There is also a commit that removes memtable_cleanup_threshold.&lt;/p&gt;
</comment>
                            <comment id="15405797" author="krummas" created="Wed, 3 Aug 2016 12:01:06 +0000"  >&lt;p&gt;New default looks good, and it makes sense to remove memtable_cleanup_threshold - but I&apos;m not entirely sure we can/should do that in 3.x (def not in 3.9, maybe 3.10), should we make it deprecated it and remove in 4.0 instead?&lt;/p&gt;</comment>
                            <comment id="15405922" author="aweisberg" created="Wed, 3 Aug 2016 13:35:42 +0000"  >&lt;p&gt;I know we have a compatibility policy for things like data artifacts and communication between nodes, but does that apply to configuration artifacts as well?&lt;/p&gt;</comment>
                            <comment id="15405953" author="slebresne" created="Wed, 3 Aug 2016 14:01:40 +0000"  >&lt;p&gt;We even wrote stuff up: &lt;a href=&quot;http://wiki.apache.org/cassandra/CompatibilityGuarantees&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/cassandra/CompatibilityGuarantees&lt;/a&gt;, which while absolutely imperfect is better than nothing. In particular:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;No removal/modifications of any configuration option, startup option, exposed metrics or general behavior of the Cassandra process&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15405969" author="aweisberg" created="Wed, 3 Aug 2016 14:15:19 +0000"  >&lt;p&gt;OK, I will update the comment for MCT to say that it is deprecated with an explanation. I also updated the fix version to 3.10. I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12372&quot; title=&quot;Remove deprecated memtable_cleanup_threshold for 4.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12372&quot;&gt;CASSANDRA-12372&lt;/a&gt; for removing it from 4.0 when trunk is available for 4.0 commits.&lt;/p&gt;
</comment>
                            <comment id="15407663" author="krummas" created="Thu, 4 Aug 2016 12:33:40 +0000"  >&lt;p&gt;+1, committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12994597">CASSANDRA-12372</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i315uv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>