<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5665] Gossiper.handleMajorStateChange can lose existing node ApplicationState</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5665</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Dovetailing on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5660&quot; title=&quot;Gossiper incorrectly drops AppState for an upgrading node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5660&quot;&gt;&lt;del&gt;CASSANDRA-5660&lt;/del&gt;&lt;/a&gt;, I discovered that further along during an upgrade, when more nodes are on the new major version, a node the previous version can get passed some incomplete Gossip info about another, already upgraded node, and the older node drops AppStat info about that node.&lt;/p&gt;

&lt;p&gt;I think what happens is that a 1.1 node (older rev) gets gossip info from a 1.2 node (A), which includes incomplete (lacking some AppState data) gossip info about another 1.2 node (B). The 1.1 node, which has marked incorrectly kicked node B out of gossip due to the bug described in #5660, then takes that incomplete node B info and wholesale replaces any previous known state about node B in Gossiper.handleMajorStateChanged. Thus, if we previously had DC/RACK info, it&apos;ll get dropped as part of the endpointStateMap.put(endpointstate). When the data being pased is incomplete, 1.1 will start referencing node B and gets into the NPE situation in #5498.&lt;/p&gt;

&lt;p&gt;Anecdotally, this bad state is short-lived, less than a few minutes, even as short as ten seconds, until gossip catches up and properly propagates the AppState data. Furthermore, when upgrading a two datacenter, 48 node cluster, it only occurred on two nodes for less than a minute each. Thus, the scope seems limited but can occur.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12653763">CASSANDRA-5665</key>
            <summary>Gossiper.handleMajorStateChange can lose existing node ApplicationState</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="jasobrown">Jason Brown</reporter>
                        <labels>
                            <label>gossip</label>
                            <label>upgrade</label>
                    </labels>
                <created>Wed, 19 Jun 2013 17:56:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:11 +0000</updated>
                            <resolved>Mon, 22 Jun 2015 12:19:47 +0000</resolved>
                                                            <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13688223" author="jasobrown" created="Wed, 19 Jun 2013 17:58:34 +0000"  >&lt;p&gt;The attached patch modifies Gossiper.handleMajorStateChanged by checking if the the endpoint already exists in the endpointStateMap, and adds any previous ApplicationState fields to the new epState &lt;br/&gt;
if a) the AppState does not exist in the new epState struct or b) has AppState whose version is greater than that in the epState.&lt;/p&gt;

&lt;p&gt;One the surface the patch is straight forward, but I&apos;m not sure if there&apos;s some subtle bugs that might creep in with retaining previous state (although that state might get replaced anyways in a very short time). Thus, while the patch fixes &apos;my problem&apos;, I&apos;m not sure if this is the safest way to resolve.&lt;/p&gt;</comment>
                            <comment id="13688329" author="jbellis" created="Wed, 19 Jun 2013 19:07:18 +0000"  >&lt;p&gt;Is this a regression or just something we haven&apos;t noticed before?&lt;/p&gt;</comment>
                            <comment id="13688331" author="jasobrown" created="Wed, 19 Jun 2013 19:11:19 +0000"  >&lt;p&gt;I suspect it&apos;s just something we haven&apos;t noticed before. I found it when upgrading from 1.0 to 1.1, largely via the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5660&quot; title=&quot;Gossiper incorrectly drops AppState for an upgrading node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5660&quot;&gt;&lt;del&gt;CASSANDRA-5660&lt;/del&gt;&lt;/a&gt; debugging. It was exposed as an edge case of an edge case (using each_qourum, in ec2, during a major rev upgrade), however it probably applies to many upgrade scenarios.&lt;/p&gt;</comment>
                            <comment id="13689395" author="jbellis" created="Thu, 20 Jun 2013 16:40:40 +0000"  >&lt;p&gt;Currently the logic in applyStateLocally is (essentially)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (remoteGeneration &amp;gt; localGeneration)
                    handleMajorStateChange(ep, remoteState);
                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( remoteGeneration == localGeneration ) &lt;span class=&quot;code-comment&quot;&gt;// generation has not changed, apply &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; states
&lt;/span&gt;                    applyNewStates(ep, localEpStatePtr, remoteState);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You&apos;re changing hMSTC to be more like applyNewStates, can we combine the two instead?&lt;/p&gt;</comment>
                            <comment id="13690444" author="jasobrown" created="Fri, 21 Jun 2013 16:25:14 +0000"  >&lt;p&gt;v2 follows advice from ~jbellis about combining the proposed handleMajorStateChange and existing applyNewStates.&lt;/p&gt;</comment>
                            <comment id="13690451" author="jbellis" created="Fri, 21 Jun 2013 16:32:31 +0000"  >&lt;p&gt;LGTM.&lt;/p&gt;

&lt;p&gt;Note: is it a &lt;span class=&quot;error&quot;&gt;&amp;#91;pre-existing&amp;#93;&lt;/span&gt; bug that we don&apos;t call doNotifications on major state change? &lt;/p&gt;</comment>
                            <comment id="13690462" author="jasobrown" created="Fri, 21 Jun 2013 16:43:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; Yeah, i saw that we don&apos;t call doNotifications for major state change. However, we do call (in order): onRestart, onAlive, and onJoin. I suspect that probably will cover most of the same funcationality that onChange does. I can dig a little deeper, and if I suspect there might be something there, I&apos;ll create a followup ticket to fix.&lt;/p&gt;

&lt;p&gt;Immediately, though, I know we&apos;ll end up thrashing more connections in the &apos;reconnectable snitches&apos; as we&apos;ll call OTCP.reset more than once. However, that might already be happening with the current scheme (at least, up until a few days ago, when we started working on all the gossiper/connection/upgrade tickets like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5660&quot; title=&quot;Gossiper incorrectly drops AppState for an upgrading node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5660&quot;&gt;&lt;del&gt;CASSANDRA-5660&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13690465" author="jasobrown" created="Fri, 21 Jun 2013 16:46:44 +0000"  >&lt;p&gt;committed to 1.2 - trunk coming in a few minutes&lt;/p&gt;</comment>
                            <comment id="13690607" author="jasobrown" created="Fri, 21 Jun 2013 19:05:56 +0000"  >&lt;p&gt;committed to trunk.&lt;/p&gt;</comment>
                            <comment id="13691224" author="dbrosius" created="Sat, 22 Jun 2013 19:16:17 +0000"  >&lt;p&gt;Map&amp;lt;ApplicationState, VersionedValue&amp;gt; merged = new HashMap&amp;lt;ApplicationState, VersionedValue&amp;gt;();  in Gossiper.copyNewerApplicationStates could be an EnumMap&lt;/p&gt;</comment>
                            <comment id="13692832" author="slebresne" created="Tue, 25 Jun 2013 08:20:20 +0000"  >&lt;p&gt;I&apos;ve reverted this since this is causing test issues.&lt;/p&gt;</comment>
                            <comment id="13693284" author="jasobrown" created="Tue, 25 Jun 2013 19:10:06 +0000"  >&lt;p&gt;After discussion on IRC, decided to the brakes on this one as it seems like we&apos;re getting into dangerous territory mucking with Endpoint&apos;s AppState like that. I&apos;ll revisit this ticket again in the future to see if it&apos;s still a problem.&lt;/p&gt;</comment>
                            <comment id="14334119" author="jbellis" created="Tue, 24 Feb 2015 00:01:04 +0000"  >&lt;p&gt;(1.5 yr later) Should we close this?&lt;/p&gt;</comment>
                            <comment id="14595840" author="jasobrown" created="Mon, 22 Jun 2015 12:19:47 +0000"  >&lt;p&gt;(2.0 years later) Yes, we should close this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12588652" name="5665-v1.diff" size="1959" author="jasobrown" created="Wed, 19 Jun 2013 17:58:34 +0000"/>
                            <attachment id="12589103" name="5665-v2.diff" size="5773" author="jasobrown" created="Fri, 21 Jun 2013 16:25:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334040</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lmfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334366</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>