<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:18:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1895] Loadbalance during gossip issues leaves cluster in bad state</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1895</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Running loadbalance against a node in a 4 node cluster leaves gossip in a wonky state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12493949">CASSANDRA-1895</key>
            <summary>Loadbalance during gossip issues leaves cluster in bad state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="stuhood">Stu Hood</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Dec 2010 07:31:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:10 +0000</updated>
                            <resolved>Sun, 16 Jan 2011 23:54:20 +0000</resolved>
                                        <fixVersion>0.7.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="28800">8h</timeoriginalestimate>
                            <timeestimate seconds="28800">8h</timeestimate>
                                        <comments>
                            <comment id="12974554" author="stuhood" created="Thu, 23 Dec 2010 07:33:01 +0000"  >&lt;p&gt;Attaching logs and &lt;tt&gt;nodetool ring&lt;/tt&gt; output from after running loadbalance against 10.97.29.122.&lt;/p&gt;</comment>
                            <comment id="12974640" author="jbellis" created="Thu, 23 Dec 2010 15:31:16 +0000"  >&lt;p&gt;trunk, or 0.7 branch?&lt;/p&gt;</comment>
                            <comment id="12974678" author="nickmbailey" created="Thu, 23 Dec 2010 17:56:49 +0000"  >&lt;p&gt;this looks very similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1895&quot; title=&quot;Loadbalance during gossip issues leaves cluster in bad state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1895&quot;&gt;&lt;del&gt;CASSANDRA-1895&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12974680" author="nickmbailey" created="Thu, 23 Dec 2010 18:04:55 +0000"  >&lt;p&gt;It also looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1829&quot; title=&quot;Nodetool move is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1829&quot;&gt;&lt;del&gt;CASSANDRA-1829&lt;/del&gt;&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12974684" author="stuhood" created="Thu, 23 Dec 2010 18:24:50 +0000"  >&lt;p&gt;This run is from trunk. I&apos;m traveling today, but I should be able to try it against 0.7 when I get settled this evening.&lt;/p&gt;</comment>
                            <comment id="12974714" author="brandon.williams" created="Thu, 23 Dec 2010 19:59:54 +0000"  >&lt;p&gt;I&apos;m unable to repro against 0.7.&lt;/p&gt;</comment>
                            <comment id="12974716" author="tjake" created="Thu, 23 Dec 2010 20:00:08 +0000"  >&lt;p&gt;Based on the ring and .122 log it looks like you were missing fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1829&quot; title=&quot;Nodetool move is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1829&quot;&gt;&lt;del&gt;CASSANDRA-1829&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If see this in the log: &quot; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(2)-10.97.29.122&amp;#93;&lt;/span&gt; 2010-12-22 01:33:47,328 StorageService.java (line 249) Bootstrap/move completed! Now serving reads.&quot;&lt;/p&gt;

&lt;p&gt;Then the local ring state would say Normal since finishBootstrap() calls setToken() which sets the ring state to normal. hmm.&lt;/p&gt;</comment>
                            <comment id="12974717" author="tjake" created="Thu, 23 Dec 2010 20:03:58 +0000"  >&lt;p&gt;In fact, based on the log message above I can see you didn&apos;t have the fix in palace since the line is now 250 after the fix for the above message:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/cassandra/trunk/src/java/org/apache/cassandra/service/StorageService.java?r1=1043262&amp;amp;r2=1044034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/cassandra/trunk/src/java/org/apache/cassandra/service/StorageService.java?r1=1043262&amp;amp;r2=1044034&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12975011" author="stuhood" created="Sat, 25 Dec 2010 06:34:34 +0000"  >&lt;p&gt;It looks like the patch you mentioned was only partially applied to trunk. The last chunk in the patch should have added &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!bootstrapped)
+            setToken(token);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...but didn&apos;t.&lt;/p&gt;</comment>
                            <comment id="12975012" author="nickmbailey" created="Sat, 25 Dec 2010 06:39:56 +0000"  >&lt;p&gt;Stu,&lt;/p&gt;

&lt;p&gt;That  if check was removed in a later commit. The current code will call setToken() no matter what. The only difference is if the node bootstrapped, setToken will be called twice but that shouldn&apos;t be a problem and I don&apos;t think that is causing the bug here.&lt;/p&gt;</comment>
                            <comment id="12975445" author="stuhood" created="Tue, 28 Dec 2010 07:58:04 +0000"  >&lt;p&gt;I think the burden of proof is back on me now, so I&apos;ll try and reproduce this once I&apos;m back in the office tomorrow.&lt;/p&gt;</comment>
                            <comment id="12975700" author="stuhood" created="Wed, 29 Dec 2010 02:24:29 +0000"  >&lt;p&gt;After a rebase and changes to the EC2 images I was using, I&apos;m no longer able to reproduce this against either 0.7 or trunk.&lt;/p&gt;

&lt;p&gt;Nick noticed some gossip related problems in the attached logs, so I&apos;m going to chalk this up to &lt;em&gt;either&lt;/em&gt; a bad rebase, or problems related to bootstrapping during gossip problems. Nick: could you chime in with details, and whether you think those gossip issues might be worth pursuing?&lt;/p&gt;</comment>
                            <comment id="12975881" author="nickmbailey" created="Wed, 29 Dec 2010 19:34:13 +0000"  >&lt;p&gt;I just noticed that the logs on one of the machines contains a &quot;Removing token&quot; line followed by a new node line 3 times. Since Stu only called loadbalance once, I believe this is likely due to gossip issues, where a node completes the decom then gets gossip about the same node leaving and readds it.&lt;/p&gt;

&lt;p&gt;I&apos;ve also talked to one other person in irc who had a similar problem.  Every time a decommission happened, the node would get removed but added 30 seconds later (gossip timeout after removal) due to some other node in the cluster.  &lt;/p&gt;</comment>
                            <comment id="12975919" author="gdusbabek" created="Wed, 29 Dec 2010 21:33:23 +0000"  >&lt;p&gt;We&apos;ve had this problem before.  I think it was &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1467&quot; title=&quot;replication factor exceeds number of endpoints, when attempting to join a new node (but cluster has enough running nodes to fulfill RF)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1467&quot;&gt;&lt;del&gt;CASSANDRA-1467&lt;/del&gt;&lt;/a&gt;, but not sure.&lt;/p&gt;</comment>
                            <comment id="12976106" author="stuhood" created="Thu, 30 Dec 2010 20:40:53 +0000"  >&lt;p&gt;Is this the sort of problem where having a gossip generation might help? The node that readded an older node should have ignored the outdated gossip.&lt;/p&gt;</comment>
                            <comment id="12976119" author="nickmbailey" created="Thu, 30 Dec 2010 21:55:56 +0000"  >&lt;p&gt;We have generations for node states. The problem is after 30 seconds we assume gossip has propagated and forget about nodes that have been removed.  Then when we see the gossip again it looks like a brand new node.&lt;/p&gt;</comment>
                            <comment id="12976122" author="jbellis" created="Thu, 30 Dec 2010 22:10:08 +0000"  >&lt;p&gt;sounds like the inverse of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1730&quot; title=&quot;Fat clients are never removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1730&quot;&gt;&lt;del&gt;CASSANDRA-1730&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12976992" author="brandon.williams" created="Mon, 3 Jan 2011 22:39:44 +0000"  >&lt;p&gt;Revival of my first try at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1730&quot; title=&quot;Fat clients are never removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1730&quot;&gt;&lt;del&gt;CASSANDRA-1730&lt;/del&gt;&lt;/a&gt;: change the quarantine interval for justRemovedEndpoints to RING_DELAY * 2.&lt;/p&gt;</comment>
                            <comment id="12977002" author="nickmbailey" created="Mon, 3 Jan 2011 23:03:14 +0000"  >&lt;p&gt;Would it be a good idea to make this configurable? I&apos;ve seen nodes that have failed to process a REMOVED state for up to 45 minutes, although that was one extreme case. It might be useful in a case like that to temporarily configure this very high in order to process ring operations when the cluster is having issues otherwise.&lt;/p&gt;</comment>
                            <comment id="12977005" author="brandon.williams" created="Mon, 3 Jan 2011 23:08:44 +0000"  >&lt;p&gt;I&apos;m guessing in the 45 minute case, what was happening was the state was being re-gossiped just outside of RING_DELAY many times, but finally it propagated fast enough.  I think the next step, if this isn&apos;t sufficient, is to expose RING_DELAY as a tunable.&lt;/p&gt;</comment>
                            <comment id="12982026" author="jbellis" created="Sat, 15 Jan 2011 05:11:37 +0000"  >&lt;p&gt;would it make more sense to change FatClientTimeout to QUARANTINE_DELAY / 2?&lt;/p&gt;</comment>
                            <comment id="12982358" author="brandon.williams" created="Sun, 16 Jan 2011 18:47:26 +0000"  >&lt;p&gt;It wouldn&apos;t hurt, though we established in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1730&quot; title=&quot;Fat clients are never removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1730&quot;&gt;&lt;del&gt;CASSANDRA-1730&lt;/del&gt;&lt;/a&gt; the timeout was rather arbitrary.  It could help in the case of a &apos;flapping&apos; bootstrap, though I tend to think there will be problems there in any case.&lt;/p&gt;</comment>
                            <comment id="12982414" author="jbellis" created="Sun, 16 Jan 2011 23:10:33 +0000"  >&lt;p&gt;let&apos;s commit w/ that change then&lt;/p&gt;</comment>
                            <comment id="12982433" author="brandon.williams" created="Sun, 16 Jan 2011 23:54:20 +0000"  >&lt;p&gt;Committed w/fatclient timeout change.&lt;/p&gt;</comment>
                            <comment id="12982442" author="hudson" created="Mon, 17 Jan 2011 00:37:15 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #165 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/165/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/165/&lt;/a&gt;)&lt;br/&gt;
    Set quarantine delay to RING_DELAY * 2&lt;br/&gt;
Patch by brandonwilliams, reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1895&quot; title=&quot;Loadbalance during gossip issues leaves cluster in bad state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1895&quot;&gt;&lt;del&gt;CASSANDRA-1895&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12467374" name="1895.txt" size="2346" author="brandon.williams" created="Mon, 3 Jan 2011 22:39:44 +0000"/>
                            <attachment id="12466861" name="logs.tgz" size="12971" author="stuhood" created="Thu, 23 Dec 2010 07:33:01 +0000"/>
                            <attachment id="12466862" name="ring-views.txt" size="1127" author="stuhood" created="Thu, 23 Dec 2010 07:33:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20360</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g82n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92738</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>