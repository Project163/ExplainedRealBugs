<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10001] Bug in merging of collections</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10001</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Fixing the compaction dtest I noticed we aren&apos;t encoding map data correctly in sstables.&lt;/p&gt;

&lt;p&gt;The following code fails from newly committed {{ compaction_test.py:TestCompaction_with_SizeTieredCompactionStrategy.large_compaction_warning_test}}&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE large(userid text PRIMARY KEY, properties map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, text&amp;gt;) with compression = {}&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in range(200):  # ensures partition size larger than compaction_large_partition_warning_threshold_mb                                                                                                               
            session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE ks.large SET properties[%i] = &lt;span class=&quot;code-quote&quot;&gt;&apos;%s&apos;&lt;/span&gt; WHERE userid = &lt;span class=&quot;code-quote&quot;&gt;&apos;user&apos;&lt;/span&gt;&quot;&lt;/span&gt; % (i, get_random_word(strlen)))

        ret = session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT properties from ks.large where userid = &lt;span class=&quot;code-quote&quot;&gt;&apos;user&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; len(ret) == 1
	self.assertEqual(200, len(ret[0][0].keys()))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The last assert is failing with only 91 keys.  The large values are causing flushes vs staying in the memtable so the issue is somewhere in the serialization of collections in sstables.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12852585">CASSANDRA-10001</key>
            <summary>Bug in merging of collections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="tjake">T Jake Luciani</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Aug 2015 14:24:41 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:01 +0000</updated>
                            <resolved>Fri, 7 Aug 2015 14:26:26 +0000</resolved>
                                        <fixVersion>3.0 beta 1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14660693" author="jkni" created="Thu, 6 Aug 2015 19:52:42 +0000"  >&lt;p&gt;I reproduced this with Jepsen tests (now pushed up to the repo), and the same issue appears to affect CQL sets as well.&lt;/p&gt;</comment>
                            <comment id="14661162" author="stefania" created="Fri, 7 Aug 2015 01:25:58 +0000"  >&lt;p&gt;Reproduced with equivalent unit test which can be added to o.a.c.cql3.validation.entities.CollectionsTest:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMapWithLargePartition() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        Random r = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; seed = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Seed &quot;&lt;/span&gt; + seed);
        r.setSeed(seed);

        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; len = (1024 * 1024)/100;
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (userid text PRIMARY KEY, properties map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, text&amp;gt;) with compression = {}&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numKeys = 200;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; numKeys; i++)
        {
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] b = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[len];
            r.nextBytes(b);
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE %s SET properties[?] = ? WHERE userid = &lt;span class=&quot;code-quote&quot;&gt;&apos;user&apos;&lt;/span&gt;&quot;&lt;/span&gt;, i, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(b));
        }

        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[][] rows = getRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT properties from %s where userid = &lt;span class=&quot;code-quote&quot;&gt;&apos;user&apos;&lt;/span&gt;&quot;&lt;/span&gt;));
        assertEquals(1, rows.length);
        assertEquals(numKeys, ((Map)rows[0][0]).size());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError: 
Expected :200
Actual   :126
 &amp;lt;Click to see difference&amp;gt;
	at org.junit.Assert.failNotEquals(Assert.java:689)
	at org.apache.cassandra.cql3.validation.entities.CollectionsTest.testMapWithLargePartition(CollectionsTest.java:56)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14661292" author="stefania" created="Fri, 7 Aug 2015 04:33:38 +0000"  >&lt;p&gt;The encoding or decoding is fine. The problem is that we are using the &lt;tt&gt;ColumnData&lt;/tt&gt; comparator rather than the &lt;tt&gt;Cell&lt;/tt&gt; comparator for reducing cells. So spreading the map (or set) over more than one sstable (or memtable) would result in the latest cells winning and the older being lost when merging cells.&lt;/p&gt;

&lt;p&gt;I also noticed &lt;tt&gt;CQLTester.flush()&lt;/tt&gt; is not blocking and so I changed it to blocking.&lt;/p&gt;

&lt;p&gt;Patch &lt;a href=&quot;https://github.com/stef1927/cassandra/commits/10001-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll post the CI links as soon as they are available.&lt;/p&gt;</comment>
                            <comment id="14661367" author="stefania" created="Fri, 7 Aug 2015 05:38:23 +0000"  >&lt;p&gt;CI links:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10001-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10001-3.0-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10001-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10001-3.0-dtest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14661900" author="tjake" created="Fri, 7 Aug 2015 14:26:26 +0000"  >&lt;p&gt;+1 and committed. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2if6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>