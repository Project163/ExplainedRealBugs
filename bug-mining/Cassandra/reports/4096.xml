<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11030] utf-8 characters incorrectly displayed/inserted on cqlsh on Windows</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11030</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;C:\Users\Paulo\Repositories\cassandra [2.2-10948 +6 ~1 -0 !]&amp;gt; .\bin\cqlsh.bat --encoding utf-8
Connected to test at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP for help.
cqlsh&amp;gt; INSERT INTO bla.test (bla ) VALUES  (&apos;n&#227;o&apos;) ;
cqlsh&amp;gt; select * from bla.test;

 bla
-----
 n?o

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12932270">CASSANDRA-11030</key>
            <summary>utf-8 characters incorrectly displayed/inserted on cqlsh on Windows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                            <label>cqlsh</label>
                            <label>windows</label>
                    </labels>
                <created>Tue, 19 Jan 2016 01:01:24 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:58 +0000</updated>
                            <resolved>Mon, 8 Feb 2016 12:30:01 +0000</resolved>
                                        <fixVersion>2.2.6</fixVersion>
                    <fixVersion>3.0.4</fixVersion>
                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15107129" author="pauloricardomg" created="Tue, 19 Jan 2016 18:23:42 +0000"  >&lt;p&gt;There are two issues at play here. The first is that the default Windows terminal encoding is not &lt;tt&gt;utf-8&lt;/tt&gt;, so in order to display/input &lt;tt&gt;utf-8&lt;/tt&gt; characters you must set the terminal encoding (code page in Windows nomenclature) to &lt;tt&gt;cp65001&lt;/tt&gt;, by issuing the command &lt;tt&gt;chcp 65001&lt;/tt&gt; before starting cqlsh. The second issue is that there is no codec for &lt;tt&gt;cp65001&lt;/tt&gt; in python &amp;lt; 3.3 (this was fixed in issue &lt;a href=&quot;https://bugs.python.org/issue13216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13216&lt;/a&gt; in Python &lt;a href=&quot;https://docs.python.org/dev/whatsnew/3.3.html#codecs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.3+&lt;/a&gt;). A known workaround is to register a copy of the &lt;tt&gt;utf-8&lt;/tt&gt; codec to encode/decode &lt;tt&gt;cp65001&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So, if the platform is native windows (the issue doesn&apos;t happen on cygwin), and the encoding is set to &lt;tt&gt;utf-8&lt;/tt&gt; but the terminal encoding is not &lt;tt&gt;cp65001&lt;/tt&gt;, a warning is print for the user to change its codepoint to &lt;tt&gt;cp65001&lt;/tt&gt; to support &lt;tt&gt;utf-8&lt;/tt&gt; encoding. Furthermore, if the &lt;tt&gt;cp650001&lt;/tt&gt; is the default encoding and the python version is less than 3.3, the &lt;tt&gt;utf-8&lt;/tt&gt; codec is registered as &lt;tt&gt;cp65001&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.3&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-11030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.3...pauloricardomg:3.3-11030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-11030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11030-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11030-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.3-11030-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11030-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11030-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11030-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.3-11030-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11030-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Below is a sample execution with different encoding variations (default vs utf-8/cp65001):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;C:\Users\Paulo\Repositories\cassandra [cassandra-2.2 +8 ~1 -0 !]&amp;gt; bin\cqlsh.bat
Connected to test at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP for help.
cqlsh&amp;gt; select * from bla.test;

 bla
--------------
 jo&#960;o &#223;lcides
          bla
         n&#960;o&#964;

(3 rows)
cqlsh&amp;gt; select * from bla.test where bla = &apos;n&#227;o&#231;&apos;;

 bla
-----

(0 rows)
cqlsh&amp;gt; exit;
C:\Users\Paulo\Repositories\cassandra [cassandra-2.2 +8 ~1 -0 !]&amp;gt; bin\cqlsh.bat --encoding utf-8

WARNING: console codepage must be set to cp65001 to support utf-8 encoding on Windows platforms.
If you experience encoding problems, change your console codepage with &apos;chcp 65001&apos; before starting cqlsh.

Connected to test at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP for help.
cqlsh&amp;gt; select * from bla.test;

 bla
--------------
 jo&#9500;&#250;o &#9500;&#237;lcides
          bla
         n&#9500;&#250;o&#9500;&#186;

(3 rows)
cqlsh&amp;gt; select * from bla.test where bla = &apos;n&#227;o&#231;&apos;;
Traceback (most recent call last):
  File &quot;C:\Users\Paulo\Repositories\cassandra\bin\\cqlsh.py&quot;, line 1044, in get_input_line
    self.lastcmd = raw_input(prompt).decode(self.encoding)
  File &quot;C:\tools\python2\lib\encodings\utf_8.py&quot;, line 16, in decode
    return codecs.utf_8_decode(input, errors, True)
UnicodeDecodeError: &apos;utf8&apos; codec can&apos;t decode byte 0x87 in position 39: invalid start byte

WARNING: console codepage must be set to cp65001 to support utf-8 encoding on Windows platforms.
If you experience encoding problems, change your console codepage with &apos;chcp 65001&apos; before starting cqlsh.

cqlsh&amp;gt; exit;
C:\Users\Paulo\Repositories\cassandra [cassandra-2.2 +8 ~1 -0 !]&amp;gt; chcp 65001
Active code page: 65001
C:\Users\Paulo\Repositories\cassandra [cassandra-2.2 +8 ~1 -0 !]&amp;gt; bin\cqlsh.bat --encoding utf-8
Connected to test at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP for help.
cqlsh&amp;gt; select * from bla.test;

 bla
--------------
 jo&#227;o &#225;lcides
          bla
         n&#227;o&#231;

(3 rows)
cqlsh&amp;gt; select * from bla.test where bla = &apos;n&#227;o&#231;&apos;;

 bla
------
 n&#227;o&#231;

(1 rows)
cqlsh&amp;gt; insert into bla.test (bla ) VALUES ( &apos;&#227;noth&#233;r&apos; );
cqlsh&amp;gt; select * from bla.test where bla = &apos;&#227;noth&#233;r&apos;;

 bla
---------
 &#227;noth&#233;r

(1 rows)
cqlsh&amp;gt; exit;    
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; would you mind reviewing? Would you have a Windows10 box to test it? I tested only on win7 and it works correctly.&lt;/p&gt;</comment>
                            <comment id="15107797" author="stefania" created="Wed, 20 Jan 2016 01:33:59 +0000"  >&lt;p&gt;Looking at the 2.2. patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;At &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11030#diff-1cce67f7d76864f07aaf4d986d6fc051R737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 737&lt;/a&gt; why use &lt;tt&gt;sys.stdout.encoding&lt;/tt&gt; rather than &lt;tt&gt;self.encoding&lt;/tt&gt; or &lt;tt&gt;encoding&lt;/tt&gt;?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;At &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11030#diff-1cce67f7d76864f07aaf4d986d6fc051R767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 767&lt;/a&gt; is the list of encodings complete, can they ever be specified as upper case?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Can you rebase on trunk to make sure the &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11030-dtest/lastCompletedBuild/testReport/cqlsh_tests.cqlsh_tests/TestCqlsh/test_pep8_compliance/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pep8 compliance failure&lt;/a&gt; is not related?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Else it LGTM. &lt;/p&gt;

&lt;p&gt;I also only have Windows 7; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; are you running on Windows 10 by any chance?&lt;/p&gt;</comment>
                            <comment id="15108798" author="jmckenzie" created="Wed, 20 Jan 2016 16:07:45 +0000"  >&lt;p&gt;Works on Win10.&lt;/p&gt;</comment>
                            <comment id="15109933" author="stefania" created="Thu, 21 Jan 2016 02:33:04 +0000"  >&lt;p&gt;Thank you so much for checking!&lt;/p&gt;</comment>
                            <comment id="15120419" author="pauloricardomg" created="Wed, 27 Jan 2016 23:38:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt;!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At line 737 why use sys.stdout.encoding rather than self.encoding or encoding?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually self.encoding and sys.stdout.encoding are needed, because both cqlsh and other libs may use &lt;tt&gt;codecs.lookup(encoding)&lt;/tt&gt;, so codec not found will be thrown if the cp65001 is not registered. Thanks for that!&lt;/p&gt;

&lt;p&gt;This is necessary because independent of &lt;tt&gt;self.encoding&lt;/tt&gt; value, if &lt;tt&gt;sys.stdout.encoding&lt;/tt&gt; is &lt;tt&gt;cp65001&lt;/tt&gt;, the python process will fail with &lt;tt&gt;No such codec: cp65001&lt;/tt&gt; or similar.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At line 767 is the list of encodings complete, can they ever be specified as upper case?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I added the list of utf8 variations from &lt;a href=&quot;https://docs.python.org/2/library/codecs.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;py2&lt;/a&gt; and &lt;a href=&quot;https://docs.python.org/3/library/codecs.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;py3&lt;/a&gt; (since there is no direct api for that).&lt;/p&gt;

&lt;p&gt;Updated above branches with dtests.&lt;/p&gt;</comment>
                            <comment id="15120872" author="stefania" created="Thu, 28 Jan 2016 06:27:24 +0000"  >&lt;p&gt;A couple more comments but otherwise it&apos;s looking good:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Did you mean to print the encodings at this line &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11030#diff-1cce67f7d76864f07aaf4d986d6fc051R738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; or did you forget to remove the print statements?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;At this line &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11030#diff-1cce67f7d76864f07aaf4d986d6fc051R740&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, now that we are using the extended &lt;tt&gt;self.is_using_utf8&lt;/tt&gt;, which includes cp65001 but also utf-8, it means the lambda would be registered on all platforms. It&apos;s harmless but perhaps it should be limited to native Windows platforms only?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;blockquote&gt;&lt;p&gt;I added the list of utf8 variations from py2 and py3 (since there is no direct api for that).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If I understood correctly &quot;UTF&quot; is also a possible alias?&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15121466" author="pauloricardomg" created="Thu, 28 Jan 2016 13:41:32 +0000"  >&lt;p&gt;Oops, thanks for spotting those. Fixed!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At this line here, now that we are using the extended self.is_using_utf8, which includes cp65001 but also utf-8, it means the lambda would be registered on all platforms. It&apos;s harmless but perhaps it should be limited to native Windows platforms only?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;actually no need to check all utf-8 encodings, only cp65001, and also added check for windows-only&lt;/p&gt;

&lt;p&gt;Resubmitted dtests.&lt;/p&gt;</comment>
                            <comment id="15122654" author="stefania" created="Fri, 29 Jan 2016 00:53:43 +0000"  >&lt;p&gt;+1, thanks! &lt;/p&gt;

&lt;p&gt;Just one note: &lt;tt&gt;patch by pauloricardomg; reviewed by stef1927 for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11030&quot; title=&quot;utf-8 characters incorrectly displayed/inserted on cqlsh on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11030&quot;&gt;&lt;del&gt;CASSANDRA-11030&lt;/del&gt;&lt;/a&gt;&lt;/tt&gt;, I think we normally use the git users rather than the GH handles, so it should be &lt;tt&gt;patch by Paulo Motta; reviewed by Stefania Alborghetti for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11030&quot; title=&quot;utf-8 characters incorrectly displayed/inserted on cqlsh on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11030&quot;&gt;&lt;del&gt;CASSANDRA-11030&lt;/del&gt;&lt;/a&gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;I leave it to you to move the ticket to ready for commit once you have indicated which patches automatically merge up.&lt;/del&gt; Please see comment below.&lt;/p&gt;</comment>
                            <comment id="15122942" author="stefania" created="Fri, 29 Jan 2016 04:42:43 +0000"  >&lt;p&gt;I think we need to move the codec registration further up, I just stumbled into this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;C:\Users\stefania\git\cstar\cassandra&amp;gt;.\bin\cqlsh.bat --help
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Users\stefania\git\cstar\cassandra\bin\\cqlsh.py&quot;&lt;/span&gt;, line 220, in &amp;lt;module&amp;gt;
    (options, arguments) = parser.parse_args(sys.argv[1:], values=optvalues)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1400, in parse_args
    stop = self._process_args(largs, rargs, values)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1440, in _process_args
    self._process_long_opt(rargs, values)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1515, in _process_long_opt
    option.process(opt, value, values, self)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 789, in process
    self.action, self.dest, opt, value, values, parser)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 811, in take_action
    parser.print_help()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1670, in print_help
    file.write(self.format_help().encode(encoding, &lt;span class=&quot;code-quote&quot;&gt;&quot;replace&quot;&lt;/span&gt;))
LookupError: unknown encoding: cp65001
C:\Users\stefania\git\cstar\cassandra&amp;gt;.\bin\cqlsh.bat --encoding utf-8 --help
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Users\stefania\git\cstar\cassandra\bin\\cqlsh.py&quot;&lt;/span&gt;, line 220, in &amp;lt;module&amp;gt;
    (options, arguments) = parser.parse_args(sys.argv[1:], values=optvalues)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1400, in parse_args
    stop = self._process_args(largs, rargs, values)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1440, in _process_args
    self._process_long_opt(rargs, values)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1515, in _process_long_opt
    option.process(opt, value, values, self)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 789, in process
    self.action, self.dest, opt, value, values, parser)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 811, in take_action
    parser.print_help()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;C:\Program Files\Python\2.7.11\lib\optparse.py&quot;&lt;/span&gt;, line 1670, in print_help
    file.write(self.format_help().encode(encoding, &lt;span class=&quot;code-quote&quot;&gt;&quot;replace&quot;&lt;/span&gt;))
LookupError: unknown encoding: cp65001
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;del&gt;Also, on Windows 7 I still get the &quot;?&quot; even with cp650001&lt;/del&gt; It works on one Windows 7 laptop running python 2.7.10 but it fails on my newer laptop running 2.7.11. Which version are you running? I tried downgrading to 2.7.10 but to no avail, even if I get the older installers it still says version 2.7.11.&lt;/p&gt;</comment>
                            <comment id="15124576" author="pauloricardomg" created="Sat, 30 Jan 2016 01:22:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we need to move the codec registration further up, I just stumbled into this:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done, also fixed commit message and some other minor style nits, thanks!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but it fails on my newer laptop running 2.7.11&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Tested new version on 2.7.10 as well as 2.7.11, and it works. Could you try this new version with &lt;tt&gt;chcp 65001&lt;/tt&gt; before launching cqlsh and &lt;tt&gt;-&lt;del&gt;encoding utf8&lt;/tt&gt; ? If it works like this but doesn&apos;t work without &lt;tt&gt;&lt;/del&gt;-encoding utf8&lt;/tt&gt;, I think it will be dependent if the system default encoding supports or not utf-8 characters, so I think we can leave it like this as there is a simple workaround.&lt;/p&gt;

&lt;p&gt;Resubmitted tests, please mark as ready to commit if you&apos;re satisfied.&lt;/p&gt;</comment>
                            <comment id="15124620" author="pauloricardomg" created="Sat, 30 Jan 2016 02:02:00 +0000"  >&lt;p&gt;ps: always registering cp65001 as utf-8 alias on py&amp;lt;3.3 on windows for simplicity.&lt;/p&gt;

&lt;p&gt;committer: 2.2 patch merges cleanly upwards.&lt;/p&gt;
</comment>
                            <comment id="15125765" author="stefania" created="Mon, 1 Feb 2016 05:12:28 +0000"  >&lt;p&gt;The latest changes are +1.&lt;/p&gt;

&lt;p&gt;Unfortunately it still doesn&apos;t work on one of the win7 machines. On the other one it works perfectly though. I think there is something wrong with  the python installation since I cannot even get it to print Unicode characters in the python shell either even though the terminal font supports it. &lt;/p&gt;

&lt;p&gt;Here are the exact commands from a command prompt but similar results happen with a power shell prompt. Running the command prompt as an elevated user did no help either.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\stefania&amp;gt;cd git\cstar\cassandra

C:\Users\stefania\git\cstar\cassandra&amp;gt;cd bin

C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;chcp
Active code page: 437

C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;chcp 65001
Active code page: 65001

C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;type ..\unicode.cql
&#65279;INSERT INTO test.test (bla ) VALUES  (&lt;span class=&quot;code-quote&quot;&gt;&apos;n&#227;o&apos;&lt;/span&gt;) ;
C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;cqlsh.bat --help
Usage: cqlsh.py [options] [host [port]]

CQL Shell &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Apache Cassandra

Options:
  --version             show program&apos;s version number and exit
  -h, --help            show &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; help message and exit
  -C, --color           Always use color output
  --no-color            Never use color output
  --browser=BROWSER     The browser to use to display CQL help, where BROWSER
                        can be:
                        - one of the supported browsers in
                        https:&lt;span class=&quot;code-comment&quot;&gt;//docs.python.org/2/library/webbrowser.html.
&lt;/span&gt;                        - browser path followed by %s, example: /usr/bin
                        /google-chrome-stable %s
  --ssl                 Use SSL
  -u USERNAME, --username=USERNAME
                        Authenticate as user.
  -p PASSWORD, --password=PASSWORD
                        Authenticate using password.
  -k KEYSPACE, --keyspace=KEYSPACE
                        Authenticate to the given keyspace.
  -f FILE, --file=FILE  Execute commands from FILE, then exit
  --debug               Show additional debugging information
  --encoding=ENCODING   Specify a non-&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; encoding &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; output.  If you are
                        experiencing problems with unicode characters, using
                        utf8 may fix the problem. (Default from system
                        preferences: cp1252)
  --cqlshrc=CQLSHRC     Specify an alternative cqlshrc file location.
  --cqlversion=CQLVERSION
                        Specify a particular CQL version (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: 3.3.1).
                        Examples: &lt;span class=&quot;code-quote&quot;&gt;&quot;3.0.3&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;3.1.0&quot;&lt;/span&gt;
  -e EXECUTE, --execute=EXECUTE
                        Execute the statement and quit.
  --connect-timeout=CONNECT_TIMEOUT
                        Specify the connection timeout in seconds (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: 5
                        seconds).
  --request-timeout=REQUEST_TIMEOUT
                        Specify the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; request timeout in seconds
                        (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: 10 seconds).
  -t, --tty             Force tty mode (command prompt).

Connects to 127.0.0.1:9042 by &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;. These defaults can be changed by
setting $CQLSH_HOST and/or $CQLSH_PORT. When a host (and optional port number)
are given on the command line, they take precedence over any defaults.
C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;cqlsh.bat
Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select * from test.test ;

 val
-----
  no
 n?o

(2 rows)
cqlsh&amp;gt; quit
C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;cqlsh.bat  --encoding=utf-8
Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select * from test.test ;

 val
-----
  no
 n?o

(2 rows)
cqlsh&amp;gt; quit
C:\Users\stefania\git\cstar\cassandra\bin&amp;gt;cqlsh.bat  --encoding=cp65001
Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.4-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select * from test.test ;

 val
-----
  no
 n?o

(2 rows)
cqlsh&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think we should commit this as it works on the majority of machines and it looks like a Python problem only one one machine. A repair reinstall of Python did not help. I did not do a clean reinstall because I need to run more tests today and I don&apos;t want to loose all the ccm dependencies but I can try again to reinstall python completely later.&lt;/p&gt;</comment>
                            <comment id="15125880" author="stefania" created="Mon, 1 Feb 2016 07:29:42 +0000"  >&lt;p&gt;A clean re-installation of python did no help either.&lt;/p&gt;</comment>
                            <comment id="15126326" author="pauloricardomg" created="Mon, 1 Feb 2016 14:53:38 +0000"  >&lt;p&gt;how was the data inserted (this is not shown in the excerpt you posted)? because if data was inserted with the wrong encoding, it may not be read with the correct encoding. &lt;/p&gt;

&lt;p&gt;I have a feeling the system preferred encoding (in your case cp1252) might be the culprit here, since its different from the terminal encoding 437 and also from cp65001. I wonder if we should use utf-8 as default encoding if one is not specified. Can you try replacing:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        if encoding is None:
            encoding = locale.getpreferredencoding()
            if encoding is None:
                encoding = &apos;utf-8&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        if encoding is None:
             encoding = &apos;utf-8&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and check if that changes anything?&lt;/p&gt;</comment>
                            <comment id="15127558" author="stefania" created="Tue, 2 Feb 2016 03:06:52 +0000"  >&lt;p&gt;You are correct, it finally works. I think I inserted the data initially by copy and paste in a git bash terminal (launched via ConEmu), the only one where I could paste a unicode character, but for this terminal the default encoding was cp1252 since I only worked out today how to change it to cp65001. So even if I inserted the data with --encoding=UTF-8 it would have probably caused problems. From other terminals (command prompt, power shell) I could not paste the character into cqlsh and trying to insert something like u&apos;\uXXXX&apos; would give a syntax error. &lt;/p&gt;

&lt;p&gt;The following works however (unicode.cql is encoded with utf-8):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;chcp 65001
C:\Users\stefania\git\cstar\cassandra&amp;gt;type unicode.cql
INSERT INTO test.test (val) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;n&#227;o&apos;&lt;/span&gt;);
C:\Users\stefania\git\cstar\cassandra&amp;gt;bin\cqlsh.bat --encoding=UTF-8 --file=unicode.cql
C:\Users\stefania\git\cstar\cassandra&amp;gt;bin\cqlsh.bat --encoding=UTF-8
Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.2.5-SNAPSHOT | CQL spec 3.3.1 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select * from test.test;

 val
-----
 n&#227;o
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The source command also works &lt;b&gt;provided the encoding specified via the command line is the same as the file encoding&lt;/b&gt;, otherwise we get a missing character glyph (a square). &lt;/p&gt;

&lt;p&gt;Inserting the character directly from git bash also works now, but because I changed the code page to 65001 for it, otherwise it causes the original problem.&lt;/p&gt;

&lt;p&gt;You are probably right regarding changing default encoding, I&apos;m + 1 to change it to &apos;utf-8&apos; if you want. Also, shouldn&apos;t &lt;tt&gt;do_source&lt;/tt&gt; use the same encoding as the file encoding? I think we should also stress that whichever terminal people are using on Windows, it should have the same encoding as the one used by cqlsh.&lt;/p&gt;

&lt;p&gt;We can commit this ticket as is and open a new ticket re. default encoding or change it here, up to you.&lt;/p&gt;</comment>
                            <comment id="15134456" author="slebresne" created="Fri, 5 Feb 2016 16:55:14 +0000"  >&lt;p&gt;So is that patch available (or even ready to commit)?&lt;/p&gt;</comment>
                            <comment id="15134569" author="pauloricardomg" created="Fri, 5 Feb 2016 17:53:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;We can commit this ticket as is and open a new ticket re. default encoding.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good. Will mark this as ready to commit and opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11124&quot; title=&quot;Change default cqlsh encoding to utf-8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11124&quot;&gt;&lt;del&gt;CASSANDRA-11124&lt;/del&gt;&lt;/a&gt; to discuss changing default encoding to utf-8. Thanks!&lt;/p&gt;

&lt;p&gt;2.2 merges cleanly upwards.&lt;/p&gt;</comment>
                            <comment id="15136884" author="iamaleksey" created="Mon, 8 Feb 2016 12:29:40 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/d295c7c69886f63739792d60d876b012a408cc07&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d295c7c69886f63739792d60d876b012a408cc07&lt;/a&gt; to 2.2, merged with 3.0 and trunk. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rntb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333871">2.2.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>