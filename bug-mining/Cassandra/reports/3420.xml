<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8418] Queries that require allow filtering are working without it</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8418</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The trunk dtest &lt;tt&gt;cql_tests.py:TestCQL.composite_index_with_pk_test&lt;/tt&gt; has begun failing after the changes to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7981&quot; title=&quot;Refactor SelectStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7981&quot;&gt;&lt;del&gt;CASSANDRA-7981&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;With the schema &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE blogs (
                blog_id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
                time1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
                time2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
                author text,
                content text,
                PRIMARY KEY (blog_id, time1, time2)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE INDEX ON blogs(author)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;, then the query&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT blog_id, content FROM blogs WHERE time1 &amp;gt; 0 AND author=&lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; now requires ALLOW FILTERING, but did not before the refactor.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12759282">CASSANDRA-8418</key>
            <summary>Queries that require allow filtering are working without it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="philipthompson">Philip Thompson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Dec 2014 21:12:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:26 +0000</updated>
                            <resolved>Wed, 11 Mar 2015 20:13:36 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14234224" author="blerer" created="Thu, 4 Dec 2014 14:17:06 +0000"  >&lt;p&gt;The test was in fact wrong. The query required ALLOW FILTERING that was I changed the behavior during the refactoring.&lt;br/&gt;
I have changed the DTest.&lt;/p&gt;</comment>
                            <comment id="14234230" author="philipthompson" created="Thu, 4 Dec 2014 14:27:44 +0000"  >&lt;p&gt;Did all of those queries need ALLOW FILTERING? I see you added it to ~5.&lt;/p&gt;</comment>
                            <comment id="14234325" author="blerer" created="Thu, 4 Dec 2014 16:25:39 +0000"  >&lt;p&gt;Yes. Allow filtering is required if your query will perform filtering. If you have 2 relations or more like in those queries and a secondary index is use, one relation will be used to query the index and the results returned will then be filtered using the remaining relations.&lt;/p&gt;</comment>
                            <comment id="14234329" author="blerer" created="Thu, 4 Dec 2014 16:28:55 +0000"  >&lt;p&gt;Now, I realizes than my change will probably break 2.1 or 2.0. I need to check why allow filtering is not required for those versions.&lt;/p&gt;</comment>
                            <comment id="14234753" author="slebresne" created="Thu, 4 Dec 2014 22:51:49 +0000"  >&lt;p&gt;Let&apos;s not just fix tests without having check all currently maintained version and acted appropriatly.&lt;/p&gt;

&lt;p&gt;I agree that those queries should have required &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; however, so let&apos;s understand what&apos;s wrong with 2.0/2.1 and maybe fix it there.&lt;/p&gt;</comment>
                            <comment id="14241781" author="blerer" created="Wed, 10 Dec 2014 21:34:37 +0000"  >&lt;p&gt;All my apologies. I was wrong the DTest was right. The queries do not need &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; because as &lt;tt&gt;time1&lt;/tt&gt; is a clustering column the secondary index code can use a &lt;tt&gt;SliceQueryFilter&lt;/tt&gt; instead of doing some post filtering on the results returned by the index.&lt;/p&gt;</comment>
                            <comment id="14241786" author="blerer" created="Wed, 10 Dec 2014 21:37:48 +0000"  >&lt;p&gt;The patch fix the code of trunk and the unit tests.&lt;/p&gt;</comment>
                            <comment id="14241789" author="blerer" created="Wed, 10 Dec 2014 21:39:24 +0000"  >&lt;p&gt;The patch fix the problem introduced by the refactoring in 3.0&lt;/p&gt;</comment>
                            <comment id="14242509" author="slebresne" created="Thu, 11 Dec 2014 13:25:48 +0000"  >&lt;p&gt;Actually, I do think the initial reasoning was correct. The query &lt;b&gt;should&lt;/b&gt; require &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; since the partition key is not provided. Because the index cell names starts by the partition key (before the clustering column) and so without the partition key, we do have to filter.&lt;/p&gt;</comment>
                            <comment id="14242878" author="blerer" created="Thu, 11 Dec 2014 18:21:25 +0000"  >&lt;p&gt;What is happening is that non matching clustering columns are filtered out from the index row in &lt;tt&gt;CompositesSearcher.getIndexedIterator&lt;/tt&gt; as it is more efficient than loading the row and then filtering. This filtering can only works today if the clustering columns have been specified as a slice and cause the behavior to not always be consistent specially if some indices exists on the clustering columns.&lt;/p&gt;

&lt;p&gt;I agree that this behaviour is just some filtering optimization and that ALLOW FILTERING should be required.&lt;/p&gt;</comment>
                            <comment id="14243884" author="blerer" created="Fri, 12 Dec 2014 08:49:42 +0000"  >&lt;p&gt;I realized that there is two problems that are linked.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The filtering optimization for clustering column slices is not consistent. If one of the clustering column is also indexed we can end up doing double filtering (once on the index and once on the returned rows).&lt;/li&gt;
	&lt;li&gt;For the same query, we do not require &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt;  if the clustering column is not indexed but we do if the clustering column is indexed.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14244011" author="slebresne" created="Fri, 12 Dec 2014 11:32:45 +0000"  >&lt;p&gt;Let&apos;s try to focus here. The priority is that we should require &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; when we do filtering, and as that doesn&apos;t seem to be the case for some query in 2.0/2.1, let&apos;s focus on how we fix that. The efficiency of the filtering can be fixed later, especially since I doubt the double filtering is terribly impactful.&lt;/p&gt;

&lt;p&gt;Now, regarding queries that should require &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; and don&apos;t, we should probably be careful that adding it is a breaking change (even if it&apos;s a bug fix). So my suggestion would be to let things as they are in 2.0, but log a warning message if it&apos;s used. Changing it in 2.1 is probably fair game at this point if we properly indicate it in the NEWS file.&lt;/p&gt;</comment>
                            <comment id="14244914" author="thobbs" created="Fri, 12 Dec 2014 22:38:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;Now, regarding queries that should require ALLOW FILTERING and don&apos;t, we should probably be careful that adding it is a breaking change (even if it&apos;s a bug fix). So my suggestion would be to let things as they are in 2.0, but log a warning message if it&apos;s used. Changing it in 2.1 is probably fair game at this point if we properly indicate it in the NEWS file.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Regarding logging, that should probably be restricted to only happen once.  A warning log on (potentially) every query could get pretty spammy, and not everybody can quickly change their application code in response to a warning log.&lt;/p&gt;

&lt;p&gt;I also think that it&apos;s too late in 2.1 to make a breaking change for relatively little benefit.  Requiring the user to add &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; won&apos;t change the performance of the query or have any positive impact.  It&apos;s just for educating the user.  That&apos;s nice, but it isn&apos;t worth a breaking change in a bugfix release, IMO.&lt;/p&gt;</comment>
                            <comment id="14287617" author="philipthompson" created="Thu, 22 Jan 2015 15:35:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, so the dtest queries SHOULD require ALLOW FILTERING in all versions, but are only actually demanding it in trunk due to a bug in 2.0 and 2.1, yes?&lt;/p&gt;</comment>
                            <comment id="14288169" author="blerer" created="Thu, 22 Jan 2015 20:28:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt; Yes. &lt;/p&gt;</comment>
                            <comment id="14295866" author="blerer" created="Wed, 28 Jan 2015 21:11:02 +0000"  >&lt;p&gt;The problem with the warning log is that unless we specify the query that should required &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt;  in the message, the warning is a bit useless. The person who will found the warning will have no clue of which query triggered the problem.&lt;br/&gt;
On the other hand, logging only the first query that should have required &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; is a bit misleading, as it could give the impression that only one query was causing problem.&lt;/p&gt;

&lt;p&gt;I am more in favor of letting 2.1 as it is and documenting the change in the &lt;tt&gt;CHANGES.txt&lt;/tt&gt; file for 3.0.&lt;/p&gt;</comment>
                            <comment id="14298746" author="blerer" created="Fri, 30 Jan 2015 15:25:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; what do you think?&lt;/p&gt;</comment>
                            <comment id="14298775" author="slebresne" created="Fri, 30 Jan 2015 15:45:08 +0000"  >&lt;blockquote&gt;
&lt;p&gt;unless we specify the query that should required &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; in the message, the warning is a bit useless.&lt;br/&gt;
documenting the change in the &lt;tt&gt;CHANGES.txt&lt;/tt&gt; file for 3.0&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Why not have a warning that use whatever you planned to put in the &lt;tt&gt;CHANGES.txt&lt;/tt&gt; file? The goal is to make it more likely that user won&apos;t be surprised of the change once they update to 3.0, and believe it or not, people don&apos;t always read the changelog (not saying they always read their log btw, that&apos;s why I&apos;m advocating having the warning in multiple places). It&apos;s true that without the query user will have a harder time finding out which queries are responsible, but making them aware of the issue is still better than nothing imo (note that we can absolutely link to this issue in the warning message).&lt;/p&gt;</comment>
                            <comment id="14298821" author="blerer" created="Fri, 30 Jan 2015 16:33:22 +0000"  >&lt;p&gt;It make sense. I will do it like that.&lt;/p&gt;</comment>
                            <comment id="14298907" author="thobbs" created="Fri, 30 Jan 2015 17:31:51 +0000"  >&lt;p&gt;I think you want &lt;tt&gt;NEWS.txt&lt;/tt&gt;, not &lt;tt&gt;CHANGES.txt&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14350340" author="blerer" created="Fri, 6 Mar 2015 13:37:58 +0000"  >&lt;p&gt;The patch for 2.1 log a warning message the first time the server see a secondary index query with non indexed clustering columns that should require an &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The patch for trunk upates the &lt;tt&gt;NEWS.txt&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14357504" author="thobbs" created="Wed, 11 Mar 2015 20:13:36 +0000"  >&lt;p&gt;+1, committed with minor grammar fixes to the warning log as &lt;tt&gt;4831ba14&lt;/tt&gt;.  I&apos;ve also updated the related &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/981154b0e8c919e8956ca0741a19899e85cc8c12&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; and verified that it logged the correct warning when run against 2.1.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12742677">CASSANDRA-7981</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12703054" name="CASSANDRA-8418-2.1-V2.txt" size="6090" author="blerer" created="Fri, 6 Mar 2015 13:37:58 +0000"/>
                            <attachment id="12703055" name="CASSANDRA-8418-trunk-V2.txt" size="843" author="blerer" created="Fri, 6 Mar 2015 13:37:58 +0000"/>
                            <attachment id="12686380" name="CASSANDRA-8418.txt" size="11609" author="blerer" created="Wed, 10 Dec 2014 21:37:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2315b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>