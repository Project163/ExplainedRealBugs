<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:27:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18180] bulkLoaderSuccessfullyStreamsOverSsl fails with ClassCastException on JDK17</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18180</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17992&quot; title=&quot;Upgrade Netty on 5.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17992&quot;&gt;&lt;del&gt;CASSANDRA-17992&lt;/del&gt;&lt;/a&gt; we hit:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassCastException: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.memory.BufferPool$Chunk cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;sun.nio.ch.DirectBuffer (org.apache.cassandra.utils.memory.BufferPool$Chunk is in unnamed module of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;app&apos;&lt;/span&gt;; sun.nio.ch.DirectBuffer is in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;)\n\tat java.base/com.sun.crypto.provider.GaloisCounterMode$GCMEngine.overlapDetection(GaloisCounterMode.java:865)\n\tat java.base/com.sun.crypto.provider.GaloisCounterMode$GCMDecrypt.doFinal(GaloisCounterMode.java:1502)\n\tat java.base/com.sun.crypto.provider.GaloisCounterMode.engineDoFinal(GaloisCounterMode.java:447)\n\tat 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;del&gt;The issue is exposed with JDK 17, trunk; if interested, ping&lt;/del&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; &lt;del&gt;for current branch as there is no feature branch at the moment&lt;/del&gt;&#160; we can build and start from trunk with JDK17 already. Circle CI can be run for JDK17 too. For more information how to do that - .circleci/readme.md&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13520116">CASSANDRA-18180</key>
            <summary>bulkLoaderSuccessfullyStreamsOverSsl fails with ClassCastException on JDK17</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djatnieks">dan jatnieks</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Jan 2023 22:04:44 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:58 +0000</updated>
                            <resolved>Tue, 25 Jul 2023 01:42:48 +0000</resolved>
                                        <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>CI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17678407" author="edimitrova" created="Wed, 18 Jan 2023 22:11:37 +0000"  >&lt;p&gt;A few notes from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17992&quot; title=&quot;Upgrade Netty on 5.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17992&quot;&gt;&lt;del&gt;CASSANDRA-17992&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
When using JDK provider and not OpenSSL, the class cast exception is there with JDK17, no matter of Netty Version. We do not see the issue in Python DTests as they seem to rely on OpenSSL.&lt;/p&gt;

&lt;p&gt;For the record, comment by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17992&quot; title=&quot;Upgrade Netty on 5.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17992&quot;&gt;&lt;del&gt;CASSANDRA-17992&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Yes, the GaloisCounterMode appears to make about DirectBuffer and their attachments here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&#160;Looking again at the rest of the JDK, I&apos;m not actually sure attachments can be accessed publicly, so this is probably our problem rather than the JDK&apos;s. However, we might be able to fix it by simply having Chunk implement DirectBuffer, and having it return its address.&lt;/p&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;
&lt;p&gt;To be investigated further&lt;/p&gt;</comment>
                            <comment id="17702345" author="edimitrova" created="Sun, 19 Mar 2023 19:16:23 +0000"  >&lt;p&gt;I just noticed that in the latest trunk runs with JDK17 the test fails with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
14:15:18,910 Connection.java:1327 - Connection[/127.0.0.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] connection error com.datastax.shaded.netty.handler.codec.DecoderException: javax.net.ssl.SSLException: Received fatal alert: internal_error at com.datastax.shaded.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:461) at com.datastax.shaded.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:267) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:356) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:342) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:335) at com.datastax.shaded.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1304) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:356) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:342) at com.datastax.shaded.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:921) at com.datastax.shaded.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:135) at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:646) at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:546) at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:500) at com.datastax.shaded.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:460) at com.datastax.shaded.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:131) at com.datastax.shaded.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833) Caused by: javax.net.ssl.SSLException: Received fatal alert: internal_error at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:133) at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117) at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:358) at java.base/sun.security.ssl.Alert$AlertConsumer.consume(Alert.java:293) at java.base/sun.security.ssl.TransportContext.dispatch(TransportContext.java:204) at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:172) at java.base/sun.security.ssl.SSLEngineImpl.decode(SSLEngineImpl.java:736) at java.base/sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:691) at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:506) at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:482) at java.base/javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:679) at com.datastax.shaded.netty.handler.ssl.SslHandler$SslEngineType$3.unwrap(SslHandler.java:283) at com.datastax.shaded.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1205) at com.datastax.shaded.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1108) at com.datastax.shaded.netty.handler.ssl.SslHandler.decode(SslHandler.java:1151) at com.datastax.shaded.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:491) at com.datastax.shaded.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:430) ... 16 common frames omitted DEBUG [cluster1-nio-worker-0] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,911 Connection.java:601 - Defuncting Connection[/127.0.0.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] because: [localhost/127.0.0.1:9042] Unexpected exception triggered (com.datastax.shaded.netty.handler.codec.DecoderException: javax.net.ssl.SSLException: Received fatal alert: internal_error) DEBUG [cluster1-nio-worker-0] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,911 ConvictionPolicy.java:118 - [localhost/127.0.0.1:9042] preventing &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; connections &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the next 1000 ms DEBUG [cluster1-nio-worker-0] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,911 ConvictionPolicy.java:102 - [localhost/127.0.0.1:9042] Connection[/127.0.0.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] failed, remaining = 0 DEBUG [cluster1-nio-worker-0] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,911 Connection.java:892 - Connection[/127.0.0.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;] closing connection DEBUG [cluster1-nio-worker-0] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,912 Connection.java:950 - Not terminating Connection[/127.0.0.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;]: there are still pending requests DEBUG [main] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,912 ControlConnection.java:285 - [Control connection] error on localhost/127.0.0.1:9042 connection, no more host to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; com.datastax.driver.core.exceptions.TransportException: [localhost/127.0.0.1:9042] Connection has been closed at com.datastax.driver.core.Connection$ConnectionCloseFuture.force(Connection.java:1458) at com.datastax.driver.core.Connection$ConnectionCloseFuture.force(Connection.java:1439) at com.datastax.driver.core.Connection.defunct(Connection.java:622) at com.datastax.driver.core.Connection$Dispatcher.exceptionCaught(Connection.java:1361) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelHandlerAdapter.exceptionCaught(ChannelHandlerAdapter.java:88) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelHandlerAdapter.exceptionCaught(ChannelHandlerAdapter.java:88) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelHandlerAdapter.exceptionCaught(ChannelHandlerAdapter.java:88) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:259) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:251) at com.datastax.shaded.netty.handler.ssl.SslHandler.exceptionCaught(SslHandler.java:979) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:280) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.notifyHandlerException(AbstractChannelHandlerContext.java:843) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:358) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:342) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:335) at com.datastax.shaded.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1304) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:356) at com.datastax.shaded.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:342) at com.datastax.shaded.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:921) at com.datastax.shaded.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:135) at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:646) at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:546) at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:500) at com.datastax.shaded.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:460) at com.datastax.shaded.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:131) at com.datastax.shaded.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833) DEBUG [main] &amp;lt;main&amp;gt; 2023-03-17 14:15:18,913 Cluster.java:1915 - Shutting down WARN 14:15:18 Unknown exception in client networking io.netty.handler.codec.DecoderException: javax.net.ssl.SSLException: Fail to unwrap network record at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:478) at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:276) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166) at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:719) at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:655) at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:581) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493) at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989) at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833) Caused by: javax.net.ssl.SSLException: Fail to unwrap network record at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:133) at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:371) at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:314) at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:522) at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:482) at java.base/javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:679) at io.netty.handler.ssl.SslHandler$SslEngineType$3.unwrap(SslHandler.java:282) at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1387) at io.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1282) at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1329) at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:508) at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:447) ... 17 common frames omitted Caused by: java.lang.ClassCastException: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.Ref cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;sun.nio.ch.DirectBuffer (org.apache.cassandra.utils.concurrent.Ref is in unnamed module of loader org.apache.cassandra.distributed.shared.InstanceClassLoader @2a0ce342; sun.nio.ch.DirectBuffer is in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;) at java.base/com.sun.crypto.provider.GaloisCounterMode$GCMEngine.overlapDetection(GaloisCounterMode.java:865) at java.base/com.sun.crypto.provider.GaloisCounterMode$GCMDecrypt.doFinal(GaloisCounterMode.java:1502) at java.base/com.sun.crypto.provider.GaloisCounterMode.engineDoFinal(GaloisCounterMode.java:447) at java.base/javax.crypto.Cipher.doFinal(Cipher.java:2500) at java.base/sun.security.ssl.SSLCipher$T12GcmReadCipherGenerator$GcmReadCipher.decrypt(SSLCipher.java:1659) at java.base/sun.security.ssl.SSLEngineInputRecord.decodeInputRecord(SSLEngineInputRecord.java:239) at java.base/sun.security.ssl.SSLEngineInputRecord.decode(SSLEngineInputRecord.java:196) at java.base/sun.security.ssl.SSLEngineInputRecord.decode(SSLEngineInputRecord.java:159) at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:111) at java.base/sun.security.ssl.SSLEngineImpl.decode(SSLEngineImpl.java:736) at java.base/sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:691) at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:506) ... 25 common frames omitte&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Now I see:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(org.apache.cassandra.utils.concurrent.Ref is in unnamed module of loader org.apache.cassandra.distributed.shared.InstanceClassLoader @2a0ce342; sun.nio.ch.DirectBuffer is in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;) at&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2321/workflows/de1f521d-c5cb-4ddd-bc45-9ec71b577bf3/jobs/19932/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this run&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But I did not find the previous class cast exception... to be investigated&lt;/p&gt;</comment>
                            <comment id="17712874" author="djatnieks" created="Mon, 17 Apr 2023 03:40:03 +0000"  >&lt;p&gt;Running &#160;&lt;tt&gt;SSTableLoaderEncryptionOptionsTest&lt;/tt&gt;&#160;locally, I am seeing the same result as the first error mentioned in the previous comment, specifically:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.ClassCastException: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.memory.BufferPool$Chunk cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;sun.nio.ch.DirectBuffer (org.apache.cassandra.utils.memory.BufferPool$Chunk is in unnamed module of loader org.apache.cassandra.distributed.shared.InstanceClassLoader @4b34fff9; sun.nio.ch.DirectBuffer is in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;)
&#160; &#160; at java.base/com.sun.crypto.provider.GaloisCounterMode$GCMEngine.overlapDetection(GaloisCounterMode.java:865)
&#160; &#160; at java.base/com.sun.crypto.provider.GaloisCounterMode$GCMDecrypt.doFinal(GaloisCounterMode.java:1502)
&#160; &#160; at java.base/com.sun.crypto.provider.GaloisCounterMode.engineDoFinal(GaloisCounterMode.java:447)
&#160; &#160; at java.base/javax.crypto.Cipher.doFinal(Cipher.java:2500)
&#160; &#160; at java.base/sun.security.ssl.SSLCipher$T12GcmReadCipherGenerator$GcmReadCipher.decrypt(SSLCipher.java:1659)
&#160; &#160; at java.base/sun.security.ssl.SSLEngineInputRecord.decodeInputRecord(SSLEngineInputRecord.java:239)
&#160; &#160; at java.base/sun.security.ssl.SSLEngineInputRecord.decode(SSLEngineInputRecord.java:196)
&#160; &#160; at java.base/sun.security.ssl.SSLEngineInputRecord.decode(SSLEngineInputRecord.java:159)
&#160; &#160; at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:111)
&#160; &#160; at java.base/sun.security.ssl.SSLEngineImpl.decode(SSLEngineImpl.java:736)
&#160; &#160; at java.base/sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:691)
&#160; &#160; at java.base/sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:506)
&#160; &#160; ... 25 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Considering the comment made here on this ticket from 18/Jan/2023 about &lt;tt&gt;GaloisCounterMode&lt;/tt&gt; and &lt;tt&gt;DirectBuffer&lt;/tt&gt; attachments, do we consider this within the scope of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17992&quot; title=&quot;Upgrade Netty on 5.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17992&quot;&gt;&lt;del&gt;CASSANDRA-17992&lt;/del&gt;&lt;/a&gt;, or as something separate?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17713086" author="edimitrova" created="Mon, 17 Apr 2023 13:17:51 +0000"  >&lt;p&gt;Thank you for looking into this!&lt;/p&gt;

&lt;p&gt;The comment on this ticket from 18/Jan/2023&#160;was made to provide additional context. The problem you managed to reproduce is about what we do in regards to JDK and we hit in JDK17, it is not about Netty.&lt;/p&gt;

&lt;p&gt;I hope that helps and I did not misunderstand your question.&lt;/p&gt;

&lt;p&gt;Please ping me in Slack if I can help with anything. Thank you&lt;/p&gt;</comment>
                            <comment id="17713274" author="djatnieks" created="Mon, 17 Apr 2023 20:15:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think you meant the comment on this ticket from 18/Jan/2023, not on&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17992&quot; title=&quot;Upgrade Netty on 5.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17992&quot;&gt;&lt;del&gt;CASSANDRA-17992&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, that was my intent - I&apos;ve update the comment to try and make it more clear &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;It was made to provide additional context. The problem you managed to reproduce is about what we do in regards to JDK and we hit in JDK17, it is not about Netty.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok, thanks, this helps clarify it for me - I will try and address the &lt;tt&gt;ClassCastException&lt;/tt&gt; here with this ticket then.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17719564" author="djatnieks" created="Thu, 4 May 2023 23:08:15 +0000"  >&lt;p&gt;I created a patch that implements &lt;tt&gt;sun.nio.ch.DirectBuffer&lt;/tt&gt; in &lt;tt&gt;BufferPool$Chunk&lt;/tt&gt; and &lt;tt&gt;Ref&lt;/tt&gt; - doing this resolves the &lt;tt&gt;ClassCastException&lt;/tt&gt; coming from &lt;tt&gt;GaloisCounterMode.overlapDetection&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;DirectBuffer&lt;/tt&gt; is not publicly exposed, to make compilation work for JDK11/17 it&apos;s necessary to add exports for &lt;tt&gt;java.base/jdk.internal.ref&lt;/tt&gt; and &lt;tt&gt;java.base/sun.nio.ch&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;There is also a change to how &lt;tt&gt;TestNameCheckTask&lt;/tt&gt; is invoked by &lt;tt&gt;build.xml&lt;/tt&gt;. Since &lt;tt&gt;TestNameCheckTask&lt;/tt&gt; uses &lt;tt&gt;Reflections&lt;/tt&gt; to get the methods annotated with &lt;tt&gt;@Test&lt;/tt&gt;, and that involves loading classes with the ClassLoader it also needs to pass jvm args for jdk11/17 to avoid &lt;tt&gt;IllegalAccessError&lt;/tt&gt; to &lt;tt&gt;sun.nio.ch.DirectBuffer&lt;/tt&gt; (not exported by &lt;tt&gt;java.base&lt;/tt&gt;). To accomplish this, the &lt;tt&gt;checktestnameshelper&lt;/tt&gt; ant task in &lt;tt&gt;build.xml&lt;/tt&gt; is replaced with a java task, passing the necessary jvm args.&lt;/p&gt;

&lt;p&gt;Note: these changes are not compatible with JDK8.&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/djatnieks/cassandra/tree/CASSANDRA-18180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/djatnieks/cassandra/3/workflows/7ba8f619-835e-4464-b5a0-6c828352e3d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java 11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/djatnieks/cassandra/3/workflows/86cc2e85-e718-4d09-aa55-fbec0c399733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java 17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17719644" author="edimitrova" created="Fri, 5 May 2023 06:01:19 +0000"  >&lt;p&gt;Thank you for the update,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;&#160;!&lt;/p&gt;

&lt;p&gt;I just pushed CI run with my paid CircleCI account.&lt;/p&gt;

&lt;p&gt;I created the configuration by running in the .circleci folder&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./generate_11_and_17.sh -p&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We can check the results later &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra?branch=CASSANDRA-18180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17723471" author="edimitrova" created="Wed, 17 May 2023 14:00:24 +0000"  >&lt;p&gt;The CI looks good. If we opt in to this solution we still need to justify why we cannot workaround the access to internals and what would be the solution without opening them. Is it too involved to be implemented, do we plan to do it later, etc?&lt;/p&gt;</comment>
                            <comment id="17723776" author="djatnieks" created="Thu, 18 May 2023 02:47:38 +0000"  >&lt;p&gt;Recap:&#160; The &lt;tt&gt;attachment&lt;/tt&gt; field of &lt;tt&gt;ByteBuffer&lt;/tt&gt; is being used to store the related &lt;tt&gt;BufferPool&lt;/tt&gt; &lt;tt&gt;Chunk&lt;/tt&gt; object that is associated with the buffer. Since &lt;del&gt;JDK11&lt;/del&gt; JDK16 some crypto overlap detection code in &lt;tt&gt;GaloisCounterMode&lt;/tt&gt; expects that any object attached to a &lt;tt&gt;ByteBuffer&lt;/tt&gt; implements &lt;tt&gt;DirectBuffer&lt;/tt&gt;, and if it does not, will cause a &lt;tt&gt;ClassCastException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Since we see this &lt;tt&gt;ClassCastException&lt;/tt&gt; in tests using encryption, it seems it&apos;s triggered by a supported TLS setting rather than some unintended default.&lt;/p&gt;

&lt;p&gt;The patch I provided uses the suggestion made by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; in this comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17992&quot; title=&quot;Upgrade Netty on 5.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17992&quot;&gt;&lt;del&gt;CASSANDRA-17992&lt;/del&gt;&lt;/a&gt;, which is to have &lt;tt&gt;Chunk&lt;/tt&gt; (and also &lt;tt&gt;Ref&lt;/tt&gt;) implement &lt;tt&gt;DirectBuffer&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The main downside to this is that two additional &lt;tt&gt;--add-exports&lt;/tt&gt; are required to be able to access JDK internal class &lt;tt&gt;DirectBuffer&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Access to this internal class also has a secondary impact on &lt;tt&gt;TestNameCheckTask&lt;/tt&gt; as it uses reflection and tries to load all related classes of tests being checked. This led to replacing the &lt;tt&gt;checktestnameshelper&lt;/tt&gt; ant task in &lt;tt&gt;build.xml&lt;/tt&gt; with a java target so that it is possible to pass the needed jvm args to &lt;tt&gt;TestNameCheckTask&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;An alternative approach that avoids accessing jdk internals would, I think, still need to associate &lt;tt&gt;ByteBuffer&lt;/tt&gt; objects to &lt;tt&gt;Chunk&lt;/tt&gt; objects. I experimented with using a map for this, but ended up learning that &lt;tt&gt;ByteBuffer&lt;/tt&gt;&apos;s are not suited to being used as map keys, as the docs state:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;because buffer hash codes are content-dependent, it is inadvisable to use buffers as keys in hash maps or similar data structures unless it is known that their contents will not change.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, you can put a &lt;tt&gt;ByteBuffer&lt;/tt&gt; into a map, but if the contents change you won&apos;t be able to retrieve/find it again.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what other workaround solution to propose that doesn&apos;t negatively affect complexity and/or performance, but am happy to look into other ideas.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;There is another aspect of this that I don&apos;t fully understand that&apos;s somewhat bothersome - this test only fails with JDK17 even though the same &lt;tt&gt;GaloisCounterMode&lt;/tt&gt; overlap detection code is present in JDK11; for some reason the same code path is not executed and the tests pass with JDK11. I wonder why that is?&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;I did check the enabled cipher suites for internode messaging and native transport that I found looking at test run output - and those are the same with 11 and 17. So I guess it&apos;s a result of some change in the JDK? If I could be due to something else, I don&apos;t know what that might be.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;My mistake - &lt;tt&gt;GaloisCounterMode&lt;/tt&gt; overlap detection was only added in JDK16 with &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8253821&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JDK-8253821&lt;/a&gt;, so it does make sense that this issue happens with JDK17 and not with JDK11.&lt;/p&gt;</comment>
                            <comment id="17724982" author="brandon.williams" created="Mon, 22 May 2023 14:42:13 +0000"  >&lt;p&gt;I think enough due diligence has been done here that we should probably accept the exports at this point, and we can open a ticket in the future if this becomes a higher priority.&lt;/p&gt;</comment>
                            <comment id="17725576" author="djatnieks" created="Tue, 23 May 2023 21:12:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;I experimented with using a map for this, but ended up learning that &lt;tt&gt;ByteBuffer&lt;/tt&gt;&apos;s are not suited to being used as map keys&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Just a note that it was pointed out to me that &lt;tt&gt;IdentityHashMap&lt;/tt&gt; could work for this, however it would need to be made thread safe and performance would need to be verified.&lt;/p&gt;</comment>
                            <comment id="17728386" author="edimitrova" created="Thu, 1 Jun 2023 14:41:22 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;&#160;!&lt;/p&gt;

&lt;p&gt;I talked in Slack with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;He looked into the patch and he also agreed with your approach.&lt;/p&gt;

&lt;p&gt;He has only one suggestion which is more about how to make it a bit more clear maybe and not a correctness issue or so:&lt;br/&gt;
He thinks it might be nicer to have a wrapper class around the Ref. As that case matters only for testing purposes or if some DEBUG_ENABLED is active. (For reference - BufferPool.setAttachment)&lt;br/&gt;
&#160;&lt;br/&gt;
In this case we could set it to some object that contains the Ref and also implements DirectBuffer, so that we don&#8217;t leak these details into&#160;&lt;tt&gt;Ref&lt;/tt&gt;&#160; which probably shouldn&#8217;t know of them&#160;and the extra indirection is only going to be incurred by hosts already paying a very high cost for managing the lifecycle&lt;br/&gt;
I think both me and him are ok also with the current approach, so it will be up to the author&#160;whether&#160;to consider that suggestion&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17730281" author="djatnieks" created="Wed, 7 Jun 2023 21:15:04 +0000"  >&lt;p&gt;I think that&apos;s a good suggestion. So the idea I have for that is to add a class like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DirectBufferRef&amp;lt;T extends DirectBuffer&amp;gt; extends Ref&amp;lt;T&amp;gt; implements DirectBuffer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
This can use used in &lt;tt&gt;BufferPool.setAttachment&lt;/tt&gt; , like so:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;MemoryUtil.setAttachment(buffer, new DirectBufferRef&amp;lt;&amp;gt;(this, null));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here&apos;s a patch with that approach; let me know if it matches the suggestion or I could try something else: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13058861/13058861_cassandra-18180-directbufferref.diff&quot; title=&quot;cassandra-18180-directbufferref.diff attached to CASSANDRA-18180&quot;&gt;cassandra-18180-directbufferref.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also noticed that &lt;tt&gt;MerkleTree&lt;/tt&gt; has some similar code that sets a &lt;tt&gt;Ref&lt;/tt&gt; as a &lt;tt&gt;ByteBuffer&lt;/tt&gt; attachment, and in fact, I think any caller of &lt;tt&gt;MemoryUtil.setAttachment&lt;/tt&gt; probably needs to ensure that the attachment object implements &lt;tt&gt;DirectBuffer&lt;/tt&gt; in case it gets used with encryption enabled.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;MerkleTree&lt;/tt&gt; case is a bit easier than &lt;tt&gt;BufferPool&lt;/tt&gt; because it only uses a &lt;tt&gt;null&lt;/tt&gt; referent, so it&apos;s enough just to use something like the &lt;tt&gt;DirectBufferRef&lt;/tt&gt; mentioned above (no need to implement &lt;tt&gt;DirectBuffer&lt;/tt&gt; in &lt;tt&gt;MerkleTree&lt;/tt&gt; afaict). &lt;span class=&quot;error&quot;&gt;&amp;#91;This is not included yet in the patch&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I thought that perhaps it would be a good idea to even enforce it in &lt;tt&gt;MemoryUtil&lt;/tt&gt;, something like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public static &amp;lt;T extends DirectBuffer&amp;gt; void setAttachment(ByteBuffer instance, T next)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, then I found that &lt;tt&gt;SyncUtil.force&lt;/tt&gt; uses &lt;tt&gt;MemoryUtil.getAttachment&lt;/tt&gt; and expects that the attachment may be &lt;tt&gt;Runnable&lt;/tt&gt;. I&apos;m not sure yet how that gets set though - I didn&apos;t any other &lt;tt&gt;setAttachment&lt;/tt&gt; calls with &lt;tt&gt;Runnable&lt;/tt&gt; except in a unit test. Right now I&apos;m not sure what to do about this one - and I&apos;m concerned that when encryption is being used, this could again lead to a &lt;tt&gt;ClassCastException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17730331" author="edimitrova" created="Thu, 8 Jun 2023 01:25:08 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;&#160;, I will try to take a look at this tomorrow afternoon. CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17730700" author="djatnieks" created="Thu, 8 Jun 2023 20:07:44 +0000"  >&lt;p&gt;I added a commit for &lt;tt&gt;MerkleTree&lt;/tt&gt; - here is the latest branch and comparison:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/djatnieks/cassandra/tree/CASSANDRA-18180-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-18180-trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...djatnieks:cassandra:CASSANDRA-18180-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;compare with trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Btw, the reason I put &lt;tt&gt;DirectBufferRef&lt;/tt&gt; in &lt;tt&gt;Ref.java&lt;/tt&gt; is not to change the package protected variable &lt;tt&gt;referent&lt;/tt&gt;. And having &lt;tt&gt;DirectBufferRef&lt;/tt&gt; makes it simple to replace any use of &lt;tt&gt;Ref&lt;/tt&gt; as a &lt;tt&gt;ByteBuffer&lt;/tt&gt; attachment, such as in &lt;tt&gt;MerkleTree&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17730980" author="adelapena" created="Fri, 9 Jun 2023 14:19:28 +0000"  >&lt;p&gt;It seems there is a build failure for j8: &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2942/workflows/029d1542-7559-435e-b006-2e9a309ba434/jobs/49191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/2942/workflows/029d1542-7559-435e-b006-2e9a309ba434/jobs/49191&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17731019" author="djatnieks" created="Fri, 9 Jun 2023 16:32:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;It seems there is a build failure for j8&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s expected as this patch works only for jdk11 and jdk17 and merging will be blocked until jdk8 is dropped.&lt;br/&gt;
I added a link to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18255&quot; title=&quot;Drop JDK8 Support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18255&quot;&gt;&lt;del&gt;CASSANDRA-18255&lt;/del&gt;&lt;/a&gt; to indicate this.&lt;/p&gt;</comment>
                            <comment id="17731619" author="adelapena" created="Mon, 12 Jun 2023 13:31:47 +0000"  >&lt;p&gt;Ah, I see. Thanks for the explanation and the link.&lt;/p&gt;</comment>
                            <comment id="17733252" author="edimitrova" created="Thu, 15 Jun 2023 22:16:58 +0000"  >&lt;p&gt;I am still looking into this, but I wanted to ask &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;&#160;to open a PR with the latest branch where we can add comments and keep things in one place. Thank you in advance. I also mentioned some addition needed for Intellij to work with the new exports &lt;a href=&quot;https://github.com/djatnieks/cassandra/commit/9b2e993e11dc5905843fa1f4c52ea5f5437b301e#r118268304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17733553" author="edimitrova" created="Fri, 16 Jun 2023 15:16:00 +0000"  >&lt;p&gt;I realized that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt; is away these days so I decided to help and open PR where I also pushed a commit to fix IntelliJ IDEA. I will push there also my review comments - &lt;a href=&quot;https://github.com/apache/cassandra/pull/2421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2421&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17733667" author="edimitrova" created="Fri, 16 Jun 2023 22:14:58 +0000"  >&lt;p&gt;I left comments in the PR already, but also here for completeness:&lt;/p&gt;

&lt;p&gt;I still have to dig into the GaloisCounterMode, but I wanted to give you the first review comments that you can think about when you are back, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;1) I tested check-test-names by running the ant build-test with wrong test names, and it seems the ant task no longer works as expected. I suggested a workaround in the comments for you.&lt;br/&gt;
2) I am not sure it is a good idea to make Ref not final anymore&lt;br/&gt;
3) Did some archeology and talked to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; about:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;However, then I found that SyncUtil.force uses MemoryUtil.getAttachment and expects that the attachment may be Runnable. I&apos;m not sure yet how that gets set though - I didn&apos;t any other setAttachment calls with Runnable except in a unit test.&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is only used in tests, and if they pass, it is ok&#8212;more in the PR plus suggestions to update comments for the future generations of Cassandra developers.&lt;/p&gt;

&lt;p&gt;4) I also ran CI, and I did not find any new failures &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2378/workflows/cfb2f852-1a68-4a7f-8b61-c49efc5403f6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2378/workflows/cfb2f852-1a68-4a7f-8b61-c49efc5403f6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;More next week&lt;/p&gt;</comment>
                            <comment id="17735458" author="dcapwell" created="Tue, 20 Jun 2023 21:15:14 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;&apos;s 3rd point from me...&lt;/p&gt;

&lt;p&gt;org.apache.cassandra.io.filesystem.ListenableFileSystem relies on attachment as a way to allow the file system to implement flush when performing mmap (see org.apache.cassandra.io.filesystem.ListenableFileSystem.ListenableFileChannel#map)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// with real files the FD gets copied so the close of the channel does not block the BB mutation
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// from flushing...  it&apos;s possible to support &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; use &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, but kept things simplier &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; now by
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// failing &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the backing channel was closed.
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; forcer = () -&amp;gt; {
                    ByteBuffer local = bb.duplicate();
                    local.position(0);
                    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; pos = position;
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                    {
                        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (local.hasRemaining())
                        {
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; wrote = write(local, pos);
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wrote == -1)
                                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EOFException();
                            pos += wrote;
                        }
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
                    {
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UncheckedIOException(e);
                    }
                };
                MemoryUtil.setAttachment(bb, forcer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, if you are making changes and org.apache.cassandra.io.filesystem.ListenableFileSystem is working with mmap support, then you are fine in this case... force does not require Runnable, but allows Runnable&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// org.apache.cassandra.utils.SyncUtil#force(java.nio.MappedByteBuffer)
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; attachment = MemoryUtil.getAttachment(buf);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (attachment &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;)
        {
            ((&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;) attachment).run();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; buf;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are a few reasons for this&lt;/p&gt;

&lt;p&gt;1) when doing jvm-dtest, you may have the same FileSystem shared cross multiple instances (simulator does this), this means that the FileSystem is in app class loader, and the users are in InstanceClassLoader... so the only type possible are primitive JDK types&lt;br/&gt;
2) our force checks are hard to mock out due to the reliance of java.nio.MappedByteBuffer#force and a FileDescriptor; 2 types that can&apos;t be created by tests...&lt;/p&gt;


&lt;p&gt;So yeah, the runnable is kinda a hack, but as long as you make sure its still hitting the mmap case, then your patch doesn&apos;t break this relationship...  Simulator tests this, so if those tests are run and passing, should be fine&lt;/p&gt;</comment>
                            <comment id="17735460" author="edimitrova" created="Tue, 20 Jun 2023 21:21:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;The simulator tests this, so it should be fine if those tests are run and pass.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thank you,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;, this was valuable.&#160;Simulator tests are run only with JDK11, no JDK 17 tests.&lt;/p&gt;

&lt;p&gt;The focus before the freeze is on main Cassandra.&lt;/p&gt;

&lt;p&gt;But I will try running the simulator tests now with Java 17 to see where we stand. Thanks again!&lt;/p&gt;</comment>
                            <comment id="17735480" author="edimitrova" created="Tue, 20 Jun 2023 23:26:26 +0000"  >&lt;p&gt;Ok, I pushed a fix for the simulator and all tests pass with and without the patch with Java17. I will push the changes soon and also open a ticket for the simulator where those can be separately reviewed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17735517" author="edimitrova" created="Wed, 21 Jun 2023 02:30:05 +0000"  >&lt;p&gt;Simulator patch pushed in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18616&quot; title=&quot;Simulator Java 17 support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18616&quot;&gt;&lt;del&gt;CASSANDRA-18616&lt;/del&gt;&lt;/a&gt;. With and without the current patch here the tests pass with JDK17 so we are good regarding what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160;mentioned. Thank you!&lt;/p&gt;

&lt;p&gt;New commits pushed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;&#160;to the PR to address some of the current feedback. I will continue reviewing tomorrow&#160;&lt;/p&gt;</comment>
                            <comment id="17736313" author="edimitrova" created="Fri, 23 Jun 2023 00:04:59 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Pushed new CI run with the latest changes -&#160;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra?branch=CASSANDRA-18180-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra?branch=CASSANDRA-18180-trunk&lt;/a&gt;&lt;br/&gt;
There are two tests that I haven&apos;t seen failing before. Tests in discussion:&#160;&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2386/workflows/e604ddb5-85fb-4828-b6d5-aae56ba6e6a6/jobs/26557/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_move_backwards_and_cleanup&lt;/a&gt;&#160;- Python DTest&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2386/workflows/ec4aaa50-acea-4c9d-bb20-5d139a6962ab/jobs/26575/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testTruncationReleasesLogSpace-oa.jdk11&lt;/a&gt;&#160;- unit test&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I managed to reproduce the test_move_backwards_and_cleanup on current trunk &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2390/workflows/719ea674-1f0f-4165-92ba-785469e1bb2f/jobs/27021/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&#160;I did not manage to reproduce the other one in 1000 runs but it seems it could be just something random. (file not available)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I ran the simulator tests with JDK17 again (locally until we get the JDK 17 simulator tests job to CircleCI, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18616&quot; title=&quot;Simulator Java 17 support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18616&quot;&gt;&lt;del&gt;CASSANDRA-18616&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;I tested the check-test-names task. It works as expected.&lt;/li&gt;
	&lt;li&gt;The JDK change we address here affects only GCM, as per the JEP &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djatnieks&quot; class=&quot;user-hover&quot; rel=&quot;djatnieks&quot;&gt;djatnieks&lt;/a&gt;&#160; pointed to. The wrapper looks ok to me and it is used only in debugging/testing.&lt;/li&gt;
	&lt;li&gt;I did not find any other places where we might be hitting this problem.&lt;/li&gt;
	&lt;li&gt;I also ran test_simple_bootstrap_with_ssl and sslnodetonode_test Python DTests with Netty version that uses by default JDK provider (netty 4.1.73, I also had at that branch netty-tcnative-boringssl-static - 2.0.51 but I do not think that matters here) and it was hitting this problem before. The tests pass with this patch, no new problems observed.&lt;br/&gt;
&#160;&lt;br/&gt;
Let&apos;s see if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;&#160;will find something we are missing here, but I am personally +1 on the current work. (On squash, rebase and final CI ofc pre-commit)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17736462" author="adelapena" created="Fri, 23 Jun 2023 11:12:02 +0000"  >&lt;p&gt;I don&apos;t have anything else to add, changes look good to me.&lt;/p&gt;

&lt;p&gt;As for &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2386/workflows/ec4aaa50-acea-4c9d-bb20-5d139a6962ab/jobs/26575/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the failure on&#160;&lt;tt&gt;testTruncationReleasesLogSpace&lt;/tt&gt;&lt;/a&gt;, I have managed to &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2976/workflows/0427ff5b-b283-4c5e-bfaf-83d600626eaf/jobs/53102/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reproduce it on &lt;tt&gt;trunk&lt;/tt&gt;&lt;/a&gt;, so it seems the failure is not related to the changes. Actually, that test can fail on trunk also in &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2973/workflows/dd6e237b-ae4f-4230-94b9-eb48c49d8642/jobs/52884/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a different way&lt;/a&gt;. So it&apos;s definitively a now-known flaky.&lt;/p&gt;</comment>
                            <comment id="17736503" author="edimitrova" created="Fri, 23 Jun 2023 14:04:02 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;&#160;!&lt;/p&gt;

&lt;p&gt;I will leave the ticket in ReadyToCommit until we close the other few drop JDK8 blockers.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;As for &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2386/workflows/ec4aaa50-acea-4c9d-bb20-5d139a6962ab/jobs/26575/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the failure on&#160;&lt;tt&gt;testTruncationReleasesLogSpace&lt;/tt&gt;&lt;/a&gt;, I have managed to &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2976/workflows/0427ff5b-b283-4c5e-bfaf-83d600626eaf/jobs/53102/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reproduce it on &lt;tt&gt;trunk&lt;/tt&gt;&lt;/a&gt;, so it seems the failure is not related to the changes. Actually, that test can fail on trunk also in &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2973/workflows/dd6e237b-ae4f-4230-94b9-eb48c49d8642/jobs/52884/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a different way&lt;/a&gt;. So it&apos;s definitively a now-known flaky.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Great, thanks! We should open follow-up tickets for the two flaky tests.&#160;&lt;/p&gt;</comment>
                            <comment id="17746617" author="edimitrova" created="Mon, 24 Jul 2023 19:31:58 +0000"  >&lt;p&gt;Rebased and running final CI: &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2432/workflows/61555395-8882-4e11-bfa0-140797bef9d6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2432/workflows/61555395-8882-4e11-bfa0-140797bef9d6&lt;/a&gt;&lt;br/&gt;
Tested the check for test names locally; it fails properly when it has to. &lt;/p&gt;

</comment>
                            <comment id="17746640" author="edimitrova" created="Mon, 24 Jul 2023 20:31:56 +0000"  >&lt;p&gt;CI looks great. All java distributed tests pass now. The failing unit tests are known from the table in the description of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16895&quot; title=&quot;Build with Java 17&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16895&quot;&gt;&lt;del&gt;CASSANDRA-16895&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Pending commit on ensuring Jenkins accepted the drop from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18225&quot; title=&quot;CEP-15: (C*) Accord adds a accord.messages.Defer which isn&amp;#39;t supported for persisting, causing the operation to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18225&quot;&gt;&lt;del&gt;CASSANDRA-18225&lt;/del&gt;&lt;/a&gt; as expected.&lt;/p&gt;</comment>
                            <comment id="17746695" author="edimitrova" created="Mon, 24 Jul 2023 23:27:13 +0000"  >&lt;p&gt;In regards to the flaky tests we wanted open tickets for:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;testTruncationReleasesLogSpace - it had already a ticket in triage, I moved it to open and posted the second possible way to fail for reference. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18274&quot; title=&quot;Test failure: org.apache.cassandra.utils.binlog.BinLogTest.testTruncationReleasesLogSpace-compression&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18274&quot;&gt;CASSANDRA-18274&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2386/workflows/e604ddb5-85fb-4828-b6d5-aae56ba6e6a6/jobs/26557/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_move_backwards_and_cleanup&lt;/a&gt;&#160; I just opened ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18686&quot; title=&quot;Test failure: test_move_backwards_and_cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18686&quot;&gt;&lt;del&gt;CASSANDRA-18686&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17746724" author="edimitrova" created="Tue, 25 Jul 2023 01:42:04 +0000"  >&lt;p&gt;Committed&#160;to &lt;a href=&quot;https://github.com/apache/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160; 02f6353e1f..fe8a6eb70f&#160; trunk -&amp;gt; trunk&lt;/p&gt;

&lt;p&gt;Thank you all!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13536924">CASSANDRA-18540</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13524162">CASSANDRA-18255</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13540828">CASSANDRA-18616</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                            <outwardlinks description="Testing discovered">
                                        <issuelink>
            <issuekey id="13544718">CASSANDRA-18686</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13491388">CASSANDRA-17992</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13058861" name="cassandra-18180-directbufferref.diff" size="10321" author="djatnieks" created="Wed, 7 Jun 2023 21:10:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[djatnieks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>CASSANDRA-16895</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1f5eg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[e.dimitrova]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/fe8a6eb70f35b5404b15303f314023ce8d08042f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fe8a6eb70f35b5404b15303f314023ce8d08042f&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Patch:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/djatnieks/cassandra/tree/CASSANDRA-18180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/djatnieks/cassandra/tree/CASSANDRA-18180&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;PR:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2421&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Tested locally with jdk11 and jdk17:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant test-jvm-dtest-some -Dtest.name=org.apache.cassandra.distributed.test.SSTableLoaderEncryptionOptionsTest&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>