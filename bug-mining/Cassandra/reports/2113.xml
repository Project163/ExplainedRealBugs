<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:37:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5125] Support indexes on composite column components (clustered columns)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5125</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Given&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE foo (
  a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  PRIMARY KEY (a, b)
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should support &lt;tt&gt;CREATE INDEX ON foo(b)&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12626383">CASSANDRA-5125</key>
            <summary>Support indexes on composite column components (clustered columns)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jan 2013 18:33:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:20 +0000</updated>
                            <resolved>Thu, 4 Apr 2013 16:33:46 +0000</resolved>
                                        <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13580423" author="slebresne" created="Mon, 18 Feb 2013 05:25:01 +0000"  >&lt;p&gt;Attaching patches for that (also pushed to &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/5125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pcmanus/cassandra/commits/5125&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The first part of this ticket is about how we store the information that a clustering key column is indexed. Turns out that for &quot;regular&quot; columns we use ColumnDefinition and the indexing code also assumes that, so the probably best and simplest approach is to reuse ColumnDefinition for that too.  But then it&apos;s easier to always store all primary key columns as ColumnDefinition, pretty much obsoleting the old key_aliases and column_aliases. There is a few related details worth noticing:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;while this obsolete the aliases, those are not removed of the schema by the patch for compatibility sake. Truth is, I&apos;m not sure there is a way to remove a field from the schema without breaking rolling upgrades at this point.&lt;/li&gt;
	&lt;li&gt;after this patch, CFDefinition becomes much less useful as CFMetadata + ColumnDefinition holds pretty much the same information in pretty much the same form. So we could slightly simplify things by removing CFDefinition.  However, this is left to later (this won&apos;t be a 3 lines patch).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;After that, the patch adds a new type of composite indexes to handle indexing clustering keys (which share most code with the existing regular composite index) and update CQL3 to allow adding and querying the new indexes (in particular, it is slighty tricky in SelectStatment to recognize when a clustering key is restricted if 2ndary indexes should be used or not).&lt;/p&gt;

&lt;p&gt;The last patch adds support for indexing components of the partition key (we don&apos;t allow indexing the first component of the partition key as it makes no sense (it&apos;s already primary indexed), but if the partition key is composite, secondary indexing the 2+ parts can be useful).&lt;/p&gt;

&lt;p&gt;Lastly, I&apos;ll note that the patches only add theses news indexes for non compact tables. We should generalize to compact tables too, but that would require a bit of generalization that I&apos;d rather add in a second phase.&lt;/p&gt;</comment>
                            <comment id="13620040" author="slebresne" created="Tue, 2 Apr 2013 17:42:20 +0000"  >&lt;p&gt;Rebased patches attached.&lt;/p&gt;</comment>
                            <comment id="13620729" author="slebresne" created="Wed, 3 Apr 2013 08:31:33 +0000"  >&lt;p&gt;Things move fast on trunk lately, so I&apos;ve pushed a rebased version at &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/5125-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pcmanus/cassandra/commits/5125-2&lt;/a&gt; to avoid rebasing every day.&lt;/p&gt;</comment>
                            <comment id="13621748" author="carlyeks" created="Thu, 4 Apr 2013 04:16:15 +0000"  >&lt;p&gt;A few errors when running the test suite:&lt;/p&gt;

&lt;p&gt;Testcase: testCli(org.apache.cassandra.cli.CliTest):	Caused an ERROR&lt;br/&gt;
java.lang.RuntimeException: org.apache.cassandra.db.marshal.MarshalException: A long is exactly 8 bytes: 4&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1533)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: org.apache.cassandra.db.marshal.MarshalException: A long is exactly 8 bytes: 4&lt;br/&gt;
	at org.apache.cassandra.db.marshal.LongType.getString(LongType.java:69)&lt;br/&gt;
	at org.apache.cassandra.db.index.AbstractSimplePerColumnSecondaryIndex.insert(AbstractSimplePerColumnSecondaryIndex.java:121)&lt;br/&gt;
	at org.apache.cassandra.db.index.SecondaryIndexManager$PerColumnIndexUpdater.update(SecondaryIndexManager.java:623)&lt;br/&gt;
	at org.apache.cassandra.db.AtomicSortedColumns$Holder.addColumn(AtomicSortedColumns.java:313)&lt;br/&gt;
	at org.apache.cassandra.db.AtomicSortedColumns.addAllWithSizeDelta(AtomicSortedColumns.java:168)&lt;br/&gt;
	at org.apache.cassandra.db.Memtable.resolve(Memtable.java:253)&lt;br/&gt;
	at org.apache.cassandra.db.Memtable.put(Memtable.java:169)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:852)&lt;br/&gt;
	at org.apache.cassandra.db.Table.apply(Table.java:379)&lt;br/&gt;
	at org.apache.cassandra.db.Table.apply(Table.java:342)&lt;br/&gt;
	at org.apache.cassandra.db.RowMutation.apply(RowMutation.java:189)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$6.runMayThrow(StorageProxy.java:667)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1529)&lt;br/&gt;
	... 3 more&lt;/p&gt;

&lt;p&gt;Testcase: testIndexDeletions(org.apache.cassandra.db.ColumnFamilyStoreTest):	Caused an ERROR&lt;br/&gt;
A long is exactly 8 bytes: 4&lt;br/&gt;
org.apache.cassandra.db.marshal.MarshalException: A long is exactly 8 bytes: 4&lt;br/&gt;
	at org.apache.cassandra.db.marshal.LongType.getString(LongType.java:69)&lt;br/&gt;
	at org.apache.cassandra.db.index.AbstractSimplePerColumnSecondaryIndex.insert(AbstractSimplePerColumnSecondaryIndex.java:121)&lt;br/&gt;
	at org.apache.cassandra.db.index.SecondaryIndexManager$PerColumnIndexUpdater.update(SecondaryIndexManager.java:623)&lt;br/&gt;
	at org.apache.cassandra.db.AtomicSortedColumns$Holder.addColumn(AtomicSortedColumns.java:313)&lt;br/&gt;
	at org.apache.cassandra.db.AtomicSortedColumns.addAllWithSizeDelta(AtomicSortedColumns.java:168)&lt;br/&gt;
	at org.apache.cassandra.db.Memtable.resolve(Memtable.java:253)&lt;br/&gt;
	at org.apache.cassandra.db.Memtable.put(Memtable.java:169)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:852)&lt;br/&gt;
	at org.apache.cassandra.db.Table.apply(Table.java:379)&lt;br/&gt;
	at org.apache.cassandra.db.Table.apply(Table.java:342)&lt;br/&gt;
	at org.apache.cassandra.db.RowMutation.apply(RowMutation.java:189)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStoreTest.testIndexDeletions(ColumnFamilyStoreTest.java:301)&lt;/p&gt;


&lt;p&gt;Testcase: testIndexUpdate(org.apache.cassandra.db.ColumnFamilyStoreTest):	Caused an ERROR&lt;br/&gt;
Index: 0, Size: 0&lt;br/&gt;
java.lang.IndexOutOfBoundsException: Index: 0, Size: 0&lt;br/&gt;
	at java.util.ArrayList.RangeCheck(ArrayList.java:547)&lt;br/&gt;
	at java.util.ArrayList.get(ArrayList.java:322)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStoreTest.testIndexUpdate(ColumnFamilyStoreTest.java:398)&lt;/p&gt;</comment>
                            <comment id="13621877" author="slebresne" created="Thu, 4 Apr 2013 07:10:32 +0000"  >&lt;p&gt;My bad. That was due to a rebase typo that I had fixed in my &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5417&quot; title=&quot;Push composites support in the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5417&quot;&gt;&lt;del&gt;CASSANDRA-5417&lt;/del&gt;&lt;/a&gt; branch but not on that one. I&apos;ve push the fix to the same github branch than above (&lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/5125-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pcmanus/cassandra/commits/5125-2&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13621970" author="iamaleksey" created="Thu, 4 Apr 2013 09:35:43 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13622481" author="slebresne" created="Thu, 4 Apr 2013 16:33:46 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="14177444" author="denis.angilella" created="Mon, 20 Oct 2014 20:45:47 +0000"  >&lt;p&gt;&lt;cite&gt;Lastly, I&apos;ll note that the patches only add theses news indexes for non compact tables. We should generalize to compact tables too, but that would require a bit of generalization that I&apos;d rather add in a second phase.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;With 2.1 and &lt;b&gt;compact&lt;/b&gt; tables it is possible to CREATE INDEX on composite primary key columns, but queries returns no results for the tests below.&lt;br/&gt;
Adding this comment for now, can open a new ticket if you prefer.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; users2 (
   userID uuid,
   fname &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,
   zip &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,
   &lt;span class=&quot;code-keyword&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,
  &lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt; ((userID, fname))
) &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; COMPACT &lt;span class=&quot;code-keyword&quot;&gt;STORAGE&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INDEX&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; users2 (userID);
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INDEX&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; users2 (fname);

&lt;span class=&quot;code-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INTO&lt;/span&gt; users2 (userID, fname, zip, &lt;span class=&quot;code-keyword&quot;&gt;state&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;VALUES&lt;/span&gt; (b3e3bc33-b237-4b55-9337-3d41de9a5649, &lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;, 10007, &lt;span class=&quot;code-quote&quot;&gt;&apos;NY&apos;&lt;/span&gt;);

// the &lt;span class=&quot;code-keyword&quot;&gt;following&lt;/span&gt; queries &lt;span class=&quot;code-keyword&quot;&gt;returns&lt;/span&gt; 0 &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;instead&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;of&lt;/span&gt; 1 expected
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; users2 &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; fname=&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;; 
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; users2 &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; userid=b3e3bc33-b237-4b55-9337-3d41de9a5649;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; users2 &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; userid=b3e3bc33-b237-4b55-9337-3d41de9a5649 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; fname=&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;;

// dropping 2ndary indexes &lt;span class=&quot;code-keyword&quot;&gt;restore&lt;/span&gt; normal behavior
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14178232" author="slebresne" created="Tue, 21 Oct 2014 10:18:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=denis.angilella&quot; class=&quot;user-hover&quot; rel=&quot;denis.angilella&quot;&gt;denis.angilella&lt;/a&gt; Correct, the validation during index creation is broken. Do you mind creating a ticket indeed so we track the fix?&lt;/p&gt;</comment>
                            <comment id="14178274" author="denis.angilella" created="Tue, 21 Oct 2014 11:07:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;: I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8156&quot; title=&quot;Fix validation of indexes on composite column components of COMPACT tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8156&quot;&gt;&lt;del&gt;CASSANDRA-8156&lt;/del&gt;&lt;/a&gt; to track the fix.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12645855">CASSANDRA-5534</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12602565">CASSANDRA-4511</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12749489">CASSANDRA-8156</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12576611" name="0001-Refactor-aliases-into-column_metadata.txt" size="110568" author="slebresne" created="Tue, 2 Apr 2013 17:42:20 +0000"/>
                            <attachment id="12576612" name="0002-Generalize-CompositeIndex-for-all-column-type.txt" size="54296" author="slebresne" created="Tue, 2 Apr 2013 17:42:20 +0000"/>
                            <attachment id="12576613" name="0003-Handle-new-type-of-IndexExpression.txt" size="40182" author="slebresne" created="Tue, 2 Apr 2013 17:42:20 +0000"/>
                            <attachment id="12576614" name="0004-Handle-partition-key-indexing.txt" size="16859" author="slebresne" created="Tue, 2 Apr 2013 17:42:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302975</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i176wn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250087</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>