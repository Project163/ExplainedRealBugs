<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:19:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16444] Fix flaky test testMultiExpressionQueriesWhereRowSplitBetweenSSTables - org.apache.cassandra.index.sasi.SASIIndexTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16444</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/862/workflows/d2b10373-5bd1-4895-a738-1c28587cae62/jobs/5136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/862/workflows/d2b10373-5bd1-4895-a738-1c28587cae62/jobs/5136&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: []
	at org.apache.cassandra.index.sasi.SASIIndexTest.testMultiExpressionQueriesWhereRowSplitBetweenSSTables(SASIIndexTest.java:589)
	at org.apache.cassandra.index.sasi.SASIIndexTest.testMultiExpressionQueriesWhereRowSplitBetweenSSTables(SASIIndexTest.java:468)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13358396">CASSANDRA-16444</key>
            <summary>Fix flaky test testMultiExpressionQueriesWhereRowSplitBetweenSSTables - org.apache.cassandra.index.sasi.SASIIndexTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adutra">Alexandre Dutra</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Feb 2021 18:29:04 +0000</created>
                <updated>Mon, 8 Mar 2021 11:02:55 +0000</updated>
                            <resolved>Mon, 8 Mar 2021 10:54:23 +0000</resolved>
                                        <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17286034" author="adutra" created="Wed, 17 Feb 2021 18:01:20 +0000"  >&lt;p&gt;I had some time to investigate this morning by running the tests&#160;hundreds of times in a row,&#160;individually and as part of the test class suite. Just in case, here are my findings. In&#160;SASIIndexTest class, we have a few issues actually:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;testMultiExpressionQueriesWhereRowSplitBetweenSSTables: is indeed flaky, when run individually or as part of the test class suite. However it is only flaky for forceFlush = false. I couldn&apos;t make it fail when forceFlush = true.&lt;/li&gt;
	&lt;li&gt;testIndexRedistribution : also flaky,&#160;when run individually or as part of the test class suite.&lt;/li&gt;
	&lt;li&gt;testPagination: also flaky, but only when run as part of the class test suite (it is not flaky when run individually). Note: it is flaky for both forceFlush values.&lt;/li&gt;
	&lt;li&gt;testTruncate : also flaky, but only when run as part of the class test suite (it is not flaky when run individually).&lt;/li&gt;
	&lt;li&gt;testIndexMemtableSwitching: also flaky; seems sensitive to test ordering. Never fails when run individually, but fails 100% of time when run as part of the test class suite on my machine. I couldn&apos;t determine which other test is making this one fail.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Hope that helps.&lt;/p&gt;</comment>
                            <comment id="17290027" author="adutra" created="Wed, 24 Feb 2021 15:43:44 +0000"  >&lt;p&gt;What I&apos;ve got so far:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The usage of &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt; to generate timestamps is error-prone. Some tests create and apply many mutations in sequence, but sometimes 2 successive mutations get the same timestamp, and the test fails. The following tests are potentially impacted by this:
	&lt;ol&gt;
		&lt;li&gt;testCrossSSTableQueries&lt;/li&gt;
		&lt;li&gt;testMultiExpressionQueriesWhereRowSplitBetweenSSTables&lt;/li&gt;
		&lt;li&gt;testPagination&lt;/li&gt;
		&lt;li&gt;testColumnNamesWithSlashes&lt;/li&gt;
		&lt;li&gt;testInvalidate&lt;/li&gt;
		&lt;li&gt;testIndexRedistribution&lt;/li&gt;
		&lt;li&gt;testTruncate&lt;/li&gt;
		&lt;li&gt;testSameKeyInMemtableAndSSTables&lt;/li&gt;
		&lt;li&gt;testUnicodeSupport&lt;/li&gt;
		&lt;li&gt;testUnicodeSuffixModeNoSplits&lt;/li&gt;
		&lt;li&gt;testChinesePrefixSearch&lt;/li&gt;
		&lt;li&gt;testLowerCaseAnalyzer&lt;/li&gt;
		&lt;li&gt;testPrefixSSTableLookup&lt;/li&gt;
		&lt;li&gt;testIndexMemtableSwitching&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;testIndexRedistribution&lt;/tt&gt;: race condition. The test fails when a &lt;tt&gt;CompactionTask&lt;/tt&gt; is running while &lt;tt&gt;getIndexed()&lt;/tt&gt; is called.
	&lt;ol&gt;
		&lt;li&gt;Wrapping&#160;&lt;tt&gt;getIndexed()&lt;/tt&gt;&#160;call within &lt;tt&gt;store.runWithCompactionsDisabled()&lt;/tt&gt; solves the problem.&lt;/li&gt;
		&lt;li&gt;&lt;em&gt;I am not expert enough to tell if this is hiding a broader problem with index redistribution in general.&lt;/em&gt;&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;testIndexMemtableSwitching&lt;/tt&gt;: side-effect issue. The test fails only if &lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt; is executed before:
	&lt;ol&gt;
		&lt;li&gt;&lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt;&#160;leaves the store in an inconsistent state due to an invalid mutation.&lt;/li&gt;
		&lt;li&gt;The next memtable flush task fails because of an invalid cell type created by the test.&lt;/li&gt;
		&lt;li&gt;afaict, the memtable stays forever among the pending memtables list and will never be flushed or removed.&lt;/li&gt;
		&lt;li&gt;Similarly, &lt;tt&gt;ColumnIndex&lt;/tt&gt; never gets a notification that the parent memtable was flushed, and so &lt;tt&gt;ColumnIndex.pendingFlush&lt;/tt&gt;&#160;is never cleared.&lt;/li&gt;
		&lt;li&gt;&lt;tt&gt;testIndexMemtableSwitching&lt;/tt&gt; verifies that&#160;&lt;tt&gt;ColumnIndex.pendingFlush&lt;/tt&gt;&#160;is empty, and fails.&lt;/li&gt;
		&lt;li&gt;&lt;em&gt;I am not expert enough to tell if this is hiding a broader problem with failed memtable flushes.&lt;/em&gt;&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am going to propose 3 distinct patches:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Replace all occurrences of&#160;&lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt;&#160;in &lt;tt&gt;SASIIndexTest&lt;/tt&gt; by fixed timestamps.&lt;/li&gt;
	&lt;li&gt;Fix&#160;&lt;tt&gt;testIndexRedistribution&lt;/tt&gt; by reading the index contents inside &lt;tt&gt;store.runWithCompactionsDisabled()&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;testIndexMemtableSwitching&lt;/tt&gt;: manually clear the store memtables using &lt;tt&gt;store.clearUnsafe()&lt;/tt&gt; and manually clean&#160;&lt;tt&gt;ColumnIndex.pendingFlush&lt;/tt&gt; after &lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt;, so as to leave the store in a consistent state.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17290829" author="adutra" created="Thu, 25 Feb 2021 10:29:03 +0000"  >&lt;p&gt;Update: &lt;tt&gt;testIndexRedistribution&lt;/tt&gt; and &lt;tt&gt;testIndexMemtableSwitching&lt;/tt&gt; are not flaky on trunk afaict. Fixing the timestamps issue on trunk is enough. &lt;/p&gt;</comment>
                            <comment id="17291907" author="adutra" created="Fri, 26 Feb 2021 20:22:16 +0000"  >&lt;p&gt;Please review PR for trunk first.&lt;br/&gt;
PR for 3.11 includes the same fixes + 2 additional commits that are only relevant for 3.11.&lt;/p&gt;</comment>
                            <comment id="17292834" author="blerer" created="Mon, 1 Mar 2021 11:20:05 +0000"  >&lt;p&gt;Thanks for the patches and the deep analysis.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I believe that even if it does not appear as a problem right now we should make the tests more robusts. 2 things that strike me are that the tables are not cleaned up between the tests and that &lt;tt&gt;forcedFlushes&lt;/tt&gt; are used but the tests do not disable the automatic flushes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I would change the &lt;tt&gt;cleanupData&lt;/tt&gt; method into:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void cleanupData()
    {
        stores().forEach(ColumnFamilyStore::truncateBlocking);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Stream&amp;lt;ColumnFamilyStore&amp;gt; stores()
    {
        Keyspace ks = Keyspace.open(KS_NAME);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ks.getMetadata().tables.stream().map(t -&amp;gt; ks.getColumnFamilyStore(t.name));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the &lt;tt&gt;cleanUp&lt;/tt&gt; method into:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Before
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cleanUp()
    {
        cleanupData();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;That would ensure that we clean all the tables between the different tests.&lt;/p&gt;

&lt;p&gt;I would also add &lt;tt&gt;stores().forEach(ColumnFamilyStore::disableAutoCompaction);&lt;/tt&gt; at the end of the &lt;tt&gt;loadSchema()&lt;/tt&gt; method to ensure that there are no race condition with automatic compactions.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Regarding the timestamp fix, would it not make sense to use some thing like:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timestamp = 0;

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; nextTimestamp()
    {
        timestamp += 1000;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; timestamp;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;rather than specifying the timestamp for each call to &lt;tt&gt;loadData&lt;/tt&gt;?&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Regarding &lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt; problem in 3.11, it seems that the test has been changed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15867&quot; title=&quot;Update Jackson version to 2.9.10.1 because there are security issues in 2.9.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15867&quot;&gt;&lt;del&gt;CASSANDRA-15867&lt;/del&gt;&lt;/a&gt; and I am not convinced that this change was the correct one. If you roll back that change, do you still see the same issue?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17293111" author="adelapena" created="Mon, 1 Mar 2021 19:06:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adutra&quot; class=&quot;user-hover&quot; rel=&quot;adutra&quot;&gt;adutra&lt;/a&gt;&#160;this is a nice investigation on the causes of those failures. I&apos;ve run our internal test multiplexer for &lt;tt&gt;SASIIndexTest&lt;/tt&gt; with 200 iterations for the current 3.11 and trunk branches and for each corresponding patch:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;job&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;failed tests&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-3.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/696/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;696&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;testPagination(200), testIndexRedistribution(200), testMultiExpressionQueriesWhereRowSplitBetweenSSTables(1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/697/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;697&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;testMultiExpressionQueriesWhereRowSplitBetweenSSTables(5)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;16444-3.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/698/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;698&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;testTableRebuild(11), testIndexRebuild(11)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;16444-trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/699/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;699&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;testMultiExpressionQueriesWhereRowSplitBetweenSSTables(1)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;So it seems that, if we trust the multiplexer, we still have some flakiness. And, as Benjamin mentioned, &lt;tt&gt;testIndexMemtableSwitching&lt;/tt&gt; doesn&apos;t seem to be failing anymore.&lt;/p&gt;

&lt;p&gt;Also, although it&apos;s not related to the patch, I think that perhaps we could clean here some of the many warnings in &lt;tt&gt;SASIIndexTest&lt;/tt&gt;. The most frequent ones are unneeded uses of &lt;tt&gt;throws Exception&lt;/tt&gt; and many calls of the form:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Assert.assertTrue(rows.toString(), Arrays.equals(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] { &lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key3&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key4&quot;&lt;/span&gt; }, rows.toArray(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[rows.size()])));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;These could be simplified if we added a simple utility method like, for example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
assertRows(rows, &lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key3&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;key4&quot;&lt;/span&gt;);
...
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void assertRows(Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; actual, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;... expected)
{
    Assert.assertArrayEquals(expected, Iterables.toArray(actual, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Not sure whether introducing these changes would be too distracting but I think they would easily increase the readability of the test class. I gave it a quick go &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/7b6d460b63c48636d907e48e40fe1b64d8687ddc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17293598" author="blerer" created="Tue, 2 Mar 2021 10:28:04 +0000"  >&lt;p&gt;I had a look to the failing tests: &lt;tt&gt;testTableRebuild&lt;/tt&gt;, &lt;tt&gt;testIndexRebuild&lt;/tt&gt;. They both use the &lt;tt&gt;CLUSTERING_CF_NAME_1&lt;/tt&gt; table which is not cleaned between the tests.&lt;br/&gt;
I would suggest to add the improvements I proposed and re-run the multiplexer tests.&lt;/p&gt;</comment>
                            <comment id="17293716" author="adelapena" created="Tue, 2 Mar 2021 13:38:32 +0000"  >&lt;p&gt;Makes sense, I have started the multiplexer&#160;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/700/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for &lt;a href=&quot;https://github.com/adutra/cassandra/compare/16444-3.11...adelapena:16444-3.11-review&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a 3.11-based branch&lt;/a&gt; with the &lt;tt&gt;cleanupData&lt;/tt&gt; and &lt;tt&gt;timestamp&lt;/tt&gt; suggestions. It should be finished in ~2h.&lt;/p&gt;</comment>
                            <comment id="17293725" author="adutra" created="Tue, 2 Mar 2021 13:51:25 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; for the thorough reviews.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I would change the cleanupData method&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Very good suggestion, done on both PRs.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I would also add stores().forEach(ColumnFamilyStore::disableAutoCompaction); at the end of the loadSchema() method&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done on both PRs.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;forcedFlushes are used but the tests do not disable the automatic flushes&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;How would you do this? Should I play with &lt;tt&gt;memtable_flush_period_in_ms&lt;/tt&gt; when creating the tables?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Regarding testIndexMemtableSwitching problem in 3.11, it seems that the test has been changed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15867&quot; title=&quot;Update Jackson version to 2.9.10.1 because there are security issues in 2.9.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15867&quot;&gt;&lt;del&gt;CASSANDRA-15867&lt;/del&gt;&lt;/a&gt; and I am not convinced that this change was the correct one. If you roll back that change, do you still see the same issue?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will try that next and let you know.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Regarding the timestamp fix, would it not make sense to use some thing like rather than specifying the timestamp for each call to loadData?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I actually have a slight preference for fixed timestamps as they produce deterministic results. Using a counter means that you don&apos;t really control which timestamps are being used. Besides, at least one test requires very specific timestamps or it fails: &lt;tt&gt;testTruncate&lt;/tt&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think that perhaps we could clean here some of the many warnings in SASIIndexTest.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Absolutely, I cherry-picked your commit on both PRs and indeed the test class looks much better.&lt;/p&gt;

&lt;p&gt;At this point, I suggest that we re-run the multiplexer and see if at least &lt;tt&gt;testTableRebuild&lt;/tt&gt; and &lt;tt&gt;testIndexRebuild&lt;/tt&gt; are fixed.&lt;/p&gt;</comment>
                            <comment id="17293772" author="adutra" created="Tue, 2 Mar 2021 15:23:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; I investigated the change introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15867&quot; title=&quot;Update Jackson version to 2.9.10.1 because there are security issues in 2.9.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15867&quot;&gt;&lt;del&gt;CASSANDRA-15867&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In fact, this change simply fixed a test that was failing for a while.&lt;/p&gt;

&lt;p&gt;Doing a git bisect, I found that the commit that introduced the test regression is in fact&#160;c4064dd: &lt;a href=&quot;https://github.com/apache/cassandra/commit/c4064dd80e427aec7c04e8e2e1e4630d6c8087b6#diff-0e5a142c13247885605175ace136c549391fb6c778877f91f589fd94131c241b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Allow recovery from the cases when CQL-created compact sense tables have bytes in EmptyType columns&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This change introduced an assertion inside &lt;tt&gt;AbstractType.writeValue()&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; valueLengthIfFixed &amp;lt; 0 || value.remaining() == valueLengthIfFixed : &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected exactly %d bytes, but was %d&quot;&lt;/span&gt;,
                                                                                                 valueLengthIfFixed, value.remaining());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Without the assert, the incorrect 8-bytes value created by &lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt;&#160;gets written; with the assertion, it doesn&apos;t, and the &lt;tt&gt;AssertionError&lt;/tt&gt; bubbles up, messing up the store state. The author of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15867&quot; title=&quot;Update Jackson version to 2.9.10.1 because there are security issues in 2.9.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15867&quot;&gt;&lt;del&gt;CASSANDRA-15867&lt;/del&gt;&lt;/a&gt; simply added a try-catch block around the test to avoid the test failure. But I wonder if we shouldn&apos;t simply disable this test, since it violates an invariant expressed by the new assertion.&lt;/p&gt;

&lt;p&gt;Oddly enough, this assertion was not ported to trunk, which basically conserved the pre-c4064dd behavior. This is why this test (&lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt;) is not dangerous on trunk: it passes normally and doesn&apos;t leave the store in an inconsistent state; therefore it doesn&apos;t need a try-catch block nor any ugly band-aid to fix the store state.&lt;/p&gt;</comment>
                            <comment id="17293783" author="blerer" created="Tue, 2 Mar 2021 15:40:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;forcedFlushes are used but the tests do not disable the automatic flushes&lt;/p&gt;

&lt;p&gt;&#160;How would you do this? Should I play with memtable_flush_period_in_ms when creating the tables&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ignore my comment. I think I mixed up several things in my mind when I wrote that comment. By default flushes are not triggered periodically.&lt;br/&gt;
 Sorry for that.&lt;/p&gt;</comment>
                            <comment id="17293847" author="blerer" created="Tue, 2 Mar 2021 17:10:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adutra&quot; class=&quot;user-hover&quot; rel=&quot;adutra&quot;&gt;adutra&lt;/a&gt; &lt;tt&gt;testInsertingIncorrectValuesIntoAgeIndex&lt;/tt&gt; is a pretty strange test to me. In my opinion we can remove it. &lt;/p&gt;</comment>
                            <comment id="17294501" author="adutra" created="Wed, 3 Mar 2021 12:27:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;testInsertingIncorrectValuesIntoAgeIndex is a pretty strange test to me. In my opinion we can remove it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, done.&lt;/p&gt;

&lt;p&gt;Also, we have 2 green builds with the multiplexer:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/701/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16444-trunk&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/702/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16444-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So it seems that with Benjamin&apos;s suggestions we finally got rid of all the flakiness.&lt;/p&gt;</comment>
                            <comment id="17294539" author="blerer" created="Wed, 3 Mar 2021 13:53:45 +0000"  >&lt;p&gt;+1 Thanks for the patches &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adutra&quot; class=&quot;user-hover&quot; rel=&quot;adutra&quot;&gt;adutra&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17294692" author="adelapena" created="Wed, 3 Mar 2021 17:42:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Regarding the timestamp fix, would it not make sense to use some thing like rather than specifying the timestamp for each call to loadData?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I actually have a slight preference for fixed timestamps as they produce deterministic results. Using a counter means that you don&apos;t really control which timestamps are being used. Besides, at least one test requires very specific timestamps or it fails:&#160;&lt;tt&gt;testTruncate&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I liked the idea of increasing the timestamp inside of &lt;tt&gt;loadData&lt;/tt&gt;. I think that, given that the tests are not run in parallel, that automatically increased timestamp would also be deterministic. As for the special case of &lt;tt&gt;testTruncate&lt;/tt&gt; we can use the current behaviour overloading &lt;tt&gt;loadData&lt;/tt&gt;. Also I think there is no need to use seconds, we can increase the timestamps one by one with a precision of milliseconds. I gave it a go &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/fbcef9b9e0bd81a9101682e8bd1ffabe776cba5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Nevertheless this is just a detail so feel free to ignore if you don&apos;t agree.&lt;/p&gt;

&lt;p&gt;Other than this nit, the changes look good to me, it&apos;s nice to see this test finally fixed.&lt;/p&gt;</comment>
                            <comment id="17294708" author="adutra" created="Wed, 3 Mar 2021 18:02:18 +0000"  >&lt;p&gt;Fair enough, I cherry-picked your commits on both branches. I also started two more multiplexer builds, just in case.&lt;/p&gt;

&lt;p&gt;Unrelated: regarding the assertion that was introduced in 3.11:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Oddly enough, this assertion was not ported to trunk, which basically conserved the pre-c4064dd behavior.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do we need to worry about it? From my (admittedly novice) standpoint, it seems that AbstractType has stricter validation rules in 3.11 than in 4.0...&lt;/p&gt;</comment>
                            <comment id="17295135" author="blerer" created="Thu, 4 Mar 2021 10:02:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we need to worry about it? From my (admittedly novice) standpoint, it seems that AbstractType has stricter validation rules in 3.11 than in 4.0...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;According to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15778?focusedCommentId=17117827&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17117827&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment&lt;/a&gt; the validation was only added because he believe that the new code could trigger this path.&lt;/p&gt;

&lt;p&gt;In my opinion the validation make sense anyway so it might be good to put it also in 4.0. I would just use some proper IOException like in &lt;tt&gt;readValue&lt;/tt&gt; rather than assertions.   &lt;/p&gt;</comment>
                            <comment id="17297260" author="blerer" created="Mon, 8 Mar 2021 10:54:23 +0000"  >&lt;p&gt;Committed into cassandra-3.11 at e3902bcdad79dcef43562a075d6a130c6a77d63d and merged into trunk&lt;/p&gt;</comment>
                            <comment id="17297265" author="blerer" created="Mon, 8 Mar 2021 11:02:55 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adutra&quot; class=&quot;user-hover&quot; rel=&quot;adutra&quot;&gt;adutra&lt;/a&gt;. I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16500&quot; title=&quot;Missing validation in AbstractType.writeValue():&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16500&quot;&gt;&lt;del&gt;CASSANDRA-16500&lt;/del&gt;&lt;/a&gt; to address the missing validation issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13352616">CASSANDRA-16390</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13283339">CASSANDRA-15544</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13281509">CASSANDRA-15526</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13281510">CASSANDRA-15527</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13281511">CASSANDRA-15528</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13312219">CASSANDRA-15881</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13319859">CASSANDRA-15995</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13319013">CASSANDRA-15974</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adutra]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nn0g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334622">3.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/e3902bcdad79dcef43562a075d6a130c6a77d63d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/e3902bcdad79dcef43562a075d6a130c6a77d63d&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/adutra/cassandra/pull/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR for trunk&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/adutra/cassandra/pull/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR for 3.11 branch&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>