<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9554] Avoid digest mismatch storm on upgrade to 3.0</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9554</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt;, in &lt;tt&gt;UnfilteredRowIterators.digest()&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// TODO: we&apos;re not computing digest the same way that old nodes. This
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// means we&apos;ll have digest mismatches during upgrade. We should pass the messaging version of
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// the node &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (which might mean computing the digest last, and won&apos;t work
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; schema (where we announce the version through gossip to everyone))&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In a mixed 2.1(2.2) - 3.0 clusters, we need to calculate both digest at the same time and keep both results, and send the appropriate one, depending on receiving nodes&apos; messaging versions. Do that until &lt;tt&gt;MessagingService.allNodesAtLeast30()&lt;/tt&gt; is true (this is not unprecedented).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12835710">CASSANDRA-9554</key>
            <summary>Avoid digest mismatch storm on upgrade to 3.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                            <label>upgrade</label>
                    </labels>
                <created>Fri, 5 Jun 2015 13:07:07 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:08 +0000</updated>
                            <resolved>Tue, 1 Sep 2015 08:55:21 +0000</resolved>
                                        <fixVersion>3.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14640524" author="slebresne" created="Fri, 24 Jul 2015 14:53:49 +0000"  >&lt;p&gt;For info, I started &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a branch&lt;/a&gt; for that but won&apos;t have time to finish it in the coming weeks. It&apos;s compiling and should contain the gist of the issue but it&apos;s entirely untested. So attaching the branch so that if someone else wants to finish this, he has something to start with.&lt;/p&gt;</comment>
                            <comment id="14662276" author="thobbs" created="Fri, 7 Aug 2015 19:02:47 +0000"  >&lt;p&gt;Reassigning to Sylvain for now.&lt;/p&gt;</comment>
                            <comment id="14701389" author="slebresne" created="Tue, 18 Aug 2015 14:55:17 +0000"  >&lt;p&gt;I&apos;ve rebased the patch on &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;my branch&lt;/a&gt; (CI: &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-9554-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-9554-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; - no new failure that I can see). I did manually tested it this time (by adding new log messages on mismatch and manually validating that we had mismatch without the patch on update but not with the patch) and it appears to work as expected.&lt;/p&gt;

&lt;p&gt;We should make that automated dtests however and I think we can do that by using tracing since mismatches are sent in traces. That said, I&apos;m not all that familiar with the python driver so I haven&apos;t dug into how to read traces yet, and besides, I&apos;m not sure what&apos;s our usual way to deal with upgrade tests so they play well with cassci. Maybe some test engineer that is more familiar with all this has a few cycles to write proper automated dtests for this? (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt;?)&lt;/p&gt;

&lt;p&gt;Anyway, in the meantime, the code is actually ready for review.&lt;/p&gt;</comment>
                            <comment id="14701447" author="enigmacurry" created="Tue, 18 Aug 2015 15:41:13 +0000"  >&lt;p&gt;We have some dtest code that exemplifies how to read from traces here :&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/blob/master/replication_test.py#L49-L109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/blob/master/replication_test.py#L49-L109&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt; will handle this in dtests&lt;/p&gt;</comment>
                            <comment id="14712165" author="jbellis" created="Tue, 25 Aug 2015 23:17:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14716313" author="blambov" created="Thu, 27 Aug 2015 09:00:21 +0000"  >&lt;p&gt;Patch looks good, but apart from dtests I&apos;d like to see at least some minimal unit testing:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a version of &lt;tt&gt;PartitionTest.testDigest&lt;/tt&gt; for pre-3.0 version,&lt;/li&gt;
	&lt;li&gt;as the old digest will not change in the future, something that compares the result of calling digest with old version parameter to a precomputed value. We shouldn&apos;t need to go to dtests to catch trivial regressions in the calculation.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14723540" author="slebresne" created="Mon, 31 Aug 2015 15:24:03 +0000"  >&lt;p&gt;You&apos;re right of course.&lt;/p&gt;

&lt;p&gt;I&apos;ve push a few additional commits on &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;my branch&lt;/a&gt;. It makes &lt;tt&gt;PartitionTest.testDigest&lt;/tt&gt; run on the legacy format (even though that test isn&apos;t all that useful) and more importantly adds backward compatibility tests against values computed on 2.2 as suggested. There is also 3 other &quot;fix&quot; commits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the first one remove the &quot;local deletion time&quot; from the digest computation on 3.0 nodes. This one isn&apos;t really a bug nor a problem for backward compatibility, but as the name implies, the &quot;local deletion time&quot; is meant to be a local information (even though it&apos;s in practice assigned by the coordinator and thus common to all replica, and that&apos;s why this wasn&apos;t a problem) and if &quot;feels&quot; better to not use it in digests.  This is also more consistent with the old way to during things (we don&apos;t include it in pre-3.0 digets).&lt;/li&gt;
	&lt;li&gt;the second one makes it so that deletion of a row on a compact table is done through the insertion of a cell tombstone. As explained by the comment in the commit, that&apos;s more consistent with the old way of doing this, and is easier than to deal with that in both thrift and the backward compatibility code (which we weren&apos;t doing properly).&lt;/li&gt;
	&lt;li&gt;the thirft one fix minor errors in the legacy digest computation.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CI tests are ongoing but will be at &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-9554-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-9554-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14723641" author="blambov" created="Mon, 31 Aug 2015 16:31:29 +0000"  >&lt;p&gt;Thank you, the new test looks great.&lt;/p&gt;

&lt;p&gt;Nit in &lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/e0699a4451980d1b568e3e0ec960851b7d58ad4c#diff-79b0ff76cc67b62a0d7947248e60c379R152&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the addRowDeletion comment&lt;/a&gt;: s/use to/used to/&lt;/p&gt;

&lt;p&gt;+1, commit when cassci&apos;s happy.&lt;/p&gt;</comment>
                            <comment id="14725005" author="slebresne" created="Tue, 1 Sep 2015 08:55:21 +0000"  >&lt;p&gt;Cassci looks happy (as in, no specific dtest failure that doesn&apos;t happen on the cassandra-3.0 branch) so committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2foif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rhatch</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>