<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13337] Dropping column results in &quot;corrupt&quot; SSTable</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13337</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It seems like dropping a column can make SSTables containing rows with writes to only the dropped column will become uncompactable.&lt;/p&gt;

&lt;p&gt;Also Cassandra &amp;lt;= 3.9 and &amp;lt;= 3.0.11 will even refuse to start with the same stack trace&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh -e &lt;span class=&quot;code-quote&quot;&gt;&quot;create keyspace test with replication = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : 1 }&quot;&lt;/span&gt;
cqlsh -e &lt;span class=&quot;code-quote&quot;&gt;&quot;create table test.test(pk text primary key, x text, y text)&quot;&lt;/span&gt;

cqlsh -e &lt;span class=&quot;code-quote&quot;&gt;&quot;update test.test set x=&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; where pk=&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;&quot;&lt;/span&gt;
nodetool flush

cqlsh -e &lt;span class=&quot;code-quote&quot;&gt;&quot;update test.test set x=&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;, y=&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; where pk=&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;&quot;&lt;/span&gt;
nodetool flush
cqlsh -e &lt;span class=&quot;code-quote&quot;&gt;&quot;alter table test.test drop x&quot;&lt;/span&gt;

nodetool compact test test
error: Corrupt empty row found in unfiltered partition
-- StackTrace --
java.io.IOException: Corrupt empty row found in unfiltered partition
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserialize(UnfilteredSerializer.java:382)
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$CurrentFormatIterator.computeNext(SSTableSimpleIterator.java:87)
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$CurrentFormatIterator.computeNext(SSTableSimpleIterator.java:65)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.doCompute(SSTableIdentityIterator.java:123)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.computeNext(SSTableIdentityIterator.java:100)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.computeNext(SSTableIdentityIterator.java:30)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95)
	at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:369)
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:189)
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:158)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:509)
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:369)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129)
	at org.apache.cassandra.db.transform.UnfilteredRows.isEmpty(UnfilteredRows.java:58)
	at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:67)
	at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:26)
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:96)
	at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:227)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:190)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:89)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:61)
	at org.apache.cassandra.db.compaction.CompactionManager$8.runMayThrow(CompactionManager.java:610)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13056599">CASSANDRA-13337</key>
            <summary>Dropping column results in &quot;corrupt&quot; SSTable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jborgstrom">Jonas Borgstr&#246;m</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Mar 2017 09:43:03 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:08 +0000</updated>
                            <resolved>Mon, 27 Mar 2017 10:05:14 +0000</resolved>
                                        <fixVersion>3.0.13</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15932823" author="slebresne" created="Mon, 20 Mar 2017 15:25:19 +0000"  >&lt;p&gt;This is definitively wrong, attaching patch for fix (including an unit test to reproduce).&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/13337-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13337-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13337-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13337-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/13337-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13337-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13337-3.11-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13337-3.11-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;ll note that the patch basically disable the error message seen here, instead simply ignoring empty rows from disk since they can happen. I suppose it would be possible to do a more involved checking to make sure we didn&apos;t wrote something actually empty, but I&apos;m not sure at all it&apos;s worth the trouble (not the cost of that check on a pretty hot path) especially given that expecting non-empty rows was wrong no only due to dropping, but also because we can actually skip columns due to the &lt;tt&gt;ColumnFilter&lt;/tt&gt; within &lt;tt&gt;SerializationHelper&lt;/tt&gt;. I believe the latter would only potentially impact thrift queries, which may be why nobody as yet reported that problem, but it&apos;s still wrong.&lt;/p&gt;</comment>
                            <comment id="15933059" author="ifesdjeen" created="Mon, 20 Mar 2017 16:58:43 +0000"  >&lt;p&gt;There&apos;s another way to reproduce the same issue with slightly different steps:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE IF NOT EXISTS &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt; WITH REPLICATION = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.locator.SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1 };

CREATE TABLE IF NOT EXISTS &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;reproduce&quot;&lt;/span&gt; (pk1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ck1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v3 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v4 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v5 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY(pk1, ck1));

UPDATE &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;reproduce&quot;&lt;/span&gt; SET v2 = 1, v3 = 3, v4 = 4 WHERE pk1 = 1 AND ck1 = 0;

ALTER TABLE &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;reproduce&quot;&lt;/span&gt; DROP v2;
ALTER TABLE &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;reproduce&quot;&lt;/span&gt; DROP v3;
ALTER TABLE &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;reproduce&quot;&lt;/span&gt; DROP v4;

SELECT * FROM test.reproduce;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But essentially the problem is that we do return empty rows from local storage. For example, when &lt;tt&gt;UPDATE&lt;/tt&gt; was used to set only a subset of rows, then the rows that were used in &lt;tt&gt;UPDATE&lt;/tt&gt; get dropped. When trying to query, we end up with an empty row. This wouldn&apos;t happen with &lt;tt&gt;INSERT&lt;/tt&gt; since for &lt;tt&gt;INSERT&lt;/tt&gt; we have liveness set.&lt;/p&gt;

&lt;p&gt;I just see a single small problem: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s(k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, y &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE %s SET x = 1 WHERE k = 0&quot;&lt;/span&gt;);
        flush(doFlush); &lt;span class=&quot;code-comment&quot;&gt;// (1)
&lt;/span&gt;        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE %s DROP x&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we do flush at point &lt;tt&gt;1&lt;/tt&gt;, we will end up with a single row &lt;tt&gt;row(1, null)&lt;/tt&gt;. However, if we do not do flush and query directly from memtable, we end up with an empty result.&lt;/p&gt;</comment>
                            <comment id="15934453" author="slebresne" created="Tue, 21 Mar 2017 11:04:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;I just see a single small problem&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, that is wrong. And that&apos;s because while compaction uses &lt;tt&gt;UnfilteredSerializer.deserialize()&lt;/tt&gt; which the first patch changes, &lt;tt&gt;SSTableIterator/SSTableReversedIterator&lt;/tt&gt; which are used by queries do not, it uses &lt;tt&gt;UnfilteredDeserializer&lt;/tt&gt; (which is more lazy). Pushed an additional patch that fix that part (unfortunately, due to how &lt;tt&gt;UnfilteredDesializer&lt;/tt&gt; works, we can&apos;t easily handle this within &lt;tt&gt;UnfilteredDeserializer&lt;/tt&gt; itself; still not terribly hard to handle properly).&lt;/p&gt;</comment>
                            <comment id="15940589" author="ifesdjeen" created="Fri, 24 Mar 2017 15:44:26 +0000"  >&lt;p&gt;Sorry for the delay, I have somehow missed the notification. &lt;br/&gt;
The new patch looks great, thanks for taking care of it!&lt;/p&gt;

&lt;p&gt;+1 &lt;/p&gt;</comment>
                            <comment id="15942982" author="slebresne" created="Mon, 27 Mar 2017 10:05:14 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ccun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339652">3.0.12</customfieldvalue>
    <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ifesdjeen</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>