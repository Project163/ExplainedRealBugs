<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15499] Internode message builder does not add trace header</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15499</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The messages built with the &lt;tt&gt;Builder&lt;/tt&gt; (&lt;tt&gt;org.apache.cassandra.net.Message.Builder&lt;/tt&gt;) do not have the trace header when tracing is enabled. &lt;br/&gt;
Consequently, no tracing session gets propagated to other nodes, and the tracing function is broken. &lt;/p&gt;

&lt;p&gt;The set of static &lt;tt&gt;out*&lt;/tt&gt; methods provided (to create an out-bounding message) in Message do not have the issue. They can properly add the trace header when necessary. &lt;br/&gt;
To be clear, only the &lt;tt&gt;Builder&lt;/tt&gt; missed adding the tracing header and it should be fixed to be consistent with the &lt;tt&gt;out*&lt;/tt&gt; methods.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13278947">CASSANDRA-15499</key>
            <summary>Internode message builder does not add trace header</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yifanc">Yifan Cai</assignee>
                                    <reporter username="yifanc">Yifan Cai</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 12 Jan 2020 19:04:22 +0000</created>
                <updated>Mon, 21 Dec 2020 08:08:26 +0000</updated>
                            <resolved>Wed, 22 Jan 2020 18:19:40 +0000</resolved>
                                        <fixVersion>4.0-alpha3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Messaging/Internode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17013903" author="yifanc" created="Sun, 12 Jan 2020 22:05:52 +0000"  >&lt;p&gt;The code change is minor. Trace headers are added when tracing is on and no trace headers are present.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;, &lt;a href=&quot;https://github.com/yifan-c/cassandra/tree/CASSANDRA-15499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Code&lt;/a&gt;&#160;and&#160;&lt;a href=&quot;https://app.circleci.com/github/yifan-c/cassandra/pipelines/3df93bc8-f10e-44bc-884f-767da032a862/workflows/6ee3bd5c-98a1-44f0-9889-21a1ec77bebd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Test&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17014640" author="yifanc" created="Mon, 13 Jan 2020 20:30:45 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; since the change is applied to &lt;tt&gt;Message&lt;/tt&gt;, which is part of the patch of internode messaging refactor. &lt;/p&gt;</comment>
                            <comment id="17014642" author="dcapwell" created="Mon, 13 Jan 2020 20:32:04 +0000"  >&lt;p&gt;starting review now. &#160;At first glance the code looks fine, so starting with testing it.&lt;/p&gt;</comment>
                            <comment id="17014656" author="yifanc" created="Mon, 13 Jan 2020 21:15:28 +0000"  >&lt;p&gt;To add more context, I am working on the other &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2848&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;patch&lt;/a&gt; that makes more messages being created with the Builder and the &lt;tt&gt;org.apache.cassandra.distributed.test.MessageForwardingTest&lt;/tt&gt; that checks the tracing history fails.&lt;/p&gt;</comment>
                            <comment id="17014657" author="dcapwell" created="Mon, 13 Jan 2020 21:15:43 +0000"  >&lt;p&gt;Based off trunk, build() is only called in a special case (forwardTo with mixed ids) so not a common bug, but will be as more usages of build() pop up.&lt;/p&gt;

&lt;p&gt;Looking at other call sites for new Message, I see the below are also missing tracing&lt;/p&gt;

&lt;p&gt;org.apache.cassandra.net.Message.Serializer#toPre40FailureResponse and&lt;br/&gt;
org.apache.cassandra.net.Message.Serializer#toPost40FailureResponse&lt;/p&gt;

&lt;p&gt;The patch looks to improve build, but I wonder if the failure response methods should also be updated (my instinct is yes, but would like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; feedback)?&lt;/p&gt;</comment>
                            <comment id="17016149" author="yifanc" created="Wed, 15 Jan 2020 16:50:32 +0000"  >&lt;p&gt;The message serializer should be good.&lt;/p&gt;

&lt;p&gt;Tracing headers are placed in the&#160;&lt;tt&gt;params&lt;/tt&gt;. Both &lt;tt&gt;toPre40FailureResponse&lt;/tt&gt; and &lt;tt&gt;toPost40FailureResponse&lt;/tt&gt; copy the &lt;tt&gt;params&lt;/tt&gt; and any existing trace headers fields should been copied.&lt;/p&gt;</comment>
                            <comment id="17016193" author="iamaleksey" created="Wed, 15 Jan 2020 18:14:52 +0000"  >&lt;p&gt;The code looks fine, but conceptually I would prefer it to be the responsibility of &lt;tt&gt;withParams()&lt;/tt&gt; caller to build the correct map, and not have &lt;tt&gt;build()&lt;/tt&gt; reach out to global state to set it implicitly if avoidable. Add a helper for other callers if needed?&lt;/p&gt;</comment>
                            <comment id="17016203" author="yifanc" created="Wed, 15 Jan 2020 18:25:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;Agree that&#160;&lt;tt&gt;withParams()&lt;/tt&gt; is the intended way to add the trace headers and other fields, especially after seeing the unit test cases. However, I feel it is quite easy to forget adding the trace headers, and the logic of check and add is applicable to all outing messages. It, in certain degree, becomes an intrinsic step of building a message. Does it sound a valid argument?&lt;/p&gt;

&lt;p&gt;Regarding helper, probably adding a method in the builder, say &lt;tt&gt;withTracingMaybe(tracing: Tracing)&lt;/tt&gt;, if the above does not sound good. And call this method for building every message...&lt;/p&gt;</comment>
                            <comment id="17016940" author="iamaleksey" created="Thu, 16 Jan 2020 13:42:23 +0000"  >&lt;p&gt;It would help if you showed the code from your other upcoming patch. The general idea is/was that for out messages you should be using a variant of &lt;tt&gt;Message#out*&lt;/tt&gt; methods, which all add the header for you.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160;In that scenario (forwardTo with mixed ids), the original tracing headers are preserved when the builder copied params field from the original message which has them, so there is no bug currently.&lt;/p&gt;</comment>
                            <comment id="17017058" author="dcapwell" created="Thu, 16 Jan 2020 15:57:33 +0000"  >&lt;p&gt;Thanks for the details&lt;/p&gt;</comment>
                            <comment id="17017069" author="yifanc" created="Thu, 16 Jan 2020 16:06:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;Message#out*&lt;/tt&gt; methods are good and it was stated in the ticket description. However, those 2 message creation approaches are inconsistent. So this patch aims to close the gap. &lt;/p&gt;

&lt;p&gt;What is the desired usage of using the &lt;tt&gt;Message.Builder&lt;/tt&gt;? I feel having 2 implementations of message creation can have problem in maintaining the code. To me, using &lt;tt&gt;Message.Builder&lt;/tt&gt; gives more flexibility. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It would help if you showed the code from your other upcoming patch.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Attaching the link to the &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...yifan-c:CASSANDRA-2848-per-request-timeout&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; to see it helps to give more context. &lt;b&gt;Discussion about the attached patch does not fit the topic of this ticket.&lt;/b&gt; The patch involves a lot of changes. Please search for &quot;Message.Builder&quot; to see the usage of it. In short, builder is used to adjust the message expiration time since the query is allowed accept custom timeout value. &lt;/p&gt;</comment>
                            <comment id="17021224" author="yifanc" created="Wed, 22 Jan 2020 15:58:50 +0000"  >&lt;p&gt;The patch was updated to having a method to add tracing params explicitly.&#160;&lt;/p&gt;</comment>
                            <comment id="17021248" author="iamaleksey" created="Wed, 22 Jan 2020 16:26:31 +0000"  >&lt;p&gt;+1 from me. When and if David approves, I&apos;ll commit for you guys.&lt;/p&gt;</comment>
                            <comment id="17021326" author="dcapwell" created="Wed, 22 Jan 2020 17:59:35 +0000"  >&lt;p&gt;Looking now.&lt;/p&gt;</comment>
                            <comment id="17021328" author="dcapwell" created="Wed, 22 Jan 2020 18:00:57 +0000"  >&lt;p&gt;LGTM +1&lt;/p&gt;</comment>
                            <comment id="17021353" author="iamaleksey" created="Wed, 22 Jan 2020 18:19:11 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/0e3a90698a94772e57df39e7461efe6b7e09d678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;0e3a90698a94772e57df39e7461efe6b7e09d678&lt;/a&gt;, cheers.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12512655">CASSANDRA-2848</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yifanc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0afc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/0e3a90698a94772e57df39e7461efe6b7e09d678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/0e3a90698a94772e57df39e7461efe6b7e09d678&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Unit test and circleCI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>