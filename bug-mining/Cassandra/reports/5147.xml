<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14922] In JVM dtests need to clean up after instance shutdown</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14922</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently the unit tests are failing on circleci (&lt;a href=&quot;https://circleci.com/gh/jolynch/cassandra/300#tests/containers/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;example one&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/rustyrazorblade/cassandra/44#tests/containers/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;example two&lt;/a&gt;)&#160;because we use a small container (medium) for unit tests by default and the in JVM dtests are leaking a few hundred megabytes of memory per test right now. This is not a big deal because the dtest runs with the larger containers continue to function fine as well as local testing as the number of in JVM dtests is not yet high enough to cause a problem with more than 2GB of available heap. However we should fix the memory leak so that going forwards we can add more in JVM dtests without worry.&lt;/p&gt;

&lt;p&gt;I&apos;ve been working with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; to debug, and the issue appears to be unreleased Table/Keyspace metrics (screenshot showing the leak attached). I believe that we have&#160;a few potential issues that are leading to the leaks:&lt;/p&gt;

&lt;p&gt;1. The&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/f22fec927de7ac291266660c2f34de5b8cc1c695/test/distributed/org/apache/cassandra/distributed/Instance.java#L328-L354&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Instance::shutdown&lt;/tt&gt;&lt;/a&gt; method is not successfully cleaning up all the metrics created by the &lt;tt&gt;CassandraMetricsRegistry&lt;/tt&gt;&lt;br/&gt;
 2. The &lt;a href=&quot;https://github.com/apache/cassandra/blob/f22fec927de7ac291266660c2f34de5b8cc1c695/test/distributed/org/apache/cassandra/distributed/TestCluster.java#L283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;TestCluster::close&lt;/tt&gt;&lt;/a&gt; method is not waiting for all the instances to finish shutting down and cleaning up before continuing on&lt;br/&gt;
3. I&apos;m not sure if this is an issue assuming we clear all metrics, but &lt;a href=&quot;https://github.com/apache/cassandra/blob/4ae229f5cd270c2b43475b3f752a7b228de260ea/src/java/org/apache/cassandra/metrics/TableMetrics.java#L951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;TableMetrics::release&lt;/tt&gt;&lt;/a&gt; does not release all the metric references (which could leak them)&lt;/p&gt;

&lt;p&gt;I am working on a patch which shuts down everything and assures that we do not leak memory.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13202340">CASSANDRA-14922</key>
            <summary>In JVM dtests need to clean up after instance shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jolynch">Joey Lynch</assignee>
                                    <reporter username="jolynch">Joey Lynch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Dec 2018 18:29:19 +0000</created>
                <updated>Thu, 27 Aug 2020 15:14:00 +0000</updated>
                            <resolved>Wed, 9 Jan 2019 14:07:04 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16709185" author="ifesdjeen" created="Tue, 4 Dec 2018 19:41:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; thank you for reporting it and investing time to fix it! Great investigation, looking forward to see the full patch!&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;close&lt;/tt&gt; is not waiting for full instance shutdown (same as instance shutdown does not wait for executor shutdown) wasn&apos;t an oversight. It makes shutdown significantly faster and allows shutting down a cluster much quicker. &lt;/p&gt;

&lt;p&gt;I do agree we should fix leaks and make sure things shutdown properly and we definitely have to do what we can to make it happen. But I also think we should keep it performant. If there&apos;s no way and clusters churn quicker than we can shutdown them, we can make a switch. &lt;/p&gt;

&lt;p&gt;Another thing we might want to consider is reusing cluster instance for multiple tests as I think this will most frequently be the case. We can make it in a follow-up ticket, since it is, however helpful, also orthogonal. &lt;/p&gt;</comment>
                            <comment id="16709389" author="jolynch" created="Tue, 4 Dec 2018 23:23:57 +0000"  >&lt;p&gt;Definitely have to keep the shutdown fast, I think we just have a deadlock or something like that in the cleanups where we&apos;re not actually cleaning up. I tried adding in &lt;tt&gt;Keyspace::clear&lt;/tt&gt; calls in the shutdown hook but that deadlocked on the single STPE in &lt;tt&gt;nonPeriodicTasks&lt;/tt&gt;, still trying to figure out why we can&apos;t drop all the CFs and release all the metrics but making progress &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16713487" author="jolynch" created="Sat, 8 Dec 2018 02:35:39 +0000"  >&lt;p&gt;Alright, I think I&apos;m narrowing in on this. I&apos;ve managed to get all the threads to die over in &lt;a href=&quot;https://github.com/jolynch/cassandra/tree/CASSANDRA-14922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a branch&lt;/a&gt; but we&apos;re still leaking all the static state through the &lt;tt&gt;InstanceClassLoader&lt;/tt&gt; s. I think I&apos;ve narrowed it down to just three remaining references (and I &lt;em&gt;think&lt;/em&gt; only one of them is a strong reference), details attached in the screenshots.&lt;/p&gt;

&lt;p&gt;We basically just need to kill that last strong reference and I believe that the whole &lt;tt&gt;InstanceClassLoader&lt;/tt&gt; should become collectible at that point (even with all the static state and self references to the classloaders should be ok since it&apos;ll be cut off at the root, I think).&lt;/p&gt;</comment>
                            <comment id="16718243" author="jolynch" created="Wed, 12 Dec 2018 00:11:34 +0000"  >&lt;p&gt;Nailed the MessageSink leak and properly shuts down logback now, and we clean up ThreadLocal variables which afaict means that there are no additional threads that could hold references ... and at least now &lt;a href=&quot;https://github.com/jolynch/cassandra/tree/CASSANDRA-14922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;my branch&lt;/a&gt; can pass unit tests in &lt;a href=&quot;https://circleci.com/workflow-run/6fb24842-bbb8-4aac-b137-4007729bf39a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt; so that&apos;s good.&lt;/p&gt;

&lt;p&gt;Unfortunately I think we&apos;re still leaking, according to my heap dump analysis the&#160;&lt;em&gt;main&lt;/em&gt; thread ends up with a strong reference to the &lt;tt&gt;InstanceClassLoaders&lt;/tt&gt;, which is really odd since the InstanceClassLoader doesn&apos;t have any static state so I don&apos;t see how those don&apos;t go out of scope when the test methods finish.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; tbh at this point I&apos;m pretty stuck. My understanding is that the &lt;tt&gt;InstanceClassLoaders&lt;/tt&gt; should go out of scope after each test method, which should allow everything to GC now that there are no more live references from threads to the &lt;tt&gt;InstanceClassLoaders&lt;/tt&gt;, but that&apos;s not happening. I think it might be related to passing in the current threads classloader &lt;a href=&quot;https://github.com/jolynch/cassandra/blob/1ca6ad3c41f4456b674e13883e0df0091f638564/test/distributed/org/apache/cassandra/distributed/TestCluster.java#L241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; but I&apos;m not sure how to achieve what we need there without that.&lt;/p&gt;</comment>
                            <comment id="16718514" author="jolynch" created="Wed, 12 Dec 2018 06:40:08 +0000"  >&lt;p&gt;I think I figured it out, it turns out that&#160;our version of &lt;tt&gt;jna.Native&lt;/tt&gt;&#160;holds a static map called &lt;a href=&quot;https://github.com/java-native-access/jna/blob/4bcc6191c5467361b5c1f12fb5797354cc3aa897/src/com/sun/jna/Native.java#L104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;options&lt;/tt&gt;&lt;/a&gt; which holds noncollectable references to the &lt;a href=&quot;https://github.com/java-native-access/jna/blob/4bcc6191c5467361b5c1f12fb5797354cc3aa897/src/com/sun/jna/Native.java#L1528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;InstanceClassLoader&lt;/tt&gt;&lt;/a&gt;; I believe this leak is what the last two references were talking about. I tried cleanly unloading or unregistering those but that still doesn&apos;t remove the reference to the ClassLoader in the &lt;tt&gt;options&lt;/tt&gt; map so I just hacked some reflection based solution together (similar to what I did for the &lt;tt&gt;ThreadLocal&lt;/tt&gt; variables) in&#160;&#160;&lt;a href=&quot;https://github.com/jolynch/cassandra/commit/6573176ef3ed9601ce7f02602c964d478c6a5741&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;6573176&lt;/a&gt;. According to Yourkit there are now no more strong references to the &lt;tt&gt;InstanceClassLoader&lt;/tt&gt; instances (attached).&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12951468/12951468_no_more_references.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;We leak a lot less memory with my latest patches, but ... for some reason the class loaders aren&apos;t going away and are still retaining some heap, just a lot less ... There is still something missing, maybe something like &lt;tt&gt;CMSClassUnloadingEnabled&lt;/tt&gt; or some such?&lt;/p&gt;</comment>
                            <comment id="16718972" author="benedict" created="Wed, 12 Dec 2018 13:34:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;: nice work, somehow I hadn&apos;t spotted this thread until now.&lt;/p&gt;

&lt;p&gt;Unfortunately I don&apos;t have anything useful to add, except a shot-in-the-dark that maybe a full GC is needed?  This is apparently the case for G1GC; not sure about other GCs, or which you are using.  It&apos;s probably not helpful, but you could also look at &lt;tt&gt;-XX:+TraceClassUnloading&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Mostly just wanted to say thanks for taking the time to track all of this down.&lt;/p&gt;</comment>
                            <comment id="16719715" author="jolynch" created="Thu, 13 Dec 2018 03:42:44 +0000"  >&lt;p&gt;I found a better workaround (in &lt;a href=&quot;https://github.com/apache/cassandra/commit/bfd8c328f92e6bd2c82269a048f6b868179f484a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bfd8c328&lt;/a&gt;) for the jna &lt;tt&gt;Native&lt;/tt&gt; Classloader&#160;leak is to just call the &lt;a href=&quot;https://github.com/java-native-access/jna/blob/365f6b343a92427e7890cae0c16df7b6c4c254d4/src/com/sun/jna/Native.java#L1446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;register&lt;/a&gt; API that doesn&apos;t add the &lt;tt&gt;InstanceClassLoader&lt;/tt&gt; to a global static map in &lt;tt&gt;Native&lt;/tt&gt;. This still loads the libraries and doesn&apos;t leak the ClassLoader into a global static map. If we&apos;re concerned about the changes to the &lt;tt&gt;NativeLibrary&lt;/tt&gt; I can pursue other option. I also found another thread that leaks only during ant test runs which is fixed in &lt;a href=&quot;https://github.com/apache/cassandra/commit/512d15b5f08bda1b0dc8a952ce950b5c4341f992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;512d15b5f&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Furthermore I believe I know why the JVM was still not releasing the classloaders even after they are no longer referenced: &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/lang/ref/SoftReference.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SoftReferences&lt;/a&gt;&#160;are apparently just ... not collected. It looks like Metaspace just grows without bound until we run the machine OOM (not the JVM, the machine).&lt;/p&gt;

&lt;p&gt;I tried the following after eliminating all strong references:&lt;br/&gt;
 1. No JVM tuning. This &lt;em&gt;did not&lt;/em&gt; work as the metaspace would grow without bound and eventually OOM the machine (not the JVM, the machine).&lt;br/&gt;
 2. &lt;tt&gt;-XX:SoftRefLRUPolicyMSPerMB=0&lt;/tt&gt; and or &lt;tt&gt;-XX:MaxMetaspaceSize=256M&lt;/tt&gt;. This &lt;b&gt;worked&lt;/b&gt; and caused the ClassLoaders to be released. With MaxMetaspaceSize we also successfully limit the offheap Metaspace which is nice.&lt;br/&gt;
 3. &lt;tt&gt;-XX:MaxMetaspaceSize=256M&lt;/tt&gt; and or &lt;tt&gt;-XX:MetaspaceSize=100M&lt;/tt&gt;. This &lt;em&gt;did not&lt;/em&gt; work. Setting the Max size would cause an &lt;tt&gt;java.lang.OutOfMemoryError: Metaspace&lt;/tt&gt;, setting just the size didn&apos;t do anything (machine would just OOM itself anyways)&lt;br/&gt;
 4. &lt;tt&gt;-XX:UseConcMarkSweepGC&lt;/tt&gt; and or &lt;tt&gt;-XX:CMSClassUnloadingEnabled&lt;/tt&gt;. This &lt;em&gt;did not&lt;/em&gt; work. Again the metaspace just grew without bound and ran out of memory.&lt;/p&gt;

&lt;p&gt;I think that running all unit tests under #2 is a pretty reasonable thing to do (we shouldn&apos;t be leaking Metaspace imo). I&apos;ve pursued that option in &lt;a href=&quot;https://github.com/apache/cassandra/commit/86f982b19ba23fc5efcd7421449af4a84d93711b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;86f982b1&lt;/a&gt; and it appears to work looking at my &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12951598/Metaspace_Actually_Collected.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;profiler&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Do you guys think it&apos;s acceptable to run all unit tests with the off-heap Metaspace limited to 256 megabytes and &lt;tt&gt;SoftRefLRUPolicyMSPerMB&lt;/tt&gt; set to 0 to tell the GC to actually collect soft references? It&apos;s different than the status quo but I think we probably shouldn&apos;t leak metaspace (aka permgen from java7/6) and we probably shouldn&apos;t rely on soft references for things to work generally... I checked and both options are available in openjdk8+, but I&apos;m not sure if there is a better way.&lt;/p&gt;

&lt;p&gt;Other than the ThreadLocal reflection hacks I think the branch is almost ready to squash and merge, what do you think?&lt;/p&gt;</comment>
                            <comment id="16720109" author="benedict" created="Thu, 13 Dec 2018 12:35:36 +0000"  >&lt;p&gt;Do you know where the soft references originate?  I wonder if there&apos;s anything we can do to simply eliminate them.&lt;/p&gt;

&lt;p&gt;Short of that, I&apos;m comfortable setting the SoftRefLRUPolicyMSPerMB - the default seems pretty strange (of 1s per MB), and probably does not seem to play well with Metaspace, since this probably doesn&apos;t contribute to the input to the SoftRefLRUPolicyMSPerMB.  So we could have Gigabytes of free space, and judge that we need the referent to have been unused for hours before we collect it.&lt;/p&gt;

&lt;p&gt;It&apos;s been a while since I sperlunked in the JDK source, but it might be worth taking a look to find out exactly what number if provides, but honestly I don&apos;t really see a problem with setting the value to zero.  The worst impact of soft references being freed too-eagrerly is performance, it should never be functional.  We don&apos;t depend on them directly in C*, so it would only be via the JDK.  Worst case scenario, we need to investigate again at some later date an issue with the tests.&lt;/p&gt;

&lt;p&gt;Nice catch on the Native API also.&lt;/p&gt;

&lt;p&gt;Overall this looks like excellent work (Though I&apos;ll leave a full review to Alex, since he&apos;s marked himself reviewer)&lt;/p&gt;</comment>
                            <comment id="16737083" author="ifesdjeen" created="Tue, 8 Jan 2019 12:36:09 +0000"  >&lt;p&gt;The patch looks good, and I&apos;d say &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; let&apos;s merge it, since tests have been failing for a while now, unless there&apos;s something else you wanted to include in the patch immediately. &lt;/p&gt;

&lt;p&gt;I&apos;ve had a couple of minor suggestions. All of the issues are easier to see / reproducible with a very small heap, ~256Mb: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Hints are leaking direct memory&lt;/li&gt;
	&lt;li&gt;Threadlocals are leaked&lt;/li&gt;
	&lt;li&gt;FastThreadLocalThread thread locals are leaked (sorry for a tongue-twister)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve put together a small &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:CASSANDRA-14922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;demo&lt;/a&gt; just for demonstration purposes if you wanted to see the impact of suggested changes.&lt;/p&gt;</comment>
                            <comment id="16737552" author="jolynch" created="Tue, 8 Jan 2019 21:42:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;The patch looks good, and I&apos;d say&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;&#160;let&apos;s merge it,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok, yea I agree let&apos;s merge what we have so that the unit tests can pass on trunk again. I&apos;ve put up a patch against trunk with what we have so far (including your changes from the demo branch which as far as I can tell remove the need for the ThreadLocal clearing).&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/024e69436e89bb79cdbf4e136a1f6d9c2747275d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;024e6943&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jolynch/cassandra/tree/CASSANDRA-14922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/jolynch/cassandra/tree/CASSANDRA-14922.png?circle-token= 1102a59698d04899ec971dd36e925928f7b521f5&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;If I attach a profiler during an intellij &quot;run this test until it fails&quot; mode I can see that the memory is indeed getting cleaned up:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12954229/12954229_MemoryReclaimedFix.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16737557" author="benedict" created="Tue, 8 Jan 2019 21:49:53 +0000"  >&lt;p&gt;Marking &apos;Ready to Commit&apos; given &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&apos;s comments.  I&apos;ll give it another quick once over then commit, so I can rebase &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14931&quot; title=&quot;Backport In-JVM dtests to 2.2, 3.0 and 3.11&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14931&quot;&gt;&lt;del&gt;CASSANDRA-14931&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14937&quot; title=&quot;Multi-version In-JVM dtests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14937&quot;&gt;&lt;del&gt;CASSANDRA-14937&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16737614" author="jolynch" created="Tue, 8 Jan 2019 22:54:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Awesome, can we wait for Alex to see the latest diff though with the reflection removed in favor of his proposed fast local thread pool cleanup method? I&apos;ve changed the patch a bit since he last looked.&lt;/p&gt;

&lt;p&gt;Regarding the backport, I am slightly concerned about the NativeLibrary changes being backported in their current form. From my reading of the JNA source code in version 4.2.2 in trunk we&apos;re just skipping the cache by using &lt;a href=&quot;https://github.com/java-native-access/jna/blob/4bcc6191c5467361b5c1f12fb5797354cc3aa897/src/com/sun/jna/NativeLibrary.java#L341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NativeLibrary::getInstance&lt;/a&gt; directly and passing it to &lt;a href=&quot;https://github.com/java-native-access/jna/blob/4bcc6191c5467361b5c1f12fb5797354cc3aa897/src/com/sun/jna/Native.java#L1260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Native::register(NativeLibrary)&lt;/a&gt; instead of having &lt;a href=&quot;https://github.com/java-native-access/jna/blob/4bcc6191c5467361b5c1f12fb5797354cc3aa897/src/com/sun/jna/Native.java#L1251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Native::register(String)&lt;/a&gt; do that for us and cache the classloader along the way &lt;a href=&quot;https://github.com/java-native-access/jna/blob/4bcc6191c5467361b5c1f12fb5797354cc3aa897/src/com/sun/jna/NativeLibrary.java#L363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. But, if I&apos;m wrong it&apos;s unlikely we&apos;d know, as while our tests cover Linux pretty thoroughly, darwin/windows are less covered.&lt;/p&gt;

&lt;p&gt;Also I forgot to respond to your question about SoftReferences here, did it on IRC but not here.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Do you know where the soft references originate? I wonder if there&apos;s anything we can do to simply eliminate them.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think the Soft references are coming from &lt;tt&gt;java.io.ObjectStreamClass$Caches.localDescs&lt;/tt&gt;, but the object serder we&apos;re doing in &lt;tt&gt;InvokableInstance&lt;/tt&gt; is a bit beyond my JVM skills I&apos;m afraid. I don&apos;t know how we can prevent the object serializations from caching the class descriptions... Perhaps the JVM option is sufficient for now and if we don&apos;t like that going forward we can dive in more?&lt;/p&gt;</comment>
                            <comment id="16737711" author="benedict" created="Wed, 9 Jan 2019 01:11:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;can we wait for Alex to see the latest diff though... I&apos;ve changed the patch a bit since he last looked.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure thing.  I&apos;ll start the rebase tomorrow in that case.  In that case, also, I&apos;ve pushed my one nit from a quick look through &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for Alex to look at, that I would have simply ninja&apos;d in (with comment here, of course).  This is just using the &lt;tt&gt;HintsBuffer.free&lt;/tt&gt; method instead of directly invoking &lt;tt&gt;DirectByteBuffer.cleaner().clean()&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Regarding the backport, I am slightly concerned about the NativeLibrary changes being backported in their current form.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for highlighting this.  I&apos;ll be sure to take a close look at the behaviour on each version we backport to.  I expect there will be other places that need similar treatment to what you&apos;ve done here, as well, so I need to double check anyway.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the Soft references are coming from java.io.ObjectStreamClass$Caches.localDescs, but the object serder we&apos;re doing in InvokableInstance is a bit beyond my JVM skills I&apos;m afraid.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No worries at all, thanks very much for reproducing this information here for posterity.  If we ever want to clean this up, it would probably be easiest to simply avoid ser/deser entirely (or use custom ser/deser), but your approach is a much more suitable compromise for now.  Thanks again also for all the investigative work to plug these gaps.&lt;/p&gt;</comment>
                            <comment id="16737726" author="jolynch" created="Wed, 9 Jan 2019 01:30:02 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Sure thing. I&apos;ll start the rebase tomorrow in that case. In that case, also, I&apos;ve pushed my one nit from a quick look through here for Alex to look at, that I would have simply ninja&apos;d in (with comment here, of course). This is just using the HintsBuffer.free method instead of directly invoking DirectByteBuffer.cleaner().clean().&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah cool, yea that appears to still work (and then we can leave the slab private in &lt;tt&gt;HintsBuffer&lt;/tt&gt; as well.)&lt;/p&gt;</comment>
                            <comment id="16738278" author="ifesdjeen" created="Wed, 9 Jan 2019 14:06:53 +0000"  >&lt;p&gt;Committed to trunk with &lt;a href=&quot;https://github.com/apache/cassandra/commit/d5005627b02b4e716947fa05a40473368017c0f9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d5005627b02b4e716947fa05a40473368017c0f9&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://circleci.com/workflow-run/eed85c4b-3a55-46bb-bad8-93c4c1e820f9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI run&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; thank you for the investigation &amp;amp; patch. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; thank you for input as well!&lt;/p&gt;</comment>
                            <comment id="16738597" author="benedict" created="Wed, 9 Jan 2019 19:44:56 +0000"  >&lt;p&gt;In back porting this to 3.0, I wondered if it was worth opening a brief bit of discussion around alternative approaches&#160;to the &lt;tt&gt;ThreadLocal&lt;/tt&gt;&#160;issue, for which the&#160;Netty approach does not anyway work in 3.0 (since we use regular &lt;tt&gt;ThreadLocal&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;The fix introduced here&#160;assumes that we only access any cluster behaviour from the &lt;tt&gt;main&lt;/tt&gt;&#160;thread. &#160;An alternative approach would be to isolate all tests to a thread owned by the &lt;tt&gt;TestCluster&lt;/tt&gt;&#160;(which we already have available to us, and we shutdown on &lt;tt&gt;close&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;If this were the standard pattern for implementing any tests, we should not have an issue with the &lt;tt&gt;main&lt;/tt&gt; thread retaining any references inside its &lt;tt&gt;ThreadLocal&lt;/tt&gt;, but we also will create a pattern that extends to any tests written to utilise multi-threading, and hence not run against the &lt;tt&gt;main&lt;/tt&gt;&#160;thread.&lt;/p&gt;

&lt;p&gt;I&apos;ve implemented this in&#160;my backport branch, and it is quite straight forward, however I am still chasing down other 3.0-era leaks (right now around our custom log4j integrations)&lt;/p&gt;</comment>
                            <comment id="16738600" author="benedict" created="Wed, 9 Jan 2019 19:46:26 +0000"  >&lt;p&gt;On a related topic, it might be nice to eventually migrate to assigning a&#160;&lt;tt&gt;ThreadGroup&lt;/tt&gt;&#160;to all our threads, so we can reliably&#160;manage them en masse.&lt;/p&gt;</comment>
                            <comment id="16740530" author="benedict" created="Fri, 11 Jan 2019 16:21:10 +0000"  >&lt;p&gt;I&apos;ve pushed a branch&#160;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14922-followup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&#160;that removes the cleanup of thread locals, and removes the cluster-wide executor, instead introducing a node-specific executor on which all invocations to that node happen. &#160;This might introduce some slight penalty for evaluating tests, as we have multiple synchronisation points where control-flow is handed between threads, but it guarantees that all state remains isolated without ever burdening the user of the API to restrict their own program design.&lt;/p&gt;

&lt;p&gt;We can elaborate on this later to make it ergonomic to use the executor, or perhaps to skip the executor, in order to provide efficiency where it matters.&lt;/p&gt;

&lt;p&gt;I think it&#160;makes sense to classify this&#160;as part of&#160;the work for this ticket, and I will then backport it&#160;alongside the original patch for this ticket and the jvm-dtests, however it&apos;s primarily necessary&#160;for&#160;&lt;em&gt;future&lt;/em&gt;&#160;reasons:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;3.0 and earlier use &lt;tt&gt;ThreadLocal&lt;/tt&gt;, not &lt;tt&gt;FastThreadLocal&lt;/tt&gt;, so we need the earlier hackier reflection to fix on these&lt;/li&gt;
	&lt;li&gt;The current approach only cleans up the main thread - any other threads may themselves retain state indefinitely&lt;/li&gt;
	&lt;li&gt;Most importantly, when we begin stopping and starting nodes, and/or upgrading them, the cluster-wide executor service will retain&#160;thread local state from the stopped nodes, potentially indefinitely, probably&#160;leading to a steady leak of memory.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It seems easiest to introduce the future-proof approach now and port it to all the versions at once.&lt;/p&gt;

&lt;p&gt;On a related note, there is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14974&quot; title=&quot;Unit test stdout capture is malfunctioning in 4.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14974&quot;&gt;&lt;del&gt;CASSANDRA-14974&lt;/del&gt;&lt;/a&gt;, which simultaneously fixes a bug in our stdout capture, &lt;em&gt;and&lt;/em&gt; the impact this has to the cleanup of a &lt;tt&gt;TestCluster&lt;/tt&gt; that occurs once this bug is fixed. &#160;If somebody&#160;watching this ticket fancies reviewing that ticket, it would also be appreciated.&lt;/p&gt;</comment>
                            <comment id="16741910" author="ifesdjeen" created="Mon, 14 Jan 2019 10:11:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; thank you for the patch. It does look like an improvement. &lt;/p&gt;

&lt;p&gt;I think that using node-local executor will work better for scenarios different than &quot;fire up cluster, shut down the cluster&quot;. &lt;/p&gt;

&lt;p&gt;Just to confirm my understanding is correct: we can remove thread-local works in this case since we&apos;re passing the right class loader, making references unreachable. Is that right? I did test it and tests do confirm that passing &quot;root&quot; class loader would cause heap problems again, but maybe you have some more insight on that.&lt;/p&gt;

&lt;p&gt;+1 to commit it in the scope of this ticket as a follow-up. However, there are some test failures in distributed tests, seemingly caused by different exception wrapping in the new version, we should fix them before committing.&lt;/p&gt;</comment>
                            <comment id="16742047" author="benedict" created="Mon, 14 Jan 2019 13:15:18 +0000"  >&lt;p&gt;Thanks for the review.  I&apos;ll push an update shortly, with the test failures handled, and a slight tweak to not misleadingly return a SerializableX when it is wrapped with an executor (since this cannot be serialized).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we can remove thread-local works in this case since we&apos;re passing the right class loader, making references unreachable. Is that right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;By &apos;passing&apos; do&#160;you mean to the thread factory? &#160;In which case, no, that shouldn&apos;t have an impact (I pass it only because it seems to make sense, it should work still without doing so, and seems to if I try). &#160;All we&apos;re really doing is ensuring that any thread that evaluates anything inside one of the classes&#160;loaded by the instance&apos;s classloader is shutdown when the node is shutdown, by passing the work to a thread on this executor.&lt;/p&gt;</comment>
                            <comment id="16742246" author="benedict" created="Mon, 14 Jan 2019 16:07:28 +0000"  >&lt;p&gt;I&apos;ve pushed an update with the suggested changes, and also reintroduced some sequencing to the executor shutdowns.&lt;/p&gt;</comment>
                            <comment id="16743066" author="ifesdjeen" created="Tue, 15 Jan 2019 13:40:49 +0000"  >&lt;p&gt;+1 for the latest version, huge improvement!&lt;/p&gt;</comment>
                            <comment id="16743312" author="benedict" created="Tue, 15 Jan 2019 19:13:25 +0000"  >&lt;p&gt;Thanks, committed follow-up as &lt;a href=&quot;https://github.com/apache/cassandra/commit/00fff3ee6e6c0142529de621bcaeee5790a0c235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;00fff3ee6e6c0142529de621bcaeee5790a0c235&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16750488" author="jolynch" created="Wed, 23 Jan 2019 22:38:43 +0000"  >&lt;p&gt;I&apos;m getting trunk failures again as of e871903d, and after an &lt;a href=&quot;https://wilderness.apache.org/channels/?f=cassandra-dev/2019-01-23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;IRC discussion&lt;/a&gt; with Benedict it looks like we&#160;may be leaking:&lt;br/&gt;
 1. Off heap memory via some combination of the &lt;tt&gt;HintsBuffer&lt;/tt&gt;, &lt;tt&gt;CommitLogs&lt;/tt&gt; and the &lt;tt&gt;BufferPool&lt;/tt&gt;&lt;br/&gt;
 2. File descriptors are potentially leaked and it&apos;s unclear that we clean those up&lt;/p&gt;

&lt;p&gt;What is odd is that according to a profiler attached while running one of the dtests in a for loop, most of the leaked native memory is either pending finalization or unreachable from GC roots:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12956048/12956048_LeakedNativeMemory.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Afaict both &lt;tt&gt;HintsBuffer&lt;/tt&gt; and &lt;tt&gt;CommitLogs&lt;/tt&gt; should be getting cleaned in the &lt;tt&gt;Instance::shutdown&lt;/tt&gt; methods, although I don&apos;t think we clean the &lt;tt&gt;BufferPool&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Continuing to investigate this so that we can have green runs on trunk again.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Edit:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The test I&apos;m running is applying this diff:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--- a/test/distributed/org/apache/cassandra/distributed/DistributedReadWritePathTest.java
+++ b/test/distributed/org/apache/cassandra/distributed/DistributedReadWritePathTest.java
@@ -27,6 +27,15 @@ import static org.apache.cassandra.net.MessagingService.Verb.READ_REPAIR;
 
 public class DistributedReadWritePathTest extends DistributedTestBase
 {
+    @Test
+    public void manyCoordinatedReads() throws Throwable
+    {
+        for (int i = 0; i &amp;lt; 20; i ++)
+        {
+            coordinatorRead();
+        }
+    }
+
     @Test
     public void coordinatorRead() throws Throwable
     {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then I run the test suite and measure OS memory usage, for example if I re-wind trunk to the first patch (3dcde082) I see only 1.6GB allocated:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/usr/bin/time -f &quot;mem=%K RSS=%M elapsed=%E cpu.sys=%S .user=%U&quot; ant testclasslist -Dtest.classlistfile=/tmp/java_dtests_1_final.txt -Dtest.classlistprefix=distributed

testclasslist:
     [echo] Number of test runners: 1
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest Tests run: 7, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 103.473 sec
[junit-timeout] 
[junitreport] Processing /home/josephl/pg/cassandra/build/test/TESTS-TestSuites.xml to /tmp/null554485593
[junitreport] Loading stylesheet jar:file:/usr/share/ant/lib/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-frames.xsl
[junitreport] Transform time: 269ms
[junitreport] Deleting: /tmp/null554485593

BUILD SUCCESSFUL
Total time: 1 minute 47 seconds
mem=0 RSS=1606332 elapsed=1:47.37 cpu.sys=10.95 .user=159.99
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But, if I use latest trunk (e871903d), I get 5GB:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;testclasslist:
     [echo] Number of test runners: 1
    [mkdir] Created dir: /home/josephl/pg/cassandra/build/test/cassandra
    [mkdir] Created dir: /home/josephl/pg/cassandra/build/test/output
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest Tests run: 7, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 103.098 sec
[junit-timeout] 
[junitreport] Processing /home/josephl/pg/cassandra/build/test/TESTS-TestSuites.xml to /tmp/null126756458
[junitreport] Loading stylesheet jar:file:/usr/share/ant/lib/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-frames.xsl
[junitreport] Transform time: 330ms
[junitreport] Deleting: /tmp/null126756458

BUILD SUCCESSFUL
Total time: 2 minutes 15 seconds
mem=0 RSS=4962924 elapsed=2:15.93 cpu.sys=16.55 .user=284.28
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since the heap is 1GB, and we allocate about 256MB for the off-heap metaspace, 1.6GB is much closer to what we expect than 5GB.&lt;/p&gt;

&lt;p&gt;So ,.. something about the new executor system may be contributing. Continuing to dig in.&lt;/p&gt;</comment>
                            <comment id="16751020" author="ifesdjeen" created="Thu, 24 Jan 2019 11:19:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; to be honest I do not see OOMs so far. I&apos;m running up to 100 3-node cluster instances and it works fine. Which JDK are you using? Could that be a difference?&lt;/p&gt;</comment>
                            <comment id="16751398" author="jolynch" created="Thu, 24 Jan 2019 18:15:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; they are no longer JVM level OOMs; I believe from the circleci ssh dmesg output this is a OS oomkill:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[32619.267150] Task in /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40/390b809d1f78090fda35dcf8b56612302f71bee5632fd911b2ef94558023610b killed as a result of limit of /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40
[32619.267155] memory: usage 4194304kB, limit 4194304kB, failcnt 28170
[32619.267156] memory+swap: usage 0kB, limit 9007199254740988kB, failcnt 0
[32619.267157] kmem: usage 0kB, limit 9007199254740988kB, failcnt 0
[32619.267158] Memory cgroup stats for /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40: cache:16KB rss:9444KB rss_huge:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:8KB active_anon:9452KB inactive_file:0KB active_file:0KB unevictable:0KB
[32619.267168] Memory cgroup stats for /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40/390b809d1f78090fda35dcf8b56612302f71bee5632fd911b2ef94558023610b: cache:64956KB rss:4119888KB rss_huge:0KB mapped_file:17712KB dirty:32988KB writeback:0KB inactive_anon:60KB active_anon:4120272KB inactive_file:32116KB active_file:31896KB unevictable:0KB
[32619.267176] [ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name
[32619.267245] [30017]     0 30017    31256     5620      22       4        0         -1000 circleci
[32619.267248] [31296] 166536 31296     1157      198       8       3        0           200 sh
[32619.267251] [31416] 166536 31416    31064     5075      22       4        0           200 circleci-agent
[32619.267253] [33206] 166536 33206     5012      745      15       3        0           200 bash
[32619.267351] [32251] 166536 32251  5984655   127267     432      11        0           200 java
[32619.267353] [32391] 166536 32391  8094234   904842    6190      34        0           200 java
[32619.267355] Memory cgroup out of memory: Kill process 32391 (java) score 1068 or sacrifice child
[32619.271649] Killed process 32391 (java) total-vm:32376936kB, anon-rss:3603092kB, file-rss:16276kB

# Try it manually
cassandra@390b809d1f78:/tmp/cassandra$ /usr/bin/time -f &quot;mem=%K RSS=%M elapsed=%E cpu.sys=%S .user=%U&quot; ant testclasslist -Dtest.classlistfile=/tmp/java_dtests_${CIRCLE_NODE_INDEX}_final.txt -Dtest.classlistprefix=distributed
...
testclasslist:
     [echo] Number of test runners: 1
[junit-timeout] Picked up JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest
[junit-timeout] Testsuite: org.apache.cassandra.distributed.DistributedReadWritePathTest Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0 sec
[junit-timeout] 
[junit-timeout] Testcase: org.apache.cassandra.distributed.DistributedReadWritePathTest:readRepairTest: Caused an ERROR
[junit-timeout] Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
[junit-timeout] junit.framework.AssertionFailedError: Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1275)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1275)
[junit-timeout]         at java.lang.Thread.run(Thread.java:748)
[junit-timeout] 
[junit-timeout] 
[junit-timeout] Test org.apache.cassandra.distributed.DistributedReadWritePathTest FAILED (crashed)
[junitreport] Processing /tmp/cassandra/build/test/TESTS-TestSuites.xml to /tmp/null1789186966
[junitreport] Loading stylesheet jar:file:/usr/share/ant/lib/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-frames.xsl
[junitreport] Transform time: 2223ms
[junitreport] Deleting: /tmp/null1789186966

BUILD FAILED
/tmp/cassandra/build.xml:1861: The following error occurred while executing this line:
/tmp/cassandra/build.xml:1751: Some test(s) failed.

Total time: 25 seconds
Command exited with non-zero status 1
mem=0 RSS=3667504 elapsed=0:26.40 cpu.sys=17.58 .user=52.25

# This was another oomkill
[33152.855977] Task in /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40/390b809d1f78090fda35dcf8b56612302f71bee5632fd911b2ef94558023610b killed as a result of limit of /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40 
[33152.855982] memory: usage 4194304kB, limit 4194304kB, failcnt 50983 
[33152.855984] memory+swap: usage 0kB, limit 9007199254740988kB, failcnt 0 
[33152.855985] kmem: usage 0kB, limit 9007199254740988kB, failcnt 0 
[33152.855986] Memory cgroup stats for /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40: cache:16KB rss:9144KB rss_huge:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:8KB active_anon:9152KB inactive_file:0KB active_file:0KB unevictable:0KB 
[33152.856001] Memory cgroup stats for /docker/db2d2aa36ea5a82fa51c91a99d32de688d45610c74f496288015ad82845ebf40/390b809d1f78090fda35dcf8b56612302f71bee5632fd911b2ef94558023610b: cache:2332KB rss:4182812KB rss_huge:0KB mapped_file:500KB dirty:944KB writeback:0KB inactive_anon
:52KB active_anon:4183236KB inactive_file:808KB active_file:632KB unevictable:0KB 
[33152.856012] [ pid ] &#160;&#160;uid &#160;tgid total_vm &#160;&#160;&#160;&#160;&#160;rss nr_ptes nr_pmds swapents oom_score_adj name 
[33152.856086] [30017] &#160;&#160;&#160;&#160;0 30017 &#160;&#160;&#160;31256 &#160;&#160;&#160;&#160;5515 &#160;&#160;&#160;&#160;&#160;23 &#160;&#160;&#160;&#160;&#160;&#160;4 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;-1000 circleci 
[33152.856090] [31296] 166536 31296 &#160;&#160;&#160;&#160;1157 &#160;&#160;&#160;&#160;&#160;&#160;16 &#160;&#160;&#160;&#160;&#160;&#160;8 &#160;&#160;&#160;&#160;&#160;&#160;3 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;200 sh 
[33152.856093] [31416] 166536 31416 &#160;&#160;&#160;31640 &#160;&#160;&#160;&#160;5323 &#160;&#160;&#160;&#160;&#160;24 &#160;&#160;&#160;&#160;&#160;&#160;4 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;200 circleci-agent 
[33152.856132] [ &#160;708] 166536 &#160;&#160;708 &#160;&#160;&#160;&#160;5070 &#160;&#160;&#160;&#160;&#160;143 &#160;&#160;&#160;&#160;&#160;15 &#160;&#160;&#160;&#160;&#160;&#160;3 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;200 bash 
[33152.856251] [28288] 166536 28288 &#160;&#160;&#160;&#160;1096 &#160;&#160;&#160;&#160;&#160;&#160;16 &#160;&#160;&#160;&#160;&#160;&#160;7 &#160;&#160;&#160;&#160;&#160;&#160;3 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;200 time 
[33152.856254] [28289] 166536 28289 &#160;5984655 &#160;&#160;125056 &#160;&#160;&#160;&#160;437 &#160;&#160;&#160;&#160;&#160;11 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;200 java 
[33152.856262] [28645] 166536 28645 &#160;8143453 &#160;&#160;914706 &#160;&#160;&#160;6291 &#160;&#160;&#160;&#160;&#160;35 &#160;&#160;&#160;&#160;&#160;&#160;&#160;0 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;200 java 
[33152.856310] Memory cgroup out of memory: Kill process 28645 (java) score 1078 or sacrifice child 
[33152.860694] Killed process 28645 (java) total-vm:32573812kB, anon-rss:3658488kB, file-rss:336kB&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For example on the latest trunk I see three test fails, the in-jvm dtests and two PagingTests: &lt;a href=&quot;https://circleci.com/gh/jolynch/cassandra/413#tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7d138e20&lt;/a&gt;. I&apos;m also getting these failures in other bug fix branches e.g. &lt;a href=&quot;https://circleci.com/gh/jolynch/cassandra/tree/CASSANDRA-14096-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-14096-trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My java version running locally is 8u191:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ java -version
java version &quot;1.8.0_191&quot;
Java(TM) SE Runtime Environment (build 1.8.0_191-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16751659" author="benedict" created="Thu, 24 Jan 2019 22:44:42 +0000"  >&lt;p&gt;FWIW, I don&apos;t suspect anything.  I have had terminations due to file handle exhaustion locally, but I absolutely believe that we are likely to have some native memory leaks too.&lt;/p&gt;</comment>
                            <comment id="16759846" author="ifesdjeen" created="Mon, 4 Feb 2019 13:31:43 +0000"  >&lt;p&gt;I&apos;ve investigated this one a bit further, but to be honest could not find any proof of leaks. I&apos;ve also tried to make shutdown process more synchronous to reduce amount of in-flight memory, but this hasn&apos;t helped. I did also check the possible native memory leak. You are right there native byte buffer instances hanging after instance shutdown, but all of them as far as I can tell were pending finalization (see &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12956908/12956908_Screen+Shot+2019-01-30+at+15.47.13.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;).&lt;/p&gt;

&lt;p&gt;I&apos;ve tried running tests in non-constrained environment in loop &lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/1197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, and it seems to be passing fine after 10x100 runs. &lt;/p&gt;

&lt;p&gt;I made a small follow-up patch (however, these improvements are minor and do not have any impact on the end result) &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:oom-improvements&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. In this patch I also disable in-jvm dtests for resource constrained environment.&lt;/p&gt;

&lt;p&gt;If this looks ok, I suggest we do that and merge &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&apos;s multi-version patch and continue writing tests.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13206848">CASSANDRA-14946</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13208388">CASSANDRA-14969</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13208989">CASSANDRA-14974</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12951080" name="AllThreadsStopped.png" size="349717" author="jolynch" created="Sat, 8 Dec 2018 02:35:52 +0000"/>
                            <attachment id="12951079" name="ClassLoadersRetaining.png" size="182212" author="jolynch" created="Sat, 8 Dec 2018 02:35:52 +0000"/>
                            <attachment id="12956048" name="LeakedNativeMemory.png" size="338361" author="jolynch" created="Wed, 23 Jan 2019 22:37:51 +0000"/>
                            <attachment id="12950585" name="Leaking_Metrics_On_Shutdown.png" size="193847" author="jolynch" created="Tue, 4 Dec 2018 18:28:26 +0000"/>
                            <attachment id="12951436" name="MainClassRetaining.png" size="390103" author="jolynch" created="Wed, 12 Dec 2018 00:11:45 +0000"/>
                            <attachment id="12954229" name="MemoryReclaimedFix.png" size="106585" author="jolynch" created="Tue, 8 Jan 2019 21:42:16 +0000"/>
                            <attachment id="12951598" name="Metaspace_Actually_Collected.png" size="112676" author="jolynch" created="Thu, 13 Dec 2018 03:46:28 +0000"/>
                            <attachment id="12951078" name="OnlyThreeRootsLeft.png" size="383310" author="jolynch" created="Sat, 8 Dec 2018 02:35:52 +0000"/>
                            <attachment id="12956909" name="Screen Shot 2019-01-30 at 15.46.35.png" size="194884" author="ifesdjeen" created="Wed, 30 Jan 2019 14:49:01 +0000"/>
                            <attachment id="12956908" name="Screen Shot 2019-01-30 at 15.47.13.png" size="191569" author="ifesdjeen" created="Wed, 30 Jan 2019 14:48:31 +0000"/>
                            <attachment id="12951468" name="no_more_references.png" size="227844" author="jolynch" created="Wed, 12 Dec 2018 06:41:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jolynch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s015w8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ifesdjeen</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>