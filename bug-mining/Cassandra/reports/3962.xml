<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10740] Incorrect condition causes cleanup of SSTables which might not need it</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10740</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We needed to perform cleanup of SSTables in our production cluster but found out that it would take several months. Together with my colleague &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JiriHorky&quot; class=&quot;user-hover&quot; rel=&quot;JiriHorky&quot;&gt;JiriHorky&lt;/a&gt; we have pinpointed the issue to method CompactionManager.needsCleanup which incorrectly marks almost all SSTables as the ones needing the cleanup even though that might not be true. I am attaching a patch which should be applicable from version 2.x forward (this is the version we would need it in).&lt;/p&gt;

&lt;p&gt;To explain the problem, the last condition in the cycle that checks whether the next key in the SSTable after the current checked range is NOT contained in the next range falsely marks SSTable as necessary to have cleanup even though it might be contained in some other range. The correct condition (which is actully described in the comment) is to check whether the next key in the SSTable after the current range is less than or equal to the &quot;left&quot; key of the next range (assuming that the left key is exclusive which is described in another comment of the same method).&lt;/p&gt;

&lt;p&gt;Is our patch and reasoning correct?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12914631">CASSANDRA-10740</key>
            <summary>Incorrect condition causes cleanup of SSTables which might not need it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jakubjanecek">Jakub Janecek</assignee>
                                    <reporter username="jakubjanecek">Jakub Janecek</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Nov 2015 22:11:54 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:49 +0000</updated>
                            <resolved>Thu, 26 Nov 2015 07:56:10 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15015592" author="jakubjanecek" created="Fri, 20 Nov 2015 10:54:26 +0000"  >&lt;p&gt;Could the fix version be 2.0.x?&lt;/p&gt;</comment>
                            <comment id="15016706" author="krummas" created="Fri, 20 Nov 2015 12:20:34 +0000"  >&lt;p&gt;there won&apos;t be any more 2.0 releases so we will only commit to 2.1+, you would have to roll your own version if you want this in 2.0&lt;/p&gt;</comment>
                            <comment id="15021835" author="krummas" created="Mon, 23 Nov 2015 09:28:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jakubjanecek&quot; class=&quot;user-hover&quot; rel=&quot;jakubjanecek&quot;&gt;jakubjanecek&lt;/a&gt; this looks correct to me, but it would be nice with a unit test that shows the difference, do you have time to write one?&lt;/p&gt;</comment>
                            <comment id="15021839" author="jakubjanecek" created="Mon, 23 Nov 2015 09:31:05 +0000"  >&lt;p&gt;Of course I wanted to write a unit test but the method depends on an instance of SSTableReader and I wasn&apos;t really able to get one or mock it as it is quite a class in size. If you help me with the test setup I can write it.&lt;/p&gt;</comment>
                            <comment id="15021840" author="krummas" created="Mon, 23 Nov 2015 09:33:37 +0000"  >&lt;p&gt;We usually generate actual sstables, did you have a look at the other tests in CleanupTest ?&lt;/p&gt;</comment>
                            <comment id="15021845" author="jakubjanecek" created="Mon, 23 Nov 2015 09:37:38 +0000"  >&lt;p&gt;I did but it seemed like too heavy-weight approach. The algorithm is quite easy to test and I would like to keep it that way. Actually without the necessity to have method SSTableReader.firstKeyBeyond I could refactor the algorithmic part into a separate method which could be tested and let the SSTableReader dependency in the current method. But ok... can you point me to some actual test I can &quot;copy&quot; to start?&lt;/p&gt;</comment>
                            <comment id="15021849" author="krummas" created="Mon, 23 Nov 2015 09:40:57 +0000"  >&lt;p&gt;Have not looked too closely, but testCleanupWithNewToken might be a candidate&lt;/p&gt;</comment>
                            <comment id="15026562" author="jakubjanecek" created="Wed, 25 Nov 2015 10:21:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I have added a patch with the test. The last test case shows that the change actually has some effect. The old implementation would return that the SSTable needs a cleanup but my implementation correctly returns false.&lt;/p&gt;</comment>
                            <comment id="15026746" author="krummas" created="Wed, 25 Nov 2015 13:21:17 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;This looks good to me - moved the test into CleanupTest (made needsCleanup public with @VisibleForTesting)&lt;/p&gt;

&lt;p&gt;pushed to github to get a clean CI run before committing:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/jakub/10740&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jakub/10740&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/jakub/10740-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jakub/10740-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/jakub/10740-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jakub/10740-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/jakub/10740-3.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jakub/10740-3.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-3.1-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-3.1-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/jakub/10740-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jakub/10740-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-jakub-10740-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15026856" author="jakubjanecek" created="Wed, 25 Nov 2015 14:36:03 +0000"  >&lt;p&gt;OK. Do I need to do something else or is that it? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15028324" author="krummas" created="Thu, 26 Nov 2015 07:56:10 +0000"  >&lt;p&gt;nope, nothing more, it is now committed - I will assign this ticket to you once someone adds you as a contributor in jira&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12773349" name="trunk-10740.txt" size="1113" author="jakubjanecek" created="Thu, 19 Nov 2015 22:14:46 +0000"/>
                            <attachment id="12774313" name="trunk-test-10740.txt" size="6842" author="jakubjanecek" created="Wed, 25 Nov 2015 10:19:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jakubjanecek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oo1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332830">2.0.17</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>