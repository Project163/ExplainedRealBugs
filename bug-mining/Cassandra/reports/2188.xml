<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5542] BulkLoader is broken in trunk</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5542</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5015&quot; title=&quot;move bloom_filter_fp_chance to compaction options&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5015&quot;&gt;&lt;del&gt;CASSANDRA-5015&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5521&quot; title=&quot;move IndexSummary off heap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5521&quot;&gt;&lt;del&gt;CASSANDRA-5521&lt;/del&gt;&lt;/a&gt;, we need CFMetaData to open SSTable(Reader), especially to get bloom_filter_fp_chance and index_interval.&lt;/p&gt;

&lt;p&gt;When using bulkloader, CFMetaData is not available, so we cannot open SSTable to be streamed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646297">CASSANDRA-5542</key>
            <summary>BulkLoader is broken in trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="yukim">Yuki Morishita</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 May 2013 21:20:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:13 +0000</updated>
                            <resolved>Thu, 18 Jul 2013 14:28:58 +0000</resolved>
                                        <fixVersion>2.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13669359" author="yukim" created="Wed, 29 May 2013 15:55:15 +0000"  >&lt;p&gt;There are two classes that need to change:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;DatabaseDescriptor&lt;br/&gt;
  We need to set memoryAllocator in order to create IndexSummary.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;SSTableLoader&lt;br/&gt;
  Create dummy CFMetadata and pass it to SSTableReader.open, so it can use default values for bf_fp_chance and index_interval.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not sure if that the best approach for second one though.&lt;/p&gt;</comment>
                            <comment id="13669422" author="jbellis" created="Wed, 29 May 2013 16:45:25 +0000"  >&lt;p&gt;I&apos;m a little skeptical about the SSTL changes as well.  Seems dangerous to pass a default CFM that claims e.g. comparator that doesn&apos;t actually match the data.&lt;/p&gt;

&lt;p&gt;I note that we&apos;re passing null back in 1.2 as well; what changed?&lt;/p&gt;</comment>
                            <comment id="13669524" author="yukim" created="Wed, 29 May 2013 18:09:41 +0000"  >&lt;p&gt;On trunk, we are using bloom_filter_fp_chance and index_interval from CFMetaData when opening.&lt;br/&gt;
If we pass null, we get NPE.&lt;/p&gt;</comment>
                            <comment id="13669797" author="jbellis" created="Wed, 29 May 2013 22:03:22 +0000"  >&lt;p&gt;Pushed the DatabaseDescriptor change to trunk.  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5555&quot; title=&quot;Allow sstableloader to handle a larger number of files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5555&quot;&gt;&lt;del&gt;CASSANDRA-5555&lt;/del&gt;&lt;/a&gt; will solve the SSTableLoader problem.&lt;/p&gt;</comment>
                            <comment id="13677351" author="yukim" created="Thu, 6 Jun 2013 18:36:17 +0000"  >&lt;p&gt;Still, sstableloader throws NPE on the execution path at SSTableReader.&lt;/p&gt;</comment>
                            <comment id="13677353" author="yukim" created="Thu, 6 Jun 2013 18:37:08 +0000"  >&lt;p&gt;Attaching patch to switch using indexSummary instead of CFMetaData where affected.&lt;/p&gt;</comment>
                            <comment id="13677355" author="jbellis" created="Thu, 6 Jun 2013 18:40:34 +0000"  >&lt;p&gt;sample key count is going to be nonsense, will that break anything?&lt;/p&gt;</comment>
                            <comment id="13677362" author="yukim" created="Thu, 6 Jun 2013 18:45:57 +0000"  >&lt;p&gt;hmm, you are right, but it is used to tell the receiving node the estimated key count for creating BF.&lt;br/&gt;
Maybe we should query schema first, then bulk load.&lt;br/&gt;
I need that anyway if we switch to use cf ID for new streaming protocol(&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5286?focusedCommentId=13671413&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13671413&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-5286?focusedCommentId=13671413&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13671413&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13677374" author="jbellis" created="Thu, 6 Jun 2013 18:54:33 +0000"  >&lt;p&gt;It makes me sad to introduce a schema dependency, since that means you can&apos;t run sstableloader except on a cluster member.&lt;/p&gt;

&lt;p&gt;What if we added key count and cfid to the stats/metadata sstable component?&lt;/p&gt;</comment>
                            <comment id="13677387" author="yukim" created="Thu, 6 Jun 2013 19:06:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;It makes me sad to introduce a schema dependency, since that means you can&apos;t run sstableloader except on a cluster member.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It does query schema even on 1.2(&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4755&quot; title=&quot;Bulk loader won&amp;#39;t work with CQL3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4755&quot;&gt;&lt;del&gt;CASSANDRA-4755&lt;/del&gt;&lt;/a&gt;), so it is fairly easy to fetch info we need.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What if we added key count and cfid to the stats/metadata sstable component?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This can also be done, but the change requires stats.db to be always present when using bulkloader, which we don&apos;t today.&lt;/p&gt;</comment>
                            <comment id="13677407" author="jbellis" created="Thu, 6 Jun 2013 19:27:27 +0000"  >&lt;p&gt;Oh, I&apos;m fine with querying remotely a la 4755.  I thought we were talking about opening up the system keyspace locally.&lt;/p&gt;</comment>
                            <comment id="13702583" author="yukim" created="Mon, 8 Jul 2013 22:58:55 +0000"  >&lt;p&gt;I added &quot;querying schema&quot; part to bulk loader and successfully opened SSTables, but now I&apos;m stuck on the change in streaming.&lt;br/&gt;
New streaming now connects from both endpoints, so bulk loader also needs to listen on storage port to receive message from the loading nodes. I think we don&apos;t want to make bulk loader a fat client again...&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Any suggestion for fixing this issue?&lt;/p&gt;</comment>
                            <comment id="13703090" author="slebresne" created="Tue, 9 Jul 2013 09:40:42 +0000"  >&lt;p&gt;Ahah, yeah that sucks, didn&apos;t though of that.&lt;/p&gt;

&lt;p&gt;Well, one solution I think might be to change a bit the solution I used in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5699&quot; title=&quot;Streaming (2.0) can deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5699&quot;&gt;&lt;del&gt;CASSANDRA-5699&lt;/del&gt;&lt;/a&gt;. Instead of having the initiator node open one connection and the other one opening the other one afterwards, we could make the initiator node open both connections instead sequentially (sending a StreamInit on both, but with a &quot;isIncoming&quot; flag to say if the connection should be used by the remote as incoming or ongoing connection).&lt;/p&gt;</comment>
                            <comment id="13703783" author="yukim" created="Tue, 9 Jul 2013 21:00:46 +0000"  >&lt;p&gt;Thanks Sylvain.&lt;/p&gt;

&lt;p&gt;Attaching 2 patches, 0001 changes streaming 2.0 procedure based on Sylvain&apos;s comment above(initiator opens 2 connections), and 0002 to query schema to open SSTableReader for streaming.&lt;/p&gt;</comment>
                            <comment id="13706972" author="slebresne" created="Fri, 12 Jul 2013 14:23:17 +0000"  >&lt;p&gt;On the protocol changes, I&apos;m not sure I&apos;m a big fan of adding 2 new stream messages just for the purpose of setting up connections. I was also liking the idea of having a setup phase that creates both connections before starting to use it, instead of creating one and partially using it to synchronize the creation of the other one as done in the patch.&lt;/p&gt;

&lt;p&gt;What I had imagined is that the initiator could just create 2 connections (without really waiting for anything from the other side), sending a StreamInit on each with a flag saying if the connection is the incoming or ongoing one. On receiving any of those connection, the other side would fetch the session and attach the connection if it&apos;s the second one, or create the session if it&apos;s the first one. The initiator could then start the prepare phase as soon as both connection are open (without waiting for any special message from the other side). Seems a bit simpler to me overall.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;

&lt;p&gt;The 2nd patch lgtm.&lt;/p&gt;</comment>
                            <comment id="13709391" author="yukim" created="Tue, 16 Jul 2013 02:37:19 +0000"  >&lt;p&gt;Uploaded update patches.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;0001 changes so that streaming initiator makes two connections. It also changes how StreamManager manages current connection in order to distinguish plans inside the same JVM (for bulkload JMX op and unit test).&lt;/li&gt;
	&lt;li&gt;0002 is updated for sstableloader command output.&lt;/li&gt;
	&lt;li&gt;0003 introduces change in how we create socket from streaming session. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5171&quot; title=&quot;Save EC2Snitch topology information in system table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5171&quot;&gt;&lt;del&gt;CASSANDRA-5171&lt;/del&gt;&lt;/a&gt; makes OutboundTCPConnection pool require system table which client like sstableloader doesn&apos;t have. Instead, I made newSocket static method so we just can obtain socket for specific host.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13709560" author="slebresne" created="Tue, 16 Jul 2013 07:13:44 +0000"  >&lt;p&gt;Looks mostly good. A couple of minor remarks/nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In ConnectionHandler, initiateOnReceivingSide and the pair attach(Incoming/Outgoing)Socket are basically duplicates. We should keep only one of them.&lt;/li&gt;
	&lt;li&gt;We use to call the StreamSession.start(Socket, ...) (the one on the receiving side) on the streamExecutor because it was creating a connection (and was thus blocking on I/O). Since it&apos;s not the case anymore, it&apos;s probably overkill. So we could ditch that whole start function and do the attachSocket in SRF.initReceivingSide, which would improve the symmetry of that function.&lt;/li&gt;
	&lt;li&gt;Does separating initiated and receiving stream in StreamManager really buys us anything? (outside slightly complicating things)&lt;/li&gt;
	&lt;li&gt;On failure (StreamSession.onError), we could (and probably should) send a message as long as the outgoing connection is opened (even if the incoming one is broken), so the current isConnected() is possibly a bit restrictive.&lt;/li&gt;
	&lt;li&gt;For consistency sake, can&apos;t we rename forOutput to isOutgoing everywhere, and same for isFirst in ConnectionHandler.sendInitMessage.&lt;/li&gt;
	&lt;li&gt;The comment on StreamInitMessage.isForOutgoing is outdated (talk of ACK, INIT_ACK)&lt;/li&gt;
	&lt;li&gt;The comment on on top StreamSession still talks of InitCompleteMessage.&lt;/li&gt;
	&lt;li&gt;The comment in IncomingStreamingSession still mentions INIT_ACK&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13711578" author="yukim" created="Wed, 17 Jul 2013 20:31:09 +0000"  >&lt;p&gt;Thanks for the review.&lt;br/&gt;
Updated 0001 patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Does separating initiated and receiving stream in StreamManager really buys us anything? (outside slightly complicating things)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We need to keep StreamResultFuture of the same plan ID when we are doing streaming on the same JVM. This happens when we bulk load via JMX method, or running StreamingTransferTest unit test.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;On failure (StreamSession.onError), we could (and probably should) send a message as long as the outgoing connection is opened (even if the incoming one is broken), so the current isConnected() is possibly a bit restrictive.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right. I changed to put null check on outgoing message handler before sending message instead.&lt;/p&gt;</comment>
                            <comment id="13712132" author="slebresne" created="Thu, 18 Jul 2013 08:32:34 +0000"  >&lt;p&gt;One last nit: In ConnectionHandler.sendMessage(), I don&apos;t like throwing messages on the floor without warning. I&apos;d rather add some isOutgoingConnected() method in ConnectionHandler and have the caller check that before calling sendMessage. And otherwise, sendMessage() would throw a RuntimeException in that case too.&lt;/p&gt;

&lt;p&gt;But other than that, lgtm, ship it!&lt;/p&gt;</comment>
                            <comment id="13712372" author="yukim" created="Thu, 18 Jul 2013 14:28:58 +0000"  >&lt;p&gt;Committed with above nit fix.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12592845" name="0001-change-streaming-procedure.patch" size="24373" author="yukim" created="Wed, 17 Jul 2013 20:31:09 +0000"/>
                            <attachment id="12592469" name="0002-make-BulkLoader-work-with-SSTableReader.patch" size="17156" author="yukim" created="Tue, 16 Jul 2013 02:37:19 +0000"/>
                            <attachment id="12592468" name="0003-update-for-post-CASSANDRA-5171.patch" size="5276" author="yukim" created="Tue, 16 Jul 2013 02:37:19 +0000"/>
                            <attachment id="12586548" name="5542-fix-NPE.txt" size="1450" author="yukim" created="Thu, 6 Jun 2013 18:37:08 +0000"/>
                            <attachment id="12585231" name="5542.txt" size="3804" author="yukim" created="Wed, 29 May 2013 15:55:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326655</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kcrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327000</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>