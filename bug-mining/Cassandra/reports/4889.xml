<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13797] RepairJob blocks on syncTasks</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13797</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The thread running &lt;tt&gt;RepairJob&lt;/tt&gt; blocks while it waits for the validations it starts to complete (&lt;a href=&quot;https://github.com/bdeggleston/cassandra/blob/9fdec0a82851f5c35cd21d02e8c4da8fc685edb2/src/java/org/apache/cassandra/repair/RepairJob.java#L185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;see here&lt;/a&gt;). However, the downstream callbacks (ie: the post-repair cleanup stuff) aren&apos;t waiting for &lt;tt&gt;RepairJob#run&lt;/tt&gt; to return, they&apos;re waiting for a result to be set on RepairJob the future, which happens after the sync tasks have completed. This post repair cleanup stuff also immediately shuts down the executor &lt;tt&gt;RepairJob#run&lt;/tt&gt; is running in. So in noop repair sessions, where there&apos;s nothing to stream, I&apos;m seeing the callbacks sometimes fire before &lt;tt&gt;RepairJob#run&lt;/tt&gt; wakes up, and causing an &lt;tt&gt;InterruptedException&lt;/tt&gt; is thrown.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure this can just be removed, but I&apos;d like a second opinion. This appears to just be a holdover from before repair coordination became async. I thought it might be doing some throttling by blocking, but each repair session gets it&apos;s own executor, and validation is  throttled by the fixed size executors doing the actual work of validation, so I don&apos;t think we need to keep this around.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13097450">CASSANDRA-13797</key>
            <summary>RepairJob blocks on syncTasks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="bdeggleston">Blake Eggleston</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Aug 2017 22:15:16 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:59 +0000</updated>
                            <resolved>Wed, 14 Mar 2018 12:56:03 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16140849" author="bdeggleston" created="Thu, 24 Aug 2017 22:23:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/13797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/bdeggleston/cassandra/104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/218/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16141688" author="krummas" created="Fri, 25 Aug 2017 14:27:17 +0000"  >&lt;p&gt;+1 (if the tests pass, I restarted the dtests)&lt;/p&gt;</comment>
                            <comment id="16146204" author="bdeggleston" created="Tue, 29 Aug 2017 21:54:39 +0000"  >&lt;p&gt;let&apos;s see if this one finishes: &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Edit: also aborted&lt;/p&gt;</comment>
                            <comment id="16162185" author="bdeggleston" created="Mon, 11 Sep 2017 22:54:56 +0000"  >&lt;p&gt;rebased on latest trunk: &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/295/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16163095" author="bdeggleston" created="Tue, 12 Sep 2017 15:10:25 +0000"  >&lt;p&gt;Adding 3.0 branch &amp;amp; tests since it&apos;s also affected.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/13797-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/bdeggleston/cassandra/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/302/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16164601" author="JIRAUSER308715" created="Wed, 13 Sep 2017 12:56:30 +0000"  >&lt;p&gt;If adding 3.0 you also need 3.11&lt;/p&gt;</comment>
                            <comment id="16165367" author="bdeggleston" created="Wed, 13 Sep 2017 22:06:42 +0000"  >&lt;p&gt;Got clean utest runs on 3.0, 3.11, and trunk. 3.0 and trunk dtest failures were either also failing in their respective parent branches, or not reproducible locally. Committed to 3.0 as &lt;tt&gt;e7299c08f940057e8fd4dfa3f24dcc6e0cb5f78d&lt;/tt&gt; and merged up&lt;/p&gt;</comment>
                            <comment id="16188407" author="jjirsa" created="Mon, 2 Oct 2017 16:35:01 +0000"  >&lt;p&gt;Please keep an eye on fixvers.&lt;/p&gt;</comment>
                            <comment id="16382839" author="vincentwhite" created="Thu, 1 Mar 2018 23:17:15 +0000"  >&lt;p&gt;Now that we don&apos;t wait for the validations of each repair job to finish before moving onto the next one, I don&apos;t see anything to stop the repair coordinator from spinning through all the token ranges and effectively triggering all the validations tasks at once, which could be a significant amount of validation compactions on each node depending on your topology and common ranges for that keyspace. I&apos;m also not sure of the overhead of creating all the futures/listeners on the coordinator at once in this case. &lt;/p&gt;

&lt;p&gt;In 3 the validation executor thread pool has no size limit so a new validation is started as soon as a validation request is received. I admit I haven&apos;t caught up on the changes to repair in trunk, and while the validation executor pool size is configurable in trunk, its default is still Integer.MAX_VALUE.&lt;/p&gt;

&lt;p&gt;I understand this same affect (hundreds of concurrent validations) can still happen if you trigger a repair across a keyspace with a large number of column families but with this change there is no way of avoiding it without using subrange repairs on a single column family (if you have a topology/replication that cant be merged into a small number of common ranges) .&lt;/p&gt;</comment>
                            <comment id="16382950" author="bdeggleston" created="Fri, 2 Mar 2018 01:04:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=VincentWhite&quot; class=&quot;user-hover&quot; rel=&quot;VincentWhite&quot;&gt;VincentWhite&lt;/a&gt; are you seeing this happen? It&apos;s been a little while since I&apos;ve thought about this, but I do remember worrying about something like&#160;and eventually convincing myself that this runaway validation case you&apos;re describing is prevented by something else.&lt;/p&gt;</comment>
                            <comment id="16383119" author="vincentwhite" created="Fri, 2 Mar 2018 03:43:11 +0000"  >&lt;p&gt;After upgrading an ~18 node, vnode multi-DC cluster from 3.11.0 to 3.11.1 it started seeing some nodes running hundreds of concurrent validation compactions, rolling back it went back to 1 concurrent validation per CF. I haven&apos;t had a chance to reproduce it at that scale but my locale testing show that if I have enough data, or just add a sleep(9999999) to validation compactions to simulate long validations, they continue to accumulate over a few seconds until the repair session has looped through all the common ranges. &lt;/p&gt;
</comment>
                            <comment id="16397897" author="kurtg" created="Wed, 14 Mar 2018 00:22:49 +0000"  >&lt;p&gt;This issue is actually pretty serious for anyone running vnodes and a mid sized cluster. This isn&apos;t the first time we&apos;ve had unbounded validation compactions kicked off simultaneously and it&apos;s caused a lot of problems at Instaclustr in the past. We should really fix this by 3.11.3 because it easily causes massive latency spikes whenever a repair kicks off due to validations taking up all the CPU. I&apos;d like a simple revert but that doesn&apos;t fix the issue in the description. Don&apos;t think this warrants a new ticket so I think reopening this one is in order. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="16398542" author="JIRAUSER308715" created="Wed, 14 Mar 2018 12:55:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; when a ticket has already gone out in a release we prefer to open a brand new ticket rather than re-open an existing one, as fix versions get confusing if you re-open and already released ticket.&lt;/p&gt;</comment>
                            <comment id="16398846" author="bdeggleston" created="Wed, 14 Mar 2018 16:35:19 +0000"  >&lt;p&gt;Agreed this should be a new ticket. Maybe the right fix is to backport&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13521&quot; title=&quot;Add configurable upper bound for validation executor threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13521&quot;&gt;&lt;del&gt;CASSANDRA-13521&lt;/del&gt;&lt;/a&gt; with concurrent validations set to something reasonable? I think the incorrect assumption of this ticket that&apos;s causing problems was that the validation executor was bounded, which obviously isn&apos;t&#160;the case.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13313454">CASSANDRA-15902</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13074995">CASSANDRA-13555</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13146727">CASSANDRA-14332</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j9hr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>