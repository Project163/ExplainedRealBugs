<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11765] dtest failure in upgrade_tests.upgrade_through_versions_test.ProtoV3Upgrade_AllVersions_Skips_3_0_x_EndsAt_Trunk_HEAD.rolling_upgrade_test</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11765</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Parameterized/job/upgrade_tests-all-custom_branch_runs/12/testReport/upgrade_tests.upgrade_through_versions_test/ProtoV3Upgrade_AllVersions_Skips_3_0_x_EndsAt_Trunk_HEAD/rolling_upgrade_test_2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Parameterized/job/upgrade_tests-all-custom_branch_runs/12/testReport/upgrade_tests.upgrade_through_versions_test/ProtoV3Upgrade_AllVersions_Skips_3_0_x_EndsAt_Trunk_HEAD/rolling_upgrade_test_2/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The test is seeing a corrupt hint sstable after upgrade from 2.2.5 to 3.6. Relevant stack trace is&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [main] 2016-05-11 16:22:25,180 CassandraDaemon.java:727 - Exception encountered during startup
java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /mnt/tmp/dtest-X7IReF/test/node1/data2/system/hints-2666e20573ef38b390fefecf96e8f0c7/la-3-big-Data.db
	at org.apache.cassandra.hints.LegacyHintsMigrator.forceCompaction(LegacyHintsMigrator.java:119) ~[main/:na]
	at org.apache.cassandra.hints.LegacyHintsMigrator.compactLegacyHints(LegacyHintsMigrator.java:108) ~[main/:na]
	at org.apache.cassandra.hints.LegacyHintsMigrator.migrate(LegacyHintsMigrator.java:92) ~[main/:na]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:321) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:581) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:710) [main/:na]
Caused by: java.util.concurrent.ExecutionException: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /mnt/tmp/dtest-X7IReF/test/node1/data2/system/hints-2666e20573ef38b390fefecf96e8f0c7/la-3-big-Data.db
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_51]
	at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_51]
	at org.apache.cassandra.hints.LegacyHintsMigrator.forceCompaction(LegacyHintsMigrator.java:115) ~[main/:na]
	... 5 common frames omitted
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /mnt/tmp/dtest-X7IReF/test/node1/data2/system/hints-2666e20573ef38b390fefecf96e8f0c7/la-3-big-Data.db
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator.computeNext(BigTableScanner.java:351) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator.computeNext(BigTableScanner.java:265) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner.hasNext(BigTableScanner.java:245) ~[main/:na]
	at org.apache.cassandra.utils.MergeIterator$OneToOne.computeNext(MergeIterator.java:463) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$2.hasNext(UnfilteredPartitionIterators.java:150) ~[main/:na]
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:72) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:226) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:182) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:82) ~[main/:na]
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionManager$10.runMayThrow(CompactionManager.java:805) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_51]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.8.0_51]
Caused by: java.io.EOFException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.io.util.RebufferingInputStream.readFully(RebufferingInputStream.java:68) ~[main/:na]
	at org.apache.cassandra.io.util.RebufferingInputStream.readFully(RebufferingInputStream.java:60) ~[main/:na]
	at org.apache.cassandra.io.util.TrackedDataInputPlus.readFully(TrackedDataInputPlus.java:93) ~[main/:na]
	at org.apache.cassandra.utils.ByteBufferUtil.read(ByteBufferUtil.java:400) ~[main/:na]
	at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:375) ~[main/:na]
	at org.apache.cassandra.db.Serializers$1.deserialize(Serializers.java:109) ~[main/:na]
	at org.apache.cassandra.db.Serializers$1.deserialize(Serializers.java:89) ~[main/:na]
	at org.apache.cassandra.io.sstable.IndexInfo$Serializer.deserialize(IndexInfo.java:135) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$IndexedEntry.&amp;lt;init&amp;gt;(RowIndexEntry.java:651) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$IndexedEntry.&amp;lt;init&amp;gt;(RowIndexEntry.java:577) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$LegacyShallowIndexedEntry.deserialize(RowIndexEntry.java:508) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$Serializer.deserialize(RowIndexEntry.java:321) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator.computeNext(BigTableScanner.java:310) ~[main/:na]
	... 19 common frames omitted
ERROR [CompactionExecutor:2] 2016-05-11 16:22:25,183 CassandraDaemon.java:213 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:2,1,main]
org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /mnt/tmp/dtest-X7IReF/test/node1/data2/system/hints-2666e20573ef38b390fefecf96e8f0c7/la-3-big-Data.db
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator.computeNext(BigTableScanner.java:351) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator.computeNext(BigTableScanner.java:265) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner.hasNext(BigTableScanner.java:245) ~[main/:na]
	at org.apache.cassandra.utils.MergeIterator$OneToOne.computeNext(MergeIterator.java:463) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$2.hasNext(UnfilteredPartitionIterators.java:150) ~[main/:na]
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:72) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:226) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:182) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:82) ~[main/:na]
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionManager$10.runMayThrow(CompactionManager.java:805) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_51]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_51]
Caused by: java.io.EOFException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.io.util.RebufferingInputStream.readFully(RebufferingInputStream.java:68) ~[main/:na]
	at org.apache.cassandra.io.util.RebufferingInputStream.readFully(RebufferingInputStream.java:60) ~[main/:na]
	at org.apache.cassandra.io.util.TrackedDataInputPlus.readFully(TrackedDataInputPlus.java:93) ~[main/:na]
	at org.apache.cassandra.utils.ByteBufferUtil.read(ByteBufferUtil.java:400) ~[main/:na]
	at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:375) ~[main/:na]
	at org.apache.cassandra.db.Serializers$1.deserialize(Serializers.java:109) ~[main/:na]
	at org.apache.cassandra.db.Serializers$1.deserialize(Serializers.java:89) ~[main/:na]
	at org.apache.cassandra.io.sstable.IndexInfo$Serializer.deserialize(IndexInfo.java:135) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$IndexedEntry.&amp;lt;init&amp;gt;(RowIndexEntry.java:651) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$IndexedEntry.&amp;lt;init&amp;gt;(RowIndexEntry.java:577) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$LegacyShallowIndexedEntry.deserialize(RowIndexEntry.java:508) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$Serializer.deserialize(RowIndexEntry.java:321) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator.computeNext(BigTableScanner.java:310) ~[main/:na]
	... 19 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Logs are attached&lt;/p&gt;</description>
                <environment></environment>
        <key id="12968662">CASSANDRA-11765</key>
            <summary>dtest failure in upgrade_tests.upgrade_through_versions_test.ProtoV3Upgrade_AllVersions_Skips_3_0_x_EndsAt_Trunk_HEAD.rolling_upgrade_test</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="philipthompson">Philip Thompson</reporter>
                        <labels>
                            <label>dtest</label>
                    </labels>
                <created>Thu, 12 May 2016 15:07:43 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:33 +0000</updated>
                            <resolved>Fri, 3 Jun 2016 14:32:42 +0000</resolved>
                                        <fixVersion>3.7</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15297296" author="mambocab" created="Mon, 23 May 2016 22:59:12 +0000"  >&lt;p&gt;For testing this for the 3.6 release, check out the &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/tree/upgrade_test_3.6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade_test_3.6 branch of the dtest repo&lt;/a&gt;, then run&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;UPGRADE_TEST_RUN=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; nosetests upgrade_tests/upgrade_through_versions_test..py:ProtoV3Upgrade_AllVersions_Skips_3_0_x_EndsAt_Trunk_HEAD.rolling_upgrade_test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15306431" author="stefania" created="Mon, 30 May 2016 09:25:50 +0000"  >&lt;p&gt;There is a regression introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11206&quot; title=&quot;Support large partitions on the 3.0 sstable format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11206&quot;&gt;&lt;del&gt;CASSANDRA-11206&lt;/del&gt;&lt;/a&gt;: &lt;tt&gt;LegacyShallowIndexedEntry&lt;/tt&gt; should not invoke &lt;tt&gt;new IndexedEntry(dataFilePosition, in, idxInfoSerializer, version, false);&lt;/tt&gt; when &lt;tt&gt;size &amp;lt;= DatabaseDescriptor.getColumnIndexCacheSize()&lt;/tt&gt; because that will deserialize an index entry according to the new format. Not sure if it is the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11763&quot; title=&quot;Failure to read non-shallow pre-3.0 sstable index entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11763&quot;&gt;&lt;del&gt;CASSANDRA-11763&lt;/del&gt;&lt;/a&gt;, but removing the special case fixes this specific problem, 3.6 patch &lt;a href=&quot;https://github.com/apache/cassandra/commit/1a43a195564f410e38317bf4aedd82739368e6b3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; could you take a look at the patch and incorporate in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11763&quot; title=&quot;Failure to read non-shallow pre-3.0 sstable index entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11763&quot;&gt;&lt;del&gt;CASSANDRA-11763&lt;/del&gt;&lt;/a&gt; if not already covered?&lt;/p&gt;

&lt;p&gt;Once the problem above is solved, there is then another issue, at least when running the test locally, which I am still working on:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  [main] 2016-05-30 10:21:08,461 LegacyHintsMigrator.java:88 - Migrating legacy hints to &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; storage
INFO  [main] 2016-05-30 10:21:08,462 LegacyHintsMigrator.java:91 - Forcing a major compaction of system.hints table
ERROR [CompactionExecutor:2] 2016-05-30 10:21:08,484 CassandraDaemon.java:213 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:2,1,main]
java.lang.UnsupportedOperationException: You can&apos;t mix sstables from different directories in a compaction
        at org.apache.cassandra.db.compaction.CompactionStrategyManager.validateForCompaction(CompactionStrategyManager.java:672) ~[main/:na]
        at org.apache.cassandra.db.compaction.CompactionStrategyManager.getUserDefinedTask(CompactionStrategyManager.java:718) ~[main/:na]
        at org.apache.cassandra.db.compaction.CompactionManager$10.runMayThrow(CompactionManager.java:803) ~[main/:na]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_91]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_91]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_91]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_91]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_91]
ERROR [main] 2016-05-30 10:21:08,486 CassandraDaemon.java:727 - Exception encountered during startup
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.UnsupportedOperationException: You can&apos;t mix sstables from different directories in a compaction
        at org.apache.cassandra.hints.LegacyHintsMigrator.forceCompaction(LegacyHintsMigrator.java:119) ~[main/:na]
        at org.apache.cassandra.hints.LegacyHintsMigrator.compactLegacyHints(LegacyHintsMigrator.java:108) ~[main/:na]
        at org.apache.cassandra.hints.LegacyHintsMigrator.migrate(LegacyHintsMigrator.java:92) ~[main/:na]
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:321) [main/:na]
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:581) [main/:na]
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:710) [main/:na]
Caused by: java.util.concurrent.ExecutionException: java.lang.UnsupportedOperationException: You can&apos;t mix sstables from different directories in a compaction
        at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_91]
        at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_91]
        at org.apache.cassandra.hints.LegacyHintsMigrator.forceCompaction(LegacyHintsMigrator.java:115) ~[main/:na]
        ... 5 common frames omitted
Caused by: java.lang.UnsupportedOperationException: You can&apos;t mix sstables from different directories in a compaction
        at org.apache.cassandra.db.compaction.CompactionStrategyManager.validateForCompaction(CompactionStrategyManager.java:672) ~[main/:na]
        at org.apache.cassandra.db.compaction.CompactionStrategyManager.getUserDefinedTask(CompactionStrategyManager.java:718) ~[main/:na]
        at org.apache.cassandra.db.compaction.CompactionManager$10.runMayThrow(CompactionManager.java:803) ~[main/:na]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_91]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_91]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_91]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_91]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.8.0_91]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, is this a new problem or a an existing one? If it is a valid new problem, do we change &lt;tt&gt;LegacyHintsMigrator&lt;/tt&gt; or the user defined compaction tasks?&lt;/p&gt;</comment>
                            <comment id="15306439" author="krummas" created="Mon, 30 May 2016 09:29:54 +0000"  >&lt;p&gt;this is probably a new issue&lt;/p&gt;</comment>
                            <comment id="15306480" author="snazy" created="Mon, 30 May 2016 10:19:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; the bug you describe is the one fixed in the branch for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11763&quot; title=&quot;Failure to read non-shallow pre-3.0 sstable index entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11763&quot;&gt;&lt;del&gt;CASSANDRA-11763&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The other thing (compaction on different directories) seems unrelated to 11763.&lt;/p&gt;</comment>
                            <comment id="15306554" author="stefania" created="Mon, 30 May 2016 11:40:42 +0000"  >&lt;p&gt;Thank you both, I&apos;ll work on a fix for the compaction in different directories then.&lt;/p&gt;</comment>
                            <comment id="15306711" author="stefania" created="Mon, 30 May 2016 14:33:22 +0000"  >&lt;p&gt;Here is a 3.6 patch that supports multiple folders for user defined compaction tasks (ignore the first commit which will be replaced by the patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11763&quot; title=&quot;Failure to read non-shallow pre-3.0 sstable index entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11763&quot;&gt;&lt;del&gt;CASSANDRA-11763&lt;/del&gt;&lt;/a&gt;):&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/11765-3.6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.6&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11765-3.6-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11765-3.6-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; could you check if it is correct when you have time? I am not too familiar with this part of the code.&lt;/p&gt;</comment>
                            <comment id="15306782" author="snazy" created="Mon, 30 May 2016 15:54:46 +0000"  >&lt;p&gt;Note: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11763&quot; title=&quot;Failure to read non-shallow pre-3.0 sstable index entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11763&quot;&gt;&lt;del&gt;CASSANDRA-11763&lt;/del&gt;&lt;/a&gt; is now committed.&lt;/p&gt;</comment>
                            <comment id="15307248" author="stefania" created="Tue, 31 May 2016 05:53:56 +0000"  >&lt;p&gt;Rebased, thank you.&lt;/p&gt;</comment>
                            <comment id="15311871" author="snazy" created="Thu, 2 Jun 2016 07:24:04 +0000"  >&lt;p&gt;From a brief look (cannot review the whole ticket at the moment):&lt;br/&gt;
Can you replace the &lt;tt&gt;CompletableFuture.runAsync&lt;/tt&gt; with one of &quot;our&quot; thread pools or better introduce a new shared executor service?&lt;br/&gt;
The &lt;tt&gt;catch (InterruptedException | ExecutionException e) { JVMStabilityInspector.inspectThrowable(e); ...&lt;/tt&gt; doesn&apos;t work as expected - you&apos;d need to pass &lt;tt&gt;((ExecutionException)e).getCause()&lt;/tt&gt; to &lt;tt&gt;JVMStabilityInspector&lt;/tt&gt;. However - I&apos;d prefer to add support for &lt;tt&gt;ExecutionException&lt;/tt&gt; to &lt;tt&gt;JVMStabilityInspector&lt;/tt&gt; since we have similar usages elsewhere.&lt;/p&gt;</comment>
                            <comment id="15311983" author="krummas" created="Thu, 2 Jun 2016 08:56:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can you replace the CompletableFuture.runAsync with one of &quot;our&quot; thread pools or better introduce a new shared executor service?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We could probably just run the tasks one after the other instead?&lt;/p&gt;

&lt;p&gt;And a code comment - in CompactionStrategyManager;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, List&amp;lt;SSTableReader&amp;gt;&amp;gt; group : repairedSSTables.entrySet())
    ret.add(repaired.get(group.getKey()).getUserDefinedTask(*sstables*, gcBefore));
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, List&amp;lt;SSTableReader&amp;gt;&amp;gt; group : unrepairedSSTables.entrySet())
    ret.add(unrepaired.get(group.getKey()).getUserDefinedTask(*sstables*, gcBefore));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;should be&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, List&amp;lt;SSTableReader&amp;gt;&amp;gt; group : repairedSSTables.entrySet())
    ret.add(repaired.get(group.getKey()).getUserDefinedTask(*group.getValue()*, gcBefore));
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, List&amp;lt;SSTableReader&amp;gt;&amp;gt; group : unrepairedSSTables.entrySet())
    ret.add(unrepaired.get(group.getKey()).getUserDefinedTask(*group.getValue()*, gcBefore));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And a dtest that runs a user defined compaction with sstables in different directories would be nice&lt;/p&gt;</comment>
                            <comment id="15312352" author="stefania" created="Thu, 2 Jun 2016 14:02:32 +0000"  >&lt;p&gt;Thank you for the review.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We could probably just run the tasks one after the other instead?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done. Previously they were running in the compaction executor and it would have been a problem with a single threaded executor.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And a code comment - in CompactionStrategyManager;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Comment added and typo fixed, thanks for spotting this.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The catch (InterruptedException | ExecutionException e) { JVMStabilityInspector.inspectThrowable(e); ... doesn&apos;t work as expected - you&apos;d need to pass ((ExecutionException)e).getCause() to JVMStabilityInspector. However - I&apos;d prefer to add support for ExecutionException to JVMStabilityInspector since we have similar usages elsewhere.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s no longer relevant but, why would it have been a problem given that JVMStabilityInspector.inspect() recursively calls itself if getClause() is not null?&lt;/p&gt;

&lt;p&gt;I&apos;ve rebased on 3.7 and cherry-picked to trunk:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.7&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/11765-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/11765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11765-3.7-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11765-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11765-3.7-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11765-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The tests are currently running on 3.7, if they are OK I will launch them on trunk as well. &lt;/p&gt;

&lt;p&gt;The new dtest is &lt;a href=&quot;https://github.com/stef1927/cassandra-dtest/commits/11765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and it is included in the CI jobs currently running.&lt;/p&gt;</comment>
                            <comment id="15312369" author="snazy" created="Thu, 2 Jun 2016 14:16:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;why would it have been a problem given that JVMStabilityInspector.inspect() recursively calls itself if getClause() is not null&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Oh! You&apos;re right! No problem then. Sorry for the confusion!&lt;/p&gt;</comment>
                            <comment id="15312383" author="stefania" created="Thu, 2 Jun 2016 14:21:01 +0000"  >&lt;p&gt;No worries, thanks for clarifying! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15313961" author="krummas" created="Fri, 3 Jun 2016 10:52:56 +0000"  >&lt;p&gt;LGTM, +1&lt;/p&gt;</comment>
                            <comment id="15314191" author="stefania" created="Fri, 3 Jun 2016 14:32:20 +0000"  >&lt;p&gt;Thank you, committed to 3.7 as 5a7ff5e32312426b63d9a8a5dc7fd58fa2ffb8ce and merged into trunk.&lt;/p&gt;</comment>
                            <comment id="15316236" author="stefania" created="Mon, 6 Jun 2016 06:28:45 +0000"  >&lt;p&gt;dtest pull request is &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12968611">CASSANDRA-11763</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12694767">CASSANDRA-6696</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12941116">CASSANDRA-11206</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12803676" name="node1.log" size="161549" author="philipthompson" created="Thu, 12 May 2016 15:07:43 +0000"/>
                            <attachment id="12803675" name="node1_debug.log" size="1761766" author="philipthompson" created="Thu, 12 May 2016 15:07:43 +0000"/>
                            <attachment id="12803678" name="node2.log" size="113490" author="philipthompson" created="Thu, 12 May 2016 15:07:43 +0000"/>
                            <attachment id="12803677" name="node2_debug.log" size="16819508" author="philipthompson" created="Thu, 12 May 2016 15:07:43 +0000"/>
                            <attachment id="12803680" name="node3.log" size="116533" author="philipthompson" created="Thu, 12 May 2016 15:07:43 +0000"/>
                            <attachment id="12803679" name="node3_debug.log" size="6924144" author="philipthompson" created="Thu, 12 May 2016 15:07:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xscn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>