<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15557] Fix flaky test org.apache.cassandra.cql3.validation.operations.AlterTest testDropListAndAddListWithSameName</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15557</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/jobs/github/dcapwell/cassandra/482/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/jobs/github/dcapwell/cassandra/482/tests&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: Invalid value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row 0 column 2 (mycollection of type list&amp;lt;text&amp;gt;), expected &amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&amp;gt; but got &amp;lt;[first element]&amp;gt;
	at org.apache.cassandra.cql3.CQLTester.assertRows(CQLTester.java:1070)
	at org.apache.cassandra.cql3.validation.operations.AlterTest.testDropListAndAddListWithSameName(AlterTest.java:91)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13283837">CASSANDRA-15557</key>
            <summary>Fix flaky test org.apache.cassandra.cql3.validation.operations.AlterTest testDropListAndAddListWithSameName</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rssvihla">Ryan Svihla</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 7 Feb 2020 05:47:25 +0000</created>
                <updated>Mon, 21 Dec 2020 08:08:16 +0000</updated>
                            <resolved>Mon, 16 Mar 2020 17:02:47 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17039318" author="brandon.williams" created="Tue, 18 Feb 2020 18:19:17 +0000"  >&lt;p&gt;So I started this test in a while loop, and forgot about it over the long (US) weekend.  The net effect is I ran this &lt;em&gt;many&lt;/em&gt; thousands of times without failure on java 8.  Is this still an issue?&lt;/p&gt;</comment>
                            <comment id="17039369" author="dcapwell" created="Tue, 18 Feb 2020 19:05:38 +0000"  >&lt;p&gt;Don&apos;t have a lot of history on trunk in CI, but of the history I can look at I have not seen it fail normally; the only sample I see is that Circle CI run.&lt;/p&gt;

&lt;p&gt;Here is the test in question&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testDropListAndAddListWithSameName() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (id text PRIMARY KEY, content text, myCollection list&amp;lt;text&amp;gt;);&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (id, content , myCollection) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;first test&apos;&lt;/span&gt;, [&lt;span class=&quot;code-quote&quot;&gt;&apos;first element&apos;&lt;/span&gt;]);&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE %s DROP myCollection;&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE %s ADD myCollection list&amp;lt;text&amp;gt;;&quot;&lt;/span&gt;);

        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s;&quot;&lt;/span&gt;), row(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;first test&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;));
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE %s set myCollection = [&lt;span class=&quot;code-quote&quot;&gt;&apos;second element&apos;&lt;/span&gt;] WHERE id = &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;;&quot;&lt;/span&gt;);
        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s;&quot;&lt;/span&gt;), row(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;first test&quot;&lt;/span&gt;, list(&lt;span class=&quot;code-quote&quot;&gt;&quot;second element&quot;&lt;/span&gt;)));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17039496" author="dcapwell" created="Tue, 18 Feb 2020 21:52:27 +0000"  >&lt;p&gt;I am hesitant to say to close since the type of error is data correctness; if this was a time out I would be fine closing if stable so frequently.&lt;/p&gt;

&lt;p&gt;The other annoying thing is nothing stands out in the logs &lt;a href=&quot;https://482-209217594-gh.circle-artifacts.com/1/logs/TEST-org.apache.cassandra.cql3.validation.operations.AlterTest.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://482-209217594-gh.circle-artifacts.com/1/logs/TEST-org.apache.cassandra.cql3.validation.operations.AlterTest.log&lt;/a&gt;. We don&apos;t log the select so hard to say what happened before and after that block (even if we did timing isn&apos;t perfect).  Also when I search for cql_test_keyspace.table_11 I see that we didn&apos;t flush the table, so this should be local to memtable and not sstable.&lt;/p&gt;</comment>
                            <comment id="17048991" author="rssvihla" created="Mon, 2 Mar 2020 10:11:30 +0000"  >&lt;p&gt;Seems real as I&apos;ve been able to reproduce a failure in a few environments&#160; just running the testsuite in a loop, it varies how frequently it happens. So far it seems the slower the env (fewer cores, less ram, etc) the more likely it happens.&lt;/p&gt;

&lt;p&gt;Using &lt;em&gt;while ant test -Dtest.name=AlterTest; do :; done&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;PerDiskMemtableFlushWriter_0:1&amp;#93;&lt;/span&gt; 2020-03-02 09:39:35,759 Memtable.java:483 - Completed flushing /home/debian/code/cassandra/build/test/cassandra/data:0/system_schema/keyspaces-abac5682dea631c5b535b3d6cffd0fb6/na-194-big-Data.db (0.035KiB) for commitlog position CommitLogPosition(segmentId=1583141964092, position=7807)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;MemtableFlushWriter:2&amp;#93;&lt;/span&gt; 2020-03-02 09:39:35,764 ColumnFamilyStore.java:1144 - Flushed to &lt;span class=&quot;error&quot;&gt;&amp;#91;BigTableReader(path=&amp;#39;/home/debian/code/cassandra/build/test/cassandra/data:0/system_schema/keyspaces-abac5682dea631c5b535b3d6cffd0fb6/na-194-big-Data.db&amp;#39;)&amp;#93;&lt;/span&gt; (1 sstables, 4.830KiB), biggest 4.830KiB, smallest 4.830KiB&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; ------------- ---------------- ---------------&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; Testcase: testDropListAndAddListWithSameName(org.apache.cassandra.cql3.validation.operations.AlterTest): FAILED&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; Invalid value for row 0 column 2 (mycollection of type list&amp;lt;text&amp;gt;), expected &amp;lt;null&amp;gt; but got &amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;first element&amp;#93;&lt;/span&gt;&amp;gt;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; junit.framework.AssertionFailedError: Invalid value for row 0 column 2 (mycollection of type list&amp;lt;text&amp;gt;), expected &amp;lt;null&amp;gt; but got &amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;first element&amp;#93;&lt;/span&gt;&amp;gt;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at org.apache.cassandra.cql3.CQLTester.assertRows(CQLTester.java:1070)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at org.apache.cassandra.cql3.validation.operations.AlterTest.testDropListAndAddListWithSameName(AlterTest.java:91)&lt;/tt&gt;&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; }}&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; }}&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; Test org.apache.cassandra.cql3.validation.operations.AlterTest FAILED&lt;/tt&gt;&lt;br/&gt;
 {{ &lt;span class=&quot;error&quot;&gt;&amp;#91;delete&amp;#93;&lt;/span&gt; Deleting directory /home/debian/code/cassandra/build/test/cassandra/commitlog:0}}&lt;br/&gt;
 {{ &lt;span class=&quot;error&quot;&gt;&amp;#91;delete&amp;#93;&lt;/span&gt; Deleting directory /home/debian/code/cassandra/build/test/cassandra/data:0}}&lt;br/&gt;
 {{ &lt;span class=&quot;error&quot;&gt;&amp;#91;delete&amp;#93;&lt;/span&gt; Deleting directory /home/debian/code/cassandra/build/test/cassandra/saved_caches:0}}&lt;br/&gt;
 {{ &lt;span class=&quot;error&quot;&gt;&amp;#91;delete&amp;#93;&lt;/span&gt; Deleting directory /home/debian/code/cassandra/build/test/cassandra/hints:0}}&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junitreport&amp;#93;&lt;/span&gt; Processing /home/debian/code/cassandra/build/test/TESTS-TestSuites.xml to /tmp/null291777528&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junitreport&amp;#93;&lt;/span&gt; Loading stylesheet jar:&lt;a href=&quot;file:/usr/share/ant/lib/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-frames.xsl&quot; title=&quot;file:///usr/share/ant/lib/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-frames.xsl&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/usr/share/ant/lib/ant-junit.jar!/org/apache/tools/ant/taskdefs/optional/junit/xsl/junit-frames.xsl&lt;/a&gt;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junitreport&amp;#93;&lt;/span&gt; Transform time: 483ms&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junitreport&amp;#93;&lt;/span&gt; Deleting: /tmp/null291777528&lt;/tt&gt;&lt;tt&gt;BUILD FAILED&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;/home/debian/code/cassandra/build.xml:1930: The following error occurred while executing this line:&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;/home/debian/code/cassandra/build.xml:1831: Some test(s) failed.&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17049232" author="rssvihla" created="Mon, 2 Mar 2020 13:59:39 +0000"  >&lt;p&gt;It would fit if this was a timestamp issue like the previous failing of this test (see&#160; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12997&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-12997&lt;/a&gt;) but I&apos;d expect to see it more on the faster machines than on the slower ones that I&apos;ve been able to repro this quickly with.&lt;/p&gt;</comment>
                            <comment id="17049477" author="dcapwell" created="Mon, 2 Mar 2020 17:33:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;So far it seems the slower the env (fewer cores, less ram, etc) the more likely it happens.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Makes sense, CI tends to run with limited resources; by default ~4 cores and ~4gb memory&lt;/p&gt;</comment>
                            <comment id="17051007" author="rssvihla" created="Wed, 4 Mar 2020 08:50:08 +0000"  >&lt;p&gt;[PR|&lt;a href=&quot;https://github.com/rssvihla/cassandra/pull/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rssvihla/cassandra/pull/1&lt;/a&gt;][Code|&lt;a href=&quot;https://github.com/rssvihla/cassandra/tree/failing-test-15557&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rssvihla/cassandra/tree/failing-test-15557&lt;/a&gt;]&lt;/p&gt;

&lt;p&gt;Ran the tests all night on two different servers and had no issues (whereas before on the same hardware I had 30 or 40 failures usually within 5 to 10 minute).&lt;/p&gt;

&lt;p&gt;The theory I have is this test got broken when the schema management changed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13426&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-13426&lt;/a&gt;&#160;and the test no longer was relying on client query state to set a timestamp as it was &lt;a href=&quot;#diff-43b2d530031e2f7ad4286bd05fed4ca0R253]&quot; title=&quot;https://github.com/pcmanus/cassandra/commit/020960d727b882349aff00c17a1c46bf3c7f7a24#diff-43b2d530031e2f7ad4286bd05fed4ca0R253&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;here&lt;/a&gt;and this logic appears to not have made it back in &lt;a href=&quot;#diff-50a7bf78bc4f943f42ce60c8768484a6R400]&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;here&lt;/a&gt; which meant an occasional tie, but maybe I&apos;m misreading it all, lots of code to go through in that PR.&lt;/p&gt;

&lt;p&gt;The fix I used was one of the two proposed in 12997 (ie just using manual time stamp).&lt;/p&gt;</comment>
                            <comment id="17051020" author="blerer" created="Wed, 4 Mar 2020 09:10:03 +0000"  >&lt;p&gt;It seems that something is wrong on your github &lt;tt&gt;here&lt;/tt&gt; github links. They bring me back to this page.&lt;/p&gt;</comment>
                            <comment id="17051025" author="rssvihla" created="Wed, 4 Mar 2020 09:15:52 +0000"  >&lt;p&gt;Not sure what&apos;s going on there, maybe some Jira macro run amok. Take 2&lt;/p&gt;

&lt;p&gt;Code as it was when the test was originally fixed&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/020960d727b882349aff00c17a1c46bf3c7f7a24#diff-43b2d530031e2f7ad4286bd05fed4ca0R253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pcmanus/cassandra/commit/020960d727b882349aff00c17a1c46bf3c7f7a24#diff-43b2d530031e2f7ad4286bd05fed4ca0R253&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;EDIT dunno why the highlight isn&apos;t being added to the links..&lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/020960d727b882349aff00c17a1c46bf3c7f7a24#diff-43b2d530031e2f7ad4286bd05fed4ca0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;src/java/org/apache/cassandra/cql3/statements/AlterTableStatement.java&lt;/a&gt; line 253&lt;/p&gt;

&lt;p&gt;Change below that I think stripped out the client state timestamp&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/207c80c1fd63dfbd8ca7e615ec8002ee8983c5d6#diff-50a7bf78bc4f943f42ce60c8768484a6R400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/207c80c1fd63dfbd8ca7e615ec8002ee8983c5d6#diff-50a7bf78bc4f943f42ce60c8768484a6R400&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;EDIT ( &lt;a href=&quot;https://github.com/apache/cassandra/commit/207c80c1fd63dfbd8ca7e615ec8002ee8983c5d6#diff-50a7bf78bc4f943f42ce60c8768484a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;src/java/org/apache/cassandra/cql3/statements/schema/AlterTableStatement.java&lt;/a&gt; line 400)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17051100" author="blerer" created="Wed, 4 Mar 2020 10:42:01 +0000"  >&lt;p&gt;I believe that the test is fine and should not be changed. The &lt;tt&gt;DroppedColum&lt;/tt&gt; should filter out every row with a timestamp less or equal to the &lt;tt&gt;DroppedColum.timestamp&lt;/tt&gt;. So even if the row and the &lt;tt&gt;DroppedColum&lt;/tt&gt; have the same timestamp, it should be ignored.&lt;br/&gt;
Now the interesting question is why if you fix the timestamps for the row and the dropped column, the test is not failing anymore? &lt;/p&gt;</comment>
                            <comment id="17051111" author="rssvihla" created="Wed, 4 Mar 2020 11:01:26 +0000"  >&lt;p&gt;Yes silly me, easy enough to prove when setting the timestamps to the same value the tests still pass, and just to totally eliminate weird side effects, setting the timestamp in reverse breaks the test as expected so I don&apos;t think there is anything specific about setting the timestamp to any value that makes it pass.&#160;&lt;/p&gt;

&lt;p&gt;So I&apos;m not sure I have a good theory as to why breaks in the first place. It does then act as if somehow the drop is happening &quot;before&quot; the insert. I&apos;ll keep digging thanks for the review.&lt;/p&gt;</comment>
                            <comment id="17052316" author="iamaleksey" created="Thu, 5 Mar 2020 16:38:46 +0000"  >&lt;p&gt;In 4.0 we get the timestamp from &lt;tt&gt;FBUtilities.timestampMicros()&lt;/tt&gt; unless it&apos;s been set explicitly by the user, so yes, the test can be racy as it used to be before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12997&quot; title=&quot;Use timestamp from ClientState by default in AlterTableStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12997&quot;&gt;&lt;del&gt;CASSANDRA-12997&lt;/del&gt;&lt;/a&gt;. Sylvain&apos;s explanation why in the first comment is still the most likely one. We derive &lt;tt&gt;timestampMicros()&lt;/tt&gt; from &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt;, and that &lt;b&gt;can&lt;/b&gt; walk back between the two statements&apos; executions.&lt;/p&gt;

&lt;p&gt;Now, it&apos;s tricker to reimplement the same logic in 4.0, so going for the second option of explicit timestamp would be my preferred way to resolve this issue.&lt;/p&gt;</comment>
                            <comment id="17052417" author="rssvihla" created="Thu, 5 Mar 2020 18:35:45 +0000"  >&lt;p&gt;Yep makes sense. I&apos;d feel better if I had some proof why it&apos;s happening now (logging more or copying out the dropped columns table makes it not happen on the boxes I&apos;ve replicated it with), but either way it can definitely happen with System.currentTimeMillis() and clock skew, and we&apos;d need to protect against that.&lt;/p&gt;

&lt;p&gt;I reopened my PR and restored my branch with the client side timestamp, simple fix: &lt;a href=&quot;https://github.com/rssvihla/cassandra/pull/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rssvihla/cassandra/pull/1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17053185" author="blerer" created="Fri, 6 Mar 2020 09:08:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Now, it&apos;s tricker to reimplement the same logic in 4.0, so going for the second option of explicit timestamp would be my preferred way to resolve this issue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It seems to me that we should be able to re-implement the same logic in &lt;tt&gt;AlterTableStatement.Raw.prepare&lt;/tt&gt; no?&lt;/p&gt;</comment>
                            <comment id="17054887" author="rssvihla" created="Mon, 9 Mar 2020 11:56:27 +0000"  >&lt;p&gt;So digging into the actual failure, this took a few tries as wrapping logging, or flushing sstables seemed to make it hard to reproduce, I&apos;ve confirmed it&apos;s time based errors at least in this case:&lt;/p&gt;

&lt;p&gt;row ts: &#160; &#160; &#160; &#160; &#160; &#160; 1583753957613001&lt;/p&gt;

&lt;p&gt;dropped time: &lt;tt&gt;1583753957613000&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;{{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; Testcase: testDropListAndAddListWithSameName(org.apache.cassandra.cql3.validation.operations.AlterTest): FAILED }}&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; Dropped column: {java.nio.HeapByteBuffer&lt;span class=&quot;error&quot;&gt;&amp;#91;pos=0 lim=12 cap=12&amp;#93;&lt;/span&gt;=DroppedColumn{column=mycollection, droppedTime=1583753957613000&lt;/tt&gt; Row timestamp: 1583753957613001 }}&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; junit.framework.AssertionFailedError: Dropped column: {java.nio.HeapByteBuffer&lt;span class=&quot;error&quot;&gt;&amp;#91;pos=0 lim=12 cap=12&amp;#93;&lt;/span&gt;=DroppedColumn{column=mycollection, droppedTime=1583753957613000&lt;/tt&gt; Row timestamp: 1583753957613001}}&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at org.apache.cassandra.cql3.validation.operations.AlterTest.testDropListAndAddListWithSameName(AlterTest.java:102) }}&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) }}&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) }}&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) }}&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; Caused by: java.lang.AssertionError: Invalid value for row 0 column 2 (mycollection of type list&amp;lt;text&amp;gt;), expected &amp;lt;null&amp;gt; but got &amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;first element&amp;#93;&lt;/span&gt;&amp;gt; }}&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at org.apache.cassandra.cql3.CQLTester.assertRows(CQLTester.java:1070)&lt;/tt&gt;&lt;br/&gt;
 {{&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; at org.apache.cassandra.cql3.validation.operations.AlterTest.testDropListAndAddListWithSameName(AlterTest.java:98) }}&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17054908" author="rssvihla" created="Mon, 9 Mar 2020 12:24:27 +0000"  >&lt;p&gt;So looking at the alter schema logic more:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/blob/08b2192da0eb6deddcd8f79cd180d069442223ae/src/java/org/apache/cassandra/cql3/statements/schema/AlterTableStatement.java#L398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/08b2192da0eb6deddcd8f79cd180d069442223ae/src/java/org/apache/cassandra/cql3/statements/schema/AlterTableStatement.java#L398&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/blob/08b2192da0eb6deddcd8f79cd180d069442223ae/src/java/org/apache/cassandra/cql3/statements/schema/AlterTableStatement.java#L411-L426&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/08b2192da0eb6deddcd8f79cd180d069442223ae/src/java/org/apache/cassandra/cql3/statements/schema/AlterTableStatement.java#L411-L426&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;it does seem (naively) reasonable to have it using the ClientState&apos;s getTimestamp() method in the AlterTableStatement since the ClientState is already there, but I&apos;m sure I&apos;m missing lots of background. &lt;/p&gt;

&lt;p&gt;Will wait for more experience people to weigh in.&lt;/p&gt;</comment>
                            <comment id="17054989" author="rssvihla" created="Mon, 9 Mar 2020 14:02:41 +0000"  >&lt;p&gt;New &lt;a href=&quot;https://github.com/apache/cassandra/pull/465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Note: I think this also happens to fix this behavior in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15303&quot; title=&quot;drop column statement should not initialize timestamp because of statement cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15303&quot;&gt;&lt;del&gt;CASSANDRA-15303&lt;/del&gt;&lt;/a&gt; and made a new Jira for the issue this causes with dropped columns and precision &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15626&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-15626&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17055110" author="blerer" created="Mon, 9 Mar 2020 15:53:28 +0000"  >&lt;p&gt;The patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="17055175" author="iamaleksey" created="Mon, 9 Mar 2020 16:30:30 +0000"  >&lt;p&gt;LGTM as well.&lt;/p&gt;</comment>
                            <comment id="17055189" author="blerer" created="Mon, 9 Mar 2020 16:42:49 +0000"  >&lt;p&gt;Sorry, there is an issue with the patch as pointed out by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; in  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15303&quot; title=&quot;drop column statement should not initialize timestamp because of statement cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15303&quot;&gt;&lt;del&gt;CASSANDRA-15303&lt;/del&gt;&lt;/a&gt;. The timestamp need to be set during the &lt;tt&gt;execution&lt;/tt&gt; phase and not during the &lt;tt&gt;prepare&lt;/tt&gt; one. Otherwise if the statement is prepared by the user it will reuse the same timestamp everytime it is executed. &lt;/p&gt;</comment>
                            <comment id="17055682" author="rssvihla" created="Tue, 10 Mar 2020 08:15:30 +0000"  >&lt;p&gt;I borrowed the code from 15303 and updated the PR. Some notes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There is an additional fix in there which is related to comparison of relations. This doesn&apos;t appear to be related to either Jira, but it makes sense at a glance, either way &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; added it and he can comment&lt;/li&gt;
	&lt;li&gt;Made ClientState.getTimestatmp() static and call it directly instead of FBUtilities.timestampMicros()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But I&apos;m also ok with someone first merging in 15303, then I can do another PR based on that code base just with the changes that use ClientState.getTimetamp() instead of FBUtilities.timestampMicros().&#160;&lt;/p&gt;</comment>
                            <comment id="17055793" author="iamaleksey" created="Tue, 10 Mar 2020 10:27:42 +0000"  >&lt;p&gt;Schema DDL statements aren&apos;t really meant to be prepared, as they don&apos;t even support bound variables, and there is no benefit to doing so, so I&apos;m not sure how much of an issue this is. But I guess one still could do that, sure.&lt;/p&gt;</comment>
                            <comment id="17060379" author="blerer" created="Mon, 16 Mar 2020 17:02:47 +0000"  >&lt;p&gt;Committed in trunk at 61b8a14a59e824854f87b54afc08289a3278942c&lt;/p&gt;</comment>
                            <comment id="17063152" author="jasonstack" created="Fri, 20 Mar 2020 07:51:27 +0000"  >&lt;p&gt;Should we change &lt;tt&gt;QueryState#getTimestamp()&lt;/tt&gt; to use class &lt;tt&gt;ClientState&lt;/tt&gt; instead of object &lt;tt&gt;clientState&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;I got some exception when running dtest locally...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [main] 2020-03-20 15:43:21,360 CassandraDaemon.java:789 - Exception encountered during startup
java.lang.IncompatibleClassChangeError: Expecting non-&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; method org.apache.cassandra.service.ClientState.getTimestamp()J
	at org.apache.cassandra.service.QueryState.getTimestamp(QueryState.java:71)
	at org.apache.cassandra.cql3.QueryOptions.getTimestamp(QueryOptions.java:199)
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:630)
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:624)
	at org.apache.cassandra.cql3.QueryProcessor.executeOnceInternal(QueryProcessor.java:358)
	at org.apache.cassandra.db.SystemKeyspace.persistLocalMetadata(SystemKeyspace.java:457)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:228)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:650)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:767)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17063226" author="blerer" created="Fri, 20 Mar 2020 09:25:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; &lt;tt&gt;java.lang.IncompatibleClassChangeError&lt;/tt&gt; is normally thrown when some client of a jar has not been recompiled while the jar has changed. Could you make sure that everything has been recompiled?&lt;/p&gt;</comment>
                            <comment id="17063235" author="jasonstack" created="Fri, 20 Mar 2020 09:33:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;&#160; &quot;ant realclean &amp;amp;&amp;amp; ant jar&quot; solves it.. thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[rssvihla]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0b8tk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
        <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/61b8a14a59e824854f87b54afc08289a3278942c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/61b8a14a59e824854f87b54afc08289a3278942c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;The patch is a fix for a flacky test.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>