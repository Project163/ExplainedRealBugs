<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2463] Flush and Compaction Unnecessarily Allocate 256MB Contiguous Buffers</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2463</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently, Cassandra 0.7.x allocates a 256MB contiguous byte array at the beginning of a memtable flush or compaction (presently hard-coded as Config.in_memory_compaction_limit_in_mb). When several memtable flushes are triggered at once (as by `nodetool flush` or `nodetool snapshot`), the tenured generation will typically experience extreme pressure as it attempts to locate &lt;span class=&quot;error&quot;&gt;&amp;#91;n&amp;#93;&lt;/span&gt; contiguous 256mb chunks of heap to allocate. This will often trigger a promotion failure, resulting in a stop-the-world GC until the allocation can be made. (Note that in the case of the &quot;release valve&quot; being triggered, the problem is even further exacerbated; the release valve will ironically trigger two contiguous 256MB allocations when attempting to flush the two largest memtables).&lt;/p&gt;

&lt;p&gt;This patch sets the buffer to be used by BufferedRandomAccessFile to Math.min(bytesToWrite, BufferedRandomAccessFile.DEFAULT_BUFFER_SIZE) rather than a hard-coded 256MB. The typical resulting buffer size is 64kb.&lt;/p&gt;

&lt;p&gt;I&apos;ve taken some time to measure the impact of this change on the base 0.7.4 release and with this patch applied. This test involved launching Cassandra, performing four million writes across three column families from three clients, and monitoring heap usage and garbage collections. Cassandra was launched with 2GB of heap and the default JVM options shipped with the project. This configuration has 7 column families with a total of 15GB of data.&lt;/p&gt;

&lt;p&gt;Here&apos;s the base 0.7.4 release:&lt;br/&gt;
&lt;a href=&quot;http://cl.ly/413g2K06121z252e2t10&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cl.ly/413g2K06121z252e2t10&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Note that on launch, we see a flush + compaction triggered almost immediately, resulting in at least 7x very quick 256MB allocations maxing out the heap, resulting in a promotion failure and a full GC. As flushes proceeed, we see that most of these have a corresponding CMS, consistent with the pattern of a large allocation and immediate collection. We see a second promotion failure and full GC at the 75% mark as the allocations cannot be satisfied without a collection, along with several CMSs in between. In the failure cases, the allocation requests occur so quickly that a standard CMS phase cannot completed before a ParNew attempts to promote the surviving byte array into the tenured generation. The heap usage and GC profile of this graph is very unhealthy.&lt;/p&gt;

&lt;p&gt;Here&apos;s the 0.7.4 release with this patch applied:&lt;br/&gt;
&lt;a href=&quot;http://cl.ly/050I1g26401B1X0w3s1f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cl.ly/050I1g26401B1X0w3s1f&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This graph is very different. At launch, rather than a immediate spike to full allocation and a promotion failure, we see a slow allocation slope reaching only 1/8th of total heap size. As writes begin, we see several flushes and compactions, but none result in immediate, large allocations. The ParNew collector keeps up with collections far more ably, resulting in only one healthy CMS collection with no promotion failure. Unlike the unhealthy rapid allocation and massive collection pattern we see in the first graph, this graph depicts a healthy sawtooth pattern of ParNews and an occasional effective CMS with no danger of heap fragmentation resulting in a promotion failure.&lt;/p&gt;

&lt;p&gt;The bottom line is that there&apos;s no need to allocate a hard-coded 256MB write buffer for flushing memtables and compactions to disk. Doing so results in unhealthy rapid allocation patterns and increases the probability of triggering promotion failures and full stop-the-world GCs which can cause nodes to become unresponsive and shunned from the ring during flushes and compactions.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Any&lt;/p&gt;</environment>
        <key id="12504105">CASSANDRA-2463</key>
            <summary>Flush and Compaction Unnecessarily Allocate 256MB Contiguous Buffers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cscotta">C. Scott Andreas</assignee>
                                    <reporter username="cscotta">C. Scott Andreas</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Apr 2011 21:23:43 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:02 +0000</updated>
                            <resolved>Wed, 13 Apr 2011 05:34:31 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="259200">72h</timeoriginalestimate>
                            <timeestimate seconds="259200">72h</timeestimate>
                                        <comments>
                            <comment id="13019062" author="cscotta" created="Tue, 12 Apr 2011 21:26:37 +0000"  >&lt;p&gt;[ Patch attached ]&lt;/p&gt;</comment>
                            <comment id="13019064" author="cscotta" created="Tue, 12 Apr 2011 21:28:22 +0000"  >&lt;p&gt;Patch attached. Applies cleanly to tag &apos;cassandra-0.7.4&apos;. All tests pass.&lt;/p&gt;</comment>
                            <comment id="13019078" author="jbellis" created="Tue, 12 Apr 2011 22:07:20 +0000"  >&lt;p&gt;I started making it more complicated:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// the gymnastics here are because
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//  - we want the buffer large enough that we&apos;re not re-buffering when we have to seek back to the
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//    start of a row to write the data size.  Here, &lt;span class=&quot;code-quote&quot;&gt;&quot;10% larger than the average row&quot;&lt;/span&gt; is &lt;span class=&quot;code-quote&quot;&gt;&quot;large enough,&quot;&lt;/span&gt;
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//    meaning we expect to seek and rebuffer about 1/10 of the time.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//  - but we don&apos;t want to allocate a huge buffer unnecessarily &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a small amount of data
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//  - and on the low end, we don&apos;t want to be absurdly stingy with the buffer size &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; small rows
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; estimatedSize &amp;gt; 0;
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; maxBufferSize = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(DatabaseDescriptor.getInMemoryCompactionLimit(), 1024 * 1024);
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bufferSize;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (estimatedSize &amp;lt; 64 * 1024)
        {
            bufferSize = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) estimatedSize;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; estimatedRowSize = estimatedSize / keyCount;
            bufferSize = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(1.1 * estimatedRowSize, 64 * 1024), maxBufferSize);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...  but the larger our buffer is, the larger the penalty for guessing wrong when we have to seek back and rebuffer.&lt;/p&gt;

&lt;p&gt;Then I went through and added size estimation to the CompactionManager, until I thought &quot;it&apos;s kind of ridiculous to be worrying about saving a few bytes less than 64KB, especially when we expect most memtables to have more data in them than 64K when flushed.&quot;&lt;/p&gt;

&lt;p&gt;Thus, I arrived at the patch Antoine de Saint-Exupery would have written, attached as v2.&lt;/p&gt;</comment>
                            <comment id="13019097" author="scode" created="Tue, 12 Apr 2011 22:44:16 +0000"  >&lt;p&gt;A noteworthy factor here is that unless an fsync()+fadvise()/madvise() have evicted data, in the normal case this stuff should still be in page cache for any reasonably sized row. For truly huge rows, the penalty of seeking back should be insignificant anyway.&lt;/p&gt;

&lt;p&gt;Total +1 on avoiding huge allocations. I was surprised to realize, when this ticket came along, that this was happening &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I have been suspecting that the bloom filters are a major concern too with respect to triggering promotion failures (but I haven&apos;t done testing to confirm this). Are there other cases than this and the bloom filters where we know that we&apos;re doing large allocations?&lt;/p&gt;</comment>
                            <comment id="13019122" author="jbellis" created="Tue, 12 Apr 2011 23:58:53 +0000"  >&lt;p&gt;(I wonder if this is the cause of the intermittent load-spikes-after-upgrade-to-0.7 reports we&apos;ve seen.)&lt;/p&gt;</comment>
                            <comment id="13019152" author="eonnen" created="Wed, 13 Apr 2011 00:56:11 +0000"  >&lt;p&gt;As a data point to that question, we hardly ever had CMS collections on 0.6.8 and maybe one full GC ever that I can think of for what was years of cumulative uptime. It surely differs for workloads, but in our case 0.7 got much worse along the CMS dimension.&lt;/p&gt;</comment>
                            <comment id="13019179" author="scode" created="Wed, 13 Apr 2011 03:45:50 +0000"  >&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2466&quot; title=&quot;bloom filters should avoid huge array allocations to avoid fragmentation concerns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2466&quot;&gt;&lt;del&gt;CASSANDRA-2466&lt;/del&gt;&lt;/a&gt; for the bloom filter case.&lt;/p&gt;</comment>
                            <comment id="13019211" author="jbellis" created="Wed, 13 Apr 2011 05:34:31 +0000"  >&lt;p&gt;First time I got a +1 via Twitter: &lt;a href=&quot;http://twitter.com/#!/cscotta/status/58031493565513728&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://twitter.com/#!/cscotta/status/58031493565513728&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;committed.&lt;/p&gt;</comment>
                            <comment id="13019212" author="jbellis" created="Wed, 13 Apr 2011 05:34:50 +0000"  >&lt;p&gt;Thanks for tracking this down, Scott and Erik!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476182" name="2463-v2.txt" size="828" author="jbellis" created="Tue, 12 Apr 2011 22:07:20 +0000"/>
                            <attachment id="12476177" name="patch.diff" size="4524" author="cscotta" created="Tue, 12 Apr 2011 21:28:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[cscotta]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20638</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbiv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93297</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>