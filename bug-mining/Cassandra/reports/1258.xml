<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:26:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3399] Truncate disregards running compactions when deleting sstables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3399</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;All truncation do is `cfs.markCompacted(truncatedSSTables)` without holding any lock or anything. Which have the effect of actually deleting sstables that may be compacting. More precisely there is three problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;It removes those compacting sstables from the current set of active sstables for the cfs. But when they are done compacting, DataTracker.replaceCompactedSSTables() will be called and it assumes that the compacted sstable are parts of the current set of active sstables. In other words, we&apos;ll get an exception looking like the one of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3306&quot; title=&quot;Failed streaming may cause duplicate SSTable reference&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3306&quot;&gt;&lt;del&gt;CASSANDRA-3306&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;The result of the compaction will be added as a new active sstable (actually no, because the code will throw an exception before because of the preceding point, but that&apos;s something we should probably deal with).&lt;/li&gt;
	&lt;li&gt;Currently, compaction don&apos;t &apos;acquire references&apos; on SSTR. That&apos;s because the code assumes we won&apos;t compact twice the same sstable and that compaction is the only mean to delete an sstable. With these two assumption, acquiring references is not necessary, but truncate break that first assumption.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As for solution, I see two possibilities:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;make the compaction lock be per-cf instead of global (which I think is easy and a good idea anyway) and grab the write lock to do the markCompacted call. The big downside is that truncation will potentially take much longer.&lt;/li&gt;
	&lt;li&gt;had two phases: mark the sstable that are not compacting as compacted and set the dataTracker as &apos;truncated at&apos;, and let it deal with the other sstable when their compaction is done. A bit like what is proposed for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3116&quot; title=&quot;Compactions can (seriously) delay schema migrations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3116&quot;&gt;&lt;del&gt;CASSANDRA-3116&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12528489">CASSANDRA-3399</key>
            <summary>Truncate disregards running compactions when deleting sstables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Oct 2011 14:24:02 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:47 +0000</updated>
                            <resolved>Mon, 31 Oct 2011 22:10:10 +0000</resolved>
                                        <fixVersion>0.8.8</fixVersion>
                    <fixVersion>1.0.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13136140" author="jbellis" created="Wed, 26 Oct 2011 17:42:33 +0000"  >&lt;p&gt;I think we should:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;grab the Big Lock for this ticket&lt;/li&gt;
	&lt;li&gt;create another ticket to take a 3116 approach in 1.1&lt;/li&gt;
	&lt;li&gt;create another ticket to break the Big Lock apart to a per-CF lock in 1.0.2&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13140280" author="jbellis" created="Mon, 31 Oct 2011 16:32:36 +0000"  >&lt;p&gt;created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3429&quot; title=&quot;Fix truncate/compaction race without locking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3429&quot;&gt;&lt;del&gt;CASSANDRA-3429&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3430&quot; title=&quot;Break Big Compaction Lock apart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3430&quot;&gt;&lt;del&gt;CASSANDRA-3430&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13140287" author="jbellis" created="Mon, 31 Oct 2011 16:41:45 +0000"  >&lt;p&gt;big lock patch attached.&lt;/p&gt;</comment>
                            <comment id="13140288" author="jbellis" created="Mon, 31 Oct 2011 16:42:53 +0000"  >&lt;p&gt;(patch is against 1.0, will also commit to 0.8)&lt;/p&gt;</comment>
                            <comment id="13140296" author="jbellis" created="Mon, 31 Oct 2011 16:48:16 +0000"  >&lt;p&gt;new patch w/ less crack smoking&lt;/p&gt;</comment>
                            <comment id="13140308" author="slebresne" created="Mon, 31 Oct 2011 16:52:22 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13140618" author="jbellis" created="Mon, 31 Oct 2011 22:10:10 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13140722" author="hudson" created="Tue, 1 Nov 2011 00:24:00 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #391 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/391/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/391/&lt;/a&gt;)&lt;br/&gt;
    acquire compactionlock during truncate&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3399&quot; title=&quot;Truncate disregards running compactions when deleting sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3399&quot;&gt;&lt;del&gt;CASSANDRA-3399&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1195695&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1195695&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/CompactionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12501633" name="3399.txt" size="1698" author="jbellis" created="Mon, 31 Oct 2011 16:48:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>214349</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gjf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94576</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>