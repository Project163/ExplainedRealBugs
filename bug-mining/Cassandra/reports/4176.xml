<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11168] Hint Metrics are updated even if hinted_hand-offs=false</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11168</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In our PROD logs, we noticed a lot of hint metrics even though we have disabled hinted handoffs.&lt;/p&gt;

&lt;p&gt;The reason is StorageProxy.ShouldHint has an inverted if condition. &lt;br/&gt;
We should also wrap the if (hintWindowExpired) block in if (DatabaseDescriptor.hintedHandoffEnabled()).&lt;/p&gt;

&lt;p&gt;The fix is easy, and I can provide a patch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12938953">CASSANDRA-11168</key>
            <summary>Hint Metrics are updated even if hinted_hand-offs=false</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anubhavk">Anubhav Kale</assignee>
                                    <reporter username="anubhavk">Anubhav Kale</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Feb 2016 22:52:57 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:02 +0000</updated>
                            <resolved>Mon, 14 Mar 2016 22:09:21 +0000</resolved>
                                        <fixVersion>2.2.6</fixVersion>
                    <fixVersion>3.0.5</fixVersion>
                    <fixVersion>3.5</fixVersion>
                                    <component>Legacy/Coordination</component>
                    <component>Legacy/Observability</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15154317" author="jmckenzie" created="Fri, 19 Feb 2016 15:07:42 +0000"  >&lt;p&gt;A patch would be great. We&apos;ll get a reviewer for that when you have that available.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15172286" author="jkni" created="Mon, 29 Feb 2016 18:17:14 +0000"  >&lt;p&gt;This doesn&apos;t look quite right to me yet.&lt;/p&gt;

&lt;p&gt;The metric &lt;tt&gt;incrPastWindow&lt;/tt&gt; pre-patch simply records all the times shouldHint failed. Under this understanding, the current behavior is fine. If we want to change this behavior to only times we are past the window, we should remove all instances of the metric incr except those inside the hintWindowExpired block. Under the current patch, the metric will always be incremented if Hinted Handoff is enabled and possibly again if hintWindowExpired or if hinted handoff is disabled for the specific DC.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; - since you did the most work with hinted handoff most recently, do you have an opinion on what this metric should reflect? Current implementation of the incrPastWindow metric counts the times shouldHint fails because of either hints being disabled or hint window expiration. This issue could be used to change the metric to only be incremented when the hint window has ended.&lt;/p&gt;</comment>
                            <comment id="15173961" author="iamaleksey" created="Tue, 1 Mar 2016 16:13:50 +0000"  >&lt;p&gt;I don&apos;t think this really matters. That said, I&apos;m slightly inclined towards making the suggested change (only increment if hints are both enabled and past window).&lt;/p&gt;</comment>
                            <comment id="15174002" author="jkni" created="Tue, 1 Mar 2016 16:45:00 +0000"  >&lt;p&gt;Works for me.&lt;/p&gt;

&lt;p&gt;A patch for both 2.2 and 3.0+ would be appreciated &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anubhavk&quot; class=&quot;user-hover&quot; rel=&quot;anubhavk&quot;&gt;anubhavk&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15176707" author="anubhavk" created="Wed, 2 Mar 2016 23:27:26 +0000"  >&lt;p&gt;So, making sure I understand Aleksey&apos;s thought this correctly, what we want is below. Can you confirm (only increment if hint window expired) ?&lt;/p&gt;

&lt;p&gt;if (DatabaseDescriptor.hintedHandoffEnabled())&lt;br/&gt;
		{&lt;br/&gt;
			Set&amp;lt;String&amp;gt; disabledDCs = DatabaseDescriptor.hintedHandoffDisabledDCs();&lt;br/&gt;
			if (!disabledDCs.isEmpty())&lt;br/&gt;
			{&lt;br/&gt;
				final String dc = DatabaseDescriptor.getEndpointSnitch().getDatacenter(ep);&lt;br/&gt;
				if (disabledDCs.contains(dc))&lt;br/&gt;
				{&lt;br/&gt;
					Tracing.trace(&quot;Not hinting {} since its data center {} has been disabled {}&quot;, ep, dc, disabledDCs);&lt;/p&gt;

&lt;p&gt;					return false;&lt;br/&gt;
				}&lt;br/&gt;
			}&lt;/p&gt;

&lt;p&gt;			boolean hintWindowExpired = Gossiper.instance.getEndpointDowntime(ep) &amp;gt; DatabaseDescriptor.getMaxHintWindow();&lt;br/&gt;
			if (hintWindowExpired)&lt;br/&gt;
			{&lt;br/&gt;
				HintsService.instance.metrics.incrPastWindow(ep);&lt;br/&gt;
				Tracing.trace(&quot;Not hinting {} which has been down {} ms&quot;, ep, Gossiper.instance.getEndpointDowntime(ep));&lt;br/&gt;
			}&lt;br/&gt;
			return !hintWindowExpired;&lt;br/&gt;
		}&lt;br/&gt;
		else&lt;/p&gt;
		{
			return false;
		}</comment>
                            <comment id="15183387" author="jkni" created="Mon, 7 Mar 2016 18:19:41 +0000"  >&lt;p&gt;Yes, this accomplishes the desired behavior with regard to the metric.&lt;/p&gt;

&lt;p&gt;It isn&apos;t clear to me why the changes to the scope of the if from the original code are needed. Is there a change in logical behavior or is it just a suggested code style change?&lt;/p&gt;

&lt;p&gt;I think a patch that simply removes the metric increment in the case of early returns due to hinted handoff being disabled would be sufficient.&lt;/p&gt;</comment>
                            <comment id="15188197" author="anubhavk" created="Wed, 9 Mar 2016 22:24:26 +0000"  >&lt;p&gt;Updated patch. Not really sure if its really necessary to be back-ported though.&lt;/p&gt;</comment>
                            <comment id="15189739" author="anubhavk" created="Thu, 10 Mar 2016 18:58:30 +0000"  >&lt;p&gt;I have attached for 2.2 as well.&lt;/p&gt;</comment>
                            <comment id="15189764" author="jkni" created="Thu, 10 Mar 2016 19:11:25 +0000"  >&lt;p&gt;The 3.0 patch is pretty close - it just needs a few tweaks.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It looks like the boolean condition around hintedHandoffEnabled() is inverted - if we&apos;re moving all the following code inside the if, it should only be run when hinted handoff is enabled, not the opposite.&lt;/li&gt;
	&lt;li&gt;It looks like we still increment the metric when we decide not to hint because hints are disabled for a specific datacenter. We shouldn&apos;t do this.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The version from your comment above doesn&apos;t have these problems; if you want me to make a patch out of that, I can.&lt;/p&gt;

&lt;p&gt;EDIT: Both patches (2.2 and revised 3.0) look good. 3.0 merges cleanly through 3.5 and trunk. CI here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/11168-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11168-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-11168-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-11168-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/11168-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11168-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-11168-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-11168-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15189855" author="anubhavk" created="Thu, 10 Mar 2016 19:56:07 +0000"  >&lt;p&gt;My bad on the trunk patch. Updated. &lt;/p&gt;</comment>
                            <comment id="15193558" author="jkni" created="Mon, 14 Mar 2016 16:21:47 +0000"  >&lt;p&gt;+1. CI looks clean - I ran for 2.2, 3.0, 3.5, and trunk.&lt;/p&gt;

&lt;p&gt;For committer: there are two patches to be applied. One for 2.2 and one for 3.0+. These are the two most recent patches attached to the issue. The 2.2 patch is attached to the issue as 0001-Hinted-Handoff-fix-2_2.patch. The 3.0+ patch is attached to the issue as 0001-Hinted-handoffs-fix.patch. This patch should merge forward cleanly up to trunk.&lt;/p&gt;</comment>
                            <comment id="15194260" author="jmckenzie" created="Mon, 14 Mar 2016 22:09:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=719caa67649bf6f27cdd99dd7d6055d2aa8546ae&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Committed&lt;/a&gt;, with some whitespace and formatting fixes on the 3.0 patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12788750" name="0001-Hinted-Handoff-Fix.patch" size="2890" author="anubhavk" created="Fri, 19 Feb 2016 20:50:01 +0000"/>
                            <attachment id="12792562" name="0001-Hinted-Handoff-fix-2_2.patch" size="2524" author="anubhavk" created="Thu, 10 Mar 2016 18:58:19 +0000"/>
                            <attachment id="12792364" name="0001-Hinted-handoff-metrics.patch" size="2740" author="anubhavk" created="Wed, 9 Mar 2016 22:23:54 +0000"/>
                            <attachment id="12792574" name="0001-Hinted-handoffs-fix.patch" size="2792" author="anubhavk" created="Thu, 10 Mar 2016 19:55:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[anubhavk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ssqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jkni</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jkni]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>