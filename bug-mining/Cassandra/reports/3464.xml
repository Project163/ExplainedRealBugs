<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8672] Ambiguous WriteTimeoutException while completing pending CAS commits</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8672</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Any CAS update has a chance to trigger a pending/stalled commit of any previously agreed on CAS update. After completing the pending commit, the CAS operation will resume to execute the actual update and also possibly create a new commit. See StorageProxy.cas()&lt;/p&gt;

&lt;p&gt;Theres two possbile execution paths that might end up throwing a WriteTimeoutException:&lt;br/&gt;
cas() -&amp;gt; beginAndRepairPaxos() -&amp;gt; commitPaxos()&lt;br/&gt;
cas() -&amp;gt; commitPaxos()&lt;/p&gt;

&lt;p&gt;Unfortunatelly clients catching a WriteTimeoutException won&apos;t be able to tell at which stage the commit failed. My guess would be that most developers are not aware that the beginAndRepairPaxos() could also trigger a write and assume that write timeouts would refer to a timeout while writting the actual CAS update. Its therefor not safe to assume that successive CAS or SERIAL read operations will cause a (write-)timeouted CAS operation to get eventually applied. Although some &lt;a href=&quot;http://www.datastax.com/dev/blog/cassandra-error-handling-done-right&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;best-practices advise&lt;/a&gt; claims otherwise.&lt;/p&gt;

&lt;p&gt;At this point the safest bet is possibly to retry the complete business transaction in case of an WriteTimeoutException. However, as theres a chance that the timeout occurred while writing the actual CAS operation, another write could potentially complete it and our CAS condition will get a different result upon retry.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12769600">CASSANDRA-8672</key>
            <summary>Ambiguous WriteTimeoutException while completing pending CAS commits</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="spod">Stefan Podkowinski</assignee>
                                    <reporter username="spod">Stefan Podkowinski</reporter>
                        <labels>
                            <label>CAS</label>
                            <label>LWT</label>
                    </labels>
                <created>Fri, 23 Jan 2015 09:45:08 +0000</created>
                <updated>Fri, 25 Oct 2019 13:11:39 +0000</updated>
                            <resolved>Wed, 1 Apr 2015 19:53:08 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14389063" author="thobbs" created="Tue, 31 Mar 2015 18:19:00 +0000"  >&lt;p&gt;I think the best option is to add a new &lt;tt&gt;WriteType.CAS_PREPARE&lt;/tt&gt; for the v4 protocol (and continue to use &lt;tt&gt;WriteType.CAS&lt;/tt&gt; for v1 through v3).  If we timeout during &lt;tt&gt;beginAndRepairPaxos()&lt;/tt&gt;, we use &lt;tt&gt;WriteType.CAS_PREPARE&lt;/tt&gt; for the WriteTimeoutException. What do you think, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14390450" author="slebresne" created="Wed, 1 Apr 2015 11:41:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;Its therefor not safe to assume that successive CAS or SERIAL read operations will cause a (write-)timeouted CAS operation to get eventually applied.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The only case where you can assume that is if the timeout happens during the &lt;tt&gt;commitPaxos&lt;/tt&gt; phase. But we already distinguish timeouts in that case since they have a &lt;tt&gt;WriteType.SIMPLE&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;However, as theres a chance that the timeout occurred while writing the actual CAS operation, another write could potentially complete it and our CAS condition will get a different result upon retry.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that &lt;b&gt;is&lt;/b&gt; a problem you have to deal with at the application level. But no amount of disambiguation of &lt;tt&gt;WriteTimeoutException&lt;/tt&gt; will remove this: if there is a timeout during the &quot;propose&quot; phase, we just don&apos;t know if the write will be eventually applied or not. In other words, in many cases, the retry mechanism that you&apos;ll have to implement client side will involve a SERIAL read to figure out if the write was applied or not.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the best option is to add a new &lt;tt&gt;WriteType.CAS_PREPARE&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We could add a different &lt;tt&gt;WriteType&lt;/tt&gt; if the timeout is during the prepare phase, and client could have an easier time retrying in that case since they can assume the update hasn&apos;t been applied, but as said above, this would change the fact that you will have to handle timeouts during the propose phase the hard way. And given that you have to do the latter, I wonder how meaningful it is to optimize for the former. I also don&apos;t know if that kind of subtle difference will still make sense post-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6246&quot; title=&quot;EPaxos&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6246&quot;&gt;&lt;del&gt;CASSANDRA-6246&lt;/del&gt;&lt;/a&gt;. So I&apos;m not strongly opposed, but I do wonder if exposing that kind of subtlety won&apos;t confuse users more than it will help and/or have a short shelf life (due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6246&quot; title=&quot;EPaxos&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6246&quot;&gt;&lt;del&gt;CASSANDRA-6246&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14390526" author="spodxx@gmail.com" created="Wed, 1 Apr 2015 13:19:48 +0000"  >&lt;p&gt;What is the reason of having `WriteType.CAS` if I have to retry using serial reads for both CAS and SIMPLE timeouts? I don&apos;t see the point of implementing different error handling cases based on this flag given the current implementation. &lt;/p&gt;

&lt;p&gt;With the new prepare flag the error handling could be done like this:&lt;br/&gt;
CAS_PREPARE -&amp;gt; retry cas write operation&lt;br/&gt;
CAS -&amp;gt; serial read and retry write if needed&lt;br/&gt;
SIMPLE -&amp;gt; ignore, will be committed later&lt;/p&gt;
</comment>
                            <comment id="14390545" author="slebresne" created="Wed, 1 Apr 2015 13:33:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;What is the reason of having `WriteType.CAS` if I have to retry using serial reads for both CAS and SIMPLE timeouts?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Where in my answer did you see me suggesting that your &lt;b&gt;have to&lt;/b&gt; retry using serial reads for timeouts with &lt;tt&gt;WriteType.SIMPLE&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="14390745" author="spodxx@gmail.com" created="Wed, 1 Apr 2015 15:01:01 +0000"  >&lt;p&gt;You&apos;d have to read serial to get a chance to find out if your cas operation has been applied or not. And no, you didn&apos;t suggest you absolutely have to do that. But for the sake of the discussion, lets assume users will be interested to find out if they need to retry a cas operation in case the operation hasn&apos;t been applied at all. &lt;/p&gt;</comment>
                            <comment id="14390761" author="slebresne" created="Wed, 1 Apr 2015 15:09:32 +0000"  >&lt;p&gt;I don&apos;t understand your arguments. You seems to suggest that you&apos;d be content with a new prepare flag, but it wouldn&apos;t change when we use &lt;tt&gt;WriteType.SIMPLE&lt;/tt&gt;. All I&apos;m saying is that adding a new &lt;tt&gt;CAS_PREPARE&lt;/tt&gt; is only about splitting the &lt;tt&gt;CAS&lt;/tt&gt; case in two and I don&apos;t understand why you&apos;re saying that distinguishing CAS and SIMPLE is pointless while it would become somehow great with a CAS_PREPARE.&lt;/p&gt;</comment>
                            <comment id="14390979" author="spodxx@gmail.com" created="Wed, 1 Apr 2015 17:00:30 +0000"  >&lt;p&gt;CAS_PREPARE and the whole ticket is not be about splitting the CAS case. The point is that currently I can get a WriteTimeout SIMPLE at two different points during execution:&lt;/p&gt;

&lt;p&gt;cas() -&amp;gt; beginAndRepairPaxos() -&amp;gt; commitPaxos()&lt;br/&gt;
cas() -&amp;gt; commitPaxos()&lt;/p&gt;

&lt;p&gt;I&apos;ve double checked and can&apos;t really see that the beginAndRepairPaxos() would somehow catch and wrap a SIMPLE timeout from commitPaxos() to wrap it into a CAS timeout. But this is what IMO should be the preferred way to deal with a SIMPLE timeout at the beginAndRepairPaxos() phase. Else the caller would assume that the SIMPLE timeout was caused by his own (now accepted) cas operation and not the previous commited and resumed operation. &lt;/p&gt;

&lt;p&gt;Basically the behaviour in the &quot;CAS operations&quot; section of the &lt;a href=&quot;http://www.datastax.com/dev/blog/cassandra-error-handling-done-right&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;error-handling blog&lt;/a&gt; describes how the error handling is suppose to work pretty well. But currently the implementation just makes the described individual handling of the paxos and commit phase not possible, since the WriteType.SIMPLE exception is ambiguous and can happen in both paxos and commit phase. &lt;/p&gt;</comment>
                            <comment id="14391158" author="spodxx@gmail.com" created="Wed, 1 Apr 2015 18:27:50 +0000"  >&lt;p&gt;I&apos;ve added a patch to make it clearer where I actually want to go with this ticket. Should have done this right at the start instead of posting a wall of text, sorry :/&lt;/p&gt;</comment>
                            <comment id="14391314" author="slebresne" created="Wed, 1 Apr 2015 19:52:28 +0000"  >&lt;p&gt;Apologies, for some reason I didn&apos;t understood you were talking of the commit that is within &lt;tt&gt;beginAndRepairPaxos&lt;/tt&gt;. So I agree, that commit should definitively throw &lt;tt&gt;WriteType.CAS&lt;/tt&gt; (I think it&apos;s an oversight that it doesn&apos;t), and in fact, the patches look good to me so I&apos;ve committed them. I&apos;ll therefore close this issue. If someone wants to discuss further splitting &lt;tt&gt;WriteType.CAS&lt;/tt&gt; into more precise values (since that end up being suggested even though that&apos;s orthogonal to the issue fixed), feel free to open a separate issue (but as I mentioned above, I&apos;m personally not entirely convinced that it&apos;s entirely wise).&lt;/p&gt;


</comment>
                    </comments>
                    <attachments>
                            <attachment id="12708764" name="storyproxybean-2.0-8672.txt" size="1608" author="spod" created="Wed, 1 Apr 2015 18:23:58 +0000"/>
                            <attachment id="12708763" name="storyproxybean-2.1-8672.txt" size="1608" author="spod" created="Wed, 1 Apr 2015 18:23:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[spod]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24puf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>