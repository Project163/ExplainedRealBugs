<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10829] cleanup + repair generates a lot of logs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10829</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;One of our node generates a lot of cassandra logs (int the 10 MB/s) and CPU usage has increased (by a factor 2-3).&lt;br/&gt;
This was most probably triggered by a &quot;nodetool snapshot&quot; while a cleanup was already running on this node.&lt;/p&gt;

&lt;p&gt;An example of those logs:&lt;br/&gt;
2015-12-08 09:15:17,794 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ValidationExecutor:689&amp;#93;&lt;/span&gt;ColumnFamilyStore.java:1923 Spinning trying to capture released readers &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
2015-12-08 09:15:17,794 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ValidationExecutor:689&amp;#93;&lt;/span&gt;ColumnFamilyStore.java:1924 Spinning trying to capture all readers &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
2015-12-08 09:15:17,795 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ValidationExecutor:689&amp;#93;&lt;/span&gt;ColumnFamilyStore.java:1923 Spinning trying to capture released readers &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
2015-12-08 09:15:17,795 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ValidationExecutor:689&amp;#93;&lt;/span&gt;ColumnFamilyStore.java:1924 Spinning trying to capture all readers &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
(I removed SSTableReader information because it&apos;s rather long... I can share it privately if needed)&lt;br/&gt;
Note that the date has not been changed (only 1ms between logs)&lt;/p&gt;

&lt;p&gt;It should not generate that gigantic amount of logs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;This is probably linked to: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9637&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-9637&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;5 nodes on Cassandra 2.1.11 (on Debian)&lt;/p&gt;</environment>
        <key id="12920020">CASSANDRA-10829</key>
            <summary>cleanup + repair generates a lot of logs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="frousseau">Fabien Rousseau</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Dec 2015 09:37:07 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:48 +0000</updated>
                            <resolved>Tue, 19 Jan 2016 08:11:58 +0000</resolved>
                                        <fixVersion>2.1.13</fixVersion>
                    <fixVersion>2.2.5</fixVersion>
                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.3</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15059786" author="krummas" created="Wed, 16 Dec 2015 10:11:57 +0000"  >&lt;p&gt;I couldn&apos;t reproduce this with just a snapshot, triggering a repair while cleanup was running did reproduce, working on that&lt;/p&gt;</comment>
                            <comment id="15062136" author="krummas" created="Thu, 17 Dec 2015 14:50:30 +0000"  >&lt;p&gt;Problem is that we use the sstables marked as &apos;compacting&apos; to create the canonical view (to get the original sstable instances) and when running cleanup, scrub, upgradesstables and anticompaction we mark each sstable as compacted as we finish it, but we keep it as compacting until the entire operation is done. This means that we have sstables which are marked as compacted in the CANONICAL_SSTABLES and we cannot reference them and it makes us log the &apos;spinning ... &apos; message.&lt;/p&gt;

&lt;p&gt;There is also an issue with the log rate limiting, it was meant to only log every 100ms, but it logs every iteration.&lt;/p&gt;

&lt;p&gt;Patch that unmarks compacting once the sstable finished and fixes the rate limiting: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/10829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/10829&lt;/a&gt;&lt;br/&gt;
and tests:&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10829-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10829-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10829-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10829-testall/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;seems only the rate limiting fix applies to 2.2+ (edit: the other issues are already fixed with LifecycleTransaction)&lt;/p&gt;</comment>
                            <comment id="15062366" author="frousseau" created="Thu, 17 Dec 2015 17:17:58 +0000"  >&lt;p&gt;If I undertstand well:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log rate limit is now once every 100ms&lt;/li&gt;
	&lt;li&gt;rate limit is already on 2.2+ (not related to this ticket)&lt;/li&gt;
	&lt;li&gt;compacting sstables are now released sooner (as soon as it has been compacted, and no more at the end of the whole operation)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, thanks a lot for the fix.&lt;/p&gt;</comment>
                            <comment id="15063695" author="krummas" created="Fri, 18 Dec 2015 08:38:43 +0000"  >&lt;p&gt;correct except:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;rate limit is already on 2.2+ (not related to this ticket)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;no, that is the only thing that is needed on 2.2+&lt;/p&gt;</comment>
                            <comment id="15064320" author="carlyeks" created="Fri, 18 Dec 2015 17:51:27 +0000"  >&lt;p&gt;We need to ensure we only &lt;tt&gt;unmarkCompacting&lt;/tt&gt; the sstables which we haven&apos;t already unmarked, otherwise we could be running a different compaction operation on the previously unmarked sstables and unmark it again after this operation is finished.&lt;/p&gt;</comment>
                            <comment id="15066392" author="krummas" created="Mon, 21 Dec 2015 12:23:12 +0000"  >&lt;p&gt;good point, pushed new commit on top of the old one and triggered new builds in cassci.&lt;/p&gt;</comment>
                            <comment id="15081735" author="carlyeks" created="Mon, 4 Jan 2016 20:23:20 +0000"  >&lt;p&gt;Looks good, but the test failures look like we need to use a &lt;tt&gt;ConcurrentHashSet&lt;/tt&gt; for &lt;tt&gt;finished&lt;/tt&gt; since we&apos;re getting {{IllegalStateException}}s.&lt;/p&gt;</comment>
                            <comment id="15082705" author="krummas" created="Tue, 5 Jan 2016 09:26:49 +0000"  >&lt;p&gt;right, forgot to trigger a new build for testall, did that now (no code changes)&lt;/p&gt;</comment>
                            <comment id="15083978" author="carlyeks" created="Tue, 5 Jan 2016 22:41:51 +0000"  >&lt;p&gt;I think we need to make &lt;tt&gt;finished&lt;/tt&gt; thread-safe, since we&apos;re submitting those to the compaction executor, which may be multi-threaded.&lt;/p&gt;</comment>
                            <comment id="15097863" author="krummas" created="Thu, 14 Jan 2016 09:15:08 +0000"  >&lt;p&gt;pushed a fix and reran tests&lt;/p&gt;</comment>
                            <comment id="15098337" author="carlyeks" created="Thu, 14 Jan 2016 16:21:04 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15106423" author="krummas" created="Tue, 19 Jan 2016 08:11:58 +0000"  >&lt;p&gt;Committed, with only the rate limiting fix merged up to 2.2/3.0/3.3/trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pl9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333770">2.1.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>