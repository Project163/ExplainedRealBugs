<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11995] Commitlog replaced with all NULs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11995</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I noticed this morning that Cassandra was failing to start, after being shut down on Friday.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR 09:13:37 Exiting due to error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing commit log during initialization.
org.apache.cassandra.db.commitlog.CommitLogReplayer$CommitLogReplayException: Could not read commit log descriptor in file C:\Program Files\DataStax Community\data\commitlog\CommitLog-5-1465571056722.log
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.handleReplayError(CommitLogReplayer.java:622) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:302) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:147) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:189) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:169) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:273) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:513) [apache-cassandra-2.2.3.jar:2.2.3]
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:622) [apache-cassandra-2.2.3.jar:2.2.3]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Checking the referenced file reveals it comprises 33,554,432 (32 * 1024 * 1024) NUL bytes.&lt;br/&gt;
No logs (stdout, stderr, prunsrv) from the shutdown show any other issues and appear exactly as normal.&lt;br/&gt;
Is installed as a service via DataStax&apos;s distribution.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 10 Enterprise 1511&lt;br/&gt;
DataStax Cassandra Community Server 2.2.3&lt;/p&gt;</environment>
        <key id="12978100">CASSANDRA-11995</key>
            <summary>Commitlog replaced with all NULs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="jameshowe">James Howe</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jun 2016 10:05:11 +0000</created>
                <updated>Fri, 15 May 2020 08:04:16 +0000</updated>
                            <resolved>Tue, 5 Sep 2017 18:51:00 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15396016" author="jogarcia" created="Wed, 27 Jul 2016 17:22:18 +0000"  >&lt;p&gt;Got the same error, using DSE Enterprise, but reported Cassandra version is 3.0.7.1159&lt;br/&gt;
 StorageService.java:625 - Cassandra version: 3.0.7.1159&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main] 2016-07-27 17:06:50,956  JVMStabilityInspector.java:82 - Exiting due to error while processing commit log during initialization.
org.apache.cassandra.db.commitlog.CommitLogReplayer$CommitLogReplayException: Could not read commit log descriptor in file /ssd/cassandra/commitlog/CommitLog-6-1469633515550.log
        at org.apache.cassandra.db.commitlog.CommitLogReplayer.handleReplayError(CommitLogReplayer.java:650) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:327) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:148) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:181) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:161) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:289) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at com.datastax.bdp.server.DseDaemon.setup(DseDaemon.java:440) [dse-core-5.0.1.jar:5.0.1]
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:557) [cassandra-all-3.0.7.1159.jar:3.0.7.1159]
        at com.datastax.bdp.DseModule.main(DseModule.java:49) [dse-core-5.0.1.jar:5.0.1]
INFO  [Daemon shutdown] 2016-07-27 17:06:50,958  DseDaemon.java:549 - DSE shutting down...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15533075" author="jameshowe" created="Thu, 29 Sep 2016 15:24:48 +0000"  >&lt;p&gt;Just happened to me again.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jogarcia&quot; class=&quot;user-hover&quot; rel=&quot;jogarcia&quot;&gt;jogarcia&lt;/a&gt;, are you also running on Windows?&lt;/p&gt;</comment>
                            <comment id="15644485" author="jmarsten" created="Mon, 7 Nov 2016 15:28:58 +0000"  >&lt;p&gt;We observed this phenomenon running Apache Cassandra 3.7 on Windows Server 2012 VM. The precise history and state of the VM in question was unclear, but apparently the administrators took a live volume snapshot, and after reverting to the snapshot, Cassandra would no longer start due to the error above. In this case, the commit log file was 48MB of NUL bytes. The Cassandra system log showed an ungraceful termination and a handful of warnings related to slow commit log syncs, but no errors prior to the CommitLogReplayException on subsequent startups.&lt;/p&gt;

&lt;p&gt;Cassandra was configured for batch mode commit log syncing with a window size of 50ms. It&apos;s not clear whether the system was writing to Cassandra at the time of the snapshot.&lt;/p&gt;</comment>
                            <comment id="15644593" author="jmarsten" created="Mon, 7 Nov 2016 16:14:38 +0000"  >&lt;p&gt;I&apos;m not too familiar with the Cassandra code base, but it looks like the CommitLogSegment.createSegment() method returns an instance that has had the log header written, but not synced. So until a sync is triggered (periodic, batch, or graceful shutdown), the segment file is left in a corrupt state because it has no header on disk. If I&apos;m right about this, I&apos;d suggest making CommitLogSegment.createSegment() call sync() on the new segment before returning it.&lt;/p&gt;</comment>
                            <comment id="15644627" author="jogarcia" created="Mon, 7 Nov 2016 16:27:03 +0000"  >&lt;p&gt;Mine is running on Ubuntu. What I found was that the specific node had a bad memory stick. The machine in question was crashing constantly, every few hours. I think when the crash happens at the wrong moment, there is a log being created and initialized with NULL characters, or probably just allocated to be sure it gets enough space. When the crash happens at that time, the log stays allocated with NULL characters and that prevents the cassandra node from starting, as its format is incorrect. I think what is needed after reboot is to check for that condition and realize the failire and roll it back. and restart.&lt;/p&gt;

&lt;p&gt;In our specific case, we replaced the memory stick, the machine stopped crashing and I&apos;ve never seen the error again. Probably the condition is rare and only happens during bad timing of a crash, but loosing power on a large cluster would make such condition appear with some frequency. &lt;/p&gt;</comment>
                            <comment id="15861177" author="tinytimrob" created="Fri, 10 Feb 2017 12:01:47 +0000"  >&lt;p&gt;I&apos;ve been seeing this issue quite frequently on my dev machine.&lt;/p&gt;

&lt;p&gt;For various reasons, that machine is currently a bit unstable and tends to lock up quite often, meaning I&apos;m forced to hit the reset button on the front, which results in ungraceful termination of all the running programs. Since I use it for other things, in some boots of the system the Cassandra server starts but I never actually connect to it or use it in any way. In those cases, if I perform a forced reset of the machine while Cassandra is in a &quot;running but hasn&apos;t been accessed yet&quot; state, I almost always encounter this issue.&lt;/p&gt;

&lt;p&gt;I was able to work around the problem by just deleting the commit log that was filled with NULs. I checked the tables and data and nothing seems to be missing in the database, so this definitely seems like a minor glitch. It looks like the Cassandra server is creating an empty commit log file, but the header for it isn&apos;t being synced to disk, possibly because there haven&apos;t been any changes to data happening which would warrant bothering with one. Then if there is a forced reset while the server is in this state, it isn&apos;t able to start up again on reboot because there is a commit log filled with NUL bytes that lacks a header.&lt;/p&gt;</comment>
                            <comment id="15930751" author="jjirsa" created="Fri, 17 Mar 2017 21:26:01 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; utests &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.0-11995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.0-11995-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.0-11995-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.11-11995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.11-11995-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.11-11995-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-11995&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-11995-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-11995-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Note to reviewer: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; and I talked about this offline a bit, and one of the things worth questioning is &quot;how do we even get in this position&quot;. It seems like there may be a window after &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/commitlog/CommitLogSegment.java#L168-L171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CommitLogDescriptor.writeHeader&lt;/a&gt; is called where we don&apos;t actually sync, but short of a system reboot, we should still have the data in memory and the kernel should keep it consistent - however, if we&apos;re crashing for some other reason, we could certainly have an all-0 file, which will fail to replay. We may want to open up a subsequent JIRA to talk address that particular problem, but we see it as distinct from the replay problem. &lt;/p&gt;

&lt;p&gt;This patch, then, is only dealing with the problem of replaying the final all-0 file, which we consider to be a change in behavior from 2.x. Continuing to replay a &quot;corrupt&quot; all-null file is the 2.x behavior, and presumably should only allowed if we&apos;re the last segment, which we already explicitly tolerate in the rest of that segment via &lt;tt&gt;tolerateTruncation&lt;/tt&gt; flag - this patch just makes &lt;tt&gt;tolerateTruncation&lt;/tt&gt; also tolerate truncation of the header without interrupting replay and startup.&lt;/p&gt;</comment>
                            <comment id="16097041" author="jjirsa" created="Sat, 22 Jul 2017 01:01:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; - either of you interested in reviewing? I can rebase as needed.&lt;/p&gt;</comment>
                            <comment id="16098478" author="blambov" created="Mon, 24 Jul 2017 14:18:57 +0000"  >&lt;p&gt;The patch looks good.&lt;/p&gt;

&lt;p&gt;Did this happen during normal shutdown? The log is supposed to clean-up such unused segments, but probably isn&apos;t able to delete them on Windows because they are still memory-mapped. Still, they should have a header if that&apos;s the case, shouldn&apos;t they?&lt;/p&gt;

&lt;p&gt;There may also be a further complication related to this. If the empty segment did not sync on a crash, the one before it may be truncated too. We may have to treat that situation as tolerable too.&lt;/p&gt;</comment>
                            <comment id="16108122" author="jjirsa" created="Mon, 31 Jul 2017 22:55:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; - I do think there&apos;s a few areas for improvement, though this is the low hanging fruit of it. The one case where I was able to see this myself was in a test environment where failures were expected (and indeed, injected), but based on the descriptions above, I believe happens on any unclean shutdown triggered during startup.&lt;/p&gt;

&lt;p&gt;I&apos;d personally like to commit this as an intermediate step, and not try to fix ALL of the potential problems at once (I think this removes the most obvious cause, and does it with very little risk). Are you ok with that, and we can open some follow-up tickets as they arise? &lt;/p&gt;

</comment>
                            <comment id="16154129" author="jjirsa" created="Tue, 5 Sep 2017 18:51:00 +0000"  >&lt;p&gt;Thanks for the &apos;ready-to-commit&apos; change. Committed as &lt;tt&gt;0493545dd08d29c34d757bb2f1d90052d03d24c6&lt;/tt&gt; to 3.0 and merged up through 3.11 and trunk.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zdev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>