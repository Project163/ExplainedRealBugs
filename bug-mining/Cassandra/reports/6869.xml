<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:34:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20842] Fix version range check in MessagingService.getVersionOrdinal</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20842</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Thank you to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; and Claude &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; for highlighting a minor issue in the recent changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20816&quot; title=&quot;Optimize MessagingService.getVersionOrdinal&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20816&quot;&gt;&lt;del&gt;CASSANDRA-20816&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
## Issues Found
### 1. Incorrect bounds check condition
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result &amp;lt; 0 || result &amp;gt; maxVersion)
This condition is wrong. The check should be against the array length, not `maxVersion`. Currently:
- `maxVersion` is the actual version value (e.g., 15)
- The check should be against `Version.values().length - 1` (the maximum valid ordinal)
### 2. Misleading variable name
`maxVersion` actually contains the version value, not the maximum ordinal index.
## Corrected Implementation

&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minVersion = Version.values()[0].value;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxVersionOrdinal = Version.values().length - 1;

/**
 * This is an optimisation to speed up the translation of the serialization
 * version to the {@link Version} &lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; ordinal.
 * We expect values &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; versions to be incremented sequentially
 *
 * @param version the serialization version
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a {@link Version} ordinal value
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getVersionOrdinal(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; version)
{
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; result = version - minVersion;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result &amp;lt; 0 || result &amp;gt; maxVersionOrdinal)
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unknown serialization version: &quot;&lt;/span&gt; + version);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
}
## Additional Issues
### 3. Typo in exception message
&lt;span class=&quot;code-quote&quot;&gt;&quot;Unkown&quot;&lt;/span&gt; should be &lt;span class=&quot;code-quote&quot;&gt;&quot;Unknown&quot;&lt;/span&gt;
### 4. Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; issue
The test `checkUnknownBigVersion()` uses `&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;.MAX_VALUE + 1` (128), but &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; assumes version values are &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;-sized. A more robust test would use a value that&apos;s guaranteed to be out of range regardless of the actual version values.
## Recommended Test Fix

@Test(expected = IllegalStateException.class)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkUnknownBigVersion()
{
    &lt;span class=&quot;code-comment&quot;&gt;// Use a value that&apos;s definitely larger than any reasonable version
&lt;/span&gt;    MessagingService.getVersionOrdinal(1000);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13626528">CASSANDRA-20842</key>
            <summary>Fix version range check in MessagingService.getVersionOrdinal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="dnk">Dmitry Konstantinov</reporter>
                        <labels>
                    </labels>
                <created>Sat, 16 Aug 2025 14:52:11 +0000</created>
                <updated>Tue, 19 Aug 2025 17:29:36 +0000</updated>
                            <resolved>Tue, 19 Aug 2025 17:28:43 +0000</resolved>
                                        <fixVersion>5.1</fixVersion>
                                    <component>Messaging/Internode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="18014289" author="dnk" created="Sat, 16 Aug 2025 15:13:28 +0000"  >&lt;ul&gt;
	&lt;li&gt;I think 1-2 statements are correct, good catch by Claude &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/li&gt;
	&lt;li&gt;Regarding #3 - it is inherited from the old logic but it makes sense to fix it as well&lt;/li&gt;
	&lt;li&gt;Regarding #4 checkUnknownBigVersion - here I relied on the fact that the version is 8bit (but probably I should multiple MAX_VALUE by 2 due to sign/unsigned difference..):
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// 8 bits version, so don&apos;t waste versions 
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; Version
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and org.apache.cassandra.net.HandshakeProtocol.Initiate#maybeDecode:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minMessagingVersion = getBits(flags, 16, 8); &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxMessagingVersion = getBits(flags, 24, 8);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;1000 suggested here by AI I do not think very good as well. &lt;br/&gt;
Taking in account the discovered bug I think it would be better to adjust the test and use the first out of range value instead&#160;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="18014300" author="dnk" created="Sat, 16 Aug 2025 16:07:22 +0000"  >&lt;p&gt;MR: &lt;a href=&quot;https://github.com/apache/cassandra/pull/4320&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/4320&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18014694" author="dnk" created="Mon, 18 Aug 2025 18:00:17 +0000"  >&lt;p&gt;CI test results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13078017/13078017_ci_summary_20842-trunk.htm&quot; title=&quot;ci_summary_20842-trunk.htm attached to CASSANDRA-20842&quot;&gt;ci_summary_20842-trunk.htm&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13078016/13078016_results_details_20842-trunk.tar.xz&quot; title=&quot;results_details_20842-trunk.tar.xz attached to CASSANDRA-20842&quot;&gt;results_details_20842-trunk.tar.xz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Known issues or flaky tests:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;distributed.test.SSTableLoaderEncryptionOptionsTest bulkLoaderSuccessfullyStreamsOverSslWithDeprecatedSslStoragePort-_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;distributed.test.log.InProgressSequenceCoordinationTest bootstrapProgressTest-_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;distributed.test.log.InProgressSequenceCoordinationTest decommissionProgressTest-_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;distributed.test.log.InProgressSequenceCoordinationTest inProgressSequenceRetryTest-_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;simulator.test.AccordHarrySimulationTest test-cassandra.testtag_IS_UNDEFINED&lt;/li&gt;
	&lt;li&gt;simulator.test.TrivialSimulationTest trivialTest-_jdk11_x86_64&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="18014953" author="maedhroz" created="Tue, 19 Aug 2025 16:03:51 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="18014954" author="maedhroz" created="Tue, 19 Aug 2025 16:04:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;1000 suggested here by AI I do not think very good as well. Taking in account the discovered bug I think it would be better to adjust the test and use the first out of range value instead&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1000 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13625461">CASSANDRA-20816</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13078017" name="ci_summary_20842-trunk.htm" size="1316880" author="dnk" created="Mon, 18 Aug 2025 17:58:56 +0000"/>
                            <attachment id="13078016" name="results_details_20842-trunk.tar.xz" size="1893940" author="dnk" created="Mon, 18 Aug 2025 17:58:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xa8o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353509">5.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/657d9578f0858f42caea98ffd62bce692adbf532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/657d9578f0858f42caea98ffd62bce692adbf532&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Related unit tests are updated&#160;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>