<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:24:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17335] Fix race condition bug during local session repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17335</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The in-JVM dtest &lt;tt&gt;RepairErrorsTest#testNoSuchRepairSessionAnticompaction&lt;/tt&gt; seems to be flaky, as it&apos;s shown by &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1280/workflows/8a4e04cb-64cc-46a3-9e1e-c946dfafc7fa/jobs/12114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this repeated run&lt;/a&gt; on trunk, which hits 18 failures in 500 iterations. The config for CircleCI was generated with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -m \
  -e REPEATED_UTEST_TARGET=test-jvm-dtest-some \
  -e REPEATED_UTEST_COUNT=500 \
  -e REPEATED_UTEST_CLASS=org.apache.cassandra.distributed.test.RepairErrorsTest
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This was discovered while testing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16878&quot; title=&quot;Race in commit log replay can cause rejected mutations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16878&quot;&gt;CASSANDRA-16878&lt;/a&gt;, on &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1268/workflows/aef1c703-c816-40f8-8e07-9055027d6403/jobs/12000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this CI run&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The error consists on a failed assertion when grepping the logs in search of an error message.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13426195">CASSANDRA-17335</key>
            <summary>Fix race condition bug during local session repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bernardo.botella">Bernardo Botella Corbi</assignee>
                                    <reporter username="adelapena">Andres de la Pe&#241;a</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Feb 2022 13:05:28 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:47 +0000</updated>
                            <resolved>Fri, 4 Mar 2022 18:47:25 +0000</resolved>
                                        <fixVersion>4.0.4</fixVersion>
                    <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="17494099" author="JIRAUSER285406" created="Thu, 17 Feb 2022 17:25:10 +0000"  >&lt;p&gt;Found a fix for this issue. Can be found here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1452/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1452/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As a backup, I am also attaching a patch.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13040201/13040201_0001-Fix-Flaky-testNoSuchRepairSessionAnticompaction-trunk.patch&quot; title=&quot;0001-Fix-Flaky-testNoSuchRepairSessionAnticompaction-trunk.patch attached to CASSANDRA-17335&quot;&gt;0001-Fix-Flaky-testNoSuchRepairSessionAnticompaction-trunk.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Problem is that sometimes the session state value changed to FAILED state between the moment it was checked as non failed and the moment it was being updated, leading to an ilegal transition (from FAILED to PREPARED).&lt;/p&gt;

&lt;p&gt;The way I was able to repro it was:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;to tell intelliJ to keep running the same test until it failed. It failed always after between 2 and 6 runs.&lt;/li&gt;
	&lt;li&gt;Running a simple bash script until it failed. Same results.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That allowed me to investigate the logs and chase that. After adding the synchronize, I couldn&#8217;t make the test fail again. Also, thinking about it, it makes perfect sense to put that block into a synchronized block, as it is reading a variable that is being updated from other threads.&lt;/p&gt;</comment>
                            <comment id="17494106" author="edimitrova" created="Thu, 17 Feb 2022 17:29:45 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bernardo.botella&quot; class=&quot;user-hover&quot; rel=&quot;bernardo.botella&quot;&gt;bernardo.botella&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I just saw you posted a patch but the ticket was still in triage so I moved it to Patch Available to signal people it needs a reviewer.&#160;&lt;/p&gt;

&lt;p&gt;Thank you for your work!&lt;/p&gt;</comment>
                            <comment id="17497064" author="yifanc" created="Wed, 23 Feb 2022 23:03:01 +0000"  >&lt;p&gt;The code gets fixed was added in 4.0. A patch is needed for the 4.0 branch. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bernardo.botella&quot; class=&quot;user-hover&quot; rel=&quot;bernardo.botella&quot;&gt;bernardo.botella&lt;/a&gt;, can you also provide a patch to 4.0 branch?&#160;&lt;/p&gt;</comment>
                            <comment id="17497073" author="JIRAUSER285406" created="Wed, 23 Feb 2022 23:48:29 +0000"  >&lt;p&gt;Added&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1452/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17497088" author="yifanc" created="Thu, 24 Feb 2022 00:38:26 +0000"  >&lt;p&gt;Thanks for the patches. The &lt;a href=&quot;https://app.circleci.com/pipelines/github/yifan-c/cassandra/321/workflows/69e3eaca-8e3e-407f-b427-7125b2ea873f/jobs/2613/steps&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;repeated run&lt;/a&gt; of the &quot;flaky&quot; test now looks good.&lt;/p&gt;

&lt;p&gt;+1 on the patch.&lt;/p&gt;</comment>
                            <comment id="17498009" author="bereng" created="Fri, 25 Feb 2022 09:36:05 +0000"  >&lt;p&gt;Dropped a couple comments.&lt;/p&gt;</comment>
                            <comment id="17499630" author="JIRAUSER285406" created="Tue, 1 Mar 2022 16:11:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt;&#160;! I just addressed them. Please let me know any thoughts you may have.&lt;/p&gt;</comment>
                            <comment id="17500529" author="bereng" created="Thu, 3 Mar 2022 06:30:03 +0000"  >&lt;p&gt;LGTM +1&lt;/p&gt;</comment>
                            <comment id="17501082" author="yifanc" created="Thu, 3 Mar 2022 23:52:51 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/yifan-c/cassandra/tree/commit_remote_branch/CASSANDRA-17335-cassandra-4.0-3EE5D631-3BA2-47A0-B74F-D79A5776514F&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/yifan-c/cassandra?branch=commit_remote_branch%2FCASSANDRA-17335-cassandra-4.0-3EE5D631-3BA2-47A0-B74F-D79A5776514F&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/yifan-c/cassandra/tree/commit_remote_branch/CASSANDRA-17335-trunk-3EE5D631-3BA2-47A0-B74F-D79A5776514F&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/yifan-c/cassandra?branch=commit_remote_branch%2FCASSANDRA-17335-trunk-3EE5D631-3BA2-47A0-B74F-D79A5776514F&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Both runs look mostly green.&#160;&lt;/p&gt;</comment>
                            <comment id="17501478" author="yifanc" created="Fri, 4 Mar 2022 18:47:25 +0000"  >&lt;p&gt;Committed into cassandra-4.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/fd5e2ad74eff61e189c2abe87797c2690a45220c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fd5e2ad7&lt;/a&gt; and merged into trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13396911">CASSANDRA-16878</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13040201" name="0001-Fix-Flaky-testNoSuchRepairSessionAnticompaction-trunk.patch" size="2652" author="bernardo.botella" created="Thu, 17 Feb 2022 17:21:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bernardo.botella]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0z6rc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[ycai]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350367">4.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/fd5e2ad74eff61e189c2abe87797c2690a45220c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fd5e2ad74eff61e189c2abe87797c2690a45220c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1452/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1452/files&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>