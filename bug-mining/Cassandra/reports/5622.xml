<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:18:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16387] UpgradeTest sporadically failing on schema updates</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16387</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We&#8217;ve observed &lt;tt&gt;UpdateTest&lt;/tt&gt; failing during what appears to be a schema change:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/192/workflows/ed5305e6-e4f9-420e-9f0a-6153333746dc/jobs/1068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/maedhroz/cassandra/192/workflows/ed5305e6-e4f9-420e-9f0a-6153333746dc/jobs/1068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It almost looks like the Gossiper can&#8217;t find its own endpoint state in the endpoint state map, and the failure is not consistent, which might suggest a race.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13352575">CASSANDRA-16387</key>
            <summary>UpgradeTest sporadically failing on schema updates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="maedhroz">Caleb Rackliffe</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Jan 2021 22:57:32 +0000</created>
                <updated>Wed, 16 Mar 2022 15:24:36 +0000</updated>
                            <resolved>Mon, 15 Feb 2021 13:48:45 +0000</resolved>
                                        <fixVersion>3.0.25</fixVersion>
                    <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="8400">2h 20m</timespent>
                                <comments>
                            <comment id="17268012" author="maedhroz" created="Tue, 19 Jan 2021 16:23:26 +0000"  >&lt;p&gt;This may be a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16394&quot; title=&quot;Fix schema aggreement race conditions in in-JVM dtests &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16394&quot;&gt;&lt;del&gt;CASSANDRA-16394&lt;/del&gt;&lt;/a&gt;, but I&apos;ll mark it as such when/if that is confirmed.&lt;/p&gt;</comment>
                            <comment id="17276410" author="aholmber" created="Mon, 1 Feb 2021 15:46:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16394&quot; title=&quot;Fix schema aggreement race conditions in in-JVM dtests &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16394&quot;&gt;&lt;del&gt;CASSANDRA-16394&lt;/del&gt;&lt;/a&gt; closing last week, was there a disposition on this one?&lt;/p&gt;</comment>
                            <comment id="17276564" author="maedhroz" created="Mon, 1 Feb 2021 18:32:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt; I&apos;m waiting for the results of some upgrade tests on the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16181&quot; title=&quot;4.0 Quality: Replication Test Audit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16181&quot;&gt;&lt;del&gt;CASSANDRA-16181&lt;/del&gt;&lt;/a&gt; patch (after rebasing that on trunk w/ the changes from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16394&quot; title=&quot;Fix schema aggreement race conditions in in-JVM dtests &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16394&quot;&gt;&lt;del&gt;CASSANDRA-16394&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17277277" author="maedhroz" created="Tue, 2 Feb 2021 16:48:08 +0000"  >&lt;p&gt;Unfortunately, this still &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/216/workflows/f821efda-dbcd-4281-b2df-e4a3611b1b23/jobs/1195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;seems to be happening&lt;/a&gt; even after a rebase on trunk w/ &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16394&quot; title=&quot;Fix schema aggreement race conditions in in-JVM dtests &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16394&quot;&gt;&lt;del&gt;CASSANDRA-16394&lt;/del&gt;&lt;/a&gt;. Going to need to have to dig in a bit more...&lt;/p&gt;</comment>
                            <comment id="17277464" author="maedhroz" created="Tue, 2 Feb 2021 21:22:53 +0000"  >&lt;p&gt;Nominally, this looks like it&apos;s happening is when:&lt;/p&gt;

&lt;p&gt;1.) A cluster is created at 3.0.&lt;br/&gt;
 2.) The schema is updated, in this case a keyspace is created in &lt;tt&gt;init()&lt;/tt&gt; and another keyspace and table immediately after, as laid out in &lt;tt&gt;setup()&lt;/tt&gt;.&lt;br/&gt;
 3.) The schema migration coordinator node pushes schema mutations out.&lt;br/&gt;
 4.) Some other node (again still on 3.0) receives the update message/partitions.&lt;br/&gt;
 5.) When it tries to gossip its new schema version, it can&apos;t even find its &lt;b&gt;own endpoint state&lt;/b&gt; in &lt;tt&gt;endpointStateMap&lt;/tt&gt; in &lt;tt&gt;Gossiper#addLocalApplicationStateInternal()&lt;/tt&gt;.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.cassandra.distributed.shared.ShutdownException: Uncaught exceptions were thrown during test

	at org.apache.cassandra.distributed.impl.AbstractCluster.checkAndResetUncaughtExceptions(AbstractCluster.java:866)
	at org.apache.cassandra.distributed.impl.AbstractCluster.close(AbstractCluster.java:852)
	at org.apache.cassandra.distributed.upgrade.UpgradeTestBase$TestCase.run(UpgradeTestBase.java:188)
	at org.apache.cassandra.distributed.upgrade.MixedModeBatchTestBase.testSimpleStrategy(MixedModeBatchTestBase.java:70)
	at org.apache.cassandra.distributed.upgrade.MixedModeFrom3UnloggedBatchTest.testSimpleStrategy30to4(MixedModeFrom3UnloggedBatchTest.java:36)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:220)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:53)
	Suppressed: java.lang.AssertionError
		at org.apache.cassandra.gms.Gossiper.addLocalApplicationStateInternal(Gossiper.java:1551)
		at org.apache.cassandra.gms.Gossiper.addLocalApplicationStates(Gossiper.java:1575)
		at org.apache.cassandra.gms.Gossiper.addLocalApplicationState(Gossiper.java:1565)
		at org.apache.cassandra.service.MigrationManager.passiveAnnounce(MigrationManager.java:478)
		at org.apache.cassandra.config.Schema.updateVersionAndAnnounce(Schema.java:600)
		at org.apache.cassandra.schema.SchemaKeyspace.mergeSchemaAndAnnounceVersion(SchemaKeyspace.java:1336)
		at org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:51)
		at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
		at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
		at java.util.concurrent.FutureTask.run(FutureTask.java:266)
		at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
		at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
		at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:83)
		at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This only happens sporadically, so it feels like we&apos;re randomly losing the race to update &lt;tt&gt;endpointStateMap&lt;/tt&gt;...&lt;/p&gt;</comment>
                            <comment id="17277716" author="maedhroz" created="Wed, 3 Feb 2021 06:17:17 +0000"  >&lt;p&gt;Alright, after digging around even more, I&apos;m starting to wonder how tests that start 3 or more nodes (and don&apos;t use the GOSSIP feature) could be expected to avoid this problem. In &lt;tt&gt;AbstractCluster#startup()&lt;/tt&gt;, we start the first node and any nodes using &lt;tt&gt;auto_bootstrap&lt;/tt&gt; sequentially, one-at-a-time. After that, the other nodes are started in parallel. This seems to open a whole pandoras box of races in the initialization of the messaging service, gossiper, and migration manager.&lt;/p&gt;

&lt;p&gt;In this&#160;case nodes 2 and 3 start up in parallel. By default, &lt;tt&gt;UpgradeTestBase&lt;/tt&gt; doesn&apos;t use &lt;tt&gt;auto_bootstrap&lt;/tt&gt;, and it doesn&apos;t use the GOSSIP or NETWORK features. For the 3.0 &lt;tt&gt;Instance&lt;/tt&gt; this means we rely on &lt;tt&gt;Gossiper#initializeNodeUnsafe()&lt;/tt&gt; to initialize the endpoint state map entry for the local node and then immediately treat all other nodes as being live via a call to &lt;tt&gt;Gossiper#realMarkAlive()&lt;/tt&gt;. Importantly, this happens after mock messaging is set up. Lastly, a call to &lt;tt&gt;StorageService#ensureTraceKeyspace()&lt;/tt&gt; makes sure the traces keyspace is created and &lt;em&gt;pushes the schema change to other live nodes&lt;/em&gt;. The problem is that means all nodes in the cluster, even the ones that haven&apos;t finished calling &lt;tt&gt;Gossiper#initializeNodeUnsafe()&lt;/tt&gt; will get a &lt;tt&gt;DEFINITIONS_UPDATE&lt;/tt&gt; message and try to access the local node gossip state from the endpoint state map that doesn&apos;t exist yet.&lt;/p&gt;

&lt;p&gt;With some extra debugging and stack traces, this is what the progression looks like in the logs:&lt;/p&gt;

&lt;p&gt;1.) Node 2 create the traces keyspace, announces it, and pushes the schema change mutations.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [node2_isolatedExecutor:3] node2 2021-02-02 19:33:54,101 StorageService.java:1293 - NORMAL
java.lang.RuntimeException
	at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:433)
	at org.apache.cassandra.service.MigrationManager.announceGlobally(MigrationManager.java:419)
	at java.util.Optional.ifPresent(Optional.java:159)
	at org.apache.cassandra.service.StorageService.ensureTraceKeyspace(StorageService.java:1080)
	at org.apache.cassandra.distributed.impl.Instance.lambda$startup$7(Instance.java:609)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.) Node 3 get the message.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [node3_MigrationStage:1] node3 2021-02-02 19:33:54,119 DefinitionsUpdateVerbHandler.java:48 - Received schema mutation push from /127.0.0.2 for keyspaces [system_schema]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.) Node 3 tries to update its own schema version, but can&apos;t since its own endpoint state is very much missing.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [node3_MigrationStage:1] node3 2021-02-02 19:33:54,186 Schema.java:485 - Adding org.apache.cassandra.config.CFMetaData@3262feed[cfId=c5e99f16-8677-3914-b17e-960613512345,ksName=system_traces
Exception null occurred on thread node3_MigrationStage:1
java.lang.AssertionError
	at org.apache.cassandra.gms.Gossiper.addLocalApplicationStateInternal(Gossiper.java:1555)
	at org.apache.cassandra.gms.Gossiper.addLocalApplicationStates(Gossiper.java:1579)
	at org.apache.cassandra.gms.Gossiper.addLocalApplicationState(Gossiper.java:1569)
	at org.apache.cassandra.service.MigrationManager.passiveAnnounce(MigrationManager.java:479)
	at org.apache.cassandra.config.Schema.updateVersionAndAnnounce(Schema.java:600)
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchemaAndAnnounceVersion(SchemaKeyspace.java:1336)
	at org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:54)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4.) Node 3 finally gets initialized, but it&apos;s too late.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [node3_GossipStage:1] node3 2021-02-02 19:33:54,304 Gossiper.java:1633 - Initializing state for /127.0.0.3 on /127.0.0.3
java.lang.RuntimeException
	at org.apache.cassandra.gms.Gossiper.initializeNodeUnsafe(Gossiper.java:1634)
	at org.apache.cassandra.distributed.impl.Instance.lambda$addToRing$8(Instance.java:666)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17277729" author="maedhroz" created="Wed, 3 Feb 2021 06:40:55 +0000"  >&lt;p&gt;As an experiment, I changed &lt;tt&gt;UpgradeTestBase&lt;/tt&gt; to use &lt;tt&gt;auto_bootstrap&lt;/tt&gt; by default, and so far I&apos;ve been unable to trigger the failure locally (dozens of runs) or on &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra?branch=CASSANDRA-16181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Circle&lt;/a&gt;, where the failure was almost constant beforehand. I&apos;m not sure if that&apos;s a solution though, if we want to preserve the performance improvement I&apos;m guessing we get with concurrent &lt;tt&gt;Instance&lt;/tt&gt; startup.&lt;/p&gt;

&lt;p&gt;Perhaps all we need to do is avoid &lt;tt&gt;pushSchemaMutation()&lt;/tt&gt; when we&apos;re creating the traces keyspace at every instance. It seems redundant anyway, and I&apos;m actually not even sure why we push the mutations to other nodes via &lt;tt&gt;setUpDistributedSystemKeyspaces()&lt;/tt&gt; in a production scenario, given each node has the mutations applied locally already on join. (Like forcing serial startup, avoiding the push also stabilizes the failing upgrade tests locally.)&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17278517" author="maedhroz" created="Thu, 4 Feb 2021 04:04:10 +0000"  >&lt;p&gt;I did some 3.0 and trunk experiments where we avoid &lt;tt&gt;pushSchemaMutation()&lt;/tt&gt; for the locally added distributed system schema changes, as mentioned above:&lt;/p&gt;

&lt;p&gt;3.0: &lt;a href=&quot;https://github.com/apache/cassandra/pull/885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/885&lt;/a&gt;&lt;br/&gt;
test: &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/222/workflows/2866e273-279a-46c5-8d13-d6c18c5a383a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/maedhroz/cassandra/222/workflows/2866e273-279a-46c5-8d13-d6c18c5a383a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;trunk: &lt;a href=&quot;https://github.com/apache/cassandra/pull/821&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/821&lt;/a&gt; (recent commits)&lt;br/&gt;
test: &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/221/workflows/4adb761f-2521-495a-9715-dcf5a9c7eadf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/maedhroz/cassandra/221/workflows/4adb761f-2521-495a-9715-dcf5a9c7eadf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This doesn&apos;t appear to cause a single new test failure (except for maybe &lt;tt&gt;InternodeEncryptionEnforcementTest&lt;/tt&gt; which seems to implicitly rely on a connection being made when the definitions update is sent). That doesn&apos;t necessarily mean things are safe, but it pushes this idea toward viability...&lt;/p&gt;

&lt;p&gt;(Note that a couple of the in-JVM upgrade tests for the trunk patch still fail, because the version of 3.0 used there doesn&apos;t include the fix from the 3.0 patch above.)&lt;/p&gt;</comment>
                            <comment id="17279066" author="maedhroz" created="Thu, 4 Feb 2021 18:47:22 +0000"  >&lt;p&gt;Given the clean test runs, I&apos;m posting the 3.0 and 3.11 versions of the solution that avoids globally pushing mutations from the distributed system keyspace schema changes at startup. (Nodes still passively announce their schema version.)&lt;/p&gt;

&lt;p&gt;While this change appears to consistently fix the problem in local test runs (3.0 -&amp;gt; trunk in-JVM upgrade tests), the next step would be modifying the CircleCI config to use my 3.0 and 3.11 branches rather than the base branches to build dtest JARs.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16387-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/223/workflows/e60f131d-326e-4241-92d4-f51b9043eb62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16387-3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/225/workflows/0bea0ed5-9dd6-4a7e-8cae-3a6c5ea7942d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;UPDATE: The trunk version also looks not to have created any new test failures.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16387-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/227/workflows/93a9d7d5-df87-41bd-a4be-5ea689416f30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;In any case, judging from these results, either it &lt;b&gt;is&lt;/b&gt; safe to avoid the global push, or we just lack the tests/in-code documentation to make it obvious that it isn&apos;t.&lt;/p&gt;</comment>
                            <comment id="17279471" author="blerer" created="Fri, 5 Feb 2021 08:48:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; Your reasoning and the patches make sense to me.&lt;br/&gt;
The &lt;tt&gt;j8_upgradetests-no-vnodes&lt;/tt&gt; seems to be failing in 3.0 and 3.11 and I am not sure of what should be the state of those tests.&lt;/p&gt;</comment>
                            <comment id="17279776" author="maedhroz" created="Fri, 5 Feb 2021 16:11:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; Do we actually expect the &lt;tt&gt;j8_upgradetests-no-vnodes&lt;/tt&gt; to work on 3.0 and 3.11 right now?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; Any chance you&apos;d like to be an official reviewers?&lt;/p&gt;</comment>
                            <comment id="17279792" author="maedhroz" created="Fri, 5 Feb 2021 16:41:22 +0000"  >&lt;p&gt;Also a quick note for reviewers, we&apos;re obviously seeing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16415&quot; title=&quot;Digest mismatches during upgrade&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16415&quot;&gt;&lt;del&gt;CASSANDRA-16415&lt;/del&gt;&lt;/a&gt; in our test results.&lt;/p&gt;</comment>
                            <comment id="17283273" author="iamaleksey" created="Thu, 11 Feb 2021 18:12:43 +0000"  >&lt;p&gt;All three patches look good to me, except for one omission. &lt;tt&gt;StorageService#doAuthSetup()&lt;/tt&gt; is also a user of &lt;tt&gt;evolveSystemKeyspace()&lt;/tt&gt;, and probably should be updated to not actively push.&lt;/p&gt;</comment>
                            <comment id="17283414" author="maedhroz" created="Thu, 11 Feb 2021 22:35:01 +0000"  >&lt;p&gt;Addressed &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&apos;s feedback and&#160;started new CI runs for &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra?branch=CASSANDRA-16387-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra?branch=CASSANDRA-16387-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, and &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra?branch=CASSANDRA-16387-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17283452" author="brandon.williams" created="Fri, 12 Feb 2021 01:18:12 +0000"  >&lt;p&gt;Patches look good to me, +1 if CI is happy.&lt;/p&gt;</comment>
                            <comment id="17283494" author="maedhroz" created="Fri, 12 Feb 2021 04:16:25 +0000"  >&lt;p&gt;I&apos;m not seeing anything problematic in the CircleCI runs, and we&apos;ve got 3 +1&apos;s. Unless we want to throw up ci-cassandra runs, anyone willing to commit this?&lt;/p&gt;

&lt;p&gt;Thanks for all the review!&lt;/p&gt;</comment>
                            <comment id="17284735" author="blerer" created="Mon, 15 Feb 2021 13:48:45 +0000"  >&lt;p&gt;Committed into 3.0 at 1f686fd634dbe9b46c03629d2b3bfae345a151e3 and merged into cassandra-3.11 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13333700">CASSANDRA-16181</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mn48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
        <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/1f686fd634dbe9b46c03629d2b3bfae345a151e3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/1f686fd634dbe9b46c03629d2b3bfae345a151e3&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;The ultimate goal here is for the upgrade tests that indicated the problem in the first place to pass consistently. It should be easy enough to modify the CircleCI config to pull the right branches from the previous versions...&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>