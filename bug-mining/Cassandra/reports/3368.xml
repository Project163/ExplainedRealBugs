<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8448] &quot;Comparison method violates its general contract&quot; in AbstractEndpointSnitch</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8448</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Seen in both 1.2 and 2.0.  The error is occurring here: &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/locator/AbstractEndpointSnitch.java#L49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/locator/AbstractEndpointSnitch.java#L49&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Thrift:9] 2014-12-04 20:12:28,732 CustomTThreadPoolServer.java (line 219) Error occurred during processing of message.
com.google.common.util.concurrent.UncheckedExecutionException: java.lang.IllegalArgumentException: Comparison method violates its general contract!
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2199)
	at com.google.common.cache.LocalCache.get(LocalCache.java:3932)
	at com.google.common.cache.LocalCache.getOrLoad(LocalCache.java:3936)
	at com.google.common.cache.LocalCache$LocalLoadingCache.get(LocalCache.java:4806)
	at org.apache.cassandra.service.ClientState.authorize(ClientState.java:352)
	at org.apache.cassandra.service.ClientState.ensureHasPermission(ClientState.java:224)
	at org.apache.cassandra.service.ClientState.hasAccess(ClientState.java:218)
	at org.apache.cassandra.service.ClientState.hasColumnFamilyAccess(ClientState.java:202)
	at org.apache.cassandra.thrift.CassandraServer.createMutationList(CassandraServer.java:822)
	at org.apache.cassandra.thrift.CassandraServer.batch_mutate(CassandraServer.java:954)
	at com.datastax.bdp.server.DseServer.batch_mutate(DseServer.java:576)
	at org.apache.cassandra.thrift.Cassandra$Processor$batch_mutate.getResult(Cassandra.java:3922)
	at org.apache.cassandra.thrift.Cassandra$Processor$batch_mutate.getResult(Cassandra.java:3906)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:201)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IllegalArgumentException: Comparison method violates its general contract!
	at java.util.TimSort.mergeHi(TimSort.java:868)
	at java.util.TimSort.mergeAt(TimSort.java:485)
	at java.util.TimSort.mergeCollapse(TimSort.java:410)
	at java.util.TimSort.sort(TimSort.java:214)
	at java.util.TimSort.sort(TimSort.java:173)
	at java.util.Arrays.sort(Arrays.java:659)
	at java.util.Collections.sort(Collections.java:217)
	at org.apache.cassandra.locator.AbstractEndpointSnitch.sortByProximity(AbstractEndpointSnitch.java:49)
	at org.apache.cassandra.locator.DynamicEndpointSnitch.sortByProximityWithScore(DynamicEndpointSnitch.java:157)
	at org.apache.cassandra.locator.DynamicEndpointSnitch.sortByProximityWithBadness(DynamicEndpointSnitch.java:186)
	at org.apache.cassandra.locator.DynamicEndpointSnitch.sortByProximity(DynamicEndpointSnitch.java:151)
	at org.apache.cassandra.service.StorageProxy.getLiveSortedEndpoints(StorageProxy.java:1408)
	at org.apache.cassandra.service.StorageProxy.getLiveSortedEndpoints(StorageProxy.java:1402)
	at org.apache.cassandra.service.AbstractReadExecutor.getReadExecutor(AbstractReadExecutor.java:148)
	at org.apache.cassandra.service.StorageProxy.fetchRows(StorageProxy.java:1223)
	at org.apache.cassandra.service.StorageProxy.read(StorageProxy.java:1165)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:255)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:225)
	at org.apache.cassandra.auth.Auth.selectUser(Auth.java:243)
	at org.apache.cassandra.auth.Auth.isSuperuser(Auth.java:84)
	at org.apache.cassandra.auth.AuthenticatedUser.isSuper(AuthenticatedUser.java:50)
	at org.apache.cassandra.auth.CassandraAuthorizer.authorize(CassandraAuthorizer.java:69)
	at org.apache.cassandra.service.ClientState$1.load(ClientState.java:338)
	at org.apache.cassandra.service.ClientState$1.load(ClientState.java:335)
	at com.google.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3522)
	at com.google.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2315)
	at com.google.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2278)
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2193)
	... 18 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Workaround: Setting  -Djava.util.Arrays.useLegacyMergeSort=true causes the error to go away.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12760560">CASSANDRA-8448</key>
            <summary>&quot;Comparison method violates its general contract&quot; in AbstractEndpointSnitch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="jblangston@datastax.com">J.B. Langston</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Dec 2014 21:31:09 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:26 +0000</updated>
                            <resolved>Fri, 6 Feb 2015 19:28:24 +0000</resolved>
                                        <fixVersion>2.0.13</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14248389" author="slebresne" created="Tue, 16 Dec 2014 15:50:56 +0000"  >&lt;p&gt;Pretty sure that&apos;s because DynamicEndpointSnitch scores can change in the middle of &lt;tt&gt;sortByProximity&lt;/tt&gt;. We&apos;d need to snapshot the scores somehow before the sorting. &lt;/p&gt;</comment>
                            <comment id="14266191" author="brandon.williams" created="Tue, 6 Jan 2015 14:56:30 +0000"  >&lt;p&gt;ISTM we already do that:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        ArrayList&amp;lt;Double&amp;gt; sortedScores = new ArrayList&amp;lt;&amp;gt;(subsnitchOrderedScores);
        Collections.sort(sortedScores);

        Iterator&amp;lt;Double&amp;gt; sortedScoreIterator = sortedScores.iterator();
        for (Double subsnitchScore : subsnitchOrderedScores)
        {
            if (subsnitchScore &amp;gt; (sortedScoreIterator.next() * (1.0 + BADNESS_THRESHOLD)))
            {
                sortByProximityWithScore(address, addresses);
                return;
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I&apos;m not sure what to do (and have no clear repro steps so I can&apos;t even try.) A simple workaround would be disabling badness, though.&lt;/p&gt;</comment>
                            <comment id="14266626" author="benedict" created="Tue, 6 Jan 2015 19:43:30 +0000"  >&lt;p&gt;compareEndpoints() doesn&apos;t snapshot, it uses the values from the shared &quot;scores&quot; object property, and sortByProximityWithScore ultimately delegates to this.&lt;/p&gt;</comment>
                            <comment id="14269441" author="brandon.williams" created="Thu, 8 Jan 2015 15:33:13 +0000"  >&lt;p&gt;I see, thanks.  So something like this should fix it?&lt;/p&gt;</comment>
                            <comment id="14275626" author="benedict" created="Tue, 13 Jan 2015 18:08:10 +0000"  >&lt;p&gt;The current patch is a no-op...? sortByProximityWithScore needs to create a HashMap (no need to be concurrent) and populate it with the current data, then create a new DynamicEndpointSnitch with that snapshot and call super.sortByProximity on that (with the necessary gymnastics to make that happen, since semantically you can&apos;t call super on another object...)&lt;/p&gt;</comment>
                            <comment id="14309581" author="brandon.williams" created="Fri, 6 Feb 2015 18:35:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;The current patch is a no-op...?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Whoops, that was silly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I think creating a new DES within DES just to sort is going to get very hairy very quickly.  Instead, v2 locks the update and reset tasks so they can&apos;t modify scores while we&apos;re sorting.  This shouldn&apos;t be a big problem if they&apos;re blocked for a while during the sort.&lt;/p&gt;</comment>
                            <comment id="14309660" author="benedict" created="Fri, 6 Feb 2015 19:05:17 +0000"  >&lt;p&gt;The problem with this approach is that sorts will not be able to proceed in parallel, and can themselves be stopped by updates. We could prevent the first with a read/write lock, but this would not prevent the second (and in fact updates would &quot;win&quot; over sorters). I think a better solution might be to simply replace the map wholesale during update - it&apos;s only infrequent, and avoids any unnecessary costs on the common path. &lt;/p&gt;</comment>
                            <comment id="14309679" author="brandon.williams" created="Fri, 6 Feb 2015 19:14:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;sorts will not be able to proceed in parallel&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Doh, good point.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think a better solution might be to simply replace the map wholesale during update&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a good idea and even simpler.  v3 does this.&lt;/p&gt;</comment>
                            <comment id="14309693" author="benedict" created="Fri, 6 Feb 2015 19:19:36 +0000"  >&lt;p&gt;One nit: need to make the shared variable volatile. Otherwise +1&lt;/p&gt;</comment>
                            <comment id="14309707" author="brandon.williams" created="Fri, 6 Feb 2015 19:28:24 +0000"  >&lt;p&gt;Committed w/nit fixed.&lt;/p&gt;</comment>
                            <comment id="14618635" author="kenfailbus" created="Wed, 8 Jul 2015 14:10:48 +0000"  >&lt;p&gt;Folks,&lt;/p&gt;

&lt;p&gt;I still see this error in 2.0.14 version of cassandra. Can you please make sure that nothing got regressed?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12833927">CASSANDRA-9519</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12697076" name="8448-v2.txt" size="3261" author="brandon.williams" created="Fri, 6 Feb 2015 18:35:11 +0000"/>
                            <attachment id="12697091" name="8448-v3.txt" size="1947" author="brandon.williams" created="Fri, 6 Feb 2015 19:15:02 +0000"/>
                            <attachment id="12690862" name="8448.txt" size="811" author="brandon.williams" created="Thu, 8 Jan 2015 15:33:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i238wn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327240">1.2.19</customfieldvalue>
    <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>