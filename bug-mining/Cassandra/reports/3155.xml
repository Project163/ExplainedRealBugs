<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7898] IndexOutOfBoundsException comparing incompatible reversed types in DynamicCompositeType</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7898</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In the following setup, an IndexOutOfBoundsException is often observed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A DynamicCompositeType value is used in a column name (e.g. in a CQL3 cluster key)&lt;/li&gt;
	&lt;li&gt;Two incompatible types (e.g. Int32Type and DoubleType) are used in the dynamic composite value in their reversed form (e.g. ReversedType(Int32Type) and ReversedType(DoubleType)&lt;/li&gt;
	&lt;li&gt;Values for the incompatible types are inserted&lt;/li&gt;
	&lt;li&gt;One of various scenarios occurs that trigger comparison of the column names&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The exception can be variously observed (sometimes not immediately) during query execution, memtable flushing, commit log replay etc. In some cases this can prevent Cassandra server startup (e.g. during commit log replay).&lt;/p&gt;

&lt;p&gt;Typical stack traces follow:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: java.lang.IndexOutOfBoundsException
	at org.apache.cassandra.service.StorageProxy$LocalMutationRunnable.run(StorageProxy.java:1968)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.IndexOutOfBoundsException
	at java.nio.Buffer.checkIndex(Buffer.java:538)
	at java.nio.HeapByteBuffer.getDouble(HeapByteBuffer.java:512)
	at org.apache.cassandra.utils.ByteBufferUtil.toDouble(ByteBufferUtil.java:431)
	at org.apache.cassandra.serializers.DoubleSerializer.deserialize(DoubleSerializer.java:33)
	at org.apache.cassandra.serializers.DoubleSerializer.deserialize(DoubleSerializer.java:25)
	at org.apache.cassandra.db.marshal.AbstractType.compose(AbstractType.java:142)
	at org.apache.cassandra.db.marshal.DoubleType.compare(DoubleType.java:45)
	at org.apache.cassandra.db.marshal.DoubleType.compare(DoubleType.java:28)
	at org.apache.cassandra.db.marshal.ReversedType.compare(ReversedType.java:73)
	at org.apache.cassandra.db.marshal.ReversedType.compare(ReversedType.java:30)
	at org.apache.cassandra.db.marshal.AbstractType.compareCollectionMembers(AbstractType.java:279)
	at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:64)
	at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:36)
	at org.apache.cassandra.db.marshal.AbstractType.compareCollectionMembers(AbstractType.java:279)
	at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:64)
	at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:36)
	at edu.stanford.ppl.concurrent.SnapTreeMap$1.compareTo(SnapTreeMap.java:538)
	at edu.stanford.ppl.concurrent.SnapTreeMap.attemptUpdate(SnapTreeMap.java:1108)
	at edu.stanford.ppl.concurrent.SnapTreeMap.attemptUpdate(SnapTreeMap.java:1192)
	at edu.stanford.ppl.concurrent.SnapTreeMap.attemptUpdate(SnapTreeMap.java:1192)
	at edu.stanford.ppl.concurrent.SnapTreeMap.attemptUpdate(SnapTreeMap.java:1192)
	at edu.stanford.ppl.concurrent.SnapTreeMap.updateUnderRoot(SnapTreeMap.java:1059)
	at edu.stanford.ppl.concurrent.SnapTreeMap.update(SnapTreeMap.java:1023)
	at edu.stanford.ppl.concurrent.SnapTreeMap.putIfAbsent(SnapTreeMap.java:985)
	at org.apache.cassandra.db.AtomicSortedColumns$Holder.addColumn(AtomicSortedColumns.java:319)
	at org.apache.cassandra.db.AtomicSortedColumns.addAllWithSizeDelta(AtomicSortedColumns.java:191)
	at org.apache.cassandra.db.Memtable.resolve(Memtable.java:226)
	at org.apache.cassandra.db.Memtable.put(Memtable.java:173)
	at org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:900)
	at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:374)
	at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:339)
	at org.apache.cassandra.db.RowMutation.apply(RowMutation.java:211)
	at org.apache.cassandra.service.StorageProxy$7.runMayThrow(StorageProxy.java:952)
	at org.apache.cassandra.service.StorageProxy$LocalMutationRunnable.run(StorageProxy.java:1964)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IndexOutOfBoundsException
        at java.nio.Buffer.checkIndex(Buffer.java:538)
        at java.nio.HeapByteBuffer.getDouble(HeapByteBuffer.java:512)
        at org.apache.cassandra.utils.ByteBufferUtil.toDouble(ByteBufferUtil.java:431)
        at org.apache.cassandra.serializers.DoubleSerializer.deserialize(DoubleSerializer.java:33)
        at org.apache.cassandra.serializers.DoubleSerializer.deserialize(DoubleSerializer.java:25)
        at org.apache.cassandra.db.marshal.AbstractType.compose(AbstractType.java:142)
        at org.apache.cassandra.db.marshal.DoubleType.compare(DoubleType.java:45)
        at org.apache.cassandra.db.marshal.DoubleType.compare(DoubleType.java:28)
        at org.apache.cassandra.db.marshal.ReversedType.compare(ReversedType.java:73)
        at org.apache.cassandra.db.marshal.ReversedType.compare(ReversedType.java:30)
        at org.apache.cassandra.db.marshal.AbstractType.compareCollectionMembers(AbstractType.java:279)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:64)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:36)
        at org.apache.cassandra.io.sstable.ColumnNameHelper.max(ColumnNameHelper.java:159)
        at org.apache.cassandra.io.sstable.ColumnNameHelper.mergeMax(ColumnNameHelper.java:245)
        at org.apache.cassandra.io.sstable.SSTableMetadata$Collector.updateMaxColumnNames(SSTableMetadata.java:346)
        at org.apache.cassandra.io.sstable.SSTableMetadata$Collector.update(SSTableMetadata.java:327)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:194)
        at org.apache.cassandra.db.Memtable$FlushRunnable.writeSortedContents(Memtable.java:397)
        at org.apache.cassandra.db.Memtable$FlushRunnable.runWith(Memtable.java:350)
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: java.lang.IndexOutOfBoundsException
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1931)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.IndexOutOfBoundsException
        at java.nio.Buffer.checkIndex(Buffer.java:538)
        at java.nio.HeapByteBuffer.getDouble(HeapByteBuffer.java:512)
        at org.apache.cassandra.utils.ByteBufferUtil.toDouble(ByteBufferUtil.java:431)
        at org.apache.cassandra.serializers.DoubleSerializer.deserialize(DoubleSerializer.java:33)
        at org.apache.cassandra.serializers.DoubleSerializer.deserialize(DoubleSerializer.java:25)
        at org.apache.cassandra.db.marshal.AbstractType.compose(AbstractType.java:142)
        at org.apache.cassandra.db.marshal.DoubleType.compare(DoubleType.java:45)
        at org.apache.cassandra.db.marshal.DoubleType.compare(DoubleType.java:28)
        at org.apache.cassandra.db.marshal.ReversedType.compare(ReversedType.java:73)
        at org.apache.cassandra.db.marshal.ReversedType.compare(ReversedType.java:30)
        at org.apache.cassandra.db.marshal.AbstractType.compareCollectionMembers(AbstractType.java:279)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:64)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:36)
        at org.apache.cassandra.db.marshal.CompositeType.compare(CompositeType.java:310)
        at org.apache.cassandra.db.marshal.CompositeType.intersects(CompositeType.java:275)
        at org.apache.cassandra.db.filter.SliceQueryFilter.shouldInclude(SliceQueryFilter.java:342)
        at org.apache.cassandra.db.filter.QueryFilter.shouldInclude(QueryFilter.java:234)
        at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:236)
        at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:53)
        at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1547)
        at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1376)
        at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:333)
        at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)
        at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1363)
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1927)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12739845">CASSANDRA-7898</key>
            <summary>IndexOutOfBoundsException comparing incompatible reversed types in DynamicCompositeType</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="timw">Tim Whittington</assignee>
                                    <reporter username="timw">Tim Whittington</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Sep 2014 10:04:44 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:34 +0000</updated>
                            <resolved>Thu, 2 Oct 2014 09:22:26 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14125369" author="timw" created="Mon, 8 Sep 2014 10:09:16 +0000"  >&lt;p&gt;The root cause of this is that comparator selection in DynamicComposite inspects only the Java class identity of the AbstractType of the two parts of the comparison, and if they are the same uses the first AbstractType instance as the comparator. If the top level type of both values is ReversedType, then the first such type is used as a comparator to compose and compare both values, but the other value may be incompatible (ReversedType not being a singleton type) - any such comparison where the comparator expects more bytes than are available in the second value results in an IndexOutOfBoundsException.&lt;/p&gt;

&lt;p&gt;Attached patch + unit test that fixes this.&lt;/p&gt;</comment>
                            <comment id="14126105" author="timw" created="Mon, 8 Sep 2014 21:10:29 +0000"  >&lt;p&gt;Original patch lost ordering of compatible ReversedType(X) in a dynamic composite - updated patch fixes this and adds additional testing for preservation of order in reversed types.&lt;/p&gt;</comment>
                            <comment id="14156261" author="slebresne" created="Thu, 2 Oct 2014 09:22:26 +0000"  >&lt;p&gt;Looks like a reasonable (and simple) fix, committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12667245" name="cassandra-2.0-7898.txt" size="8327" author="timw" created="Mon, 8 Sep 2014 21:10:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[timw]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zsb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>