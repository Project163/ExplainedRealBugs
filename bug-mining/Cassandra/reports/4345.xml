<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12071] Regression in flushing throughput under load after CASSANDRA-6696</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12071</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The way flushing used to work is that a ColumnFamilyStore could have multiple Memtables flushing at once and multiple ColumnFamilyStores could flush at the same time. The way it works now there can be only a single flush of any ColumnFamilyStore &amp;amp; Memtable running in the C* process, and the number of threads applied to that flush is bounded by the number of disks in JBOD.&lt;/p&gt;

&lt;p&gt;This works ok most of the time but occasionally flushing will be a little slower and ingest will outstrip it and then block on available memory. At this point you see several second stalls that cause timeouts.&lt;/p&gt;

&lt;p&gt;This is a problem for reasonable configurations that don&apos;t use JBOD but have access to a fast disk that can handle some IO queuing (RAID, SSD).&lt;/p&gt;

&lt;p&gt;You can reproduce on beefy hardware (12 cores 24 threads, 64 gigs of RAM, SSD) if you unthrottle compaction or set it to something like 64 megabytes/second and run with 8 compaction threads and stress with the default write workload and a reasonable number of threads. I tested with 96.&lt;/p&gt;

&lt;p&gt;It started happening after about 60 gigabytes of data was loaded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12982091">CASSANDRA-12071</key>
            <summary>Regression in flushing throughput under load after CASSANDRA-6696</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jun 2016 20:49:04 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:28 +0000</updated>
                            <resolved>Fri, 29 Jul 2016 22:25:45 +0000</resolved>
                                        <fixVersion>3.8</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15345605" author="jbellis" created="Thu, 23 Jun 2016 02:45:52 +0000"  >&lt;p&gt;You&apos;re seeing this against a single table, right?  So ingest parallelism across multiple tables would make it even worse?&lt;/p&gt;</comment>
                            <comment id="15345631" author="aweisberg" created="Thu, 23 Jun 2016 03:13:06 +0000"  >&lt;p&gt;I am seeing this against a single table. I don&apos;t think the number of tables matters. The memory pool is global for the process and shared by all tables.&lt;/p&gt;

&lt;p&gt;The parallelism is reduced both for a single table and across tables. The issue is that there is a single threaded executor kicking off flushes that is waiting on the result of whatever amount of parallelism is available for a single Memtable flush. &lt;a href=&quot;https://github.com/apache/cassandra/commit/e2c6341898fa43b0e262ef031f267587050b8d0f#diff-f0a15c3588b56c5ce53ece7c48e325b5R262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;The parallelism for a single Memtable flush is set to the the # of JBOD disks.&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15361046" author="krummas" created="Mon, 4 Jul 2016 09:04:18 +0000"  >&lt;p&gt;&lt;tt&gt;Flush&lt;/tt&gt; runs on the &lt;tt&gt;flushExecutor&lt;/tt&gt; and splits the memtable up based on the number of data directories on the node and executes the &lt;tt&gt;FlushRunnables&lt;/tt&gt; on the per disk flush executors. It then blocks until all per disk runnables are completed to be able to run &lt;tt&gt;PostFlush&lt;/tt&gt; etc.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;flushExecutor&lt;/tt&gt; size is 1 we can only ever execute a single flush at a time.&lt;/p&gt;

&lt;p&gt;Patch to bump it to &lt;tt&gt;memtable_flush_writers&lt;/tt&gt; &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/12071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; - in my tests this removes the timeout issues&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; could you try it out?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; to review since you might have some ideas for further improvements&lt;/p&gt;

&lt;p&gt;tests here:&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-12071-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-12071-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-12071-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-12071-testall/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15361225" author="blambov" created="Mon, 4 Jul 2016 12:11:06 +0000"  >&lt;p&gt;+1 to commit.&lt;/p&gt;

&lt;p&gt;The growing number of threads in this piece of code is a bit worrying, but improving that needs some non-trivial restructuring (which should come soon enough as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8496&quot; title=&quot;Remove MemtablePostFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8496&quot;&gt;CASSANDRA-8496&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="15361235" author="krummas" created="Mon, 4 Jul 2016 12:21:41 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                            <comment id="15362670" author="aweisberg" created="Tue, 5 Jul 2016 15:53:38 +0000"  >&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; looks solid to me. Got to 173 gigabytes and performance was stable. Flushing was down to 9 megabytes a second for one thread so those extra threads really helped out.&lt;/p&gt;</comment>
                            <comment id="15400086" author="aweisberg" created="Fri, 29 Jul 2016 22:04:14 +0000"  >&lt;p&gt;Turns out this is still a problem because the usage of an unbounded LinkedBlockingQueue means that TPE will never actually spin up additional threads.&lt;/p&gt;

&lt;p&gt;You can see that this was necessary for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2178&quot; title=&quot;Memtable Flush writers doesn&amp;#39;t actually flush in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2178&quot;&gt;&lt;del&gt;CASSANDRA-2178&lt;/del&gt;&lt;/a&gt; as well.&lt;/p&gt;</comment>
                            <comment id="15400129" author="aweisberg" created="Fri, 29 Jul 2016 22:25:45 +0000"  >&lt;p&gt;Going to bring this up in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12228&quot; title=&quot;Write performance regression in 3.x vs 3.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12228&quot;&gt;&lt;del&gt;CASSANDRA-12228&lt;/del&gt;&lt;/a&gt; since this was resolved and released already.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zxjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>