<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:34:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4532] NPE when trying to select a slice from a composite table</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4532</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I posted this question on StackOverflow, because i need a solution. &lt;/p&gt;

&lt;p&gt;Created a table with :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create table compositetest(m_id ascii,i_id int,l_id ascii,body ascii, PRIMARY KEY(m_id,i_id,l_id));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;wanted to slice the results returned, so did something like below, not sure if its the right way. The first one returns data perfectly as expected, second one to get the next 3 columns closes the transport of my cqlsh&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:testkeyspace1&amp;gt; select * from compositetest where i_id&amp;lt;=3 limit 3;
 m_id | i_id | l_id | body
------+------+------+------
   m1 |    1 |   l1 |   b1
   m1 |    2 |   l2 |   b2
   m2 |    1 |   l1 |   b1

cqlsh:testkeyspace1&amp;gt; Was trying to write something for slice range.

TSocket read 0 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is there a way to achieve what I am doing here, it would be good if some meaning ful error is sent back, instead of cqlsh closing the transport.&lt;/p&gt;

&lt;p&gt;On the server side I see the following error.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [Thrift:3] 2012-08-12 15:15:24,414 CustomTThreadPoolServer.java (line 204) Error occurred during processing of message.
java.lang.NullPointerException
	at org.apache.cassandra.cql3.statements.SelectStatement$Restriction.setBound(SelectStatement.java:1277)
	at org.apache.cassandra.cql3.statements.SelectStatement$RawStatement.updateRestriction(SelectStatement.java:1151)
	at org.apache.cassandra.cql3.statements.SelectStatement$RawStatement.prepare(SelectStatement.java:1001)
	at org.apache.cassandra.cql3.QueryProcessor.getStatement(QueryProcessor.java:215)
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:121)
	at org.apache.cassandra.thrift.CassandraServer.execute_cql_query(CassandraServer.java:1237)
	at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3542)
	at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3530)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:186)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
	at java.lang.Thread.run(Thread.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With ThriftClient I get :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.thrift.transport.TTransportException
	at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)
	at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)
	at org.apache.thrift.transport.TFramedTransport.readFrame(TFramedTransport.java:129)
	at org.apache.thrift.transport.TFramedTransport.read(TFramedTransport.java:101)
	at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)
	at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:378)
	at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:297)
	at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:204)
	at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:69)
	at org.apache.cassandra.thrift.Cassandra$Client.recv_execute_cql_query(Cassandra.java:1402)
	at org.apache.cassandra.thrift.Cassandra$Client.execute_cql_query(Cassandra.java:1388)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Cassandra 1.1.3 (2 nodes) on a single host - mac osx&lt;/p&gt;</environment>
        <key id="12603138">CASSANDRA-4532</key>
            <summary>NPE when trying to select a slice from a composite table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="basu76">basanth gowda</reporter>
                        <labels>
                            <label>Slice</label>
                            <label>cql</label>
                            <label>cql3</label>
                    </labels>
                <created>Sun, 12 Aug 2012 19:41:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:29 +0000</updated>
                            <resolved>Thu, 6 Sep 2012 14:57:34 +0000</resolved>
                                        <fixVersion>1.1.5</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13441943" author="thepaul" created="Sat, 25 Aug 2012 19:15:03 +0000"  >&lt;p&gt;Please give the exact queries you used which reproduce the problem. &quot;&lt;tt&gt;Was trying to write something for slice range.&lt;/tt&gt;&quot; isn&apos;t a valid query.&lt;/p&gt;</comment>
                            <comment id="13444059" author="basu76" created="Wed, 29 Aug 2012 13:44:38 +0000"  >&lt;p&gt;I was trying to get a slice range, like you could do in thrift.&lt;/p&gt;

&lt;p&gt;table defn :&lt;/p&gt;

&lt;p&gt;create tables schedules(status ascii, timecreated bigint, key ascii, nil ascii, PRIMARY KEY(status,timecreated,key));&lt;/p&gt;

&lt;p&gt;for the same time there can be a lot of entries.&lt;/p&gt;

&lt;p&gt;Lets suppose there are 50 entries that match where timecreated is &amp;lt; Ln&lt;/p&gt;

&lt;p&gt;1st query : select * from schedules where timecreated &amp;lt;= &amp;lt;Ln&amp;gt; limit 10;&lt;/p&gt;


&lt;p&gt;2nd Query : select * from schedules where timecreated&amp;gt;=L10 AND key=K10 and timecreated&amp;lt;Ln.&lt;/p&gt;

&lt;p&gt;In CQL terms this is a wrong query I know, basically not sure how to represent Between in CQL&lt;/p&gt;


&lt;p&gt;In Hector I would do, get slice range limiting 10 first time, &lt;/p&gt;

&lt;p&gt;for the next query (until no more are returned) I would use the time returned by last query and key returned by last query as the start range. This is in production and works perfectly fine&lt;/p&gt;</comment>
                            <comment id="13444067" author="jbellis" created="Wed, 29 Aug 2012 13:54:45 +0000"  >&lt;p&gt;can you test against trunk?&lt;/p&gt;</comment>
                            <comment id="13444099" author="basu76" created="Wed, 29 Aug 2012 14:21:06 +0000"  >&lt;p&gt;No luck. See the last query closed the socket. I took the latest from git and compiled&lt;/p&gt;

&lt;p&gt;Here are the steps to reproduce :&lt;/p&gt;

&lt;p&gt;cqlsh:testkeyspace1&amp;gt; create table compositetest(status ascii,ctime bigint,key ascii,nil ascii,PRIMARY KEY(status,ctime,key));&lt;/p&gt;

&lt;p&gt;cqlsh:testkeyspace1&amp;gt; insert into compositetest(status,ctime,key,nil) VALUES (&apos;C&apos;,12345678,&apos;key1&apos;,&apos;&apos;);&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; insert into compositetest(status,ctime,key,nil) VALUES (&apos;C&apos;,12345678,&apos;key2&apos;,&apos;&apos;);&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; insert into compositetest(status,ctime,key,nil) VALUES (&apos;C&apos;,12345679,&apos;key3&apos;,&apos;&apos;);&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; insert into compositetest(status,ctime,key,nil) VALUES (&apos;C&apos;,12345679,&apos;key4&apos;,&apos;&apos;);&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; insert into compositetest(status,ctime,key,nil) VALUES (&apos;C&apos;,12345679,&apos;key5&apos;,&apos;&apos;);&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; insert into compositetest(status,ctime,key,nil) VALUES (&apos;C&apos;,12345680,&apos;key6&apos;,&apos;&apos;);&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; select * from compositetest;&lt;br/&gt;
 status | ctime    | key  | nil&lt;br/&gt;
-------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;--------&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;----&lt;del&gt;+&lt;/del&gt;----&lt;br/&gt;
      C | 12345678 | key1 |    &lt;br/&gt;
      C | 12345678 | key2 |    &lt;br/&gt;
      C | 12345679 | key3 |    &lt;br/&gt;
      C | 12345679 | key4 |    &lt;br/&gt;
      C | 12345679 | key5 |    &lt;br/&gt;
      C | 12345680 | key6 |    &lt;/p&gt;

&lt;p&gt;1st query of slice :&lt;/p&gt;

&lt;p&gt;cqlsh:testkeyspace1&amp;gt; select * from compositetest where ctime&amp;lt;=12345680 limit 3;&lt;br/&gt;
 status | ctime    | key  | nil&lt;br/&gt;
-------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;--------&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;----&lt;del&gt;+&lt;/del&gt;-----&lt;br/&gt;
      C | 12345678 | key1 |     &lt;br/&gt;
      C | 12345678 | key2 |     &lt;br/&gt;
      C | 12345679 | key3 | null&lt;/p&gt;

&lt;p&gt;Second Query : I want to get values where first one left off (Yes you could do this with hector) &lt;span class=&quot;error&quot;&gt;&amp;#91;Try 1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;cqlsh:testkeyspace1&amp;gt; select * from compositetest where ctime&amp;gt;=12345679 and key=&apos;key3&apos; and ctime&amp;lt;=12345680 limit 3;&lt;br/&gt;
Bad Request: PRIMARY KEY part key cannot be restricted (preceding part ctime is either not restricted or by a non-EQ relation) &lt;span class=&quot;error&quot;&gt;&amp;#91;Try 2&amp;#93;&lt;/span&gt;&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt; select * from compositetest where ctime=12345679 and key=&apos;key3&apos; and ctime&amp;lt;=12345680 limit 3;&lt;br/&gt;
TSocket read 0 bytes&lt;br/&gt;
cqlsh:testkeyspace1&amp;gt;&lt;/p&gt;</comment>
                            <comment id="13449663" author="slebresne" created="Thu, 6 Sep 2012 13:41:37 +0000"  >&lt;p&gt;Attaching (trivial) patch to fix the validation issue (the request is invalid because it mixes an equal and inequal on the same ctime column).&lt;/p&gt;

&lt;p&gt;For the record, a valid request that does the equivalent of a thrift sliceRange would be:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT * FROM compositetest WHERE ctime&amp;gt;=12345679 and ctime&amp;lt;=12345680 limit 3;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If you further want to restrict the result to those column where key=&apos;key3&apos;, you&apos;d have to do it client side (but that would be the same with thrift).&lt;/p&gt;</comment>
                            <comment id="13449681" author="jbellis" created="Thu, 6 Sep 2012 13:53:18 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13449718" author="slebresne" created="Thu, 6 Sep 2012 14:57:34 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13449764" author="basu76" created="Thu, 6 Sep 2012 15:59:22 +0000"  >&lt;p&gt;Sylvain,&lt;br/&gt;
Thanks for the fix, May be I should have opened the ticket differently. My main issue is not that the connection on cqlsh was getting closed (because of NPE) or exception being thrown in thrift client. To adopt CQL3 mainstream slice with paging is need, I saw some other ticket, where this proposal was there. &lt;/p&gt;

&lt;p&gt;Main reason I opened the ticket was for not being able to slice (rather no syntax support for that, to continue where the last query left off). This is a piece of code that was written using Hector and my assumption is the filtering was done on server side. We are using this in production. I modified attributes (to get rid of proprietary stuff, so may be broken, but should give an idea of what I was trying to do with CQL3)&lt;/p&gt;

&lt;p&gt;            long cStartTime = 0L;&lt;br/&gt;
            long startTime = System.nanoTime();&lt;br/&gt;
            boolean fetchNextBatch = true;&lt;br/&gt;
            int totalKeysFetched = 0;&lt;br/&gt;
            String lastKeyFetched = null;&lt;br/&gt;
            long cEndTime = &amp;lt;Some Time in Millis&amp;gt;;&lt;br/&gt;
            while(fetchNextBatch) {&lt;br/&gt;
                fetchNextBatch = false;&lt;br/&gt;
                int pageSize = 3; //Just for demonstration&lt;br/&gt;
                SliceQuery&amp;lt;Object,DynamicComposite,String&amp;gt; sliceQuery =   HFactory.createSliceQuery(keyspace,&amp;lt;KEY SERIALIZER&amp;gt;,DynamicCompositeSerializer.get(),StringSerializer.get());&lt;br/&gt;
                sliceQuery.setKey(&quot;C&quot;);&lt;br/&gt;
                sliceQuery.setColumnFamily(&quot;&amp;lt;SOME CF NAME&amp;gt;&quot;);&lt;br/&gt;
                DynamicComposite startRange = new DynamicComposite();&lt;/p&gt;

&lt;p&gt;                startRange.addComponent(cStartTime,LongSerializer.get()); //For the first fetch - this will be 0L&lt;br/&gt;
                startRange.addComponent(lastKeyFetched,StringSerializer.get()); // this will be null for first fetch&lt;/p&gt;

&lt;p&gt;                DynamicComposite endRange = new DynamicComposite();&lt;br/&gt;
                endRange.addComponent(new Long(cEndTime), LongSerializer.get(), &quot;LongType&quot;, AbstractComposite.ComponentEquality.LESS_THAN_EQUAL);&lt;br/&gt;
                //Add another config if we need columnPageSize&lt;br/&gt;
                sliceQuery.setRange(startRange,endRange,false,pageSize);&lt;/p&gt;

&lt;p&gt;                long start = System.nanoTime();&lt;br/&gt;
                QueryResult&amp;lt;ColumnSlice&amp;lt;DynamicComposite, String&amp;gt;&amp;gt; result = sliceQuery.execute();&lt;br/&gt;
                float t =  (float)((System.nanoTime() - start)/1000000);&lt;br/&gt;
                System.out.println(&quot;TIME FOR QUERY :&quot; + t  + &quot; MILLI SECONDS&quot;);&lt;/p&gt;

&lt;p&gt;                ColumnSlice&amp;lt;DynamicComposite, String&amp;gt; cs = result.get();&lt;br/&gt;
                List&amp;lt;HColumn&amp;lt;DynamicComposite,String&amp;gt;&amp;gt; compositeList = cs.getColumns();&lt;/p&gt;

&lt;p&gt;                for(int i =0;i&amp;lt;compositeList.size();i++) &lt;/p&gt;
{
                    HColumn&amp;lt;DynamicComposite, String&amp;gt; col = compositeList.get(i);
                    cStartTime = col.getName().get(0,LongSerializer.get()); //This will be the cTime for the start range of the next query
                    lastKeyFetched = col.getName().get(1,StringSerializer.get()); //In the start range for the next query, this key will be used.
                    keyTimeMap.put(lastKeyFetched,scheduleStartTime);
                    totalKeysFetched ++;
                }

&lt;p&gt;                //Process Fetched Data &lt;/p&gt;

&lt;p&gt;                fetchNextBatch = compositeList.size() == pageSize; // If the number of records retrieved is equal to the page size, then there are probably more records left &lt;br/&gt;
            }&lt;/p&gt;</comment>
                            <comment id="13449799" author="slebresne" created="Thu, 6 Sep 2012 16:48:06 +0000"  >&lt;p&gt;@basanth Slices are definitely supported in CQL3, the query I gave you earlier involves a slice for instance. In a fair amount of cases, paging within a Cassandra row is also pretty simple to do in CQL3 too. It is true that in some cases it&apos;s not completely as easy as in thrift. For those last cases, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4415&quot; title=&quot;Add cursor API/auto paging to the native CQL protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4415&quot;&gt;&lt;del&gt;CASSANDRA-4415&lt;/del&gt;&lt;/a&gt; should provide a solution.&lt;/p&gt;

&lt;p&gt;If you questions on how to translate some piece thrift code to CQL3, you&apos;re definitively welcome to ask them but please use the user mailing list for such inquiries.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12544045" name="4532.txt" size="1093" author="slebresne" created="Thu, 6 Sep 2012 13:41:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gwt3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96745</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>