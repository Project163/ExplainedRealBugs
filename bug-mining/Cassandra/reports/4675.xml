<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13320] upgradesstables fails after upgrading from 2.1.x to 3.0.11</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13320</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I tried to execute &lt;tt&gt;nodetool upgradesstables&lt;/tt&gt; after upgrading cluster from 2.1.16 to 3.0.11, but it fails when upgrading a table with 2i.&lt;/p&gt;

&lt;p&gt;This problem can be reproduced as follows.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ ccm create test -v 2.1.16 -n 1 -s
$ ccm node1 cqlsh  -e &lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;:1}&quot;&lt;/span&gt;
$ ccm node1 cqlsh  -e &lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE test.test(k1 text, k2 text, PRIMARY KEY( k1 ));&quot;&lt;/span&gt;
$ ccm node1 cqlsh  -e &lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE INDEX k2 ON test.test(k2);&quot;&lt;/span&gt;
 
$ ccm node1 cqlsh  -e &lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO test.test (k1, k2 ) VALUES ( &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;) ;&quot;&lt;/span&gt;
$ ccm node1 cqlsh  -e &lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO test.test (k1, k2 ) VALUES ( &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;) ;&quot;&lt;/span&gt;
 
$ ccm node1 nodetool flush
 
$ &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in `seq 1 `; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; ccm node${i} stop; ccm node${i} setdir -v3.0.11;ccm node${i} start; done
$ ccm node1 nodetool upgradesstables test test
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/y/bin/ccm&quot;&lt;/span&gt;, line 86, in &amp;lt;module&amp;gt;
    cmd.run()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/y/lib/python2.7/site-packages/ccmlib/cmds/node_cmds.py&quot;&lt;/span&gt;, line 267, in run
    stdout, stderr = self.node.nodetool(&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;.join(self.args[1:]))
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/y/lib/python2.7/site-packages/ccmlib/node.py&quot;&lt;/span&gt;, line 742, in nodetool
    raise NodetoolError(&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;.join(args), exit_status, stdout, stderr)
ccmlib.node.NodetoolError: Nodetool command &lt;span class=&quot;code-quote&quot;&gt;&apos;/home/zzheng/.ccm/repository/3.0.11/bin/nodetool -h localhost -p 7100 upgradesstables test test&apos;&lt;/span&gt; failed; exit status: 2; stderr: WARN  06:29:08 Only 10476 MB free across all data volumes. Consider adding more capacity to your cluster or removing obsolete snapshots
error: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
-- StackTrace --
java.lang.AssertionError
	at org.apache.cassandra.db.rows.Rows.collectStats(Rows.java:70)
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter$StatsCollector.applyToRow(BigTableWriter.java:197)
	at org.apache.cassandra.db.transform.BaseRows.applyOne(BaseRows.java:116)
	at org.apache.cassandra.db.transform.BaseRows.add(BaseRows.java:107)
	at org.apache.cassandra.db.transform.UnfilteredRows.add(UnfilteredRows.java:41)
	at org.apache.cassandra.db.transform.Transformation.add(Transformation.java:156)
	at org.apache.cassandra.db.transform.Transformation.apply(Transformation.java:122)
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter.append(BigTableWriter.java:147)
	at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:125)
	at org.apache.cassandra.db.compaction.writers.DefaultCompactionWriter.realAppend(DefaultCompactionWriter.java:57)
	at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.append(CompactionAwareWriter.java:109)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:195)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:89)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:61)
	at org.apache.cassandra.db.compaction.CompactionManager$5.execute(CompactionManager.java:415)
	at org.apache.cassandra.db.compaction.CompactionManager$2.call(CompactionManager.java:307)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result of dumping the 2i sstable is as follows.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;61&quot;&lt;/span&gt;,1488961273,1488961269822817,&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;]]},
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;61&quot;&lt;/span&gt;,&quot;&quot;,1488961273015759]]}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This problem is occurred by the tombstone row. When this row is processed in &lt;tt&gt;LegacyLayout.java&lt;/tt&gt;, it will be treated as a row maker.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/LegacyLayout.java#L1195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/LegacyLayout.java#L1195&lt;/a&gt;&lt;br/&gt;
Then the deletion info will be lost.&lt;/p&gt;

&lt;p&gt;As a result, the row will be a empty row, which causes the assertion error.&lt;/p&gt;

&lt;p&gt;To avoid this, I added the code to add row deletion info when the row is a tombstone and &lt;b&gt;not&lt;/b&gt; a row marker, and it works as I expect, which means that &lt;tt&gt;upgradesstables&lt;/tt&gt; succeeds and row deletion info is remained.&lt;/p&gt;

&lt;p&gt;However I don&apos;t understand whether this change will cause another problem. Anyway, I submit my patch as a reference.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13049952">CASSANDRA-13320</key>
            <summary>upgradesstables fails after upgrading from 2.1.x to 3.0.11</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="zzheng">Zhongxiang Zheng</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Mar 2017 08:08:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:08 +0000</updated>
                            <resolved>Fri, 17 Mar 2017 11:16:38 +0000</resolved>
                                        <fixVersion>3.0.13</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15905555" author="jjirsa" created="Fri, 10 Mar 2017 19:02:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; - given your work on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12620&quot; title=&quot;Resurrected rows with expired TTL on update to 3.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12620&quot;&gt;&lt;del&gt;CASSANDRA-12620&lt;/del&gt;&lt;/a&gt; , either of you available to comment on the correctness of this? &lt;/p&gt;</comment>
                            <comment id="15905643" author="jjirsa" created="Fri, 10 Mar 2017 20:15:38 +0000"  >&lt;p&gt;For troubleshooting in case it helps someone, here&apos;s some dumps of the sstable data post-upgradesstables with 3.0.10:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ ~/.ccm/repository/3.0.10/tools/bin/sstabledump ~/.ccm/test/node1/data0/test/test-0c0e762005c511e7990409d9d370a92a/mc-2-big-Data.db
[
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 15,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T19:09:14.478850Z&quot;&lt;/span&gt; },
        &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [
          { &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;k2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt; }
        ]
      }
    ]
  }
]

$ ~/.ccm/repository/3.0.10/tools/bin/sstabledump ~/.ccm/test/node1/data0/test/test-0c0e762005c511e7990409d9d370a92a/.k2/mc-2-big-Data.db
[
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 15,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;61&quot;&lt;/span&gt; ],
        &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T19:09:13.979340Z&quot;&lt;/span&gt; },
        &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [ ]
      }
    ]
  },
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 23
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 38,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;61&quot;&lt;/span&gt; ],
        &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T19:09:14.478850Z&quot;&lt;/span&gt; },
        &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [ ]
      }
    ]
  }
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and 3.0.11 + the patch from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zzheng&quot; class=&quot;user-hover&quot; rel=&quot;zzheng&quot;&gt;zzheng&lt;/a&gt; &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ ~/.ccm/repository/3.0.11/tools/bin/sstabledump ~/.ccm/test/node1/data0/test/test-a4feee4005cb11e79e0709d9d370a92a/mc-2-big-Data.db
[
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 22,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T20:10:03.973045Z&quot;&lt;/span&gt; },
        &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [
          { &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;k2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt; }
        ]
      }
    ]
  }
]
$ ~/.ccm/repository/3.0.11/tools/bin/sstabledump ~/.ccm/test/node1/data0/test/test-a4feee4005cb11e79e0709d9d370a92a/.k2/mc-2-big-Data.db
[
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 26,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;61&quot;&lt;/span&gt; ],
        &lt;span class=&quot;code-quote&quot;&gt;&quot;deletion_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;marked_deleted&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T20:09:59.667091Z&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;local_delete_time&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T20:10:03Z&quot;&lt;/span&gt; },
        &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [ ]
      }
    ]
  },
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 27
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 52,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;61&quot;&lt;/span&gt; ],
        &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2017-03-10T20:10:03.973045Z&quot;&lt;/span&gt; },
        &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [ ]
      }
    ]
  }
]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="15905651" author="blerer" created="Fri, 10 Mar 2017 20:25:46 +0000"  >&lt;p&gt;I will try to look into that next week.&lt;/p&gt;</comment>
                            <comment id="15924841" author="beobal" created="Tue, 14 Mar 2017 19:21:16 +0000"  >&lt;p&gt;I think that the change is slightly incorrect and can cause a regression along the lines of what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; describes &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12620?focusedCommentId=15751089&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15751089&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;. 2i tables are the exception to the assertion that we never actually delete row markers in 2.x (sort of), so I think the correct fix should be:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/src/java/org/apache/cassandra/db/LegacyLayout.java b/src/java/org/apache/cassandra/db/LegacyLayout.java
index 972bb9f..bfe3bff 100644
--- a/src/java/org/apache/cassandra/db/LegacyLayout.java
+++ b/src/java/org/apache/cassandra/db/LegacyLayout.java
@@ -1196,8 +1196,12 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LegacyLayout
                 &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !cell.value.hasRemaining();
                 &lt;span class=&quot;code-comment&quot;&gt;// In 2.1, the row marker expired cell might have been converted into a deleted one by compaction. So,
&lt;/span&gt;                 &lt;span class=&quot;code-comment&quot;&gt;// we need to set the primary key liveness info only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the cell is not a deleted one.
&lt;/span&gt;+                &lt;span class=&quot;code-comment&quot;&gt;// The only time in 2.x that we actually delete a row marker is in 2i tables, so in that &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&lt;/span&gt;+                &lt;span class=&quot;code-comment&quot;&gt;// want to actually propagate the row deletion. (CASSANDRA-13320)
&lt;/span&gt;                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!cell.isTombstone())
                     builder.addPrimaryKeyLivenessInfo(LivenessInfo.create(cell.timestamp, cell.ttl, cell.localDeletionTime));
+                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (metadata.isIndex())
+                    builder.addRowDeletion(Row.Deletion.regular(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DeletionTime(cell.timestamp, cell.localDeletionTime)));
             }
             &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
             {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15926213" author="slebresne" created="Wed, 15 Mar 2017 13:57:12 +0000"  >&lt;p&gt;Agreed, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;&apos;s patch lgtm.&lt;/p&gt;</comment>
                            <comment id="15926225" author="blerer" created="Wed, 15 Mar 2017 14:02:58 +0000"  >&lt;p&gt;I still have some tests that I would like to run on top of the upgrade tests. &lt;/p&gt;</comment>
                            <comment id="15926424" author="blerer" created="Wed, 15 Mar 2017 16:02:20 +0000"  >&lt;p&gt;I discussed off line with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;. One of my concerned was with expired TTLs on the index rows that have been compacted (converted in to deleted cells). Sam pointed out that as the index tables only have row markers and no regular data, it should be fine to convert them into deleted rows.&lt;br/&gt;
So, I am +1 with the patch if the upgrade tests look good.&lt;/p&gt;
</comment>
                            <comment id="15929778" author="beobal" created="Fri, 17 Mar 2017 11:16:38 +0000"  >&lt;p&gt;Thanks, I had some problems running the upgrade tests on cassci, but I finally managed to get a &lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/beobal/job/beobal-13320-3.0-upgrade-upgrade/5/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pretty clean run&lt;/a&gt;. The supercolumn test failures are also present upstream, which looks like an issue with a no-longer-supported sstable version. I was slightly concerned by the failure in &lt;tt&gt;test_cell_TTL_expiry_during_paging&lt;/tt&gt; but I&apos;ve run that locally several times without any problem. We did actually have a failing test indicating this problem (which is no longer failing) tracked by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13059&quot; title=&quot;dtest failure in upgrade_tests.upgrade_through_versions_test.TestUpgrade_current_2_1_x_To_indev_3_x.rolling_upgrade_test&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13059&quot;&gt;&lt;del&gt;CASSANDRA-13059&lt;/del&gt;&lt;/a&gt;, so I&apos;m marking that resolved too. &lt;/p&gt;

&lt;p&gt;Committed to 3.0 in &lt;tt&gt;5918375e88bcacfab47e44cbfa2dd202ec634725&lt;/tt&gt; &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13003422">CASSANDRA-12620</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13029171">CASSANDRA-13059</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13057017">CASSANDRA-13347</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="13029171">CASSANDRA-13059</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12857268" name="13320.patch" size="982" author="zzheng" created="Fri, 10 Mar 2017 08:10:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3b88n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338635">3.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338635">3.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>