<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8757] IndexSummaryBuilder should construct itself offheap, and share memory between the result of each build() invocation</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8757</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description></description>
                <environment></environment>
        <key id="12773291">CASSANDRA-8757</key>
            <summary>IndexSummaryBuilder should construct itself offheap, and share memory between the result of each build() invocation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Sun, 8 Feb 2015 14:03:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:21 +0000</updated>
                            <resolved>Tue, 10 Mar 2015 12:38:26 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14318575" author="benedict" created="Thu, 12 Feb 2015 17:21:46 +0000"  >&lt;p&gt;Patch available &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/8757-offheapsummarybuilder&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The approach is pretty straight forward in principle: we split the offheap memory for the summary into two allocations, the summary offsets and the summary entries - the latter composed of the key and its offset in the index file. The offsets index from zero now, instead of from the end of the offsets themselves, and so to maintain compatibility we do not change the serialization format, on read/write we simply subtract/add the necessary offset. This split permits us to have a separate chunk of memory for each that we can append to in the writer, so that a prefix of both can be used to open a summary before we&apos;ve finished writing. This permits us to share memory between all early instances of a table.&lt;/p&gt;</comment>
                            <comment id="14324492" author="benedict" created="Tue, 17 Feb 2015 17:20:22 +0000"  >&lt;p&gt;Just to explain why I consider this a priority for 2.1, if you have users with very large STCS compactions, we can have some fairly pathological behaviour. Let&apos;s say our target file is 500Gb, and 20% of the data is the partition key. This means the summary will be approximately 800Mb, assuming defaults. If we re-open the result every 50Mb (default behaviour) we will allocate a total of 4Tb of memory for summaries over the duration of the compaction. Not all of this will be used at once; ideally, in fact, we would only ever have maybe 1.6Gb allocated. But there is no guarantee, and longer running operations like compactions could retain copies of multiple different instances indefinitely, so we could see several Gb of summary floating around in this pathological case. If there is a reticence to introduce this into 2.1, another option might be to either disable early reopening entirely for very large files, or to open far less frequently, say at even intervals of sqrt(N) where N is the expected end size, or at logarthmically further apart intervals. But the advantage of reopening vanishes if we do this, so we may as well just not do it for such files without this patch.&lt;/p&gt;</comment>
                            <comment id="14329186" author="tjake" created="Fri, 20 Feb 2015 17:12:33 +0000"  >&lt;p&gt;Looking at this in conjunction with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8689&quot; title=&quot;Assertion error in 2.1.2: ERROR [IndexSummaryManager:1]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8689&quot;&gt;&lt;del&gt;CASSANDRA-8689&lt;/del&gt;&lt;/a&gt;.  There is some issue with this patch, all tests are hanging on the SchemaLoader&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=10 tid=0x00007f9ab000f000 nid=0x11d5 waiting on condition [0x00007f9ab7447000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000ecb941f8&amp;gt; (a java.util.concurrent.FutureTask)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
	at java.util.concurrent.FutureTask.awaitDone(FutureTask.java:425)
	at java.util.concurrent.FutureTask.get(FutureTask.java:187)
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:398)
	at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:375)
	at org.apache.cassandra.service.MigrationManager.announceNewKeyspace(MigrationManager.java:231)
	at org.apache.cassandra.service.MigrationManager.announceNewKeyspace(MigrationManager.java:220)
	at org.apache.cassandra.service.MigrationManager.announceNewKeyspace(MigrationManager.java:215)
	at org.apache.cassandra.SchemaLoader.loadSchema(SchemaLoader.java:65)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:27)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:220)
	at junit.framework.JUnit4TestAdapter.run(JUnit4TestAdapter.java:39)
	at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:532)
	at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:1179)
	at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:1030)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14330143" author="benedict" created="Sat, 21 Feb 2015 11:39:20 +0000"  >&lt;p&gt;Broken by the rebase, since 8792&apos;s behaviour was changed. The IndexSummaryBuilder calculates a maxExpectedEntries count of zero, which was perfectly safe when we accepted zero length allocations. The new version of 8792 does not support this, so we have to ensure the maxExpectedEntries is at least 1, so we do not allocate a zero length region of memory. Pushed an update.&lt;/p&gt;</comment>
                            <comment id="14339391" author="aweisberg" created="Thu, 26 Feb 2015 23:16:00 +0000"  >&lt;p&gt;I didn&apos;t understand the offset business so the comment probably doesn&apos;t provide the right context. After agonizing for a while I figured out what it meant. It could be lack of sleep.&lt;/p&gt;

&lt;p&gt;It might be clearer if it described the mismatch between in memory and on disk (in a way I grok). The in-memory representation is a set of offsets into a separate zero indexed array while the disk based representation is a set of offsets to entries appended after the offsets section so every offset needs to be recalculated.&lt;/p&gt;

&lt;p&gt;I think &quot;serialization point&quot; didn&apos;t parse for me as being the point in the file after the offsets.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;because we serialize/deserialize in native&lt;br/&gt;
+            // int/long format,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;And that doesn&apos;t seem to be the cause of this mess. It&apos;s not the native int/long formatness of it. It&apos;s that the offsets are into array and the two have to be flattened into one file.&lt;/p&gt;

&lt;p&gt;SSTableReader line 747 random semi-colon, IndexSummaryBuilder line 216 extra semi-colon.&lt;/p&gt;

&lt;p&gt;SafeMemoryWriter has no unit test.&lt;/p&gt;

&lt;p&gt;Otherwise I am +1&lt;/p&gt;</comment>
                            <comment id="14345066" author="benedict" created="Tue, 3 Mar 2015 13:30:14 +0000"  >&lt;p&gt;OK, I&apos;ve pushed a new version to the repository that improves the comments and integrates SafeMemoryWriter with DataOutputTest (also slightly changing the behaviour of SafeMemoryWriter to support this, but in a way that is probably generally sensible anyway)&lt;/p&gt;</comment>
                            <comment id="14347070" author="benedict" created="Wed, 4 Mar 2015 16:10:20 +0000"  >&lt;p&gt;Got ahead of myself and thought I&apos;d had the final +1 for this, so I&apos;ve already committed. If you could still check the final changes to confirm you&apos;re ok with them and I don&apos;t need to rollback, that would be appreciated.&lt;/p&gt;</comment>
                            <comment id="14353187" author="aweisberg" created="Mon, 9 Mar 2015 16:47:18 +0000"  >&lt;p&gt;+1 The new comment makes sense to me although it might be because I already know what is going on.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25c4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>