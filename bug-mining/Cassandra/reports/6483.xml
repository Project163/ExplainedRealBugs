<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:30:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19557] ShallowIndexedEntry scenario: the same IndexInfo is read multiple times, per every read row</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19557</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When we read rows from a large partition stored in an SSTable and ShallowIndexedEntry is used - the same IndexInfo entity is read from disk multiple times, it happens per every read row.&lt;br/&gt;
The following stacktrace shows the execution path:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
at org.apache.cassandra.db.RowIndexEntry$ShallowInfoRetriever.fetchIndex(RowIndexEntry.java:742)
at org.apache.cassandra.db.RowIndexEntry$FileIndexInfoRetriever.columnsIndex(RowIndexEntry.java:792)
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$IndexState.index(AbstractSSTableIterator.java:528) 
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$IndexState.currentIndex(AbstractSSTableIterator.java:523)
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$IndexState.isPastCurrentBlock(AbstractSSTableIterator.java:513)
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$IndexState.updateBlock(AbstractSSTableIterator.java:487) &amp;lt;=== here we retrieve the current index entry
at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardIndexedReader.computeNext(SSTableIterator.java:290) &amp;lt;========== here we iterate over rows
at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.hasNextInternal(SSTableIterator.java:182)
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:342)
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.hasNext(AbstractSSTableIterator.java:224)
at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:133)
at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:100)
at org.apache.cassandra.db.rows.UnfilteredRowIteratorWithLowerBound.computeNext(UnfilteredRowIteratorWithLowerBound.java:110)
at org.apache.cassandra.db.rows.UnfilteredRowIteratorWithLowerBound.computeNext(UnfilteredRowIteratorWithLowerBound.java:48)
at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:133)
at org.apache.cassandra.db.transform.UnfilteredRows.isEmpty(UnfilteredRows.java:74)
at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:76)
at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:27)
at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:97)
at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:303)
at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:191)
at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:181)
at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:177)
at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:48)
at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:308)
at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1991)
at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2277)
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:165)
at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:137)
at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:119)
at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This Cassandra logic was originally written for the case when there is a small number of index entries and all of them are fetched in memory, so it was cheap to retrieve the IndexInfo again and again for this case. Later a support of ShallowIndexedEntry case was added (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11206&quot; title=&quot;Support large partitions on the 3.0 sstable format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11206&quot;&gt;&lt;del&gt;CASSANDRA-11206&lt;/del&gt;&lt;/a&gt;) which shares the same IndexState logic but in this case the cost to fetch IndexInfo is much higher - we read it from disk every time.&lt;/p&gt;

&lt;p&gt;I have &quot;disk_access_mode: standard&quot; enabled and for each IndexInfo retrieval there are two read syscalls:&lt;br/&gt;
1) to find an offset for the correspondent IndexInfo&lt;br/&gt;
2) to read the IndexInfo itself&lt;/p&gt;

&lt;p&gt;If we trace pread syscall we will see the following disk read syscall pattern:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2722116&amp;lt;ReadStage-5&amp;gt; 14:20:00.769513 pread64(102&amp;lt;my_keyspace/mytable/nb-1-big-Index.db&amp;gt;, &quot;&quot;..., 65536, 338611) = 65536 &amp;lt;0.000021&amp;gt;
2722116&amp;lt;ReadStage-5&amp;gt; 14:20:00.769562 pread64(102&amp;lt;my_keyspace/mytable/nb-1-big-Index.db&amp;gt;, &quot;&quot;..., 65536, 164405) = 65536 &amp;lt;0.000020&amp;gt;
2722116&amp;lt;ReadStage-5&amp;gt; 14:20:00.769616 pread64(102&amp;lt;my_keyspace/mytable/nb-1-big-Index.db&amp;gt;, &quot;&quot;..., 65536, 338611) = 65536 &amp;lt;0.000021&amp;gt;
2722116&amp;lt;ReadStage-5&amp;gt; 14:20:00.769664 pread64(102&amp;lt;my_keyspace/mytable/nb-1-big-Index.db&amp;gt;, &quot;&quot;..., 65536, 164405) = 65536 &amp;lt;0.000020&amp;gt;
... same is repeated many times ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when we do 2 reads for the same positions again and again, for every data row we read from Data file. &lt;br/&gt;
Also because these 2 reads are not near each other - we reset index reader buffer each time, so it does not help to prevent the repeated disk reads.&lt;/p&gt;

&lt;p&gt;This can be improved with a local simple change: we can cache the last read&#160;IndexInfo within IndexState, one IndexInfo is small and it doesn&apos;t create a lot of GC pressure.&lt;br/&gt;
The caching is efficient because when we iterate through rows we iterate in parallel through the IndexInfo items in a sequential way, so we fetch once an IndexInfo and then re-use it till the moment when we need the next one.&lt;/p&gt;

&lt;p&gt;I have an example (pathological but still representative) when 350&apos;000 rows are read from a partition (majority are expired tombstones). Before the change the read takes 1196 ms vs 150 ms after (361&apos;262 read syscalls from Index file before vs 622 after).&lt;/p&gt;

&lt;p&gt;The patch is attached.&lt;/p&gt;

&lt;p&gt;There are other optimisations which can be done for ShallowIndexedEntry logic additionally but they are more complicated, once I will have some specific proposals ready I will create separate tickets.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13575556">CASSANDRA-19557</key>
            <summary>ShallowIndexedEntry scenario: the same IndexInfo is read multiple times, per every read row</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="dnk">Dmitry Konstantinov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Apr 2024 20:18:50 +0000</created>
                <updated>Fri, 28 Jun 2024 17:05:55 +0000</updated>
                            <resolved>Mon, 6 May 2024 15:31:04 +0000</resolved>
                                        <fixVersion>5.0-rc1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17836664" author="brandon.williams" created="Fri, 12 Apr 2024 15:53:32 +0000"  >&lt;p&gt;First, thank you for the contribution!  This looks like a significant improvement.&lt;/p&gt;

&lt;p&gt;I am not advocating one way or the other yet, but if we are to consider this a bug then we will need to start with 3.11, otherwise we should target 5.0.&lt;/p&gt;

&lt;p&gt;I think a good next step is to run CI to spot check this and make sure nothing blows up and then we can continue to assess.  I have started that against the 4.1 patch &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17836734" author="dnk" created="Fri, 12 Apr 2024 19:25:34 +0000"  >&lt;p&gt;Hi Brandon, thank you for the quick reply and the tests running.&lt;/p&gt;

&lt;p&gt;Regarding bug vs improvement I am also in doubt, it is a kind of performance issue and I suppose it is not what the original authors expected to happen, at the same time from a functional point it is not a bug which produces wrong results.&lt;/p&gt;</comment>
                            <comment id="17838765" author="dnk" created="Thu, 18 Apr 2024 18:28:47 +0000"  >&lt;p&gt;I see 3 errors in the test report and all of them do not look like related to the changes..&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4/jobs/84434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4/jobs/84434&lt;/a&gt;&#160;&lt;br/&gt;
fails with: test_consistent_range_movement_true_with_rf1_should_fail&lt;br/&gt;
looks like a flaky test, the current change is not related to bootstrap logic..&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4/jobs/84433/parallel-runs/9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4/jobs/84433/parallel-runs/9&lt;/a&gt;&lt;br/&gt;
fails with: Too long with no output (exceeded 15m0s): context deadline exceeded&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18735&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-18735&lt;/a&gt; - the same failure was considered here as an infra issue.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4/jobs/84432/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1583/workflows/c6f9d038-b59a-4647-ba06-160d79da32b4/jobs/84432/tests&lt;/a&gt;&lt;br/&gt;
AssertionFailedError: Expected heap usage close to 74.927MiB, got 71.597MiB.&lt;br/&gt;
at org.apache.cassandra.cql3.MemtableSizeTest.testSizeFlaky(MemtableSizeTest.java:149)&lt;br/&gt;
The same test is mentioned in the open ticket: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17298&quot; title=&quot;Improve accuracy of memtable heap usage tracking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17298&quot;&gt;&lt;del&gt;CASSANDRA-17298&lt;/del&gt;&lt;/a&gt;&#160;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17838781" author="brandon.williams" created="Thu, 18 Apr 2024 19:34:19 +0000"  >&lt;p&gt;I agree, none of the failures look related to this patch (and if it did break something, I&apos;d expect to see a lot more.)  Do you know if this is a problem in 5.0 after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17056&quot; title=&quot;CEP-17 &#8211; Pluggable SSTable format (SSTable format API)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17056&quot;&gt;&lt;del&gt;CASSANDRA-17056&lt;/del&gt;&lt;/a&gt;? This patch won&apos;t apply to that branch after that ticket.&lt;/p&gt;</comment>
                            <comment id="17840593" author="dnk" created="Wed, 24 Apr 2024 22:30:22 +0000"  >&lt;p&gt;I have built the current trunk and 5.0 branch and tested them: they have the same issue.&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17056&quot; title=&quot;CEP-17 &#8211; Pluggable SSTable format (SSTable format API)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17056&quot;&gt;&lt;del&gt;CASSANDRA-17056&lt;/del&gt;&lt;/a&gt; the&#160;IndexState class was extracted to a separate file: org.apache.cassandra.io.sstable.format.big.IndexState but the logic is still the same.&lt;/p&gt;

&lt;p&gt;Please find the patch for 5.0 branch attached - &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13068414/13068414_19557-5.0.patch&quot; title=&quot;19557-5.0.patch attached to CASSANDRA-19557&quot;&gt;19557-5.0.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17843040" author="dnk" created="Thu, 2 May 2024 18:28:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&#160; could you please take a look at it when you have time&lt;/p&gt;</comment>
                            <comment id="17843369" author="brandon.williams" created="Fri, 3 May 2024 22:01:52 +0000"  >&lt;p&gt;Running CI:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19557-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1619/workflows/9150003c-b1f3-48e3-a6d1-cca4b9844660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1619/workflows/c57d97b6-bc23-4456-a4ad-2cce22174edd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19557-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1618/workflows/43bf05a7-8a4a-4a71-88b0-bf94fe586b78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1618/workflows/1071e4e7-d04d-40a5-9646-7b9bf6ed251e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17843648" author="bereng" created="Mon, 6 May 2024 06:35:15 +0000"  >&lt;p&gt;It&apos;s difficult to keep track of trunk failures, but code if pretty simple and failures LGTM iiuc. +1&lt;/p&gt;</comment>
                            <comment id="17843772" author="brandon.williams" created="Mon, 6 May 2024 15:15:45 +0000"  >&lt;p&gt;5.0 under j11 had some timeouts but hit the concurrency limit and they didn&apos;t fail under j17 so I don&apos;t think they are concerning.  j17 also hit &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19612&quot; title=&quot;flaky IntersectFilteringQueryTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19612&quot;&gt;&lt;del&gt;CASSANDRA-19612&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
trunk under j11 hit &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19601&quot; title=&quot;Test failure: test_change_durable_writes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19601&quot;&gt;&lt;del&gt;CASSANDRA-19601&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19279&quot; title=&quot;Test Failure: org.apache.cassandra.simulator.test.HarrySimulatorTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19279&quot;&gt;&lt;del&gt;CASSANDRA-19279&lt;/del&gt;&lt;/a&gt; and a timeout that didn&apos;t recur. j17 also encountered &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19601&quot; title=&quot;Test failure: test_change_durable_writes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19601&quot;&gt;&lt;del&gt;CASSANDRA-19601&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18098&quot; title=&quot;Test failure bootstrap_test.py::test_cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18098&quot;&gt;CASSANDRA-18098&lt;/a&gt;, and a timeout under the concurrency limit.&lt;/p&gt;

&lt;p&gt;None of this is a concern, and I am +1 here but unfortunately could not convince myself (as much as I would like to) that this is a bug to fix from 3.11 forward.  That said, I will begin committing to 5.0.&lt;/p&gt;</comment>
                            <comment id="17843774" author="brandon.williams" created="Mon, 6 May 2024 15:31:04 +0000"  >&lt;p&gt;Committed, thanks for the patch and review!&lt;/p&gt;</comment>
                            <comment id="17844453" author="dnk" created="Tue, 7 May 2024 21:33:14 +0000"  >&lt;p&gt;Thank you for your support!&lt;/p&gt;</comment>
                            <comment id="17846048" author="maedhroz" created="Mon, 13 May 2024 19:35:02 +0000"  >&lt;p&gt;Apologies for coming to this a little late, but I&apos;m curious if it would have made more sense to cache in &lt;tt&gt;ShallowInfoRetriever&lt;/tt&gt; itself. That way, &lt;tt&gt;IndexState&lt;/tt&gt; wouldn&apos;t have to concern itself when &lt;tt&gt;ShallowIndexedEntry&lt;/tt&gt; isn&apos;t used? (It doesn&apos;t look like any of these classes are meant to be thread-safe, so that shouldn&apos;t be a reason not to.)&lt;/p&gt;</comment>
                            <comment id="17846086" author="dnk" created="Mon, 13 May 2024 21:47:32 +0000"  >&lt;p&gt;Hi Caleb, yes, I thought about this option as well.&lt;/p&gt;

&lt;p&gt;The main reason why I placed the logic in the current place - the existing indexInfoGetsHistogram metric (it is present for disk as well as for memory cases). Before the change the metric was actually equal to the number of fetched rows and I wanted it to represent the number of different used IndexedEntry items.&lt;/p&gt;

&lt;p&gt;Another reason: for me the multiple retrievals of IndexState by index again and again during the iteration by rows looks a bit odd and ideally it should be one retrieval per block within the iteration logic itself but that part of the logic looks quite complicated, so I decided not to touch it - to not introduce a possible regression &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and I put my logic as close as possible to the iteration logic and at the same time in a way which does not require to change a lot.&lt;/p&gt;

&lt;p&gt;Finally, there is a tiny performance benefit from the caching for memory IndexedEntry option as well, by reducing the number fetches from the array by index, but, of course, it is insignificant compared to the disk access/deserialization which is happening near by.&lt;/p&gt;

&lt;p&gt;If you still think that it is better to place the logic in ShallowInfoRetriever/FileIndexInfoRetriever - I can submit a patch for this change, there are no major concerns from my side for this option as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17846090" author="maedhroz" created="Mon, 13 May 2024 22:01:00 +0000"  >&lt;p&gt;Thanks for responding! Those things all make sense. Who knows whether the index access is better or worse than updating the &lt;tt&gt;IndexState&lt;/tt&gt; cache in the &lt;tt&gt;IndexedEntry&lt;/tt&gt; case (unless there&apos;s a microbenchmark somewhere). I wouldn&apos;t worry about patching unless we have real evidence that this is problematic.&lt;/p&gt;</comment>
                            <comment id="17846100" author="dnk" created="Mon, 13 May 2024 22:15:47 +0000"  >&lt;p&gt;Agree, the last item may depend on a lot of factors like a type of GC (read vs write barrier cost).&lt;/p&gt;

&lt;p&gt;Regarding caching on ShallowInfoRetriever level I have one additional idea: currently in org.apache.cassandra.io.sstable.format.big.RowIndexEntry.ShallowInfoRetriever#fetchIndex we do 2 seek/read operations: 1st is to find the offset for IndexInfo and the 2nd to read it. These are two quite distant regions of the file and for standard disk access mode we do not use a benefit from a buffer in RandomAccessReader due to jumping between the regions and reseting this buffer again and again. A possible improvement here can be to read and cache N first offsets (to limit the amount of memory to use) on the first read and do later only sequential reads of IndexInfo data. By caching of less than 1Kb we can reduce the number of syscalls even more, in my case: from few hundred to less than 10.&#160;&#160;&lt;/p&gt;

&lt;p&gt;If it makes sense - I can create a separate ticket for such change..&lt;/p&gt;</comment>
                            <comment id="17846361" author="maedhroz" created="Tue, 14 May 2024 15:51:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dnk&quot; class=&quot;user-hover&quot; rel=&quot;dnk&quot;&gt;dnk&lt;/a&gt; Yeah, go for it. A separate Jira for that would make sense.&lt;/p&gt;</comment>
                            <comment id="17860869" author="dnk" created="Fri, 28 Jun 2024 17:05:55 +0000"  >&lt;p&gt;Created: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19652&quot; title=&quot;ShallowInfoRetriever: cache offsets to void resetting of RandomAccessReader buffer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19652&quot;&gt;CASSANDRA-19652&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13580008">CASSANDRA-19652</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12941116">CASSANDRA-11206</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13068152" name="19557-4.1.patch" size="2555" author="dnk" created="Thu, 11 Apr 2024 20:48:48 +0000"/>
                            <attachment id="13068414" name="19557-5.0.patch" size="2462" author="dnk" created="Wed, 24 Apr 2024 22:29:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ol60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335055">3.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/049160e70a22bfcc9c751a1fe3afec1e5c329f4c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/049160e70a22bfcc9c751a1fe3afec1e5c329f4c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>