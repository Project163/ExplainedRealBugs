<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10360] UnsupportedOperationException when compacting system.size_estimates after 2.1 -&gt; 2.2 -&gt; 3.0 upgrade</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10360</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When upgrading from 2.1 -&amp;gt; 2.2 -&amp;gt; 3.0 the system.size_estimates table will get stuck in a compaction loop throwing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.UnsupportedOperationException
    at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer.readNext(UnfilteredDeserializer.java:382)
    at org.apache.cassandra.io.sstable.SSTableSimpleIterator$OldFormatIterator.computeNext(SSTableSimpleIterator.java:147)
    at org.apache.cassandra.io.sstable.SSTableSimpleIterator$OldFormatIterator.computeNext(SSTableSimpleIterator.java:96)
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
    at org.apache.cassandra.io.sstable.SSTableIdentityIterator.computeNext(SSTableIdentityIterator.java:100)
    at org.apache.cassandra.io.sstable.SSTableIdentityIterator.computeNext(SSTableIdentityIterator.java:30)
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
    at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95)
    at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32)
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
    at org.apache.cassandra.utils.MergeIterator$TrivialOneToOne.computeNext(MergeIterator.java:460)
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
    at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:503)
    at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:363)
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
    at org.apache.cassandra.db.rows.WrappingUnfilteredRowIterator.hasNext(WrappingUnfilteredRowIterator.java:80)
    at org.apache.cassandra.db.rows.AlteringUnfilteredRowIterator.hasNext(AlteringUnfilteredRowIterator.java:72)
    at org.apache.cassandra.db.rows.UnfilteredRowIterator.isEmpty(UnfilteredRowIterator.java:100)
    at org.apache.cassandra.db.partitions.PurgingPartitionIterator.hasNext(PurgingPartitionIterator.java:72)
    at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:223)
    at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:177)
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
    at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:78)
    at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60)
    at org.apache.cassandra.db.compaction.CompactionManager$8.runMayThrow(CompactionManager.java:539)
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It will only occur when upgrading thru 2.2.  Going from 2.1 -&amp;gt; 3.0 will not surface the issue.  It can be reproduced with the following (note &amp;#8211; changing jdks will need to be altered if you aren&apos;t on OSX)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#!/bin/sh

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;using java7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; cassandra-2.1 instance&quot;&lt;/span&gt;
export JAVA_HOME=$(/usr/libexec/java_home -v 1.7)

ccm stop
ccm remove upgrade_nodes
ccm create -n 1 -v git:cassandra-2.1 upgrade_nodes
ccm start
ccm node1 stress write n=500K -rate threads=4 -mode &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; cql3
sleep 10

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; cver in 3.0
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Draining all nodes&quot;&lt;/span&gt;
    ccm node1 nodetool drain
    ccm stop

    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;switching to java 8&quot;&lt;/span&gt;
    export JAVA_HOME=$(/usr/libexec/java_home -v 1.8)

    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Upgrading to git:cassandra-$cver&quot;&lt;/span&gt;
    ccm setdir -v git:cassandra-$cver
    ccm start
    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Sleeping to all version migrations&quot;&lt;/span&gt;
    sleep 30
    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Upgrading sstables&quot;&lt;/span&gt;
    ccm node1 nodetool upgradesstables
    ccm node1 nodetool upgradesstables system
    ccm node1 nodetool compact system

    ccm node1 stress write n=500K -rate threads=4 -mode &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; cql3
    sleep 10
done

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;***********&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;instead of creating churn to cause compaction naturally forcing compaction of system keyspace&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;***********&quot;&lt;/span&gt;
ccm node1 nodetool compact system
ccm stop
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The example uses &lt;tt&gt;nodetool compact system&lt;/tt&gt; but it will also occur with &lt;tt&gt;nodetool upgradesstables system&lt;/tt&gt;.  I&apos;m puzzled by that since the script runs &lt;tt&gt;upgradesstables&lt;/tt&gt; on each iteration.  Is the system keyspace not effected by the command without arguments?&lt;/p&gt;

&lt;p&gt;Ran against:&lt;br/&gt;
2.1: &lt;tt&gt;e889ee408bec5330c312ff6b72a81a0012fdf2a5&lt;/tt&gt;&lt;br/&gt;
2.2: &lt;tt&gt;e63dacf793fedc8a9eed9c7fc635cde5f9fd68f3&lt;/tt&gt;&lt;br/&gt;
3.0: &lt;tt&gt;9218d7456b36d20ebe78bab23594e67d2f0c4a20&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;//CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12873115">CASSANDRA-10360</key>
            <summary>UnsupportedOperationException when compacting system.size_estimates after 2.1 -&gt; 2.2 -&gt; 3.0 upgrade</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="nutbunnies">Andrew Hust</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Sep 2015 22:09:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:55 +0000</updated>
                            <resolved>Thu, 22 Oct 2015 07:25:18 +0000</resolved>
                                        <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14791289" author="iamaleksey" created="Wed, 16 Sep 2015 23:19:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Looks to me like another old format reading bug. Can you give it a quick look?&lt;/p&gt;</comment>
                            <comment id="14937461" author="nutbunnies" created="Wed, 30 Sep 2015 16:18:11 +0000"  >&lt;p&gt;I have now reproduced this issue when upgrading from 2.1 to 3.0 when doing a rolling upgrade with cstar_perf.  Attached site_estimates sstables and system log from one of the nodes.  I&apos;ll work on getting a isolated script to reproduce.&lt;/p&gt;

&lt;p&gt;UPDATE:  The above shell script has been updated to show failure from 2.1 -&amp;gt; 3.0.  It just needed more activity on the stress operation to trigger the issue.  Change line &lt;tt&gt;for cver in 3.0&lt;/tt&gt; to &lt;tt&gt;for cver in 2.2 3.0&lt;/tt&gt; for the original upgrade path.  &lt;/p&gt;</comment>
                            <comment id="14940994" author="slebresne" created="Fri, 2 Oct 2015 10:22:00 +0000"  >&lt;p&gt;The error stems from the fact I left handling range tombstone in legacy sstable as a TODO and forgot to get back to it. So I&apos;ve push a patch &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; to fix that. I haven&apos;t tried the reproduction script in the description to be honest but rather a most focused test that is &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="14947144" author="nutbunnies" created="Wed, 7 Oct 2015 16:25:18 +0000"  >&lt;p&gt;I ran your patch thru a 2.1-&amp;gt;2.2-&amp;gt;3.0 upgrade and it failed with a different exception.  I&apos;ve attached the system.log and size_estimates sstables from this run.&lt;/p&gt;

&lt;p&gt;Ran with:&lt;br/&gt;
apache/cassandra-2.1 &lt;tt&gt;1b08cbd817dea379ea84175381d3ef151fe65681&lt;/tt&gt;&lt;br/&gt;
apache/cassandra-2.2: &lt;tt&gt;be89dae3ecfd98b2170732c45d7f95807d5c19af&lt;/tt&gt;&lt;br/&gt;
pcmanus/10360: &lt;tt&gt;8f7d524efcbf0157697e67a3b4ff4b883b441a55&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError
	at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer.checkReady(UnfilteredDeserializer.java:346)
	at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer.nextIsRow(UnfilteredDeserializer.java:367)
	at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer.readNext(UnfilteredDeserializer.java:384)
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$OldFormatIterator.computeNext(SSTableSimpleIterator.java:147)
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$OldFormatIterator.computeNext(SSTableSimpleIterator.java:96)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.computeNext(SSTableIdentityIterator.java:100)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.computeNext(SSTableIdentityIterator.java:30)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95)
	at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:369)
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:189)
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:158)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:503)
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:363)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.rows.WrappingUnfilteredRowIterator.hasNext(WrappingUnfilteredRowIterator.java:80)
	at org.apache.cassandra.db.rows.AlteringUnfilteredRowIterator.hasNext(AlteringUnfilteredRowIterator.java:72)
	at org.apache.cassandra.db.rows.WrappingUnfilteredRowIterator.hasNext(WrappingUnfilteredRowIterator.java:80)
	at org.apache.cassandra.db.rows.AlteringUnfilteredRowIterator.hasNext(AlteringUnfilteredRowIterator.java:72)
	at org.apache.cassandra.db.ColumnIndex$Builder.build(ColumnIndex.java:110)
	at org.apache.cassandra.db.ColumnIndex.writeAndBuildIndex(ColumnIndex.java:52)
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter.append(BigTableWriter.java:148)
	at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:125)
	at org.apache.cassandra.db.compaction.writers.DefaultCompactionWriter.realAppend(DefaultCompactionWriter.java:57)
	at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.append(CompactionAwareWriter.java:112)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:182)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:78)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60)
	at org.apache.cassandra.db.compaction.CompactionManager$8.runMayThrow(CompactionManager.java:539)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14953244" author="slebresne" created="Mon, 12 Oct 2015 16:04:17 +0000"  >&lt;p&gt;There was indeed a small error in the logic of the next code leading to that assertion. I&apos;ve force-pushed a fix, would you mind re-running your test and check if it works now?&lt;/p&gt;</comment>
                            <comment id="14953490" author="nutbunnies" created="Mon, 12 Oct 2015 18:01:39 +0000"  >&lt;p&gt;Confirmed that the above upgrade test script now passes without exceptions.&lt;/p&gt;

&lt;p&gt;Ran with:&lt;br/&gt;
apache/cassandra-2.1: &lt;tt&gt;4acc3a69d319b0e7e00cbd37b27e988ebfa4df4f&lt;/tt&gt;&lt;br/&gt;
apache/cassandra-2.2: &lt;tt&gt;0c051a46c54fd1a2f151e1a68f4556faca02be8d&lt;/tt&gt;&lt;br/&gt;
pcmanus/10360: &lt;tt&gt;6a56057a4eaab01480fba6292c5a59d4c3d62c49&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14955127" author="blambov" created="Tue, 13 Oct 2015 15:32:30 +0000"  >&lt;p&gt;Does this solution satisfy the &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/rows/RangeTombstoneMarker.java#L55&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&quot;no range tombstone markers between open and close&quot;&lt;/a&gt; requirement? I believe we must convert to a boundary whenever there&apos;s overlap.&lt;/p&gt;</comment>
                            <comment id="14960601" author="slebresne" created="Fri, 16 Oct 2015 12:43:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does this solution satisfy the &quot;no range tombstone markers between open and close&quot; requirement?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, you&apos;re right, it doesn&apos;t, I&apos;ve been sloppy. So I force-pushed &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on the same branch&lt;/a&gt; a solution that should satisfy those requirements. It refactors the old format deserializer somewhat but that hopefully makes thing easier to follow/simpler. While testing this I also noticed a (simple to fix) regression from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10136&quot; title=&quot;startup error after upgrade to 3.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10136&quot;&gt;&lt;del&gt;CASSANDRA-10136&lt;/del&gt;&lt;/a&gt;, so the branch has an additional commit for that.&lt;/p&gt;</comment>
                            <comment id="14960971" author="blambov" created="Fri, 16 Oct 2015 16:30:47 +0000"  >&lt;p&gt;I think the code actually reads a bit better now, even if it has to do a bit more.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/618929034b045505368c4f92043f5d3da8e73ed5#diff-19cb83af11bbbc4d803ca33c8cdea57aR444&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TombstoneTracker.isShadowed&lt;/a&gt;: Not sure if worth rewriting, but iterating over &lt;tt&gt;openTombstones.tailSet(atom.asRangeTombstone())&lt;/tt&gt; instead would ensure the comparison is always true for tombstones. Perhaps change to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SortedSet&amp;lt;LegacyLayout.LegacyRangeTombstone&amp;gt; coveringTombstones = atom.isCell() ? openTombstones : openTombstones.tailSet(atom.asRangeTombstone());
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Iterables.any(coveringTombstones, tombstone -&amp;gt; tombstone.deletionTime.deletes(timestamp));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It probably does not matter, but shouldn&apos;t the test above use &lt;tt&gt;isRow(atom)&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/618929034b045505368c4f92043f5d3da8e73ed5#diff-19cb83af11bbbc4d803ca33c8cdea57aR313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;hasNext&lt;/a&gt; is hard to follow. One thing that may help is to get rid of &lt;tt&gt;atom&lt;/tt&gt;, using &lt;tt&gt;next&lt;/tt&gt; directly. I have a feeling that letting the RT/static row swap flow into the &lt;tt&gt;isRow&lt;/tt&gt; option would make it a little clearer as well, but I may be wrong.&lt;/p&gt;

&lt;p&gt;It appears there is a situation when &lt;tt&gt;nextAtom&lt;/tt&gt; may be lost: if static row pushes tombstone to &lt;tt&gt;nextAtom&lt;/tt&gt; followed by grouping the static row which also will want to push something there. I wonder why &lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/618929034b045505368c4f92043f5d3da8e73ed5#diff-19cb83af11bbbc4d803ca33c8cdea57aR298&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the assert&lt;/a&gt; doesn&apos;t fire (if my failure scenario is valid it would be good to have a test that makes it fire).&lt;/p&gt;

&lt;p&gt;I no longer see the code to drain the tombstone tracker after the input is exhausted. Don&apos;t we need to do that any more?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commit/618929034b045505368c4f92043f5d3da8e73ed5#diff-19cb83af11bbbc4d803ca33c8cdea57aR404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;clearState&lt;/a&gt;: what about the tombstone tracker?&lt;/p&gt;</comment>
                            <comment id="14965103" author="slebresne" created="Tue, 20 Oct 2015 13:34:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;hasNext is hard to follow.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed. I&apos;ve actually gave a shot to a slightly more extensive refactor (pushed to the same branch) where I&apos;ve separated some of the steps, creating first an iterator of atom from the input, then an iterator of &lt;tt&gt;Unfiltered&lt;/tt&gt; from that, leaving mostly just the handling of the last special cases to &lt;tt&gt;hasNext&lt;/tt&gt;. This takes a bit more lines of code, but I think this is overall easier to follow.&lt;/p&gt;

&lt;p&gt;The rest of the remarks were all on point and I included fixes for them in the new patch too.&lt;/p&gt;</comment>
                            <comment id="14965172" author="blambov" created="Tue, 20 Oct 2015 14:30:12 +0000"  >&lt;p&gt;It &lt;em&gt;is&lt;/em&gt; much clearer now. Thank you.&lt;/p&gt;

&lt;p&gt;One problem left in &lt;tt&gt;UnfilteredIterator.next/peek&lt;/tt&gt; and &lt;tt&gt;AtomIterator.next/peek&lt;/tt&gt;: &lt;tt&gt;assert hasNext()&lt;/tt&gt; changes the code&apos;s behavior when asserts are on. Call &lt;tt&gt;hasNext()&lt;/tt&gt; separately and then &lt;tt&gt;assert next != null&lt;/tt&gt; or &lt;tt&gt;!isDone&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Is the code being tested already?&lt;/p&gt;</comment>
                            <comment id="14966539" author="slebresne" created="Wed, 21 Oct 2015 09:38:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;assert hasNext()&lt;/tt&gt; changes the code&apos;s behavior when asserts are on&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True. I did that because in practice, we never need this, the method that have those assert are always called after a &lt;tt&gt;hasNext()&lt;/tt&gt; call. But you&apos;re right, there is not reason to take a risk, so added a simple commit to move the call out of an assert.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is the code being tested already?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Basic functionality of reading old sstable is tested by some of our existing upgrade tests. I have more focused tests for this (that include tests for statics and range tombstones) &lt;a href=&quot;https://github.com/pcmanus/cassandra-dtest/blob/8099_upgrade_tests/upgrade_8099_test.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, but those haven&apos;t been committed yet cause they use hard-coded path for now and I&apos;ll need to figure out how to modify that so cassci is happy with it. Actually, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;, could you look at including that test file in the upgrade tests in a way that works for CI?&lt;/p&gt;</comment>
                            <comment id="14966560" author="blambov" created="Wed, 21 Oct 2015 09:46:39 +0000"  >&lt;p&gt;&lt;tt&gt;OldFormatDeserializer.skipNext()&lt;/tt&gt; as well as &lt;tt&gt;UnfilteredIterator.next/peek&lt;/tt&gt; and &lt;tt&gt;AtomIterator.next/peek&lt;/tt&gt; still &lt;tt&gt;assert hasNext()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Other than that, the patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="14967257" author="slebresne" created="Wed, 21 Oct 2015 14:51:29 +0000"  >&lt;p&gt;Alright, committed with the last places having &lt;tt&gt;assert hasNext&lt;/tt&gt; fixed. I&apos;ll mark the ticket for now just so we don&apos;t forget to include the tests I&apos;ve linked above in our dtest suite.&lt;/p&gt;</comment>
                            <comment id="14967606" author="mambocab" created="Wed, 21 Oct 2015 18:26:23 +0000"  >&lt;p&gt;I&apos;ll add the test &amp;#8211; I&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10563&quot; title=&quot;Integrate new upgrade test into dtest upgrade suite&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10563&quot;&gt;&lt;del&gt;CASSANDRA-10563&lt;/del&gt;&lt;/a&gt; to track it.&lt;/p&gt;</comment>
                            <comment id="14968696" author="slebresne" created="Thu, 22 Oct 2015 07:25:38 +0000"  >&lt;p&gt;Ok, I&apos;ve closed this issue then. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12765414" name="size_estimates.2.tar.bz2" size="4185" author="nutbunnies" created="Wed, 7 Oct 2015 16:26:15 +0000"/>
                            <attachment id="12764437" name="size_estimates.tar.bz2" size="66123" author="nutbunnies" created="Wed, 30 Sep 2015 16:18:28 +0000"/>
                            <attachment id="12765413" name="system.log.2.bz2" size="31990" author="nutbunnies" created="Wed, 7 Oct 2015 16:26:15 +0000"/>
                            <attachment id="12764438" name="system.log.bz2" size="53371" author="nutbunnies" created="Wed, 30 Sep 2015 16:18:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k9u7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333287">3.0 beta 2</customfieldvalue>
    <customfieldvalue id="12332955">3.0.0 rc1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mambocab</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>