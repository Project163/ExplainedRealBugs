<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7144] Fix handling of empty counter replication mutations</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7144</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;First time reporting a bug here, apologies if I&apos;m not posting it in the right space.&lt;/p&gt;

&lt;p&gt;At what seems like random interval, on random nodes in random situations I will get the following exception. After this the hinted handoff start timing out and the node stops participating in the cluster.&lt;/p&gt;

&lt;p&gt;I started seeing these after switching to the Cassandra Python-Driver from the Python-CQL driver.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [WRITE-/10.128.180.108] 2014-05-03 13:45:12,843 CassandraDaemon.java (line 198) Exception in thread Thread[WRITE-/10.128.180.108,5,main]
java.lang.AssertionError
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
	at org.apache.cassandra.net.MessageOut.serialize(MessageOut.java:120)
	at org.apache.cassandra.net.OutboundTcpConnection.writeInternal(OutboundTcpConnection.java:251)
	at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:203)
	at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:151)
ERROR [WRITE-/10.128.194.70] 2014-05-03 13:45:12,843 CassandraDaemon.java (line 198) Exception in thread Thread[WRITE-/10.128.194.70,5,main]
java.lang.AssertionError
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
	at org.apache.cassandra.net.MessageOut.serialize(MessageOut.java:120)
	at org.apache.cassandra.net.OutboundTcpConnection.writeInternal(OutboundTcpConnection.java:251)
	at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:203)
	at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:151)
ERROR [MutationStage:118] 2014-05-03 13:45:15,048 CassandraDaemon.java (line 198) Exception in thread Thread[MutationStage:118,5,main]
java.lang.AssertionError
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
	at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:654)
	at org.apache.cassandra.db.HintedHandOffManager.hintFor(HintedHandOffManager.java:137)
	at org.apache.cassandra.service.StorageProxy.writeHintForMutation(StorageProxy.java:908)
	at org.apache.cassandra.service.StorageProxy$6.runMayThrow(StorageProxy.java:881)
	at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:1981)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:744)
ERROR [MutationStage:117] 2014-05-03 13:45:15,048 CassandraDaemon.java (line 198) Exception in thread Thread[MutationStage:117,5,main]
java.lang.AssertionError
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
	at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:654)
	at org.apache.cassandra.db.HintedHandOffManager.hintFor(HintedHandOffManager.java:137)
	at org.apache.cassandra.service.StorageProxy.writeHintForMutation(StorageProxy.java:908)
	at org.apache.cassandra.service.StorageProxy$6.runMayThrow(StorageProxy.java:881)
	at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:1981)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The service must be restarted for the node to come back online. Let me know any additional configuration details needed.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 12.04 w/ Oracle JVM, 5 nodes cluster. Nodes 2GB / 2 Cores in DigitalOcean.&lt;/p&gt;</environment>
        <key id="12712103">CASSANDRA-7144</key>
            <summary>Fix handling of empty counter replication mutations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="nesnub">Maxime Lamothe-Brassard</reporter>
                        <labels>
                    </labels>
                <created>Sat, 3 May 2014 08:23:18 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:46 +0000</updated>
                            <resolved>Tue, 3 Jun 2014 16:04:33 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                    <fixVersion>2.0.9</fixVersion>
                                        <due></due>
                            <votes>5</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="13989834" author="jbellis" created="Mon, 5 May 2014 18:45:42 +0000"  >&lt;p&gt;You didn&apos;t give a version so I&apos;m not 100% sure but I think you&apos;re seeing this assert:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size = rm.modifications.size();
            out.writeInt(size);
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; size &amp;gt; 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which means that your client is sending a zero-length mutation to the server.&lt;/p&gt;

&lt;p&gt;do we not validate that in the native protocol &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13989838" author="nesnub" created="Mon, 5 May 2014 18:50:29 +0000"  >&lt;p&gt;I had mentioned it, probably in the wrong field since it got removed. 2.0.7, latest at the moment. Quick update, I ended up decomissioning the node, wiping /var/lib/cassandra/* and then re-joining the cluster (same install, just wiped the dir). It has 100% solved my problem (so far anyway, about 2 days of uptime).&lt;/p&gt;

&lt;p&gt;So it sounds like the data on disk was somehow corrupted somewhere between my client code update and repairs.&lt;/p&gt;</comment>
                            <comment id="13992186" author="thobbs" created="Wed, 7 May 2014 20:28:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nesnub&quot; class=&quot;user-hover&quot; rel=&quot;nesnub&quot;&gt;nesnub&lt;/a&gt; when you saw this, were you using prepared statements or unprepared statements?  Were you using BATCH, INSERT, UPDATE, and/or DELETE?&lt;/p&gt;

&lt;p&gt;So far I&apos;ve tried a few things to reproduce this with no luck.&lt;/p&gt;</comment>
                            <comment id="13992841" author="nesnub" created="Thu, 8 May 2014 15:22:48 +0000"  >&lt;p&gt;I was not using prepared statements. I was doing INSERT and SELECT, no DELETE.&lt;/p&gt;

&lt;p&gt;I have some more info now. As I said I rebuilt the data on the node and it eliminated the problem. However, a day later, I found myself killing my ingestor (doing lots of INSERT), it&apos;s a python script using the new cassandra python-driver. When I did that I got the exception above. Thinking it was a &quot;runtime&quot; bug, I just kept going. Then the hinted-handoff started timing out on that box, so I restarted cassandra. From that point on, I would get the same exception without ever killing ingestors, at random interval. It seems as if killing the script during a query ended up sending data to cassandra that made it corrupt something on disk and that from that point on whenever it reached that part of the data on disk (I use that liberally, I just mean NOT directly from the script doing the ingestion) it would throw the exact same exception, leading to the timing out again. Restart of the cassandra node did nothing, I had to rebuild the data again. So now I&apos;m very paranoid about killing my ingestion.&lt;/p&gt;

&lt;p&gt;The ingestion uses UNLOGGED BATCH for some of the data for performance as well as normal INSERT.&lt;/p&gt;</comment>
                            <comment id="14004910" author="jason.punyon" created="Wed, 21 May 2014 17:01:05 +0000"  >&lt;p&gt;I&apos;m Jason and I work at Stack Overflow. We&apos;re bit by this right now on our 2.0.6 cluster and we haven&apos;t wiped it out yet.&lt;/p&gt;

&lt;p&gt;We got to this state on Friday after a power outage took out our entire datacenter (&lt;a href=&quot;https://twitter.com/JasonPunyon/status/467290879569719296&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://twitter.com/JasonPunyon/status/467290879569719296&lt;/a&gt;). We have a 3-node cluster and we interact with it using the CqlSharp library. We do our reads and writes at QUORUM, some of them are batches. The first symptom of the problem was that both read and write operations were timing out. When we dug in, we found that nodes 1 and 3 were throwing errors (not enough responses), but node 2 would execute the exact same operations fine at quorum. Nodes 1 and 3 would execute reads fine at ONE.&lt;/p&gt;

&lt;p&gt;We&apos;re pretty interested in getting it fixed. Is there any way we can help? &lt;/p&gt;</comment>
                            <comment id="14005085" author="thobbs" created="Wed, 21 May 2014 18:51:53 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jason.punyon&quot; class=&quot;user-hover&quot; rel=&quot;jason.punyon&quot;&gt;jason.punyon&lt;/a&gt;, thanks for your offer to help.  The best way to help at the moment would be to help come up with a reproduceable test case, if you can.  I have one other ticket on my queue in front of this one, so I should be able to give it proper attention pretty soon.&lt;/p&gt;</comment>
                            <comment id="14005303" author="jason.punyon" created="Wed, 21 May 2014 22:08:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; We racked our brains a bit, we can&apos;t really conceive of a direction to go in to replicate it again (remember it&apos;s still live on our cluster, we can run any diagnostics you want), aside from rebuilding and then randomly bringing power down (what we did the first time).&lt;/p&gt;</comment>
                            <comment id="14006517" author="thobbs" created="Thu, 22 May 2014 21:55:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jason.punyon&quot; class=&quot;user-hover&quot; rel=&quot;jason.punyon&quot;&gt;jason.punyon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nesnub&quot; class=&quot;user-hover&quot; rel=&quot;nesnub&quot;&gt;nesnub&lt;/a&gt; can you provide any other details about the writes?  I presume you were using prepared statements?  How large were the batches? Roughly what do the individual inserts (within the batches or otherwise) look like?&lt;/p&gt;</comment>
                            <comment id="14006847" author="nesnub" created="Fri, 23 May 2014 06:02:51 +0000"  >&lt;p&gt;The writes were not using prepared statements. The batch contain average INSERT/UPDATEs, but I also have a counter update interleaved between the statements. Here is a sample:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;self.queries.append( ( ( &lt;span class=&quot;code-quote&quot;&gt;&apos;UPDATE met SET n = n + 1 WHERE id = %(id)s&apos;&lt;/span&gt;, { &lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt; : k } ) )
self.queries.append( ( &apos;&apos;&apos;BEGIN UNLOGGED BATCH
                                                  INSERT INTO om ( id, obj, otype ) VALUES ( %(id)s, %(obj)s, %(type)s );
                                                  UPDATE loc SET last = %(ts)s WHERE sid = %(sid)s AND otype = %(type)s AND id = %(id)s;
                                                  INSERT INTO lid ( id, sid ) VALUES ( %(id)s, %(sid)s );
                                                  APPLY BATCH;&lt;span class=&quot;code-quote&quot;&gt;&apos;&apos;&apos;, { &apos;&lt;/span&gt;id&apos; : k,
                                                                     &lt;span class=&quot;code-quote&quot;&gt;&apos;obj&apos;&lt;/span&gt; : unicode( obj[ 0 ] ).lower(),
                                                                     &lt;span class=&quot;code-quote&quot;&gt;&apos;type&apos;&lt;/span&gt; : obj[ 1 ],
                                                                     &lt;span class=&quot;code-quote&quot;&gt;&apos;ts&apos;&lt;/span&gt; : ts,
                                                                     &lt;span class=&quot;code-quote&quot;&gt;&apos;sid&apos;&lt;/span&gt; : ag } ) )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14016182" author="kohlisankalp" created="Tue, 3 Jun 2014 03:34:54 +0000"  >&lt;p&gt;Another point here is that one of these assertion errors which is caused in at OutboundTcpConnection.java:151 will cause that thread to die.&lt;/p&gt;

&lt;p&gt;This will be very bad as it will not be recreated and it won&apos;t be able to talk to a node which had that connection. &lt;/p&gt;</comment>
                            <comment id="14016199" author="kohlisankalp" created="Tue, 3 Jun 2014 04:12:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nesnub&quot; class=&quot;user-hover&quot; rel=&quot;nesnub&quot;&gt;nesnub&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jason.punyon&quot; class=&quot;user-hover&quot; rel=&quot;jason.punyon&quot;&gt;jason.punyon&lt;/a&gt;&lt;br/&gt;
Are you using CAS based inserts? &lt;/p&gt;</comment>
                            <comment id="14016381" author="rlow" created="Tue, 3 Jun 2014 11:09:59 +0000"  >&lt;p&gt;We saw this in 3 separate clusters at roughly the same time. In 2 clusters it happened on one node only. On 1 cluster it happened on 3 nodes.&lt;/p&gt;

&lt;p&gt;Every time it happened, there were 3 errors in WRITE threads with stack trace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
	at org.apache.cassandra.net.MessageOut.serialize(MessageOut.java:120)
	at org.apache.cassandra.net.OutboundTcpConnection.writeInternal(OutboundTcpConnection.java:251)
	at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:203)
	at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:151)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the IPs in the thread names are all adjacent in the ring (we have replication 3+3 in 2 DCs). 2-3 seconds following that, there are then stack traces in the MutationStage like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
	at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:654)
	at org.apache.cassandra.db.HintedHandOffManager.hintFor(HintedHandOffManager.java:137)
	at org.apache.cassandra.service.StorageProxy.writeHintForMutation(StorageProxy.java:897)
	at org.apache.cassandra.service.StorageProxy$6.runMayThrow(StorageProxy.java:870)
	at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:1961)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The number of these varies from 5 to 65.&lt;/p&gt;</comment>
                            <comment id="14016443" author="rlow" created="Tue, 3 Jun 2014 12:25:27 +0000"  >&lt;p&gt;In fact, the number of MutationStage AssertionErrors always come in groups of 5 (within 1ms of each other).&lt;/p&gt;</comment>
                            <comment id="14016525" author="rlow" created="Tue, 3 Jun 2014 13:58:54 +0000"  >&lt;p&gt;I have a reproduction. Not sure if it was the cause of our issue but it repros an identical situation.&lt;/p&gt;

&lt;p&gt;I have a 3 node cluster running on my box. I ran these cql commands:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; create keyspace ks with replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;:2};
cqlsh&amp;gt; use ks;
cqlsh:ks&amp;gt; create table counter_test (a text primary key, b counter) with gc_grace_seconds = 0;
cqlsh:ks&amp;gt; consistency all;
Consistency level set to ALL.
cqlsh:ks&amp;gt; update counter_test set b = b + 1 where a = &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;;
cqlsh:ks&amp;gt; delete from counter_test where a = &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;;
cqlsh:ks&amp;gt; update counter_test set b = b + 1 where a = &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;;
Request did not complete within rpc_timeout.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And in the logs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [WRITE-/127.0.0.2] 2014-06-03 14:37:24,186 CassandraDaemon.java (line 196) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[WRITE-/127.0.0.2,5,main]
java.lang.AssertionError
        at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
        at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
        at org.apache.cassandra.net.MessageOut.serialize(MessageOut.java:120)
        at org.apache.cassandra.net.OutboundTcpConnection.writeInternal(OutboundTcpConnection.java:251)
        at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:203)
        at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:151)
ERROR [MutationStage:156] 2014-06-03 14:37:26,301 CassandraDaemon.java (line 196) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MutationStage:156,5,main]
java.lang.AssertionError
        at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:271)
        at org.apache.cassandra.db.RowMutation$RowMutationSerializer.serialize(RowMutation.java:259)
        at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:654)
        at org.apache.cassandra.db.HintedHandOffManager.hintFor(HintedHandOffManager.java:137)
        at org.apache.cassandra.service.StorageProxy.writeHintForMutation(StorageProxy.java:897)
        at org.apache.cassandra.service.StorageProxy$6.runMayThrow(StorageProxy.java:870)
        at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:1961)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is that the row tombstone has microsecond timestamps but the counter has milliseconds (I just created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7346&quot; title=&quot;Modify reconcile logic to always pick a tombstone over a counter cell&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7346&quot;&gt;&lt;del&gt;CASSANDRA-7346&lt;/del&gt;&lt;/a&gt; for this). When the local counter mutation is applied, it is immediately removed because the row tombstone has a later timestamp. When we read it back, once the row tombstone becomes GCable (that&apos;s why I set gc_grace to 0) we get null for the row, so we don&apos;t add a mutation to the RowMutation object (in CounterMutation.makeReplicaionMutation()). When this mutation gets sent it kills the connection thread, times out so we write a hint, which causes the second assertion failure. We now have to wait until the row tombstone becomes GCed to be able to inc anything in this row again.&lt;/p&gt;

&lt;p&gt;Even if there wasn&apos;t &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7346&quot; title=&quot;Modify reconcile logic to always pick a tombstone over a counter cell&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7346&quot;&gt;&lt;del&gt;CASSANDRA-7346&lt;/del&gt;&lt;/a&gt;, it is legitimate to insert a row tombstone with a later timestamp so this could still happen. We need to detect this case and handle it so the empty counter increment doesn&apos;t cause trouble. We can just say it&apos;s done because the counter is deleted and not bother to replicate.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep looking in case there are other code paths that trigger this.&lt;/p&gt;</comment>
                            <comment id="14016578" author="iamaleksey" created="Tue, 3 Jun 2014 14:52:14 +0000"  >&lt;p&gt;Attaching a simple 1.2 based patch. Only 1.2 and 2.0 are affected, the 2.1 implementation is not.&lt;/p&gt;</comment>
                            <comment id="14016586" author="jason.punyon" created="Tue, 3 Jun 2014 15:00:59 +0000"  >&lt;p&gt;Having looked at our writes, the were almost exclusively batches (sized 100-1000) and a counter batch (max size 1000). We used CAS for exactly one table (our migrations table) which was used very infrequently (in our build, a few times a day).&lt;/p&gt;</comment>
                            <comment id="14016588" author="rlow" created="Tue, 3 Jun 2014 15:03:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jason.punyon&quot; class=&quot;user-hover&quot; rel=&quot;jason.punyon&quot;&gt;jason.punyon&lt;/a&gt; did you ever issue any row deletes to your counter table?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; I don&apos;t see any patch&lt;/p&gt;</comment>
                            <comment id="14016593" author="jason.punyon" created="Tue, 3 Jun 2014 15:08:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rlow&quot; class=&quot;user-hover&quot; rel=&quot;rlow&quot;&gt;rlow&lt;/a&gt; Yes we did.&lt;/p&gt;</comment>
                            <comment id="14016596" author="rlow" created="Tue, 3 Jun 2014 15:11:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jason.punyon&quot; class=&quot;user-hover&quot; rel=&quot;jason.punyon&quot;&gt;jason.punyon&lt;/a&gt; great, this is almost certainly the cause for you. You should check out &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7346&quot; title=&quot;Modify reconcile logic to always pick a tombstone over a counter cell&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7346&quot;&gt;&lt;del&gt;CASSANDRA-7346&lt;/del&gt;&lt;/a&gt; since row deletes on counter tables don&apos;t do at all what you expect.&lt;/p&gt;</comment>
                            <comment id="14016599" author="rlow" created="Tue, 3 Jun 2014 15:18:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; I tried your patch (rebased for 2.0.6 where we&apos;re seeing the problem). It stops the AssertionError which is great, but I still get a timeout for the response. Do we need to poke the responseHandler too?&lt;/p&gt;</comment>
                            <comment id="14016601" author="iamaleksey" created="Tue, 3 Jun 2014 15:20:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we need to poke the responseHandler too?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We do. Oh this is ugly-ish.&lt;/p&gt;</comment>
                            <comment id="14016792" author="rlow" created="Tue, 3 Jun 2014 15:41:06 +0000"  >&lt;p&gt;Confirmed v2 works on 2.0.6. There is no AssertionError or timeout. I haven&apos;t verified it hasn&apos;t broken anything else though but it looks like it shouldn&apos;t.&lt;/p&gt;</comment>
                            <comment id="14016826" author="iamaleksey" created="Tue, 3 Jun 2014 16:04:33 +0000"  >&lt;p&gt;Committed, thanks. (fixed non-reusing the replicationMutation local var on commit).&lt;/p&gt;</comment>
                            <comment id="14016866" author="rlow" created="Tue, 3 Jun 2014 16:49:23 +0000"  >&lt;p&gt;Confirmed that we issued counter deletes so it&apos;s the same root cause. Thanks for the fix!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12648171" name="7144-2.txt" size="2305" author="aleksey" created="Tue, 3 Jun 2014 15:32:31 +0000"/>
                            <attachment id="12648165" name="7144.txt" size="1912" author="aleksey" created="Tue, 3 Jun 2014 14:49:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390422</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1v907:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390675</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326174">1.2.16</customfieldvalue>
    <customfieldvalue id="12326170">2.0.6</customfieldvalue>
    <customfieldvalue id="12326472">2.0.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rlow</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[rlow]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>