<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:18:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1934] Update token metadata for NORMAL state</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1934</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The handleStateNormal() method in StorageService.java doesn&apos;t update the tokenmetadata. This means if you try to decommission a node but for some reason it fails, and then you bring the node back up, all other nodes will see it in a &apos;Leaving&apos; state. When the state jumps back to normal they should update the token metadata to reflect that.&lt;/p&gt;

&lt;p&gt;This also means you won&apos;t be able to call &apos;removetoken&apos; on that node, unless you restart another node in the cluster in order to put it back in a &apos;normal&apos; state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494667">CASSANDRA-1934</key>
            <summary>Update token metadata for NORMAL state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="nickmbailey">Nick Bailey</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jan 2011 02:06:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:10 +0000</updated>
                            <resolved>Thu, 20 Jan 2011 21:37:59 +0000</resolved>
                                        <fixVersion>0.7.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="14400">4h</timeoriginalestimate>
                            <timeestimate seconds="14400">4h</timeestimate>
                                        <comments>
                            <comment id="12979668" author="brandon.williams" created="Mon, 10 Jan 2011 18:10:40 +0000"  >&lt;p&gt;Patch to allow recovery to normal if we knew about the endpoint previously and its IP has not changed.&lt;/p&gt;</comment>
                            <comment id="12984368" author="jbellis" created="Thu, 20 Jan 2011 20:12:37 +0000"  >&lt;p&gt;How does updating when endpoint.equals(currentNode) solve the problem?&lt;/p&gt;

&lt;p&gt;It looks to me like the relevant path is&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            logger_.info(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Nodes %s and %s have the same token %s.  %s is the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; owner&quot;&lt;/span&gt;,
                                       endpoint, currentNode, token, endpoint));
            tokenMetadata_.updateNormalToken(token, endpoint);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is already doing The Right Thing.&lt;/p&gt;</comment>
                            <comment id="12984372" author="brandon.williams" created="Thu, 20 Jan 2011 20:16:28 +0000"  >&lt;p&gt;If you are comparing endpoint to currentNode and they are the same, the generation difference can never be &amp;gt; 0&lt;/p&gt;</comment>
                            <comment id="12984377" author="jbellis" created="Thu, 20 Jan 2011 20:22:12 +0000"  >&lt;p&gt;my point is that currentNode should always have the right view of itself anyway, it&apos;s the other nodes we are worried about (according to the issue description anyway). &lt;/p&gt;</comment>
                            <comment id="12984385" author="brandon.williams" created="Thu, 20 Jan 2011 20:35:37 +0000"  >&lt;p&gt;currentNode (which failed decom and then restarted) does have the correct view of itself (normal) but&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (endpoint.equals(currentNode))
        {
            &lt;span class=&quot;code-comment&quot;&gt;// nothing to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&lt;/span&gt;        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Prevents the other nodes from updating the state from &apos;Leaving&apos; back to &apos;normal&apos;.&lt;/p&gt;

&lt;p&gt;We almost update the state here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Gossiper.instance.compareEndpointStartup(endpoint, currentNode) &amp;gt; 0)
        {
            logger_.info(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Nodes %s and %s have the same token %s.  %s is the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; owner&quot;&lt;/span&gt;,
                                       endpoint, currentNode, token, endpoint));
            tokenMetadata_.updateNormalToken(token, endpoint);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isClientMode)
                SystemTable.updateToken(endpoint, token);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But don&apos;t because the generations will always be equal (in other words, this code only handles a &lt;b&gt;different&lt;/b&gt; node updating the state, not the same node returning)&lt;/p&gt;</comment>
                            <comment id="12984411" author="jbellis" created="Thu, 20 Jan 2011 21:24:19 +0000"  >&lt;p&gt;I still don&apos;t get it &amp;#8211; endpoint.equals(currentNode) will never be true on the other nodes.&lt;/p&gt;</comment>
                            <comment id="12984414" author="jbellis" created="Thu, 20 Jan 2011 21:29:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;I still don&apos;t get it - endpoint.equals(currentNode) will never be true on the other nodes. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking that currentNode == localAddress but that is not the case.  It makes more sense now! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12984415" author="jbellis" created="Thu, 20 Jan 2011 21:30:04 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12984416" author="brandon.williams" created="Thu, 20 Jan 2011 21:30:17 +0000"  >&lt;p&gt;Yes it will.  endpoint is the node entering the ring, currentNode is the node that currently has the token passed in (which in this case will be endpoint&apos;s token also), but does not mean &apos;my address&apos; to the node making the evaluation.  Thus, if we see the same endpoint and token, we do nothing in the current code, causing the state to never get updated.  &lt;/p&gt;</comment>
                            <comment id="12984417" author="jbellis" created="Thu, 20 Jan 2011 21:32:02 +0000"  >&lt;p&gt;(renamed currentNode to currentOwner so I can remember the difference in the future.)&lt;/p&gt;</comment>
                            <comment id="12984420" author="brandon.williams" created="Thu, 20 Jan 2011 21:37:59 +0000"  >&lt;p&gt;committed.&lt;/p&gt;</comment>
                            <comment id="12984428" author="hudson" created="Thu, 20 Jan 2011 21:53:26 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #186 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/186/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/186/&lt;/a&gt;)&lt;br/&gt;
    Update token metadata for NORMAL state when endpoint has not changed.&lt;br/&gt;
Patch by brandonwilliams, reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1934&quot; title=&quot;Update token metadata for NORMAL state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1934&quot;&gt;&lt;del&gt;CASSANDRA-1934&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12467903" name="1934.txt" size="1043" author="brandon.williams" created="Mon, 10 Jan 2011 18:10:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20376</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g8b3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92776</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>nickmbailey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[nickmbailey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>