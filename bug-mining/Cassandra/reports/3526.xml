<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9201] Race condition on creating system_auth.roles and using it on startup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9201</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It looks like it&apos;s possible for &lt;tt&gt;system_auth.roles&lt;/tt&gt; to have a statement prepared against it before the table exists on startup:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main] 2015-04-15 15:12:35,626 CassandraDaemon.java: Exception encountered during startup
java.lang.AssertionError: org.apache.cassandra.exceptions.InvalidRequestException: unconfigured table roles
    at org.apache.cassandra.auth.CassandraRoleManager.prepare(CassandraRoleManager.java:427) ~[main/:na]
    at org.apache.cassandra.auth.CassandraRoleManager.setup(CassandraRoleManager.java:139) ~[main/:na]
    at org.apache.cassandra.service.StorageService.doAuthSetup(StorageService.java:1009) ~[main/:na]
    at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:936) ~[main/:na]
    at org.apache.cassandra.service.StorageService.initServer(StorageService.java:670) ~[main/:na]
    at org.apache.cassandra.service.StorageService.initServer(StorageService.java:557) ~[main/:na]
    at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:412) [main/:na]
    at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:561) [main/:na]
    at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:668) [main/:na]
Caused by: org.apache.cassandra.exceptions.InvalidRequestException: unconfigured table roles
    at org.apache.cassandra.thrift.ThriftValidation.validateColumnFamily(ThriftValidation.java:115) ~[main/:na]
    at org.apache.cassandra.cql3.statements.SelectStatement$RawStatement.prepare(SelectStatement.java:739) ~[main/:na]
    at org.apache.cassandra.auth.CassandraRoleManager.prepare(CassandraRoleManager.java:423) ~[main/:na]
    ... 8 common frames omitted
INFO  [StorageServiceShutdownHook] 2015-04-15 15:12:35,636 Gossiper.java: Announcing shutdown
INFO  [MigrationStage:1] 2015-04-15 15:12:35,639 Schema.java: Loading org.apache.cassandra.config.CFMetaData@57a4b158[cfId=5bc52802-de25-35ed-aeab-188eecebb090,ksName=system_auth,cfName=roles,cfType=Standard,comparator=org.apache.cassandra.db.marshal.CompositeType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.ColumnToCollectionType(6d656d6265725f6f66:org.apache.cassandra.db.marshal.SetType(org.apache.cassandra.db.marshal.UTF8Type))),comment=role definitions,readRepairChance=0.0,dcLocalReadRepairChance=0.0,gcGraceSeconds=7776000,defaultValidator=org.apache.cassandra.db.marshal.BytesType,keyValidator=org.apache.cassandra.db.marshal.UTF8Type,minCompactionThreshold=4,maxCompactionThreshold=32,columnMetadata=[ColumnDefinition{name=member_of, type=org.apache.cassandra.db.marshal.SetType(org.apache.cassandra.db.marshal.UTF8Type), kind=REGULAR, componentIndex=0, indexName=null, indexType=null}, ColumnDefinition{name=is_superuser, type=org.apache.cassandra.db.marshal.BooleanType, kind=REGULAR, componentIndex=0, indexName=null, indexType=null}, ColumnDefinition{name=role, type=org.apache.cassandra.db.marshal.UTF8Type, kind=PARTITION_KEY, componentIndex=null, indexName=null, indexType=null}, ColumnDefinition{name=salted_hash, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, componentIndex=0, indexName=null, indexType=null}, ColumnDefinition{name=can_login, type=org.apache.cassandra.db.marshal.BooleanType, kind=REGULAR, componentIndex=0, indexName=null, indexType=null}],compactionStrategyClass=class org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy,compactionStrategyOptions={},compressionParameters={sstable_compression=org.apache.cassandra.io.compress.LZ4Compressor},bloomFilterFpChance=0.01,memtableFlushPeriod=3600000,caching={&quot;keys&quot;:&quot;ALL&quot;, &quot;rows_per_partition&quot;:&quot;NONE&quot;},defaultTimeToLive=0,minIndexInterval=128,maxIndexInterval=2048,speculativeRetry=99.0PERCENTILE,droppedColumns={},triggers=[],isDense=false]
INFO  [MigrationStage:1] 2015-04-15 15:12:35,654 ColumnFamilyStore.java: Initializing system_auth.roles
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12821346">CASSANDRA-9201</key>
            <summary>Race condition on creating system_auth.roles and using it on startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Apr 2015 22:38:28 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:14 +0000</updated>
                            <resolved>Sun, 3 May 2015 19:19:38 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14497158" author="thobbs" created="Wed, 15 Apr 2015 22:39:23 +0000"  >&lt;p&gt;Linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8996&quot; title=&quot;dtests should pass on trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8996&quot;&gt;&lt;del&gt;CASSANDRA-8996&lt;/del&gt;&lt;/a&gt; because this is causing occasional dtest failures (such as &lt;tt&gt;multidc_putget_test.TestMultiDCPutGet.putget_2dc_rf2_test&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="14519038" author="beobal" created="Wed, 29 Apr 2015 09:41:38 +0000"  >&lt;p&gt;When multiple nodes are started concurrently, StorageService#doAuthSetup can race with defs updates. &lt;/p&gt;

&lt;p&gt;The failure in the logs attached goes like this:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;All 4 nodes are started within a couple of hundred ms&lt;/li&gt;
	&lt;li&gt;Nodes 2, 3 &amp;amp; 4 detect that the &lt;tt&gt;system_auth&lt;/tt&gt; ks is not present and create &amp;amp; announce it&lt;/li&gt;
	&lt;li&gt;Node 1 receives a &lt;tt&gt;DefinitionsUpdate&lt;/tt&gt; from one of the peers and starts to process it on the &lt;tt&gt;MigrationStage&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Node 1 adds the new keyspace to &lt;tt&gt;Schema.instance&lt;/tt&gt; in &lt;tt&gt;LegacySchemaTables.mergeKeyspaces&lt;/tt&gt;, also in the &lt;tt&gt;MigrationStage&lt;/tt&gt; thread&lt;/li&gt;
	&lt;li&gt;Back in the &lt;tt&gt;main&lt;/tt&gt; thread, Node 1 enters &lt;tt&gt;StorageService#doAuthSetup&lt;/tt&gt;. The auth keyspace has been added, so it doesn&apos;t attempt to create it&lt;/li&gt;
	&lt;li&gt;Still in the &lt;tt&gt;main&lt;/tt&gt; thread, Node 1 now moves onto the &lt;tt&gt;setup&lt;/tt&gt; method of the &lt;tt&gt;IRoleManager&lt;/tt&gt;, which in the configured impl attempts to prepare a statement against a &lt;tt&gt;system_auth.roles&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;This fails as the &lt;tt&gt;MigrationStage&lt;/tt&gt; thread hasn&apos;t yet processed the tables in the defs update.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As the table definitions in &lt;tt&gt;AuthKeyspace&lt;/tt&gt; use deterministic IDs, their creation is idempotent so it&apos;s safe to &lt;b&gt;always&lt;/b&gt; call &lt;tt&gt;maybeAddTable&lt;/tt&gt;, which eliminates the race. &lt;/p&gt;

&lt;p&gt;Unfortunately, I haven&apos;t been able to repro the dtest failures locally so I can&apos;t prove that this fixes the issue, but the race seems pretty evident from the attached logs.&lt;/p&gt;</comment>
                            <comment id="14525971" author="iamaleksey" created="Sun, 3 May 2015 19:18:57 +0000"  >&lt;p&gt;Pretty sure that this is what&apos;s happening, too. Committed to trunk as &lt;tt&gt;0db1431e33659392b11060451c71d006941a0dda&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12783375">CASSANDRA-8996</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12729120" name="9201.txt" size="2478" author="samt" created="Wed, 29 Apr 2015 09:41:38 +0000"/>
                            <attachment id="12725712" name="node2.log" size="60427" author="thobbs" created="Wed, 15 Apr 2015 22:38:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dbcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>