<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4223] Non Unique Streaming session ID&apos;s</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4223</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have observed repair processes failing due to duplicate Streaming session ID&apos;s. In this installation it is preventing rebalance from completing. I believe it has also prevented repair from completing in the past. &lt;/p&gt;

&lt;p&gt;The attached streaming-logs.txt file contains log messages and an explanation of what was happening during a repair operation. it has the evidence for duplicate session ID&apos;s.&lt;/p&gt;

&lt;p&gt;The duplicate session id&apos;s were generated on the repairing node and sent to the streaming node. The streaming source replaced the first session with the second which resulted in both sessions failing when the first FILE_COMPLETE message was received. &lt;/p&gt;

&lt;p&gt;The errors were:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG [MiscStage:1] 2012-05-03 21:40:33,997 StreamReplyVerbHandler.java (line 47) Received StreamReply StreamReply(sessionId=26132848816442266, file=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/FMM_Studio/PartsData-hc-1-Data.db&apos;&lt;/span&gt;, action=FILE_FINISHED)
ERROR [MiscStage:1] 2012-05-03 21:40:34,027 AbstractCassandraDaemon.java (line 139) Fatal exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MiscStage:1,5,main]
java.lang.IllegalStateException: target reports current file is /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/FMM_Studio/PartsData-hc-1-Data.db but is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.streaming.StreamOutSession.validateCurrentFile(StreamOutSession.java:195)
        at org.apache.cassandra.streaming.StreamReplyVerbHandler.doVerb(StreamReplyVerbHandler.java:58)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:59)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG [MiscStage:2] 2012-05-03 21:40:36,497 StreamReplyVerbHandler.java (line 47) Received StreamReply StreamReply(sessionId=26132848816442266, file=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/OpsCenter/rollups7200-hc-3-Data.db&apos;&lt;/span&gt;, action=FILE_FINISHED)
ERROR [MiscStage:2] 2012-05-03 21:40:36,497 AbstractCassandraDaemon.java (line 139) Fatal exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MiscStage:2,5,main]
java.lang.IllegalStateException: target reports current file is /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/OpsCenter/rollups7200-hc-3-Data.db but is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.streaming.StreamOutSession.validateCurrentFile(StreamOutSession.java:195)
        at org.apache.cassandra.streaming.StreamReplyVerbHandler.doVerb(StreamReplyVerbHandler.java:58)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:59)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I think this is because System.nanoTime() is used for the session ID when creating the StreamInSession objects (driven from StorageService.requestRanges()) . &lt;/p&gt;

&lt;p&gt;From the documentation (&lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/java/lang/System.html#nanoTime(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/api/java/lang/System.html#nanoTime(&lt;/a&gt;)) &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This method provides nanosecond precision, but not necessarily nanosecond accuracy. No guarantees are made about how frequently values change. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Also some info here on clocks and timers &lt;a href=&quot;https://blogs.oracle.com/dholmes/entry/inside_the_hotspot_vm_clocks&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://blogs.oracle.com/dholmes/entry/inside_the_hotspot_vm_clocks&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The hypervisor may be at fault here. But it seems like we cannot rely on successive calls to nanoTime() to return different values. &lt;/p&gt;

&lt;p&gt;To avoid message/interface changes on the StreamHeader it would be good to keep the session ID a long. The simplest approach may be to make successive calls to nanoTime until the result changes. We could fail if a certain number of milliseconds have passed. &lt;/p&gt;

&lt;p&gt;Hashing the file names and ranges is also a possibility, but more involved. &lt;/p&gt;

&lt;p&gt;(We may also want to drop latency times that are 0 nano seconds.)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 10.04.2 LTS&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0_24&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_24-b07)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 19.1-b02, mixed mode)&lt;/p&gt;

&lt;p&gt;&quot;Bare metal&quot; servers from &lt;a href=&quot;https://www.stormondemand.com/servers/baremetal.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.stormondemand.com/servers/baremetal.html&lt;/a&gt; &lt;br/&gt;
The servers run on a custom hypervisor.&lt;/p&gt;
</environment>
        <key id="12554104">CASSANDRA-4223</key>
            <summary>Non Unique Streaming session ID&apos;s</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amorton">Aaron Morton</assignee>
                                    <reporter username="amorton">Aaron Morton</reporter>
                        <labels>
                            <label>datastax_qa</label>
                    </labels>
                <created>Sun, 6 May 2012 23:10:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:34 +0000</updated>
                            <resolved>Fri, 18 May 2012 18:40:20 +0000</resolved>
                                        <fixVersion>1.0.11</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13270037" author="amorton" created="Mon, 7 May 2012 21:45:25 +0000"  >&lt;p&gt;Did some more testing. On the stormondemand.com machines it looks like nanoTime() is updated every 10ms. On EC2 nodes nanoTime() was always unique. The test script is attached, examples are below...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;root@db6:~/aaron# java -classpath ./ NanoTest 100
nanoTime 460519702418991 occurred 5176 times
nanoTime 460519712419053 occurred 12090 times
nanoTime 460519722419115 occurred 22602 times
nanoTime 460519732419177 occurred 36154 times
nanoTime 460519742419239 occurred 36089 times
nanoTime 460519752419301 occurred 36866 times
nanoTime 460519762419363 occurred 36997 times
nanoTime 460519772419425 occurred 36763 times
nanoTime 460519782419487 occurred 36910 times
nanoTime 460519792419549 occurred 35481 times
Ran &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 100 milliseconds, got 295128 duplicates and 11 uniques.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If it takes 10ms to get a unique value calling multiple times is out of the question. Will put thinking hat back on.&lt;/p&gt;</comment>
                            <comment id="13270045" author="amorton" created="Mon, 7 May 2012 21:50:08 +0000"  >&lt;p&gt;Test for unique nanoTime() results.&lt;/p&gt;</comment>
                            <comment id="13270071" author="jbellis" created="Mon, 7 May 2012 22:51:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;The simplest approach may be to make successive calls to nanoTime until the result changes. We could fail if a certain number of milliseconds have passed. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hector has (had?) some code to make per-client unique timestamps by taking counter = max(currentTimeMillis, counter + 1).  I suppose you could do something similar here so you don&apos;t need to busywait.&lt;/p&gt;</comment>
                            <comment id="13270076" author="amorton" created="Mon, 7 May 2012 23:11:52 +0000"  >&lt;p&gt;yeah was thinking an incrementing counter.&lt;br/&gt;
Any concern about how unique the id&apos;s have to be ? &lt;/p&gt;

&lt;p&gt;I was thinking of creating a long out the (int) gossip generation for the local machine and an int counter that wraps around.   &lt;/p&gt;</comment>
                            <comment id="13270085" author="jbellis" created="Mon, 7 May 2012 23:23:39 +0000"  >&lt;p&gt;That sounds reasonable.  They just need to be unique-per-host, not per-cluster.&lt;/p&gt;</comment>
                            <comment id="13270545" author="jbellis" created="Tue, 8 May 2012 15:33:07 +0000"  >&lt;p&gt;... actually just an AtomicLong counter should be fine.  If we have more than 2^63 streaming sessions I&apos;ll live w/ the overflow. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13270824" author="amorton" created="Tue, 8 May 2012 21:02:51 +0000"  >&lt;p&gt;What about if a node received streaming requests from two other nodes? There would be an (small) chance of the nodes generating the same session ID.&lt;/p&gt;

&lt;p&gt;Adding the gossip generation adds a little entropy to the id&apos;s. Happy to go with the simpler counter idea if you think this is a non-problem. &lt;/p&gt;</comment>
                            <comment id="13270838" author="jbellis" created="Tue, 8 May 2012 21:19:05 +0000"  >&lt;p&gt;It doesn&apos;t need to be unique-per-cluster because StreamInSession tracks it as a Pair&amp;lt;InetAddress, Long&amp;gt;.&lt;/p&gt;</comment>
                            <comment id="13270843" author="yukim" created="Tue, 8 May 2012 21:23:45 +0000"  >&lt;p&gt;I see possible collision here, since StreamOutSession is identified by destination host + timestamp(for now) and StreamInSession in destination node uses it when received it from remote.&lt;br/&gt;
Adding one more key (source IP?) would make ID unique?&lt;/p&gt;</comment>
                            <comment id="13270886" author="jbellis" created="Tue, 8 May 2012 22:12:40 +0000"  >&lt;p&gt;Ugh, so the problem is that sometimes session IDs are generated by the target, and sometimes by the source?  That&apos;s broken...&lt;/p&gt;

&lt;p&gt;I think there&apos;s several possible solutions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;always generate session IDs on the source, so our Pair really is unique &lt;span class=&quot;error&quot;&gt;&amp;#91;the way I thought it worked :)&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;try to make the 64bit session IDs &quot;unique enough&quot; across the cluster &lt;span class=&quot;error&quot;&gt;&amp;#91;aaron&amp;#39;s timestamp + counter&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;guarantee the session IDs are unique-per-host, and make the session context (source, id-generated-by-ip, id) instead of just (source, id) &lt;span class=&quot;error&quot;&gt;&amp;#91;yuki&amp;#39;s suggestion&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;just switch to a UUID&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;#4 is probably simplest, but only #2 and #3 will be backwards-compatible.  Of those two I feel more confident about #3...  The only unique-id-in-64-bit schemas I know of require some coordination up front among participating nodes (e.g., &lt;a href=&quot;http://engineering.twitter.com/2010/06/announcing-snowflake.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://engineering.twitter.com/2010/06/announcing-snowflake.html&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13271010" author="amorton" created="Wed, 9 May 2012 02:05:08 +0000"  >&lt;p&gt;I&apos;ll take another look at how unique the session id need to be.&lt;/p&gt;</comment>
                            <comment id="13271335" author="amorton" created="Wed, 9 May 2012 11:38:39 +0000"  >&lt;p&gt;Use an AtomicLong in StreamInSession and one in StreamOutSession for the session id. &lt;/p&gt;

&lt;p&gt;Sessions are always accessed using &amp;lt;inet_address, session_id&amp;gt;, and in and out session are in their own collections. &lt;/p&gt;</comment>
                            <comment id="13271563" author="yukim" created="Wed, 9 May 2012 16:37:18 +0000"  >&lt;p&gt;After looking closer to the code, I can say that AtomicLong is enough here, as Aaron&apos;s patch suggests.&lt;br/&gt;
There is no need to generate cluster wide unique id, it just need to be unique between two nodes(source, dest).&lt;br/&gt;
I thought a pair of host and long value is shared among nodes but that&apos;s not true. My apologies.&lt;/p&gt;

&lt;p&gt;So +1 to the patch attached.&lt;/p&gt;</comment>
                            <comment id="13271577" author="jbellis" created="Wed, 9 May 2012 16:47:26 +0000"  >&lt;p&gt;StreamIn.requestRanges will create a session ID using the &lt;b&gt;target&lt;/b&gt; node&apos;s id generator (whatever it is) but in a Pair with the &lt;b&gt;source&lt;/b&gt; node&apos;s IP.&lt;/p&gt;

&lt;p&gt;Conversely, when a Stream is originated on the source node, it creates a session id using the &lt;b&gt;source&lt;/b&gt; node&apos;s id generator, and sends that over in the stream header, where IncomingStreamReader picks it up and sticks it in the Session map.&lt;/p&gt;

&lt;p&gt;So it looks to me like Yuki was right the first time ... ?&lt;/p&gt;</comment>
                            <comment id="13271602" author="yukim" created="Wed, 9 May 2012 17:07:28 +0000"  >&lt;p&gt;Name &lt;b&gt;source&lt;/b&gt; is probably misleading here. I found that it&apos;s actually &lt;b&gt;source&lt;/b&gt; of data you&apos;re requesting.&lt;br/&gt;
When node A initiates streaming to node B with StreamIn.requestRanges, it creates StreamInSession with pair of id, say, &amp;lt;B, 1&amp;gt; and sends request with session id 1.&lt;br/&gt;
Node B receives request and creates StreamOutSession from sender&apos;s ip and received session id 1, ends up having StreamOutSession of id &amp;lt;A, 1&amp;gt;.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;A                    &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;B                    &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;StreamInSession&amp;lt;B, 1&amp;gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &amp;#45;&amp;#45;(session ID of 1 from A)&amp;#45;&amp;#45;&amp;gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;StreamOutSession&amp;lt;A, 1&amp;gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &amp;lt;&amp;#45;(session ID of 1 from B)&amp;#45;&amp;#45;- &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="13271618" author="jbellis" created="Wed, 9 May 2012 17:33:54 +0000"  >&lt;p&gt;Right, so the problem is when A creates a &lt;tt&gt;&amp;lt;B, 1&amp;gt;&lt;/tt&gt; Session in StreamIn, while B simultaneously creates a &lt;tt&gt;&amp;lt;B, 1&amp;gt;&amp;gt;&lt;/tt&gt; for an unrelated StreamOut.transferRanges (move or unbootstrap).  &lt;/p&gt;</comment>
                            <comment id="13271883" author="amorton" created="Wed, 9 May 2012 22:27:13 +0000"  >&lt;p&gt;Cassandra 4226&lt;/p&gt;

&lt;p&gt;Agree. We could end up with the StreamOutSessions with the same &amp;lt;ip, id&amp;gt; context, one generated externally one internally. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;3. guarantee the session IDs are unique-per-host, and make the session context (source, id-generated-by-ip, id) instead of just (source, id) &lt;span class=&quot;error&quot;&gt;&amp;#91;yuki&amp;#39;s suggestion&amp;#93;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;how does &quot;id-generated-by-ip&quot; work ? We can only generate a streaming context from the StreamHeader or Stream Reply and sender ip address. Unfortunately these messages are not extensible. &lt;/p&gt;

&lt;p&gt;Another idea: make the session id &lt;span class=&quot;error&quot;&gt;&amp;#91;source_flag + local_int_counter&amp;#93;&lt;/span&gt;. Source flag is:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;0 for a StreamInSession generated to request data.&lt;/li&gt;
	&lt;li&gt;1 for a StreamOutSession generated to transfer/push data.&lt;/li&gt;
	&lt;li&gt;A StreamOutSession created in response to a stream request (still) uses the sessionID generated remotely.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;One node may now have multiple stream out sessions to the same ip with the same session id:&lt;/p&gt;

&lt;p&gt;IP | source_flag | session id&lt;br/&gt;
1.1.1.1 | 0 (started remotely) | 6&lt;br/&gt;
1.1.1.1 | 1 (started locally) | 6   &lt;/p&gt;</comment>
                            <comment id="13272484" author="yukim" created="Thu, 10 May 2012 16:49:17 +0000"  >&lt;p&gt;Isn&apos;t it enough to just increment AtomicLong counter until there is no collision when creating locally?&lt;/p&gt;</comment>
                            <comment id="13272704" author="amorton" created="Thu, 10 May 2012 20:15:58 +0000"  >&lt;p&gt;There are two path ways for a StreamOutSession to be added to the SOS.streams map:&lt;/p&gt;

&lt;p&gt;1) Push / transfer. When node A wants to push data to node B using StreamOut.transferRanges(). In this case the SOS context using the target ip address - &amp;lt;node_b_ip, node_a_sos_counter&amp;gt;&lt;/p&gt;

&lt;p&gt;2) Pull / request. When node B wants node A to send it data, using StreamIn.requestRanges(). Node B creates a StreamInSession that uses the target ip address - &amp;lt;node_a_ip, node_b_sis_counter&amp;gt;. When node A gets the stream request from node b it creates a StreamOutSession with context &amp;lt;node_b_ip, node_b_sis_counter&amp;gt;&lt;/p&gt;

&lt;p&gt;So we can end up with these two sos contexts on node A:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;node_b_ip, node_a_sos_counter&amp;gt;&lt;/li&gt;
	&lt;li&gt;&amp;lt;node_b_ip, node_b_sis_counter&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We need to avoid collisions between node_a_sos_counter and node_b_sis_counter. It&apos;s an unlikely event but we need to be safe.&lt;/p&gt;

&lt;p&gt;Adding the source_flag means we end up with this on node A:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&amp;lt;node_b_ip, 1 &quot;push&quot;, node_a_sos_counter&amp;gt;&lt;/li&gt;
	&lt;li&gt;&amp;lt;node_b_ip, 0 &quot;pull&quot;, node_b_sis_counter&amp;gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;blockquote&gt;&lt;p&gt;Isn&apos;t it enough to just increment AtomicLong counter until there is no collision when creating locally?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you saying &quot;lock around creating the StreamOutSessions from both code paths and create session ID&apos;s that do not collide with known session ids ?&quot;&lt;/p&gt;</comment>
                            <comment id="13272846" author="amorton" created="Thu, 10 May 2012 22:25:22 +0000"  >&lt;p&gt;4223_counter_session_id-V2.diff &lt;/p&gt;

&lt;p&gt;Uses stream source flag as discussed. Added the flags to StreamHeader so they were together. &lt;/p&gt;</comment>
                            <comment id="13274760" author="yukim" created="Mon, 14 May 2012 17:12:35 +0000"  >&lt;p&gt;I&apos;m fine with Aaron&apos;s approach. Session Id counter will overflow if &amp;gt; Integer.MAX_VALUE but I think thats enough for streaming. Regarding the patch, doing 0 &amp;lt;&amp;lt; 32 for StreamOutSession feels redundant to me. I think it&apos;s better to just increment the counter inside StreamOutSession constructor.&lt;/p&gt;</comment>
                            <comment id="13275016" author="amorton" created="Mon, 14 May 2012 22:34:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Regarding the patch, doing 0 &amp;lt;&amp;lt; 32 for StreamOutSession feels redundant to me. I think it&apos;s better to just increment the counter inside StreamOutSession constructor.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Always doing the shift makes it explicit that the session ID is a composite value constructed from two smaller values. And that StreamInSession and StreamOutSession have the same sessionID construction. Remember the StreamInSession ID becomes a StreamOutSession ID. &lt;/p&gt;

&lt;p&gt;For the same reasons I pulled the logic into nextSessionID(), it&apos;s easier to document and make explicit.&lt;/p&gt;

&lt;p&gt;Can change if you think it&apos;s poor style.&lt;/p&gt;</comment>
                            <comment id="13275901" author="yukim" created="Tue, 15 May 2012 15:51:40 +0000"  >&lt;p&gt;OK, +1.&lt;/p&gt;</comment>
                            <comment id="13277722" author="amorton" created="Thu, 17 May 2012 10:59:16 +0000"  >&lt;p&gt;Yuki were you going to commit this or do you want me to?&lt;/p&gt;</comment>
                            <comment id="13277889" author="yukim" created="Thu, 17 May 2012 15:19:58 +0000"  >&lt;p&gt;Aaron,&lt;/p&gt;

&lt;p&gt;Go ahead. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13279068" author="amorton" created="Fri, 18 May 2012 18:39:56 +0000"  >&lt;p&gt;committed to cassandra-1.0, cassandra-1.1 and trunk.&lt;/p&gt;

&lt;p&gt;thanks. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12526438" name="4223_counter_session_id-V2.diff" size="6290" author="amorton" created="Thu, 10 May 2012 22:25:22 +0000"/>
                            <attachment id="12526146" name="4223_counter_session_id.diff" size="3208" author="amorton" created="Wed, 9 May 2012 11:38:39 +0000"/>
                            <attachment id="12525924" name="NanoTest.java" size="1250" author="amorton" created="Mon, 7 May 2012 21:50:08 +0000"/>
                            <attachment id="12525790" name="fmm streaming bug.txt" size="22040" author="amorton" created="Sun, 6 May 2012 23:11:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[amorton]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>238328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gtfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96197</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>