<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2088] Clean up after failed (repair) streaming operation</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2088</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description></description>
                <environment></environment>
        <key id="12497286">CASSANDRA-2088</key>
            <summary>Clean up after failed (repair) streaming operation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="stuhood">Stu Hood</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Feb 2011 05:49:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:07 +0000</updated>
                            <resolved>Wed, 13 Apr 2011 21:06:46 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="12989053" author="stuhood" created="Tue, 1 Feb 2011 05:53:20 +0000"  >&lt;p&gt;Regarding repair: &lt;a href=&quot;http://www.mail-archive.com/user@cassandra.apache.org/msg09259.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@cassandra.apache.org/msg09259.html&lt;/a&gt;&lt;br/&gt;
And compaction: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2084&quot; title=&quot;Corrupt sstables cause compaction to fail again, and again and again, ...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2084&quot;&gt;&lt;del&gt;CASSANDRA-2084&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13003264" author="amorton" created="Mon, 7 Mar 2011 05:23:40 +0000"  >&lt;p&gt;I&apos;m keen to try this ticket (to learn more about compaction and repair) if it&apos;s not already been worked on. Also if it&apos;s ok for me to take a couple of days while I dig into this.&lt;/p&gt;

&lt;p&gt;For compaction I&apos;m looking in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CompactionManager.doCompaction where it creates a new SSTableWriter via cfs.createCompactionWriter()&lt;/li&gt;
	&lt;li&gt;CompactionManager.doCleanupCompaction() also uses an SSTableWriter&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Are the sorts of failures we&apos;re considering for compaction ones that come from the CompactionIterator or SSTableScanner ?&lt;/p&gt;

&lt;p&gt;For repair I&apos;m looking in:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;IncomingStreamReader appears to clean up the temporary pending file in some error situations. Do we have any more info on the sorts of failures here? e.g. If there is an IOException sending the re-stream message, or a non checked exception it will fail to cleaup the file.&lt;/li&gt;
	&lt;li&gt;I&apos;m looking into what happens in StreamInSession.finished() closeIfFinished()&lt;/li&gt;
	&lt;li&gt;Are we considering failures during the streaming or when processing the data after the stream has finished?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Any guidance welcome. &lt;/p&gt;</comment>
                            <comment id="13003435" author="jbellis" created="Mon, 7 Mar 2011 16:59:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Are the sorts of failures we&apos;re considering for compaction ones that come from the CompactionIterator or SSTableScanner ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Both. Also I suppose it&apos;s possible for the writer to error out from lack of disk space since it only checks at the beginning for space and doesn&apos;t &quot;reserve&quot; it vs flushes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are we considering failures during the streaming or when processing the data after the stream has finished?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The former is much more common (I&apos;ve never seen the latter reported), so I&apos;d start with that.&lt;/p&gt;</comment>
                            <comment id="13018204" author="amorton" created="Mon, 11 Apr 2011 05:50:45 +0000"  >&lt;p&gt;patch 0001 tracks failures during AES streaming, files for failed Stream sessions are cleaned up and repair is allowed to continue. Failed files are logged at the StreamSession, TreeRequest, and RepairSession level. &lt;/p&gt;

&lt;p&gt;patch 0002 handle exceptions when doing a (normal) compaction and deletes the temp SSTable. The SSTableWriter components are closed before deletion so that windows will delete correctly. &lt;/p&gt;</comment>
                            <comment id="13018934" author="slebresne" created="Tue, 12 Apr 2011 17:45:13 +0000"  >&lt;p&gt;I think there is a few different things here and I think we should separate them somehow.&lt;/p&gt;

&lt;p&gt;Fixing the fact that streaming leave tmp files around when it fails is a 2 lines fix and I think this is simple enough that it could go to 0.7. I&apos;m attaching a patch against 0.7. It&apos;s extracted from Aaron first patch, although rebased on 0.7 (and fix a bug).&lt;/p&gt;

&lt;p&gt;Making repair aware that there has been some failures is actually more complicated so that should go in 0.8.1 or something (and should go to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2433&quot; title=&quot;Failed Streams Break Repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2433&quot;&gt;&lt;del&gt;CASSANDRA-2433&lt;/del&gt;&lt;/a&gt; or another ticket that describe the problem better). &lt;/p&gt;</comment>
                            <comment id="13018942" author="jbellis" created="Tue, 12 Apr 2011 17:51:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m attaching a patch against 0.7&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is that 0001-Better-detect-failures-from-the-other-side-in-Incomi.patch?  I don&apos;t see the connection to .tmp files.  (Also: have you verified that the channel will actually infinite-loop returning 0?  Kind of odd behavior, although I guess it&apos;s technically within-spec.)&lt;/p&gt;</comment>
                            <comment id="13018965" author="slebresne" created="Tue, 12 Apr 2011 18:21:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is that 0001-Better-detect-failures-from-the-other-side-in-Incomi.patch? I don&apos;t see the connection to .tmp files. (Also: have you verified that the channel will actually infinite-loop returning 0? Kind of odd behavior, although I guess it&apos;s technically within-spec.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes. IncomingStreamReader does clean the tmp file when there is an expection (there&apos;s an enclosing &apos;try catch&apos;). The problem is that no exception is raised if the other side of the connection dies. What will happen then is the read will infinitely read 0 bytes. So this actually avoid the infinite loop returning 0 (and so I think answered your second question, so it wasn&apos;t very clear).&lt;/p&gt;

&lt;p&gt;Note that without this patch, there is an infinite loop that will hold a socket open forever (and consume cpu, though very few probably in that case). So this is not just merely a fix of deleting the tmp files. But it does as a consequence of correctly raising an exception when should be.&lt;/p&gt;</comment>
                            <comment id="13018972" author="jbellis" created="Tue, 12 Apr 2011 18:25:39 +0000"  >&lt;p&gt;+1, and can you move some of that explanation inline as a comment?&lt;/p&gt;</comment>
                            <comment id="13019005" author="slebresne" created="Tue, 12 Apr 2011 19:39:50 +0000"  >&lt;p&gt;Committed that first part. I think we should keep that open to fix the tmp files for failed compaction and move the rest to another ticket (like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2433&quot; title=&quot;Failed Streams Break Repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2433&quot;&gt;&lt;del&gt;CASSANDRA-2433&lt;/del&gt;&lt;/a&gt; for instance).&lt;/p&gt;

&lt;p&gt;About the attached patch on cleaning up failed compaction:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We should also handle cleanup and scrub&lt;/li&gt;
	&lt;li&gt;We should handle SSTableWriter.Builder as it is yet another place where we could miss to cleanup a tmp file on error.&lt;/li&gt;
	&lt;li&gt;In theory a failed flush could leave a tmp file behind. If that happens having a tmp file would be the least of your problem but for completeness sake we could handle it.&lt;/li&gt;
	&lt;li&gt;The logging when failing to close iwriter and dataFile in SSTableWriter could probably go at error (we should not be failing there, if we do something is wrong)&lt;/li&gt;
	&lt;li&gt;That&apos;s nitpick but I&apos;m not a huge fan of catching RuntimeException in this case as this pollute the code for something that would be a programming error (that&apos;s probably debatable though). Maybe another solution would be to have this in the final block. It means making sure closeAndDelete() is ok with the file being already closed and/or deleted and having this final block &lt;b&gt;after&lt;/b&gt; the closeAndOpenReader call.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13019171" author="amorton" created="Wed, 13 Apr 2011 03:08:25 +0000"  >&lt;p&gt;Thanks will take another look at the cleanup for compaction. &lt;/p&gt;</comment>
                            <comment id="13019551" author="jbellis" created="Wed, 13 Apr 2011 21:06:38 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2468&quot; title=&quot;Clean up after failed compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2468&quot;&gt;&lt;del&gt;CASSANDRA-2468&lt;/del&gt;&lt;/a&gt; for compaction cleanup. Will close this one for streaming.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476140" name="0001-Better-detect-failures-from-the-other-side-in-Incomi.patch" size="1499" author="slebresne" created="Tue, 12 Apr 2011 17:45:13 +0000"/>
                            <attachment id="12475965" name="0001-detect-streaming-failures-and-cleanup-temp-files.patch" size="30882" author="amorton" created="Mon, 11 Apr 2011 05:50:45 +0000"/>
                            <attachment id="12475966" name="0002-delete-partial-sstable-if-compaction-error.patch" size="3262" author="amorton" created="Mon, 11 Apr 2011 05:50:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20437</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g98n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92927</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>