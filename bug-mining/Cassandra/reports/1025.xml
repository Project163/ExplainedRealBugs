<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2496] Gossip should handle &apos;dead&apos; states</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2496</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;For background, see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2371&quot; title=&quot;Removed/Dead Node keeps reappearing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2371&quot;&gt;&lt;del&gt;CASSANDRA-2371&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12504582">CASSANDRA-2496</key>
            <summary>Gossip should handle &apos;dead&apos; states</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Apr 2011 18:57:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:01 +0000</updated>
                            <resolved>Mon, 25 Jul 2011 18:58:42 +0000</resolved>
                                        <fixVersion>0.8.3</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13041902" author="brandon.williams" created="Wed, 1 Jun 2011 00:08:52 +0000"  >&lt;p&gt;The first patch allows gossip to track dead states and completely changes how removetoken works, since it is the problem with keeping dead state around, and currently broken in many scenarios.  The second patch adds the previously reverted &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2115&quot; title=&quot;Keep endpoint state until aVeryLongTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2115&quot;&gt;&lt;del&gt;CASSANDRA-2115&lt;/del&gt;&lt;/a&gt; back now that removetoken is more resilient.&lt;/p&gt;</comment>
                            <comment id="13042254" author="brandon.williams" created="Wed, 1 Jun 2011 16:02:19 +0000"  >&lt;p&gt;Some explanation of what changed and why it was necessary:&lt;/p&gt;

&lt;p&gt;Consider nodes A through D. D is partitioned, and C is dead and needs to be removed. A removetoken will be issued to A for this.&lt;/p&gt;

&lt;p&gt;In the current way we do things, A will modify it&apos;s own state by appending information to its status indicating that it will be removing C. B will see this, re-replicate as needed, then report to A that is is done. The problem however, is that since A modified its own state, A is also free to wipe that state out, either by restarting, or simple remove another token, because there&apos;s only space for one. If A reboots and then D&apos;s partition heals, D will never know C was removed. Worse, it will still have state for C that neither A nor B do, and so it will repopulate the ring with C again.&lt;/p&gt;

&lt;p&gt;This patch changes this by instead having A sleep for RING_DELAY to make sure the generation for C is stable, and then it modifies C&apos;s state to indicate it is being removed, just as if C itself had done this. It also appends some extra state to indicate that A will be the removal coordinator. The others nodes see this, re-replicate and report back to A, which then modifies C&apos;s state once more to indicate it is completely removed. At this point, it doesn&apos;t matter if A dies completely and D&apos;s partition heals, since the state is stored in C&apos;s gossip information. If A reboots, it will be able to get the correct state information from B, or any other node.&lt;/p&gt;

&lt;p&gt;If A fails while the other nodes are re-replicating, a new removetoken can be started elsewhere, or in the case of other replicas being down preventing removetoken from completing, a removetoken force will remove the node and then repair can be run to restore the replica count.&lt;/p&gt;</comment>
                            <comment id="13065409" author="brandon.williams" created="Thu, 14 Jul 2011 17:40:25 +0000"  >&lt;p&gt;I see two more things to be done with this patch.  First, when re-replicating nodes report back to the removal coordinator, if the coordinator has restarted it won&apos;t understand them, and they will infinitely loop retrying the confirmation.  Second, since we&apos;re holding dead states, we need to make sure that bootstrapping/moving nodes can take over these dead tokens.&lt;/p&gt;</comment>
                            <comment id="13065527" author="thepaul" created="Thu, 14 Jul 2011 20:54:34 +0000"  >&lt;p&gt;These small patches build on the others.&lt;/p&gt;

&lt;p&gt;0003-update-gossip-related-comments.patch.txt: updates gossip-related comments derp derp.&lt;/p&gt;</comment>
                            <comment id="13065528" author="thepaul" created="Thu, 14 Jul 2011 20:56:12 +0000"  >&lt;p&gt;0004-do-REMOVING_TOKEN-REMOVED_TOKEN.patch.txt: use REMOVED_TOKEN instead of STATUS_LEFT (would probably be ok either way, but otherwise, the REMOVED_TOKEN state would not be used). Seems this is more the way it was intended.&lt;/p&gt;</comment>
                            <comment id="13065529" author="thepaul" created="Thu, 14 Jul 2011 20:57:51 +0000"  >&lt;p&gt;0005-drain-self-if-removetoken-d-elsewhere.patch.txt : when node X was partitioned and removetoken&apos;d but then it shows up again, it should shut itself down, rather than becoming a zombie&lt;/p&gt;</comment>
                            <comment id="13065531" author="thepaul" created="Thu, 14 Jul 2011 20:58:50 +0000"  >&lt;p&gt;I&apos;ll see what I can do to test the &quot;infinitely loop retrying the confirmation&quot; and &quot;bootstrapping/moving nodes can take over these dead tokens&quot; situations.&lt;/p&gt;</comment>
                            <comment id="13068725" author="thepaul" created="Wed, 20 Jul 2011 23:48:29 +0000"  >&lt;p&gt;Ok, nodes do indeed infinitely retry the replication confirmation in some cases, but it appears it&apos;s not just when the former removal coordinator has restarted in the interim- it seems to be when the removetoken is reissued to another, new removal coordinator. In this case, I get this traceback every 10 seconds:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [MiscStage:9] 2011-07-20 23:42:06,599 AbstractCassandraDaemon.java (line 113) Fatal exception in thread Thread[MiscStage:9,5,main]
java.lang.AssertionError
        at org.apache.cassandra.service.StorageService.confirmReplication(StorageService.java:2088)
        at org.apache.cassandra.streaming.ReplicationFinishedVerbHandler.doVerb(ReplicationFinishedVerbHandler.java:38)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:72)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll look into this.&lt;/p&gt;

&lt;p&gt;Second, it seems that moving/joining nodes can take over the removed token fine, once the removetoken is complete. I haven&apos;t tried having a node take over the removed token while the removal is ongoing- I assume we can just document that that probably isn&apos;t a great idea?&lt;/p&gt;</comment>
                            <comment id="13069159" author="thepaul" created="Thu, 21 Jul 2011 19:50:45 +0000"  >&lt;p&gt;0006-acknowledge-unexpected-repl-fins.patch.txt: don&apos;t assert and drop the message when we see an unexpected REPLICATION_FINISHED. Ack it instead, so the sender doesn&apos;t continually retry.&lt;/p&gt;</comment>
                            <comment id="13069174" author="thepaul" created="Thu, 21 Jul 2011 20:09:27 +0000"  >&lt;p&gt;0006-acknowledge-unexpected-repl-fins.patch.txt (updated): also log at info when acknowledging the unexpected messages&lt;/p&gt;</comment>
                            <comment id="13069202" author="thepaul" created="Thu, 21 Jul 2011 20:52:57 +0000"  >&lt;p&gt;ok, +1 with these patches.&lt;/p&gt;</comment>
                            <comment id="13069857" author="brandon.williams" created="Sat, 23 Jul 2011 00:20:53 +0000"  >&lt;p&gt;0007 handles problems when a node has been down longer than aVeryLongTime, and ensures that we advertise the new token states long enough.&lt;/p&gt;

&lt;p&gt;0008 makes sure that SS only get involved with removal if the token is a member.&lt;/p&gt;</comment>
                            <comment id="13070663" author="thepaul" created="Mon, 25 Jul 2011 18:33:52 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13070679" author="brandon.williams" created="Mon, 25 Jul 2011 18:58:42 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="13070710" author="hudson" created="Mon, 25 Jul 2011 19:43:56 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #238 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/238/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/238/&lt;/a&gt;)&lt;br/&gt;
    Gossip handles dead states, token removal actually works, gossip states&lt;br/&gt;
are held for aVeryLongTime.&lt;br/&gt;
Patch by brandonwilliams and Paul Cannon, reviewed by Paul Cannon for&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2496&quot; title=&quot;Gossip should handle &amp;#39;dead&amp;#39; states&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2496&quot;&gt;&lt;del&gt;CASSANDRA-2496&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;brandonwilliams : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1150847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1150847&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/Gossiper.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/VersionedValue.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/NEWS.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/HeartBeatState.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageService.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/net/MessagingService.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/ApplicationState.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12461187">CASSANDRA-957</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12481028" name="0001-Rework-token-removal-process.txt" size="17981" author="brandon.williams" created="Wed, 1 Jun 2011 01:39:39 +0000"/>
                            <attachment id="12481019" name="0002-add-2115-back.txt" size="3592" author="brandon.williams" created="Wed, 1 Jun 2011 00:28:32 +0000"/>
                            <attachment id="12486503" name="0003-update-gossip-related-comments.patch.txt" size="6399" author="thepaul" created="Thu, 14 Jul 2011 20:54:34 +0000"/>
                            <attachment id="12486504" name="0004-do-REMOVING_TOKEN-REMOVED_TOKEN.patch.txt" size="1258" author="thepaul" created="Thu, 14 Jul 2011 20:56:12 +0000"/>
                            <attachment id="12486505" name="0005-drain-self-if-removetoken-d-elsewhere.patch.txt" size="1691" author="thepaul" created="Thu, 14 Jul 2011 20:57:51 +0000"/>
                            <attachment id="12487346" name="0006-acknowledge-unexpected-repl-fins.patch.txt" size="2522" author="thepaul" created="Thu, 21 Jul 2011 20:09:27 +0000"/>
                            <attachment id="12487575" name="0007-Always-update-epstate-timestamps-when-the-node-is-al.patch" size="4479" author="brandon.williams" created="Sat, 23 Jul 2011 00:20:53 +0000"/>
                            <attachment id="12487576" name="0008-only-handleStateRemoving-if-the-node-is-a-member.patch" size="3853" author="brandon.williams" created="Sat, 23 Jul 2011 00:20:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20655</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0anvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60142</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thepaul</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thepaul]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>