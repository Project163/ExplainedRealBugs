<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10778] RowIndexEntry$Serializer invoked to serialize old format RIE triggering assertion</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10778</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I have been running some test for upgrading from v2.2.2 to v3.0.0. &lt;/p&gt;

&lt;p&gt;I encountered the following `ERROR` in the `system.log` when I was &lt;b&gt;creating/dropping materialized views&lt;/b&gt;. I did some searches online but couldn&apos;t find anything useful so filing this. The log seem to suggest that it is bug-like.&lt;/p&gt;

&lt;p&gt;Any thoughts on this would be appreciated.&lt;/p&gt;

&lt;p&gt;Main error line in log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:4] 2015-11-26 15:40:56,033 CassandraDaemon.java:195 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:4,1,main]
    java.lang.AssertionError: We read old index files but we should never write them
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Longer log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    INFO  [SharedPool-Worker-2] 2015-11-26 15:25:37,152 MigrationManager.java:336 - Create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; view: org.apache.cassandra.config.ViewDefinition@1b7fc5e6[ksName=demo,viewName=broker_quotes_by_date,baseTableId=bf928280-3c23-11e5-a4ba-07dc7eba8ee2,baseTableName=broker_quotes,includeAllColumns=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,whereClause=date IS NOT NULL AND datetime IS NOT NULL AND isin IS NOT NULL AND side IS NOT NULL AND broker IS NOT NULL,metadata=org.apache.cassandra.config.CFMetaData@49123522[cfId=f19cb8f0-9451-11e5-af90-6916ca23ea25,ksName=demo,cfName=broker_quotes_by_date,flags=[COMPOUND],params=TableParams{comment=, read_repair_chance=0.0, dclocal_read_repair_chance=0.1, bloom_filter_fp_chance=0.01, crc_check_chance=1.0, gc_grace_seconds=864000, default_time_to_live=0, memtable_flush_period_in_ms=0, min_index_interval=128, max_index_interval=2048, speculative_retry=99PERCENTILE, caching={&lt;span class=&quot;code-quote&quot;&gt;&apos;keys&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;ALL&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;rows_per_partition&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;NONE&apos;&lt;/span&gt;}, compaction=CompactionParams{class=org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy, options={min_threshold=4, max_threshold=32}}, compression=org.apache.cassandra.schema.CompressionParams@f3ef4959, extensions={}},comparator=comparator(org.apache.cassandra.db.marshal.ReversedType(org.apache.cassandra.db.marshal.TimestampType), org.apache.cassandra.db.marshal.UTF8Type, org.apache.cassandra.db.marshal.UTF8Type, org.apache.cassandra.db.marshal.UTF8Type),partitionColumns=[[] | [bmark_spread g_spread is_axed oas_spread price size ytw z_spread]],partitionKeyColumns=[ColumnDefinition{name=date, type=org.apache.cassandra.db.marshal.TimestampType, kind=PARTITION_KEY, position=0}],clusteringColumns=[ColumnDefinition{name=datetime, type=org.apache.cassandra.db.marshal.ReversedType(org.apache.cassandra.db.marshal.TimestampType), kind=CLUSTERING, position=0}, ColumnDefinition{name=side, type=org.apache.cassandra.db.marshal.UTF8Type, kind=CLUSTERING, position=1}, ColumnDefinition{name=isin, type=org.apache.cassandra.db.marshal.UTF8Type, kind=CLUSTERING, position=2}, ColumnDefinition{name=broker, type=org.apache.cassandra.db.marshal.UTF8Type, kind=CLUSTERING, position=3}],keyValidator=org.apache.cassandra.db.marshal.TimestampType,columnMetadata=[ColumnDefinition{name=z_spread, type=org.apache.cassandra.db.marshal.FloatType, kind=REGULAR, position=-1}, ColumnDefinition{name=datetime, type=org.apache.cassandra.db.marshal.ReversedType(org.apache.cassandra.db.marshal.TimestampType), kind=CLUSTERING, position=0}, ColumnDefinition{name=date, type=org.apache.cassandra.db.marshal.TimestampType, kind=PARTITION_KEY, position=0}, ColumnDefinition{name=oas_spread, type=org.apache.cassandra.db.marshal.FloatType, kind=REGULAR, position=-1}, ColumnDefinition{name=isin, type=org.apache.cassandra.db.marshal.UTF8Type, kind=CLUSTERING, position=2}, ColumnDefinition{name=bmark_spread, type=org.apache.cassandra.db.marshal.FloatType, kind=REGULAR, position=-1}, ColumnDefinition{name=side, type=org.apache.cassandra.db.marshal.UTF8Type, kind=CLUSTERING, position=1}, ColumnDefinition{name=broker, type=org.apache.cassandra.db.marshal.UTF8Type, kind=CLUSTERING, position=3}, ColumnDefinition{name=is_axed, type=org.apache.cassandra.db.marshal.BooleanType, kind=REGULAR, position=-1}, ColumnDefinition{name=ytw, type=org.apache.cassandra.db.marshal.FloatType, kind=REGULAR, position=-1}, ColumnDefinition{name=price, type=org.apache.cassandra.db.marshal.FloatType, kind=REGULAR, position=-1}, ColumnDefinition{name=g_spread, type=org.apache.cassandra.db.marshal.FloatType, kind=REGULAR, position=-1}, ColumnDefinition{name=size, type=org.apache.cassandra.db.marshal.DoubleType, kind=REGULAR, position=-1}],droppedColumns={},triggers=[],indexes=[]]]
    INFO  [MigrationStage:1] 2015-11-26 15:25:37,440 ColumnFamilyStore.java:381 - Initializing demo.broker_quotes_by_date
    ERROR [CompactionExecutor:4] 2015-11-26 15:40:56,033 CassandraDaemon.java:195 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:4,1,main]
    java.lang.AssertionError: We read old index files but we should never write them
	    at org.apache.cassandra.db.RowIndexEntry$Serializer.serialize(RowIndexEntry.java:130) ~[apache-cassandra-3.0.0.jar:3.0.0]
	    at org.apache.cassandra.service.CacheService$KeyCacheSerializer.serialize(CacheService.java:466) ~[apache-cassandra-3.0.0.jar:3.0.0]
	    at org.apache.cassandra.service.CacheService$KeyCacheSerializer.serialize(CacheService.java:454) ~[apache-cassandra-3.0.0.jar:3.0.0]
	    at org.apache.cassandra.cache.AutoSavingCache$Writer.saveCache(AutoSavingCache.java:358) ~[apache-cassandra-3.0.0.jar:3.0.0]
	    at org.apache.cassandra.db.compaction.CompactionManager$12.run(CompactionManager.java:1302) ~[apache-cassandra-3.0.0.jar:3.0.0]
	    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_60]
	    at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_60]
	    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_60]
	    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_60]
	    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_60]
	INFO  [IndexSummaryManager:1] 2015-11-26 15:41:10,729 IndexSummaryManager.java:257 - Redistributing index summaries
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Windows 7 64-bit, Cassandra 3.0.0, Java 1.8u60&lt;/p&gt;</environment>
        <key id="12916612">CASSANDRA-10778</key>
            <summary>RowIndexEntry$Serializer invoked to serialize old format RIE triggering assertion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="esvhd">Will Zhang</reporter>
                        <labels>
                            <label>error</label>
                    </labels>
                <created>Fri, 27 Nov 2015 11:44:04 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:49 +0000</updated>
                            <resolved>Tue, 1 Dec 2015 09:28:49 +0000</resolved>
                                        <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15029884" author="slebresne" created="Fri, 27 Nov 2015 13:44:13 +0000"  >&lt;p&gt;The reason is that the method to serialize old format index entries is not implemented (hence the assertion), which was mistakenly though ok as we never write old format sstables, but as the stack shows, we still potentially dump the key cache for old format sstables and that requires this serialization method after all.&lt;/p&gt;

&lt;p&gt;We just need to add the code to do it, which shouldn&apos;t be too hard, but I think we also need to add a unit test to test serialization/deserialization for all format version we read.&lt;/p&gt;

&lt;p&gt;Now, for those affected, the error isn&apos;t catastrophic. It means the key cache hasn&apos;t be saved properly and that means you&apos;ll have a cold key cache on startup. I&apos;ll also note that running &lt;tt&gt;upgradesstables&lt;/tt&gt; will remove that problem by the virtue of converting all sstables to the new format right away. In fact, I&apos;d definitively recommend running &lt;tt&gt;upgradesstables&lt;/tt&gt; when upgrading nodes on 3.0 if at all practical.&lt;/p&gt;</comment>
                            <comment id="15032232" author="aweisberg" created="Mon, 30 Nov 2015 18:41:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9738?focusedCommentId=14741107&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14741107&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;The original logic was that people are expected to run &lt;tt&gt;upgradesstables&lt;/tt&gt;&lt;/a&gt; when upgrading Cassandra so we didn&apos;t add support for serializing the old format.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Jonathan told me the expectation is that people run upgrade sstables so we don&apos;t need to be heroic. Let&apos;s go for the simples possible solution which is making the old and new formats match after deserialization. Hopefully this means we can remove a bunch of paths based in which format we are looking at.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hitting an assertion when it is expected that there will be a period before &lt;tt&gt;upgradesstables&lt;/tt&gt; is run doesn&apos;t make sense. I think what we want to do instead is skip index entries that are in the old format and just not write them. Newer entries will still get written so you won&apos;t have a completely cold cache and if the access pattern is temporal most things in the cache will be newer entries anyways.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; does it make sense to you that since people will run &lt;tt&gt;upgradesstables&lt;/tt&gt; there is no need to implement write path serialization (and tests) for the old format?&lt;/p&gt;</comment>
                            <comment id="15032240" author="slebresne" created="Mon, 30 Nov 2015 18:53:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think what we want to do instead is skip index entries that are in the old format and just not write them.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that&apos;s a totally reasonable option and a somewhat easier to maintain moving forward. Let&apos;s go for that.&lt;/p&gt;</comment>
                            <comment id="15032249" author="slebresne" created="Mon, 30 Nov 2015 18:59:18 +0000"  >&lt;p&gt;Side note: I still feel we should have had tests to catch that though ideally. Basically something that load some old format sstables, force a cache saving and check that it at least doesn&apos;t crash.&lt;/p&gt;</comment>
                            <comment id="15032286" author="aweisberg" created="Mon, 30 Nov 2015 19:15:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;Side note: I still feel we should have had tests to catch that though ideally. Basically something that load some old format sstables, force a cache saving and check that it at least doesn&apos;t crash.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Absolutely. I think we have a few old format tables checked in. I will try and get one of those loaded and use it to test the serialization.&lt;/p&gt;</comment>
                            <comment id="15032326" author="aweisberg" created="Mon, 30 Nov 2015 19:47:50 +0000"  >&lt;p&gt;Proposed fix and the missing test.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10778-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10778-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10778-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15033405" author="slebresne" created="Tue, 1 Dec 2015 09:28:49 +0000"  >&lt;p&gt;+1, committed, thanks.&lt;/p&gt;</comment>
                            <comment id="15033563" author="esvhd" created="Tue, 1 Dec 2015 11:58:04 +0000"  >&lt;p&gt;Thanks guys!!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2p09b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>