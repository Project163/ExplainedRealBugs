<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7177] Starting threads in the OutboundTcpConnectionPool constructor causes race conditions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7177</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The OutboundTcpConnectionPool starts connection threads in its constructor, causing race conditions when MessagingService#getConnectionPool is concurrently called for the first time for a given address.&lt;/p&gt;

&lt;p&gt;I.e., here&apos;s one of the races:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; WARN 12:49:03,182 Error processing org.apache.cassandra.metrics:type=Connection,scope=127.0.0.1,name=CommandPendingTasks
javax.management.InstanceAlreadyExistsException: org.apache.cassandra.metrics:type=Connection,scope=127.0.0.1,name=CommandPendingTasks
	at com.sun.jmx.mbeanserver.Repository.addMBean(Repository.java:437)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerWithRepository(DefaultMBeanServerInterceptor.java:1898)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(DefaultMBeanServerInterceptor.java:966)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(DefaultMBeanServerInterceptor.java:900)
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(DefaultMBeanServerInterceptor.java:324)
	at com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(JmxMBeanServer.java:522)
	at com.yammer.metrics.reporting.JmxReporter.registerBean(JmxReporter.java:464)
	at com.yammer.metrics.reporting.JmxReporter.processGauge(JmxReporter.java:438)
	at com.yammer.metrics.reporting.JmxReporter.processGauge(JmxReporter.java:16)
	at com.yammer.metrics.core.Gauge.processWith(Gauge.java:28)
	at com.yammer.metrics.reporting.JmxReporter.onMetricAdded(JmxReporter.java:395)
	at com.yammer.metrics.core.MetricsRegistry.notifyMetricAdded(MetricsRegistry.java:516)
	at com.yammer.metrics.core.MetricsRegistry.getOrAdd(MetricsRegistry.java:491)
	at com.yammer.metrics.core.MetricsRegistry.newGauge(MetricsRegistry.java:79)
	at com.yammer.metrics.Metrics.newGauge(Metrics.java:70)
	at org.apache.cassandra.metrics.ConnectionMetrics.&amp;lt;init&amp;gt;(ConnectionMetrics.java:71)
	at org.apache.cassandra.net.OutboundTcpConnectionPool.&amp;lt;init&amp;gt;(OutboundTcpConnectionPool.java:55)
	at org.apache.cassandra.net.MessagingService.getConnectionPool(MessagingService.java:498)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12712601">CASSANDRA-7177</key>
            <summary>Starting threads in the OutboundTcpConnectionPool constructor causes race conditions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sbtourist">Sergio Bossa</assignee>
                                    <reporter username="sbtourist">Sergio Bossa</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 May 2014 15:24:50 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:46 +0000</updated>
                            <resolved>Wed, 7 May 2014 19:10:52 +0000</resolved>
                                        <fixVersion>2.0.8</fixVersion>
                    <fixVersion>2.1 rc2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13991147" author="jasobrown" created="Tue, 6 May 2014 21:15:27 +0000"  >&lt;p&gt;Patch looks fine overall, but I&apos;d add a small optimization to the top of OTCP. waitForStarted()&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void waitForStarted()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (started.getCount() == 0)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        ....
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seem reasonable?&lt;/p&gt;</comment>
                            <comment id="13991194" author="sbtourist" created="Tue, 6 May 2014 21:54:46 +0000"  >&lt;p&gt;CountDownLatch#getCount() should only be used for debugging purposes, as await() returns straight away if the count is 0, so I&apos;d say that&apos;s unnecessary.&lt;/p&gt;</comment>
                            <comment id="13991223" author="jasobrown" created="Tue, 6 May 2014 22:10:32 +0000"  >&lt;p&gt;While I do see the comment in the CDL javadoc now (&quot;This method is typically used for debugging and testing purposes&quot;), if you look at the implementation of ASQ.tryAcquireSharedNanos(), it&apos;s not entirely free nor &quot;returns straight away&quot; as two native calls are made. However, I&apos;m not wedded to the micro-optimization, and can commit either way.&lt;/p&gt;</comment>
                            <comment id="13991276" author="sbtourist" created="Tue, 6 May 2014 22:45:55 +0000"  >&lt;p&gt;Which native calls? AQS#tryAcquireShared implementation in CountDownLatch is called first, which is implemented as follows:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;return getState() == 0? 1 : -1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which will cause the following to return straight away:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout) throws InterruptedException {
        if (Thread.interrupted())
            throw new InterruptedException();
        return tryAcquireShared(arg) &amp;gt;= 0 || doAcquireSharedNanos(arg, nanosTimeout);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Or am I missing something? Just curious, I&apos;m fine both ways in the end &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13991336" author="jasobrown" created="Tue, 6 May 2014 23:33:22 +0000"  >&lt;p&gt;You need to look just a little further, into Thread.interrupted():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; interrupted() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; currentThread().isInterrupted(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;both currentThread() and isInterrupted() are native.&lt;/p&gt;</comment>
                            <comment id="13991585" author="sbtourist" created="Wed, 7 May 2014 06:12:54 +0000"  >&lt;p&gt;Ok, so that&apos;s what you mean. I&apos;m not sure those add any significant overhead in modern jvms (it would be interesting to investigate), but anyways, feel free to add the getCount check &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13991744" author="sbtourist" created="Wed, 7 May 2014 11:18:10 +0000"  >&lt;p&gt;I&apos;ve made a small JMH-based test about CountDownLatch await() VS getCount() (plus Thread.currentThread for control/comparison), here&apos;s the gist: &lt;a href=&quot;https://gist.github.com/sbtourist/51cd5c5081e9399c6356&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/sbtourist/51cd5c5081e9399c6356&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We&apos;re talking about micro optimizations, but there&apos;s indeed an overhead (2x throughput) in the await() call, so I&apos;m attaching a second patch which shortcuts when getCount() is zero.&lt;/p&gt;

&lt;p&gt;Nice job in catching it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13992092" author="jasobrown" created="Wed, 7 May 2014 18:40:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt; Thanks for actually getting measuring this (and kudos for using JMH)! I ran the test and got, more or less, the same numbers as you did. Will commit shortly.&lt;/p&gt;</comment>
                            <comment id="13992127" author="jasobrown" created="Wed, 7 May 2014 19:10:52 +0000"  >&lt;p&gt;committed to 2.0, working on merging up to 2.1 and trunk.&lt;/p&gt;</comment>
                            <comment id="13997766" author="jasobrown" created="Wed, 14 May 2014 17:00:39 +0000"  >&lt;p&gt;Forgot to add, but successfully merged everything up on May 7 after resolving some other merge conflict&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12643740" name="CASSANDRA-7177-v2.patch" size="3861" author="sbtourist" created="Wed, 7 May 2014 11:18:10 +0000"/>
                            <attachment id="12643592" name="CASSANDRA-7177.patch" size="3750" author="sbtourist" created="Tue, 6 May 2014 16:30:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sbtourist]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390917</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vbxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391152</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326170">2.0.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>