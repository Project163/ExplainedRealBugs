<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:21:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16856] Prevent broken concurrent schema pulls</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16856</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There&apos;s a race condition around pulling schema changes, that can occur in case the schema changes push/propagation mechanism is not immediately effective (e.g. because of network delay, or because of the pulling node being down, etc.).&lt;/p&gt;

&lt;p&gt;If schema changes happen on node 1, these changes do not reach node 2 immediately through the SCHEMA.PUSH mechanism, and are first recognized during gossiping, the corresponding SCHEMA.PULL request from node 2 can catch the node 1 schema in the middle of it being modified by another schema change request. This can easily lead to problems (e.g. if a new table is being added, and the node 2 request reads the changes that need to be applied to  system_schema.tables, but not the ones that need to be applied to system_schema.columns).&lt;/p&gt;

&lt;p&gt;This PR addresses that by synchronizing the SCHEMA.PULL &quot;RPC call&quot; executed in node 1 by a request from node 2 with the method for applying schema changes in node 1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13395388">CASSANDRA-16856</key>
            <summary>Prevent broken concurrent schema pulls</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bereng">Berenguer Blasi</assignee>
                                    <reporter username="bereng">Berenguer Blasi</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Aug 2021 05:27:43 +0000</created>
                <updated>Fri, 27 May 2022 19:25:09 +0000</updated>
                            <resolved>Thu, 19 Aug 2021 05:45:12 +0000</resolved>
                                        <fixVersion>3.11.12</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Cluster/Gossip</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17401020" author="brandon.williams" created="Wed, 18 Aug 2021 12:38:00 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17419581" author="maedhroz" created="Fri, 24 Sep 2021 05:51:48 +0000"  >&lt;p&gt;I&apos;ve been looking at the 4.0 &amp;amp; trunk versions of this patch, and I&apos;m having a hard time putting things together in my head. Reading the description above, it seems like the approach was going to be a.) synchronize &lt;tt&gt;SchemaKeyspace.convertSchemaToMutations()&lt;/tt&gt;, effectively serializing requests handled by &lt;tt&gt;SchemaPullVerbHandler&lt;/tt&gt; and b.) synchronize &lt;tt&gt;SchemaKeyspace.applyChanges()&lt;/tt&gt; (I&apos;m guessing?), which is where mutations to the schema keyspace are actually applied. In other words, the idea was to not allow concurrent reads and writes on the state protected by &lt;tt&gt;SchemaKeyspace&lt;/tt&gt;. (Would we also need to synchronize &lt;tt&gt;truncate()&lt;/tt&gt; and &lt;tt&gt;saveSystemKeyspacesSchema()&lt;/tt&gt;?)&lt;/p&gt;

&lt;p&gt;It seems like only &quot;a&quot; was done here and not &quot;b&quot;, and the attached test is sort of just a trip-wire for if anyone ever tries to remove the monitor lock.&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17420088" author="azotcsit" created="Sat, 25 Sep 2021 08:34:08 +0000"  >&lt;p&gt;&lt;tt&gt;applyChanges&lt;/tt&gt; is used from synchronized sections in &lt;tt&gt;Schema&lt;/tt&gt;&#160;and that helps to prevent issues related to concurrent schema updates, but does not seem to handle &quot;read during write&quot; use case as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&#160;correctly pointed. I&apos;m not really well familiar with this codebase, but what Caleb suggested (including &lt;tt&gt;truncate&lt;/tt&gt; and &lt;tt&gt;saveSystemKeyspacesSchema&lt;/tt&gt;) makes sense to me.&lt;/p&gt;</comment>
                            <comment id="17420501" author="bereng" created="Mon, 27 Sep 2021 06:38:03 +0000"  >&lt;p&gt;What you mention makes sense. The concurrent read/write path is not protected. I am going to open a ticket for these modification as this is not a part of the code I know inside out, where we&apos;ll be able to run tests. Let&apos;s cross fingers there are no exotic scenarios leading to some deadlock.&lt;/p&gt;

&lt;p&gt;As per the junit this is the best we could came up with without going into a multinode/byteman craze that might end up not testing the actual path. It&apos;s better than nothing but suggestions welcomed.&lt;/p&gt;</comment>
                            <comment id="17420818" author="jmckenzie" created="Mon, 27 Sep 2021 15:23:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;As per the junit this is the best we could came up with without going into a multinode/byteman craze that might end up not testing the actual path. It&apos;s better than nothing but suggestions welcomed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;d house the comment as to why the method is synchronized plus the link to the JIRA together rather than having the documentation of the reason only existing in the unit test. Seems like we&apos;d have better cohesion on the &quot;this is here for a reason, understand that reason before modifying&quot; effort by doing so.&lt;/p&gt;</comment>
                            <comment id="17420953" author="maedhroz" created="Mon, 27 Sep 2021 18:23:29 +0000"  >&lt;p&gt;Assuming the scenario in the description is something we arrived at simply via inspection...&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If schema changes happen on node 1, these changes do not reach node 2 immediately through the SCHEMA.PUSH mechanism, and are first recognized during gossiping, the corresponding SCHEMA.PULL request from node 2 can catch the node 1 schema in the middle of it being modified by another schema change request.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;...the goal of making access to schema via &lt;tt&gt;SchemaKeyspace&lt;/tt&gt; atomic (in the sense that we won&apos;t expose partial schema changes) is reasonable. In terms of testing, I&apos;d probably just start w/ a time-boxed fuzz test of &lt;tt&gt;SchemaKeyspace&lt;/tt&gt; itself to reproduce atomicity violations, using that to verify the fix. (ex. &lt;tt&gt;DigestResolverTest#multiThreadedNoRepairNeededReadCallback()&lt;/tt&gt;)&lt;/p&gt;

&lt;p&gt;(Even if there wasn&apos;t a catastrophic consequence to not changing this, having &lt;tt&gt;SchemaKeyspace&lt;/tt&gt; expose some serial ordering of complete schema changes certainly reduces the possible states of the system to reason about other problems. Deadlock due to something like lock acquisition order doesn&apos;t seem like a worry here...)&lt;/p&gt;</comment>
                            <comment id="17421164" author="bereng" created="Tue, 28 Sep 2021 05:29:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmckenzie&quot; class=&quot;user-hover&quot; rel=&quot;jmckenzie&quot;&gt;jmckenzie&lt;/a&gt; the origin of this ticket is a multi-node fallout test that was failing to start some node bc of this reason.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmckenzie&quot; class=&quot;user-hover&quot; rel=&quot;jmckenzie&quot;&gt;jmckenzie&lt;/a&gt; good point I can add the comment + ticket ref to all the places for clarity.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; Brandon and I had a discussion on how to better test this. Besides the one you point out there was another dtest I played with that was also very re-usable. But in the end we had a worry: look at &lt;tt&gt;applyChanges()&lt;/tt&gt; where the method itself is not synched but the paths that call it are. The worry being we&apos;d be testing the call paths being synched but not the method itself being synched. Instantiating the class itself and mocking everything is &apos;not doable&apos; within reason, the class is final and can&apos;t be extended, etc. So that junit is what I could come up with. And tbh I dislike both approaches: the one I did and going for a dtest. But I couldn&apos;t think of anything else. Maybe I am thinking too much about it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                            <outwardlinks description="is a parent of">
                                        <issuelink>
            <issuekey id="13403427">CASSANDRA-16996</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0txjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339541">3.11.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/23b61a5fa1de17cc6b8a1d7c300053160bfc728a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/23b61a5fa1de17cc6b8a1d7c300053160bfc728a&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;See PR&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>