<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6869] Broken 1.2 sstables support in 2.1</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6869</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5417&quot; title=&quot;Push composites support in the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5417&quot;&gt;&lt;del&gt;CASSANDRA-5417&lt;/del&gt;&lt;/a&gt; has broken 1.2 (ic) sstables support in at least two ways.&lt;/p&gt;

&lt;p&gt;1. CFMetaData.getOnDiskSerializer(), used by SSTableNamesIterator and IndexedSliceReader, doesn&apos;t account for pre-2.0 supercolumn sstables&lt;/p&gt;

&lt;p&gt;2. More importantly, ACCNT.CompositeDeserializer doesn&apos;t handle ic tables&apos; cell counts, and maybeReadNext() might throw EOFException while expecting the partition end marker. SimpleDeserializer is likely just as broken.&lt;/p&gt;

&lt;p&gt;I&apos;d expect more issues like this, but less obvious, in the code, and thus am torn between forcing people to run upgradesstables on 2.0 and actually fixing these issues, and hoping that we haven&apos;t missed anything.&lt;/p&gt;

&lt;p&gt;Implementing a supercolumn aware AtomDeserializer is not hard, fixing CompositeDeserializer and SimpleDeserializer isn&apos;t very hard either, but I really am worried about stuff that&apos;s less obvious. Plus, if we drop that support, we can get rid of some legacy supercolumn code in 2.1. Minus, obviously, is a bit of extra pain for 2.0-&amp;gt;2.1 upgraders still having 1.2- sstables around.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12701698">CASSANDRA-6869</key>
            <summary>Broken 1.2 sstables support in 2.1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Sat, 15 Mar 2014 20:56:33 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:51 +0000</updated>
                            <resolved>Mon, 31 Mar 2014 10:44:20 +0000</resolved>
                                        <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13937650" author="slebresne" created="Mon, 17 Mar 2014 10:42:46 +0000"  >&lt;p&gt;Truth is, when we said we would make 2.0 a mandatory stop to upgrade to 2.1, I kind of expected that would include asking people to upgrade their sstables too. To put it another way, since we do make 2.0 a mandatory stop (even 2.0.6+ in fact), I wonder if this is not the right time to additionally force an updatesstables while we&apos;re at it, and thus drop old sstable compat code. In a majority of case, upgrading to 2.0 will mean doing an updatesstables anyway since you can&apos;t stream without that (i.e. updatesstables is almost implied by an upgrade to a major), so I don&apos;t think that&apos;s a big additional burden.&lt;/p&gt;

&lt;p&gt;So anyway, we can indeed add back code to handle the pre-2.0 format, but my vote goes to extending the &quot;make 2.0 a mandatory stop&quot; definition to include sstables. &lt;/p&gt;</comment>
                            <comment id="13937701" author="iamaleksey" created="Mon, 17 Mar 2014 11:39:55 +0000"  >&lt;p&gt;For the record, I&apos;m also leaning towards making upgradesstables mandatory in 2.0.&lt;/p&gt;</comment>
                            <comment id="13937713" author="jbellis" created="Mon, 17 Mar 2014 11:59:15 +0000"  >&lt;p&gt;wfm&lt;/p&gt;</comment>
                            <comment id="13946592" author="slebresne" created="Tue, 25 Mar 2014 14:22:31 +0000"  >&lt;p&gt;So attaching patch for what&apos;s above.&lt;/p&gt;</comment>
                            <comment id="13946823" author="iamaleksey" created="Tue, 25 Mar 2014 17:32:20 +0000"  >&lt;p&gt;LGTM mostly, although I do think we should put some &apos;friendly exception&apos; in ColumnFamilySerializer#deserialize() if version &amp;lt; 2.0 and isSuper() (because hints and batchlog might still contain those serialized mutations). Or maybe put it into MutationSerializer#deserialize() instead.&lt;/p&gt;

&lt;p&gt;Minor nitty stuff:&lt;/p&gt;

&lt;p&gt;Failing tests:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LegacySSTableTest, for obvious reasons&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unkilled stuff:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;old sc format in SSTableImport should probably go&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unused imports:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ColumnFamilySerializer has 2 unused imports: DataOutput and MessagingService&lt;/li&gt;
	&lt;li&gt;SuperColumns has a bunch of unused imports (more than half now)&lt;/li&gt;
	&lt;li&gt;CellNames in IndexedSliceReader&lt;/li&gt;
	&lt;li&gt;Collections in StatsMetadata&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unused variables:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;version in SimpleSliceReader constructor&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13947951" author="slebresne" created="Wed, 26 Mar 2014 14:16:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;if version &amp;lt; 2.0 and isSuper() (because hints and batchlog might still contain those serialized mutations)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oh, that&apos;s why that code was still there. I just assumed we forgot to remove it. Well, the initial patch was really just about the sstable format and &quot;fixing&quot; the problem on that ticket so re-attaching a first patch that address the nits but revert that part for now.&lt;/p&gt;

&lt;p&gt;This being said, I think it&apos;s silly to keep code around for messaging versions we don&apos;t support just because of the remote chance there may be very old hints remaining. Since we do force users to update the cluster to 2.0 first anyway, the chance that hints from 1.2 remains when upgrading to 2.1 is very slim anyway. So adding a 2nd patch that add a one-time check of the hints table on upgrade to make sure we don&apos;t indeed have remaining old hints (if we have, we ask the user to force delivery because upgrading). With that, the 3rd patch just remove the remainder of pre-2.0 compatibility code. I&apos;ll note that the patch don&apos;t deal with batchLog because it has it&apos;s own (bigger) problem: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6931&quot; title=&quot;BatchLogManager shouldn&amp;#39;t serialize mutations with version 1.2 in 2.1.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6931&quot;&gt;&lt;del&gt;CASSANDRA-6931&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13954530" author="iamaleksey" created="Sun, 30 Mar 2014 00:34:16 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasHintsBefore(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; messagingVersion)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (UntypedResultSet.Row row : QueryProcessor.processInternal(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM system.%s&quot;&lt;/span&gt;)))
        {
{
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides missing a String#format() argument, this looks extremely dangerous to me when unpaged - it &lt;b&gt;will&lt;/b&gt; blow up C* with a decent number of hints accumulated.&lt;/p&gt;

&lt;p&gt;That said, as noted in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6931&quot; title=&quot;BatchLogManager shouldn&amp;#39;t serialize mutations with version 1.2 in 2.1.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6931&quot;&gt;&lt;del&gt;CASSANDRA-6931&lt;/del&gt;&lt;/a&gt; comments, we might not be able to get rid of that code just yet. Gotta wait until 3.0 :\&lt;/p&gt;</comment>
                            <comment id="13955040" author="slebresne" created="Mon, 31 Mar 2014 09:06:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;this looks extremely dangerous to me when unpaged&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, forgot to page it, agreed that it should be done. But as you said, we need to keep this for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6931&quot; title=&quot;BatchLogManager shouldn&amp;#39;t serialize mutations with version 1.2 in 2.1.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6931&quot;&gt;&lt;del&gt;CASSANDRA-6931&lt;/del&gt;&lt;/a&gt; so let&apos;s forget about the 2 last patches then, as I said, they are not directly related to fixing this ticket anyway. What about the first patch then, are we good on that?&lt;/p&gt;</comment>
                            <comment id="13955059" author="iamaleksey" created="Mon, 31 Mar 2014 09:48:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;What about the first patch then, are we good on that?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Almost. SSTableImportTest fails to build (trivially fixed), and, once fixed, fails (slightly less trivially fixed). Feel free to fix on commit.&lt;/p&gt;</comment>
                            <comment id="13955086" author="slebresne" created="Mon, 31 Mar 2014 10:44:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;SSTableImportTest fails to build (trivially fixed), and, once fixed, fails (slightly less trivially fixed)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, there is no way to fix without deleting the tests since the patch was dropping the support for the SC format and that&apos;s what the tests are testing.  That being said, I decided to revert the changed to SSTableImport instead, leaving support for the SC format: it really isn&apos;t much complexity (and we&apos;re not modifiy SSTableImport all that often), and so far SSTableImport seems to have kept support for old stuffs (like testImportSimpleCfOldFormat), so I&apos;d rather keep the SC support a bit longer.&lt;/p&gt;

&lt;p&gt;Anyway, committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12636925" name="0001-Drop-support-for-pre-2.0-sstables.txt" size="43466" author="slebresne" created="Wed, 26 Mar 2014 14:09:26 +0000"/>
                            <attachment id="12636926" name="0002-Check-for-remaining-1.2-hints-when-upgrading-to-2.1.txt" size="4226" author="slebresne" created="Wed, 26 Mar 2014 14:09:26 +0000"/>
                            <attachment id="12636927" name="0003-Remove-remnant-of-pre-2.0-messaging-format.txt" size="10266" author="slebresne" created="Wed, 26 Mar 2014 14:09:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380044</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1thdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>