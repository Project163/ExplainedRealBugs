<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13109] Lightweight transactions temporarily fail after upgrade from 2.1 to 3.0</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13109</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We&apos;ve observed this upgrading from 2.1.15 to 3.0.8 and from 2.1.16 to 3.0.10: some lightweight transactions executed on upgraded nodes fail with a read failure.  The following conditions seem relevant to this occurring:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The transaction must be conditioned on the current value of at least one column, e.g., &lt;tt&gt;IF NOT EXISTS&lt;/tt&gt; transactions don&apos;t seem to be affected.&lt;/li&gt;
	&lt;li&gt;There should be a collection column (in our case, a map) defined on the table on which the transaction is executed.&lt;/li&gt;
	&lt;li&gt;The transaction should be executed before sstables on the node are upgraded.  The failure does not occur after the sstables have been upgraded (whether via &lt;tt&gt;nodetool upgradesstables&lt;/tt&gt; or effectively via compaction).&lt;/li&gt;
	&lt;li&gt;Upgraded nodes seem to be able to participate in lightweight transactions as long as they&apos;re not the coordinator.&lt;/li&gt;
	&lt;li&gt;The values in the row being manipulated by the transaction must have been consistently manipulated by lightweight transactions (perhaps the existence of Paxos state for the partition is somehow relevant?).&lt;/li&gt;
	&lt;li&gt;In 3.0.10, it &lt;em&gt;seems&lt;/em&gt; to be necessary to have the partition split across multiple legacy sstables.  This was not necessary to reproduce the bug in 3.0.8 or .9.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For applications affected by this bug, a possible workaround is to prevent nodes being upgraded from coordinating requests until sstables have been upgraded.&lt;/p&gt;

&lt;p&gt;We&apos;re able to reproduce this when upgrading from 2.1.16 to 3.0.10 with the following steps on a single-node cluster using a mostly pristine &lt;tt&gt;cassandra.yaml&lt;/tt&gt; from the source distribution.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Start Cassandra-2.1.16 on the node.&lt;/li&gt;
	&lt;li&gt;Create a table with a collection column and insert some data into it.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; KEYSPACE test &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;REPLICATION&lt;/span&gt; = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; test.test (&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TEXT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt;, cas_target &lt;span class=&quot;code-keyword&quot;&gt;TEXT&lt;/span&gt;, some_collection &lt;span class=&quot;code-keyword&quot;&gt;MAP&lt;/span&gt;&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;TEXT&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;TEXT&lt;/span&gt;&amp;gt;);
&lt;span class=&quot;code-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INTO&lt;/span&gt; test.test (&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, cas_target, some_collection) &lt;span class=&quot;code-keyword&quot;&gt;VALUES&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;&apos;&lt;/span&gt;, {}) &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;EXISTS&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Flush the row to an sstable: &lt;tt&gt;nodetool flush&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Update the row:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;UPDATE&lt;/span&gt; test.test &lt;span class=&quot;code-keyword&quot;&gt;SET&lt;/span&gt; cas_target = &lt;span class=&quot;code-quote&quot;&gt;&apos;newvalue&apos;&lt;/span&gt;, some_collection = {} &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; cas_target = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Drain the node: &lt;tt&gt;nodetool drain&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Stop the node, upgrade to 3.0.10, and start the node.&lt;/li&gt;
	&lt;li&gt;Attempt to update the row again:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;UPDATE&lt;/span&gt; test.test &lt;span class=&quot;code-keyword&quot;&gt;SET&lt;/span&gt; cas_target = &lt;span class=&quot;code-quote&quot;&gt;&apos;lastvalue&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; cas_target = &lt;span class=&quot;code-quote&quot;&gt;&apos;newvalue&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Using &lt;tt&gt;cqlsh&lt;/tt&gt;, if the error is reproduced, the following output will be returned:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;$ ./cqlsh &amp;lt;&amp;lt;&amp;lt; &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;UPDATE&lt;/span&gt; test.test &lt;span class=&quot;code-keyword&quot;&gt;SET&lt;/span&gt; cas_target = &lt;span class=&quot;code-quote&quot;&gt;&apos;newvalue&apos;&lt;/span&gt;, some_collection = {} &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; cas_target = &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;&apos;&lt;/span&gt;;&quot;&lt;/span&gt;
(&lt;span class=&quot;code-keyword&quot;&gt;start&lt;/span&gt;: 2016-12-22 10:14:27 EST)
&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;stdin&lt;/span&gt;&amp;gt;:2:ReadFailure: Error &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; server: code=1300 [Replica(s) failed &lt;span class=&quot;code-keyword&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;execute&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;read&lt;/span&gt;] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;Operation&lt;/span&gt; failed - received 0 responses &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; 1 failures&quot;&lt;/span&gt; info={&lt;span class=&quot;code-quote&quot;&gt;&apos;failures&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;received_responses&apos;&lt;/span&gt;: 0, &lt;span class=&quot;code-quote&quot;&gt;&apos;required_responses&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;consistency&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;QUORUM&apos;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and the following stack trace will be present in the system log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  15:14:28 Uncaught exception on thread Thread[SharedPool-Worker-10,10,main]: {}
java.lang.RuntimeException: java.lang.NullPointerException
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2476) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_101]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[main/:na]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_101]
Caused by: java.lang.NullPointerException: null
	at org.apache.cassandra.db.rows.Row$Merger$ColumnDataReducer.getReduced(Row.java:617) ~[main/:na]
	at org.apache.cassandra.db.rows.Row$Merger$ColumnDataReducer.getReduced(Row.java:569) ~[main/:na]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:220) ~[main/:na]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:159) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.db.rows.Row$Merger.merge(Row.java:546) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator$MergeReducer.getReduced(UnfilteredRowIterators.java:563) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator$MergeReducer.getReduced(UnfilteredRowIterators.java:527) ~[main/:na]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:220) ~[main/:na]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:159) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:509) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:369) ~[main/:na]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
	at org.apache.cassandra.db.partitions.AbstractBTreePartition.build(AbstractBTreePartition.java:334) ~[main/:na]
	at org.apache.cassandra.db.partitions.ImmutableBTreePartition.create(ImmutableBTreePartition.java:111) ~[main/:na]
	at org.apache.cassandra.db.partitions.ImmutableBTreePartition.create(ImmutableBTreePartition.java:94) ~[main/:na]
	at org.apache.cassandra.db.SinglePartitionReadCommand.add(SinglePartitionReadCommand.java:810) ~[main/:na]
	at org.apache.cassandra.db.SinglePartitionReadCommand.queryMemtableAndSSTablesInTimestampOrder(SinglePartitionReadCommand.java:760) ~[main/:na]
	at org.apache.cassandra.db.SinglePartitionReadCommand.queryMemtableAndDiskInternal(SinglePartitionReadCommand.java:519) ~[main/:na]
	at org.apache.cassandra.db.SinglePartitionReadCommand.queryMemtableAndDisk(SinglePartitionReadCommand.java:496) ~[main/:na]
	at org.apache.cassandra.db.SinglePartitionReadCommand.queryStorage(SinglePartitionReadCommand.java:358) ~[main/:na]
	at org.apache.cassandra.db.ReadCommand.executeLocally(ReadCommand.java:394) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1794) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2472) ~[main/:na]
	... 5 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Under both 3.0.8 and .9, the &lt;tt&gt;nodetool flush&lt;/tt&gt; and additional &lt;tt&gt;UPDATE&lt;/tt&gt; statement before upgrading to 3.0 are not necessary to reproduce this.  In that case (when Cassandra only has to read the data from one sstable?), a different stack trace appears in the log.  Here&apos;s a sample from 3.0.8:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; WARN [SharedPool-Worker-3] 2016-12-13 15:19:48,863 AbstractLocalAwareExecutorService.java (line 169) Uncaught exception on thread Thread[SharedPool-Worker-3,5,main]: {}
java.lang.RuntimeException: java.lang.IllegalStateException: [ColumnDefinition{name=REDACTED, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=REDACTED2, type=org.apache.cassandra.db.marshal.MapType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.UTF8Type), kind=REGULAR, position=-1}] is not a subset of [REDACTED]
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2453) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_101]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[main/:na]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_101]
Caused by: java.lang.IllegalStateException: [ColumnDefinition{name=REDACTED, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=REDACTED2, type=org.apache.cassandra.db.marshal.MapType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.UTF8Type), kind=REGULAR, position=-1}] is not a subset of [REDACTED]
        at org.apache.cassandra.db.Columns$Serializer.encodeBitmap(Columns.java:531) ~[main/:na]
        at org.apache.cassandra.db.Columns$Serializer.serializeSubset(Columns.java:465) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:178) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:108) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:96) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:132) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:77) ~[main/:na]
        at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:300) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:134) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:127) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:123) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:65) ~[main/:na]
        at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:289) ~[main/:na]
        at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1796) ~[main/:na]
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2449) ~[main/:na]
        ... 5 common frames omitted
 WARN [SharedPool-Worker-1] 2016-12-13 15:19:48,943 AbstractLocalAwareExecutorService.java (line 169) Uncaught exception on thread Thread[SharedPool-Worker-1,5,main]: {}
java.lang.IllegalStateException: [ColumnDefinition{name=REDACTED, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=REDACTED2, type=org.apache.cassandra.db.marshal.MapType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.UTF8Type), kind=REGULAR, position=-1}] is not a subset of [REDACTED]
        at org.apache.cassandra.db.Columns$Serializer.encodeBitmap(Columns.java:531) ~[main/:na]
        at org.apache.cassandra.db.Columns$Serializer.serializeSubset(Columns.java:465) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:178) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:108) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:96) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:132) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:77) ~[main/:na]
        at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:300) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:134) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:127) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:123) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:65) ~[main/:na]
        at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:289) ~[main/:na]
        at org.apache.cassandra.db.ReadCommandVerbHandler.doVerb(ReadCommandVerbHandler.java:47) ~[main/:na]
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_101]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[main/:na]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_101]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s not clear to us what changed in 3.0.10 to make this behavior somewhat more difficult to reproduce.&lt;/p&gt;

&lt;p&gt;We spent some time trying to track down the cause in 3.0.8, and we&apos;ve identified a very small patch (which I will attach to this issue) that &lt;em&gt;seems&lt;/em&gt; to fix it.  The problem appears to be that the logic that reads data from legacy sstables can pull range tombstones covering collection columns that weren&apos;t requested, which then breaks downstream logic that doesn&apos;t expect those tombstones to be present in the data.  The patch attempts to include those tombstones only if they&apos;re explicitly requested.  However, there&apos;s enough going on in that logic that it&apos;s not clear to us whether the change is safe, so it is definitely in need of review from someone knowledgable about what that area of the code is intended to do.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13032647">CASSANDRA-13109</key>
            <summary>Lightweight transactions temporarily fail after upgrade from 2.1 to 3.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sklock">Samuel Klock</assignee>
                                    <reporter username="sklock">Samuel Klock</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Fri, 6 Jan 2017 19:50:41 +0000</created>
                <updated>Fri, 25 Oct 2019 13:10:50 +0000</updated>
                            <resolved>Thu, 9 Feb 2017 09:29:20 +0000</resolved>
                                        <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15805546" author="sklock" created="Fri, 6 Jan 2017 19:53:00 +0000"  >&lt;p&gt;Attaching the patch.&lt;/p&gt;</comment>
                            <comment id="15857806" author="slebresne" created="Wed, 8 Feb 2017 10:30:24 +0000"  >&lt;p&gt;Thanks for the report and reproduction steps. I &lt;em&gt;was&lt;/em&gt; able to reproduce this consistently with 3.0.10 but this actually happens to be fixed on the current 3.0 branch (future 3.0.11).&lt;/p&gt;

&lt;p&gt;And the reason this is not a problem anymore is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12694&quot; title=&quot;PAXOS Update Corrupted empty row exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12694&quot;&gt;&lt;del&gt;CASSANDRA-12694&lt;/del&gt;&lt;/a&gt; and that&apos;s because it basically made us fetch all columns for CAS (much like we do for any other CQL query really), thus side-stepping the &quot;the code to read legacy sstable can return stuffs for non fetched columns&quot;.&lt;/p&gt;

&lt;p&gt;That said, that problem in &lt;tt&gt;LegacyLayout&lt;/tt&gt; is kind of legit: we should include something that is not fetched and while we correctly skip non-fetched column for &quot;cells&quot;, we did miss doing the same for collection tombsones. But I say &quot;kind of&quot; because thruth is, after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12694&quot; title=&quot;PAXOS Update Corrupted empty row exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12694&quot;&gt;&lt;del&gt;CASSANDRA-12694&lt;/del&gt;&lt;/a&gt;, I&apos;m not sure we can really run into this problem anymore: only thrift queries uses the mode where we don&apos;t fetch all columns, but thrift don&apos;t support collections so actually cannot create a query that would be problematic for this case.&lt;/p&gt;

&lt;p&gt;Still, the code is definitively not doing what it should and the fix is trivial enough that it&apos;s not worth risking running into problems in the future, or if I happen to miss a genuine case where this could happen, so I&apos;ve pushed the patch for CI below and will commit if tests are clear. I did modify said patch a bit because if the column for which we have a collection tombstone is not fetched, we also want to skip the few lines that were before the condition your patch added as otherwise we might end up returning an empty row which would break assumptions of the code. Still, mostly the same thing, just moving the condition a bit up.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/13109-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13109-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13109-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13109-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/13109-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13109-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13109-3.11-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13109-3.11-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15859251" author="slebresne" created="Thu, 9 Feb 2017 09:29:20 +0000"  >&lt;p&gt;CI was clean so committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12846070" name="13109-3.0.txt" size="1471" author="sklock" created="Fri, 6 Jan 2017 19:53:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sklock]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 40 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38ddz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336056">3.0.8</customfieldvalue>
    <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    <customfieldvalue id="12338291">3.0.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>