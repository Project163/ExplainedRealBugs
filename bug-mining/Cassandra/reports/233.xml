<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:12:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-604] Compactions might remove tombstones without removing the actual data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-604</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I was looking at the code for compaction, and noticed that when we are doing compactions during the normal course of&lt;br/&gt;
Cassandra, we call:&lt;/p&gt;

&lt;p&gt;           for (List&amp;lt;SSTableReader&amp;gt; sstables :&lt;br/&gt;
getCompactionBuckets(ssTables_, 50L * 1024L * 1024L))&lt;br/&gt;
           {&lt;br/&gt;
               if (sstables.size() &amp;lt; minThreshold)&lt;/p&gt;
               {
                   continue;
               }
&lt;p&gt;               other wise docompactions...&lt;/p&gt;

&lt;p&gt;where getCompactionBuckets puts in buckets very small files, or files&lt;br/&gt;
that are 0.5-1.5 of each other&apos;s sizes. It will only compact those if&lt;br/&gt;
they are &amp;gt;= minimum threshold which is 4 by default.&lt;br/&gt;
So far so good. Now how about this scenario, I have an old entry that&lt;br/&gt;
I inserted long time ago and that was compacted into a 75MB file.&lt;br/&gt;
There are fewer 75MB files than 4. I do many deletes, and I end with 4&lt;br/&gt;
extra sstable files filled with tombstones, each about 300 MB large.&lt;br/&gt;
These 4 files are compacted together and in the compaction code, if&lt;br/&gt;
the tombstone is there we don&apos;t copy it over to the new file. Now&lt;br/&gt;
since we did not compact the 75MB files, but we compacted the&lt;br/&gt;
tombstone files, that leaves us with the tombstone gone, but&lt;br/&gt;
the data still intact in the 75MB file. If we compacted all the&lt;br/&gt;
files together I don&apos;t think that would be a problem, but since we&lt;br/&gt;
only compact 4, this potentially leaves data not cleaned.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cent-OS&lt;/p&gt;</environment>
        <key id="12442530">CASSANDRA-604</key>
            <summary>Compactions might remove tombstones without removing the actual data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="rrabah">Ramzi Rabah</reporter>
                        <labels>
                    </labels>
                <created>Sat, 5 Dec 2009 00:12:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:31 +0000</updated>
                            <resolved>Tue, 8 Dec 2009 18:45:44 +0000</resolved>
                                        <fixVersion>0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12786662" author="rrabah" created="Sun, 6 Dec 2009 18:04:03 +0000"  >&lt;p&gt;Thinking about it some more, there is another case when data can be lost. In the above case the file containing the tombstone was compacted by itself before the data file.&lt;br/&gt;
The second case is that the file containing the data is compacted by itself before the tombstone is compacted. &lt;/p&gt;

&lt;p&gt;So in both cases, it seems like the only viable solution I can think of, is to only remove the tombstones when every single SSTable file for the column family is compacted (I.E. major compaction). Otherwise, the tombstone should stick around.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;</comment>
                            <comment id="12786711" author="jbellis" created="Sun, 6 Dec 2009 21:36:32 +0000"  >&lt;p&gt;I don&apos;t follow.&lt;/p&gt;

&lt;p&gt;All the tombstone does is suppress earlier versions.  And all compaction does is write out a new sstable containing only the newest version.  So compacting data w/o the tombstone will either yield (1) a single version that is newer than the tombstone, in which case the tombstone will be ignored on reads, or (2) a single version older than the tombstone, in which case it will still be supressed.  Either way correctness is preserved.&lt;/p&gt;</comment>
                            <comment id="12786743" author="rrabah" created="Mon, 7 Dec 2009 00:33:52 +0000"  >&lt;p&gt;What I meant was there are 2 orders of compactions that might happen that would lead to the clean up of tombstones but not data:&lt;/p&gt;

&lt;p&gt;Case 1) I described first, data is in sstable 1, tombstone in sstable 2. sstables 2-5 are compacted producing sstable 6, and sstable 6 has no tombstone. That leaves us with sstable 1 data, sstable 6 no tombstone --&amp;gt; Probably bad. In this case tombstones are compacted before the data is ever compacted.&lt;/p&gt;

&lt;p&gt;Case 2) data is in sstable 1, tombstone is in sstable 5. sstable 1-4 get compacted to sstable 6 that has data, so now we have sstable 5 tombstone, sstable 6 data. sstable 5,7,8,9 are compacted producing sstable 10. sstable 6 data, sstable 10 no tombstone --&amp;gt; Probably bad.  In this case, data was compacted first, then tombstones. &lt;/p&gt;

&lt;p&gt;Both cases can probably be fixed in the same manner, but just wanted to point out all scenarios which I can think of that can cause this problem. &lt;/p&gt;

</comment>
                            <comment id="12786748" author="jbellis" created="Mon, 7 Dec 2009 00:55:34 +0000"  >&lt;p&gt;That makes sense.  I agree that only GCing tombstones during major compactions (or, other compactions that happen to include all sstables) is the easiest fix.&lt;/p&gt;</comment>
                            <comment id="12787348" author="jbellis" created="Tue, 8 Dec 2009 06:58:17 +0000"  >&lt;p&gt;patch to only GC when compacting all sstables, as outlined above.&lt;/p&gt;

&lt;p&gt;Ramzi to review?&lt;/p&gt;</comment>
                            <comment id="12787629" author="rrabah" created="Tue, 8 Dec 2009 18:33:08 +0000"  >&lt;p&gt;Looks great. I will test the patch with a higher volume of inserts and deletes and let you know how the test goes.&lt;/p&gt;</comment>
                            <comment id="12787645" author="jbellis" created="Tue, 8 Dec 2009 18:45:44 +0000"  >&lt;p&gt;committed.  let us know if your testing uncovers any problems.&lt;/p&gt;</comment>
                            <comment id="12788069" author="hudson" created="Wed, 9 Dec 2009 12:42:41 +0000"  >&lt;p&gt;Integrated in Cassandra #282 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/282/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/282/&lt;/a&gt;)&lt;br/&gt;
    only GC when compacting all sstables, to avoid situations where the data a tombstone is intended to supress is in an sstable that is not part of the compaction set.&lt;br/&gt;
patch by jbellis; reviewed by Ramzi Rabah for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12427304" name="604.patch" size="7888" author="jbellis" created="Tue, 8 Dec 2009 06:58:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19775</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fzyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91423</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>