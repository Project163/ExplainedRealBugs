<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:34:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4462] upgradesstables strips active data from sstables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4462</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;From the discussion here: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/cassandra-user/201207.mbox/%3CCAOac0GCtyDqS6ocuHOuQqre4re5wKj3o-ZpUZGkGsjCHzDVbTA%40mail.gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/cassandra-user/201207.mbox/%3CCAOac0GCtyDqS6ocuHOuQqre4re5wKj3o-ZpUZGkGsjCHzDVbTA%40mail.gmail.com%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We are trying to migrate a 0.8.8 cluster to 1.1.2 by migrating the sstables from the 0.8.8 ring to a parallel 1.1.2 ring. However, every time we run the `nodetool upgradesstables` step we find it removes active data from our CFs &amp;#8211; leading to lost data in our application.&lt;/p&gt;

&lt;p&gt;The steps we took were:&lt;/p&gt;


&lt;p&gt;1. Bring up a 1.1.2 ring in the same AZ/data center configuration with&lt;br/&gt;
tokens matching the corresponding nodes in the 0.8.8 ring.&lt;br/&gt;
2. Create the same keyspace on 1.1.2.&lt;br/&gt;
3. Create each CF in the keyspace on 1.1.2.&lt;br/&gt;
4. Flush each node of the 0.8.8 ring.&lt;br/&gt;
5. Rsync each non-compacted sstable from 0.8.8 to the corresponding node in&lt;br/&gt;
1.1.2.&lt;br/&gt;
6. Move each 0.8.8 sstable into the 1.1.2 directory structure by renaming the file to the  /cassandra/data/&amp;lt;keyspace&amp;gt;/&amp;lt;cf&amp;gt;/&amp;lt;keyspace&amp;gt;-&amp;lt;cf&amp;gt;... format. For example, for the keyspace &quot;Metrics&quot; and CF &quot;epochs_60&quot; we get:&lt;br/&gt;
&quot;cassandra/data/Metrics/epochs_60/Metrics-epochs_60-g-941-Data.db&quot;.&lt;br/&gt;
7. On each 1.1.2 node run `nodetool -h localhost refresh Metrics &amp;lt;CF&amp;gt;` for each CF in the keyspace. We notice that storage load jumps accordingly.&lt;br/&gt;
8. On each 1.1.2 node run `nodetool -h localhost upgradesstables`.&lt;/p&gt;

&lt;p&gt;Afterwards we would test the validity of the data by comparing it with data from the original 0.8.8 ring. After an upgradesstables command the data was always incorrect.&lt;/p&gt;

&lt;p&gt;With further testing we found that we could successfully use scrub to convert our sstables without data loss. However, any invocation of upgradesstables causes active data to be culled from the sstables:&lt;/p&gt;

&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:4&amp;#93;&lt;/span&gt; 2012-07-24 04:27:36,837 CompactionTask.java (line 109) Compacting &lt;span class=&quot;error&quot;&gt;&amp;#91;SSTableReader(path=&amp;#39;/raid0/cassandra/data/Metrics/metrics_900/Metrics-metrics_900-hd-51-Data.db&amp;#39;)&amp;#93;&lt;/span&gt;&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:4&amp;#93;&lt;/span&gt; 2012-07-24 04:27:51,090 CompactionTask.java (line 221) Compacted to &lt;span class=&quot;error&quot;&gt;&amp;#91;/raid0/cassandra/data/Metrics/metrics_900/Metrics-metrics_900-hd-58-Data.db,&amp;#93;&lt;/span&gt;.  60,449,155 to 2,578,102 (~4% of original) bytes for 4,002 keys at 0.172562MB/s.  Time: 14,248ms.&lt;/p&gt;

&lt;p&gt;These are the steps we&apos;ve tried:&lt;/p&gt;

&lt;p&gt;WORKS		refresh -&amp;gt; scrub&lt;br/&gt;
WORKS		refresh -&amp;gt; scrub -&amp;gt; major compaction&lt;br/&gt;
WORKS		refresh -&amp;gt; scrub -&amp;gt; cleanup&lt;br/&gt;
WORKS		refresh -&amp;gt; scrub -&amp;gt; repair&lt;/p&gt;

&lt;p&gt;FAILS		refresh -&amp;gt; upgradesstables&lt;br/&gt;
FAILS		refresh -&amp;gt; scrub -&amp;gt; upgradesstables&lt;br/&gt;
FAILS		refresh -&amp;gt; scrub -&amp;gt; repair -&amp;gt; upgradesstables&lt;br/&gt;
FAILS		refresh -&amp;gt; scrub -&amp;gt; major compaction -&amp;gt; upgradesstables&lt;/p&gt;

&lt;p&gt;We have fewer than 143 million row keys in the CFs we&apos;re testing and none&lt;br/&gt;
of the *-Filter.db files are &amp;gt; 10MB, so I don&apos;t believe this is our&lt;br/&gt;
problem: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3820&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-3820&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The keyspace is defined as:&lt;/p&gt;

&lt;p&gt;Keyspace: Metrics:&lt;br/&gt;
  Replication Strategy: org.apache.cassandra.locator.NetworkTopologyStrategy&lt;br/&gt;
  Durable Writes: true&lt;br/&gt;
    Options: &lt;span class=&quot;error&quot;&gt;&amp;#91;us-east:3&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;And the column family that we tested with is defined as:&lt;/p&gt;

&lt;p&gt;    ColumnFamily: metrics_900&lt;br/&gt;
      Key Validation Class: org.apache.cassandra.db.marshal.UTF8Type&lt;br/&gt;
      Default column value validator: org.apache.cassandra.db.marshal.BytesType&lt;br/&gt;
      Columns sorted by: org.apache.cassandra.db.marshal.CompositeType(org.apache.cassandra.db.marshal.LongType,org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.UTF8Type)&lt;br/&gt;
      GC grace seconds: 0&lt;br/&gt;
      Compaction min/max thresholds: 4/32&lt;br/&gt;
      Read repair chance: 0.1&lt;br/&gt;
      DC Local Read repair chance: 0.0&lt;br/&gt;
      Replicate on write: true&lt;br/&gt;
      Caching: KEYS_ONLY&lt;br/&gt;
      Bloom Filter FP chance: default&lt;br/&gt;
      Built indexes: []&lt;br/&gt;
      Compaction Strategy: org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&lt;br/&gt;
      Compression Options:&lt;br/&gt;
        sstable_compression: org.apache.cassandra.io.compress.SnappyCompressor&lt;/p&gt;

&lt;p&gt;All rows have a TTL of 30 days and a gc_grace=0 so it&apos;s possible that a small number of older columns would be removed during a compaction/scrub/upgradesstables step. However, the majority should still be kept as their TTL&apos;s have not expired yet.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 11.04 64-bit&lt;/p&gt;</environment>
        <key id="12600069">CASSANDRA-4462</key>
            <summary>upgradesstables strips active data from sstables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="mheffner">Mike Heffner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Jul 2012 21:23:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:30 +0000</updated>
                            <resolved>Fri, 27 Jul 2012 08:46:08 +0000</resolved>
                                        <fixVersion>1.0.11</fixVersion>
                    <fixVersion>1.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13422070" author="slebresne" created="Wed, 25 Jul 2012 07:49:06 +0000"  >&lt;p&gt;There is indeed an unfortunate typo in the code of upgradesstables that makes it purge every tombstone instead of purging none. Since we upgrade one sstable at a time, purging tombstone is a bug that will resurrect data.&lt;/p&gt;

&lt;p&gt;Attached patch to fix (which also fix a 2nd occurrence of the same problem but that 2nd one was introduce by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4456&quot; title=&quot;AssertionError in ColumnFamilyStore.getOverlappingSSTables() during repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4456&quot;&gt;&lt;del&gt;CASSANDRA-4456&lt;/del&gt;&lt;/a&gt; so wasn&apos;t released yet).&lt;/p&gt;</comment>
                            <comment id="13422186" author="mheffner" created="Wed, 25 Jul 2012 12:11:14 +0000"  >&lt;p&gt;Would that typo lead to the behavior we saw where non-tombstoned data would be removed from the sstable during an upgradesstables run?&lt;/p&gt;</comment>
                            <comment id="13423231" author="slebresne" created="Thu, 26 Jul 2012 16:59:16 +0000"  >&lt;p&gt;Best way to make sure would be to test with the patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;But since you have ttl, I would say that yes, there is a good chance that&apos;s related.&lt;/p&gt;</comment>
                            <comment id="13423249" author="mheffner" created="Thu, 26 Jul 2012 17:18:16 +0000"  >&lt;p&gt;Fair enough, though we are not quite equipped to test patch sets yet so it might take awhile.&lt;/p&gt;</comment>
                            <comment id="13423252" author="jbellis" created="Thu, 26 Jul 2012 17:19:44 +0000"  >&lt;p&gt;+1 on the basic fix, but I&apos;m not really convinced that GC_ALL and NO_GC are improvements since we don&apos;t really get any extra typesafety from it.  (Maybe switching to an enum for ALL, NONE, and CURRENT_TIME enum would be okay though?  But that&apos;s out of scope here.)&lt;/p&gt;</comment>
                            <comment id="13423749" author="slebresne" created="Fri, 27 Jul 2012 08:46:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not really convinced that GC_ALL and NO_GC are improvements since we don&apos;t really get any extra typesafety from it&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The goal is not really to gain type safety, but to avoid having to take the few seconds to think about which of MIN_VALUE or MAX_VALUE means to not GC anything or conversely to GC everything. At least I have a tendency of screwing that up as showed by this issue, and I think having more explicit and readable constant names might avoid that kind of mistake in the future (again, at least for me). Anyway, I&apos;ve committed as is, but if you really don&apos;t like, feel free to ninja edit it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12537812" name="4462.txt" size="2639" author="slebresne" created="Wed, 25 Jul 2012 07:49:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256178</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gw5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96638</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>