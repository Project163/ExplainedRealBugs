<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10381] NullPointerException in cqlsh paging through CF with static columns</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10381</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running select count( * ) from cqlsh with limit, the following NPE occurs:&lt;/p&gt;

&lt;p&gt;select count( * ) from tbl1 limit 50000 ; &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [SharedPool-Worker-4] 2015-09-16 14:49:43,480 QueryMessage.java:132 - Unexpected error during query
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
at org.apache.cassandra.service.pager.RangeSliceQueryPager.containsPreviousLast(RangeSliceQueryPager.java:99) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.service.pager.AbstractQueryPager.fetchPage(AbstractQueryPager.java:119) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.service.pager.RangeSliceQueryPager.fetchPage(RangeSliceQueryPager.java:37) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.cql3.statements.SelectStatement.pageCountQuery(SelectStatement.java:286) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:230) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:67) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:238) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at com.datastax.bdp.cassandra.cql3.DseQueryHandler$StatementExecution.execute(DseQueryHandler.java:291) ~[dse-4.7.2.jar:4.7.2]
at com.datastax.bdp.cassandra.cql3.DseQueryHandler$Operation.executeWithTiming(DseQueryHandler.java:223) ~[dse-4.7.2.jar:4.7.2]
at com.datastax.bdp.cassandra.cql3.DseQueryHandler$Operation.executeWithAuditLogging(DseQueryHandler.java:259) ~[dse-4.7.2.jar:4.7.2]
at com.datastax.bdp.cassandra.cql3.DseQueryHandler.process(DseQueryHandler.java:94) ~[dse-4.7.2.jar:4.7.2]
at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:119) ~[cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:439) [cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:335) [cassandra-all-2.1.8.621.jar:2.1.8.621]
at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_75]
at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [cassandra-all-2.1.8.621.jar:2.1.8.621]
at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [cassandra-all-2.1.8.621.jar:2.1.8.621]
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.7.0_75]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Table definition looks something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE tbl1 (
    field1 bigint,
    field2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    field3 timestamp,
    field4 map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;&amp;gt;,
    field5 text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
    field6 text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
    field7 text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;
    PRIMARY KEY (field1, field2, field3)
) WITH CLUSTERING ORDER BY (field2 ASC, field3 ASC)
    AND bloom_filter_fp_chance = 0.1
    AND caching = &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;keys&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ALL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;rows_per_partition&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;NONE&quot;&lt;/span&gt;}&apos;&lt;/span&gt;
    AND comment = &apos;&apos;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.LeveledCompactionStrategy&apos;&lt;/span&gt;}
    AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;&lt;/span&gt;}
   ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Following appears in debug log leading up to the error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG [SharedPool-Worker-1] 2015-09-17 15:32:06,484  AbstractQueryPager.java:95 - Fetched 101 live rows
DEBUG [SharedPool-Worker-1] 2015-09-17 15:32:06,484  AbstractQueryPager.java:133 - Remaining rows to page: 1
DEBUG [SharedPool-Worker-1] 2015-09-17 15:32:06,485  SelectStatement.java:285 - New maxLimit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; paged count query is 1
DEBUG [SharedPool-Worker-1] 2015-09-17 15:32:06,486  StorageProxy.java:1646 - Estimated result rows per range: 2586.375; requested rows: 2, ranges.size(): 762; concurrent range requests: 1
DEBUG [SharedPool-Worker-1] 2015-09-17 15:32:06,487  AbstractQueryPager.java:95 - Fetched 2 live rows
ERROR [SharedPool-Worker-1] 2015-09-17 15:32:06,487  QueryMessage.java:132 - Unexpected error during query
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m working on recreating to have a workable dataset.  When running cqlsh from remote node version 2.0.14, query returns successfully&lt;/p&gt;</description>
                <environment></environment>
        <key id="12895216">CASSANDRA-10381</key>
            <summary>NullPointerException in cqlsh paging through CF with static columns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="Michael Keeney">Michael Keeney</reporter>
                        <labels>
                            <label>cqlsh</label>
                            <label>nullpointerexception</label>
                            <label>range</label>
                    </labels>
                <created>Mon, 21 Sep 2015 18:51:40 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:55 +0000</updated>
                            <resolved>Tue, 20 Oct 2015 12:44:24 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14901557" author="philipthompson" created="Mon, 21 Sep 2015 22:41:59 +0000"  >&lt;p&gt;This seems like an NPE in CQL, not in cqlsh. I&apos;m confused by your last sentence. Are you saying when you run the 2.0.14 cqlsh against a 2.0.14 node, the problem does not appear? Or are you running the 2.0.14 cqlsh against a 2.1.8 node?&lt;/p&gt;</comment>
                            <comment id="14901573" author="philipthompson" created="Mon, 21 Sep 2015 22:50:49 +0000"  >&lt;p&gt;Okay, I believe the reason the 2.0.14 cqlsh works fine is because it is connecting via thrift, and this NPE is in cql3 server code. Which would explain why the 2.1.8 cqlsh sees the issue, as it uses the native python driver. I suspect the query will fail if you connect via any native driver.&lt;/p&gt;</comment>
                            <comment id="14901574" author="michael keeney" created="Mon, 21 Sep 2015 22:51:20 +0000"  >&lt;p&gt;The latter, when running 2.0.14 cqlsh against a 2.1.8 node.  Edit: just saw your comment. Makes sense thanks&lt;/p&gt;</comment>
                            <comment id="14908467" author="michael keeney" created="Fri, 25 Sep 2015 18:33:23 +0000"  >&lt;p&gt;Was unable to reproduce issue in lab, consulting with Benjamin&lt;/p&gt;</comment>
                            <comment id="14909888" author="blerer" created="Sun, 27 Sep 2015 20:44:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael.keeney&quot; class=&quot;user-hover&quot; rel=&quot;michael.keeney&quot;&gt;michael.keeney&lt;/a&gt; Thanks for trying to reproduce it. I will have a look at the code of 2.1.8 to try to understand the possible root cause for the &lt;tt&gt;NPE&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14939856" author="blerer" created="Thu, 1 Oct 2015 13:57:40 +0000"  >&lt;p&gt;I can reproduce the problem in 2.1 HEAD using the java driver with the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        session = cluster.connect();
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE IF NOT EXISTS test WITH REPLICATION = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;}&quot;&lt;/span&gt;);
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;USE test&quot;&lt;/span&gt;);
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;DROP TABLE IF EXISTS test&quot;&lt;/span&gt;);
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE IF NOT EXISTS test (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, primary key(a, b))&quot;&lt;/span&gt;);

        PreparedStatement pstmt = session.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE test SET c = ? WHERE a = ?&quot;&lt;/span&gt;);

        BatchStatement bstmt = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BatchStatement();

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i++)
            bstmt.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BoundStatement(pstmt).setInt(0, i).setInt(1, i));
        session.execute(bstmt);

        ResultSet rs = session.execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT count(*) FROM test&quot;&lt;/span&gt;).setFetchSize(2));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem appears when multiple partitions contains data only within the static columns. &lt;/p&gt;</comment>
                            <comment id="14942430" author="blerer" created="Sat, 3 Oct 2015 19:50:12 +0000"  >&lt;p&gt;The problem was coming from the fact that the code was not handling properly the case where the paging was occuring on a partition containing some values only for the static columns.&lt;/p&gt;

&lt;p&gt;The patch for &lt;tt&gt;2.1&lt;/tt&gt; and &lt;tt&gt;2.2&lt;/tt&gt; is &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:10381-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The patch for &lt;tt&gt;3.0&lt;/tt&gt; is &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:10381-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the unit test results for 2.1 are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-2.1-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the dtest results for 2.1 are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-2.1-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the unit test results for 2.2 are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-2.2-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the dtest results for 2.2 are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-2.2-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the unit test results for 3.0 are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-3.0-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the dtest results for 3.0 are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-3.0-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, master of paging, could you review?&lt;br/&gt;
I have some doubts for my approach for 3.0.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Michael+Keeney&quot; class=&quot;user-hover&quot; rel=&quot;Michael Keeney&quot;&gt;Michael Keeney&lt;/a&gt; I was not able to get a &lt;tt&gt;NPE&lt;/tt&gt; at exactly the same line as the one of the description. I could only manage to get it on the next line. I believe that problem is the one that I have found but it might be could to check if the dataset that has caused the &lt;tt&gt;NPE&lt;/tt&gt; has some partitions that contains some values only for the static columns.&lt;/p&gt;</comment>
                            <comment id="14943895" author="michael keeney" created="Mon, 5 Oct 2015 19:33:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; Is there a good way to query for this specific type of partition?&lt;/p&gt;</comment>
                            <comment id="14943910" author="blerer" created="Mon, 5 Oct 2015 19:44:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Michael+Keeney&quot; class=&quot;user-hover&quot; rel=&quot;Michael Keeney&quot;&gt;Michael Keeney&lt;/a&gt; not that I am aware of.&lt;br/&gt;
You will have to scan the entire table and check the static columns and the clustering keys. &lt;/p&gt;</comment>
                            <comment id="14953118" author="slebresne" created="Mon, 12 Oct 2015 13:32:08 +0000"  >&lt;p&gt;The 2.1 patch lgtm. On the 3.0 patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Can you update the comment on top of &lt;tt&gt;boolean includeLastKey = ...&lt;/tt&gt; (in &lt;tt&gt;RangeSliceQueryPager&lt;/tt&gt; to explain the new condition.&lt;/li&gt;
	&lt;li&gt;I don&apos;t think I understand why &lt;tt&gt;SinglePartitionParger&lt;/tt&gt; has to include a &lt;tt&gt;lastReturnedKey&lt;/tt&gt;? A &lt;tt&gt;SinglePartitionPager&lt;/tt&gt; applies to a single partition so we shouldn&apos;t need this. And if we do need this, can you provide a test for what problem this fixes (since as far as I can tell, the test you mention above doesn&apos;t use &lt;tt&gt;SinglePartitionPager&lt;/tt&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also, can you convert your test for this above to a dtest and open a pull request for its inclusion.&lt;/p&gt;</comment>
                            <comment id="14953197" author="blerer" created="Mon, 12 Oct 2015 14:55:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, can you convert your test for this above to a dtest and open a pull request for its inclusion.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The link to the DTest branch is in the &lt;tt&gt;Issue Links&lt;/tt&gt;. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t think I understand why SinglePartitionParger has to include a lastReturnedKey? A SinglePartitionPager applies to a single partition so we shouldn&apos;t need this. And if we do need this, can you provide a test for what problem this fixes (since as far as I can tell, the test you mention above doesn&apos;t use SinglePartitionPager).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, I forgot to explain that part of the patch.&lt;/p&gt;

&lt;p&gt;While investigating the issue, I found out that queries like &lt;tt&gt;SELECT * FROM test WHERE a IN (0, 1, 2, 3, 4)&lt;/tt&gt; were also not working properly.&lt;br/&gt;
In &lt;tt&gt;3.0&lt;/tt&gt; those queries lead me to &lt;tt&gt;SinglePartitionParger&lt;/tt&gt;. I included a &lt;tt&gt;lastReturnedKey&lt;/tt&gt; to be able to detect if we were done with the partition and should move to the next.&lt;br/&gt;
It seems to be working but I am not sure that it is the right way to fix the problem.&lt;/p&gt;
</comment>
                            <comment id="14953227" author="slebresne" created="Mon, 12 Oct 2015 15:44:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;I found out that queries like SELECT * FROM test WHERE a IN (0, 1, 2, 3, 4) were also not working properly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok. In theory, we shouldn&apos;t end up calling &lt;tt&gt;SinglePartitionPager.isPreviouslyReturnedPartition()&lt;/tt&gt; with another key than the one of the pager itself, and &lt;tt&gt;MultiPartitionPager&lt;/tt&gt; should theoretically handle that, but I think the underlying problem is that &lt;tt&gt;AbstractQueryPager&lt;/tt&gt; doesn&apos;t properly record if it&apos;s done with a given partition. We should probably fix that by changing &lt;tt&gt;AbstractQueryPager.PagerIterator.close()&lt;/tt&gt; slightly to&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Override
public void close()
{
    boolean partitionExhausted = !hasNext();
    super.close();
    // ...
    remainingInPartition = partitionExhausted ? 0 : counter.countedInCurrentPartition();
    exhausted = counted &amp;lt; pageLimits.count();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I suspect that&apos;s the cleaner way to fix the &lt;tt&gt;IN&lt;/tt&gt; problem. That said, there isn&apos;t any harm I suppose to check the key in &lt;tt&gt;SinglePartitionPager.isPreviouslyReturnedPartition()&lt;/tt&gt; for extra safety, but we don&apos;t need to add a &lt;tt&gt;lastReturnedKey&lt;/tt&gt; for that, we can just do:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;protected boolean isPreviouslyReturnedPartition(DecoratedKey key)
{
    return key.equals(command.partitionKey()) &amp;amp;&amp;amp; lastReturned != null;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14960762" author="blerer" created="Fri, 16 Oct 2015 14:14:24 +0000"  >&lt;p&gt;I have pushed a new commit with the suggested fixes &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:10381-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14960826" author="slebresne" created="Fri, 16 Oct 2015 14:52:59 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14960965" author="blerer" created="Fri, 16 Oct 2015 16:25:06 +0000"  >&lt;p&gt;The changes broke most of the paging tests.&lt;/p&gt;</comment>
                            <comment id="14963300" author="blerer" created="Mon, 19 Oct 2015 13:31:56 +0000"  >&lt;p&gt;The issue with the previous patch was that checking if the partition was exhausted by using &lt;tt&gt;hasNext&lt;/tt&gt; was not reliable. &lt;tt&gt;hasNext&lt;/tt&gt; returns false when the page size has been reached.&lt;br/&gt;
I pushed a new patch &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:10381-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The patch checks, in &lt;tt&gt;close&lt;/tt&gt;, if the last row returned was only containing static column data. If it is the case the partition is marked as exhausted.&lt;/p&gt;

&lt;p&gt;The unit tests results are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-3.0-testall/5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and the dtests results are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-3.0-dtest/5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  &lt;/p&gt;

&lt;p&gt;Unfortunatly, a lot of the upgrade tests failed with an HTTP:404  for cassandra-2.2. I will be waiting for another run.&lt;/p&gt;</comment>
                            <comment id="14963904" author="blerer" created="Mon, 19 Oct 2015 19:27:37 +0000"  >&lt;p&gt;The result for the DTests are &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10381-3.0-dtest/6/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14964886" author="slebresne" created="Tue, 20 Oct 2015 09:47:11 +0000"  >&lt;p&gt;Alright, +1.&lt;/p&gt;</comment>
                            <comment id="14965049" author="blerer" created="Tue, 20 Oct 2015 12:43:46 +0000"  >&lt;p&gt;Committed in 2.1 at 328916d1591be69f217f6519304651d3757d9e1d. Merged into 2.2, 3.0 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12909431">CASSANDRA-10630</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311024" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>External issue ID</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19913</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ld13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>