<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4492] HintsColumnFamily compactions hang when using multithreaded compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4492</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Running into an issue on a 6 node ring running 1.0.11 where HintsColumnFamily compactions often hang indefinitely when using multithreaded compaction. Nothing of note in the logs. In some cases, the compaction hangs before a tmp sstable is even created.&lt;/p&gt;

&lt;p&gt;I&apos;ve wiped out every hints sstable and restarted several times. The issue always comes back rather quickly and predictably. The compactions sometimes complete if the hint sstables are very small. Disabling multithreaded compaction stops this issue from occurring.&lt;/p&gt;

&lt;p&gt;Compactions of all other CFs seem to work just fine.&lt;/p&gt;

&lt;p&gt;This ring was upgraded from 1.0.7. I didn&apos;t keep any hints from the upgrade.&lt;/p&gt;

&lt;p&gt;I should note that the ring gets a huge amount of writes, and as a result the HintedHandoff rows get be quite wide. I didn&apos;t see any large-row compaction notices when the compaction was hanging (perhaps the bug was triggered by incremental compaction?). After disabling multithreaded compaction, several of the rows that were successfully compacted were over 1GB.&lt;/p&gt;

&lt;p&gt;Here is the output I see from compactionstats where a compaction has hung. The &apos;bytes compacted&apos; column never changes.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;pending tasks: 1
          compaction type        keyspace   column family bytes compacted     bytes total  progress
               Compaction          systemHintsColumnFamily          268082       464784758     0.06%
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The hung thread stack is as follows: (full jstack attached, as well)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;CompactionExecutor:37&quot;&lt;/span&gt; daemon prio=10 tid=0x00000000063df800 nid=0x49d9 waiting on condition [0x00007eb8c6ffa000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000050f2e0e58&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)
        at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)
        at org.apache.cassandra.db.compaction.ParallelCompactionIterable$Deserializer.computeNext(ParallelCompactionIterable.java:329)
        at org.apache.cassandra.db.compaction.ParallelCompactionIterable$Deserializer.computeNext(ParallelCompactionIterable.java:281)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)
        at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:147)
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:126)
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:100)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)
        at org.apache.cassandra.db.compaction.ParallelCompactionIterable$Unwrapper.computeNext(ParallelCompactionIterable.java:101)
        at org.apache.cassandra.db.compaction.ParallelCompactionIterable$Unwrapper.computeNext(ParallelCompactionIterable.java:88)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)
        at com.google.common.collect.Iterators$7.computeNext(Iterators.java:614)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:141)
        at org.apache.cassandra.db.compaction.CompactionManager$7.call(CompactionManager.java:395)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12601486">CASSANDRA-4492</key>
            <summary>HintsColumnFamily compactions hang when using multithreaded compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlyeks">Carl Yeksigian</assignee>
                                    <reporter username="alienth">Jason Harvey</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Aug 2012 04:12:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:30 +0000</updated>
                            <resolved>Tue, 18 Dec 2012 21:15:52 +0000</resolved>
                                        <fixVersion>1.1.9</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13428854" author="brandon.williams" created="Sun, 5 Aug 2012 14:02:41 +0000"  >&lt;p&gt;MT compaction is unfortunately a) not highly used and b) known to be suspect to issues.  The best course of action right now is to just not use it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13477221" author="tjake" created="Tue, 16 Oct 2012 18:01:57 +0000"  >&lt;p&gt;I hit this recently as well.&lt;/p&gt;

&lt;p&gt;Though mine I was able to reproduce.  If you call truncate while a compaction is currently going on it hangs both the truncate and the parallel compaction iterator.  &lt;/p&gt;
</comment>
                            <comment id="13477500" author="mkjellman" created="Wed, 17 Oct 2012 00:45:37 +0000"  >&lt;p&gt;hit this as well on both 1.1.5 and 1.1.6. Turned multhreaded compaction off and HintsColumnFamily finished very quickly. Nothing in the logs of interest and not reproducible.&lt;/p&gt;</comment>
                            <comment id="13506806" author="tvachon" created="Thu, 29 Nov 2012 21:16:07 +0000"  >&lt;p&gt;This actually is severe.  Since they hang, it blocks all schema changes.&lt;/p&gt;</comment>
                            <comment id="13529111" author="jbellis" created="Tue, 11 Dec 2012 16:48:59 +0000"  >&lt;p&gt;If you can give us a set of sstables that reliably cause the hang (snapshot before compaction option should be useful here) then we can troubleshoot.  Nothing is obviously wrong from just eyeballing things.&lt;/p&gt;</comment>
                            <comment id="13529123" author="jbellis" created="Tue, 11 Dec 2012 17:03:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;If you call truncate while a compaction is currently going on it hangs both the truncate and the parallel compaction iterator. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Truncate took some big changes for 1.2 (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4096&quot; title=&quot;mlockall() returned code is ignored w/o assertions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4096&quot;&gt;&lt;del&gt;CASSANDRA-4096&lt;/del&gt;&lt;/a&gt;) so I doubt this is still the case.  (If it is, I&apos;m not sure it&apos;s related to compaction alone causing the hang.)&lt;/p&gt;</comment>
                            <comment id="13529242" author="tjake" created="Tue, 11 Dec 2012 19:26:00 +0000"  >&lt;p&gt;Using 1.2 with LeveledCompaction I have not hit any deadlocks&lt;/p&gt;</comment>
                            <comment id="13529251" author="tvachon" created="Tue, 11 Dec 2012 19:34:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; no I can&apos;t.  We turned off MT compaction and they have been compacted away.&lt;/p&gt;</comment>
                            <comment id="13529271" author="jbellis" created="Tue, 11 Dec 2012 19:50:26 +0000"  >&lt;p&gt;Does your workload also involve truncates &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tvachon&quot; class=&quot;user-hover&quot; rel=&quot;tvachon&quot;&gt;tvachon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman&quot; class=&quot;user-hover&quot; rel=&quot;mkjellman&quot;&gt;mkjellman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alienth&quot; class=&quot;user-hover&quot; rel=&quot;alienth&quot;&gt;alienth&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13529284" author="tvachon" created="Tue, 11 Dec 2012 20:01:49 +0000"  >&lt;p&gt;No, update heavy though &lt;/p&gt;</comment>
                            <comment id="13529288" author="mkjellman" created="Tue, 11 Dec 2012 20:05:05 +0000"  >&lt;p&gt;no, minimal (if any) deletes.&lt;/p&gt;</comment>
                            <comment id="13534970" author="tjake" created="Tue, 18 Dec 2012 15:34:06 +0000"  >&lt;p&gt;This is still happening:&lt;/p&gt;

&lt;p&gt;Looking at the code it seems there are two places where HintedHandoffManager calls a user defined compact() for all sstables.&lt;/p&gt;

&lt;p&gt;Multithreaded compaction would allow this to race since I see no check to avoid multiple calls to user defined compaction for the same sstables&lt;/p&gt;
</comment>
                            <comment id="13534973" author="tvachon" created="Tue, 18 Dec 2012 15:35:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking at the code it seems there are two places where HintedHandoffManager calls a user defined compact() for all sstable&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well that would explain why everytime I restart and I get hints, I get every sstable compacted&lt;/p&gt;</comment>
                            <comment id="13534978" author="jbellis" created="Tue, 18 Dec 2012 15:40:26 +0000"  >&lt;p&gt;Jake: I think you&apos;re missing how markCompacting works in submitUserDefined&lt;/p&gt;</comment>
                            <comment id="13534985" author="tjake" created="Tue, 18 Dec 2012 15:48:57 +0000"  >&lt;p&gt;Ah, I needed to scroll down more.  Well I can confirm this is sill happening in 1.2 but only for hints CF  &lt;/p&gt;</comment>
                            <comment id="13535169" author="carlyeks" created="Tue, 18 Dec 2012 19:06:00 +0000"  >&lt;p&gt;Here is what I think is happening (with help from Jake):&lt;/p&gt;

&lt;p&gt;For simplicity, we are compacting two SSTables, sstable-1 and sstable-2.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Read a row from sstable-1, which is empty&lt;/li&gt;
	&lt;li&gt;We don&apos;t call close on the LazilyCompactedRow because only Write or Update calls close; this means that the NotifyingSSTableIdentityIterator never signals the condition.&lt;/li&gt;
	&lt;li&gt;Read a row from sstable-2, which is not empty&lt;/li&gt;
	&lt;li&gt;Call hasNext() in CompactionTask&apos;s runWith() on the iterator for sstable-1, which was never triggered&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This means that we are now deadlocked in ParallelCompactionIterable.Deserializer&apos;s as waiting for the signal and waiting for another row. We never return because we have no way of closing sstable-1&apos;s NotifyingSSTableIdentityIterator, and moving to the next row.&lt;/p&gt;</comment>
                            <comment id="13535184" author="carlyeks" created="Tue, 18 Dec 2012 19:22:07 +0000"  >&lt;p&gt;This patch add the Closeable interface to AbstractCompactedRow, and calls row.close() if the row is empty.&lt;/p&gt;</comment>
                            <comment id="13535332" author="jbellis" created="Tue, 18 Dec 2012 21:15:52 +0000"  >&lt;p&gt;I think you&apos;ve nailed it.  Committed to 1.1 and 1.2.0.  Nice work!&lt;/p&gt;</comment>
                            <comment id="13535469" author="carlyeks" created="Tue, 18 Dec 2012 23:49:24 +0000"  >&lt;p&gt;One more place that wasn&apos;t handling the close on empty - was hitting this case as well.&lt;/p&gt;

&lt;p&gt;I&apos;ve only included the additional patch.&lt;/p&gt;</comment>
                            <comment id="13535595" author="jbellis" created="Wed, 19 Dec 2012 02:48:14 +0000"  >&lt;p&gt;fixed formatting and committed&lt;/p&gt;</comment>
                            <comment id="13535699" author="mkjellman" created="Wed, 19 Dec 2012 06:10:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; thanks for your work on this&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12607985">CASSANDRA-4673</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12561612" name="4492-patch2.patch" size="832" author="carlyeks" created="Wed, 19 Dec 2012 00:26:00 +0000"/>
                            <attachment id="12561608" name="4492-patch2.patch" size="823" author="carlyeks" created="Tue, 18 Dec 2012 23:49:24 +0000"/>
                            <attachment id="12561544" name="4492.patch" size="2778" author="carlyeks" created="Tue, 18 Dec 2012 19:21:03 +0000"/>
                            <attachment id="12539176" name="jstack.txt" size="538350" author="alienth" created="Sun, 5 Aug 2012 04:59:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249088</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0a4on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57032</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>