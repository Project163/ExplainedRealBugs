<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:30:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18736] Streaming exception race creates corrupt transaction log files that prevent restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18736</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;On restart, Cassandra logs this message and terminates.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 2023-07-17T17:17:22,931 [main] org.apache.cassandra.db.lifecycle.LogTransaction:561 - Unexpected disk state: failed to read transaction log [nb_txn_stream_39d5f6b0-fb81-11ed-8f46-e97b3f61511e.log in /datadir1/keyspace/table-c9527530a0d611e8813f034699fc9043]
Files and contents follow:
/datadir1/keyspace/table-c9527530a0d611e8813f034699fc9043/nb_txn_stream_39d5f6b0-fb81-11ed-8f46-e97b3f61511e.log
        ABORT:[,0,0][737437348]
                ***This record should have been the last one in all replicas
        ADD:[/datadir1/keyspace/table-c9527530a0d611e8813f034699fc9043/nb-284490-big-,0,8][2493503833]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The root cause is a race during streaming exception handling.&lt;/p&gt;

&lt;p&gt;Although concurrent modification of to the &lt;tt&gt;LogTransaction&lt;/tt&gt; was added for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16225&quot; title=&quot;Followup CASSANDRA-14554&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16225&quot;&gt;&lt;del&gt;CASSANDRA-16225&lt;/del&gt;&lt;/a&gt;, there is nothing to prevent usage after the transaction is completed (committed/aborted) once it has been processed by &lt;tt&gt;TransactionTidier&lt;/tt&gt; (after the last reference is released). Before the transaction is tidied, the &lt;tt&gt;LogFile&lt;/tt&gt; keeps a list of records that are checked for completion before adding new entries. In &lt;tt&gt;TransactionTidier&lt;/tt&gt; &lt;tt&gt;LogFile.records&lt;/tt&gt; are cleared as no longer needed, however the LogTransaction/LogFile is still accessible to the stream.&lt;/p&gt;

&lt;p&gt;The changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17273&quot; title=&quot;Lazy transaction log replica creation allows incorrect replica content divergence during compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17273&quot;&gt;&lt;del&gt;CASSANDRA-17273&lt;/del&gt;&lt;/a&gt; added a parallel set of &lt;tt&gt;onDiskRecords&lt;/tt&gt; that could be used to reliably recreate the transaction log at any new datadirs the same as the existing&lt;br/&gt;
datadirs - regardless of the effect of &lt;tt&gt;LogTransaction.untrackNew/LogFile.remove&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;If a streaming exception causes the LogTransaction to be aborted and tidied just before &lt;tt&gt;SimpleSSTableMultiWriter&lt;/tt&gt; calls trackNew to add a new sstable. At the time of the call, the &lt;tt&gt;LogFile&lt;/tt&gt; will not contain any &lt;tt&gt;LogReplicas&lt;/tt&gt;,&lt;br/&gt;
&lt;tt&gt;LogFile.records&lt;/tt&gt; will be empty, and &lt;tt&gt;LogFile.onDiskRecords&lt;/tt&gt; will contain an &lt;tt&gt;ABORT&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;When &lt;tt&gt;LogTransaction.trackNew/LogFile.add&lt;/tt&gt; is called, the check for completed transaction fails as records is empty, there are no replicas on the datadir, so &lt;tt&gt;maybeCreateReplicas&lt;/tt&gt; creates a new txnlog file replica containing ABORT, then&lt;br/&gt;
appends an ADD record.&lt;/p&gt;

&lt;p&gt;The LogFile has already been tidied after the abort so the txnlog file is not removed and sits on disk until a restart, causing the faiulre.&lt;/p&gt;

&lt;p&gt;There is a related exception caused with a different interleaving of aborts, after an sstable is added, however this is just a nuisance in the logs as the LogRelica is already created with an &lt;tt&gt;ADD&lt;/tt&gt; record first.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: [ADD:[/datadir1/keyspace/table/nb-23314378-big-,0,8][1869379820]] is not tracked by 55be35b0-35d1-11ee-865d-8b1e3c48ca06
        at org.apache.cassandra.db.lifecycle.LogFile.remove(LogFile.java:388)
        at org.apache.cassandra.db.lifecycle.LogTransaction.untrackNew(LogTransaction.java:158)
        at org.apache.cassandra.db.lifecycle.LifecycleTransaction.untrackNew(LifecycleTransaction.java:577)
        at org.apache.cassandra.db.streaming.CassandraStreamReceiver$1.untrackNew(CassandraStreamReceiver.java:149)
        at org.apache.cassandra.io.sstable.SimpleSSTableMultiWriter.abort(SimpleSSTableMultiWriter.java:95)
        at org.apache.cassandra.io.sstable.format.RangeAwareSSTableWriter.abort(RangeAwareSSTableWriter.java:191)
        at org.apache.cassandra.db.streaming.CassandraCompressedStreamReader.read(CassandraCompressedStreamReader.java:115)
        at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:85)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:53)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:38)
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:53)
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:172)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13546581">CASSANDRA-18736</key>
            <summary>Streaming exception race creates corrupt transaction log files that prevent restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jonmeredith">Jon Meredith</assignee>
                                    <reporter username="jonmeredith">Jon Meredith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Aug 2023 19:59:55 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:45 +0000</updated>
                            <resolved>Thu, 25 Apr 2024 20:18:28 +0000</resolved>
                                        <fixVersion>4.0.13</fixVersion>
                    <fixVersion>4.1.5</fixVersion>
                    <fixVersion>5.0-rc1</fixVersion>
                                    <component>Consistency/Streaming</component>
                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9000">2.5h</timespent>
                                <comments>
                            <comment id="17826769" author="edimitrova" created="Wed, 13 Mar 2024 15:15:55 +0000"  >&lt;p&gt;This ticket hasn&apos;t been updated for a while, is anything blocking it?&#160;&lt;/p&gt;</comment>
                            <comment id="17837291" author="edimitrova" created="Mon, 15 Apr 2024 14:14:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonmeredith&quot; class=&quot;user-hover&quot; rel=&quot;jonmeredith&quot;&gt;jonmeredith&lt;/a&gt; , the fix versions mention 4.0, but I do not see a branch for it. Do you plan to apply it on that branch too?&lt;/p&gt;</comment>
                            <comment id="17837333" author="jonmeredith" created="Mon, 15 Apr 2024 15:58:35 +0000"  >&lt;p&gt;I&apos;m double-checking at the moment. I think the bug became an issue after some restructuring for the simulator, but need to convince myself of that.&#160;&lt;/p&gt;

&lt;p&gt;Also, I&apos;ve deleted the original branches/PRs as I accidentally referenced ones from a different fix. I&apos;ll post new ones in a day or so.&lt;/p&gt;</comment>
                            <comment id="17837338" author="edimitrova" created="Mon, 15 Apr 2024 16:10:18 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonmeredith&quot; class=&quot;user-hover&quot; rel=&quot;jonmeredith&quot;&gt;jonmeredith&lt;/a&gt;, I haven&apos;t tried myself, but I have people telling me they reproduced the issue on 4.0.&lt;/p&gt;

&lt;p&gt;I can try to ask for more details if that will help you.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17837487" author="jonmeredith" created="Tue, 16 Apr 2024 02:48:51 +0000"  >&lt;p&gt;As expected, the (modified) tests fail on 4.0 so I&apos;ve backported there too. I&apos;ll try and post test runs tomorrow but wanted to share the changes in case anybody was waiting on it.&lt;/p&gt;

&lt;p&gt;PRs&lt;br/&gt;
Trunk &lt;a href=&quot;https://github.com/apache/cassandra/pull/3250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3250&lt;/a&gt;&lt;br/&gt;
5.0 &lt;a href=&quot;https://github.com/apache/cassandra/pull/3251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3251&lt;/a&gt;&lt;br/&gt;
4.1 &lt;a href=&quot;https://github.com/apache/cassandra/pull/3252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3252&lt;/a&gt;&lt;br/&gt;
4.0 &lt;a href=&quot;https://github.com/apache/cassandra/pull/3253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3253&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17838787" author="maedhroz" created="Thu, 18 Apr 2024 20:29:19 +0000"  >&lt;p&gt;I left a few nits in the 4.0 PR, but also approved all 4 PRs.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17840897" author="jonmeredith" created="Thu, 25 Apr 2024 17:56:37 +0000"  >&lt;p&gt;Starting commit. I believe all of the test failures are known flakes or unrelated issues. This patch has been running in production for me for many months without issue so I have high confidence in it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13068444" name="4.0-ci_summary.html" size="16246" author="jonmeredith" created="Thu, 25 Apr 2024 17:57:39 +0000"/>
                            <attachment id="13068445" name="4.1-ci_summary.html" size="7951" author="jonmeredith" created="Thu, 25 Apr 2024 17:57:39 +0000"/>
                            <attachment id="13068446" name="5.0-ci_summary.html" size="43075" author="jonmeredith" created="Thu, 25 Apr 2024 17:57:39 +0000"/>
                            <attachment id="13068447" name="trunk-ci_summary.html" size="3323" author="jonmeredith" created="Thu, 25 Apr 2024 17:57:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jonmeredith]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12992" cascade-level="1"><![CDATA[Process Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jo0w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt; &lt;a href=&quot;https://github.com/apache/cassandra/commit/9157d98e4cc5c00d74cef6128c16659ff43f3585&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/9157d98e4cc5c00d74cef6128c16659ff43f3585&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Added StreamDisconnectedWhileReceivingTest&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>