<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:24:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3272] READ Operation with CL=EACH_QUORUM succeed when a DC is down (RF=3)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3272</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&quot;READ EACH_QUORUM: 	Returns the record with the most recent timestamp once a quorum of replicas in each data center of the cluster has responded.&quot;&lt;/p&gt;

&lt;p&gt;In other words, if a DC is down and the QUORUM could not be reached on that DC, read should fail.&lt;/p&gt;

&lt;p&gt;test case:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Cassandra version 0.8.6:&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2011-09-28 22:26:24,297 StorageService.java (line 371) Cassandra version: 0.8.6&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;6-node cluster with 2 DC and 3 node each. RF=3 in each DC:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;default@Keyspace3&amp;#93;&lt;/span&gt; describe keyspace;&lt;br/&gt;
Keyspace: Keyspace3:&lt;br/&gt;
Replication Strategy: org.apache.cassandra.locator.NetworkTopologyStrategy&lt;br/&gt;
Durable Writes: true&lt;br/&gt;
Options: &lt;span class=&quot;error&quot;&gt;&amp;#91;DC2:3, DC1:3&amp;#93;&lt;/span&gt;&lt;br/&gt;
Column Families:&lt;br/&gt;
ColumnFamily: test&lt;br/&gt;
Key Validation Class: org.apache.cassandra.db.marshal.BytesType&lt;br/&gt;
Default column value validator: org.apache.cassandra.db.marshal.BytesType&lt;br/&gt;
Columns sorted by: org.apache.cassandra.db.marshal.BytesType&lt;br/&gt;
Row cache size / save period in seconds: 0.0/0&lt;br/&gt;
Key cache size / save period in seconds: 200000.0/14400&lt;br/&gt;
Memtable thresholds: 1.0875/1440/232 (millions of ops/minutes/MB)&lt;br/&gt;
GC grace seconds: 864000&lt;br/&gt;
Compaction min/max thresholds: 4/32&lt;br/&gt;
Read repair chance: 1.0&lt;br/&gt;
Replicate on write: true&lt;br/&gt;
Built indexes: []&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;all nodes are up, insert a row:&lt;/p&gt;

&lt;p&gt;$ nodetool -h localhost ring&lt;br/&gt;
Address DC Rack Status State Load Owns Token&lt;br/&gt;
141784319550391026443072753096570088106&lt;br/&gt;
10.34.79.179 DC1 RAC1 Up Normal 11.13 KB 16.67% 0&lt;br/&gt;
10.34.70.163 DC2 RAC1 Up Normal 11.14 KB 16.67% 28356863910078205288614550619314017621&lt;br/&gt;
10.35.81.147 DC1 RAC1 Up Normal 11.14 KB 16.67% 56713727820156410577229101238628035242&lt;br/&gt;
10.84.233.170 DC2 RAC1 Up Normal 11.14 KB 16.67% 85070591730234615865843651857942052864&lt;br/&gt;
10.195.201.236 DC1 RAC1 Up Normal 11.14 KB 16.67% 113427455640312821154458202477256070485&lt;br/&gt;
10.118.147.73 DC2 RAC1 Up Normal 11.14 KB 16.67% 141784319550391026443072753096570088106&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;insert a value&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;default@Keyspace3&amp;#93;&lt;/span&gt; set test&lt;span class=&quot;error&quot;&gt;&amp;#91;utf8(&amp;#39;test-key-1&amp;#39;)&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;utf8(&amp;#39;test-col&amp;#39;)&amp;#93;&lt;/span&gt;=utf8(&apos;test-value&apos;);&lt;br/&gt;
Value inserted.&lt;/p&gt;

&lt;p&gt;sanity check (cli connects to a node in DC1) :&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;default@Keyspace3&amp;#93;&lt;/span&gt; consistencylevel as EACH_QUORUM;                                  &lt;br/&gt;
Consistency level is set to &apos;EACH_QUORUM&apos;.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;default@Keyspace3&amp;#93;&lt;/span&gt; get test&lt;span class=&quot;error&quot;&gt;&amp;#91;utf8(&amp;#39;test-key-1&amp;#39;)&amp;#93;&lt;/span&gt;;   &lt;br/&gt;
=&amp;gt; (column=746573742d636f6c, value=test-value, timestamp=1317249361722000)&lt;br/&gt;
Returned 1 results&lt;/p&gt;

&lt;p&gt;shut down DC2:&lt;br/&gt;
$ nodetool -h localhost ring&lt;br/&gt;
Address         DC          Rack        Status State   Load            Owns    Token                                       &lt;br/&gt;
                                                                               141784319550391026443072753096570088106     &lt;br/&gt;
10.34.79.179    DC1         RAC1        Up     Normal  51.86 KB        16.67%  0                                           &lt;br/&gt;
10.34.70.163    DC2         RAC1        Down   Normal  51.88 KB        16.67%  28356863910078205288614550619314017621      &lt;br/&gt;
10.35.81.147    DC1         RAC1        Up     Normal  47.5 KB         16.67%  56713727820156410577229101238628035242      &lt;br/&gt;
10.84.233.170   DC2         RAC1        Down   Normal  51.88 KB        16.67%  85070591730234615865843651857942052864      &lt;br/&gt;
10.195.201.236  DC1         RAC1        Up     Normal  47.5 KB         16.67%  113427455640312821154458202477256070485     &lt;br/&gt;
10.118.147.73   DC2         RAC1        Down   Normal  51.88 KB        16.67%  141784319550391026443072753096570088106  &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;default@Keyspace3&amp;#93;&lt;/span&gt; get test&lt;span class=&quot;error&quot;&gt;&amp;#91;utf8(&amp;#39;test-key-1&amp;#39;)&amp;#93;&lt;/span&gt;;   &lt;br/&gt;
=&amp;gt; (column=746573742d636f6c, value=746573742d76616c7565, timestamp=1317249361722000)&lt;br/&gt;
Returned 1 results.&lt;/p&gt;

&lt;p&gt;tried with pycassaShell:&lt;br/&gt;
&amp;gt;&amp;gt;&amp;gt; col_fam.get(&apos;test-key-1&apos;,read_consistency_level=pycassa.ConsistencyLevel.EACH_QUORUM)&lt;br/&gt;
OrderedDict(&lt;span class=&quot;error&quot;&gt;&amp;#91;(&amp;#39;test-col&amp;#39;, &amp;#39;test-value&amp;#39;)&amp;#93;&lt;/span&gt;)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525118">CASSANDRA-3272</key>
            <summary>READ Operation with CL=EACH_QUORUM succeed when a DC is down (RF=3)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="cywjackson">Jackson Chung</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Sep 2011 23:25:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:50 +0000</updated>
                            <resolved>Tue, 18 Oct 2011 14:06:08 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13116917" author="jbellis" created="Thu, 29 Sep 2011 00:39:50 +0000"  >&lt;p&gt;Why are you using EACH_QUORUM?&lt;/p&gt;</comment>
                            <comment id="13116918" author="jbellis" created="Thu, 29 Sep 2011 00:40:13 +0000"  >&lt;p&gt;(I ask because I&apos;ve never seen it be the &quot;right&quot; CL yet.)&lt;/p&gt;</comment>
                            <comment id="13116925" author="brandon.williams" created="Thu, 29 Sep 2011 00:52:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;In other words, if a DC is down and the QUORUM could not be reached on that DC, read should fail.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can&apos;t think of any reason someone would actually want to do EACH_QUORUM on a read, when LOCAL_QUORUM would be sufficient if the write was done at EACH_QUORUM.  &lt;/p&gt;</comment>
                            <comment id="13116945" author="cywjackson" created="Thu, 29 Sep 2011 01:41:48 +0000"  >&lt;p&gt;&quot;Why are you using EACH_QUORUM?&quot;&lt;br/&gt;
 &amp;#8211; no particular reason other than testing.&lt;/p&gt;

&lt;p&gt;&quot;I can&apos;t think of any reason someone would actually want to do EACH_QUORUM on a read, when LOCAL_QUORUM would be sufficient if the write was done at EACH_QUORUM. &quot;&lt;br/&gt;
 &amp;#8211; would it make sense to make such consistency level as an &quot;invalid to use&quot; for READ then?&lt;/p&gt;

&lt;p&gt;What if write (update, say add a new column/value to the key) is done via LOCAL_QUORUM to DC1 but DC2 were down. &lt;br/&gt;
anti-entropy repair wasn&apos;t done&lt;br/&gt;
stop DC1 (for some reason this step is important)&lt;br/&gt;
now bring DC2 back up (assume HH is off)&lt;br/&gt;
read LQ from DC2.. &lt;br/&gt;
you get an outdated result. &lt;/p&gt;

&lt;p&gt;at least i think with EACH_QUORUM on a read, you should get an consistent result if 2 nodes replicas agreed on each DC (in the example where RF=3 in each DC)&lt;/p&gt;

&lt;p&gt;(and you should get an UAE in the above example)&lt;/p&gt;</comment>
                            <comment id="13126822" author="jbellis" created="Thu, 13 Oct 2011 19:12:02 +0000"  >&lt;p&gt;currently EACH_QUORUM silently does LOCAL_QUORUM instead. Patch attached to raise an error saying EACH_QUORUM is only supported for writes.&lt;/p&gt;</comment>
                            <comment id="13127361" author="slebresne" created="Fri, 14 Oct 2011 08:28:59 +0000"  >&lt;p&gt;Shouldn&apos;t we move the validation up. We already have a validateConsistencyLevel in ThriftValidation for instance, we could just add a flag to if it&apos;s a write or read operation and throw the right exception there. If only for consistency, but I think it&apos;s nice to keep validating the queries upfront so we don&apos;t have to later anyway.&lt;/p&gt;

&lt;p&gt;Which btw make me see that this validateConsistencyLevel is not called by CQL (which thus don&apos;t do the right check this function already does I suppose, or duplicate it). It would be worth checking if that&apos;s the only place where CQL is more loose than thrift in validating the query (and maybe we could refactor a bit the validation code so it&apos;s easier to apply it to both thrift and CQL).&lt;/p&gt;</comment>
                            <comment id="13127906" author="jbellis" created="Fri, 14 Oct 2011 22:02:15 +0000"  >&lt;p&gt;v2 attached&lt;/p&gt;</comment>
                            <comment id="13129646" author="slebresne" created="Tue, 18 Oct 2011 10:34:05 +0000"  >&lt;p&gt;+1 with the only nitpick that validateStrategyForCL could probably be more accurately (though less concisely) named validateStrategyForMultiDataCenterCL since it don&apos;t really use the consistency level excepted for the exception message.&lt;/p&gt;</comment>
                            <comment id="13129748" author="jbellis" created="Tue, 18 Oct 2011 14:06:08 +0000"  >&lt;p&gt;renamed to requireNetworkTopologyStrategy and committed&lt;/p&gt;</comment>
                            <comment id="13129798" author="hudson" created="Tue, 18 Oct 2011 15:26:21 +0000"  >&lt;p&gt;Integrated in Cassandra #1160 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/1160/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/1160/&lt;/a&gt;)&lt;br/&gt;
    EACH_QUORUM is only supported for writes&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3272&quot; title=&quot;READ Operation with CL=EACH_QUORUM succeed when a DC is down (RF=3)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3272&quot;&gt;&lt;del&gt;CASSANDRA-3272&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1185669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1185669&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/NEWS.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/cql/QueryProcessor.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/thrift/CassandraServer.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/thrift/RequestType.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/thrift/ThriftValidation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12499103" name="3272-v2.txt" size="7586" author="jbellis" created="Fri, 14 Oct 2011 22:02:15 +0000"/>
                            <attachment id="12498911" name="3272.txt" size="2986" author="jbellis" created="Thu, 13 Oct 2011 19:12:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37574</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ghwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94330</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>