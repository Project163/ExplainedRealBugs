<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16685] Flaky ActiveRepairServiceTest.testRejectWhenPoolFullStrategy</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16685</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Flaky &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.0/50/testReport/junit/org.apache.cassandra.service/ActiveRepairServiceTest/testRejectWhenPoolFullStrategy_compression/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ActiveRepairServiceTest.testRejectWhenPoolFullStrategy&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error Message

Task java.util.concurrent.FutureTask@63553e9f[Not completed, task = java.util.concurrent.Executors$RunnableAdapter@52cb52bd[Wrapped task = org.apache.cassandra.service.ActiveRepairServiceTest$Task@1d1c37d5]] rejected from org.apache.cassandra.concurrent.JMXEnabledThreadPoolExecutor@218df7d6[Running, pool size = 2, active threads = 2, queued tasks = 0, completed tasks = 0]

Stacktrace

java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@63553e9f[Not completed, task = java.util.concurrent.Executors$RunnableAdapter@52cb52bd[Wrapped task = org.apache.cassandra.service.ActiveRepairServiceTest$Task@1d1c37d5]] rejected from org.apache.cassandra.concurrent.JMXEnabledThreadPoolExecutor@218df7d6[Running, pool size = 2, active threads = 2, queued tasks = 0, completed tasks = 0]
	at java.base/java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2055)
	at java.base/java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:825)
	at java.base/java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1355)
	at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor.execute(DebuggableThreadPoolExecutor.java:176)
	at java.base/java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:118)
	at org.apache.cassandra.service.ActiveRepairServiceTest.testRejectWhenPoolFullStrategy(ActiveRepairServiceTest.java:380)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)

Standard Output

INFO  [main] 2021-05-18 22:04:31,694 YamlConfigurationLoader.java:93 - Configuration location: file:////home/cassandra/cassandra/build/test/cassandra.compressed.yaml
DEBUG [main] 2021-05-18 22:04:31,698 YamlConfigurationLoader.java:112 - Loading settings from file:////home/cassandra/cassandra/build/test/cassandra.compressed.yaml
DEBUG [main] 2021-05-18 22:04:31,807 InternalLoggerFactory.java:63 - Using SLF4J as the default logging framework
DEBUG [main] 2021-05-18 22:04:31,827 PlatformDependent0
...[truncated 95289 chars]...
andra/build/test/cassandra/data/system/local-7ad54392bcdd35a684174e047860b377/nb_txn_flush_08e70270-b825-11eb-a393-871312b17b94.log 
DEBUG [MemtableFlushWriter:1] 2021-05-18 22:04:36,792 ColumnFamilyStore.java:1197 - Flushed to [BigTableReader(path=&apos;/home/cassandra/cassandra/build/test/cassandra/data/system/local-7ad54392bcdd35a684174e047860b377/nb-15-big-Data.db&apos;)] (1 sstables, 4.944KiB), biggest 4.944KiB, smallest 4.944KiB
DEBUG [main] 2021-05-18 22:04:36,795 StorageService.java:1619 - NORMAL
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13379724">CASSANDRA-16685</key>
            <summary>Flaky ActiveRepairServiceTest.testRejectWhenPoolFullStrategy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bereng">Berenguer Blasi</assignee>
                                    <reporter username="bereng">Berenguer Blasi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 May 2021 09:39:17 +0000</created>
                <updated>Fri, 27 May 2022 19:25:22 +0000</updated>
                            <resolved>Fri, 11 Jun 2021 06:54:06 +0000</resolved>
                                        <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                    <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17350951" author="bereng" created="Tue, 25 May 2021 10:24:11 +0000"  >&lt;p&gt;Managed to repro with the &lt;tt&gt;RepeatableRunner&lt;/tt&gt; locally on 500 iterations. Basically there is a small window where the task signals completion on a count down latch but the pool executor is still tidying up the environment. Hence a new submission is rejected. The fix is to wait for the pool to be ready to accept new tasks.&lt;/p&gt;</comment>
                            <comment id="17354901" author="bereng" created="Tue, 1 Jun 2021 07:40:59 +0000"  >&lt;p&gt;The underlying root problem seems to stem from java&apos;s &lt;tt&gt;ThreadPool&lt;/tt&gt; and &lt;tt&gt;SynchronousQueue&lt;/tt&gt; interactions. The queue will fail &lt;tt&gt;offer()&lt;/tt&gt; calls if there is no thread ready to read. At the same time the TP can be bouncing and spinning threads around internally. If you happen to submit a task during that window you will get false rejections. Other people have hit this, it can be googled easily, and it seems to be an internal Java thing.&lt;/p&gt;

&lt;p&gt;Reproduction is easy with the &lt;tt&gt;RepeteableRunner&lt;/tt&gt; for the single test method where it fails around 10%. 500 runs is a good start, you&apos;ll have to rename the KS on each iteration though. I am providing a pure java test, with no C* code involved, as proof this is a generic issue and not related to our codebase&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testTP() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException
    {
        ExecutorService validationExecutor = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
        {
            ThreadPoolExecutor executor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor(1,
                                                                 2,
                                                                 1,
                                                                 TimeUnit.HOURS,
                                                                 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SynchronousQueue&amp;lt;&amp;gt;(),
                                                                 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NamedThreadFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;Repair-Task&quot;&lt;/span&gt;));
            executor.setRejectedExecutionHandler(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor.AbortPolicy());
            executor.prestartAllCoreThreads();
            validationExecutor = executor;
            Condition blocked = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleCondition();
            CountDownLatch completed = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(2);
            &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);
&lt;/span&gt;            validationExecutor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Task(blocked, completed));
            &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100);
&lt;/span&gt;            validationExecutor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Task(blocked, completed));
            blocked.signalAll();
            completed.await(11, TimeUnit.SECONDS);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
        {
            validationExecutor.shutdownNow();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The solution is to add a &lt;tt&gt;Thread.sleep()&lt;/tt&gt; to give the TP time to sort itself before accepting new tasks. It&apos;s ugly but I can&apos;t come up with a better idea.&lt;/p&gt;

&lt;p&gt;In the PR 1K CI repeats can be found.&lt;/p&gt;</comment>
                            <comment id="17360652" author="michaelsembwever" created="Thu, 10 Jun 2021 08:24:06 +0000"  >&lt;p&gt;+1 &lt;/p&gt;</comment>
                            <comment id="17360846" author="adelapena" created="Thu, 10 Jun 2021 12:26:07 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17361463" author="bereng" created="Fri, 11 Jun 2021 06:57:24 +0000"  >&lt;p&gt;Thx for the review guys!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r920:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/23ad7c301e227d5ea88cea0784b32e6351603912&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/23ad7c301e227d5ea88cea0784b32e6351603912&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;See PR&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>