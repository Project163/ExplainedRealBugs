<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9908] Potential race caused by async cleanup of transaction log files</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9908</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There seems to be a potential race in the cleanup of transaction log files, introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7066&quot; title=&quot;Simplify (and unify) cleanup of compaction leftovers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7066&quot;&gt;&lt;del&gt;CASSANDRA-7066&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
It&apos;s pretty hard to trigger on trunk, but it&apos;s possible to hit it via &lt;tt&gt;o.a.c.db.SecondaryIndexTest#testCreateIndex&lt;/tt&gt; &lt;/p&gt;

&lt;p&gt;That test creates an index, then removes it to check that the removal is correctly recorded, then adds the index again to assert that it gets rebuilt from the existing data. &lt;br/&gt;
The removal causes the SSTables of the index CFS to be dropped, which is a transactional operation and so writes a transaction log. When the drop is completed and the last reference to an SSTable is released, the cleanup of the transaction log is scheduled on the periodic tasks executor. The issue is that re-creating the index re-creates the index CFS. When this happens, it&apos;s possible for the cleanup of the txn log to have not yet happened. If so, the initialization of the CFS attempts to read the log to identify any orphaned temporary files. The cleanup can happen between the finding the log file and reading it&apos;s contents, which results in a &lt;tt&gt;NoSuchFileException&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit] java.nio.file.NoSuchFileException: build/test/cassandra/data:1/SecondaryIndexTest1/CompositeIndexToBeAdded-d0885f60323211e5a5e8ad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_d4b69fc0-3232-11e5-a5e8-ad83a3dc3e9c_old.log
[junit] java.lang.RuntimeException: java.nio.file.NoSuchFileException: build/test/cassandra/data:1/SecondaryIndexTest1/CompositeIndexToBeAdded-d0885f60323211e5a5e8ad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_d4b69fc0-3232-11e5-a5e8-ad83a3dc3e9c_old.log
[junit]     at org.apache.cassandra.io.util.FileUtils.readLines(FileUtils.java:620)
[junit]     at org.apache.cassandra.db.lifecycle.TransactionLogs$TransactionFile.getTrackedFiles(TransactionLogs.java:190)
[junit]     at org.apache.cassandra.db.lifecycle.TransactionLogs$TransactionData.getTemporaryFiles(TransactionLogs.java:338)
[junit]     at org.apache.cassandra.db.lifecycle.TransactionLogs.getTemporaryFiles(TransactionLogs.java:739)
[junit]     at org.apache.cassandra.db.lifecycle.LifecycleTransaction.getTemporaryFiles(LifecycleTransaction.java:541)
[junit]     at org.apache.cassandra.db.Directories$SSTableLister.getFilter(Directories.java:652)
[junit]     at org.apache.cassandra.db.Directories$SSTableLister.filter(Directories.java:641)
[junit]     at org.apache.cassandra.db.Directories$SSTableLister.list(Directories.java:606)
[junit]     at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:351)
[junit]     at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:313)
[junit]     at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:511)
[junit]     at org.apache.cassandra.index.internal.CassandraIndexer.addIndexedColumn(CassandraIndexer.java:115)
[junit]     at org.apache.cassandra.index.SecondaryIndexManager.addIndexedColumn(SecondaryIndexManager.java:265)
[junit]     at org.apache.cassandra.db.SecondaryIndexTest.testIndexCreate(SecondaryIndexTest.java:467)
[junit] Caused by: java.nio.file.NoSuchFileException: build/test/cassandra/data:1/SecondaryIndexTest1/CompositeIndexToBeAdded-d0885f60323211e5a5e8ad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_d4b69fc0-3232-11e5-a5e8-ad83a3dc3e9c_old.log
[junit]     at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
[junit]     at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
[junit]     at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
[junit]     at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:214)
[junit]     at java.nio.file.Files.newByteChannel(Files.java:361)
[junit]     at java.nio.file.Files.newByteChannel(Files.java:407)
[junit]     at java.nio.file.spi.FileSystemProvider.newInputStream(FileSystemProvider.java:384)
[junit]     at java.nio.file.Files.newInputStream(Files.java:152)
[junit]     at java.nio.file.Files.newBufferedReader(Files.java:2784)
[junit]     at java.nio.file.Files.readAllLines(Files.java:3202)
[junit]     at org.apache.cassandra.io.util.FileUtils.readLines(FileUtils.java:616)
[junit] 
[junit] 
[junit] Test org.apache.cassandra.db.SecondaryIndexTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12849577">CASSANDRA-9908</key>
            <summary>Potential race caused by async cleanup of transaction log files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                            <label>benedict-to-commit</label>
                    </labels>
                <created>Tue, 28 Jul 2015 10:31:43 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:03 +0000</updated>
                            <resolved>Tue, 11 Aug 2015 07:11:01 +0000</resolved>
                                        <fixVersion>3.0 beta 1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14644500" author="benedict" created="Tue, 28 Jul 2015 15:05:49 +0000"  >&lt;p&gt;Hmm. So our secondary index files don&apos;t use their cfId in their directory name?&lt;/p&gt;</comment>
                            <comment id="14644519" author="beobal" created="Tue, 28 Jul 2015 15:20:32 +0000"  >&lt;p&gt;No, an index cfs doesn&apos;t have a unique cfId, instead it inherits it from its parent table.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AbstractPerColumnSecondaryIndex#newIndexMetadata&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; CFMetaData.Builder builder = CFMetaData.Builder.create(baseMetadata.ksName, baseMetadata.indexColumnFamilyName(def))
                                                .withId(baseMetadata.cfId)
                                                .addPartitionKey(def.name, def.type);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14644539" author="benedict" created="Tue, 28 Jul 2015 15:31:15 +0000"  >&lt;p&gt;Doesn&apos;t that sort of obviate much of the supposed benefit of unique cfIds?&lt;/p&gt;

&lt;p&gt;Anyway, I guess in this instance we can just make sure that all txn logs have been fully cleared before creating a secondary index. The rub will be if the cleanup fails, though (deletion on windows, for instance), or there are still extant readers. In either case the cleanup can&apos;t safely complete.&lt;/p&gt;</comment>
                            <comment id="14645277" author="stefania" created="Wed, 29 Jul 2015 00:34:44 +0000"  >&lt;p&gt;Regardless of indexes, I think it should be safe to call &lt;tt&gt;LifecycleTransaction.getTemporaryFiles&lt;/tt&gt; at any time. Should we perhaps get the temporary files by using a future on the same thread performing the deletions or synchronize in some other way? Or just ignore the exception?&lt;/p&gt;</comment>
                            <comment id="14645299" author="stefania" created="Wed, 29 Jul 2015 00:51:41 +0000"  >&lt;p&gt;There was an obvious mistake in &lt;tt&gt;TransactionData.getTemporaryFile()&lt;/tt&gt;, we should check for the existence of the old log before reading lines because of the sync() just above. The object itself is created only when at least one log file exists, but this may change due to the sync.&lt;/p&gt;

&lt;p&gt;This change was sufficient to fix my unit test. which was reliably failing. However I could not reproduce it at all with &lt;tt&gt;testIndexCreate&lt;/tt&gt;, so &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; could you apply this simple patch to your branch and see if it works?&lt;/p&gt;</comment>
                            <comment id="14645687" author="beobal" created="Wed, 29 Jul 2015 08:21:27 +0000"  >&lt;p&gt;The patch narrows the window for the race but doesn&apos;t close it completely. It remains possible for the async cleanup to remove the file between the existence check in &lt;tt&gt;TransactionData#getTemporaryFiles&lt;/tt&gt; and actually reading its content in &lt;tt&gt;TransactionFile#getTrackedFiles&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt; My test fails much less frequently now but I can still hit the error on occasion, so I added some extra logging to capture the race happening (extracted from the attached log):  &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [main] 2015-07-29 09:13:50,782 TransactionLogs.java:228  Deleted txn log file build/test/cassandra/data/SecondaryIndexTest1/CompositeIndexToBeAdded-bd86e0e035c911e5951aad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_bea2b120-35c9-11e5-951a-ad83a3dc3e9c_new.log
INFO  [NonPeriodicTasks:1] 2015-07-29 09:13:50,793 TransactionLogs.java:537  Removing files for transaction bea2b120-35c9-11e5-951a-ad83a3dc3e9c
INFO  [NonPeriodicTasks:1] 2015-07-29 09:13:50,823 TransactionLogs.java:228  Deleted txn log file build/test/cassandra/data/SecondaryIndexTest1/CompositeIndexToBeAdded-bd86e0e035c911e5951aad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_bea2b120-35c9-11e5-951a-ad83a3dc3e9c_old.log
INFO  [main] 2015-07-29 09:13:50,823 TransactionLogs.java:351  Txn old log file build/test/cassandra/data/SecondaryIndexTest1/CompositeIndexToBeAdded-bd86e0e035c911e5951aad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_bea2b120-35c9-11e5-951a-ad83a3dc3e9c_old.log exists
INFO  [main] 2015-07-29 09:13:50,831 TransactionLogs.java:195  Error reading from txn log file build/test/cassandra/data/SecondaryIndexTest1/CompositeIndexToBeAdded-bd86e0e035c911e5951aad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_bea2b120-35c9-11e5-951a-ad83a3dc3e9c_old.log
java.lang.RuntimeException: java.nio.file.NoSuchFileException: build/test/cassandra/data/SecondaryIndexTest1/CompositeIndexToBeAdded-bd86e0e035c911e5951aad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_bea2b120-35c9-11e5-951a-ad83a3dc3e9c_old.log
        at org.apache.cassandra.io.util.FileUtils.readLines(FileUtils.java:620) ~[main/:na]
        at org.apache.cassandra.db.lifecycle.TransactionLogs$TransactionFile.getTrackedFiles(TransactionLogs.java:192) ~[main/:na]
        at org.apache.cassandra.db.lifecycle.TransactionLogs$TransactionData.getTemporaryFiles(TransactionLogs.java:352) [main/:na]
        at org.apache.cassandra.db.lifecycle.TransactionLogs.getTemporaryFiles(TransactionLogs.java:757) [main/:na]
        at org.apache.cassandra.db.lifecycle.LifecycleTransaction.getTemporaryFiles(LifecycleTransaction.java:541) [main/:na]
        at org.apache.cassandra.db.Directories$SSTableLister.getFilter(Directories.java:652) [main/:na]
        at org.apache.cassandra.db.Directories$SSTableLister.filter(Directories.java:641) [main/:na]
        at org.apache.cassandra.db.Directories$SSTableLister.list(Directories.java:606) [main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:351) [main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:313) [main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:511) [main/:na]
        at org.apache.cassandra.index.internal.CassandraIndexer.addIndexedColumn(CassandraIndexer.java:115) [main/:na]
        at org.apache.cassandra.index.SecondaryIndexManager.addIndexedColumn(SecondaryIndexManager.java:265) [main/:na]
        at org.apache.cassandra.db.SecondaryIndexTest.testIndexCreate(SecondaryIndexTest.java:467) [classes/:na]
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_45]
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_45]
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_45]
        at java.lang.reflect.Method.invoke(Method.java:497) ~[na:1.8.0_45]
        at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44) [junit-4.6.jar:na]
        at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15) [junit-4.6.jar:na]
        at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41) [junit-4.6.jar:na]
        at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20) [junit-4.6.jar:na]
        at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28) [junit-4.6.jar:na]
        at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31) [junit-4.6.jar:na]
        at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70) [junit-4.6.jar:na]
        at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:44) [junit-4.6.jar:na]
        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:180) [junit-4.6.jar:na]
        at org.junit.runners.ParentRunner.access$000(ParentRunner.java:41) [junit-4.6.jar:na]
        at org.junit.runners.ParentRunner$1.evaluate(ParentRunner.java:173) [junit-4.6.jar:na]
        at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28) [junit-4.6.jar:na]
        at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31) [junit-4.6.jar:na]
        at org.junit.runners.ParentRunner.run(ParentRunner.java:220) [junit-4.6.jar:na]
        at org.apache.tools.ant.taskdefs.optional.junit.JUnit4TestMethodAdapter.run(JUnit4TestMethodAdapter.java:105) [ant-junit4.jar:na]
        at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:532) [ant-junit-1.9.4.jar:na]
        at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:1179) [ant-junit-1.9.4.jar:na]
        at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:1030) [ant-junit-1.9.4.jar:na]
Caused by: java.nio.file.NoSuchFileException: build/test/cassandra/data/SecondaryIndexTest1/CompositeIndexToBeAdded-bd86e0e035c911e5951aad83a3dc3e9c/.birthdate_index/transactions/unknowncompactiontype_bea2b120-35c9-11e5-951a-ad83a3dc3e9c_old.log
        at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86) ~[na:1.8.0_45]
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102) ~[na:1.8.0_45]
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107) ~[na:1.8.0_45]
        at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:214) ~[na:1.8.0_45]
        at java.nio.file.Files.newByteChannel(Files.java:361) ~[na:1.8.0_45]
        at java.nio.file.Files.newByteChannel(Files.java:407) ~[na:1.8.0_45]
        at java.nio.file.spi.FileSystemProvider.newInputStream(FileSystemProvider.java:384) ~[na:1.8.0_45]
        at java.nio.file.Files.newInputStream(Files.java:152) ~[na:1.8.0_45]
        at java.nio.file.Files.newBufferedReader(Files.java:2784) ~[na:1.8.0_45]
        at java.nio.file.Files.readAllLines(Files.java:3202) ~[na:1.8.0_45]
        at org.apache.cassandra.io.util.FileUtils.readLines(FileUtils.java:616) ~[main/:na]
        ... 35 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14645925" author="benedict" created="Wed, 29 Jul 2015 11:56:26 +0000"  >&lt;p&gt;Probably we should at least introduce a &lt;tt&gt;TransactionLogs.waitForDeletions&lt;/tt&gt; call after any schema change. We should also make certain dropping an index awaits a new writeOrder and readOrder barrier prior to this.&lt;/p&gt;</comment>
                            <comment id="14646991" author="stefania" created="Thu, 30 Jul 2015 00:47:00 +0000"  >&lt;p&gt;Thank you for checking Sam. So if we cannot rely on calling exists() just prior to reading the lines, we might as well not call it again (to help performance a bit) and wrap the exception, which is what I did in the latest commit.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Probably we should at least introduce a TransactionLogs.waitForDeletions call after any schema change.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure exactly where, do you mean in MigrationManager.announce()? Would it be bad for performance to put it in Tracker.dropSSTables()?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We should also make certain dropping an index awaits a new writeOrder and readOrder barrier prior to this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You mean something like this?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeIndex(ByteBuffer columnName)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; OpOrder.Barrier readBarrier = indexCfs.readOrdering.newBarrier();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; OpOrder.Barrier writeBarrier = indexCfs.keyspace.writeOrder.newBarrier();

        readBarrier.issue();
        writeBarrier.issue();

        readBarrier.await();
        writeBarrier.await();

        indexCfs.invalidate();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, this is not related to the transaction logs, it&apos;s to protect ongoing operations using the index cfs?&lt;/p&gt;</comment>
                            <comment id="14647351" author="benedict" created="Thu, 30 Jul 2015 08:43:30 +0000"  >&lt;p&gt;Take a look in &lt;tt&gt;Keyspace.dropCf&lt;/tt&gt; for another example. In that case it is done to ensure there are no writes to the commit log for the table after it&apos;s dropped. In this case that&apos;s unimportant, but we &lt;em&gt;do&lt;/em&gt; want to be certain that when we call &lt;tt&gt;waitForDeletions&lt;/tt&gt; we can be confident the deletions have all actually happened, and that the log has been cleaned up. This means waiting until nobody is using any of the sstables.&lt;/p&gt;

&lt;p&gt;Really, though, we should be waiting for any writes to complete, then we should clean our memtable, perform a blocking flush (which waits for any in-progress flushes to complete), then waiting for any reads to complete, and &lt;em&gt;then&lt;/em&gt; drop our tables and wait for deletions. This should all happen after the index is no longer reachable by any new operations.&lt;/p&gt;

&lt;p&gt;Waiting for deletions should be fine to put in &lt;tt&gt;dropSSTables&lt;/tt&gt;, however I think it might be better put in &lt;tt&gt;invalidate&lt;/tt&gt;, since there&apos;s no need to wait for them during truncation, for instance.&lt;/p&gt;</comment>
                            <comment id="14647488" author="stefania" created="Thu, 30 Jul 2015 11:24:18 +0000"  >&lt;p&gt;So something like this then:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeIndex(ByteBuffer columnName)
    {
        indexCfs.keyspace.writeOrder.awaitNewBarrier();
        indexCfs.forceBlockingFlush();

        indexCfs.readOrdering.awaitNewBarrier();
        indexCfs.invalidate();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;This should all happen after the index is no longer reachable by any new operations.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Here you mean operations on the base cfs of the index? Isn&apos;t this already guaranteed by &lt;tt&gt;SecondaryIndexManager.removeIndexedColumn&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Agreed on waiting for deletions in &lt;tt&gt;invalidate&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14651564" author="benedict" created="Mon, 3 Aug 2015 08:00:16 +0000"  >&lt;p&gt;Yep, that all looks good.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Isn&apos;t this already guaranteed by SecondaryIndexManager.removeIndexedColumn?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, it was just a general statement, without having yet dived into this piece of code sufficiently, that we needed to ensure this.&lt;/p&gt;

&lt;p&gt;(sorry for the delay, I thought I&apos;d already responded to this)&lt;/p&gt;</comment>
                            <comment id="14653163" author="stefania" created="Tue, 4 Aug 2015 06:46:47 +0000"  >&lt;p&gt;Thanks for confirming, it&apos;s ready for review then.&lt;/p&gt;</comment>
                            <comment id="14662981" author="benedict" created="Sat, 8 Aug 2015 13:36:36 +0000"  >&lt;p&gt;Thinking about it, we need to replicate a little more code from the regular CF drop: interruption of compactions. We should be calling both &lt;tt&gt;CompactionManager.instance.interruptCompactionForCFs&lt;/tt&gt; and &lt;tt&gt;waitForCessation&lt;/tt&gt;, to ensure that most references to the files are also relinquished before we signal successful drop.&lt;/p&gt;

&lt;p&gt;Then, unfortunately, that still doesn&apos;t put us in the clear, but I&apos;m beginning to think it would be better and more robust to just accelerate SecondaryIndexes having their own UUID, which I believe is already on the cards for the near future. As we can still have other long running operations - such as &lt;tt&gt;keySamples&lt;/tt&gt; which have references to sstables that can be long lived, that aren&apos;t compactions and won&apos;t acquiesce. So, really, we need to sleep-spin until they are all released. This is pretty unpleasant, and it does run the risk of schema changes becoming blocked indefinitely on a leaked reference.&lt;/p&gt;

&lt;p&gt;I would also prefer we at least logged an error message if we encounter the race condition with the NoSuchFileException. Since it definitely means we still have problems.&lt;/p&gt;</comment>
                            <comment id="14663311" author="benedict" created="Sun, 9 Aug 2015 07:46:51 +0000"  >&lt;p&gt;(It&apos;s also worth noting this race condition as a whole is not new to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7066&quot; title=&quot;Simplify (and unify) cleanup of compaction leftovers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7066&quot;&gt;&lt;del&gt;CASSANDRA-7066&lt;/del&gt;&lt;/a&gt;, but it is easier to hit now. The patch as stands should make the situation better than pre-7066)&lt;/p&gt;</comment>
                            <comment id="14679517" author="stefania" created="Mon, 10 Aug 2015 03:34:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;Thinking about it, we need to replicate a little more code from the regular CF drop: interruption of compactions. We should be calling both CompactionManager.instance.interruptCompactionForCFs and waitForCessation, to ensure that most references to the files are also relinquished before we signal successful drop.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done. However, &lt;tt&gt;waitForCessasion&lt;/tt&gt; is not called by &lt;tt&gt;Keyspace.dropCf&lt;/tt&gt; - just pointing it out, I agree that we should call it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Then, unfortunately, that still doesn&apos;t put us in the clear, but I&apos;m beginning to think it would be better and more robust to just accelerate SecondaryIndexes having their own UUID, which I believe is already on the cards for the near future. As we can still have other long running operations - such as keySamples which have references to sstables that can be long lived, that aren&apos;t compactions and won&apos;t acquiesce. So, really, we need to sleep-spin until they are all released. This is pretty unpleasant, and it does run the risk of schema changes becoming blocked indefinitely on a leaked reference.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Other than this race, which would result in a log message after this patch, what are the other risks? From what I understand we include temporary files when calculating the latest generation number in &lt;tt&gt;ColumnFamilyStore.createColumnFamilyStore&lt;/tt&gt; but we exclude them when loading the sstables in the constructor of CFS. So, we should not reuse old generation numbers (which would be really bad) and we should not load old files (also quite bad). We delete the tx log file last, and we call getTemporaryFiles() before calling listFiles() in Directories.filter(). So can we still pick up temporary files by mistake? If anything we should always ensure that listFiles() is never called before getTemporaryFiles() by perhaps moving this code together? Or am I missing something completely? I do agree on using separate UUID for indexes by the way, I am just reasoning on how to make this safe given the current status.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I would also prefer we at least logged an error message if we encounter the race condition with the NoSuchFileException. Since it definitely means we still have problems.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I changed the log message from WARN to ERROR.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;Please disregard the old patch based on trunk, I rebased it on cassandra-3.0 and renamed it to &lt;a href=&quot;https://github.com/stef1927/cassandra/commits/9908-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9908-3.0&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14679665" author="benedict" created="Mon, 10 Aug 2015 06:48:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;Done. However, waitForCessasion is not called by Keyspace.dropCf - just pointing it out, I agree that we should call it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The table UUID means it isn&apos;t necessary to wait for correctness purposes in &lt;tt&gt;dropCf&lt;/tt&gt;, and it is better not to wait because it makes the command itself more responsive. I&apos;m genuinely a little concerned about completely preventing schema updates making it to the node, as &lt;tt&gt;waitForCessation&lt;/tt&gt; could take a long time if there are huge rows (or we have a bug)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;what are the other risks? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Loading old data files for the new index. But you&apos;re right, with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7066&quot; title=&quot;Simplify (and unify) cleanup of compaction leftovers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7066&quot;&gt;&lt;del&gt;CASSANDRA-7066&lt;/del&gt;&lt;/a&gt; (but not before), running &lt;tt&gt;dropSSTables()&lt;/tt&gt; before this but compactions have stopped should be completely safe.&lt;/p&gt;

&lt;p&gt;It may also be worth though, on supported platforms, making cleanup happen much earlier. We can delete files we want to be rid of immediately on any unix platform, since we no longer depend on the file&apos;s presence for serving reads / constructing new readers. It is only Windows that requires our file handles are all closed before we delete. This should definitely be a separate ticket though.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Please disregard the old patch based on trunk, I rebased it on cassandra-3.0 and renamed it to 9908-3.0.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks, I&apos;ll review shortly.&lt;/p&gt;</comment>
                            <comment id="14680208" author="benedict" created="Mon, 10 Aug 2015 14:41:55 +0000"  >&lt;p&gt;I&apos;ve committed this as 45c04b72753a738cb4a8af7025ad4cb10a12c452.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this is quite the end of making this completely 100% safe, though, and relates to my comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7066&quot; title=&quot;Simplify (and unify) cleanup of compaction leftovers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7066&quot;&gt;&lt;del&gt;CASSANDRA-7066&lt;/del&gt;&lt;/a&gt;. For instance, we could fail to read a &lt;tt&gt;TransactionLog&lt;/tt&gt; after listing a file that it deletes (because both are now deleted), which would result in a &lt;tt&gt;FileNotFoundException&lt;/tt&gt; during CFS instantiation. This particular issue would not affect correctness as it stands, though, but I&apos;m not confident there aren&apos;t other similar issues remaining that wouldn&apos;t (very rarely) cause correctness problems.&lt;/p&gt;</comment>
                            <comment id="14680969" author="stefania" created="Mon, 10 Aug 2015 23:44:50 +0000"  >&lt;p&gt;If the listing of files happened before listing the temporary files we would have an issue. If the two listing operations happened in the opposite order, as we do at the moment, we would have an issue if a new transaction was started in between the two operations. We should address these potential problems but let&apos;s do it as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7066&quot; title=&quot;Simplify (and unify) cleanup of compaction leftovers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7066&quot;&gt;&lt;del&gt;CASSANDRA-7066&lt;/del&gt;&lt;/a&gt; or a follow up ticket. I&apos;ll move the discussion there. &lt;/p&gt;

&lt;p&gt;So can we resolve this ticket?&lt;/p&gt;</comment>
                            <comment id="14681350" author="benedict" created="Tue, 11 Aug 2015 07:11:01 +0000"  >&lt;p&gt;Yes; I meant to do so yesterday.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12747746" name="TEST-org.apache.cassandra.db.SecondaryIndexTest.log" size="36712" author="samt" created="Wed, 29 Jul 2015 08:21:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i0f3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>