<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16619] Loss of commit log data possible after sstable ingest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16619</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;SSTable metadata contains commit log positions of the sstable. These positions are used to filter out mutations from the commit log on restart and only make sense for the node on which the data was flushed.&lt;/p&gt;

&lt;p&gt;If an SSTable is moved between nodes they may cover regions that the receiving node has not yet flushed, and result in valid data being lost should these sections of the commit log need to be replayed.&lt;/p&gt;

&lt;p&gt;Solution:&lt;br/&gt;
The chosen solution introduces a new sstable metadata (StatsMetadata) - originatingHostId (UUID), which is the local host id of the node on which the sstable was created, or null if not known. Commit log intervals from an sstable are taken into account during Commit Log replay only when the originatingHostId of the sstable matches the local node&apos;s hostId.&lt;/p&gt;

&lt;p&gt;For new sstables the originatingHostId is set according to StorageService&apos;s local hostId.&lt;br/&gt;
For compacted sstables the originatingHostId set according to StorageService&apos;s local hostId, and only commit log intervals from local sstables is preserved in the resulting sstable.&lt;/p&gt;

&lt;p&gt;discovered by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jakubzytka&quot; class=&quot;user-hover&quot; rel=&quot;jakubzytka&quot;&gt;jakubzytka&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13373819">CASSANDRA-16619</key>
            <summary>Loss of commit log data possible after sstable ingest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jlewandowski">Jacek Lewandowski</assignee>
                                    <reporter username="jlewandowski">Jacek Lewandowski</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Apr 2021 10:17:27 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Mon, 17 May 2021 08:47:22 +0000</resolved>
                                        <fixVersion>3.0.25</fixVersion>
                    <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Commit Log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17325939" author="dcapwell" created="Tue, 20 Apr 2021 16:17:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;If an SSTable is moved between nodes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What method are you using to &quot;move&quot; SSTables?  Streaming and nodetool import are expected to remove this info; can you elaborate?&lt;/p&gt;</comment>
                            <comment id="17326894" author="jlewandowski" created="Wed, 21 Apr 2021 20:24:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; - how the streaming is expected to remove this info? I can see that zero copy streaming moves the whole files between the nodes and there is no transformation which removes that information.&lt;/p&gt;</comment>
                            <comment id="17326899" author="dcapwell" created="Wed, 21 Apr 2021 20:33:59 +0000"  >&lt;p&gt;that sounds like a bug in zero-copy streaming then, ideally we should strip that info out before adding the SSTables&lt;/p&gt;</comment>
                            <comment id="17326906" author="dcapwell" created="Wed, 21 Apr 2021 20:42:23 +0000"  >&lt;p&gt;Looking at importer I don&apos;t see it cleaning up &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/SSTableImporter.java#L365-L380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/SSTableImporter.java#L365-L380&lt;/a&gt;. Ideally we should drop it, and ancestors (also missing)&lt;/p&gt;</comment>
                            <comment id="17326907" author="yifanc" created="Wed, 21 Apr 2021 20:43:10 +0000"  >&lt;p&gt;ZCS streams a file as-is and w/o loading it into memory, hence fast. To remove a field metadata, a node needs to load the file into memory when receiving from remote.&#160;&lt;/p&gt;

&lt;p&gt;I think it is an expected behavior with ZCS.&#160;&lt;/p&gt;

&lt;p&gt;To distinguish, adding the original hostID in the metadata sounds valid.&lt;/p&gt;

&lt;p&gt;&amp;#8211; edit &amp;#8211;&lt;/p&gt;

&lt;p&gt;Talked with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160;on slack. In the case of ZCS, the sstable metadata is updated after flushing the bytes. See &lt;a href=&quot;https://github.com/apache/cassandra/blob/0fd8f0a52fbd69c47d073373abfe7d2437bbd9ca/src/java/org/apache/cassandra/db/streaming/CassandraEntireSSTableStreamReader.java#L142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here.&lt;/a&gt;&#160;Currently, it does not reset the commitLogInterval. But it is possible to just add a step to reset, and avoid updating the sstable format, i.e. add a new field.&#160;&lt;/p&gt;</comment>
                            <comment id="17326911" author="dcapwell" created="Wed, 21 Apr 2021 20:58:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;a node needs to load the file into memory when receiving from remote&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;we would already when we open the file, so can strip this out still&lt;/p&gt;</comment>
                            <comment id="17326916" author="JIRAUSER308715" created="Wed, 21 Apr 2021 21:03:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; this isn&apos;t just about ZCS.  Any backup/restore process that copied an SSTable around is also affected.  If a given node did not create the CommitLogPosition information then it needs to be ignored when loading the sstable.  Hence the proposal to store the hostid in the metadata.  If the hostid in the sstable doesn&apos;t match the hostid of the current node, then you can just ignore that erroneous information.  This affects 3.x clusters as well, not just 4.x with ZCS.&lt;/p&gt;</comment>
                            <comment id="17326943" author="dcapwell" created="Wed, 21 Apr 2021 21:30:23 +0000"  >&lt;p&gt;A backup/restore process which bypasses nodetool import and directly dumps the files in the CF directory makes sense to hit this, but if you go through import I would hope we strip out all the metadata which is no longer relevant (which we are trying to do in import as commit log position isn&apos;t the only thing we need to deal with).  If we special case commit log, what do we do with other things such as repair, ancestry, level, etc?  &lt;/p&gt;

&lt;p&gt;Since the cases which load SStables from external writers are few and well known, I feel it makes the most sense to make sure each strips the metadata the same way. Adding a method to MetadataSerializer such as resetCommitLogPosition and calling it in the places which import files would handle this without requiring a format change (import allows more flexibility in what we strip out, which backup/restore processes can use.  So nice to have this method rather than a resetNonLocalMetadata method).&lt;/p&gt;</comment>
                            <comment id="17327149" author="blambov" created="Thu, 22 Apr 2021 07:09:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;what do we do with other things such as repair, ancestry, level, etc?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;With this ticket, we &lt;em&gt;have&lt;/em&gt;&#160;the originating host id, so we have the means to ignore non-relevant information, whether it is in commit log, compaction or anywhere.&lt;/p&gt;

&lt;p&gt;There&apos;s some room to make the interface more generic, i.e. have a mechanism to mark fields as local so that they can be properly combined when doing compaction (which can easily be done in a separate ticket), but this IMHO is a better solution to the problem as it&#160;handles all manners of transfer and also allows correcting errors caused by tables already transferred by the time a bug with local metadata is uncovered.&lt;/p&gt;</comment>
                            <comment id="17329365" author="blerer" created="Thu, 22 Apr 2021 19:14:52 +0000"  >&lt;p&gt;One problem with a new SSTable version is that if you hit an issue after upgrading you might not be able to downgrade your cluster without losing some data. I agree that the current solution is probably better, nevertheless introducing a new SSTable version is not without consequence until we introduce a mechanism as the one descripbe by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cscotta&quot; class=&quot;user-hover&quot; rel=&quot;cscotta&quot;&gt;cscotta&lt;/a&gt; in the roadmap discussion.&lt;br/&gt;
Would it makes sense to use another approach for now and introduce the change later on (either when we have other reasons to introduce a new SSTable format or when we have a safety mechanism) ? &lt;/p&gt;</comment>
                            <comment id="17329924" author="JIRAUSER308715" created="Fri, 23 Apr 2021 01:47:35 +0000"  >&lt;p&gt;Actually new minor sstable versions that only add new metadata fields are fine. If you downgrade the previous version should still be able to read the files.&lt;/p&gt;</comment>
                            <comment id="17329926" author="JIRAUSER308715" created="Fri, 23 Apr 2021 01:49:02 +0000"  >&lt;p&gt;There is only a downgrade issue for major version bumps of sstables.&lt;/p&gt;</comment>
                            <comment id="17330342" author="jlewandowski" created="Fri, 23 Apr 2021 09:37:47 +0000"  >&lt;p&gt;I&apos;ve started CI builds:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/703/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/703/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/704/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/705/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/705/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17332479" author="blerer" created="Mon, 26 Apr 2021 15:04:57 +0000"  >&lt;p&gt;As &lt;tt&gt;4.0-rc1&lt;/tt&gt; has been released we need to provide forward compatibility for data. I do not think it is the case with the current patch. Users using &lt;tt&gt;4.0-rc1&lt;/tt&gt; will have an &lt;tt&gt;na&lt;/tt&gt; format &lt;b&gt;without&lt;/b&gt; hostID whereas when they will deploy &lt;tt&gt;4.0-rc2&lt;/tt&gt; they will have an &lt;tt&gt;na&lt;/tt&gt; format &lt;b&gt;with&lt;/b&gt; hostID which will fail to read the &lt;tt&gt;na&lt;/tt&gt; SSTables from the &lt;tt&gt;4.0-rc1&lt;/tt&gt;. To fix that I think that we need to introduce a new &lt;tt&gt;nb&lt;/tt&gt; version.&lt;/p&gt;

&lt;p&gt;Regarding the patches, we should refactor the &lt;tt&gt;MetadataSerializerTest.testXReadY&lt;/tt&gt; tests to ensure that they test all the possible combinations not only some of them.&lt;/p&gt;</comment>
                            <comment id="17333149" author="jlewandowski" created="Tue, 27 Apr 2021 11:29:01 +0000"  >&lt;p&gt;Thanks you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, I&apos;ll apply the requested changes&lt;/p&gt;</comment>
                            <comment id="17337318" author="jlewandowski" created="Fri, 30 Apr 2021 11:50:41 +0000"  >&lt;p&gt;Started CI tests:&lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/728/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/728/&lt;/a&gt; (4.0) - eventually looks good I guess&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/729/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/729/&lt;/a&gt; (3.11)&lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/724/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/724/&lt;/a&gt; (3.0)&lt;/p&gt;</comment>
                            <comment id="17339547" author="blerer" created="Wed, 5 May 2021 09:18:30 +0000"  >&lt;p&gt;+1 Thanks for all the hard work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17340126" author="blerer" created="Thu, 6 May 2021 09:57:25 +0000"  >&lt;p&gt;Committed into 3.0 at d84c6e98106e7b0c205f019ee24d416d0bb65f37 and merged into cassandra-3.11, cassandra-4.0 and trunk&lt;/p&gt;</comment>
                            <comment id="17340366" author="jlewandowski" created="Thu, 6 May 2021 18:37:25 +0000"  >&lt;p&gt;thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343859" author="jlewandowski" created="Thu, 13 May 2021 13:29:46 +0000"  >&lt;p&gt;Unfortunately I missed moving the originating host id to the end in 4.0 PR&lt;br/&gt;
here is the fix: &lt;a href=&quot;https://github.com/apache/cassandra/pull/1007&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1007&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343966" author="edimitrova" created="Thu, 13 May 2021 15:54:44 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;, CircleCI run submitted:&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/821/workflows/a53aac7b-ecee-4597-9d27-66a9d6b9ab90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 &lt;/a&gt; | &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/821/workflows/02eba6a1-5601-45f1-9743-16b3f04beaf8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 11 &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343980" author="edimitrova" created="Thu, 13 May 2021 16:07:26 +0000"  >&lt;p&gt;Jenkins run also submitted &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/773/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17344513" author="jlewandowski" created="Fri, 14 May 2021 10:25:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; I&apos;ve missed regenerating &lt;tt&gt;nb&lt;/tt&gt; in legacy sstables after the change - fixed that and rerun the tests: &lt;a href=&quot;https://jenkins-cm4.apache.org/view/patches/job/Cassandra-devbranch-test/524/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins-cm4.apache.org/view/patches/job/Cassandra-devbranch-test/524/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17344917" author="edimitrova" created="Fri, 14 May 2021 23:12:49 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;, I will review the patch on Monday&lt;/p&gt;</comment>
                            <comment id="17345956" author="blerer" created="Mon, 17 May 2021 08:19:13 +0000"  >&lt;p&gt;The patch looks good to me. Sorry, for missing that part in the review.&lt;br/&gt;
I will commit&lt;/p&gt;</comment>
                            <comment id="17345976" author="blerer" created="Mon, 17 May 2021 08:46:58 +0000"  >&lt;p&gt;Committed into cassandra 4.0 at d35f36cd055419f5ba5b82f2efc047348c71b530 and merged into trunk.&lt;/p&gt;</comment>
                            <comment id="17441530" author="tsteinmaurer" created="Wed, 10 Nov 2021 06:55:57 +0000"  >&lt;p&gt;Regarding the WARN log, which got introduced by that ticket, e.g.:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [main] 2021-11-08 21:54:06,826 CommitLogReplayer.java:253 - Origin of 1 sstables is unknown or doesn&apos;t match the local node; commitLogIntervals for them were ignored
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While I understand the intention to ensure / avoid things when SSTables have been copied around (or e.g. due to a restore), the WARN log also seems to happen when Cassandra 3.11.11 reads pre-&quot;&lt;b&gt;me&lt;/b&gt;&quot; SSTables, thus e.g. from 3.11.10. I understand that the WARN log will go away eventually on its own resp. for sure (I guess?) after running &quot;nodetool upgradesstables&quot;.&lt;/p&gt;

&lt;p&gt;These sort of WARN log has produced quite some confusion and customer interaction for on-premise customer installations.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Would it be possible to WARN only if we are in context of a &quot;me&quot; SSTable to avoid confusion after upgrading from pre-3.11.11?&lt;/li&gt;
	&lt;li&gt;Would it be possible to mention a SSTable minor upgrade in e.g. &lt;tt&gt;NEWS.txt&lt;/tt&gt; (or perhaps I missed it), as there might be tooling out there which counts number of SSTables per &quot;format&quot; via file name&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Many thanks.&lt;/p&gt;</comment>
                            <comment id="17449594" author="smiklosovic" created="Fri, 26 Nov 2021 14:45:35 +0000"  >&lt;p&gt;How am I supposed to do a point-in-time restoration using a commit log from the other node when it gets skipped as shown in the previous comment? That is by means of pointing Cassandra to dir with logs and modifying commitlog_archiving.properties.&lt;/p&gt;</comment>
                            <comment id="17450284" author="smiklosovic" created="Mon, 29 Nov 2021 09:10:26 +0000"  >&lt;p&gt;I think this feature is broken on the scenario when I have a commit log I want to replay for a completely diffent / new node which has UUID not matching the one in the commit log. The way how to workaround this will be in 4.1 as done in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14582&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-14582&lt;/a&gt; however I am afraid that point in time restoration of all other Cassandra versions, since this patch was introduced, is broken.&#160;&lt;/p&gt;</comment>
                            <comment id="17450328" author="blambov" created="Mon, 29 Nov 2021 10:31:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt;, could you please open a separate ticket with your suggestions, so that the fix can be tracked correctly?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;How am I supposed to do a point-in-time restoration using a commit log from the other node when it gets skipped as shown in the previous comment?&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The patch ensures that the commit log will &lt;em&gt;not&lt;/em&gt; be skipped, even if it matches spans that sstables already cover. The problem you are describing is not a correctness one &#8211; the node will ignore intervals and hence replay all commit log data that it finds. Since mutations are idempotent, this will work correctly, albeit slower than before. The difference is that it will not mess up if the wrong sstable ended up in the restore set for whatever reason.&lt;/p&gt;</comment>
                            <comment id="17450366" author="smiklosovic" created="Mon, 29 Nov 2021 10:48:27 +0000"  >&lt;p&gt;No, I think I am still right in what I wrote. It breaks point-in-time restoration. If you set property &quot;restore_point_in_time&quot; in commitlog_archiving.properties, with this patch it is just ignored and all is replayed. So you do not have any possibility to replay to some point in time for a completely new node. I still consider this to be a regression.&lt;/p&gt;

&lt;p&gt;Lets say you have a cluster of 5 nodes you are taking snapshots of regularly as well as all commit logs in between and all this stuff is uploaded to some backup storage.&lt;/p&gt;

&lt;p&gt;Then on restore, you want to regenerate the cluster as it was, point-in-time precision. With backup, I have also backed up the information about tokens so I set initial_tokens field in yaml etc.&lt;/p&gt;

&lt;p&gt;So when I put it all in place, SSTables will match the nodes (because tokens have not changed) and I want to replay the commit logs, but since host ids are generated and I cant set them up on my own as shown in the other ticket I linked, for previous versions, pit restore will stop to work properly even my tokens and all that stuff is just completely fine and I know what I do.&lt;/p&gt;

&lt;p&gt;This was all possible to do previously. Now I end up with all data being replayed even I do not want that.&lt;/p&gt;</comment>
                            <comment id="17450439" author="blambov" created="Mon, 29 Nov 2021 13:14:43 +0000"  >&lt;p&gt;Could you elaborate why this change would cause the restore point to be ignored?&lt;/p&gt;</comment>
                            <comment id="17450469" author="smiklosovic" created="Mon, 29 Nov 2021 13:50:56 +0000"  >&lt;p&gt;Maybe my wording was not precise enough so let me fix and reiterate on that.&lt;/p&gt;

&lt;p&gt;As you said, when it detects that the commit log was not created on the node we try to replay it on, it will effectively replay all mutations. I have a unit test for this and I noticed that when I created 6 mutations and I took a snapshot of that and I created two more mutations but I have not made a snapshot of that but I backed up a commit log, when I replayed commit logs in such a way that I was expecting 7 mutations to be present (6 from sstables + 1 from logs), I was still getting 8 mutations and after looking into the logs I discovered that message which lead me to this ticket.&lt;/p&gt;

&lt;p&gt;So in that sense - &quot;restore_point_in_time&quot; is effectively ignored in cases when I want to restore to a completely new node because its host id will be generated in such a way that it will not match the host id of the commit log I want to replay - so it will replay all mutations - but I do not want that.&lt;/p&gt;</comment>
                            <comment id="17450478" author="brandon.williams" created="Mon, 29 Nov 2021 14:02:33 +0000"  >&lt;p&gt;I think we can just add a flag to disable to get around this.&lt;/p&gt;</comment>
                            <comment id="17450486" author="smiklosovic" created="Mon, 29 Nov 2021 14:15:14 +0000"  >&lt;p&gt;Ok I am reading this: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L290-L313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L290-L313&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After closer look it seems that it relates to SSTables, not commit logs. So basically it will replay all &quot;commitLogIntervals&quot;, whatever it means, I am not familiar with this code, and it does not have anything in common with restore_point_in_time setting or anything related to that replay path. It is just because SSTables were created on the other node, host ids do not match, so it will replay all commit log intervals and these commit log intervals are maybe covering all intervals of commit logs I want to replay, right? Because, clearly, there is less mutations, physically, in these sstables then in sstables + commit logs so when I see all mutations being replayed, the stuff this patch introduced will somehow replay it all ...&lt;/p&gt;</comment>
                            <comment id="17450493" author="jlewandowski" created="Mon, 29 Nov 2021 14:29:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; you mentioned you have some test to demonstrates the problem - could you share it?&lt;/p&gt;</comment>
                            <comment id="17450494" author="blambov" created="Mon, 29 Nov 2021 14:32:45 +0000"  >&lt;p&gt;Rechecking the code, the point in time in restores is applied in &lt;tt&gt;MutationInitiator.initiateMutation&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. What this patch may change is the filtering by commit log position done &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;later in the same method&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I still do not see any evidence that this patch is affecting PIT restore in any way, other than making replay slower because it could be needlessly replaying mutations that are already present in sstables. Granted, the latter is an issue and may warrant risking correctness by flagging this out, but reusing the same ID through porting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14582&quot; title=&quot;Add a system property to set the cassandra hostId if not yet initialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14582&quot;&gt;&lt;del&gt;CASSANDRA-14582&lt;/del&gt;&lt;/a&gt; to earlier versions is most probably a better solution.&lt;/p&gt;</comment>
                            <comment id="17450642" author="JIRAUSER308715" created="Mon, 29 Nov 2021 18:04:59 +0000"  >&lt;p&gt;I would expect someone to see more data replayed, because the intervals would not be ignored, but the end result data wise should be the same. The data in the commitlogs should be idempotent so it is safe to replay even if it is already in a given sstable.&lt;/p&gt;</comment>
                            <comment id="17450645" author="smiklosovic" created="Mon, 29 Nov 2021 18:10:41 +0000"  >&lt;p&gt;I ll keep an eye on this, I was trying to reproduce it but I cant &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; But I am absolutely sure I was getting this, multiple times in a row. I could not wrap my head around this. I am not sure if it is happening non-deterministically or what.&lt;/p&gt;</comment>
                            <comment id="17528376" author="douglasawh" created="Tue, 26 Apr 2022 19:44:18 +0000"  >&lt;p&gt;oops, I was wanting to do a search for things since 3.11.9 but I changed this bug. I clearly need more coffee. going to see if I can figure out what it was.&lt;/p&gt;

&lt;p&gt;UPDATE: Unfortunately, this is not on Wayback...digging.&lt;/p&gt;

&lt;p&gt;UPDATE: History tab to the rescue&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13406490">CASSANDRA-17042</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q8o0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12313861">0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d84c6e98106e7b0c205f019ee24d416d0bb65f37&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d84c6e98106e7b0c205f019ee24d416d0bb65f37&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run regression tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>