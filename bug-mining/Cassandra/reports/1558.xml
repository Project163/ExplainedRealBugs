<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:31:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3690] Streaming CommitLog backup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3690</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Problems with the current SST backups&lt;br/&gt;
1) The current backup doesn&apos;t allow us to restore point in time (within a SST)&lt;br/&gt;
2) Current SST implementation needs the backup to read from the filesystem and hence additional IO during the normal operational Disks&lt;br/&gt;
3) in 1.0 we have removed the flush interval and size when the flush will be triggered per CF, &lt;br/&gt;
          For some use cases where there is less writes it becomes increasingly difficult to time it right.&lt;br/&gt;
4) Use cases which needs BI which are external (Non cassandra), needs the data in regular intervals than waiting for longer or unpredictable intervals.&lt;/p&gt;

&lt;p&gt;Disadvantages of the new solution&lt;br/&gt;
1) Over head in processing the mutations during the recover phase.&lt;br/&gt;
2) More complicated solution than just copying the file to the archive.&lt;/p&gt;

&lt;p&gt;Additional advantages:&lt;br/&gt;
Online and offline restore.&lt;br/&gt;
Close to live incremental backup.&lt;/p&gt;

&lt;p&gt;Note: If the listener agent gets restarted, it is the agents responsibility to Stream the files missed or incomplete.&lt;/p&gt;

&lt;p&gt;There are 3 Options in the initial implementation:&lt;br/&gt;
1) Backup -&amp;gt; Once a socket is connected we will switch the commit log and send new updates via the socket.&lt;br/&gt;
2) Stream -&amp;gt; will take the absolute path of the file and will read the file and send the updates via the socket.&lt;br/&gt;
3) Restore -&amp;gt; this will get the serialized bytes and apply&apos;s the mutation.&lt;/p&gt;

&lt;p&gt;Side NOTE: (Not related to this patch as such) The agent which will take incremental backup is planned to be open sourced soon (Name: Priam).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12536930">CASSANDRA-3690</key>
            <summary>Streaming CommitLog backup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vijay2win@yahoo.com">Vijay</assignee>
                                    <reporter username="vijay2win@yahoo.com">Vijay</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jan 2012 00:39:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:43 +0000</updated>
                            <resolved>Mon, 9 Apr 2012 16:24:43 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13180954" author="jbellis" created="Thu, 5 Jan 2012 23:38:24 +0000"  >&lt;p&gt;The socket business sounds complicated.  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1602&quot; title=&quot;Commit Log archivation and rolling forward utility (AKA Retaining commit logs)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1602&quot;&gt;&lt;del&gt;CASSANDRA-1602&lt;/del&gt;&lt;/a&gt; is a lot more straightforward, I&apos;d recommend starting with that.&lt;/p&gt;</comment>
                            <comment id="13180959" author="vijay2win@yahoo.com" created="Thu, 5 Jan 2012 23:52:27 +0000"  >&lt;p&gt;Hi Jonathan, But there is additional IO which the server has to do to copy the archive logs to a different location (not locally)... &lt;br/&gt;
While streaming the Commit log back to the server we have to copy it first and then read it back which is also a over head in recovery. &lt;/p&gt;

&lt;p&gt;Something like copying the data to S3 in amazon and copying right back for the node for recovery. (this backup will also be used for test cluster refresh for prod data and BI which is completely a different system)&lt;br/&gt;
Recovery in most case are loose of instance or the whole cluster (Virtual machines).&lt;/p&gt;</comment>
                            <comment id="13191899" author="vijay2win@yahoo.com" created="Tue, 24 Jan 2012 05:34:28 +0000"  >&lt;p&gt;0001 =&amp;gt; Adds a configuration so we can avoid recycling in case some one wants to copy the files across to another location like a archive logs&lt;br/&gt;
0002 =&amp;gt; Adds CommitLogListener, implementation can recive the updates to the commitlogs.&lt;br/&gt;
0003 =&amp;gt; helper JMX in case the user wants to query the active CL&apos;s&lt;br/&gt;
0004 =&amp;gt; this can go to the tools folder/we dont need to commit it to the core.&lt;/p&gt;</comment>
                            <comment id="13205043" author="jbellis" created="Thu, 9 Feb 2012 23:35:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;But there is additional IO which the server has to do to copy the archive logs to a different location (not locally)... While streaming the Commit log back to the server we have to copy it first and then read it back which is also a over head in recovery.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What if you mounted the archive logs via s3fs?&lt;/p&gt;</comment>
                            <comment id="13213096" author="jasobrown" created="Tue, 21 Feb 2012 23:11:11 +0000"  >&lt;p&gt;We spent some time looking into s3fs, and ran into problems between fuse (which s3fs depends on) and mmap. I put together a small java app to simulate writing to local disc vs. s3fs using mmapp&apos;ed and non-mmap&apos;ed files. (Note most of my java sample code is based on CommitLogSegment&apos;s implementation.) We found the non-mmap&apos;ed files wrote to s3fs without a hitch, but writing to the mmap&apos;ed S3 mount failed. The failure was different between OpenJDK 6 vs. Sun JDK, but they were both SIGBUS errors. Also, I ran the tests on my local ubuntu box running Linux 3.0.0-12, fuse version (fusermount --version) at 2.8.4. &lt;/p&gt;

&lt;p&gt;At this point, it seems like s3fs isn&apos;t as viable as one would hope.&lt;/p&gt;


</comment>
                            <comment id="13213911" author="jbellis" created="Wed, 22 Feb 2012 19:38:05 +0000"  >&lt;p&gt;That does rule out using s3fs in read/write mode, but I imagine that would be a pretty bad idea from a latency standpoint anyway.  But in the context of just mounting log files for replay/recover, CommitLog uses RandomAccessReader which is ordinary buffered i/o.&lt;/p&gt;</comment>
                            <comment id="13213931" author="vijay2win@yahoo.com" created="Wed, 22 Feb 2012 19:50:23 +0000"  >&lt;p&gt;Starting to think... What we really want is a Async Triggers &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1311&quot; title=&quot;Triggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1311&quot;&gt;&lt;del&gt;CASSANDRA-1311&lt;/del&gt;&lt;/a&gt; which listens for all the updates + a way to restore the data with mutation before starting the node. In someways thats what the original patch was trying to do will it make sense to merge these two efforts?&lt;/p&gt;</comment>
                            <comment id="13213995" author="jbellis" created="Wed, 22 Feb 2012 20:46:42 +0000"  >&lt;p&gt;I&apos;m skeptical of trying to do this on top of triggers.  First, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1311&quot; title=&quot;Triggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1311&quot;&gt;&lt;del&gt;CASSANDRA-1311&lt;/del&gt;&lt;/a&gt; seems to lean towards coordinator-level triggers rather than replica-level.  Second, I don&apos;t think it makes sense for a Trigger-level API to deal with raw bytes, which would mean losing efficiency from having to re-serialize RowMutations.&lt;/p&gt;

&lt;p&gt;I like the postgresql approach: &lt;a href=&quot;http://www.postgresql.org/docs/9.1/static/continuous-archiving.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.postgresql.org/docs/9.1/static/continuous-archiving.html&lt;/a&gt; &amp;#8211; briefly, you configure an &lt;tt&gt;archive_command&lt;/tt&gt; that tells it how you want it to copy full log segments off-server when full, and set up a recovery.conf file when you want to recover, which includes a &lt;tt&gt;restore_command&lt;/tt&gt; that is the inverse of the archive command.&lt;/p&gt;

&lt;p&gt;The main difference is that postgresql&apos;s default wal segment size is 16MB, which gives them a finer resolution than our 128MB.  I can&apos;t think of a reason we can&apos;t lower ours, though.&lt;/p&gt;</comment>
                            <comment id="13225656" author="vijay2win@yahoo.com" created="Thu, 8 Mar 2012 23:11:17 +0000"  >&lt;p&gt;Hi Jonathan,&lt;/p&gt;

&lt;p&gt;Attached patch does exactly what we discussed here. Its almost the same as PostgreSQL &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;In addition we can start the node with -Dcassandra.join_ring=false and then use JMX to restore files one by one via JMX.&lt;/p&gt;

&lt;p&gt;Plz let me know.&lt;/p&gt;</comment>
                            <comment id="13228958" author="jbellis" created="Wed, 14 Mar 2012 04:29:57 +0000"  >&lt;p&gt;I don&apos;t see any uses of CommitLogRecover outside of CommitLog, which makes me think this is an unrelated refactoring.  Is that correct?  If so, let&apos;s split that out of this ticket.&lt;/p&gt;</comment>
                            <comment id="13228962" author="vijay2win@yahoo.com" created="Wed, 14 Mar 2012 04:37:51 +0000"  >&lt;p&gt;Hi Jonathan, The refactor is mainly for the following:&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt; In addition we can start the node with -Dcassandra.join_ring=false and then use JMX to restore files one by one via JMX.&lt;br/&gt;
This allows us to start the recovery process before all the files are downloaded from S3/External source. I can do that it in another ticket, let me know. Thanks!&lt;/p&gt;</comment>
                            <comment id="13247729" author="jbellis" created="Thu, 5 Apr 2012 21:45:01 +0000"  >&lt;p&gt;I&apos;ve made a bunch of minor changes and pushed to &lt;a href=&quot;https://github.com/jbellis/cassandra/branches/3690-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/cassandra/branches/3690-v3&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I noticed that we need to wait for the archive to finish whether we end up recycling or not.  Seems to me it would be simpler to continue to always recycle, but (as we have here) wait for the archive first.  So archive can copy off to s3 or whatever directly, instead of ln somewhere else as an intermediate step.  Total i/o will be lower and commitlog will create extra segments if needed in the meantime.&lt;/p&gt;

&lt;p&gt;Maybe we should also have a restore_list_segments command as well, so we can query s3 (again for instance) directly and have restore_command pull from there, rather than requiring a local directory?&lt;/p&gt;</comment>
                            <comment id="13247738" author="jbellis" created="Thu, 5 Apr 2012 21:53:25 +0000"  >&lt;p&gt;Also: would be nice to get rid of the new Thread / busywait archive dance.  If we used an ExecutorService instead, we could add the Future to the segment and just say segment.waitForArchive(), no looping.&lt;/p&gt;</comment>
                            <comment id="13249104" author="vijay2win@yahoo.com" created="Sat, 7 Apr 2012 00:58:50 +0000"  >&lt;p&gt;Hi Jonathan, Attached patch incorporates all the recommended changes.... except&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt; Maybe we should also have a restore_list_segments command as well, so we can query s3 (again for instance) directly and have restore_command pull from there, rather than requiring a local directory?&lt;br/&gt;
IMHO. It might be better if we have a streaming API to list and stream the data in... otherwise we need have to download to the local FS anyways, So it will be better to incrementally download and use the JMX to restore the files independently (example: A external agent), that may be a simple solution for now..... If the user has a NFS mount it will work even better all he needs to do is to &quot;ln -s&quot; location and he is done &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Plz note that i also removed the requirement to turn off recycling for backup (as recommended), but i left that as configurable because it will good to have unique names in the backup sometimes so we dont overwrite &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13249119" author="jbellis" created="Sat, 7 Apr 2012 01:40:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;it will good to have unique names in the backup sometimes so we dont overwrite &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you think about it, &quot;target filename&quot; is just a suggestion... you&apos;d be free to ignore it and generate a different filename (incorporating timestamp for instance, or even a uuid) in the archive script.&lt;/p&gt;</comment>
                            <comment id="13249126" author="vijay2win@yahoo.com" created="Sat, 7 Apr 2012 01:51:35 +0000"  >&lt;p&gt;Hi Jonathan, Agree, would you like to remove the configuration to disable recycle (which this patch added)? let me know... Thanks!&lt;/p&gt;</comment>
                            <comment id="13249329" author="jbellis" created="Sat, 7 Apr 2012 20:43:13 +0000"  >&lt;p&gt;I do think we should make recycling always-on; it&apos;s a non-negligible performance win and so far we don&apos;t have a use case that requires disabling it.&lt;/p&gt;</comment>
                            <comment id="13249461" author="vijay2win@yahoo.com" created="Sun, 8 Apr 2012 02:51:33 +0000"  >&lt;p&gt;Hi Jonathan, &lt;br/&gt;
v5 removes the recycle related changes and&lt;br/&gt;
Added 2 JMX (getActiveSegmentNames and getArchivingSegmentNames)&lt;/p&gt;

&lt;p&gt;(list all files) - (getActiveSegmentNames) will provide a view of orphan files which failed archiving...&lt;/p&gt;</comment>
                            <comment id="13249854" author="jbellis" created="Mon, 9 Apr 2012 15:04:41 +0000"  >&lt;p&gt;v6 attached.  The primary changes made are fixes to the Future logic: the only way you&apos;ll get a null Future back is if no archive tack was submitted; if it errors out, you&apos;ll get an ExecutionException when you call get(), but never a null.&lt;/p&gt;

&lt;p&gt;Updated getArchivingSegmentNames javadoc to emphasize that it does NOT include failed archive attempts. Not sure if this is what was intended.&lt;/p&gt;</comment>
                            <comment id="13249876" author="vijay2win@yahoo.com" created="Mon, 9 Apr 2012 15:33:49 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13249918" author="jbellis" created="Mon, 9 Apr 2012 16:24:43 +0000"  >&lt;p&gt;committed w/ some final improvements to yaml comments&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517636" name="0001-CASSANDRA-3690-v2.patch" size="41632" author="vijay2win@yahoo.com" created="Thu, 8 Mar 2012 23:11:17 +0000"/>
                            <attachment id="12521798" name="0001-CASSANDRA-3690-v4.patch" size="45316" author="vijay2win@yahoo.com" created="Sat, 7 Apr 2012 01:00:10 +0000"/>
                            <attachment id="12521871" name="0001-CASSANDRA-3690-v5.patch" size="45302" author="vijay2win@yahoo.com" created="Sun, 8 Apr 2012 02:51:33 +0000"/>
                            <attachment id="12511632" name="0001-Make-commitlog-recycle-configurable.patch" size="2580" author="vijay2win@yahoo.com" created="Tue, 24 Jan 2012 05:42:40 +0000"/>
                            <attachment id="12511633" name="0002-support-commit-log-listener.patch" size="3105" author="vijay2win@yahoo.com" created="Tue, 24 Jan 2012 05:42:40 +0000"/>
                            <attachment id="12511634" name="0003-helper-jmx-methods.patch" size="2377" author="vijay2win@yahoo.com" created="Tue, 24 Jan 2012 05:42:40 +0000"/>
                            <attachment id="12511635" name="0004-external-commitlog-with-sockets.patch" size="10768" author="vijay2win@yahoo.com" created="Tue, 24 Jan 2012 05:42:40 +0000"/>
                            <attachment id="12511636" name="0005-cmmiting-comments-to-yaml.patch" size="1018" author="vijay2win@yahoo.com" created="Tue, 24 Jan 2012 05:42:40 +0000"/>
                            <attachment id="12521959" name="3690-v6.txt" size="47560" author="jbellis" created="Mon, 9 Apr 2012 15:04:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>222525</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gn1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95164</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>