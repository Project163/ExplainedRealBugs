<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6998] HintedHandoff - expired hints may block future hints deliveries</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6998</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;For tests purposes, DC2 was shut down for 1 day. The &lt;em&gt;hints&lt;/em&gt; table was filled with millions of rows. Now, when &lt;em&gt;HintedHandOffManager&lt;/em&gt; tries to &lt;em&gt;doDeliverHintsToEndpoint&lt;/em&gt;  it queries the store with QueryFilter.getSliceFilter which counts deleted (TTLed) cells and throws org.apache.cassandra.db.filter.TombstoneOverwhelmingException. &lt;br/&gt;
Throwing this exception stops the manager from running compaction as it is run only after successful handoff. This leaves the HH practically disabled till administrator runs truncateAllHints. &lt;br/&gt;
Wouldn&apos;t it be nicer if on org.apache.cassandra.db.filter.TombstoneOverwhelmingException run compaction? That would remove TTLed hints leaving whole HH mechanism in a healthy state.&lt;/p&gt;

&lt;p&gt;The stacktrace is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;org.apache.cassandra.db.filter.TombstoneOverwhelmingException&lt;br/&gt;
	at org.apache.cassandra.db.filter.SliceQueryFilter.collectReducedColumns(SliceQueryFilter.java:201)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateColumns(QueryFilter.java:122)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:80)&lt;br/&gt;
	at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:72)&lt;br/&gt;
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:297)&lt;br/&gt;
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:53)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1487)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1306)&lt;br/&gt;
	at org.apache.cassandra.db.HintedHandOffManager.doDeliverHintsToEndpoint(HintedHandOffManager.java:351)&lt;br/&gt;
	at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:309)&lt;br/&gt;
	at org.apache.cassandra.db.HintedHandOffManager.access$300(HintedHandOffManager.java:92)&lt;br/&gt;
	at org.apache.cassandra.db.HintedHandOffManager$4.run(HintedHandOffManager.java:530)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cluster of two DCs: DC1, DC2&lt;/li&gt;
	&lt;li&gt;keyspace using NetworkTopologyStrategy (replication factors for both DCs)&lt;/li&gt;
	&lt;li&gt;heavy load (write:read, 100:1) with LOCAL_QUORUM using Java driver setup with DC awareness, writing to DC1&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="12707157">CASSANDRA-6998</key>
            <summary>HintedHandoff - expired hints may block future hints deliveries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="Scooletz">Scooletz</reporter>
                        <labels>
                            <label>HintedHandoff</label>
                            <label>TTL</label>
                    </labels>
                <created>Tue, 8 Apr 2014 11:16:31 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:49 +0000</updated>
                            <resolved>Thu, 16 Oct 2014 16:23:34 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13962935" author="iamaleksey" created="Tue, 8 Apr 2014 13:02:21 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6666&quot; title=&quot;Avoid accumulating tombstones after partial hint replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6666&quot;&gt;&lt;del&gt;CASSANDRA-6666&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13963007" author="scooletz" created="Tue, 8 Apr 2014 14:04:45 +0000"  >&lt;p&gt;Thx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; for your quick comment, I think this problem is not solved yet though. In the comments section of the issue referenced by you &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6666&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-6666&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gsanderson&quot; class=&quot;user-hover&quot; rel=&quot;gsanderson&quot;&gt;gsanderson&lt;/a&gt; asks:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;One quick question... this patch will hopefully prevent us getting into this state in many cases, unless you have a huge number of hints for a node that is down for a very long time: since there is no auto-compaction, a large number of hints may have expired from TTL, thus preventing any further hint delivery.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s the case I&apos;m referring to. I got this Is it covered by 6666? If not, is it considered as a bug? I added stacktrace to the issue.&lt;/p&gt;</comment>
                            <comment id="13968457" author="muhammadadel" created="Mon, 14 Apr 2014 15:53:31 +0000"  >&lt;p&gt;Deleting undelivered tombstones can introduce problems with consistency. I don&apos;t think a hinted handoff row should ever be deleted before delivery even if it was a tombstone.&lt;/p&gt;

&lt;p&gt;The exception is thrown when the number of deleted columns in the query result exceed the tombstonefailurethreshold.&lt;br/&gt;
This can be solved using in two ways:&lt;br/&gt;
1-Instead of just removing the tombstones by compacting the table, we can decrease the page size when catching the exception and then try to perform the hinted handoff again.This will decrease the number of deleted columns below the tombstonefailurethreshold.&lt;br/&gt;
2-a better design choice in my opinion is to use another type of queries, one that gets all rows with a given size regardless of being a live row or not.SliceQueries are not the suitable type for this task since hinted handoff deliver doesn&apos;t care for the status of the given row.&lt;/p&gt;</comment>
                            <comment id="13979480" author="muhammadadel" created="Thu, 24 Apr 2014 09:02:23 +0000"  >&lt;p&gt; Instead of ignoring tombstones when counting returned page size, and instead of ignoring irrelevant data, deliver both relevant and Irrelevant columns. This will increase data consistency when the recovering node was down for a time longer than the gc grace period.&lt;/p&gt;

&lt;p&gt;To avoid performance problems, when choosing to return both relevant and irrelevant data, the slice query filter will count live, tombstones and irrelevant columns, compared to counting live columns only in the ordinary case. The check for tombstone threshold is ignored in this specific case.&lt;/p&gt;

&lt;p&gt;Patch submitted.&lt;/p&gt;</comment>
                            <comment id="13980393" author="muhammadadel" created="Thu, 24 Apr 2014 22:16:40 +0000"  >&lt;p&gt;Sorry, changed status to TESTING by error. Can someone of the moderators return the status back to Patch Available? there is no undo functionality&lt;/p&gt;</comment>
                            <comment id="13993187" author="jbellis" created="Thu, 8 May 2014 22:12:49 +0000"  >&lt;p&gt;I&apos;m confused, both because I&apos;m not sure how &quot;get all rows with a given size&quot; would fix the problem, and because this patch does not seem to match that proposal.&lt;/p&gt;</comment>
                            <comment id="13994200" author="muhammadadel" created="Sat, 10 May 2014 10:19:36 +0000"  >&lt;p&gt;Sorry if I didn&apos;t make myself clear enough. I will try to explain what this patch does:&lt;/p&gt;

&lt;p&gt;1-Normally, the page size passed to SliceQueryFilter represents number of live columns returned. The SliceQueryFilter returns a mix of live columns and tombstones which are not eligible for garbage collection yet. If the number of tombstones seen during constructing the query result exceeds the threshold, an exception is thrown. &lt;/p&gt;

&lt;p&gt;2-When retrieving hinted handoff data, use the SliceQueryFilter in a different way. The page size will represent the total number of columns returned: live columns count + tombstones count. Even tombstones that are eligible for garbage collection are returned. The check for the tombstones threshold is removed. No memory overload will take place since the size of data processed and returned is controlled and predictable (exactly the page size).&lt;/p&gt;

&lt;p&gt;3-This will send all data in the hinted handoff table to the recovering node allowing for higher data consistency even if the node was down for a time larger than the gc_grace period. On the other hand it can cause a higher network load.&lt;/p&gt;

&lt;p&gt;This is a suggested way to deal with the issue of consistency of deleted hinted handoff data. It is not just an addressing for the exception problem, because I think the exception problem is a symptom for the more delicate issue of deleted hinted handoff. &lt;/p&gt;</comment>
                            <comment id="13995547" author="jbellis" created="Mon, 12 May 2014 19:47:47 +0000"  >&lt;p&gt;I see.&lt;/p&gt;

&lt;p&gt;That would fix the problem, but I&apos;m not really a fan of adding extra layers of complexity to mask symptoms of a deeper underlying problem (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6666&quot; title=&quot;Avoid accumulating tombstones after partial hint replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6666&quot;&gt;&lt;del&gt;CASSANDRA-6666&lt;/del&gt;&lt;/a&gt;).  Let&apos;s first figure out &lt;b&gt;why&lt;/b&gt; these tombstones aren&apos;t going away the way we expect them to; it&apos;s likely that we can then solve the problem without breaking the SQF contract (and then trying to make up for that at a higher level).&lt;/p&gt;</comment>
                            <comment id="14161266" author="iamaleksey" created="Tue, 7 Oct 2014 00:25:49 +0000"  >&lt;p&gt;Attaching a very simple v2 patch that fixes this issue, and fixed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6666&quot; title=&quot;Avoid accumulating tombstones after partial hint replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6666&quot;&gt;&lt;del&gt;CASSANDRA-6666&lt;/del&gt;&lt;/a&gt; in an arguably better way, too.&lt;/p&gt;

&lt;p&gt;Currently, a large number of TTLd hints can really block future hint deliveries, b/c the mechanism of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6666&quot; title=&quot;Avoid accumulating tombstones after partial hint replay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6666&quot;&gt;&lt;del&gt;CASSANDRA-6666&lt;/del&gt;&lt;/a&gt; won&apos;t even be able to kick in.&lt;/p&gt;

&lt;p&gt;The attached patch moves the major compaction step in front of delivery, instead of afterwards, thus guaranteeing that we will not have a huge number of expired hints when we go replaying (and also cleans up delivered tombstoned hints).&lt;/p&gt;

&lt;p&gt;As a nice side effect, we are saving &lt;b&gt;a lot&lt;/b&gt; of compactions for the scheduled &apos;deliver all the hints&apos; 10 minutes process, by having a single major compaction done for all the N nodes we are going to deliver hints to, instead of having a compaction at the end of each of those N deliveries.&lt;/p&gt;

&lt;p&gt;The patch is small and non-invasive enough to go into 2.0.x.&lt;/p&gt;</comment>
                            <comment id="14172514" author="jbellis" created="Wed, 15 Oct 2014 16:09:41 +0000"  >&lt;p&gt;LGTM, +1&lt;/p&gt;</comment>
                            <comment id="14173913" author="iamaleksey" created="Thu, 16 Oct 2014 16:23:34 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12693587">CASSANDRA-6666</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12754161">CASSANDRA-8285</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12641685" name="6998" size="8378" author="muhammadadel" created="Thu, 24 Apr 2014 09:01:11 +0000"/>
                            <attachment id="12673262" name="6998-v2.txt" size="8743" author="aleksey" created="Tue, 7 Oct 2014 01:02:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385480</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uep3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325322">2.0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>