<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:33:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20190] MemoryUtil.setInt/getInt and similar use the wrong endianness</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20190</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;`NativeCell`, `NativeClustering` and `NativeDecoratedKey` use the above methods from `MemoryUtil` to write and read data from native memory. As far as I can see they are meant to write data in big endian. They do not (they always correct to little endian).&lt;/p&gt;

&lt;p&gt;Moreover, they disagree with their `ByByte` versions on big-endian machines (which is only likely an issue on aligned-access architectures (x86 and arm should be fine)).&lt;/p&gt;

&lt;p&gt;The same is true for the methods in `Memory`, used by compression metadata as well as index summaries.&lt;/p&gt;

&lt;p&gt;We need to verify that this does not cause any problems, and to change the methods to behave as expected and document the behaviour by explicitly using `ByteOrder.LITTLE_ENDIAN` for any data that may have been persisted on disk with the wrong endianness.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The current MemoryUtil behaviour (before the fix):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Native order&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MemoryUtil.setX&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MemoryUtil.setXByByte&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MemoryUtil.getX&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MemoryUtil.getXByByte&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;shortly: MemoryUtil.setX/getX is LE, MemoryUtil.setXByByte/getXByByte is Native&lt;/p&gt;</description>
                <environment></environment>
        <key id="13604078">CASSANDRA-20190</key>
            <summary>MemoryUtil.setInt/getInt and similar use the wrong endianness</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="blambov">Branimir Lambov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Jan 2025 14:13:18 +0000</created>
                <updated>Thu, 24 Apr 2025 11:31:34 +0000</updated>
                            <resolved>Thu, 24 Apr 2025 11:28:52 +0000</resolved>
                                        <fixVersion>5.0.5</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Local/Other</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17910644" author="benedict" created="Tue, 7 Jan 2025 14:37:41 +0000"  >&lt;p&gt;I&apos;m not sure why these methods should care about endianness at all? These objects live in memory only, so long as the endianness of the machine doesn&apos;t change underneath the VM why are we wasting cycles converting?&lt;/p&gt;</comment>
                            <comment id="17910645" author="benedict" created="Tue, 7 Jan 2025 14:39:40 +0000"  >&lt;p&gt;Perhaps it would be clearer to have a NativeEndianUtil that makes clear the intent, and prevents any accidental usage where we care about the endianness. But the endianness should only matter if we&apos;re putting data into memory directly from disk or network without first parsing/interpreting the bytes.&lt;/p&gt;</comment>
                            <comment id="17910652" author="blambov" created="Tue, 7 Jan 2025 15:03:58 +0000"  >&lt;p&gt;I agree, we can have versions of these methods with specified endianness for the cases we care, and remove any attempts to correct if we don&apos;t.&lt;/p&gt;

&lt;p&gt;However, someone needs to check that we don&apos;t directly copy e.g. bloom filter content and read it with machine-dependent order.&lt;/p&gt;</comment>
                            <comment id="17910655" author="benedict" created="Tue, 7 Jan 2025 15:10:43 +0000"  >&lt;p&gt;I just checked quickly, and my memory was inverted. I thought we used to save it in a machine-dependent manner but had fixed it, but it looks like the opposite is true: we &lt;em&gt;used&lt;/em&gt; to correctly serialise each long in big-endian via DataOutputPlus, but now we do a memory copy.&lt;/p&gt;

&lt;p&gt;Still, this is easily fixed if we&apos;re maintaining a little-endian representation in memory regardless of architecture.&lt;/p&gt;</comment>
                            <comment id="17910671" author="dnk" created="Tue, 7 Jan 2025 15:38:45 +0000"  >&lt;p&gt;MemoryUtil part:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Class&#160;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Used methods&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Usage&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NativeClustering&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;MemoryUtil.setShort/getShort&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;to store metadata like sizes/null bitmap/etc, the metadata are not exposed without decoding outside of this class as a part of any raw buffers/arrays/etc.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NativeDecoratedKey&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;MemoryUtil.setInt/getInt&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;to store length, it is not exposed outside of this class without decoding as a part of any raw buffers/arrays/etc&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NativeCell&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;MemoryUtil.setLong/getLong&lt;br/&gt;
MemoryUtil.setInt/getInt&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;to store metadata like size/timestamp/deletion time/etc, the metadata are not exposed without decoding outside of this class as a part of any raw buffers/arrays/etc&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;based on the source code analysis: for these 3 classes - the written values are not exposed in a raw form outside, so it should be ok to use any order here and from performance point of view - here it makes sense to use a native order.&lt;/p&gt;

&lt;p&gt;So, do we have an agreement that the best option would be to introduce unconditional NativeEndianUtil and BigEndianUtil and use NativeEndianUtil in the above MemoryUtil use cases?&lt;/p&gt;

&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20173&quot; title=&quot;Avoid new ByteBuffer allocation for each NativeCell/NativeClustering during flushing of offheap_objects memtable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20173&quot;&gt;&lt;del&gt;CASSANDRA-20173&lt;/del&gt;&lt;/a&gt; I will use BigEndianUtil within NativeAccessor logic.&lt;/p&gt;</comment>
                            <comment id="17910675" author="dnk" created="Tue, 7 Jan 2025 15:55:28 +0000"  >&lt;p&gt;I have also done a full text search for unsafe.put/get methods and found few more places additionally to Memory and MemoryUtil:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.cassandra.utils.FastByteOperations.UnsafeOperations#compareTo(java.lang.Object, long, int, java.lang.Object, long, int) - here we use unsafe.getLong to speedup comparison but we use the same order for left and write here + we assume that the array/byte buffer/native memory used here to compare has the same order (I think big-endian) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;test class: org.apache.cassandra.net.MessageGenerator#setId/getId - if I got the logic correctly, technically it should be big endian order here instead of native because we work with a network message content but it does not cause a problem if all emulation is happen on a single host &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17910689" author="blambov" created="Tue, 7 Jan 2025 16:40:06 +0000"  >&lt;p&gt;&amp;gt; &lt;tt&gt;org.apache.cassandra.utils.FastByteOperations.UnsafeOperations#compareTo(java.lang.Object, long, int, java.lang.Object, long, int)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The code here is correct, equal longs are fine, and the method correctly reverses unequal longs when the native order is &lt;em&gt;not&lt;/em&gt; big-endian.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17910693" author="dnk" created="Tue, 7 Jan 2025 16:49:02 +0000"  >&lt;p&gt;Yes, sorry, I have not stated it clearly: I do not see an issue in this part of the logic.&lt;/p&gt;

&lt;p&gt;&#160;I am trying to summarize now what I see in the source code for:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;IndexSummary&lt;/li&gt;
	&lt;li&gt;CompressionMetadata&lt;/li&gt;
	&lt;li&gt;BloomFilter (org.apache.cassandra.utils.obs.OffHeapBitSet)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17911199" author="dnk" created="Wed, 8 Jan 2025 18:26:32 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Entity&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Used Memory methods&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Serialize/deserialize logic&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Notes&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BloomFilter (OffHeapBitSet)&lt;br/&gt;
assuming new format&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;setByte&lt;br/&gt;
getByte&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OffHeapBitSet#serialize
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DataOutputPlus.write(bytes, 0, bytes.size()); -&amp;gt; list of &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; order &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; buffers -&amp;gt; copy them as is&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;OffHeapBitSet#deserialize&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FBUtilities.copy(in, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryOutputStream(memory), byteCount), read using &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] chunks &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Order agnostic&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;IndexSummary.offsets&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;getInt&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;IndexSummaryBuilder
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
offsets = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SafeMemoryWriter(4 * maxExpectedEntries).order(ByteOrder.LITTLE_ENDIAN);
&lt;span class=&quot;code-comment&quot;&gt;// it was &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; before CASSANDRA-17723
&lt;/span&gt;...
offsets.writeInt((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) entries.length()); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;IndexSummary.IndexSummarySerializer#serialize&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; offset = t.offsets.getInt(i * 4) + baseOffset;
&lt;span class=&quot;code-comment&quot;&gt;// our serialization format &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; file uses &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; order, so &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is different to the
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; Java serialization order (BIG_ENDIAN) we have to reverse our bytes
&lt;/span&gt;offset = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.reverseBytes(offset);
out.writeInt(offset); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;IndexSummary.IndexSummarySerializer#deserialize&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FBUtilities.copy(in, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryOutputStream(offsets), offsets.size()); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;copy file content as is to memory&lt;/p&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul&gt;
	&lt;li&gt;file format: LE (for offsets)&lt;/li&gt;
	&lt;li&gt;memory format: LE&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;IndexSummary.entries&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;getLong&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;IndexSummaryBuilder
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
entries = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SafeMemoryWriter(expectedEntrySize * maxExpectedEntries).order(ByteOrder.LITTLE_ENDIAN); &lt;span class=&quot;code-comment&quot;&gt;// was &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; before CASSANDRA-17723
&lt;/span&gt;...
entries.writeLong(indexStart); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;IndexSummary.IndexSummarySerializer#serialize&lt;br/&gt;
out.write(t.entries, 0, t.entriesLength);&#160; -&amp;gt; list of native order byte buffers -&amp;gt; copy them as is&lt;/p&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul&gt;
	&lt;li&gt;file format: LE (for positions)&lt;/li&gt;
	&lt;li&gt;memory format: LE&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CompressionMetadata&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;setLong&lt;br/&gt;
getLong&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;CompressionMetadata.Writer#doPrepare
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
out.writeLong(offsets.getLong(i * 8L));&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;CompressionMetadata#readChunkOffsets&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
offsets.setLong(i * 8L, input.readLong());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul&gt;
	&lt;li&gt;file format: BE&lt;/li&gt;
	&lt;li&gt;memory format: LE&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17913785" author="dnk" created="Thu, 16 Jan 2025 15:59:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; what can be the next step for this issue?&lt;/p&gt;

&lt;p&gt;I can prepare a MR with NativeEndianMemoryUtil/BigEndianMemoryUtil/LowEndianMemoryUtil if it is a preferable option (with keeping some common code in MemoryUtil)..&lt;/p&gt;</comment>
                            <comment id="17913848" author="blambov" created="Thu, 16 Jan 2025 20:06:09 +0000"  >&lt;p&gt;SGTM&lt;/p&gt;</comment>
                            <comment id="17930810" author="dnk" created="Wed, 26 Feb 2025 20:29:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3936&lt;/a&gt;&lt;br/&gt;
I have implemented a draft version of changes related to &lt;tt&gt;MemoryUtil&lt;/tt&gt;: I have introduced &lt;tt&gt;NativeEndianMemoryUtil&lt;/tt&gt; and moved adjusted methods from &lt;tt&gt;MemoryUtil&lt;/tt&gt; related to a particular endian (like get/setInt).&lt;/p&gt;

&lt;p&gt;The methods from MemoryUtil class are used only in offheap memtable entities (NativeCell/NativeClustering/NativeDecoratedKey) which are not going to disk/network without decoding to Java primitives, so I switched the logic to native endian to avoid unnecessary conversions. Values stored in the entities are still exposed as BigEndian byte buffers.&lt;br/&gt;
Also I dropped unused &lt;tt&gt;getHollowByteBuffer()&lt;/tt&gt; method and related constants.&lt;/p&gt;

&lt;p&gt;By some reason setShort did not support aligned architecture case, I have added the correspondent logic. &lt;tt&gt;getShort&lt;/tt&gt; is renamed to &lt;tt&gt;getUnsignedShort&lt;/tt&gt; to reflect the reality.&lt;/p&gt;

&lt;p&gt;I have not touched &lt;tt&gt;Memory&lt;/tt&gt; class yet.&lt;/p&gt;</comment>
                            <comment id="17935609" author="dnk" created="Fri, 14 Mar 2025 17:36:33 +0000"  >&lt;p&gt;Before touching Memory class I have decided to trace careful the logic related to it one more time to be sure that any changes in it would not cause some compatibility issues.&lt;/p&gt;

&lt;p&gt;First part: IndexSummary.offsets, serialization:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;IndexSummaryBuilder#maybeAddEntry - we start from (int) entries.length() value&lt;/li&gt;
	&lt;li&gt;&lt;br/&gt;
SafeMemoryWriter#writeInt - we write int value to SafeMemoryWriter with LE order configured&lt;/li&gt;
	&lt;li&gt;new IndexSummary(partitioner, offsets.currentBuffer().sharedCopy() - we take the underline buffer from SafeMemoryWriter as is for IndexSummary&lt;/li&gt;
	&lt;li&gt;IndexSummary.IndexSummarySerializer#serialize - we read it back using int offset = t.offsets.getInt(i * 4) + baseOffset;&lt;/li&gt;
	&lt;li&gt;We do Integer.reverseBytes to switch to native order instead of a default BE (for backward compatibility)&lt;/li&gt;
	&lt;li&gt;java.io.DataOutput#writeInt(offset) - we write int value, writer uses BE&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The table contains the tranformation during&#160; buidling + serialization to &lt;font color=&quot;#172b4d&quot;&gt;a file using 0x01_02_03_04 int value as an example.&lt;/font&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Architecture&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;1. offset as int&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2. SafeMemoryWriter&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3. IndexSummary.offsets&#160;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;4. int offsets.getInt&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;5. int reverseBytes&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;6. out.writeInt (BE) -&amp;gt; disk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;(native order)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;br/&gt;
(order != BE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01 (LE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;br/&gt;
(LE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01 (LE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE Unaligned, after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;br/&gt;
(LE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01 (LE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE Unaligned, before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;br/&gt;
(native order)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;br/&gt;
(order == BE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04(BE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&#160;&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE Aligned, after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;br/&gt;
(LE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04 (BE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE Aligned, before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04(native order)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04(native order)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;br/&gt;
(order == BE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04(BE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;If I have traced the code correctly then it looks like:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt; we had native order for offsets (the same conclusion is here - &lt;a href=&quot;https://opensource.docs.scylladb.com/stable/architecture/sstable/sstable3/sstables-3-summary.html#summary-entries&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;after&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt; (since 5.0) we have got LE order for offsets in case of unaligned architecture.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It means that we broke compatibility for offsets format in 5.0 for offsets in index summary file format. From another side we have made it machine independent &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;So, the question for this part - what do we plan to do with it.. - should we preserve the new behaviour or return back to the old one (for aligned and unaligned cases)?..&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17936012" author="dnk" created="Sun, 16 Mar 2025 12:45:34 +0000"  >&lt;p&gt;&#160;IndexSummary.entries, serialization:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;IndexSummaryBuilder#maybeAddEntry- we start with a long value&lt;/li&gt;
	&lt;li&gt;&#160;SafeMemoryWriter#writeLong - &#160;we write long value to SafeMemoryWriter with LE order configured&lt;/li&gt;
	&lt;li&gt;new IndexSummary(.., entries.currentBuffer().sharedCopy()) - we take the underline buffer from SafeMemoryWriter as is for IndexSummary&lt;/li&gt;
	&lt;li&gt;IndexSummary.IndexSummarySerializer#serialize - then we write Memory as a sequence of ByteBuffers to an output stream: out.write(t.entries, 0, t.entriesLength); MemoryUtil#getByteBuffer(long, int) - a native order buffer is used&lt;/li&gt;
	&lt;li&gt;DataOutputPlus#write(java.nio.ByteBuffer) - finally we copy the buffer content without any transformations to a stream&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;The table contains the tranformation during&#160; buidling + serialization to &lt;font color=&quot;#172b4d&quot;&gt;a file using 0x01_02_03_04 value as an example.&lt;/font&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Architecture&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;1. indexStart as primitive&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2. SafeMemoryWriter&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3. IndexSummary.entries&#160;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;4-5. out.write&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;LE&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;br/&gt;
(native = LE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01 (LE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE, after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;br/&gt;
(LE)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;0x04_03_02_01 (LE)&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;BE, before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04 (native)&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#00875a&quot;&gt;0x01_02_03_04&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;&lt;font color=&quot;#00875a&quot;&gt;&lt;/font&gt;0x01_02_03_04 (BE)&lt;/font&gt;&lt;font color=&quot;&quot;&gt;&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;For positions from entries in index summary file format: we had native order, now it is LE&lt;/p&gt;</comment>
                            <comment id="17936447" author="blambov" created="Tue, 18 Mar 2025 10:42:40 +0000"  >&lt;p&gt;The first thing we need to start with is that we can&apos;t have a machine-dependent on-disk order. Data shouldn&apos;t break if we move it from one machine type to another. If I&apos;m reading the above correctly, this is currently a problem and needs to be corrected.&lt;/p&gt;

&lt;p&gt;I personally don&apos;t have a strong preference which order to fix the data file to (x86 and arm is where we are most used, so LE makes sense; on the other hand conversion is so fast it&apos;s practically free, so switching to Java&apos;s default is not really a loss). We should pick one and then we either introduce a flag to flip it if someone runs the risk of a failure on upgrade, or, since this seems to be a problem on the index summary which is not hard to recreate, maybe recognize something&apos;s wrong on sstable load and throw away and recreate the index file.&lt;/p&gt;</comment>
                            <comment id="17937117" author="dnk" created="Thu, 20 Mar 2025 13:44:53 +0000"  >&lt;p&gt;Yes, I have the same opinion that we should not use machine-dependent on-disk order. &lt;br/&gt;
A short summary for index summary:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;before 5.0 we had native order used in index summary file format for offsets and positions in entries.&lt;/li&gt;
	&lt;li&gt;since 5.0 due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt; changes we have LE now for positions in entries (for all architectures)&lt;/li&gt;
	&lt;li&gt;since 5.0 due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt; changes we have LE now for offsets in case of LE and unaligned BE architectures and BE in case of aligned BE architectures.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;so, here the most reasonable option then is to fix the case with aligned BE architecture in case of offsets and use LE in this case as well (which actually means use LE in Memory#get/putXByByte). &lt;/p&gt;

&lt;p&gt;I am checking now BloomFilter and CompressionMetadata read/write flows.&lt;/p&gt;
</comment>
                            <comment id="17937122" author="dnk" created="Thu, 20 Mar 2025 14:01:06 +0000"  >&lt;p&gt;Bloom filter:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;write and store flow
	&lt;ul&gt;
		&lt;li&gt;org.apache.cassandra.utils.obs.OffHeapBitSet#set(long) - uses Memory.setByte(..), so it is order agnostic&lt;/li&gt;
		&lt;li&gt;org.apache.cassandra.utils.obs.OffHeapBitSet#serialize - writes to output stream memory as a sequence of buffers, by copying the buffers as is&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;load and read flow
	&lt;ul&gt;
		&lt;li&gt;org.apache.cassandra.utils.BloomFilterSerializer#deserialize - uses FBUtilities.copy(in, new MemoryOutputStream(memory), byteCount) to load memory as is from the input stream&lt;/li&gt;
		&lt;li&gt;org.apache.cassandra.utils.obs.IBitSet#get uses org.apache.cassandra.io.util.Memory#getByte, so it is order agnostic&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, it is agnostic to the memory order in Memory and it will not be affected by using LE in Memory#get/putXByByte&lt;/p&gt;</comment>
                            <comment id="17937127" author="dnk" created="Thu, 20 Mar 2025 14:21:57 +0000"  >&lt;p&gt;CompressionMetadata:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;write and store flow
	&lt;ul&gt;
		&lt;li&gt;org.apache.cassandra.io.compress.CompressionMetadata.Writer#addOffset - uses Memory.setLong();&lt;/li&gt;
		&lt;li&gt;org.apache.cassandra.io.compress.CompressionMetadata.Writer#doPrepare - we read long as a primitive value from Memory and write it to FileInputStreamPlus: out.writeLong(offsets.getLong(i * 8L));&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;load and read flow
	&lt;ul&gt;
		&lt;li&gt;org.apache.cassandra.io.compress.CompressionMetadata#readChunkOffsets - we read long as a primitive value from an input stream and set it to Memory: offsets.setLong(i * 8L, input.readLong()), where the input stream is a standard FileInputStreamPlus with BE order.&lt;/li&gt;
		&lt;li&gt;org.apache.cassandra.io.compress.CompressionMetadata#chunkFor - uses Memory.getLong(..)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case transferring of data to/from file and Memory is done using a translation to primitive long values, so the logic is agnostic to the order used inside Memory (while get/put methods are consistent in ordering). Input and output streams use BE order, so the file format is BE here.&lt;br/&gt;
So, this logic will not be affected by using LE in Memory#get/putXByByte too.&lt;/p&gt;
</comment>
                            <comment id="17937152" author="dnk" created="Thu, 20 Mar 2025 16:30:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3936&lt;/a&gt; is updated, LittleEndianMemoryUtil is added and used in Memory class&lt;/p&gt;</comment>
                            <comment id="17937952" author="dnk" created="Mon, 24 Mar 2025 16:56:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; do you think we need it in 5.0 as well or trunk is enough?&lt;/p&gt;</comment>
                            <comment id="17938145" author="blambov" created="Tue, 25 Mar 2025 08:30:37 +0000"  >&lt;p&gt;The main worry is to not break anyone who does a minor or patch version upgrade.&lt;/p&gt;

&lt;p&gt;But if I&apos;m reading this correctly, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17723&quot; title=&quot;Add support for big endian architecture (s390x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17723&quot;&gt;&lt;del&gt;CASSANDRA-17723&lt;/del&gt;&lt;/a&gt; will have changed the storage format for 5.0, possibly breaking any users on big-endian hardware in the process?&lt;/p&gt;

&lt;p&gt;If that reading is correct, we should also port this over. And if possible add some way to recognize broken order in the summary and reject &amp;amp; recreate it.&lt;/p&gt;</comment>
                            <comment id="17938570" author="michaelsembwever" created="Wed, 26 Mar 2025 11:39:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;If that reading is correct, we should also port this over. And if possible add some way to recognize broken order in the summary and reject &amp;amp; recreate it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. &#160;We want to fix 5.0, and detecting these broken index summary files and simply ignoring them and letting them be recreated makes sense. &#160;(This needs to be in trunk too, as users can ofc upgrade from &amp;lt;=5.0.3 to 5.1.)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe adding data in test/data/legacy-sstables/ and test/assertion in LegacySSTable to validate the recreation process works&#8230; ?&#160;&lt;/p&gt;</comment>
                            <comment id="17938608" author="dnk" created="Wed, 26 Mar 2025 13:10:14 +0000"  >&lt;p&gt;A possible way can be to add a heuristic check into org.apache.cassandra.io.sstable.indexsummary.IndexSummary.IndexSummarySerializer#deserialize&lt;/p&gt;

&lt;p&gt;once we loaded offsets and entries into memory we can read offsets.getInt(0) (and/or entries.getLong(..)) and check if it is suspiciously big for example by offsets.getInt(0) &amp;gt; Integer.reserveBytes(offsets.getInt(0) or a similar way and then we can throw IOException.&#160;&lt;/p&gt;

&lt;p&gt;We load summaries using the following call tree if I read the code correctly:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder#openComponents &amp;lt;-- it should rebuild the summary if it is not loaded&lt;/li&gt;
	&lt;li&gt;org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder#loadSummary &amp;lt;-- it will catch the IOException and return null as summary&lt;/li&gt;
	&lt;li&gt;org.apache.cassandra.io.sstable.format.big.IndexSummaryComponent#loadOrDeleteCorrupted&#160; &amp;lt;-- it will delete the summary file if we thrown an IOException&lt;/li&gt;
	&lt;li&gt;org.apache.cassandra.io.sstable.format.big.IndexSummaryComponent#load&lt;/li&gt;
	&lt;li&gt;org.apache.cassandra.io.sstable.indexsummary.IndexSummary.IndexSummarySerializer#deserialize&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;so, it looks like it would be the cheapest way to do such detection...&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17938622" author="michaelsembwever" created="Wed, 26 Mar 2025 14:20:19 +0000"  >&lt;p&gt;agree.&lt;/p&gt;</comment>
                            <comment id="17943379" author="dnk" created="Thu, 10 Apr 2025 22:33:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3936&lt;/a&gt; - I have added a logic to detect BE (using a heuristic) on IndexSummary loading with IndexSummary re-creation in case of if BE is detected. Test table data with BE offsets summary are added to LegacySSTableTest (I do not have a BE machine, so to emulate BE for offsets in Summary I commented temporary the following line: offset = Integer.reverseBytes(offset);&lt;br/&gt;
in org.apache.cassandra.io.sstable.indexsummary.IndexSummary.IndexSummarySerializer.serialize&lt;/p&gt;</comment>
                            <comment id="17943451" author="michaelsembwever" created="Fri, 11 Apr 2025 07:24:23 +0000"  >&lt;p&gt;Thanks for that added chunk of work to LegacySSTableTest!&lt;/p&gt;</comment>
                            <comment id="17943827" author="dnk" created="Sat, 12 Apr 2025 15:01:40 +0000"  >&lt;p&gt;Test results for trunk: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13075959/13075959_ci_summary_trunk.htm&quot; title=&quot;ci_summary_trunk.htm attached to CASSANDRA-20190&quot;&gt;ci_summary_trunk.htm&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;IndexSummaryTest.testSerialization fails correctly: in the heuristic check I forgot about the case when a sign bit is set by reverseBytes.&lt;br/&gt;
Also I have noticed that LegacySSTableTest uses data in place, so I have prepared correct data (with BE offsets) but after a local test execution I have got them fixed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&#160; It looks like I need to adjust the test to copy sstables at the beginning.&lt;/p&gt;</comment>
                            <comment id="17944331" author="dnk" created="Mon, 14 Apr 2025 11:15:06 +0000"  >&lt;p&gt;The logic which modifies test data in place is streaming test logic:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
at org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder.openComponents(BigSSTableReaderLoadingBuilder.java:127)
at org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder.openComponents(BigSSTableReaderLoadingBuilder.java:58)
at org.apache.cassandra.io.sstable.format.SSTableReaderLoadingBuilder.build(SSTableReaderLoadingBuilder.java:92)
at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:414)
at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:371)
at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:366)
at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:361)
at org.apache.cassandra.io.sstable.LegacySSTableTest.streamLegacyTable(LegacySSTableTest.java:506)
at org.apache.cassandra.io.sstable.LegacySSTableTest.streamLegacyTables(LegacySSTableTest.java:497)
at org.apache.cassandra.io.sstable.LegacySSTableTest.testStreamLegacyCqlTables(LegacySSTableTest.java:324)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17945010" author="dnk" created="Wed, 16 Apr 2025 09:22:34 +0000"  >&lt;p&gt;I have updated the heuristic check (added&#160;offsetReversed &amp;gt; 0 condition) and fixed the tests:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Test results&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076050/13076050_ci_summary_trunk_v2.htm&quot; title=&quot;ci_summary_trunk_v2.htm attached to CASSANDRA-20190&quot;&gt;ci_summary_trunk_v2.htm&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/4093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076049/13076049_ci_summary_5.0.htm&quot; title=&quot;ci_summary_5.0.htm attached to CASSANDRA-20190&quot;&gt;ci_summary_5.0.htm&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17946804" author="michaelsembwever" created="Wed, 23 Apr 2025 18:13:58 +0000"  >&lt;p&gt;additional CI runs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;5.0, post-commit profile:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076215/13076215_ci_summary_netudima_CASSANDRA-20190-5-0_217.html.download.zip&quot; title=&quot;ci_summary_netudima_CASSANDRA-20190-5-0_217.html.download.zip attached to CASSANDRA-20190&quot;&gt;ci_summary_netudima_CASSANDRA-20190-5-0_217.html.download.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076216/13076216_results_details_netudima_CASSANDRA-20190-5-0_217.tar.xz&quot; title=&quot;results_details_netudima_CASSANDRA-20190-5-0_217.tar.xz attached to CASSANDRA-20190&quot;&gt;results_details_netudima_CASSANDRA-20190-5-0_217.tar.xz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;trunk, post-commit profile:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076217/13076217_ci_summary_netudima_20190-trunk_219.html&quot; title=&quot;ci_summary_netudima_20190-trunk_219.html attached to CASSANDRA-20190&quot;&gt;ci_summary_netudima_20190-trunk_219.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13076218/13076218_results_details_netudima_20190-trunk_219.tar.xz&quot; title=&quot;results_details_netudima_20190-trunk_219.tar.xz attached to CASSANDRA-20190&quot;&gt;results_details_netudima_20190-trunk_219.tar.xz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17946805" author="michaelsembwever" created="Wed, 23 Apr 2025 18:14:56 +0000"  >&lt;p&gt;+1 &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13603365">CASSANDRA-20173</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13469433">CASSANDRA-17723</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13076049" name="ci_summary_5.0.htm" size="9402322" author="dnk" created="Wed, 16 Apr 2025 09:19:47 +0000"/>
                            <attachment id="13076217" name="ci_summary_netudima_20190-trunk_219.html" size="6365425" author="mck" created="Wed, 23 Apr 2025 18:13:59 +0000"/>
                            <attachment id="13076215" name="ci_summary_netudima_CASSANDRA-20190-5-0_217.html.download.zip" size="811544" author="mck" created="Wed, 23 Apr 2025 18:13:48 +0000"/>
                            <attachment id="13075959" name="ci_summary_trunk.htm" size="2398105" author="dnk" created="Fri, 11 Apr 2025 17:00:48 +0000"/>
                            <attachment id="13076050" name="ci_summary_trunk_v2.htm" size="2343312" author="dnk" created="Wed, 16 Apr 2025 09:21:12 +0000"/>
                            <attachment id="13076218" name="results_details_netudima_20190-trunk_219.tar.xz" size="8363548" author="mck" created="Wed, 23 Apr 2025 18:14:02 +0000"/>
                            <attachment id="13076216" name="results_details_netudima_CASSANDRA-20190-5-0_217.tar.xz" size="10203520" author="mck" created="Wed, 23 Apr 2025 18:13:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1tglc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
        <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
        <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351720">5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/ae82efc013cf0529d6156306ab1d1f4d8a9f963a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/ae82efc013cf0529d6156306ab1d1f4d8a9f963a&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;unit tests are added &lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>