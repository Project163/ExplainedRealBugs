<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:31:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20396] Test failure: CorruptedSSTablesCompactionsTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20396</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;CorruptedSSTablesCompactionsTest is failing for trunk on CI:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/2049/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/2049/&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/2044/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/2044/&lt;/a&gt;&#160;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/2043/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/2043/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;with errors like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: expected:&amp;lt;8&amp;gt; but was:&amp;lt;25&amp;gt;
	at org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.testCorruptedSSTables(CorruptedSSTablesCompactionsTest.java:267)
	at org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.testCorruptedSSTablesWithSizeTieredCompactionStrategy(CorruptedSSTablesCompactionsTest.java:146)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;note: the failure is observing for test-compression suite&lt;/p&gt;</description>
                <environment></environment>
        <key id="13610624">CASSANDRA-20396</key>
            <summary>Test failure: CorruptedSSTablesCompactionsTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="dnk">Dmitry Konstantinov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Mar 2025 18:54:00 +0000</created>
                <updated>Tue, 22 Apr 2025 11:41:16 +0000</updated>
                            <resolved>Fri, 7 Mar 2025 20:29:11 +0000</resolved>
                                        <fixVersion>5.0.5</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17932570" author="michaelsembwever" created="Wed, 5 Mar 2025 09:42:36 +0000"  >&lt;p&gt;Is this related to the disk_access_mode changes ( &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19779&quot; title=&quot;direct IO support is always evaluated to false upon the very first start of a node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19779&quot;&gt;&lt;del&gt;CASSANDRA-19779&lt;/del&gt;&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19820&quot; title=&quot;Fix tests extending FuzzTestBase when running test-compression profile&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19820&quot;&gt;&lt;del&gt;CASSANDRA-19820&lt;/del&gt;&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18464&quot; title=&quot;Enable Direct I/O For CommitLog Files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18464&quot;&gt;&lt;del&gt;CASSANDRA-18464&lt;/del&gt;&lt;/a&gt; ) ?&lt;/p&gt;</comment>
                            <comment id="17932571" author="dnk" created="Wed, 5 Mar 2025 09:49:35 +0000"  >&lt;p&gt;thank you for the links, not sure yet, I see that it is failing consistently but only for compression-test target, I want to troubleshoot it in next few days - it is the main contributor to the number of failing tests in trunk as of now. &lt;/p&gt;</comment>
                            <comment id="17932896" author="dnk" created="Thu, 6 Mar 2025 08:33:13 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; (I think I will need your review for a fix here)&lt;/p&gt;

&lt;p&gt;I have analyzed the issue - it looks like a real regression:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the test creates a set of SSTables and corrupt some of them in a random place by writing a slice of random bytes. Then major compaction is invoked multiple times: it is expected that corrupted SSTables are marked as suspected by compaction and excluded from the next invocations of compactions, so finally we exclude all corrupted SSTables and compact the remaining normal ones.&lt;/li&gt;
	&lt;li&gt;In our case the same corrupted SSTable is present again and again in each compaction causing it to fail which means the corrupted SSTable is not marked as suspected now.&lt;/li&gt;
	&lt;li&gt;the issue is observing only for &quot;test-compression&quot; Ant target execution. I have reproduced it in IDE as well by taking a single parameter from the Ant target: &lt;em&gt;-Dcassandra.test.compression=true&lt;/em&gt;. The parameter defines enables compression for SSTables (by default the test create non-compressed tables).&lt;/li&gt;
	&lt;li&gt;5.0 does not suffer from this issue. I have bisected recent commits to trunk and found then it was started: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20092&quot; title=&quot;SSTableScanner can be vastly simplified for compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20092&quot;&gt;&lt;del&gt;CASSANDRA-20092&lt;/del&gt;&lt;/a&gt;. So the new scanner logic does not mark an SSTable as corrupted when we read a bad compressed block.&lt;br/&gt;
Stacktrace of the invocation:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [CompactionExecutor:4] 2025-03-04 12:47:00,885 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:4,5,CompactionExecutor]
org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /home/cassandra/cassandra/build/test/cassandra/data/CorruptedSSTablesCompactionsTest/Standard_LCS-c39a304af8f611ef894ef9e5dfadae6d/oa-18-big-Data.db
    at org.apache.cassandra.io.util.CompressedChunkReader$Standard.readChunk(CompressedChunkReader.java:171)
    at org.apache.cassandra.cache.ChunkCache.load(ChunkCache.java:164)
    at org.apache.cassandra.cache.ChunkCache.load(ChunkCache.java:46)
    at com.github.benmanes.caffeine.cache.LocalLoadingCache.lambda$newMappingFunction$3(LocalLoadingCache.java:183)
    at com.github.benmanes.caffeine.cache.LocalCache.lambda$statsAware$2(LocalCache.java:167)
    at com.github.benmanes.caffeine.cache.BoundedLocalCache.lambda$doComputeIfAbsent$14(BoundedLocalCache.java:2688)
    at java.base/java.util.concurrent.ConcurrentHashMap.compute(ConcurrentHashMap.java:1908)
    at com.github.benmanes.caffeine.cache.BoundedLocalCache.doComputeIfAbsent(BoundedLocalCache.java:2686)
    at com.github.benmanes.caffeine.cache.BoundedLocalCache.computeIfAbsent(BoundedLocalCache.java:2669)
    at com.github.benmanes.caffeine.cache.LocalCache.computeIfAbsent(LocalCache.java:112)
    at com.github.benmanes.caffeine.cache.LocalLoadingCache.get(LocalLoadingCache.java:58)
    at org.apache.cassandra.cache.ChunkCache$CachingRebufferer.rebuffer(ChunkCache.java:232)
    at org.apache.cassandra.cache.ChunkCache$CachingRebufferer.rebuffer(ChunkCache.java:211)
    at org.apache.cassandra.io.util.RandomAccessReader.reBufferAt(RandomAccessReader.java:67)
    at org.apache.cassandra.io.util.RandomAccessReader.seek(RandomAccessReader.java:209)
    at org.apache.cassandra.io.sstable.format.SSTableSimpleScanner.advanceRange(SSTableSimpleScanner.java:162)
    at org.apache.cassandra.io.sstable.format.SSTableSimpleScanner.hasNext(SSTableSimpleScanner.java:146)

    at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:375)
    at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:187)
    at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:156)
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
    at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$2.hasNext(UnfilteredPartitionIterators.java:201)
    at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:90)
    at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:304)
    at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:256)
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:26)
    at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:90)
    at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:110)
    at org.apache.cassandra.db.compaction.CompactionManager$9.runMayThrow(CompactionManager.java:1166)
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:26)
    at org.apache.cassandra.concurrent.FutureTask$3.call(FutureTask.java:141)
    at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61)
    at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71)
    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
    at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
    at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
Caused by: org.apache.cassandra.io.compress.CorruptBlockException: (/home/cassandra/cassandra/build/test/cassandra/data/CorruptedSSTablesCompactionsTest/Standard_LCS-c39a304af8f611ef894ef9e5dfadae6d/oa-18-big-Data.db): corruption detected, chunk at 0 of length 167.
    at org.apache.cassandra.io.util.CompressedChunkReader$Standard.readChunk(CompressedChunkReader.java:133)
    ... 36 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;vs the old scanner stacktrace for the same case where we did the marking:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;CompactionExecutor:1@7879&quot;&lt;/span&gt; daemon prio=5 tid=0x29 nid=NA runnable
  java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
      at org.apache.cassandra.io.sstable.format.SSTableReader.markSuspect(SSTableReader.java:915)
      at org.apache.cassandra.io.sstable.format.SSTableScanner$BaseKeyScanningIterator.computeNext(SSTableScanner.java:294)
      at org.apache.cassandra.io.sstable.format.SSTableScanner$BaseKeyScanningIterator.computeNext(SSTableScanner.java:244)
      at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
      at org.apache.cassandra.io.sstable.format.SSTableScanner.hasNext(SSTableScanner.java:206)

      at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:375)
      at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:187)
      at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:156)
      at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
      at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$2.hasNext(UnfilteredPartitionIterators.java:201)
      at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:90)
      at org.apache.cassandra.db.compaction.CompactionIterator.hasNext(CompactionIterator.java:304)
      at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:206)
      at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:26)
      at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:86)
      at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:100)
      at org.apache.cassandra.db.compaction.CompactionManager$9.runMayThrow(CompactionManager.java:1039)
      at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:26)
      at org.apache.cassandra.concurrent.FutureTask$3.call(FutureTask.java:141)
      at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61)
      at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71)
      at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
      at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
      at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
      at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:840)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;More specifically we do not process CorruptSSTableException thrown by dfile.seek() in org.apache.cassandra.io.sstable.format.SSTableSimpleScanner#advanceRange&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I am preparing a patch for the issue and going to share it soon.&lt;/p&gt;</comment>
                            <comment id="17932897" author="dnk" created="Thu, 6 Mar 2025 08:38:08 +0000"  >&lt;p&gt;There is one more issue which I noticed in the test. It does not cause the test failure and it is observed even before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20092&quot; title=&quot;SSTableScanner can be vastly simplified for compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20092&quot;&gt;&lt;del&gt;CASSANDRA-20092&lt;/del&gt;&lt;/a&gt; changes. We have a pool buffer leak reported:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Reference-Reaper] 2025-03-04 12:47:00,906 LEAK DETECTED: a reference (@2027340356) to @2027340356 was not released before the reference was garbage collected
ERROR [Reference-Reaper] 2025-03-04 12:47:00,907 Allocate trace @2027340356:
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[main,5,main]
    at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.getStackTrace(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1602)
    at org.apache.cassandra.utils.concurrent.Ref$Debug.&amp;lt;init&amp;gt;(Ref.java:273)
    at org.apache.cassandra.utils.concurrent.Ref$State.&amp;lt;init&amp;gt;(Ref.java:194)
    at org.apache.cassandra.utils.concurrent.Ref.&amp;lt;init&amp;gt;(Ref.java:116)
    at org.apache.cassandra.utils.concurrent.Ref$DirectBufferRef.&amp;lt;init&amp;gt;(Ref.java:810)
    at org.apache.cassandra.utils.memory.BufferPool$Chunk.setAttachment(BufferPool.java:1334)
    at org.apache.cassandra.utils.memory.BufferPool$Chunk.set(BufferPool.java:1474)
    at org.apache.cassandra.utils.memory.BufferPool$Chunk.get(BufferPool.java:1464)
    at org.apache.cassandra.utils.memory.BufferPool$MicroQueueOfChunks.get(BufferPool.java:635)
    at org.apache.cassandra.utils.memory.BufferPool$LocalPool.tryGetInternal(BufferPool.java:963)
    at org.apache.cassandra.utils.memory.BufferPool$LocalPool.tryGet(BufferPool.java:946)
    at org.apache.cassandra.utils.memory.BufferPool$LocalPool.get(BufferPool.java:906)
    at org.apache.cassandra.utils.memory.BufferPool$LocalPool.get(BufferPool.java:896)
    at org.apache.cassandra.utils.memory.BufferPool.get(BufferPool.java:211)
    at org.apache.cassandra.cache.ChunkCache.load(ChunkCache.java:162)
    at org.apache.cassandra.cache.ChunkCache.load(ChunkCache.java:46)
    at com.github.benmanes.caffeine.cache.LocalLoadingCache.lambda$newMappingFunction$3(LocalLoadingCache.java:183)
    at com.github.benmanes.caffeine.cache.LocalCache.lambda$statsAware$2(LocalCache.java:167)
    at com.github.benmanes.caffeine.cache.BoundedLocalCache.lambda$doComputeIfAbsent$14(BoundedLocalCache.java:2688)
    at java.base/java.util.concurrent.ConcurrentHashMap.compute(ConcurrentHashMap.java:1908)
    at com.github.benmanes.caffeine.cache.BoundedLocalCache.doComputeIfAbsent(BoundedLocalCache.java:2686)
    at com.github.benmanes.caffeine.cache.BoundedLocalCache.computeIfAbsent(BoundedLocalCache.java:2669)
    at com.github.benmanes.caffeine.cache.LocalCache.computeIfAbsent(LocalCache.java:112)
    at com.github.benmanes.caffeine.cache.LocalLoadingCache.get(LocalLoadingCache.java:58)
    at org.apache.cassandra.cache.ChunkCache$CachingRebufferer.rebuffer(ChunkCache.java:232)
    at org.apache.cassandra.cache.ChunkCache$CachingRebufferer.rebuffer(ChunkCache.java:211)
    at org.apache.cassandra.io.util.RandomAccessReader.reBufferAt(RandomAccessReader.java:67)
    at org.apache.cassandra.io.util.RandomAccessReader.seek(RandomAccessReader.java:209)
    at org.apache.cassandra.io.sstable.format.SSTableSimpleScanner.advanceRange(SSTableSimpleScanner.java:162)
    at org.apache.cassandra.io.sstable.format.SSTableSimpleScanner.hasNext(SSTableSimpleScanner.java:146)
    at org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.readsWithoutError(CorruptedSSTablesCompactionsTest.java:280)
    at org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.testCorruptedSSTables(CorruptedSSTablesCompactionsTest.java:241)
    at org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.testCorruptedSSTablesWithLeveledCompactionStrategy(CorruptedSSTablesCompactionsTest.java:152)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In org.apache.cassandra.cache.ChunkCache#load if we have an exception thrown by readChunk method the buffer is leaking:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        ByteBuffer buffer = bufferPool.get(key.file.chunkSize(), key.file.preferredBufferType());
        key.file.readChunk(key.position, buffer);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will add handling of this case to the fix as well.&lt;/p&gt;</comment>
                            <comment id="17932915" author="dnk" created="Thu, 6 Mar 2025 09:29:11 +0000"  >&lt;p&gt;MR: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3958&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3958&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17933041" author="dnk" created="Thu, 6 Mar 2025 15:40:51 +0000"  >&lt;p&gt;I checked similar places in SSTableSimpleScanner proximity and probably we also need to add a logic like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (CorruptSSTableException e) &lt;span class=&quot;code-comment&quot;&gt;// to ensure that we marked the sstable as suspected
&lt;/span&gt;{
    sstable.markSuspect();
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to org.apache.cassandra.io.sstable.SSTableIdentityIterator#create() because it does reads and we can throw CorruptSSTableException from org.apache.cassandra.io.util.CompressedChunkReader.Standard#readChunk() but we do not invoke markSuspect on that level.&lt;/p&gt;

&lt;p&gt;An alternative can be not covert CorruptBlockException (which is IOException) to CorruptSSTableException within CompressedChunkReader.Standard#readChunk but I am not sure about a global impact for this change..&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17933436" author="dnk" created="Fri, 7 Mar 2025 20:01:13 +0000"  >&lt;p&gt;There is +1 from Branimir in &lt;a href=&quot;https://github.com/apache/cassandra/pull/3958&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3958&lt;/a&gt;&lt;br/&gt;
CI test results (&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/174/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13075317/13075317_ci_summary.html&quot; title=&quot;ci_summary.html attached to CASSANDRA-20396&quot;&gt;ci_summary.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13075318/13075318_results_details.tar.xz&quot; title=&quot;results_details.tar.xz attached to CASSANDRA-20396&quot;&gt;results_details.tar.xz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Failures:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Tests / test-latest jdk11 1/16 / org.apache.cassandra.db.commitlog.BatchCommitLogTest.testBatchCLShutDownImmediately&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;-latest_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;Tests / test-latest jdk11 8/16 / org.apache.cassandra.transport.CQLUserAuditTest.loginSuccessfulTest-latest_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;Tests / test-latest jdk11 8/16 / org.apache.cassandra.transport.CQLUserAuditTest.prepareStmt-latest_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;Tests / test-latest jdk11 8/16 / org.apache.cassandra.transport.CQLUserAuditTest.queryBatch-latest_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;Tests / test-latest jdk11 8/16 / org.apache.cassandra.transport.CQLUserAuditTest.queryInsert-latest_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;Tests / test-latest jdk11 8/16 / org.apache.cassandra.transport.CQLUserAuditTest.querySimpleSelect-latest_jdk11_x86_64&lt;/li&gt;
	&lt;li&gt;fuzz.sai.MultiNodeSAITest mixedFilteringSaiTest-cassandra.testtag_IS_UNDEFINED&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;they are flaky:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;CQLUserAuditTest is reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19165&quot; title=&quot;Test Failure: org.apache.cassandra.transport.CQLUserAuditTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19165&quot;&gt;CASSANDRA-19165&lt;/a&gt; + the test is passed locally&lt;/li&gt;
	&lt;li&gt;BatchCommitLogTest fails in trunk sometimes too (for example: &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/2054/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/2054/#showFailuresLink&lt;/a&gt;) + the test is passed locally - to analyze flakiness: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19101&quot; title=&quot;Test Failure: org.apache.cassandra.db.commitlog.CommitlogShutdownTest failed on trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19101&quot;&gt;&lt;del&gt;CASSANDRA-19101&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;MultiNodeSAITest is reported as flaky in other recent JIRA tickets + fails sometimes in trunk (for example: &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/2054/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/2054/#showFailuresLink&lt;/a&gt;) + the test is passed locally&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13599241">CASSANDRA-20092</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13075319" name="BatchCommitLogTest_flaky_proof.png" size="517936" author="dnk" created="Fri, 7 Mar 2025 19:58:38 +0000"/>
                            <attachment id="13075226" name="TEST-org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.log.xz" size="34356" author="dnk" created="Tue, 4 Mar 2025 18:53:24 +0000"/>
                            <attachment id="13075227" name="TEST-org.apache.cassandra.db.compaction.CorruptedSSTablesCompactionsTest.xml.xz" size="43012" author="dnk" created="Tue, 4 Mar 2025 18:53:24 +0000"/>
                            <attachment id="13075317" name="ci_summary.html" size="1121957" author="dnk" created="Fri, 7 Mar 2025 19:53:02 +0000"/>
                            <attachment id="13075228" name="image-2025-03-04-21-46-34-829.png" size="517526" author="dnk" created="Tue, 4 Mar 2025 18:46:36 +0000"/>
                            <attachment id="13075318" name="results_details.tar.xz" size="1649728" author="dnk" created="Fri, 7 Mar 2025 19:53:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ukhc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
        <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353509">5.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/db38529ab801bfc801b07c7fd53db126dfc49a17&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/db38529ab801bfc801b07c7fd53db126dfc49a17&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;an existing test is failing&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>