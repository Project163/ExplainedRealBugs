<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3181] Compaction fails to occur</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3181</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Compaction just stops running at some point.  To repro, insert like 20M rows with a 1G heap and you&apos;ll get around 1k sstables.  Restarting doesn&apos;t help, you have to invoke a major to get anything to happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522759">CASSANDRA-3181</key>
            <summary>Compaction fails to occur</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Mon, 12 Sep 2011 15:51:23 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:51 +0000</updated>
                            <resolved>Wed, 14 Sep 2011 01:27:27 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13102751" author="brandon.williams" created="Mon, 12 Sep 2011 15:51:52 +0000"  >&lt;p&gt;Note that this is with the default compaction strategy.&lt;/p&gt;</comment>
                            <comment id="13103334" author="bcoverston" created="Tue, 13 Sep 2011 04:30:43 +0000"  >&lt;p&gt;Tested this a bit and I was able to reproduce the problem.&lt;/p&gt;

&lt;p&gt;Basically what I think happened was:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;There were compactions in-flight and scheduled.&lt;/li&gt;
	&lt;li&gt;Something happened to halt the compactions (probably restarted the server)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2444&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-2444&lt;/a&gt; got in the way&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I propose one of the following: &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;add option in as originally proposed&lt;br/&gt;
OR&lt;/li&gt;
	&lt;li&gt;put compactions on a timer and ask periodically `does any compaction need to be done`. Also stagger the start of the compactions by some variable amount (5-10 minutes) similar to what we did with Hinted Handoff in 0.7.&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="13103821" author="slebresne" created="Tue, 13 Sep 2011 17:43:32 +0000"  >&lt;p&gt;What is unclear is what did stop the compactions from happening ? Because Brandon said that restarting didn&apos;t helped, but I get from that that compaction stopped before the restart. Basically, if the only thing that happened is &quot;after a restart, if you don&apos;t do any inserts, no compaction happens&quot;, then ok, that&apos;s not a big deal. But if it is indeed that &quot;Compaction just stops running at some point&quot;, then there is something that we need to fix.&lt;/p&gt;</comment>
                            <comment id="13103826" author="bcoverston" created="Tue, 13 Sep 2011 17:50:09 +0000"  >&lt;p&gt;From his repro I was able to get compactions going again with a simple write/flush.&lt;/p&gt;

&lt;p&gt;From Brandon, he&apos;s not sure how compactions stopped. There are only two scenarios where I see compactions stopping like this with the tiered compaction strategy:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;the server was restarted&lt;/li&gt;
	&lt;li&gt;a compaction failed unexpectedly&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The fact that there were no errors in the log makes #2 unlikely. I&apos;m pretty sure that we&apos;re just looking at a problem where a server restarts and there is no more activity triggering a flush.&lt;/p&gt;</comment>
                            <comment id="13103827" author="brandon.williams" created="Tue, 13 Sep 2011 17:50:44 +0000"  >&lt;p&gt;What started all this is my attempt at running repair.  So I think repair was blocking minors, but then I ran into countless other issues (like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3179&quot; title=&quot;JVM segfaults&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3179&quot;&gt;&lt;del&gt;CASSANDRA-3179&lt;/del&gt;&lt;/a&gt;) and was forced to restart.&lt;/p&gt;</comment>
                            <comment id="13103949" author="slebresne" created="Tue, 13 Sep 2011 20:09:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;. So I think repair was blocking minors&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;repair should be on its own executor now, so it shouldn&apos;t block minors.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;a compaction failed unexpectedly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;hum, a compaction failing shouldn&apos;t stop other compactions. Otherwise this is worth fixing.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m pretty sure that we&apos;re just looking at a problem where a server restarts and there is no more activity triggering a flush&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If that&apos;s the case, then is there really much we want to do ? And even if we want, we should move that to 1.0.1. Just want to make sure this doesn&apos;t hide a real, unknown,  problem.&lt;/p&gt;</comment>
                            <comment id="13103950" author="brandon.williams" created="Tue, 13 Sep 2011 20:15:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;repair should be on its own executor now, so it shouldn&apos;t block minors.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, then maybe I just hit one of the OOM bugs, and compaction had never fully completed.  After restarting I never did any more writes, and we know compaction won&apos;t happen at startup.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If that&apos;s the case, then is there really much we want to do ? And even if we want, we should move that to 1.0.1. Just want to make sure this doesn&apos;t hide a real, unknown, problem.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2444&quot; title=&quot;Remove checkAllColumnFamilies on startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2444&quot;&gt;&lt;del&gt;CASSANDRA-2444&lt;/del&gt;&lt;/a&gt; was wrong.  It should be an option, and one that is off by default.  Starting a server with 1k sstables and having nothing happen is a bit of a shock, and having no way out of it besides hacks like forcing a flush or a major isn&apos;t great.&lt;/p&gt;</comment>
                            <comment id="13103952" author="jbellis" created="Tue, 13 Sep 2011 20:16:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2444&quot; title=&quot;Remove checkAllColumnFamilies on startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2444&quot;&gt;&lt;del&gt;CASSANDRA-2444&lt;/del&gt;&lt;/a&gt; got in the way&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure what the right solution is here.  I buy the premise of 2444 that you don&apos;t necessarily want to get hammered by compaction when you&apos;re first starting up (warming up caches).  So I don&apos;t think &quot;check for compactions ever N seconds&quot; is a great policy.  But, I&apos;m not sure &quot;check every N seconds, starting M minutes after startup&quot; is great either because it&apos;s not something a user will just guess when he&apos;s wondering &quot;why aren&apos;t compactions happening yet?&quot;&lt;/p&gt;

&lt;p&gt;Any other ideas?&lt;/p&gt;</comment>
                            <comment id="13104032" author="jbellis" created="Tue, 13 Sep 2011 22:03:20 +0000"  >&lt;p&gt;Attached patch does a couple things:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Schedules a compaction submission for each CFS 5 minutes after startup.  My reasoning is, five minutes is (a) enough time for most caches to warm up under load and (b) when it is not, at least it is enough time to reduce the compaction i/o limit.&lt;/li&gt;
	&lt;li&gt;removes the permanent check-for-compactions-every-3s task from leveled compaction; I don&apos;t like spinning that up for no reason, when we already kick off a check on each flush and end-of-compaction, which should be adequate.  (Every 3s for 1 CFS = every 0.0003s for 10K CFS.)&lt;/li&gt;
	&lt;li&gt;makes Leveled getMaximal return a &quot;normal, leveling&quot; compaction, if any needs to be done, allowing users of leveldb compaction to kick things off earlier than 5m via &quot;nodetool compact,&quot; if desired&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13104059" author="bcoverston" created="Tue, 13 Sep 2011 22:48:47 +0000"  >&lt;p&gt;Was a little concerned about removing the scheduled compaction from leveldb, but the mechanics are really no different from the tiered compaction in terms of &quot;it will stop when it&apos;s finished&quot; assuming that nothing goes wrong with the running compactions.&lt;/p&gt;

&lt;p&gt;To be (probably overly) pedantic another advantage this has is that you are essentially kicking off only a single compaction where when the server was brought down there were probably multiple compactions in flight.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;
</comment>
                            <comment id="13104144" author="jbellis" created="Wed, 14 Sep 2011 01:27:27 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13104478" author="jbellis" created="Wed, 14 Sep 2011 13:14:15 +0000"  >&lt;p&gt;patch to keep shutdown from waiting for the compaction kickoff&lt;/p&gt;</comment>
                            <comment id="13104481" author="slebresne" created="Wed, 14 Sep 2011 13:18:46 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13104492" author="jbellis" created="Wed, 14 Sep 2011 13:32:33 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12494442" name="3181-2.txt" size="6162" author="jbellis" created="Wed, 14 Sep 2011 13:14:15 +0000"/>
                            <attachment id="12494333" name="3181.txt" size="4016" author="jbellis" created="Tue, 13 Sep 2011 22:03:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4036</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ggsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94150</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>bcoverston</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bcoverston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>