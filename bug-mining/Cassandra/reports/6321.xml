<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18841] InstanceClassLoader leak in 5.0/trunk</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18841</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Something in the 5.0/trunk branches has caused an in-jvm dtest InstanceClassLoader leak - it appears to have something to do with the Mutual TLS Authenticator (f078c02cb58bddd735490b07548f7352f0eb09aa) but nothing in that commit, so far, has stood out as causing issues.&lt;/p&gt;

&lt;p&gt;The culprit class appears to be &lt;tt&gt;io.netty.util.internal.InternalThreadLocalMap&lt;/tt&gt;, which seems to no be removed when the threads stops for some reason.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13550381">CASSANDRA-18841</key>
            <summary>InstanceClassLoader leak in 5.0/trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="drohrer">Doug Rohrer</assignee>
                                    <reporter username="drohrer">Doug Rohrer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Sep 2023 14:55:10 +0000</created>
                <updated>Wed, 1 Nov 2023 08:54:50 +0000</updated>
                            <resolved>Fri, 15 Sep 2023 20:17:25 +0000</resolved>
                                        <fixVersion>4.1.4</fixVersion>
                    <fixVersion>5.0-alpha2</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17764884" author="drohrer" created="Wed, 13 Sep 2023 21:14:32 +0000"  >&lt;p&gt;Note I believe this patch should &lt;em&gt;also&lt;/em&gt; be applied to 4.1 as the same bug is there, it just hasn&apos;t been hit because the code that is called in &lt;tt&gt;postStartup&lt;/tt&gt; today doesn&apos;t tickle the particular issue (it requires hitting something that uses a &lt;tt&gt;ThreadLocal&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17764886" author="drohrer" created="Wed, 13 Sep 2023 21:21:01 +0000"  >&lt;p&gt;The patch should apply cleanly (or be easy enough to apply) to all branches - I can submit PRs if necessary tomorrow.&lt;/p&gt;</comment>
                            <comment id="17764893" author="frankgh" created="Wed, 13 Sep 2023 22:15:15 +0000"  >&lt;p&gt;Taking a look at the patch, and it doesn&apos;t seem like &lt;tt&gt;runsOnInstance&lt;/tt&gt; was called previously: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/distributed/org/apache/cassandra/distributed/impl/Instance.java#L813&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/test/distributed/org/apache/cassandra/distributed/impl/Instance.java#L813&lt;/a&gt; I wonder if that&apos;s something you&apos;ve added interim as you were testing the fix?&lt;/p&gt;</comment>
                            <comment id="17764929" author="drohrer" created="Thu, 14 Sep 2023 01:06:44 +0000"  >&lt;p&gt;Yeah - not sure why the runsOnInstance is there in the patch - it&apos;s really just wrapping the call in &lt;tt&gt;sync&lt;/tt&gt; - I&apos;ll update it to make sure it&apos;s clean in the morning.&lt;/p&gt;

&lt;p&gt;Some more context as to why this fixed the problem we saw, there was some new code added in the above-mentioned commit that eventually creates a new instance of a &lt;tt&gt;o.netty.util.internal.InternalThreadLocalMap&lt;/tt&gt; with the instance class loader, but in the main thread. By calling &lt;tt&gt;sync&lt;/tt&gt; we execute the code on the instance&apos;s executor thread so when the instance is shut down the &lt;tt&gt;InternalThreadLocalMap&lt;/tt&gt; is removed appropriately.&lt;/p&gt;</comment>
                            <comment id="17765159" author="drohrer" created="Thu, 14 Sep 2023 12:40:54 +0000"  >&lt;p&gt;Updated the patch - no idea how it got what it did in there, but I was in fact trying to grok the difference between `sync` and `runsOnInstance` earlier when I was working on the fix so maybe Git ended up in some weird state.&lt;/p&gt;</comment>
                            <comment id="17765169" author="drohrer" created="Thu, 14 Sep 2023 13:06:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2686&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2686&lt;/a&gt; in case you like GitHub better than a patch.&lt;/p&gt;</comment>
                            <comment id="17765251" author="frankgh" created="Thu, 14 Sep 2023 16:16:39 +0000"  >&lt;p&gt;+1 (nb) on the patch. We&apos;ll probably need this all the way down to 4.1&lt;/p&gt;</comment>
                            <comment id="17765356" author="jonmeredith" created="Thu, 14 Sep 2023 20:45:20 +0000"  >&lt;p&gt;+1 from me, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; do you have time to review this small PR as it&apos;s just a cleanup found after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18725&quot; title=&quot;IsolatedJMX should not release all TCPEndpoints on instance shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18725&quot;&gt;&lt;del&gt;CASSANDRA-18725&lt;/del&gt;&lt;/a&gt; that you helped review. I&apos;ll start a CI run.&lt;/p&gt;</comment>
                            <comment id="17765364" author="jonmeredith" created="Thu, 14 Sep 2023 21:14:05 +0000"  >&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jonmeredith/cassandra/tree/commit_remote_branch/CASSANDRA-18841-cassandra-4.1-CC040354-8525-4D6E-B4FF-002AF85C683A&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jonmeredith/cassandra?branch=commit_remote_branch%2FCASSANDRA-18841-cassandra-4.1-CC040354-8525-4D6E-B4FF-002AF85C683A&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2592/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-5.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jonmeredith/cassandra/tree/commit_remote_branch/CASSANDRA-18841-cassandra-5.0-CC040354-8525-4D6E-B4FF-002AF85C683A&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jonmeredith/cassandra?branch=commit_remote_branch%2FCASSANDRA-18841-cassandra-5.0-CC040354-8525-4D6E-B4FF-002AF85C683A&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2593/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jonmeredith/cassandra/tree/commit_remote_branch/CASSANDRA-18841-trunk-CC040354-8525-4D6E-B4FF-002AF85C683A&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jonmeredith/cassandra?branch=commit_remote_branch%2FCASSANDRA-18841-trunk-CC040354-8525-4D6E-B4FF-002AF85C683A&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2594/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17765729" author="dcapwell" created="Fri, 15 Sep 2023 16:53:23 +0000"  >&lt;p&gt;I am +1 but feel that if this patch is actually needed then don&apos;t we have more places that are problematic?&lt;/p&gt;

&lt;p&gt;org.apache.cassandra.distributed.impl.Instance#schemaVersion&lt;br/&gt;
org.apache.cassandra.distributed.impl.Instance#getMessagingVersion&lt;br/&gt;
org.apache.cassandra.distributed.impl.Instance#setMessagingVersion&lt;br/&gt;
org.apache.cassandra.distributed.impl.Instance#getReleaseVersionString&lt;br/&gt;
org.apache.cassandra.distributed.impl.Instance#flush&lt;br/&gt;
org.apache.cassandra.distributed.impl.Instance#forceCompact&lt;br/&gt;
org.apache.cassandra.distributed.impl.Instance#executorFor&lt;/p&gt;</comment>
                            <comment id="17765836" author="jonmeredith" created="Fri, 15 Sep 2023 20:16:02 +0000"  >&lt;p&gt;Thanks for the review, and the extra info. I&apos;ve gone ahead and merged to make testing the sidecar easier, we can follow up with a new JIRA for the other items once investigated.&lt;/p&gt;</comment>
                            <comment id="17765844" author="drohrer" created="Fri, 15 Sep 2023 20:28:22 +0000"  >&lt;p&gt;Yeah - I agree that there are clearly other places where we probably need a &lt;tt&gt;sync&lt;/tt&gt; call, or even if we don&apos;t &lt;ins&gt;technically&lt;/ins&gt; need one now, not having them opens us up to repeats of this particular bug if something deep in the bowls of one of those calls ends up touching a thread local variable, so it would be good to review the other non-&lt;tt&gt;sync&lt;/tt&gt; ed methods, and perhaps provide some guidance on when we can skip calling &lt;tt&gt;sync&lt;/tt&gt; (maybe almost never?)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13062909" name="trunk_ThreadLocal_leak.patch" size="1213" author="drohrer" created="Thu, 14 Sep 2023 13:06:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[drohrer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12995" cascade-level="1"><![CDATA[Resource Management]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kb3s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[frankgh]]></customfieldvalue>
        <customfieldvalue><![CDATA[jonmeredith]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351787">4.1-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/8bfe0e5878c64ed25591aae50643187bc8ab7241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/8bfe0e5878c64ed25591aae50643187bc8ab7241&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Run &lt;tt&gt;ResourceLeakTest#looperTest&lt;/tt&gt; after increasing the number of loops to 100 - without the patch, this will fail on 5.0 and trunk long before you get to 100 iterations.&lt;/p&gt;

&lt;p&gt;With the patch, it should reach 100.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>