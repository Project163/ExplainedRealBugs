<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8490] DISTINCT queries with LIMITs or paging are incorrect when partitions are deleted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8490</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Using paging demo code from &lt;a href=&quot;https://github.com/PatrickCallaghan/datastax-paging-demo&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/PatrickCallaghan/datastax-paging-demo&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The code creates and populates a table with 1000 entries and pages through them with setFetchSize set to 100. If we then delete one entry with &apos;cqlsh&apos;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:datastax_paging_demo&amp;gt; delete from datastax_paging_demo.products  where productId = &apos;P142&apos;; (The specified productid is number 6 in the resultset.)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and run the same query (&quot;Select * from&quot;) again we get:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[com.datastax.paging.Main.main()] INFO  com.datastax.paging.Main - Paging demo took 0 secs. Total Products : 999
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is what we would expect.&lt;/p&gt;


&lt;p&gt;If we then change the &quot;select&quot; statement in dao/ProductDao.java (line 70) from &quot;Select * from &quot; to &quot;Select DISTINCT productid from &quot; we get this result:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[com.datastax.paging.Main.main()] INFO  com.datastax.paging.Main - Paging demo took 0 secs. Total Products : 99
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it looks like the tombstone stops the paging behaviour. Is this a bug?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [Native-Transport-Requests:788] 2014-12-16 10:09:13,431 Message.java (line 319) Received: QUERY Select DISTINCT productid from datastax_paging_demo.products, v=2
DEBUG [Native-Transport-Requests:788] 2014-12-16 10:09:13,434 AbstractQueryPager.java (line 98) Fetched 99 live rows
DEBUG [Native-Transport-Requests:788] 2014-12-16 10:09:13,434 AbstractQueryPager.java (line 115) Got result (99) smaller than page size (100), considering pager exhausted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Driver version: 2.1.3.&lt;br/&gt;
Cassandra version: 2.0.11/2.1.2.&lt;/p&gt;</environment>
        <key id="12761982">CASSANDRA-8490</key>
            <summary>DISTINCT queries with LIMITs or paging are incorrect when partitions are deleted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="franklimstrand">Frank Limstrand</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Dec 2014 09:13:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:25 +0000</updated>
                            <resolved>Fri, 9 Jan 2015 17:23:20 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14249229" author="thobbs" created="Wed, 17 Dec 2014 00:46:22 +0000"  >&lt;p&gt;I was able to reproduce on the latest cassandra-2.1.  This does appear to be limited to &lt;tt&gt;SELECT DISTINCT&lt;/tt&gt; queries on the partition key.&lt;/p&gt;</comment>
                            <comment id="14250824" author="thobbs" created="Wed, 17 Dec 2014 23:41:14 +0000"  >&lt;p&gt;This is a tricky one.  It affects both DISTINCT queries with paging and DISTINCT queries with limits.&lt;/p&gt;

&lt;p&gt;The root of the problem is that ColumnFamilyStore.filter() counts tombstoned partitions towards the row limit.  This is the correct behavior for Thrift compatibility, but is not the correct behavior for CQL3 queries.  Normal CQL3 queries don&apos;t have this problem, but DISTINCT queries are treated differently: countCQL3Rows is false, and we use the row (partition) limit instead of a cql3 row limit (the &quot;column&quot; limit).&lt;/p&gt;

&lt;p&gt;Due to the way that range commands are serialized (and versioned), we can&apos;t add a field or flag within a minor Cassandra version, so there&apos;s not a great way to indicate to replicas that tombstoned partitions should not count towards the limit (i.e. we want cql3 behavior). That leaves us with a few choices:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Never count tombstoned partitions towards the limit, and trim excess partitions on the coordinator.  This would be fine for CQL3, but for Thrift, replicas could end up sending the coordinator a lot of extra partitions if there are a lot of partition tombstones.&lt;/li&gt;
	&lt;li&gt;Add a new, optional flag to the range command serialization format (keeping in mind the new &lt;tt&gt;countCQL3Rows&lt;/tt&gt; flag in 2.1) or do something like use a special &lt;tt&gt;compositesToGroup()&lt;/tt&gt; value of -2  to signal that tombstoned partitions should not count towards the limit. The main problem with this is upgrades to 2.1.  There would be a window of 2.1 versions where upgrading from 2.0.12 would break these queries.  This is a pretty hacky option.&lt;/li&gt;
	&lt;li&gt;Leave &lt;tt&gt;DISTINCT ... LIMIT&lt;/tt&gt; queries broken, but partially fix the paging situation by only considering the query exhausted when the count of all rows in the fetch page (not just live ones) is less than the page size.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;?  (P.S. I can&apos;t wait for your refactor &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ).&lt;/p&gt;</comment>
                            <comment id="14264665" author="slebresne" created="Mon, 5 Jan 2015 15:18:56 +0000"  >&lt;p&gt;It is indeed annoying.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Never count tombstoned partitions towards the limit, and trim excess partitions on the coordinator&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As you said, this could theortically backfire for thrift and I&apos;d rather not take the risk unless we really have no better option.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Leave DISTINCT ... LIMIT queries broken, but partially fix the paging situation by only considering the query exhausted when the count of all rows in the fetch page&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s easy to do, and it almost surely won&apos;t have much noticeable drawbacks. But it only solve half of the problem ...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Add a new, optional flag to the range command serialization format (keeping in mind the new countCQL3Rows flag in 2.1) or do something like use a special compositesToGroup() value of -2 to signal that tombstoned partitions should not count towards the limit&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think using -2 for &lt;tt&gt;compositesToGroup&lt;/tt&gt; might actually have my preference. It&apos;s clearly hacky but it fixes the problem for both limit and paging and can be applied to 2.0 and 2.1 without breaking backward compatibility as far as I can tell. And while it&apos;s true that going form a 2.0 with this fix to a 2.1 without this fix would &quot;break&quot; those queries, it&apos;s really not specific to this issue. Besides, upgrading to 2.1 with a version that is older than your last upgrade of 2.0 is asking for trouble imo.&lt;/p&gt;</comment>
                            <comment id="14268536" author="thobbs" created="Wed, 7 Jan 2015 23:53:25 +0000"  >&lt;p&gt;Okay, the attached patches take the approach of using -2 for &lt;tt&gt;compositesToGroup()&lt;/tt&gt;.  I&apos;ve also pushed a &lt;a href=&quot;https://github.com/thobbs/cassandra-dtest/tree/CASSANDRA-8490&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14269347" author="slebresne" created="Thu, 8 Jan 2015 14:24:28 +0000"  >&lt;p&gt;I don&apos;t think the logic in CFS is the one we want because:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;while we don&apos;t want to count tombstoned partition towards the limit, we probably shouldn&apos;t skip them from the result since they may shadow data from another node.&lt;/li&gt;
	&lt;li&gt;we want to skip (not count) partition that have no live data, but that also means partition with only tombstones, so I think we should use &lt;tt&gt;CF.hasOnlyTombstones(now)&lt;/tt&gt; instead of &lt;tt&gt;CF.isMarkedForDelete()&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So I think the logic should something along the lines of:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;rows.add(new Row(rawRow.key, data));
if (!ignoreTombstonedPartitions || !data.hasOnlyTombstones(filter.timestamp))
    matched++;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The rest lgtm, so +1 with that change if we agree on it.&lt;/p&gt;</comment>
                            <comment id="14269959" author="thobbs" created="Thu, 8 Jan 2015 19:57:24 +0000"  >&lt;p&gt;Ah, good point.  The v2 patch makes the suggested change and also updates StorageProxy to properly handle counting/trimming the rows for this case.&lt;/p&gt;</comment>
                            <comment id="14270824" author="slebresne" created="Fri, 9 Jan 2015 09:59:20 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14271560" author="thobbs" created="Fri, 9 Jan 2015 17:23:20 +0000"  >&lt;p&gt;Thanks, committed as dd62f7bf7.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12690924" name="8490-2.0-v2.txt" size="8454" author="thobbs" created="Thu, 8 Jan 2015 19:57:24 +0000"/>
                            <attachment id="12690663" name="8490-2.0.txt" size="5186" author="thobbs" created="Wed, 7 Jan 2015 23:53:25 +0000"/>
                            <attachment id="12690925" name="8490-trunk-v2.txt" size="9644" author="thobbs" created="Thu, 8 Jan 2015 19:57:24 +0000"/>
                            <attachment id="12690664" name="8490-trunk.txt" size="5133" author="thobbs" created="Wed, 7 Jan 2015 23:53:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23h3r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>