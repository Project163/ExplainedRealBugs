<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10261] Materialized Views Timestamp issues</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10261</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9664?focusedCommentId=14724150&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14724150&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;mentioned&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9664&quot; title=&quot;Allow MV&amp;#39;s select statements to be more complex&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9664&quot;&gt;&lt;del&gt;CASSANDRA-9664&lt;/del&gt;&lt;/a&gt; there are issues dealing with updates to individual cells which can mask data from the base table in the view when trying to filter data correctly in the view.  &lt;/p&gt;

&lt;p&gt;Unfortunately, this same issue exists for all MV tables with regular columns.&lt;br/&gt;
In the earlier versions of MV we did have a fix for this which I now can see is ineffective for all situations.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed some unit tests to show the issue (similar to tylers) and a fix.  The idea is we keep the base table&apos;s timestamps per cell as it so we can &lt;b&gt;always&lt;/b&gt; tell (per replica) which version of the record is the latest.  Since the base table &lt;b&gt;always&lt;/b&gt; writes the entire record to the view (part of our earlier partial fix) we can ensure the view record contains &lt;b&gt;at least&lt;/b&gt; views primary key timestamp.  &lt;/p&gt;




</description>
                <environment></environment>
        <key id="12861630">CASSANDRA-10261</key>
            <summary>Materialized Views Timestamp issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjake">T Jake Luciani</assignee>
                                    <reporter username="tjake">T Jake Luciani</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Sep 2015 17:43:44 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:57 +0000</updated>
                            <resolved>Fri, 11 Sep 2015 15:41:33 +0000</resolved>
                                        <fixVersion>3.0.0 rc1</fixVersion>
                                    <component>Feature/Materialized Views</component>
                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14729454" author="tjake" created="Thu, 3 Sep 2015 17:45:07 +0000"  >&lt;p&gt;Pushed fix and test &lt;a href=&quot;https://github.com/tjake/cassandra/tree/tsbug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think this same approach would work for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9664&quot; title=&quot;Allow MV&amp;#39;s select statements to be more complex&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9664&quot;&gt;&lt;del&gt;CASSANDRA-9664&lt;/del&gt;&lt;/a&gt; so long as it gets the existing record.&lt;/p&gt;</comment>
                            <comment id="14729810" author="jkni" created="Thu, 3 Sep 2015 21:21:48 +0000"  >&lt;p&gt;This approach does not appear to work.&lt;/p&gt;

&lt;p&gt;In particular, if multiple updates are made to a cell with distinct timestamps less than the primary key timestamp, these updates will get promoted to the same primary key timestamp, which will cause different merging behavior on the view than the base.&lt;/p&gt;

&lt;p&gt;EDIT: For example, consider the following case:&lt;br/&gt;
1. On the base, the columns of the MV&apos;s PK are at TS=4.&lt;br/&gt;
2. A write for normal column D=2 is made at TS=2.&lt;br/&gt;
3. On the view, this write is promoted to TS=4 to avoid tombstone problems.&lt;br/&gt;
4. A write for normal column D=1 is made at TS=3.&lt;br/&gt;
5. On the view, this write is promoted to TS=4 to avoid tombstone problems.&lt;/p&gt;

&lt;p&gt;On the base, the second write wins. On the view, since timestamps are equal, the first write wins by lexicographic ordering.&lt;/p&gt;

&lt;p&gt;A unit test showing such a failure is available on my repo branch &lt;a href=&quot;https://github.com/jkni/cassandra/tree/tsbug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tsbug&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14731067" author="thobbs" created="Fri, 4 Sep 2015 17:09:31 +0000"  >&lt;p&gt;This is a pretty nasty problem.&lt;/p&gt;

&lt;p&gt;To summarize: rewriting an entire MV row shadows updates to the base row with older timestamps.  Specifically, the tombstone on the MV row causes this.&lt;/p&gt;

&lt;p&gt;We cannot detect this condition without doing a read-before-write on the MV.  Even if we did that, we would need to write new (old timestamped) base data to the MV somewhere special so that the tombstone doesn&apos;t affect it.&lt;/p&gt;

&lt;p&gt;It seems to me that the other options are to 1) try to remove/negate existing tombstones when inserting an MV row (using an anti-tombstone?) or 2) to perform deletions in a way that doesn&apos;t prevent future updates with older timestamps.&lt;/p&gt;

&lt;p&gt;The anti-tombstone approach might look like a second timestamp in the MV row marker that would &quot;protect&quot; the cells within the row from tombstones with older timestamps, even if the cells themselves should be shadowed by the tombstone.&lt;/p&gt;

&lt;p&gt;The special deletion handling approach would be similar.  I &lt;em&gt;think&lt;/em&gt; that we can count on row markers being present in the MV (please correct me if I&apos;m wrong).  When dealing with MVs, we could treat range tombstones specially so that they only shadow rows with a lower timestamp in the row marker, regardless of timestamps on cells within the row.&lt;/p&gt;

&lt;p&gt;I haven&apos;t really thought through the mechanics or implications of these approaches yet, but I&apos;m throwing ideas out there to get us started.  It doesn&apos;t seem like we have any great options.&lt;/p&gt;</comment>
                            <comment id="14731075" author="jkni" created="Fri, 4 Sep 2015 17:14:47 +0000"  >&lt;p&gt;The approaches you described are more-or-less the best I&apos;ve got.&lt;/p&gt;

&lt;p&gt;In either case, I think we need to be concerned about repairs between view replicas; generating these anti-tombstones with time markers would not necessarily function correctly.&lt;/p&gt;

&lt;p&gt;It could work to disable repairs between the view replicas, since repair on base replicas could go through the write path.&lt;/p&gt;</comment>
                            <comment id="14731083" author="tjake" created="Fri, 4 Sep 2015 17:16:37 +0000"  >&lt;p&gt;Yeah, this is a really difficult problem.&lt;/p&gt;

&lt;p&gt;Another option is to start tracking causality when the ts is != the clustering key timestamp.  We could use a new system table that keeps track of the cells we&apos;ve updates so far since the hard part in this problem is knowing what we&apos;ve sent so far to the MV.  This would mean two reads but since it&apos;s a special case I don&apos;t think it would end up being used that often.&lt;/p&gt;</comment>
                            <comment id="14731159" author="thobbs" created="Fri, 4 Sep 2015 17:54:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;In either case, I think we need to be concerned about repairs between view replicas; generating these anti-tombstones with time markers would not necessarily function correctly.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I could easily be missing something, but I don&apos;t see why this has to break repairs on MVs.  The anti-tombstone timestamp would be based on a timestamp from the base, so that should be consistent across replicas.  In the event of a mismatch, streamed data should include row markers with anti-tombstone timestamps (every MV row should have one) as well as the &quot;protected&quot; cells.&lt;/p&gt;</comment>
                            <comment id="14731184" author="jkni" created="Fri, 4 Sep 2015 18:18:13 +0000"  >&lt;p&gt;I&apos;ve been working out examples, and I think you&apos;re right.&lt;/p&gt;

&lt;p&gt;Gut feeling on this one seems to have been wrong.&lt;/p&gt;</comment>
                            <comment id="14731190" author="tjake" created="Fri, 4 Sep 2015 18:21:26 +0000"  >&lt;p&gt;I think he means repairing the view itself.  We can disable this.&lt;/p&gt;</comment>
                            <comment id="14731222" author="thobbs" created="Fri, 4 Sep 2015 18:40:13 +0000"  >&lt;p&gt;Thinking about this more, a bit of a hybrid of the two approaches I mentioned may work.  Essentially, we use two kinds of tombstones in MVs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;View tombstones.  These have a special deletion behavior.  If the row timestamp is higher than the tombstone&apos;s timestamp, all of the cells in the row are safe, regardless of their own timestamp.  These tombstones would be used whenever we need an MV deletion as a result of a non-deletion change in the base table.  To use the original example, when &lt;tt&gt;c&lt;/tt&gt; is changed from 0 to 1 in the base table, we would insert a &quot;view tombstone&quot; into the view with &lt;tt&gt;c&lt;/tt&gt;&apos;s timestamp.&lt;/li&gt;
	&lt;li&gt;Normal tombstones.  These function just like the existing tombstones, and shadow any cell with a lower timestamp, regardless of the row&apos;s timestamp.  These are used whenever there is a deletion on the base table.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m working on some examples of how this would behave.&lt;/p&gt;

&lt;p&gt;As far as the implementation goes, it may be simpler to model this as one kind of tombstone with two separate timestamps, but I&apos;m not sure yet.&lt;/p&gt;</comment>
                            <comment id="14731257" author="tjake" created="Fri, 4 Sep 2015 19:00:29 +0000"  >&lt;p&gt;What timestamp do you use for the View tombstones?  Is it the min timestamp of the rows cells?&lt;/p&gt;</comment>
                            <comment id="14731266" author="thobbs" created="Fri, 4 Sep 2015 19:11:30 +0000"  >&lt;p&gt;Here&apos;s an example of a series of operations along with the corresponding state of the base and MV rows.&lt;/p&gt;

&lt;p&gt;The base table schema: &lt;tt&gt;CREATE TABLE base (a int, b int, c int, d int, PRIMARY KEY (a, b))&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The view schema: &lt;tt&gt;CREATE MV AS SELECT * FROM base ... PRIMARY KEY (c, a, b)&lt;/tt&gt;;&lt;/p&gt;

&lt;p&gt;In these examples, &lt;tt&gt;d=0@1&lt;/tt&gt; means the cell for &lt;tt&gt;d&lt;/tt&gt; has value 0 and timestamp 1.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INSERT ... (0, 0, 0, 0) @ TS 1

  - Base row: pk=(0, 0) row_ts=1, c=0@1, d=0@1
  - MV rows:
    - pk=(0, 0, 0) row_ts=1, d=0@1

UPDATE ... SET c = 1 @ TS 3

  - Base row: pk=(0, 0) row_ts=1, c=1@3, d=0@1
  - MV rows:
    - pk=(0, 0, 0) view_tombstone@3
    - pk=(1, 0, 0) row_ts=3, d=0@1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This update created a &quot;view tombstone&quot; in the view with timestamp 3.  Since this was higher than the row timestamp for the view&apos;s row, it was considered deleted.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;UPDATE ... SET c = 0 @ TS 4

  - Base row: pk=(0, 0) row_timestamp=1, c=1@4, d=0@1
  - MV rows:
    - pk=(0, 0, 0) view_tombstone@3, row_ts=4, d=0@1
    - pk=(1, 0, 0) view_tombstone@4,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The view row was reinserted with c=0.  Since the new view row has a timestamp of 4, the &quot;view tombstone&quot; with timestamp 3 does not shadow it, including the protected cell &lt;tt&gt;d&lt;/tt&gt; with a timestamp of 1.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;UPDATE ... SET d = 1 @ TS 2

  - Base row: pk=(0, 0) row_ts=1, c=1@4, d=1@2
  - MV rows:
    - pk=(0, 0, 0) view_tombstone@3, row_ts=4, d=1@2
    - pk=(1, 0, 0) view_tombstone@4

UPDATE ... SET d = 2 @ TS 3

  - Base row: pk=(0, 0) row_ts=1, c=1@4, d=2@3
  - MV rows:
    - pk=(0, 0, 0) view_tombstone@3, row_ts=4, d=2@3
    - pk=(1, 0, 0) view_tombstone@4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;tt&gt;d&lt;/tt&gt; cell can be updated normally without adjustments to its timestamp.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DELETE ... WHERE a = 0 AND b = 0 @ TS 5

  - Base row: pk=(0, 0) tombstone@5
  - MV rows:
    - pk=(0, 0, 0) tombstone@5
    - pk=(1, 0, 0) view_tombstone@4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Deletions on the base table result in normal tombstones being inserted to the view.&lt;/p&gt;</comment>
                            <comment id="14731272" author="thobbs" created="Fri, 4 Sep 2015 19:16:59 +0000"  >&lt;p&gt;It&apos;s the same timestamp we currently use to delete view rows when a base row is updated, which (if I follow everything correctly) is the min timestamp from a base cell in the update that corresponds to a primary key column in the view.&lt;/p&gt;</comment>
                            <comment id="14731673" author="tjake" created="Sat, 5 Sep 2015 00:55:23 +0000"  >&lt;p&gt;Got it.  Thanks.&lt;/p&gt;

&lt;p&gt;So real deletes are passed as regular tombstones but &quot;cleanup&quot; tombstones on the view are view tombstones.&lt;/p&gt;
</comment>
                            <comment id="14735069" author="slebresne" created="Tue, 8 Sep 2015 16:14:16 +0000"  >&lt;p&gt;That view tombstone idea sounds like it&apos;d work. So let me suggest some ideas regarding how it could be implemented.&lt;/p&gt;

&lt;p&gt;First, I&apos;d prefer not calling them &quot;view tombstones&quot;. It&apos;s imo better to call things by what they are rather than what they are for since you never know if you won&apos;t end up using it for something else someday. And what they do is that they are row tombstones that don&apos;t reach inside the row unless their timestamp is greater than the row one. The two suggestions I would have for a name would be either &quot;weak&quot; or &quot;shallow&quot; row-tombstones. I&apos;ll use &quot;weak tombstone&quot; in the rest but I&apos;m not strongly attached to it if there is a better idea.&lt;/p&gt;

&lt;p&gt;The second thing is that as far as I can tell, there is no reason to keep both a weak and a normal tombstone on a given row. A simple rule like &quot;normal tombstones wins over weak if they have the same timestamp&quot; is likely fine. So I would implement it more as 2 variations of row tombstones: weak and normal/strong. More concretely, we could simply add a &quot;isDeletionWeak&quot; boolean to each &lt;tt&gt;Row&lt;/tt&gt; and update the reconciliation rules to take it into account. Shouldn&apos;t require a whole of code in fact.&lt;/p&gt;

&lt;p&gt;We&apos;d also have to modify the serialization format to handle that new information, and sadly we don&apos;t have any room for a new flag in the current per-row flag byte (see &lt;tt&gt;UnfilteredSerializer&lt;/tt&gt;). Right off the bat, I see 2 options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;we change one of the existing flag (say &lt;tt&gt;HAS_COMPLEX_DELETION&lt;/tt&gt;) to be an &quot;extension&quot; flag. If that flag is set, then we read an addition byte of flags, and we use the additional room for this. If that flag isn&apos;t set, we assume some meaningful default for the flags in the &quot;extension&quot;.  The advantage is that it&apos;s a somewhat general solution that could come in handy if we need more flags later. The slight disavantage being that we&apos;d use an additional byte in some case where we currently do not, though that should hopefully be uncommon.&lt;/li&gt;
	&lt;li&gt;we don&apos;t use the flags at all for this: for instance, we could write &lt;tt&gt;-localDeletionTime&lt;/tt&gt; for the row deletion if that&apos;s a &quot;weak&quot; deletion (after all, that should never be negative for a normal tombstone). It&apos;s a bit of a hack however, and it doesn&apos;t play very nice with the delta encoding we do on the &lt;tt&gt;localDeletionTime&lt;/tt&gt;, so it&apos;s probably not the best of idea.&lt;br/&gt;
I&apos;d probably go with option 1.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14735587" author="tjake" created="Tue, 8 Sep 2015 20:51:33 +0000"  >&lt;p&gt;I&apos;ve made a first cut at implementing this &lt;a href=&quot;https://github.com/tjake/cassandra/tree/tsbug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The described situation now passes.  I&apos;ve implemented this as an extra bit in DeletionTime.  &lt;br/&gt;
I&apos;d like to add a dtest to verify this works properly when there is a digest mismatch.  but this should be enough to tell me if I&apos;m on the right path &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14735637" author="thobbs" created="Tue, 8 Sep 2015 21:19:07 +0000"  >&lt;p&gt;I haven&apos;t given this a thorough review yet, but as quick feedback:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The serialization changes aren&apos;t backwards-compatible.  They need to be conditional on &lt;tt&gt;version&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;I&apos;d go with Sylvain&apos;s suggestion of &lt;tt&gt;isWeak&lt;/tt&gt; for the name on the flag.&lt;/li&gt;
	&lt;li&gt;It would be good to add base-table deletions to the mix in your unit test, where possible.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I should have more complete feedback shortly.&lt;/p&gt;</comment>
                            <comment id="14735754" author="thobbs" created="Tue, 8 Sep 2015 22:34:52 +0000"  >&lt;p&gt;Some more review feedback:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I believe you need to update &lt;tt&gt;DeletionTime.equals()&lt;/tt&gt;, &lt;tt&gt;hashCode()&lt;/tt&gt;, &lt;tt&gt;compareTo()&lt;/tt&gt;.  If any of those should not account for the new flag, add a comment explaining why.  It would also be nice to add the flag to &lt;tt&gt;toString()&lt;/tt&gt;.  You already mentioned digests, but I believe we do want to include the new flag in the digest to cover the case where one replica has a normal tombstone and another has a weak tombstone with the same timestamp (see the next point).  Make sure the digests changes are also backwards-compatible (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9554&quot; title=&quot;Avoid digest mismatch storm on upgrade to 3.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9554&quot;&gt;&lt;del&gt;CASSANDRA-9554&lt;/del&gt;&lt;/a&gt;).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;DeletionTime.supersedes()&lt;/tt&gt; should take the new flag into account.  We want normal tombstones to supersede weak ones because they can delete cells that weak tombstones cannot.  Some tests around this would be good.&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;SinglePartitionNamesCommand&lt;/tt&gt;, why should we ignore weak tombstones?  If the sstable doesn&apos;t have any newer data, it will still be considered deleted.&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;Rows&lt;/tt&gt;, we should be checking that &lt;tt&gt;mergedInfo.timestamp() &amp;gt; deletion.markedForDeleteAt()&lt;/tt&gt;, not &lt;tt&gt;&amp;gt;=&lt;/tt&gt;.  Better yet, use &lt;tt&gt;deletion.deletes(mergedInfo.timestamp())&lt;/tt&gt;.  The changes in &lt;tt&gt;Row&lt;/tt&gt; have the same issue.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14736332" author="slebresne" created="Wed, 9 Sep 2015 07:06:01 +0000"  >&lt;p&gt;I have to admit that I&apos;m really not a fan of using the &lt;tt&gt;DeletionTime&lt;/tt&gt; that way. &lt;tt&gt;DeletionTime&lt;/tt&gt; is somewhat of a generic class that is used in more than one places. In particular, I believe we only really care here about row tombstones, but &lt;tt&gt;DeletionTime&lt;/tt&gt; is also used for range tombstones, partition tombstones and collection (complex) tombstones. The new flag doesn&apos;t make sense (or at the very least won&apos;t be used/properly handled) in those cases, which is 1) confusing code wise and 2) inefficient since that means we&apos;re storing an additional byte every time we serialize a &lt;tt&gt;DeletionTime&lt;/tt&gt; even though this is a complete waste most often than not. On that efficiency front, even restricting it to row tombstones, it&apos;s also a little bit sad that every non-MV table will also pay that 1 byte price every time they use a row tombstones even though they will also never use it. That is, we spent a reasonable amount of effort for 3.0 to keep the serialization format relatively dense, and &quot;wasting&quot; a full byte that way feels a bit of a step back.&lt;/p&gt;</comment>
                            <comment id="14736570" author="slebresne" created="Wed, 9 Sep 2015 09:55:00 +0000"  >&lt;p&gt;And so it doesn&apos;t sound like I&apos;m criticizing without offering anything, I&apos;ve pushed a branch &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; with the alternative I have in mind. Instead of adding a flag directly to &lt;tt&gt;DeletionTime&lt;/tt&gt; (since I don&apos;t think it&apos;s a good idea for reasons explain in my previous comment), it adds a new &lt;tt&gt;Row.Deletion&lt;/tt&gt; class that just group a &lt;tt&gt;DeletionTime&lt;/tt&gt; and new &lt;tt&gt;isWeak&lt;/tt&gt; flag. This makes sure we don&apos;t mess with anything else than row deletions (and a bonus of having a new class is that type checking make it more sure that we don&apos;t forget to handle the new flag somewhere we should). The serialization also use the first idea of my earlier comment: it uses a row flag extension which is only there if a weak deletion is used or the row is static (one existing flag had to move to the extension, and moving the &lt;tt&gt;IS_STATIC&lt;/tt&gt; felt the best choice because not every table has statics and even when they have, there is at most one static row per partition, and so the slight overhead is somewhat contained). Anyway, the branch steals the unit test from Jake&apos;s branch and said test passes as expected.&lt;/p&gt;</comment>
                            <comment id="14736766" author="tjake" created="Wed, 9 Sep 2015 12:34:15 +0000"  >&lt;p&gt;I like the distinction between row deletions and the others.  Let&apos;s go with your version, I&apos;ll work on adding some dtests.&lt;/p&gt;</comment>
                            <comment id="14737086" author="tjake" created="Wed, 9 Sep 2015 16:01:05 +0000"  >&lt;p&gt;I&apos;m not very keen on the &quot;weak&quot; term.   Without bikeshedding this too much...&lt;br/&gt;
The term Shadowable is clearer to me and you already added isShadowedBy()&lt;/p&gt;</comment>
                            <comment id="14737419" author="slebresne" created="Wed, 9 Sep 2015 19:06:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;The term Shadowable is clearer to me and you already added isShadowedBy()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m good with that. I&apos;ll leave some time to make sure nobody wants to bikeshed further, but I&apos;ll switch after that.&lt;/p&gt;</comment>
                            <comment id="14737485" author="tjake" created="Wed, 9 Sep 2015 20:04:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ll switch after that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Made the name change along with some new changes to the tests (adds real tombstones)&lt;br/&gt;
I also added a new dtest that does the same as the unit test but verifies digest mismatches &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/543&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull request&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/tjake/cassandra/tree/10261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch &lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/tjake/job/tjake-10261-testall/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/tjake/job/tjake-10261-dtest/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests &lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14739124" author="thobbs" created="Thu, 10 Sep 2015 17:03:36 +0000"  >&lt;p&gt;+1 on the code changes.  Once we get a good dtest run with the latest 3.0 merged in, this should be good to commit (assuming the tests pass).&lt;/p&gt;

&lt;p&gt;One nit that you can fix when committing: in BTreeRow, there&apos;s still a reference to a &quot;weak deletion&quot;.&lt;/p&gt;</comment>
                            <comment id="14740734" author="tjake" created="Fri, 11 Sep 2015 12:54:42 +0000"  >&lt;p&gt;I re-ran the dtests and there are still issues with the upgrade dtest itself.&lt;/p&gt;

&lt;p&gt;Seems like it&apos;s trying to upgrade to trunk after this branch (trunk obviously doesn&apos;t have the changes in this branch).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;dtest: DEBUG: starting from 3.0.0&lt;br/&gt;
21:45:45 dtest: DEBUG: upgrading to git:trunk&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14740951" author="mambocab" created="Fri, 11 Sep 2015 15:02:52 +0000"  >&lt;p&gt;Just to confirm: yep, that&apos;s bad test logic.&lt;/p&gt;</comment>
                            <comment id="14740992" author="tjake" created="Fri, 11 Sep 2015 15:41:33 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13061470">CASSANDRA-13409</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12875681">CASSANDRA-10368</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jr9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>