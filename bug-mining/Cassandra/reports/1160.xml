<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3234] LeveledCompaction has several performance problems</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3234</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Two main problems:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BF size calculation doesn&apos;t take into account LCS breaking the output apart into &quot;bite sized&quot; sstables, so memory use is much higher than predicted&lt;/li&gt;
	&lt;li&gt;ManyToMany merging is slow.  At least part of this is from running the full reducer machinery against single input sources, which can be optimized away.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12523796">CASSANDRA-3234</key>
            <summary>LeveledCompaction has several performance problems</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Tue, 20 Sep 2011 23:47:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:50 +0000</updated>
                            <resolved>Fri, 23 Sep 2011 13:56:48 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13109244" author="jbellis" created="Wed, 21 Sep 2011 03:54:28 +0000"  >&lt;p&gt;split OneToOne classes into separate patches and fixed bug in estimated tables calculation&lt;/p&gt;</comment>
                            <comment id="13109698" author="slebresne" created="Wed, 21 Sep 2011 17:45:29 +0000"  >&lt;p&gt;I haven&apos;t looked at the 3 first patches, but on patch 4 and 5.&lt;/p&gt;

&lt;p&gt;+1 on patch 4 (though I agree with the comment in there that it&apos;s not the more beautiful refactor ever &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;

&lt;p&gt;On patch 5, it cloneMeShallow the first read column family and basically skip all the columns, so that&apos;s wrong. Attaching a v2 that makes SSTII directly use the right ISortedColumn factory (to avoid full cloning). Problem is this doesn&apos;t translate to ParallelCompactionIterable too well since the actual read is deep into the code. For it, I think we have 2 easy solutions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Just use ArraySortedColumns all the way. This is actually ok because addAll works whatever the input is, it does a merge.&lt;/li&gt;
	&lt;li&gt;Do a full clone to a TreeMapBacked CF on the first cf read&lt;/li&gt;
	&lt;li&gt;Use TreeMapBack CFs all the way.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I went with the first solution in the patch attached (more because it requires the less changes than anything else), though that&apos;s probably not optimal for LeveledCompaction (but I&apos;m not sure ParallelCompaction is useful for LeveledCompaction). &lt;/p&gt;</comment>
                            <comment id="13109702" author="jbellis" created="Wed, 21 Sep 2011 17:48:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;that&apos;s probably not optimal for LeveledCompaction&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you elaborate?&lt;/p&gt;</comment>
                            <comment id="13109710" author="jbellis" created="Wed, 21 Sep 2011 17:54:18 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+                thisCF = row.getColumnFamilyWithColumns(cf == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? TreeMapBackedSortedColumns.factory() : ArrayBackedSortedColumns.factory());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t understand why not just ABSC here.&lt;/p&gt;</comment>
                            <comment id="13109727" author="slebresne" created="Wed, 21 Sep 2011 18:09:30 +0000"  >&lt;p&gt;ABSC.addAll does a merge. So if you do cf1.addAll(cf2) and cf1 and cf2 are comparable in size, that&apos;s likely as good as it gets. However, if cf2 has much less columns than cf1, then it&apos;s likely that TMBSC.addAll (that adds the columns of cf2 one by one) will be faster.&lt;/p&gt;

&lt;p&gt;So I guess it all depends on how many sstables we are merging. If we have a lot of them, then adding to TMBSC will be a win (my claim on LeveledCompaction was misdirected, I was thinking of it as lots of sstables, but that doesn&apos;t mean we&apos;ll merge lots of sstables (unless L0 is behind)). Anyway, it can very well be that ABSC is better in the vast majority of cases so I&apos;m fine with using just that. &lt;/p&gt;</comment>
                            <comment id="13112186" author="jbellis" created="Wed, 21 Sep 2011 22:43:57 +0000"  >&lt;p&gt;simple 05 v3 attached using just ABSC&lt;/p&gt;</comment>
                            <comment id="13112388" author="slebresne" created="Thu, 22 Sep 2011 07:41:26 +0000"  >&lt;p&gt;The problem is that now CFS.removeDeleted throws a ConcurrentModificationException. Attaching v4 that replaces the&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;for (IColumn c : cf)
    cf.remove(c.name())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;pattern by&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Iterator&amp;lt;IColumn&amp;gt; iter = cf.iterator()
while (iter.hasNext())
{
    IColumn c = iter.next();
    iter.remove();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13112767" author="brandon.williams" created="Thu, 22 Sep 2011 18:03:10 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13112893" author="jbellis" created="Thu, 22 Sep 2011 20:47:50 +0000"  >&lt;p&gt;06 attached as well.&lt;/p&gt;</comment>
                            <comment id="13113001" author="jbellis" created="Thu, 22 Sep 2011 22:59:50 +0000"  >&lt;p&gt;updated 06&lt;/p&gt;</comment>
                            <comment id="13113241" author="jbellis" created="Fri, 23 Sep 2011 08:06:54 +0000"  >&lt;p&gt;v2 improves leveled expensiveness equation to&lt;/p&gt;

&lt;p&gt;L0.size() + count(levels) - ignore.size()&lt;/p&gt;</comment>
                            <comment id="13113261" author="jbellis" created="Fri, 23 Sep 2011 08:37:42 +0000"  >&lt;p&gt;updated to &quot;Sets.difference(L0, sstablesToIgnore).size() + manifest.getLevelCount()&quot;&lt;/p&gt;</comment>
                            <comment id="13113272" author="slebresne" created="Fri, 23 Sep 2011 08:52:26 +0000"  >&lt;p&gt;The patch as is doesn&apos;t compile because it removes the import of StringUtils in LeveledManifest.java (it also add the import of DataTracker in AbstractCompactionStrategy which I think is not useful). But other than +1 on 06 v3.&lt;/p&gt;</comment>
                            <comment id="13113445" author="jbellis" created="Fri, 23 Sep 2011 13:56:48 +0000"  >&lt;p&gt;fixed + committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12495411" name="0005-use-Array-and-Tree-backed-columns-in-compaction-v2.patch" size="4116" author="slebresne" created="Wed, 21 Sep 2011 17:45:29 +0000"/>
                            <attachment id="12496044" name="0005-use-Array-and-Tree-backed-columns-in-compaction-v3.txt" size="2348" author="jbellis" created="Wed, 21 Sep 2011 22:43:57 +0000"/>
                            <attachment id="12496077" name="0005-use-Array-and-Tree-backed-columns-in-compaction-v4.patch" size="5491" author="slebresne" created="Thu, 22 Sep 2011 07:41:26 +0000"/>
                            <attachment id="12496239" name="0006-avoid-echoedRow-when-checking-shouldPurge-is-more-ex.patch" size="9107" author="jbellis" created="Fri, 23 Sep 2011 08:37:42 +0000"/>
                            <attachment id="12496233" name="0006-avoid-echoedRow-when-checking-shouldPurge-is-more-ex.patch" size="8861" author="jbellis" created="Fri, 23 Sep 2011 08:06:54 +0000"/>
                            <attachment id="12496194" name="0006-avoid-echoedRow-when-checking-shouldPurge-is-more-ex.patch" size="7663" author="jbellis" created="Thu, 22 Sep 2011 22:59:50 +0000"/>
                            <attachment id="12495388" name="ASF.LICENSE.NOT.GRANTED--0001-optimize-single-source-case-for-MergeIterator.txt" size="16335" author="jbellis" created="Wed, 21 Sep 2011 15:49:46 +0000"/>
                            <attachment id="12495389" name="ASF.LICENSE.NOT.GRANTED--0002-add-TrivialOneToOne-optimization.txt" size="8466" author="jbellis" created="Wed, 21 Sep 2011 15:49:46 +0000"/>
                            <attachment id="12495390" name="ASF.LICENSE.NOT.GRANTED--0003-fix-leveled-BF-size-calculation.txt" size="7406" author="jbellis" created="Wed, 21 Sep 2011 15:49:46 +0000"/>
                            <attachment id="12495391" name="ASF.LICENSE.NOT.GRANTED--0004-avoid-calling-shouldPurge-unless-necessary.txt" size="4963" author="jbellis" created="Wed, 21 Sep 2011 15:49:46 +0000"/>
                            <attachment id="12495392" name="ASF.LICENSE.NOT.GRANTED--0005-use-Array-and-Tree-backed-columns-in-compaction.txt" size="3720" author="jbellis" created="Wed, 21 Sep 2011 15:49:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3531</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ghfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>