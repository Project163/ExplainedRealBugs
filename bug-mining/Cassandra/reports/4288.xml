<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9530] SSTable corruption can trigger OOM</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9530</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If a sstable is corrupted so that the length of a given value is bogus, we&apos;ll still happily try to allocate a buffer of that bogus size to read the value, which can easily lead to an OOM.&lt;/p&gt;

&lt;p&gt;We should probably protect against this. In practice, a given value can be so big since it&apos;s limited by the protocol frame size in the first place. Maybe we could add a max_value_size_in_mb setting and we&apos;d considered a sstable corrupted if it was containing a value bigger than that.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that this ticket would be a good occasion to improve &lt;tt&gt;BlacklistingCompactionsTest&lt;/tt&gt;. Typically, it currently generate empty values which makes it pretty much impossible to get the problem described here. And as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9478&quot; title=&quot;SSTables are not always properly marked suspected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9478&quot;&gt;&lt;del&gt;CASSANDRA-9478&lt;/del&gt;&lt;/a&gt;, it also doesn&apos;t test properly for thing like early opening of compaction results. We could try to randomize as much of the parameters of this test as possible to make it more likely to catch any type of corruption that could happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12834581">CASSANDRA-9530</key>
            <summary>SSTable corruption can trigger OOM</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Jun 2015 13:25:12 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:59 +0000</updated>
                            <resolved>Thu, 26 May 2016 02:59:37 +0000</resolved>
                                        <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.7</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15278013" author="ifesdjeen" created="Tue, 10 May 2016 12:22:32 +0000"  >&lt;p&gt;I&apos;ve been able to reproduce the corruption that would trigger OOM. It&apos;s worth noting that SSTable itself should be large enough (otherwise we&apos;ll hit EOF earlier than we hit OOM). &lt;/p&gt;

&lt;p&gt;With the compressed files it&apos;s a bit different, because checksums catch pretty much any change there. I could try modifying checksum as well, although I&apos;m not sure it would qualify for a realistic scenario. &lt;tt&gt;BlacklistingCompactionTest&lt;/tt&gt; is also uses no compaction though. &lt;/p&gt;

&lt;p&gt;Do you think it&apos;d be still useful to only test for cases without compression?&lt;/p&gt;</comment>
                            <comment id="15279845" author="slebresne" created="Wed, 11 May 2016 09:25:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do you think it&apos;d be still useful to only test for cases without compression?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I think that&apos;s useful since we don&apos;t do block checksums in that case, and we believe no compression is a much more viable option in 3.0.&lt;/p&gt;</comment>
                            <comment id="15279852" author="ifesdjeen" created="Wed, 11 May 2016 09:32:47 +0000"  >&lt;p&gt;Great, thank you!&lt;/p&gt;</comment>
                            <comment id="15288906" author="ifesdjeen" created="Wed, 18 May 2016 12:57:31 +0000"  >&lt;p&gt;I&apos;ve composed a patch that improves situation with detecting corrupted sstables. I had more ways to reproduce corruptions locally, although this one is the most generalised and brute-force one. The idea is to save (backup) first &lt;tt&gt;n&lt;/tt&gt; bytes and then overwrite &lt;tt&gt;0&lt;/tt&gt; to &lt;tt&gt;5&lt;/tt&gt; bytes either randomly or with &lt;tt&gt;0xFF&lt;/tt&gt;, moving the corruption position byte by byte. &lt;/p&gt;

&lt;p&gt;As the test caught several more cases, where existing asserts were triggered, they were converted to &lt;tt&gt;CorruptionExceptions&lt;/tt&gt;. I&apos;ve ran the tests locally a couple of dozen times, they pass all the time (as one of the tests is randomised, it may theoretically land on some value that would discover another edge case, although that seems to be exactly the purpose of such test).&lt;/p&gt;

&lt;p&gt;I&apos;ve also added the mentioned &lt;tt&gt;max_value_size_in_mb&lt;/tt&gt; to configuration file, also corresponding workflow and the exception.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15290583" author="stefania" created="Thu, 19 May 2016 06:53:59 +0000"  >&lt;p&gt;The patch is good but there is a little bit more work required:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;cassandra.yaml&lt;/b&gt;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;Maxium size of the value in SSTable.&lt;/tt&gt; -&amp;gt; &lt;tt&gt;Maximum size of values in sstables.&lt;/tt&gt; or &lt;tt&gt;Maxium size of any value in sstables.&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Let&apos;s mention in the description of &lt;tt&gt;native_transport_max_frame_size_in_mb&lt;/tt&gt; that if this parameter is increased then &lt;tt&gt;max_value_size_in_mb&lt;/tt&gt; may need increasing too.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It&apos;s extremely unlikely but just in case someone happens to have some huge value in some ancient sstable, let&apos;s mention a brief description of this parameter in NEWS.txt.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Protecting from OOM exceptions&lt;/b&gt;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think it should be safe to cap all invocations of &lt;tt&gt;AbstractType.readValue()&lt;/tt&gt; and not just the call from &lt;tt&gt;Cell.deserialize()&lt;/tt&gt;. This way we also cover clustering values and partition keys.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;SStableCorruptionDetectionTest.java&lt;/b&gt;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The test is currently &lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/lastCompletedBuild/testReport/org.apache.cassandra.io.sstable/SStableCorruptionDetectionTest/testFinishRandomized_compression/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failing&lt;/a&gt; on Jenkins because it tries to create the keyspace when it already exists.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It also failed with an OOM &lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/lastCompletedBuild/testReport/org.apache.cassandra.io.sstable/SStableCorruptionDetectionTest/testFinish_compression&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/lastCompletedBuild/testReport/org.apache.cassandra.io.sstable/SStableCorruptionDetectionTest/testFinish/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I had a look at the exceptions captured:
	&lt;ul&gt;
		&lt;li&gt;Most of them are in the clustering deserializers. I think we need to extend the randomization so that we seek to any position in the sstable provided we don&apos;t exceed the corruption size, seeking at position zero is not sufficient.&lt;/li&gt;
		&lt;li&gt;Most of the inner exceptions were EOF exceptions, had the table been bigger they could have been OOM. See the section above on protecting from OOM exceptions.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When using randomized tests it is a good idea to print the seed. This way if a test fails on Jenkins we can reproduce the failure locally as well.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Nit: at line 144 we can use a &lt;tt&gt;try&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;BlackListingCompactionTest.java&lt;/b&gt;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;We should randomize the values created in &lt;tt&gt;testBlacklisting()&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;As above, we should print the seed.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;To ensure early opening has occurred, we should set &lt;tt&gt;conf.sstable_preemptive_open_interval_in_mb&lt;/tt&gt; to 1, then create an sstable of at least 2 MB and corrupt it after 1.5 MB, is this correct &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; or is there more to it?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15293614" author="ifesdjeen" created="Fri, 20 May 2016 16:08:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;It also failed with an OOM here and here&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Great &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; that means it worked! &lt;/p&gt;

&lt;p&gt;We&apos;re catching &lt;tt&gt;EOF&lt;/tt&gt; Exceptions now in several places (after changes):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.cassandra.db.rows.Cell$Serializer.deserialize(Cell.java:246)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.cassandra.db.ClusteringPrefix$Deserializer.deserializeOne(ClusteringPrefix.java:513)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Although all these EOFs would also be caught given the value is sufficiently large to blow up the heap (with the new &lt;tt&gt;max_value_size_in_mb&lt;/tt&gt;). &lt;br/&gt;
While working on improvements, I have also discovered that yet another code path &lt;tt&gt;SStableScanner&lt;/tt&gt; (used in for the partition range reads) was not tested. This code path also had out of boundary exceptions and was throwing similar EOFs. I wrote tests to cover both cases. &lt;/p&gt;

&lt;p&gt;I also wrote the test (not included into the patch) for early corrupting early opened compaction result, although I&apos;m not sure how useful it is in general. Early opened file will get corrupted, although there&apos;s no way to catch this corruption until the next compaction or sstable read / scan occurs. Testing this is also non-trivial, as if we trigger compaction, it runs asyncronously, so the only reasonable way it is to create a rewriter manually and catch the moment when we have a new sstable in &lt;tt&gt;EARLY&lt;/tt&gt; state. Since existing cases already do cover the situation, I decided to leave it out. I might have missed something, so please let me know.&lt;/p&gt;

&lt;p&gt;cassandra.yaml changes are made according to your comments. &lt;br/&gt;
BlackListingCompactionTest.java is adjusted to print the seed and write randomised values.&lt;br/&gt;
All invocations of &lt;tt&gt;AbstractType.readValue()&lt;/tt&gt; are now capped to protect from OOM. A single instance of &lt;tt&gt;ByteBufferUtil.readWithShortLength&lt;/tt&gt; is converted to &lt;tt&gt;skip&lt;/tt&gt; in order to avoid allocating a throwaway buffer. I thought it&apos;s also worth a separate commit.&lt;/p&gt;

&lt;p&gt;I&apos;ll be putting the tests on CI for a couple of dozen runs (even though I ran them locally a couple of hundred times already) to verify that nothing was accidentally forgotten.&lt;/p&gt;</comment>
                            <comment id="15295913" author="stefania" created="Mon, 23 May 2016 04:53:26 +0000"  >&lt;p&gt;Agreed on testing corruption for early opened tables, let&apos;s leave it for now since it is quite complex to write and it doesn&apos;t add much to what the new corruption tests already do.&lt;/p&gt;

&lt;p&gt;The patch looks good to me now.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed a couple of nits, edited the text in CHANGES.txt a bit, and I&apos;ve introduced a field in &lt;tt&gt;AbstractType&lt;/tt&gt;, to avoid calling a method every time we read a value. Perhaps this is not necessary if the jit compiler optimizes this static method call away, however there is an ongoing effort to limit the dependencies on &lt;tt&gt;DatabaseDescriptor&lt;/tt&gt;, at least in some packages, so it is not a bad thing to move the dependency at least to the constructor. Unfortunately, due to all the type singleton instances, this field cannot be final as it needs to be changed for testing. Feel free to see if you can figure out a better way to end up with types that have a different max value size by passing it to the constructor. Basically, once the types are in the CFS metadata we are good for our tests, however even if we create the CFM with those types, when the keyspace is created we end up with new types because we use the CQL string of the type. I did not want to change that part of the code for this simple patch. &lt;/p&gt;

&lt;p&gt;You can find my changes &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/2ab8950ae17ea74c7690f83dfa2eec0aa66290cc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If you are +1 on them, let&apos;s rebase and re-run the tests.&lt;/p&gt;</comment>
                            <comment id="15296203" author="ifesdjeen" created="Mon, 23 May 2016 10:26:50 +0000"  >&lt;p&gt;+1&lt;br/&gt;
I&apos;ve squashed all commits and ran the test 30 times on CI with multiplexer script (&lt;tt&gt;SStableCorruptionDetectionTest&lt;/tt&gt; only) and re-ran dtest and utest:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15297462" author="stefania" created="Tue, 24 May 2016 00:59:01 +0000"  >&lt;p&gt;It&apos;s ready to commit but I am not sure we should limit this to trunk. &lt;/p&gt;

&lt;p&gt;I&apos;m sorry I did not check the category of this ticket until now, and so far I&apos;ve treated it as an improvement since the patch provided is on trunk. Typically however, a major bug goes to 2.2+. I think in this case though, we can make an exception and commit it only to 3.0+, since the 2.2 and 3.0 branches are very divergent and I don&apos;t think it&apos;s worth creating a new patch for 2.2. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; which branch do you think we should commit this ticket to? &lt;/p&gt;</comment>
                            <comment id="15297777" author="ifesdjeen" created="Tue, 24 May 2016 06:52:28 +0000"  >&lt;p&gt;I think that 3.0+ is a good idea, as SSTable format undergone major changes in 3.0. &lt;br/&gt;
&lt;tt&gt;BlacklistingCompactionTest&lt;/tt&gt; with better randomisation can be backported to 2.2.&lt;/p&gt;</comment>
                            <comment id="15298081" author="iamaleksey" created="Tue, 24 May 2016 12:13:53 +0000"  >&lt;p&gt;Should at least commit to 3.0.x, not sure about 2.1/2.2. This should qualify as critical, given the bringing-nodes-down potential.&lt;/p&gt;</comment>
                            <comment id="15298780" author="ifesdjeen" created="Tue, 24 May 2016 19:46:28 +0000"  >&lt;p&gt;I&apos;ve made a patch for &lt;tt&gt;3.0&lt;/tt&gt; and &lt;tt&gt;3.7&lt;/tt&gt;. CI is also done, with multiplexing, too:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-multiplexed/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.0-multiplexed/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.7&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.7-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.7-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.7-multiplexed/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15299281" author="stefania" created="Wed, 25 May 2016 01:22:17 +0000"  >&lt;p&gt;OK, so we&apos;ll commit to 3.0+. For 2.1/2.2, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; pointed out above, compression will detect corruption making this patch less critical, given that compression is typically enabled in the pre 3.0 world.&lt;/p&gt;

&lt;p&gt;Whilst the multiplexed tests are clean, unfortunately we have many failures across utests and dtests. I&apos;m pretty sure they are not related to this patch but it is hard to check that every single failing tests also fails on unpatched branches when there are so many. Therefore, I&apos;ve applied the patches this morning to the latest 3.0/3.7/trunk branches and I am rerunning CI in the hope to shake some of the failures:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.7&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-3.7-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-3.7-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15299648" author="stefania" created="Wed, 25 May 2016 08:03:09 +0000"  >&lt;p&gt;I&apos;ve reviewed all the failures of the last run I launched. We need to take a look at &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-testall/lastCompletedBuild/testReport/org.apache.cassandra.db.compaction/BlacklistingCompactionsTest/testBlacklistingWithLeveledCompactionStrategy/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this one&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9530-testall/lastCompletedBuild/testReport/junit.framework/TestSuite/org_apache_cassandra_index_sasi_SASIIndexTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this one&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;The second one doesn&apos;t seem related but it pretty much reliably fails on our 3.7 and trunk patches and passes on the unpatched branches.&lt;/p&gt;
</comment>
                            <comment id="15299789" author="iamaleksey" created="Wed, 25 May 2016 10:03:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;OK, so we&apos;ll commit to 3.0+. For 2.1/2.2, as Alex Petrov pointed out above, compression will detect corruption making this patch less critical, given that compression is typically enabled in the pre 3.0 world.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Works for me.&lt;/p&gt;</comment>
                            <comment id="15300235" author="ifesdjeen" created="Wed, 25 May 2016 15:39:23 +0000"  >&lt;p&gt;One of the failures was the SASI index text and static initialisers.  I couldn&apos;t find any correlation with the current patch, it&apos;s fixed now (there was an issue with config being loaded earlier then the configuration setting for it forced, because of static initialisation). &lt;/p&gt;

&lt;p&gt;The second one is just another issue that our new randomisation caught. There was one more place where non-seeded random was used, but after several dozen runs I&apos;ve found another seed that can reproduce it: 754271160974509L in case you&apos;d like to see in more details. Corruption in this case makes row to be deserialised as an empty one. It&apos;s being normally read, although fails during the compaction. Sstable doesn&apos;t get marked as suspected and compaction fails all 25 times. &lt;/p&gt;

&lt;p&gt;I&apos;ve increased the amount of multiplexed runs to 50 (ran both tests). May be we catch some more things here. Commits in all branches are not squashed to make it simpler to go through. I&apos;ve also added more elaborate comments in commit messages.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-trunk-multiplexed/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.0-multiplexed/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/9530-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.7&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.7-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.7-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9530-3.7-multiplexed/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The rest of failures seem unrelated (also, passing locally).&lt;/p&gt;</comment>
                            <comment id="15301395" author="stefania" created="Thu, 26 May 2016 02:59:09 +0000"  >&lt;p&gt;CI is looking good now, all failing tests are either unrelated known failures or pass locally.&lt;/p&gt;

&lt;p&gt;Committed to 3.0 as 85cc390189f45be54dec9b146f66eeb7737fb0eb and merged upwards, thank you for your hard work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15304311" author="JIRAUSER308715" created="Fri, 27 May 2016 16:44:16 +0000"  >&lt;p&gt;We have Java based thrift code that uses AbstractType/C* marshaling to decode things.  I&apos;m guessing other people probably do too, this change breaks that by having AbstractType pull in DatabaseDescriptor.&lt;/p&gt;

&lt;p&gt;Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11912&quot; title=&quot;Remove DatabaseDescriptor import from AbstractType&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11912&quot;&gt;&lt;del&gt;CASSANDRA-11912&lt;/del&gt;&lt;/a&gt; to fix this.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12745745">CASSANDRA-8048</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2figf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>