<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:53:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9097] Repeated incremental nodetool repair results in failed repairs due to running anticompaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9097</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m trying to synchronize incremental repairs over multiple nodes in a Cassandra cluster, and it does not seem to easily achievable.&lt;/p&gt;

&lt;p&gt;In principle, the process iterates through the nodes of the cluster and performs `nodetool -h $NODE repair --incremental`, but that sometimes fails on subsequent nodes. The reason for failing seems to be that the repair returns as soon as the repair and the &lt;em&gt;local&lt;/em&gt; anticompaction has completed, but does not guarantee that remote anticompactions are complete. If I subsequently try to issue another repair command, they fail to start (and terminate with failure after about one minute). It usually isn&apos;t a problem, as the local anticompaction typically involves as much (or more) data as the remote ones, but sometimes not.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12787647">CASSANDRA-9097</key>
            <summary>Repeated incremental nodetool repair results in failed repairs due to running anticompaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="grddev">Gustav Munkby</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Apr 2015 10:51:21 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:59 +0000</updated>
                            <resolved>Fri, 15 May 2015 16:04:14 +0000</resolved>
                                        <fixVersion>2.1.6</fixVersion>
                    <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="14392689" author="philipthompson" created="Thu, 2 Apr 2015 13:21:57 +0000"  >&lt;p&gt;What Cassandra version are you using?&lt;/p&gt;</comment>
                            <comment id="14392823" author="grddev" created="Thu, 2 Apr 2015 15:25:06 +0000"  >&lt;p&gt;Sorry, I&apos;m on Cassandra 2.1.3&lt;/p&gt;</comment>
                            <comment id="14393989" author="yukim" created="Fri, 3 Apr 2015 02:54:52 +0000"  >&lt;p&gt;The problem is that the repair coordinator does not wait anticompaction to finish on other nodes.&lt;br/&gt;
We can change the behavior to wait until coordinator receives notification from other replica, but doing so can be a problem between the nodes in different minor version.&lt;/p&gt;

&lt;p&gt;We definitely need to fix this in 3.0, though let me see what would be the right solution for 2.1.x.&lt;/p&gt;</comment>
                            <comment id="14496515" author="aboudreault" created="Wed, 15 Apr 2015 17:03:08 +0000"  >&lt;p&gt;Is the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366&quot; title=&quot;Repair grows data on nodes, causes load to become unbalanced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8366&quot;&gt;&lt;del&gt;CASSANDRA-8366&lt;/del&gt;&lt;/a&gt; related to this issue?&lt;/p&gt;</comment>
                            <comment id="14496518" author="aboudreault" created="Wed, 15 Apr 2015 17:04:12 +0000"  >&lt;p&gt;//cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14496527" author="yukim" created="Wed, 15 Apr 2015 17:09:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366&quot; title=&quot;Repair grows data on nodes, causes load to become unbalanced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8366&quot;&gt;&lt;del&gt;CASSANDRA-8366&lt;/del&gt;&lt;/a&gt; related to this issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sort of. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366?focusedCommentId=14323935&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14323935&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-8366?focusedCommentId=14323935&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14323935&lt;/a&gt;. We need to wait other nodes&apos; anticompaction to finish. I&apos;m trying to see if we can fix this in 2.1 by adding new RepairMessage.&lt;/p&gt;</comment>
                            <comment id="14503513" author="JIRAUSER308715" created="Mon, 20 Apr 2015 19:59:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; so do you think we can fix this in 2.1?&lt;/p&gt;</comment>
                            <comment id="14511724" author="yukim" created="Fri, 24 Apr 2015 21:00:02 +0000"  >&lt;p&gt;The problem in fixing this in 2.1 is that if we add new repair message, message deserialization throws Exception in older nodes and it leads to repair hang.&lt;br/&gt;
One possible workaround is to poke &lt;tt&gt;system.peers&lt;/tt&gt; table and check cassandra version of replica nodes, and skip sending new message during the cluster is in mixed version.&lt;/p&gt;</comment>
                            <comment id="14521236" author="yukim" created="Thu, 30 Apr 2015 09:54:33 +0000"  >&lt;p&gt;Patch available here: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/9097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/9097&lt;/a&gt;&lt;br/&gt;
(This depends on work in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9151&quot; title=&quot;Anti-compaction is blocking ANTI_ENTROPY stage &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9151&quot;&gt;&lt;del&gt;CASSANDRA-9151&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;In order to fix this in 2.1, I introduced hack that checks &lt;tt&gt;release_version&lt;/tt&gt; of &lt;tt&gt;system.peers&lt;/tt&gt; table and if it is newer than the version with this fix (I make it &quot;2.1.6&quot;, but it may need to be adjusted before committing), repair waits for response of anti compaction for upto 1 day(this timeout can be debatable).&lt;/p&gt;</comment>
                            <comment id="14521592" author="jbellis" created="Thu, 30 Apr 2015 14:45:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14526856" author="yukim" created="Mon, 4 May 2015 17:03:41 +0000"  >&lt;p&gt;Attaching updated version. I changed Anticompaction response callback to handle failure.&lt;br/&gt;
Above branch is also force updated.&lt;/p&gt;</comment>
                            <comment id="14528037" author="krummas" created="Tue, 5 May 2015 06:56:23 +0000"  >&lt;p&gt;Looks good, just one small nit, the &lt;tt&gt;ANTICOMPACTION_RESPONSE_SUPPORTED = new SemanticVersion(&quot;2.1.5&quot;);&lt;/tt&gt; should probably be 2.1.6, right? then compare with &amp;gt;=, since we don&apos;t actually support the response in 2.1.5&lt;/p&gt;</comment>
                            <comment id="14528076" author="JIRAUSER308715" created="Tue, 5 May 2015 07:36:49 +0000"  >&lt;p&gt;It tests &amp;gt; not &amp;gt;=.  So maybe just rename so it reflects that.&lt;/p&gt;</comment>
                            <comment id="14528080" author="krummas" created="Tue, 5 May 2015 07:49:17 +0000"  >&lt;p&gt;sure, renaming the constant works for me, just that currently it looks like the feature was introduced in 2.1.5 while it will not be released until 2.1.6&lt;/p&gt;</comment>
                            <comment id="14532955" author="yukim" created="Thu, 7 May 2015 16:31:59 +0000"  >&lt;p&gt;Thanks for fedback. I renamed constant though I couldn&apos;t come out with good name, so I added some comments on it.&lt;/p&gt;</comment>
                            <comment id="14534880" author="krummas" created="Fri, 8 May 2015 16:58:57 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14535814" author="yukim" created="Fri, 8 May 2015 22:54:33 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="14544473" author="yukim" created="Thu, 14 May 2015 22:21:19 +0000"  >&lt;p&gt;This change still does not fix the issue when there is a failed repair session. Reopening.&lt;/p&gt;</comment>
                            <comment id="14544655" author="yukim" created="Fri, 15 May 2015 00:12:46 +0000"  >&lt;p&gt;When repair session fails, we are only removing coordinator&apos;s parent repair session.&lt;br/&gt;
Currently, parent repair session is only removed when exception is thrown from ANTIENTROPY_STAGE, but validation and streaming happen on separate threads so we have to clean them separately.&lt;/p&gt;

&lt;p&gt;I introduced new CleanupMessage and only send it to the nodes that pass version check. So adding new message should be fine.&lt;/p&gt;

&lt;p&gt;Note that this is not be an issue for 2.2+, since we are sending succeeded repair ranges, though we need to add new message to trunk for compatibility.&lt;/p&gt;

&lt;p&gt;I will (try to) write dtest to cover this scenario, though I submit patch first for the review.&lt;/p&gt;</comment>
                            <comment id="14545268" author="krummas" created="Fri, 15 May 2015 10:10:50 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I will use this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9142&quot; title=&quot;DC Local repair or -hosts should only be allowed with -full repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9142&quot;&gt;&lt;del&gt;CASSANDRA-9142&lt;/del&gt;&lt;/a&gt; - we should not do anticompaction with dc-local repairs etc&lt;/p&gt;</comment>
                            <comment id="14545718" author="yukim" created="Fri, 15 May 2015 16:04:14 +0000"  >&lt;p&gt;Committed, thanks.&lt;br/&gt;
I will continue writing dtest in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9109&quot; title=&quot;Repair appears to have some of untested behaviors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9109&quot;&gt;CASSANDRA-9109&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12819508">CASSANDRA-9143</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12819749">CASSANDRA-9151</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12733013" name="0001-Remove-parent-session-on-remotes-when-repair-fails.patch" size="10214" author="yukim" created="Fri, 15 May 2015 00:12:46 +0000"/>
                            <attachment id="12731211" name="0001-Wait-for-anticompaction-to-finish.patch" size="13504" author="yukim" created="Thu, 7 May 2015 16:31:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27p47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>