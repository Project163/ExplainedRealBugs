<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5723] DateType (timestamp type in CQL3) does not sort pre-&apos;unix epoch&apos; dates correctly</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5723</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this bug can be confirmed by fellow:&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;1.create table like fellow:&lt;/p&gt;

&lt;p&gt;create table test2 (&lt;br/&gt;
id varchar,&lt;br/&gt;
c varchar,&lt;br/&gt;
create_date timestamp,&lt;br/&gt;
primary key(id)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;create index idx_test2_c on test2 (c);&lt;br/&gt;
create index idx_test2_create_date on test2 (create_date);&lt;/p&gt;


&lt;p&gt;2.insert data like fellow;&lt;/p&gt;

&lt;p&gt;cqlsh:pgl&amp;gt; update test2 set create_date=&apos;1950-01-01&apos;, c=&apos;1&apos; where id=&apos;111&apos;;&lt;br/&gt;
cqlsh:pgl&amp;gt; update test2 set create_date=&apos;1917-01-01&apos;, c=&apos;1&apos; where id=&apos;111&apos;;&lt;br/&gt;
cqlsh:pgl&amp;gt; update test2 set create_date=&apos;2013-01-01&apos;, c=&apos;1&apos; where id=&apos;111&apos;;&lt;/p&gt;

&lt;p&gt;3.select data :&lt;br/&gt;
cqlsh:pgl&amp;gt; select * from test2 where c=&apos;1&apos; and create_date&amp;gt;&apos;2011-01-01 12:00:01&apos; ALLOW FILTERING ;&lt;/p&gt;

&lt;p&gt;id | c | create_date&lt;br/&gt;
----&lt;del&gt;&lt;ins&gt;&lt;/del&gt;-&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;-------------------------&lt;br/&gt;
111 | 1 | 2012-12-31 15:00:00+0000&lt;/p&gt;

&lt;p&gt;4. add data:&lt;br/&gt;
update test2 set create_date=&apos;1917-05-01&apos;, c=&apos;1&apos; where id=&apos;111&apos;;&lt;/p&gt;

&lt;p&gt;5.select data:&lt;br/&gt;
cqlsh:pgl&amp;gt; select * from test2 where c=&apos;1&apos; and create_date&amp;gt;&apos;2011-01-01 12:00:01&apos; ALLOW FILTERING ;&lt;/p&gt;

&lt;p&gt;id | c | create_date&lt;br/&gt;
----&lt;del&gt;&lt;ins&gt;&lt;/del&gt;-&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;-------------------------&lt;br/&gt;
111 | 1 | 1917-04-30 15:00:00+0000&lt;br/&gt;
&#8593;&lt;br/&gt;
the search result is not right!&lt;br/&gt;
it should be fellow:&lt;/p&gt;

&lt;p&gt;id | c | create_date&lt;br/&gt;
----&lt;del&gt;&lt;ins&gt;&lt;/del&gt;-&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;-------------------------&lt;br/&gt;
111 | 1 | 2012-12-31 15:00:00+0000&lt;/p&gt;</description>
                <environment></environment>
        <key id="12656161">CASSANDRA-5723</key>
            <summary>DateType (timestamp type in CQL3) does not sort pre-&apos;unix epoch&apos; dates correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="zhouhero">zhouhero</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Jul 2013 08:19:43 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:10 +0000</updated>
                            <resolved>Mon, 8 Jul 2013 16:59:38 +0000</resolved>
                                        <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13700164" author="slebresne" created="Thu, 4 Jul 2013 15:51:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;it should be fellow&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, it should be empty, because you&apos;re overwriting the same row all the time, so after that update in 4, the row &apos;111&apos; should contain &lt;tt&gt;create_date=&apos;1917-05-01&apos;&lt;/tt&gt; and you could rightfully expect to not get that row back with your query.&lt;/p&gt;

&lt;p&gt;The reason it&apos;s actually returned is that for some reason, DateType.compare() (the comparator used for the timestamp CQL3 type) use an unsigned comparison, and since 1917 is before the unix epoch, it&apos;s timestamp is negative and wrongfully sort after any post-epoch date. This is &lt;b&gt;not&lt;/b&gt; a CQL3 specific bug in particular.&lt;/p&gt;

&lt;p&gt;The simple fix would be to change the comparison to be signed, but there is obviously backward compatibility concerns (since DateType has done that for years). In any case, in the meantime, avoid pre-epoch dates.&lt;/p&gt;</comment>
                            <comment id="13700659" author="slebresne" created="Fri, 5 Jul 2013 13:28:21 +0000"  >&lt;p&gt;I&apos;m slightly surprised that nobody ran into this with DateType and I would argue that sorting pre-epoch dates after post-epoch ones is definitively a bug, but at the same time changing DateType now is too risky imo as it could screw current DateType rather badly.&lt;/p&gt;

&lt;p&gt;Instead, I would suggest adding a new, fixed, DateType (TimestampType or DateTimeType maybe?). And for CQL3, we would switch to that for the &apos;timestamp&apos; type (which would not switch existing table however, since they would still be DateType internally). We can also make it so that switching (manually) from/to DateType to that new type is allowed (with maybe a warning in the log).&lt;/p&gt;

&lt;p&gt;Opinions?&lt;/p&gt;</comment>
                            <comment id="13701213" author="jbellis" created="Sat, 6 Jul 2013 01:09:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Instead, I would suggest adding a new, fixed, DateType (TimestampType or DateTimeType maybe?). And for CQL3, we would switch to that for the &apos;timestamp&apos; type (which would not switch existing table however, since they would still be DateType internally). We can also make it so that switching (manually) from/to DateType to that new type is allowed (with maybe a warning in the log)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds reasonable.  What would we show for the old tables on the CQL side?  &quot;oldtimestamp?&quot;  &lt;/p&gt;

&lt;p&gt;(I would vote for TimestampType.)&lt;/p&gt;</comment>
                            <comment id="13701329" author="slebresne" created="Sat, 6 Jul 2013 12:44:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;What would we show for the old tables on the CQL side? &quot;oldtimestamp?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking of not having be any CQL3 specific type. I.e. it would be displayed as a custom type, or &quot;org.apache.cassandra.db.marshal.DateType&quot;.&lt;/p&gt;</comment>
                            <comment id="13701369" author="jbellis" created="Sat, 6 Jul 2013 15:46:21 +0000"  >&lt;p&gt;That&apos;s reasonable.&lt;/p&gt;</comment>
                            <comment id="13702013" author="slebresne" created="Mon, 8 Jul 2013 14:02:59 +0000"  >&lt;p&gt;Attaching a patch with that new TimestampType. The patch is against 1.2 right now, but I&apos;m starting to wonder if 2.0 is not a more reasonable goal.&lt;/p&gt;

&lt;p&gt;The basics of the patch is that the CQL3 timestamp type now default to that new type. For the native protocol however, we make both DateType and TimestampType be returned as &apos;timestamp&apos;. Otherwise, if we were returning it as a custom type, this would likely break users since client driver wouldn&apos;t recognize it anymore. Besides, the actual sorting of a type in a ResultSet shouldn&apos;t matter for a CQL3 driver.&lt;/p&gt;

&lt;p&gt;On the CQL-over-thrift side however, we return the full &quot;thrift&quot; comparator name, so in practice we&apos;d have to update cqlsh so it continues to work with dates, but the patch doesn&apos;t do it.&lt;/p&gt;

&lt;p&gt;The patch let user switch between DateType and TimestampType, but log a warning when you do so.&lt;/p&gt;</comment>
                            <comment id="13702091" author="jbellis" created="Mon, 8 Jul 2013 16:20:01 +0000"  >&lt;p&gt;+1, but I agree that this should be for 2.0.&lt;/p&gt;</comment>
                            <comment id="13702121" author="slebresne" created="Mon, 8 Jul 2013 16:59:38 +0000"  >&lt;p&gt;Alright, committed to trunk only then.&lt;/p&gt;

&lt;p&gt;I&apos;ve also created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5719&quot; title=&quot;Expire entries out of ThriftSessionManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5719&quot;&gt;&lt;del&gt;CASSANDRA-5719&lt;/del&gt;&lt;/a&gt; to followup on the cqlsh changes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12838513">CASSANDRA-9609</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12591217" name="5723.txt" size="16291" author="slebresne" created="Mon, 8 Jul 2013 14:02:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1m15z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336760</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>