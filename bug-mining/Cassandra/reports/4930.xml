<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:10:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13992] Don&apos;t send new_metadata_id for conditional updates</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13992</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is a follow-up to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10786&quot; title=&quot;Include hash of result set metadata in prepared statement id&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10786&quot;&gt;&lt;del&gt;CASSANDRA-10786&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Given the table&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE foo (k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And the prepared statement&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT INTO foo (k) VALUES (?) IF NOT EXISTS
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result set metadata changes depending on the outcome of the update:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if the row didn&apos;t exist, there is only a single column [applied] = true&lt;/li&gt;
	&lt;li&gt;if it did, the result contains [applied] = false, plus the current value of column k.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The way this was handled so far is that the PREPARED response contains no result set metadata, and therefore all EXECUTE messages have SKIP_METADATA = false, and the responses always include the full (and correct) metadata.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10786&quot; title=&quot;Include hash of result set metadata in prepared statement id&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10786&quot;&gt;&lt;del&gt;CASSANDRA-10786&lt;/del&gt;&lt;/a&gt; still sends the PREPARED response with no metadata, &lt;b&gt;but the response to EXECUTE now contains a &lt;tt&gt;new_metadata_id&lt;/tt&gt;&lt;/b&gt;. The driver thinks it is because of a schema change, and updates its local copy of the prepared statement&apos;s result metadata.&lt;/p&gt;

&lt;p&gt;The next EXECUTE is sent with SKIP_METADATA = true, but the server appears to ignore that, and still sends the metadata in the response. So each response includes the correct metadata, the driver uses it, and there is no visible issue for client code.&lt;/p&gt;

&lt;p&gt;The only drawback is that the driver updates its local copy of the metadata unnecessarily, every time. We can work around that by only updating if we had metadata before, at the cost of an extra volatile read. But I think the best thing to do would be to never send a &lt;tt&gt;new_metadata_id&lt;/tt&gt; in for a conditional update.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13116066">CASSANDRA-13992</key>
            <summary>Don&apos;t send new_metadata_id for conditional updates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="omichallat">Olivier Michallat</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Nov 2017 21:35:20 +0000</created>
                <updated>Tue, 7 Mar 2023 11:52:24 +0000</updated>
                            <resolved>Tue, 21 Nov 2017 12:17:32 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16241847" author="kurtg" created="Tue, 7 Nov 2017 11:23:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;The next EXECUTE is sent with SKIP_METADATA = true, but the server appears to ignore that&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I believe this is because METADATA_CHANGED will take precedence. If C* thinks the metadata changed it will set the METADATA_CHANGED flag and the driver should need to update it&apos;s metadata. TBH this isn&apos;t super clear from the spec but appears to be what the code achieves &lt;a href=&quot;https://github.com/apache/cassandra/blob/922dbdb658b1693973926026b213153d05b4077c/src/java/org/apache/cassandra/transport/messages/ExecuteMessage.java#L174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I may have no idea what I&apos;m talking about but I think the simplest solution to &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;never send a new_metadata_id in for a conditional update.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;would be to simply always use the same digest for any LWT.&lt;br/&gt;
I think the following patch achieves this without breaking anything but I haven&apos;t confirmed if it actually fixes the driver issue yet. If someone with more understanding of the protocol and what not could have a glance and let me know if this makes sense or point me in the right direction.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...kgreav:13992-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16244458" author="omichallat" created="Wed, 8 Nov 2017 18:12:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;If C* thinks the metadata changed it will set the METADATA_CHANGED flag and the driver should need to update it&apos;s metadata. TBH this isn&apos;t super clear from the spec but appears to be what the code achieves here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That makes sense, and indeed explains why the server ignores SKIP_METADATA.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested your patch against a driver snapshot. The bound statement executions now always return the same (empty) digest, but the problem is that the initial preparation still returns a non-empty digest. So the driver executes with that initial digest and gets METADATA_CHANGED with the empty digest every time.&lt;br/&gt;
The prepare should also return an empty digest, which I think should be done around &lt;a href=&quot;https://github.com/kgreav/cassandra/blob/fa259fd79ea3e0a0fac8583a54c9c76464a653be/src/java/org/apache/cassandra/cql3/QueryProcessor.java#L444&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16245469" author="ifesdjeen" created="Thu, 9 Nov 2017 10:22:36 +0000"  >&lt;p&gt;If we take this patch, I&apos;d definitely constantize the &quot;empty&quot; hash, as very least.&lt;/p&gt;

&lt;p&gt;Other than that - I think we should add more tests with LWTs (preferably dtests) and check what happens when we actually alter the table. Since in this case it seems what will happen is when table is ALTER&apos;ed, metadata won&apos;t update (I haven&apos;t checked it though). In the initial patch we&apos;ve tried always forcing metadata transfer for LWTs. If the patch has the same effect (metadata is transferred every time). I&apos;m not insisting on any particular solution here though.  &lt;/p&gt;</comment>
                            <comment id="16246907" author="kurtg" created="Fri, 10 Nov 2017 02:10:31 +0000"  >&lt;p&gt;So it seems that prepare does return an empty digest, however &lt;tt&gt;ResultSet.ResultMetadata.EMPTY&lt;/tt&gt; is created with &lt;tt&gt;compute&lt;/tt&gt; and is thus a thread local digest, which will get a different hash. From what I can see EMPTY is only ever used in one place worth mentioning, and that&apos;s in &lt;tt&gt;org.apache.cassandra.cql3.ResultSet.ResultMetadata#fromPrepared&lt;/tt&gt; (it&apos;s also used in &lt;tt&gt;org.apache.cassandra.transport.Message.Codec#decode&lt;/tt&gt; but only for protocol versions prior to V1), and will be used for anything that&apos;s not a &lt;tt&gt;SELECT&lt;/tt&gt; statement. &lt;/p&gt;

&lt;p&gt;Now, what I&apos;m wondering is there any significant reason the ID for an &quot;EMPTY&quot; metadata ID is created as a thread local digest?&lt;br/&gt;
If we can change empty to instead use &lt;tt&gt;MD5Digest.wrap()&lt;/tt&gt; we solve the prepared problem.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omichallat&quot; class=&quot;user-hover&quot; rel=&quot;omichallat&quot;&gt;omichallat&lt;/a&gt; Before I waste a lot of time figuring out how to test this in the driver, can you point me at how you did it?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since in this case it seems what will happen is when table is ALTER&apos;ed, metadata won&apos;t update (I haven&apos;t checked it though)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes we&apos;ll probably need to do something about this. I&apos;ll write up some tests first. &lt;/p&gt;</comment>
                            <comment id="16249071" author="omichallat" created="Mon, 13 Nov 2017 03:26:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Before I waste a lot of time figuring out how to test this in the driver, can you point me at how you did it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The driver-side changes are not merged yet, but you can find them in &lt;a href=&quot;https://github.com/datastax/java-driver/pull/794&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this pull request&lt;/a&gt;. The test that covers this specific scenario is &lt;a href=&quot;https://github.com/datastax/java-driver/blob/46825e446ae9d5f57baeb4f5f2c1f5fc4b99d972/driver-core/src/test/java/com/datastax/driver/core/PreparedStatementInvalidationTest.java#L182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PreparedStatementInvalidationTest#should_never_update_statement_id_for_conditional_updates_in_modern_protocol&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To run the test you&apos;ll need to install CCM (see some instructions &lt;a href=&quot;https://github.com/datastax/java-driver/blob/3.3.x/CONTRIBUTING.md#running-the-tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). Then because you&apos;re not testing a released Cassandra version, you&apos;ll need to point the test harness to your local working copy with those system properties: &lt;tt&gt;-Dcassandra.version=4.0.0 -Dcassandra.directory=/path/to/cassandra&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;If you want to do some debugging, the result metadata is handled in &lt;tt&gt;ArrayBackedResultSet.java&lt;/tt&gt;. Search for &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13992&quot; title=&quot;Don&amp;#39;t send new_metadata_id for conditional updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13992&quot;&gt;&lt;del&gt;CASSANDRA-13992&lt;/del&gt;&lt;/a&gt;&quot;, there is a comment that explains what should be changed if this ticket is fixed.&lt;/p&gt;</comment>
                            <comment id="16249215" author="ifesdjeen" created="Mon, 13 Nov 2017 08:01:52 +0000"  >&lt;p&gt;I&apos;ve composed a version of the patch, to demonstrate my thinking &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:CASSANDRA-13992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. It seems that we can solve this problem without patching the driver. In fact, it might be even better if inner doings of metadata hash are transparent for the driver.&lt;/p&gt;

&lt;p&gt;In short, we can always force &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; for conditional statements and avoid computing their metadata to make sure it&apos;s empty. It&apos;s a rough equivalent of making metadata hash random, just simpler to reason about. What do you think about it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omichallat&quot; class=&quot;user-hover&quot; rel=&quot;omichallat&quot;&gt;omichallat&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16249838" author="omichallat" created="Mon, 13 Nov 2017 17:17:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; that would work, the driver can treat an empty &lt;tt&gt;new_metadata_id&lt;/tt&gt; as &quot;don&apos;t update my local copy&quot;. Namely, changing &lt;a href=&quot;https://github.com/datastax/java-driver/blob/6eeb8b2193ab5b50b73b0d9a533e775265f11007/driver-core/src/main/java/com/datastax/driver/core/ArrayBackedResultSet.java#L83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line&lt;/a&gt; to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newMetadataId != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; newMetadataId.bytes.length &amp;gt; 0) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However that feels kind of hacky. Consider how we would have to explain that in the protocol spec:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;new_metadata_id&amp;gt; is [short bytes] representing the new, changed resultset&lt;br/&gt;
           metadata. The new metadata ID must also be used in subsequent executions of&lt;br/&gt;
           the corresponding prepared statement, if any, &lt;b&gt;except if it is empty&lt;/b&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;It would make so much more sense to force &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; to &lt;b&gt;false&lt;/b&gt; for conditional updates, isn&apos;t there any way we can do that?&lt;/p&gt;</comment>
                            <comment id="16250071" author="ifesdjeen" created="Mon, 13 Nov 2017 19:42:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omichallat&quot; class=&quot;user-hover&quot; rel=&quot;omichallat&quot;&gt;omichallat&lt;/a&gt; not sure, since &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; is just a flag: e.g. if it&apos;s set it&apos;s &lt;tt&gt;true&lt;/tt&gt;, otherwise it&apos;s &lt;tt&gt;false&lt;/tt&gt;. Moreover, I think that the default behaviour for LWTs has to be that we &lt;em&gt;always&lt;/em&gt; update metadata: there&apos;s no way for server to know what was the last metadata on the client (since it depends on the result), the server can&apos;t distinguish between the metadata hash inequality caused by &lt;tt&gt;ALTER&lt;/tt&gt; vs caused by success/non-success LWT result.&lt;/p&gt;

&lt;p&gt;Unless I&apos;m missing something, my patch achieves exactly that (also, without any driver changes): it forces the server to &lt;em&gt;always&lt;/em&gt; send the metadata. This, combined with the metadata consisting of zeroes can instruct the client that caching metadata is possible, but won&apos;t bring anything: new result metadata will just be re-delivered on every call, since it&apos;s potentially going to be changing on every request.&lt;/p&gt;

&lt;p&gt;I haven&apos;t updated spec though. I will, if/when we agree on the behaviour.&lt;/p&gt;</comment>
                            <comment id="16250154" author="omichallat" created="Mon, 13 Nov 2017 20:09:04 +0000"  >&lt;p&gt;&lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; tells the client if it needs to update its local copy of the metadata. For conditional updates, the answer is always no (since the client should never store that information in the first place); that is why I think it&apos;s more intuitive to set the flag to false.&lt;/p&gt;

&lt;p&gt;To put it another way: if the flag is forced to true, I have to add a condition in the client code (&lt;tt&gt;newMetadataId.bytes.length &amp;gt; 0&lt;/tt&gt;). My worry is that a client implementation could forget to check that the id is empty, and end up with a sub-optimal behavior (that updates the local metadata unnecessarily each time).&lt;/p&gt;

&lt;p&gt;If the flag is absent, conditional updates can be handled like any other statement.&lt;/p&gt;
</comment>
                            <comment id="16250786" author="kurtg" created="Tue, 14 Nov 2017 03:51:12 +0000"  >&lt;p&gt;My understanding is that, at the moment, &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; will &lt;em&gt;always&lt;/em&gt; be set for a conditional update, regardless of whether it&apos;s necessary or not. Necessary being defined as the schema has actually changed and the prepared statements need to be updated client side to reflect those schema changes. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omichallat&quot; class=&quot;user-hover&quot; rel=&quot;omichallat&quot;&gt;omichallat&lt;/a&gt; is this true? what exactly is &quot;metadata&quot; referring to on the driver side, and why is the answer &quot;always no&quot; for conditional updates? If there is a change to one of the columns in the update is that going to cause problems if we don&apos;t tell the driver that it has changed?&lt;/p&gt;

&lt;p&gt;I&apos;m with Olivier that that&apos;s a hacky addition to the driver, but if it&apos;s not even necessary as per above then simply only passing an empty digest will be sufficient.&lt;/p&gt;

&lt;p&gt;I&apos;ve updated my &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...kgreav:13992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; to reflect this. Note I&apos;ve changed to using &lt;tt&gt;MD5Digest#compute&lt;/tt&gt; to calculate an &quot;empty&quot; digest. Although it&apos;s thread local it will always be the same digest, and this will also solve the initial preparation problem, as it also uses the &lt;tt&gt;EMPTY&lt;/tt&gt; resultset + metadata.&lt;/p&gt;


</comment>
                            <comment id="16251096" author="ifesdjeen" created="Tue, 14 Nov 2017 08:39:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;METADATA_CHANGED tells the client if it needs to update its local copy of the metadata. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, great point. Sure, I&apos;ve changed the patch to &lt;em&gt;always&lt;/em&gt; send metadata (by avoiding setting &lt;tt&gt;SKIP_METADATA&lt;/tt&gt; for LWTs) and &lt;em&gt;never&lt;/em&gt; send metadata id when statement is LWT (by avoiding setting &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; for LWTs)). Technically, &lt;tt&gt;EMPTY&lt;/tt&gt; part isn&apos;t even necessary in that case, but we don&apos;t have to calculate it, so why not. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; to give a bit of context, &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; flag is instructing the driver to cache a newly received version of metadata (alongside with a new metadata ID). While &lt;tt&gt;SKIP_METADATA&lt;/tt&gt; flag is hinting the driver to use already cached metadata from previous responses. If I understood it correctly, what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omichallat&quot; class=&quot;user-hover&quot; rel=&quot;omichallat&quot;&gt;omichallat&lt;/a&gt; proposed here was to avoid setting &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; flag, so driver wouldn&apos;t cache the metadata, &lt;em&gt;but&lt;/em&gt; still send a metadata all the time (since it&apos;s potentially changing on each request).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m with Olivier that that&apos;s a hacky addition to the driver&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There&apos;s no addition to the driver (also, was no addition in the previous version of the patch). The only difference is that we can spare the driver a couple of cycles. Behaviour was right in both cases.&lt;/p&gt;

&lt;p&gt;I&apos;ve pulled in the last version of the driver, added comments and prettified it a bit. If we all agree that this behaviour is correct, can anyone take a short look at it?&lt;/p&gt;

&lt;p&gt;The patch can be found:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:CASSANDRA-13992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16252848" author="kurtg" created="Wed, 15 Nov 2017 02:16:55 +0000"  >&lt;p&gt;I don&apos;t see why special casing LWT is necessary. It couples LWT, &lt;tt&gt;ModificationStatement&lt;/tt&gt; and &lt;tt&gt;BatchStatement&lt;/tt&gt; with &lt;tt&gt;ExecuteMessage&lt;/tt&gt;, which seems a bit messy. It also introduces a weird edge case into the protocol - i.e, &lt;br/&gt;
1. you can&apos;t skip metadata for LWT &lt;br/&gt;
2. metadata will never be changed for LWT. &lt;/p&gt;

&lt;p&gt;2 is fine as it&apos;s somewhat the goal of the ticket, but when we already have a mechanism to meet this requirement it seems silly to wrap it in another. 1 just adds complexity to the protocol, which imo, is complex enough. It&apos;s not even clear in the protocol that SKIP_METADATA will be ignored if the metadata &lt;b&gt;did&lt;/b&gt; change (we should update this in the patch). I think this can be better solved simply by providing a consistent MD5 for LWT&apos;s as my patch already does &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...kgreav:13992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. This removes the need to introduce new imports, and special casing to &lt;tt&gt;ExecuteMessage&lt;/tt&gt; while achieving the same behaviour, and I think logically is easier to explain.&lt;/p&gt;

&lt;p&gt;AFAICT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&apos;s patch only really works because the driver is already set up for it to work. The &lt;em&gt;java&lt;/em&gt; driver already checks that &lt;tt&gt;new_metadata_id != null&lt;/tt&gt; which is logical, but in no way required. It seems to me we&apos;re introducing a metadata_id that could potentially be null where a driver might expect it to have a value. I prefer my patch, or better yet, we create an &lt;tt&gt;EMPTY_DIGEST&lt;/tt&gt; that&apos;s an actual MD5 to use so we don&apos;t have to rely on &lt;tt&gt;compute&lt;/tt&gt; every time we want to use an &lt;tt&gt;EMPTY_DIGEST&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16253022" author="omichallat" created="Wed, 15 Nov 2017 06:33:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; yes, your last patch is fine for me from a client&apos;s perspective (I can&apos;t really comment on the implementation since I&apos;m not that familiar with the Cassandra codebase).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;you can&apos;t skip metadata for LWT&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nor should you be able to. You can&apos;t safely skip metadata since these statements may return different columns depending on the state of the database. You &lt;em&gt;have&lt;/em&gt; to return the metadata every time.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;metadata will never be changed for LWT&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We don&apos;t need it since every response includes the correct metadata.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;AFAICT Alex Petrov&apos;s patch only really works because the driver is already set up for it to work.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually no, it allows the driver to treat LWT as any other statement. Here&apos;s roughly what we do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// When decoding a PREPARED response
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ! NO_METADATA &lt;span class=&quot;code-comment&quot;&gt;// Note that LWT always have NO_METADATA
&lt;/span&gt;  store result metadata in prepared statement cache
end &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;

&lt;span class=&quot;code-comment&quot;&gt;// When decoding a ROWS response:
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; NO_METADATA
  look up result metadata in prepared statement cache
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
  decode result metadata from response
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (METADATA_CHANGED)
    update result metadata in prepared statement cache
  end &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
end &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So unsetting &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; for LWT allows me to properly skip the last cache update. If we use a special value of &lt;tt&gt;new_metadata_id&lt;/tt&gt; instead (like the empty array in the initial patch), then I have to change the last test to &lt;tt&gt;if (METADATA_CHANGED || new_metadata_id == special_value)&lt;/tt&gt;.&lt;br/&gt;
HTH&lt;/p&gt;</comment>
                            <comment id="16253188" author="ifesdjeen" created="Wed, 15 Nov 2017 09:35:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; could you take a look at the patch as you&apos;re most familiar with the previous version and we&apos;ve discussed the behaviour for LWTs multiple times?&lt;/p&gt;</comment>
                            <comment id="16253220" author="kurtg" created="Wed, 15 Nov 2017 10:10:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;then I have to change the last test to if (METADATA_CHANGED || new_metadata_id == special_value)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In Alex&apos;s last version, yes, but if the metadata ID from the prepare and the exec are the same (because they are generated with the same value) this is not the case. You wouldn&apos;t have to worry about METADATA_CHANGED being set because a LWT will always have the same ID as the initial preparation. &amp;lt;bikeshedding&amp;gt;&lt;/p&gt;</comment>
                            <comment id="16253236" author="ifesdjeen" created="Wed, 15 Nov 2017 10:27:46 +0000"  >&lt;p&gt;I thought we have discussed it and I&apos;ve tried this idea out and it doesn&apos;t solve the problem with actually updating the metadata when performing &lt;tt&gt;ALTER&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This is a problem with many pitfalls, I&apos;ve done a lot of testing both back when wrote an initial patch and now when we were collaborating on the follow-up and personally believe the proposed patch solves a problem in the best possible way. I&apos;m happy to hear all the alternatives out as long as they&apos;re tested out and confirmed to work for all cases and keep consistency with previous versions.&lt;/p&gt;</comment>
                            <comment id="16253591" author="omichallat" created="Wed, 15 Nov 2017 15:17:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;You wouldn&apos;t have to worry about METADATA_CHANGED being set because a LWT will always have the same ID as the initial preparation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But then I would have to compare the ids every time. That costs me a lookup in my client-side prepared statement cache (and there also happens to be an additional volatile read in our current implementation). In contrast, checking METADATA_CHANGED is free since it is already in the response.&lt;/p&gt;</comment>
                            <comment id="16254639" author="kurtg" created="Thu, 16 Nov 2017 02:14:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;But then I would have to compare the ids every time. That costs me a lookup in my client-side prepared statement cache (and there also happens to be an additional volatile read in our current implementation). In contrast, checking METADATA_CHANGED is free since it is already in the response.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;OK I get it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I thought we have discussed it and I&apos;ve tried this idea out and it doesn&apos;t solve the problem with actually updating the metadata when performing ALTER.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Just trying to understand things here but from what I can see the patches both provide the same behaviour. Notably, METADATA_CHANGED will never be set for LWT but the metadata will still always be returned to the client. Anyway, you can do it that way if you want seeing as it helps on the java driver side. &lt;/p&gt;

&lt;p&gt;But now that I think about it more and after some testing I don&apos;t see how either case works completely for &lt;tt&gt;ALTER&lt;/tt&gt;. When you say ALTER what are you referring to? AFAICT all you can do is add + drop columns that aren&apos;t used in the prepared statement, and atm both patches behave in the exact same way. If you alter any column used in the statement it invalidates the statement and you get an error. What aspects of ALTER are you expecting to work?&lt;/p&gt;</comment>
                            <comment id="16255351" author="snazy" created="Thu, 16 Nov 2017 13:56:32 +0000"  >&lt;p&gt;As elaborated above, LWTs definitely need special handling as their result set is (or can be) different for each invocation. Remembering (and evicting) metadata for that result set (which is in the &quot;ok&quot; case just one column &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;applied&amp;#93;&lt;/span&gt;&lt;/tt&gt; - i.e. not much) is probably not beneficiary. Doing that might be worth another look in a separate ticket at a later point. But I don&apos;t expect much from that kind of optimization.&lt;/p&gt;

&lt;p&gt;I&apos;m not excited about adding a &quot;special value&quot; to indicate that the metadata is empty (neither an empty &lt;tt&gt;byte[]&lt;/tt&gt; nor the MD5 over an empty &lt;tt&gt;byte[]&lt;/tt&gt;). Just omitting the metadata flags introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10786&quot; title=&quot;Include hash of result set metadata in prepared statement id&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10786&quot;&gt;&lt;del&gt;CASSANDRA-10786&lt;/del&gt;&lt;/a&gt; is sufficient.&lt;/p&gt;

&lt;p&gt;Olivier correctly pointed out that (unnecessary) additional processing should be avoided - and I second that. Looking at the &lt;tt&gt;METADATA_CHANGED&lt;/tt&gt; flag is very cheap - comparing values is more expensive (checking a bit in a CPU register or L1 cache line vs. many dloads). Keeping the performance aspect aside, it also looks cleaner.&lt;/p&gt;

&lt;p&gt;Since we do not need those metadata-flags for LWTs, we can just omit those and it &quot;magically&quot; works - and that&apos;s pretty much what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&apos;s patch does.&lt;/p&gt;

&lt;p&gt;I&apos;ve written a &lt;a href=&quot;https://github.com/snazy/cassandra/commit/fcb221af2dcc74c57e3017b73937365e2226b7d3#diff-d04861816aec1bdaa47b3d6819df1a46R277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unit test&lt;/a&gt; that verifies the expected behavior on the protocol level.&lt;/p&gt;

&lt;p&gt;+1 on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&apos;s patch. I&apos;d like to see the new unit test being added.&lt;br/&gt;
Only change that would be good to have is to move the &lt;tt&gt;boolean hasConditions()&lt;/tt&gt; function up to &lt;tt&gt;CQLStatement&lt;/tt&gt; and implement it there as &lt;tt&gt;public default boolean hasConditions() { return false; } }}. By that you can remove the {{instanceof&lt;/tt&gt; and type casts in the change in &lt;tt&gt;ExecuteMessage&lt;/tt&gt; and probably also save the &lt;tt&gt;isLWT&lt;/tt&gt; variable as it would just be a call to &lt;tt&gt;statement.hasConditions()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16260641" author="ifesdjeen" created="Tue, 21 Nov 2017 12:17:07 +0000"  >&lt;p&gt;Thank you for the review! &lt;/p&gt;

&lt;p&gt;Committed to trunk with &lt;a href=&quot;https://github.com/apache/cassandra/commit/7eb915097dc3e34e1bb4ef96e6bd8eb67d574622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7eb915097dc3e34e1bb4ef96e6bd8eb67d574622&lt;/a&gt; with added unit test and &lt;tt&gt;hasConditions&lt;/tt&gt; pulled up to statement.&lt;/p&gt;</comment>
                            <comment id="16282724" author="kurtg" created="Thu, 7 Dec 2017 23:37:16 +0000"  >&lt;p&gt;Should we have updated the spec to indicate that those flags will not work with LWT? Seems like it could be quite surprising for new driver developers.&lt;/p&gt;</comment>
                            <comment id="16283448" author="ifesdjeen" created="Fri, 8 Dec 2017 12:10:29 +0000"  >&lt;p&gt;We didn&apos;t do any client-side changes. As far as I can understand, metadata changes are server-driven. &lt;/p&gt;</comment>
                            <comment id="16284041" author="omichallat" created="Fri, 8 Dec 2017 19:03:46 +0000"  >&lt;p&gt;Yes, with the algorithm I described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13992?focusedCommentId=16253022&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16253022&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this comment&lt;/a&gt;, LWTs are handled exactly the same way as regular statements, so I don&apos;t think we need to amend the spec.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12916909">CASSANDRA-10786</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mdyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351720">5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>snazy</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>