<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:23:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17342] Performance problem for node restart with incremental range repairs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17342</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There is a performance problem when restarting cassandra for clusters doing incremental repairs with range repairs. &lt;/p&gt;

&lt;p&gt;We have clusters with 16 vnodes per node, and are splitting each vnode into 100 ranges, this causes a node to take over 30 minutes to process the data stored in the system.repairs table before the node can restart. Even when we reduce this to 10 ranges per vnode this still takes 2 minutes to process. The cluster has 22 keyspaces and a rf of 3, this creates around 8100 records in the system.repairs table.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem seems to occur in the org.apache.cassandra.repair.consistent.RepairState class where the add method re processes the complete list, including sorting, every time a new Range is added. This leads is an exponential growth in processing time, this is demonstrated in the attached unit test.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have created a change, that collects the data read in from the system.repairs table, in the org.apache.cassandra.repair.consistent.LocalSessions class, before processing it as a group at the end, this reduces the processing time to a couple of seconds even for the 100 range version.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is my first attempt at changing the cassandra code, so I am in need of a mentor to help me with the process, and validate what I have done.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13426253">CASSANDRA-17342</key>
            <summary>Performance problem for node restart with incremental range repairs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulchandler">Paul Chandler</assignee>
                                    <reporter username="paulchandler">Paul Chandler</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Feb 2022 18:18:29 +0000</created>
                <updated>Fri, 27 May 2022 19:25:26 +0000</updated>
                            <resolved>Fri, 11 Feb 2022 13:17:44 +0000</resolved>
                                        <fixVersion>4.0.3</fixVersion>
                    <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17486016" author="brandon.williams" created="Wed, 2 Feb 2022 18:40:54 +0000"  >&lt;p&gt;Paul, thanks for reporting this, your analysis looks solid to me.&lt;/p&gt;

&lt;p&gt;I see your test attachment, do you also have the code changes to LocalSessions available?   Reviewing that will help determine the next steps here.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; I think this came from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9143&quot; title=&quot;Fix consistency of incrementally repaired data across replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9143&quot;&gt;&lt;del&gt;CASSANDRA-9143&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17486026" author="paulchandler" created="Wed, 2 Feb 2022 18:51:49 +0000"  >&lt;p&gt;Thanks Brandon, currently my change is a bit of a rough and ready hack, so I will make it more presentable and then share it&#160;&lt;/p&gt;</comment>
                            <comment id="17486100" author="paulchandler" created="Wed, 2 Feb 2022 21:04:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; These are the changes I have done:&lt;/p&gt;

&lt;p&gt;In LocalSessions.java, I have modified the method maybeUpdateRepairedState to store the level data for later if the node is in the process of starting. I have added the method finaliseStates to process all the data at the end.&lt;/p&gt;

&lt;p&gt;In RepairedState.java added the method finaliseInitalLevels and refactored the add method to pull out the processLevels method which will now do the processing during start up and during steady state.&lt;/p&gt;

&lt;p&gt;I have created UnitTest BulkRepairStateTest, this is basically a copy RepairStateTest, but calling the new methods instead.&lt;/p&gt;

&lt;p&gt;I have not done that much testing, but the command nodetool repair_admin summarize-repaired does give the same results as before.&lt;/p&gt;</comment>
                            <comment id="17486128" author="brandon.williams" created="Wed, 2 Feb 2022 22:06:25 +0000"  >&lt;p&gt;Thanks, Paul.  To make this easier for collaboration, could you put this into a git repository?&lt;/p&gt;</comment>
                            <comment id="17486369" author="paulchandler" created="Thu, 3 Feb 2022 10:48:10 +0000"  >&lt;p&gt;I have created a pull request here: &lt;a href=&quot;https://github.com/paulchandler/cassandra/pull/1/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/paulchandler/cassandra/pull/1/files&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;This is the first time for me doing this, so not sure if I have done it correctly, if not, I welcome any guidance to improve.&#160;&lt;/p&gt;</comment>
                            <comment id="17486439" author="brandon.williams" created="Thu, 3 Feb 2022 12:50:21 +0000"  >&lt;p&gt;That&apos;s perfect.  I&apos;ve moved this to Patch Available to signal it is ready to be reviewed.  Thanks Paul!&lt;/p&gt;</comment>
                            <comment id="17486469" author="krummas" created="Thu, 3 Feb 2022 13:17:48 +0000"  >&lt;p&gt;Hi, thanks fro the patch and welcome to the project&lt;/p&gt;

&lt;p&gt;I just had a quick pass over the patch and it looks like a good approach&lt;/p&gt;

&lt;p&gt;There are some code style issues in the patch, see &lt;a href=&quot;https://cassandra.apache.org/_/development/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassandra.apache.org/_/development/index.html&lt;/a&gt; for information on how to set up your IDE etc&lt;/p&gt;

&lt;p&gt;Then, I wonder if it would be better to add an &lt;tt&gt;addAll(Collection&amp;lt;Level&amp;gt; ...)&lt;/tt&gt; method on &lt;tt&gt;RepairedState&lt;/tt&gt; and then collect the initial Levels in a local list in LocalSessions#start() instead of using &lt;tt&gt;initialLevels&lt;/tt&gt; in &lt;tt&gt;RepairedState&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17486487" author="paulchandler" created="Thu, 3 Feb 2022 13:42:27 +0000"  >&lt;p&gt;Thanks Marcus,&lt;/p&gt;

&lt;p&gt;I will take a look at the style issues.&lt;/p&gt;

&lt;p&gt;I did think about doing it as an addAll method, I can&apos;t remember what stopped me, so I will revisit it.&lt;/p&gt;</comment>
                            <comment id="17486526" author="paulchandler" created="Thu, 3 Feb 2022 14:32:46 +0000"  >&lt;p&gt;If I create a Level object in the LocalSessions class, that needs to be passed to multiple RepairedState objects, one per table ( this is currently done in the maybeUpdateRepairedState method ) So if I was storing the Level object in a collection this would need to be a collection of collections, one for each table/RepairedState. Which seems to add extra complexity to the LocalSessions, when it is simpler to directly store them in the RepairedState class. &lt;/p&gt;

&lt;p&gt;If you think this is the right way to go, then I am happy to do that, or if there is a different way I am happy to hear it. My Java skills are rather rusty, I did send 15 years writing demand forecasting algorithms, but stopped that 10 years ago!&lt;/p&gt;</comment>
                            <comment id="17486547" author="krummas" created="Thu, 3 Feb 2022 15:17:17 +0000"  >&lt;p&gt;Tracking them in a &lt;tt&gt;Map&amp;lt;TableId, List&amp;lt;RepairedState.Level&amp;gt;&amp;gt; initialLevels = new HashMap&amp;lt;&amp;gt;();&lt;/tt&gt; in the &lt;tt&gt;start()&lt;/tt&gt; method is a bit clearer to me, and it avoids adding that list in RepairedState which is only used during startup&lt;/p&gt;</comment>
                            <comment id="17487016" author="paulchandler" created="Fri, 4 Feb 2022 11:30:22 +0000"  >&lt;p&gt;I have updated the patch now as we discussed, hopefully I have fixed the code style issues as well, but let me know if there is anything else that needs addressing.&#160;&lt;/p&gt;</comment>
                            <comment id="17488091" author="krummas" created="Mon, 7 Feb 2022 13:13:19 +0000"  >&lt;p&gt;thanks, that looks good - I made a few minor changes and pushed to get it tested:&lt;br/&gt;
&lt;a href=&quot;https://github.com/krummas/cassandra/commits/CASSANDRA-17342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/CASSANDRA-17342&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/767/workflows/6ba0edc0-f878-48fd-8b5a-22002aab7990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra/767/workflows/6ba0edc0-f878-48fd-8b5a-22002aab7990&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me know what you think.&lt;/p&gt;

&lt;p&gt;Also, do you have an email address for the Author: field?&lt;/p&gt;</comment>
                            <comment id="17488183" author="paulchandler" created="Mon, 7 Feb 2022 15:40:02 +0000"  >&lt;p&gt;Hi Marcus,&#160;&lt;br/&gt;
Yes those changes look good. I am not sure where I my email address goes for the Author: field ?&#160;&lt;/p&gt;</comment>
                            <comment id="17488626" author="krummas" created="Tue, 8 Feb 2022 06:55:39 +0000"  >&lt;p&gt;It would be the git author field, to show that it is your patch. Something like &lt;a href=&quot;https://www.git-tower.com/learn/git/faq/change-author-name-email&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17488898" author="brandon.williams" created="Tue, 8 Feb 2022 14:35:29 +0000"  >&lt;p&gt;Cleanups look good, the couple CI failures are known. +1&lt;/p&gt;</comment>
                            <comment id="17490314" author="paulchandler" created="Thu, 10 Feb 2022 15:02:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt;&#160;I have finally fixed the email address on my commits (I&apos;ve been held back by too many production issues). Not sure if that was the right thing to do now, as there are later changes in your repository.&lt;/p&gt;

&lt;p&gt;Not sure if you were waiting for me, or what the next step is now.&lt;/p&gt;</comment>
                            <comment id="17490326" author="krummas" created="Thu, 10 Feb 2022 15:23:36 +0000"  >&lt;p&gt;looks good, I&apos;ll get this committed tomorrow, thank you!&lt;/p&gt;</comment>
                            <comment id="17490331" author="paulchandler" created="Thu, 10 Feb 2022 15:30:44 +0000"  >&lt;p&gt;That is good news. Thanks for all your help with this Marcus and Brandon. The process was not a daunting as I was expecting, and hopefully I will get some time to take a look at some of the other open tickets soon.&lt;/p&gt;</comment>
                            <comment id="17490332" author="brandon.williams" created="Thu, 10 Feb 2022 15:32:50 +0000"  >&lt;p&gt;That&apos;s great to hear, Paul!  I&apos;ll keep an eye out for you &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17490911" author="krummas" created="Fri, 11 Feb 2022 13:17:44 +0000"  >&lt;p&gt;Committed to 4.0 and merged up, thanks again for the patch!&lt;/p&gt;

&lt;p&gt;trunk tests look bad, but similar to &lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/775/workflows/b0ede5ae-db7c-4a1d-b6ff-22245922bb46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;non-patched trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/770/workflows/edfe8c85-0de6-4191-b4be-e7c4cb1a4c1e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci 4.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/769/workflows/6eea562c-0354-41e2-b253-32da2f929193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci trunk&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13039616" name="BulkRepairStateTest.java" size="4713" author="paulchandler" created="Wed, 2 Feb 2022 21:02:59 +0000"/>
                            <attachment id="13039611" name="IncrementalRepairStartupTest.java" size="1436" author="paulchandler" created="Wed, 2 Feb 2022 18:17:17 +0000"/>
                            <attachment id="13039614" name="LocalSessions.java" size="43396" author="paulchandler" created="Wed, 2 Feb 2022 21:02:59 +0000"/>
                            <attachment id="13039615" name="RepairedState.java" size="11806" author="paulchandler" created="Wed, 2 Feb 2022 21:02:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[paulchandler]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0z748:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350367">4.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/c60ad61b3b6145af100578f2c652819f61729018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c60ad61b3b6145af100578f2c652819f61729018&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>