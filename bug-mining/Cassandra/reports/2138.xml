<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5393] Add retry mechanism to OTC for non-droppable_verbs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5393</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Can we add an Ack/Retry around passing merle tree&apos;s around in repair?  If the following fails, the repair hangs for ever on the coordinating node.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.1.10/src/java/org/apache/cassandra/service/AntiEntropyService.java#L242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.1.10/src/java/org/apache/cassandra/service/AntiEntropyService.java#L242&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            Message message = TreeResponseVerbHandler.makeVerb(local, validator);
            if (!validator.request.endpoint.equals(FBUtilities.getBroadcastAddress()))
                logger.info(String.format(&quot;[repair #%s] Sending completed merkle tree to %s for %s&quot;, validator.request.sessionid, validator.request.endpoint, validator.request.cf));
            ms.sendOneWay(message, validator.request.endpoint);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the message asking for merkle tree&apos;s gets lost, coordinating node hangs for ever as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639405">CASSANDRA-5393</key>
            <summary>Add retry mechanism to OTC for non-droppable_verbs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="jeremiah">Jeremiah Jordan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Mar 2013 17:59:48 +0000</created>
                <updated>Tue, 14 Oct 2025 12:09:20 +0000</updated>
                            <resolved>Thu, 18 Apr 2013 20:56:25 +0000</resolved>
                                        <fixVersion>1.1.12</fixVersion>
                    <fixVersion>1.2.5</fixVersion>
                    <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13619597" author="jasobrown" created="Tue, 2 Apr 2013 07:34:06 +0000"  >&lt;p&gt;We&apos;ve got an idea we&apos;re testing out here, and will hopefully post a patch in a day or so.&lt;/p&gt;</comment>
                            <comment id="13621530" author="jasobrown" created="Wed, 3 Apr 2013 23:48:07 +0000"  >&lt;p&gt;Yuki&apos;s ticket is more comprehensive than this one&lt;/p&gt;</comment>
                            <comment id="13634649" author="jasobrown" created="Thu, 18 Apr 2013 00:01:24 +0000"  >&lt;p&gt;At the end of the day, this is what I see happening:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO [AntiEntropyStage:1] 2013-03-27 22:48:55,390 AntiEntropyService.java (line 239) repair #80fe25a0-9730-11e2-0000-ebe7011631ff Sending completed merkle tree to /54.246.XXX.YYY &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Geo,GeoCountryMetadata)
DEBUG [WRITE-/54.246.XXX.YYY] 2013-03-27 22:48:55,392 OutboundTcpConnection.java (line 165) error writing to ec2-54-246-XXX.YYY.eu-west-1.compute.amazonaws.com/54.246.XXX.YYY
java.net.SocketException: Connection timed out
at java.net.SocketOutputStream.socketWrite0(Native Method)
at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)
at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
at com.sun.net.ssl.internal.ssl.OutputRecord.writeBuffer(OutputRecord.java:358)
at com.sun.net.ssl.internal.ssl.OutputRecord.write(OutputRecord.java:346)
at com.sun.net.ssl.internal.ssl.SSLSocketImpl.writeRecordInternal(SSLSocketImpl.java:781)
at com.sun.net.ssl.internal.ssl.SSLSocketImpl.writeRecord(SSLSocketImpl.java:753)
at com.sun.net.ssl.internal.ssl.AppOutputStream.write(AppOutputStream.java:100)
at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)
at java.io.BufferedOutputStream.write(BufferedOutputStream.java:104)
at java.io.DataOutputStream.write(DataOutputStream.java:90)
at java.io.FilterOutputStream.write(FilterOutputStream.java:80)
at org.apache.cassandra.net.OutboundTcpConnection.write(OutboundTcpConnection.java:200)
at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:152)
at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:126)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The interesting thing is the &quot;Connection timed out&quot; exception message, rather than socket reset (or something similar). So, I&apos;m thinking this might be to keepalive timing out after the connection is broken. I was able to reproduce this exception several times by having my test cluster setup in three ec2 regions (us-west-2, us-east-1, eu-west-1 - three nodes in each), and not sending any traffic for multiple hours. Basically, I&apos;m waiting for the connection to get dropped. Thus, when I went to triggered repair on one of the nodes (usu. starting with us-west-2), I could see where the eu-west-1 nodes would get the request to build the merkle tree, but then failed on sending the tree response with the above exception. I was able to get similar problems when trying a schema update after many hours of cluster idleness.&lt;/p&gt;

&lt;p&gt;The attached patch catches the exception when the socket is dead (for whatever reason), and attempts a simple retry by requeueing the message at the end of the backlog queue, with the hope that the next pass will successfully recreate the socket. Note that I&apos;m excluding MessagingService.DROPPABLE_VERBS from retries as it&apos;s OK to drop reads/mutates, but it&apos;s really those AES and other schema-related messages that I think we&apos;d want to retry.&lt;/p&gt;

&lt;p&gt;Admittedly this is a simple mechanism that doesn&apos;t try to do anything fancy like exponential backoff, n-levels of configurable retrys, and so on. I&apos;m open to discussion on that, but I&apos;m not sure how much complexity we&apos;d want to build in for that at this point. I think an incremental improvement would go a long way here as we&apos;re currently obscuring when messages can&apos;t be sent (which is OK for DROPPABLE_VERBS, but those other ones are ones are really important), so added visibility and a retry mechanism will help. &lt;/p&gt;


</comment>
                            <comment id="13634656" author="jasobrown" created="Thu, 18 Apr 2013 00:08:28 +0000"  >&lt;p&gt;v2 addresses a potential race condition between disconnecting the bad socket and re-enqueueing the failed message.&lt;/p&gt;</comment>
                            <comment id="13634689" author="krummas" created="Thu, 18 Apr 2013 00:42:54 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13634749" author="jbellis" created="Thu, 18 Apr 2013 01:41:08 +0000"  >&lt;p&gt;Can we make an Entry subclass instead of saddling each Entry with an extra field that will mostly be unused?&lt;/p&gt;

&lt;p&gt;Also, space before open paren. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13634848" author="jasobrown" created="Thu, 18 Apr 2013 04:57:14 +0000"  >&lt;p&gt;v3 includes Jonathan&apos;s suggestions. Created RetryableEntry as a subclass of Entry. Added method shouldRetry() to Entry; Entry will always return false, and RetryableEntry will check it&apos;s member boolean.&lt;/p&gt;</comment>
                            <comment id="13635204" author="jbellis" created="Thu, 18 Apr 2013 14:31:44 +0000"  >&lt;p&gt;v4 attached &amp;#8211; easier to show than explain what I meant in English. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13635211" author="jbellis" created="Thu, 18 Apr 2013 14:38:34 +0000"  >&lt;p&gt;sorry for the attachment churn, decided to improve the comments too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13635376" author="jasobrown" created="Thu, 18 Apr 2013 17:26:03 +0000"  >&lt;p&gt;I think your patch and my patch are rather similar, but I&apos;m game either way &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. However, there is a small bug in Entry.shouldRetry(); you have&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MessagingService.DROPPABLE_VERBS.contains(message.getVerb());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but should be&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !MessagingService.DROPPABLE_VERBS.contains(message.getVerb());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Otherwise we would retry the DROPPABLE_VERBS, which we want to drop.&lt;/p&gt;

&lt;p&gt;With that small fix, lgtm.&lt;/p&gt;</comment>
                            <comment id="13635468" author="jbellis" created="Thu, 18 Apr 2013 18:18:23 +0000"  >&lt;p&gt;Ship it!&lt;/p&gt;</comment>
                            <comment id="13635682" author="jasobrown" created="Thu, 18 Apr 2013 20:56:01 +0000"  >&lt;p&gt;Changed name of ticket to better describe the change.&lt;/p&gt;

&lt;p&gt;Committed to 1.1, 1.2, and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12640653">CASSANDRA-5426</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12579245" name="5393-v2.patch" size="3718" author="jasobrown" created="Thu, 18 Apr 2013 00:08:28 +0000"/>
                            <attachment id="12579269" name="5393-v3.patch" size="4817" author="jasobrown" created="Thu, 18 Apr 2013 04:57:14 +0000"/>
                            <attachment id="12579329" name="5393-v4.txt" size="4216" author="jbellis" created="Thu, 18 Apr 2013 14:38:34 +0000"/>
                            <attachment id="12579244" name="5393.patch" size="3484" author="jasobrown" created="Thu, 18 Apr 2013 00:02:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>319875</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j6xj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320216</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>