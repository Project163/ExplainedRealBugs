<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13204] Thread Leak in OutboundTcpConnection</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13204</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We found threads leaking from OutboundTcpConnection to machines which are not part of the cluster and still in Gossip for some reason. There are two issues here, this JIRA will cover the second one which is most important. &lt;/p&gt;



&lt;p&gt;1) First issue is that Gossip has information about machines not in the ring which has been replaced out. It causes Cassandra to connect to those machines but due to internode auth, it wont be able to connect to them at the socket level.  &lt;/p&gt;

&lt;p&gt;2) Second issue is a race between creating a connection and closing a connections which is triggered by the gossip bug explained above. Let me try to explain it using the code&lt;/p&gt;

&lt;p&gt;In OutboundTcpConnection, we are calling closeSocket(true) which will set isStopped=true and also put a close sentinel into the queue to exit the thread. On the ack connection, Gossip tries to send a message which calls connect() which will block for 10 seconds which is RPC timeout. The reason we will block is because Cassandra might not be running there or internode auth will not let it connect. During this 10 seconds, if Gossip calls closeSocket, it will put close sentinel into the queue. When we return from the connect method after 10 seconds, we will clear the backlog queue causing this thread to leak. &lt;/p&gt;

&lt;p&gt;Proofs from the heap dump of the affected machine which is leaking threads &lt;br/&gt;
1. Only ack connection is leaking and not the command connection which is not used by Gossip. &lt;br/&gt;
2. We see thread blocked on the backlog queue, isStopped=true and backlog queue is empty. This is happening on the threads which have already leaked. &lt;br/&gt;
3. A running thread was blocked on the connect waiting for timeout(10 seconds) and we see backlog queue to contain the close sentinel. Once the connect will return false, we will clear the backlog and this thread will have leaked.  &lt;/p&gt;


&lt;p&gt;Interesting bits from j stack &lt;br/&gt;
1282 number of threads for &quot;MessagingService-Outgoing-/&amp;lt;IP-Address&amp;gt;&quot;&lt;/p&gt;

&lt;p&gt;Thread which is about to leak:&lt;br/&gt;
&quot;MessagingService-Outgoing-/&amp;lt;IP Address&amp;gt;&quot; &lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
	at sun.nio.ch.Net.connect0(Native Method)&lt;br/&gt;
	at sun.nio.ch.Net.connect(Net.java:454)&lt;br/&gt;
	at sun.nio.ch.Net.connect(Net.java:446)&lt;br/&gt;
	at sun.nio.ch.SocketChannelImpl.connect(SocketChannelImpl.java:648)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;&amp;gt; (a java.lang.Object)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;&amp;gt; (a java.lang.Object)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;&amp;gt; (a java.lang.Object)&lt;br/&gt;
	at org.apache.cassandra.net.OutboundTcpConnectionPool.newSocket(OutboundTcpConnectionPool.java:137)&lt;br/&gt;
	at org.apache.cassandra.net.OutboundTcpConnectionPool.newSocket(OutboundTcpConnectionPool.java:119)&lt;br/&gt;
	at org.apache.cassandra.net.OutboundTcpConnection.connect(OutboundTcpConnection.java:381)&lt;br/&gt;
	at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:217)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thread already leaked:&lt;br/&gt;
&quot;MessagingService-Outgoing-/&amp;lt;IP Address&amp;gt;&quot;&lt;br/&gt;
   java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)&lt;br/&gt;
	at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)&lt;br/&gt;
	at org.apache.cassandra.utils.CoalescingStrategies$DisabledCoalescingStrategy.coalesceInternal(CoalescingStrategies.java:482)&lt;br/&gt;
	at org.apache.cassandra.utils.CoalescingStrategies$CoalescingStrategy.coalesce(CoalescingStrategies.java:213)&lt;br/&gt;
	at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:190)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13041790">CASSANDRA-13204</key>
            <summary>Thread Leak in OutboundTcpConnection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="kohlisankalp">Sankalp Kohli</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Feb 2017 18:22:50 +0000</created>
                <updated>Fri, 15 May 2020 08:01:05 +0000</updated>
                            <resolved>Sat, 11 Feb 2017 16:06:16 +0000</resolved>
                                        <fixVersion>2.1.17</fixVersion>
                    <fixVersion>2.2.9</fixVersion>
                    <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                    <component>Messaging/Internode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15859957" author="jasobrown" created="Thu, 9 Feb 2017 18:32:01 +0000"  >&lt;p&gt;Looks like this is due to a regression with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1632&quot; title=&quot;Thread workflow and cpu affinity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1632&quot;&gt;&lt;del&gt;CASSANDRA-1632&lt;/del&gt;&lt;/a&gt;, where I naively clear the &lt;tt&gt;backlog&lt;/tt&gt;, which had previously been the &lt;tt&gt;active&lt;/tt&gt; queue. (we used to have two LBQs in &lt;tt&gt;OutboundTcpConnection&lt;/tt&gt; in pre-2.1)&lt;/p&gt;</comment>
                            <comment id="15860348" author="jasobrown" created="Thu, 9 Feb 2017 22:52:33 +0000"  >&lt;p&gt;A small change in the branches linked below should resolve the race condition. (The change identical across the branches as not much has changed in &lt;tt&gt;OutboundTcpConnection&lt;/tt&gt; in quite a while).&lt;/p&gt;

&lt;p&gt;Also fixed another minor problem: when we fail to connect (&lt;tt&gt;#connect()&lt;/tt&gt; returns &lt;tt&gt;false&lt;/tt&gt;), we want to drop &lt;b&gt;all&lt;/b&gt; messages. Currently we clear the &lt;tt&gt;backlog&lt;/tt&gt;, but if there&apos;s any remaining messages in the &lt;tt&gt;drainedMessages&lt;/tt&gt;, we&apos;ll keep trying to process those. We should drop those messages, as well. &lt;/p&gt;

&lt;p&gt;Note: I thought about how to try to test this via a unit test, but as the interweaving of the of the shared state occurs in spots that are not easy to inject to, I&apos;m not sure how best to test this change :-/ , Lacking anything else, running the standard unit tests and dtests on cassci:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13204-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13204-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13204-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13204-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13204-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jasobrown/job/jasobrown-13204-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15860572" author="aweisberg" created="Fri, 10 Feb 2017 02:30:19 +0000"  >&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jasobrown:13204-trunk?expand=1#diff-c7ef124561c4cde1c906f28ad3883a88R184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Did you finish this comment?&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;-&lt;del&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...jasobrown:13204-2.1?expand=1#diff-c7ef124561c4cde1c906f28ad3883a88R225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This would cause a concurrent modification exception with the iterator&lt;/a&gt;&lt;/del&gt;- Never mind forgot about the jump.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...jasobrown:13204-2.1?expand=1#diff-c7ef124561c4cde1c906f28ad3883a88L164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;It&apos;s not clear to me that you need to move the backlog.clear()?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think I understand the issue. A failed connection clobbers the sentinel with backlog.clear(). You fixed the clobbering by relegating the sentinel to just a tool to wake up the thread. The flag is controlling the loop and the break will make it out to check the loop condition if a connection fails.&lt;/p&gt;</comment>
                            <comment id="15861624" author="jasobrown" created="Fri, 10 Feb 2017 18:15:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s not clear to me that you need to move the backlog.clear()?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think you are correct (that it probably does not need to move). I have a (possibly unfounded) preference for referencing shared state variables like this in the same order from different spots. wdyt?&lt;/p&gt;

&lt;p&gt;And, yes, your analysis is correct &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="15861728" author="aweisberg" created="Fri, 10 Feb 2017 19:33:26 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15862435" author="jasobrown" created="Sat, 11 Feb 2017 16:06:16 +0000"  >&lt;p&gt;committed as sha &lt;tt&gt;a6237bf65a95d654b7e702e81fd0d353460d0c89&lt;/tt&gt; to 2.1, 2.2, 3.0, 3.11, and trunk. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39v1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337740">2.1.16</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>