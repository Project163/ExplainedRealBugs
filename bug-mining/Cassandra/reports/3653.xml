<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9662] compactionManager reporting wrong pendingtasks</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9662</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Yesterday I upgraded my Cassandra cluster from 2.0.14 to 2.0.16, after upgrade, I am start seeing some strange behaviours of &quot;PendingTasks&quot; reporting.&lt;/p&gt;

&lt;p&gt;The Cassandra repository I am using is datastax, steps I performed for upgrade:&lt;/p&gt;

&lt;p&gt;yum update -y cassandra20&lt;/p&gt;

&lt;p&gt;The upgrade went fine, after upgrade cluster is operating okay. &quot;nodetool info and nodetool status&quot; results looked fine. &quot;nodetool version&quot; is reporting the correct version.&lt;/p&gt;

&lt;p&gt;But our monitoring system start reporting some crazy &quot;pendingtasks&quot;. For example, &quot;pending taks&quot; for node1 sometimes jump from 0 to 15K for about 1 minute, then drop back to 0. This issue keeps occurring, didn&apos;t have this issue with 2.0.14. Our monitoring system is checking the value of &quot;MBeans&quot; -&amp;gt; &quot;CompactionManager&quot; -&amp;gt; &quot;PendingTasks&quot;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS: Amazon Linux AMI release 2015.03&lt;br/&gt;
Cassandra: 2.0.16&lt;br/&gt;
JVM: Java HotSpot(TM) 64-Bit Server VM (25.40-b25, mixed mode)&lt;br/&gt;
Java: version 1.8.0_40, vendor Oracle Corporation&lt;br/&gt;
CPU: 8 core Intel(R) Xeon(R) CPU E5-2670 v2 @ 2.50GHz&lt;br/&gt;
Memory: 32G&lt;/p&gt;</environment>
        <key id="12840901">CASSANDRA-9662</key>
            <summary>compactionManager reporting wrong pendingtasks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="lazyadmin">Tony Xu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Jun 2015 16:13:21 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:06 +0000</updated>
                            <resolved>Wed, 8 Jul 2015 17:25:05 +0000</resolved>
                                        <fixVersion>2.0.17</fixVersion>
                    <fixVersion>2.1.9</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="604800">168h</timeoriginalestimate>
                            <timeestimate seconds="604800">168h</timeestimate>
                                        <comments>
                            <comment id="14603463" author="yukim" created="Fri, 26 Jun 2015 19:24:46 +0000"  >&lt;p&gt;patch here: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/9662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/9662&lt;/a&gt;&lt;br/&gt;
ci: &lt;a href=&quot;http://cassci.datastax.com/job/yukim-9662-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/yukim-9662-testall/2/&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/job/yukim-9662-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/yukim-9662-dtest/2/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Number of compaction pending tasks has been calculated based on estimation reported from compaction strategy and the number of tasks queued for a long time.&lt;br/&gt;
The latter, tasks queued, is mostly compaction task &lt;b&gt;candidate&lt;/b&gt; (&lt;tt&gt;BackgroundCompactionTask&lt;/tt&gt;) that can be noop.&lt;br/&gt;
We shoud have used active compaction task count instead.&lt;/p&gt;</comment>
                            <comment id="14608408" author="yukim" created="Tue, 30 Jun 2015 14:52:13 +0000"  >&lt;p&gt;Follow up on this, we probably should revert the change in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5554&quot; title=&quot;Growing pending compactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5554&quot;&gt;&lt;del&gt;CASSANDRA-5554&lt;/del&gt;&lt;/a&gt; in favor of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9592&quot; title=&quot;`Periodically attempt to submit background compaction tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9592&quot;&gt;&lt;del&gt;CASSANDRA-9592&lt;/del&gt;&lt;/a&gt; as we are now queueing way to much to compaction executor.&lt;/p&gt;</comment>
                            <comment id="14608512" author="jbellis" created="Tue, 30 Jun 2015 15:35:38 +0000"  >&lt;p&gt;5554 is correct behavior; 9592 is a hack but additional check-per-minute is basically harmless.  Now that you&apos;re fixing the estimation I don&apos;t see why we shouldn&apos;t keep both.&lt;/p&gt;

&lt;p&gt;P.S. Renaming BCT to BackgroundCompactionCandidate sounds like a good idea to me.&lt;/p&gt;</comment>
                            <comment id="14617137" author="benedict" created="Tue, 7 Jul 2015 18:29:25 +0000"  >&lt;p&gt;This patch looks like it would acceptably fix the bouncing report of compaction tasks outstanding.&lt;/p&gt;

&lt;p&gt;However I think we should step back for a moment and consider the context. The reason this is bouncing around is because we attempt to impose a constraint in &lt;tt&gt;submitBackground&lt;/tt&gt; that we enforce very badly. This leads us to accidentally submit perhaps thousands of no-op compactions. This patch masks that from the user, but we&apos;re still doing it. This constraint being enforced &lt;em&gt;at all&lt;/em&gt; is very questionable, though. It can lead us to starving entire tables from compaction for extended periods, because they happen to flush at periods during which the compaction executors are fully occupied. Ironically, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9592&quot; title=&quot;`Periodically attempt to submit background compaction tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9592&quot;&gt;&lt;del&gt;CASSANDRA-9592&lt;/del&gt;&lt;/a&gt; both mitigates and worsens this problem, depending on if you&apos;re a secondary index or not (for whom it makes things worse; everyone else it should prevent starvation for)&lt;/p&gt;

&lt;p&gt;So: how about we always submit exactly one background task for any table whenever one is requested. That way the numbers will never bounce around so wildly: they&apos;ll be capped at a variance of about 1 per table, per flush or per minute. We can (and perhaps should) also introduce this patch, but it would be comparatively much less of a problem, and we would have fixed a potential problematic situation where tables get very far behind on compaction.&lt;/p&gt;</comment>
                            <comment id="14617141" author="benedict" created="Tue, 7 Jul 2015 18:33:43 +0000"  >&lt;p&gt;Looking at the linked &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5554&quot; title=&quot;Growing pending compactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5554&quot;&gt;&lt;del&gt;CASSANDRA-5554&lt;/del&gt;&lt;/a&gt;, it appears to only partially address this, by ensuring there is always at least one submission for any CF. However it still permits an abitrary number to be submitted, and with many concurrent compactors makes no effort to ensure remotely fair distribution. If we always submit &lt;em&gt;precisely&lt;/em&gt; one compaction, when requested, we should be in a much better state AFAICT.&lt;/p&gt;</comment>
                            <comment id="14617915" author="yukim" created="Wed, 8 Jul 2015 03:36:12 +0000"  >&lt;p&gt;Right. I pushed the change to submit only one compaction on top of the current patch here: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/9662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/9662&lt;/a&gt;&lt;br/&gt;
Renamed &lt;tt&gt;BackgroundCompactionTask&lt;/tt&gt; to &lt;tt&gt;BackgroundCompactionCandidate&lt;/tt&gt; as well.&lt;/p&gt;

&lt;p&gt;dtest: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-9662-dtest/5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-9662-dtest/5/&lt;/a&gt;&lt;br/&gt;
testall: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-9662-testall/6/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-9662-testall/6/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14618270" author="benedict" created="Wed, 8 Jul 2015 09:14:31 +0000"  >&lt;p&gt;Looks good, but I think we should also remove the &quot;filling&quot; logic of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9592&quot; title=&quot;`Periodically attempt to submit background compaction tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9592&quot;&gt;&lt;del&gt;CASSANDRA-9592&lt;/del&gt;&lt;/a&gt;, so that it also submits exactly one task (or none if there are plenty running):&lt;/p&gt;

&lt;p&gt;i.e., we should remove the &lt;tt&gt;submitted&lt;/tt&gt; list, and all of the code starting &lt;a href=&quot;https://github.com/yukim/cassandra/blob/66356dbf8ed2fd9291f38026f078f9c06ba383a8/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, since this can induce the same behaviour (when I wrote it, I didn&apos;t pay close enough attention to the fact that the constraint was imposed on running threads, as opposed to running &lt;em&gt;tasks&lt;/em&gt;)&lt;/p&gt;</comment>
                            <comment id="14618815" author="yukim" created="Wed, 8 Jul 2015 15:58:42 +0000"  >&lt;p&gt;Good catch, pushed another commit to the same branch.&lt;/p&gt;</comment>
                            <comment id="14618853" author="benedict" created="Wed, 8 Jul 2015 16:16:43 +0000"  >&lt;p&gt;LGTM, +1&lt;/p&gt;</comment>
                            <comment id="14618980" author="yukim" created="Wed, 8 Jul 2015 17:25:05 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12841627">CASSANDRA-9683</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12843089">CASSANDRA-9744</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12849715">CASSANDRA-9914</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12931819">CASSANDRA-11025</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12742150" name="node1.jpg" size="34977" author="lazyadmin" created="Fri, 26 Jun 2015 16:13:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gjvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332369">2.0.16</customfieldvalue>
    <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>