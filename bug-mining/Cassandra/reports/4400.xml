<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11828] Commit log needs to track unflushed intervals rather than positions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11828</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11448&quot; title=&quot;Running OOS should trigger the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11448&quot;&gt;&lt;del&gt;CASSANDRA-11448&lt;/del&gt;&lt;/a&gt; in an effort to give a more thorough handling of flush errors I have introduced a possible correctness bug with disk failure policy ignore if a flush fails with an error:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we report the error but continue&lt;/li&gt;
	&lt;li&gt;we correctly do not update the commit log with the flush position&lt;/li&gt;
	&lt;li&gt;but we allow the post-flush executor to resume&lt;/li&gt;
	&lt;li&gt;a successful later flush can thus move the log&apos;s clear position beyond the data from the failed flush&lt;/li&gt;
	&lt;li&gt;the log will then delete segment(s) that contain unflushed data.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9669&quot; title=&quot;If sstable flushes complete out of order, on restart we can fail to replay necessary commit log records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9669&quot;&gt;&lt;del&gt;CASSANDRA-9669&lt;/del&gt;&lt;/a&gt; it is relatively easy to fix this problem by making the commit log track sets of intervals of unflushed data (as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8496&quot; title=&quot;Remove MemtablePostFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8496&quot;&gt;CASSANDRA-8496&lt;/a&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12970714">CASSANDRA-11828</key>
            <summary>Commit log needs to track unflushed intervals rather than positions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blambov">Branimir Lambov</assignee>
                                    <reporter username="blambov">Branimir Lambov</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 May 2016 10:49:02 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:32 +0000</updated>
                            <resolved>Fri, 5 Aug 2016 13:49:40 +0000</resolved>
                                        <fixVersion>2.1.16</fixVersion>
                    <fixVersion>2.2.8</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15288783" author="blambov" created="Wed, 18 May 2016 10:59:14 +0000"  >&lt;p&gt;This could potentially be a problem for disk failure policy stop as well, e.g. if a flush is requested via JMX.&lt;/p&gt;</comment>
                            <comment id="15293016" author="blambov" created="Fri, 20 May 2016 08:43:24 +0000"  >&lt;p&gt;Patch uploaded here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-cl-ss-intervals-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-cl-ss-intervals-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-cl-ss-intervals-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-cl-ss-intervals-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-cl-ss-intervals-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-cl-ss-intervals-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-cl-ss-intervals&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-cl-ss-intervals-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-cl-ss-intervals-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Changes the commit log segment dirty and clean tracking to intervals: one dirty interval per cf that covers the span of writes to that cf, and a set of clean intervals (which would normally be a single contiguous one). The segment is only discarded if the clean set completely covers the dirty interval; if a failed flush left a hole the segment will remain.&lt;/p&gt;

&lt;p&gt;Sstables are also changed to track covered replay intervals so that compaction that includes a table flushed after a failed one doesn&apos;t obscure the unflushed region from the commit log replayer.&lt;/p&gt;</comment>
                            <comment id="15303986" author="blambov" created="Fri, 27 May 2016 12:15:38 +0000"  >&lt;p&gt;With this change the delayed permission to compact that was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9669&quot; title=&quot;If sstable flushes complete out of order, on restart we can fail to replay necessary commit log records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9669&quot;&gt;&lt;del&gt;CASSANDRA-9669&lt;/del&gt;&lt;/a&gt; is no longer necessary. The branches below add a commit that removes the relevant code:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-revert-compaction-wait-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-revert-compaction-wait-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-revert-compaction-wait&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;(doesn&apos;t include latest 9669 fix so index failures are expected)&lt;/p&gt;</comment>
                            <comment id="15362592" author="slebresne" created="Tue, 5 Jul 2016 14:54:56 +0000"  >&lt;p&gt;s I like the general approach, I&apos;d like to discuss where we should commit this as this is a non-trivial patch and touching critical part of the code.&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11448&quot; title=&quot;Running OOS should trigger the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11448&quot;&gt;&lt;del&gt;CASSANDRA-11448&lt;/del&gt;&lt;/a&gt; created this bug, I assume 2.1 onwards is affected? But it&apos;s only easy to fix on 2.2+ due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9669&quot; title=&quot;If sstable flushes complete out of order, on restart we can fail to replay necessary commit log records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9669&quot;&gt;&lt;del&gt;CASSANDRA-9669&lt;/del&gt;&lt;/a&gt;, correct?&lt;/p&gt;

&lt;p&gt;Assuming my understanding is correct, wouldn&apos;t it be simpler/less risky to just revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11448&quot; title=&quot;Running OOS should trigger the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11448&quot;&gt;&lt;del&gt;CASSANDRA-11448&lt;/del&gt;&lt;/a&gt; for 2.1 and 2.2? Getting your flush writer to die when your run out of space isn&apos;t ideal, but it feels somewhat minor compared to possibly losing data.&lt;/p&gt;

&lt;p&gt;Anyway, with that out of the way, some remarks on the patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In &lt;tt&gt;CommitLogSegment&lt;/tt&gt;, the &quot;semi-lack&quot; of abstraction of &lt;tt&gt;IntegerIntervals&lt;/tt&gt; is a bit confusing, and I&apos;m not sure it&apos;s justified performance-wise. For instance, it takes more time that necessary to understand that &lt;tt&gt;cfDirty&lt;/tt&gt; also actually holds an interval, not just a position. I&apos;d rather create a true &lt;tt&gt;IntInterval&lt;/tt&gt; class (which can use a &lt;tt&gt;long&lt;/tt&gt; internally if it wants, but I&apos;m not sure that&apos;s justified), with maybe a mutable &lt;tt&gt;AtomicIntInterval&lt;/tt&gt; sublcass having the &lt;tt&gt;expandToCover&lt;/tt&gt; (&lt;tt&gt;coverInMap&lt;/tt&gt; imo belongs to &lt;tt&gt;CommitLogSegment&lt;/tt&gt;). Of course, &lt;tt&gt;IntInterval.Set&lt;/tt&gt; can very well continue to use arrays internally since we never iterate on the set except for the tests (so in practice we&apos;ll rarely create actual &lt;tt&gt;IntInterval&lt;/tt&gt; objects).&lt;/li&gt;
	&lt;li&gt;I don&apos;t think &lt;tt&gt;IntegerIntervals.Set.add()&lt;/tt&gt; needs to be synchronized (it&apos;s called only a synchronized method in practice). It&apos;s not a big deal, but making the class thread-unsafe will be imo more expected in case of future reuse.&lt;/li&gt;
	&lt;li&gt;The new classes introduced (&lt;tt&gt;IntegerIntervals&lt;/tt&gt; and &lt;tt&gt;ReplayIntervalSet&lt;/tt&gt;) lack a minimum of javadoc, and could use a little bit more comments in general.&lt;/li&gt;
	&lt;li&gt;Variable naming in &lt;tt&gt;CommitLogSegment&lt;/tt&gt; is now confusing. Should rename &lt;tt&gt;cleanPos&lt;/tt&gt; to &lt;tt&gt;cleanInterval&lt;/tt&gt; etc. Some comment should also be updated (at least on top of &lt;tt&gt;cfDirty&lt;/tt&gt;/&lt;tt&gt;cfClean&lt;/tt&gt; declarations and in &lt;tt&gt;CommitLogReplayer&lt;/tt&gt;) accordingly.&lt;/li&gt;
	&lt;li&gt;At the end of &lt;tt&gt;CommitLogTest.testOutOfOrderLogDiscard&lt;/tt&gt;, I&apos;d add a comment on the last assert saying something like &quot;In the absence of error, this should be 0 because forceRecycleAllSegments would have cleaned all segment. Because we know there was an error, we want to have something to replay&quot; (took me a minute to figure out what that test was really testing).&lt;/li&gt;
	&lt;li&gt;I&apos;m not sure to understand why &lt;tt&gt;CommitLogReplayer.firstNotCovered()&lt;/tt&gt; uses the the first range &lt;tt&gt;getValue()&lt;/tt&gt; instead of the &lt;tt&gt;getKey()&lt;/tt&gt; (i.e. the &lt;tt&gt;lowerBound()&lt;/tt&gt;). Also, leaving the &lt;tt&gt;ranges&lt;/tt&gt; in &lt;tt&gt;ReplayIntervalSet&lt;/tt&gt; private and using properly named accessors would be clearer imo.&lt;/li&gt;
	&lt;li&gt;We should fix the TODO in &lt;tt&gt;Tracker&lt;/tt&gt; (not sure I understand it fully, but I would suspect it&apos;s fine to not notify an invalidated CF).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;there is a few use of &lt;tt&gt;Integer&lt;/tt&gt; in IntegerIntervals.Set where &lt;tt&gt;int&lt;/tt&gt; would be fine.&lt;/li&gt;
	&lt;li&gt;there is a few inlined usage of &lt;tt&gt;getCurrentColumnFamilyStore()&lt;/tt&gt; in &lt;tt&gt;CQLTester&lt;/tt&gt;, can you replace them by calling the new method instead?&lt;/li&gt;
	&lt;li&gt;A few tests (in &lt;tt&gt;CommitLogTest.testUnwriteableFlushRecovery&lt;/tt&gt; and &lt;tt&gt;IntegerIntervalsTest&lt;/tt&gt;) don&apos;t uses braces after &lt;tt&gt;if&lt;/tt&gt;/&lt;tt&gt;for&lt;/tt&gt; even though the body is multi-line. I find it a bit esoteric and inconsistent with the code base, which hurts reading imo.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="15404040" author="blambov" created="Tue, 2 Aug 2016 14:09:17 +0000"  >&lt;p&gt;Thank you for the thorough review and the good suggestions. Applied them as a new commit in the 3.0 version:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-revert-compaction-wait-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-revert-compaction-wait-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;except removing the synchronization from &lt;tt&gt;IntegerIterval.Set.add&lt;/tt&gt; as the individual interval class is thread-safe and hence the consistency is better if the set class also is (also, this is a longer-running operation so synchronization is preferable to compare-and-set). Additionally untied &lt;tt&gt;IntervalSet&lt;/tt&gt; from &lt;tt&gt;ReplayPosition&lt;/tt&gt; and did a couple of smaller cleanups. Please take another look.&lt;/p&gt;

&lt;p&gt;On the topic of where it should be applied, I agree it is a better idea to leave it out of 2.x. I wouldn&apos;t completely revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11448&quot; title=&quot;Running OOS should trigger the disk failure policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11448&quot;&gt;&lt;del&gt;CASSANDRA-11448&lt;/del&gt;&lt;/a&gt; &amp;#8211; it is still preferable to die/stop the transports on error, but we shouldn&apos;t be passing control on to the post-flush. I will prepare a patch that does this next.&lt;/p&gt;</comment>
                            <comment id="15405580" author="blambov" created="Wed, 3 Aug 2016 08:44:36 +0000"  >&lt;p&gt;Uploaded a patch for 2.1 that stops passing on control to the post-flush after an error here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-no-post-flush-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-no-post-flush-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-no-post-flush-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15406047" author="slebresne" created="Wed, 3 Aug 2016 15:12:51 +0000"  >&lt;p&gt;Thanks, lgtm, I&apos;m +1 on both patches. but could you attach patch and run tests for 2.2 (with the 2.1 merged, which seems to have conflicts) and 3.9?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;except removing the synchronization from &lt;tt&gt;IntegerIterval.Set.add&lt;/tt&gt; as the individual interval class is thread-safe and hence the consistency is better if the set class also&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right. My suggestion to make the base class immutable, with a specifically called out mutable (and thread-safe) variant for the case where we need it, as I usually like making immutability the default and making it clear when it&apos;s not, but I&apos;m bikeshedding, especially as long as it&apos;s the only use of the class. I&apos;m cool with your solution, we can always change things later if {IntegerInterval}} sees reuse and immutability is better for those reuse.&lt;/p&gt;</comment>
                            <comment id="15407579" author="blambov" created="Thu, 4 Aug 2016 11:12:28 +0000"  >&lt;p&gt;Squashed, rebased and added &lt;tt&gt;CHANGES.txt&lt;/tt&gt; entry.&lt;/p&gt;

&lt;p&gt;Pre-3.0 code (disable passing control to post-flush):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-no-post-flush-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-no-post-flush-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-no-post-flush-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-no-post-flush-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-no-post-flush-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-no-post-flush-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;3.0 and later (track unflushed intervals in commitlog and sstables):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-rebased-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-rebased-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-rebased-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11828-rebased-3.9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.9&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-rebased-3.9-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11828-rebased-3.9-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15409470" author="slebresne" created="Fri, 5 Aug 2016 13:49:40 +0000"  >&lt;p&gt;Committed (including to 2.1 since this can result in data loss, which feels critical enough). Thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12762258">CASSANDRA-8496</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12954066">CASSANDRA-11448</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12996604">CASSANDRA-12436</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2y4yv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>