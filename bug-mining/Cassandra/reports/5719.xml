<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16238] Fix flaky jvm-dtests that fail with Unable to contact any seeds</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16238</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/745/workflows/1c7e589e-b5af-4a56-b40a-43da424602c7/jobs/4231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/745/workflows/1c7e589e-b5af-4a56-b40a-43da424602c7/jobs/4231&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
test teardown failure
Unexpected error found in node logs (see stdout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; full details). Errors: [ERROR [main] 2020-10-29 17:38:13,808 CassandraDaemon.java:817 - Exception encountered during startup
java.lang.IllegalStateException: Unable to contact any seeds!
	at org.apache.cassandra.service.StorageService.bootstrap(StorageService.java:1601)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:931)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:892)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:699)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:635)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:407)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:671)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:795), ERROR [main] 2020-10-29 17:38:13,808 CassandraDaemon.java:817 - Exception encountered during startup
java.lang.IllegalStateException: Unable to contact any seeds!
	at org.apache.cassandra.service.StorageService.bootstrap(StorageService.java:1601)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:931)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:892)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:699)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:635)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:407)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:671)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:795)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13337917">CASSANDRA-16238</key>
            <summary>Fix flaky jvm-dtests that fail with Unable to contact any seeds</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Oct 2020 18:24:25 +0000</created>
                <updated>Thu, 29 Apr 2021 18:22:48 +0000</updated>
                            <resolved>Thu, 29 Apr 2021 18:22:48 +0000</resolved>
                                        <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17263591" author="aholmber" created="Tue, 12 Jan 2021 18:45:54 +0000"  >&lt;p&gt;I&apos;ve had this looping on multiple platforms for the better part of a week and have not been able to reproduce. In sleuthing I have not come up with anything more to go on. Logs are gone from the linked run in Circle, and I haven&apos;t figured out how to get them from Jenkins. &lt;/p&gt;

&lt;p&gt;Jenkins shows the test at 13% flaky on trunk, with the last failure on Dec 15. Curiously, the runtimes reported for failures are always ~0.5 seconds. Not sure if that is possible, or if it&apos;s a problem with interpreting test results.&lt;/p&gt;

&lt;p&gt;I&apos;m going to set this aside for now. Maybe somebody else can think of a way to reproduce.&lt;/p&gt;</comment>
                            <comment id="17267043" author="bereng" created="Mon, 18 Jan 2021 06:53:58 +0000"  >&lt;p&gt;0% flakiness and 100% stability &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/232/testReport/dtest-novnode.replace_address_test/TestReplaceAddress/test_insert_data_during_replace_same_address/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;where the last fail&lt;/a&gt;ures are from a month ago. I say we close it until it resurfaces, rather than keeping it open, as we have nothing to on with.&lt;/p&gt;</comment>
                            <comment id="17268024" author="brandon.williams" created="Tue, 19 Jan 2021 16:38:05 +0000"  >&lt;p&gt;If the network were broken, I think what we see here would be the result (or on any other dtest, for that matter.)  If we can&apos;t reproduce after dutiful effort, I that&apos;s a sufficient enough possibility to solve for now and reopen if we see it again.&lt;/p&gt;</comment>
                            <comment id="17270738" author="michaelsembwever" created="Sat, 23 Jan 2021 19:27:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;0% flakiness and 100% stability where the last failures are from a month ago.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Here&apos;s the link(s) based off the latest build (rather than a build number that will expire to 404 soon)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/lastCompletedBuild/testReport/dtest-novnode.replace_address_test/TestReplaceAddress/test_insert_data_during_replace_same_address/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtest-novnode&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/lastCompletedBuild/testReport/dtest.replace_address_test/TestReplaceAddress/test_insert_data_during_replace_same_address/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/lastCompletedBuild/testReport/dtest-offheap.replace_address_test/TestReplaceAddress/test_insert_data_during_replace_same_address/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtest-offheap&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;h4&gt;&lt;a name=&quot;Searchingnightlies.a.oforpastfailures%E2%80%A6&quot;&gt;&lt;/a&gt;Searching nightlies.a.o for past failures&#8230;&lt;/h4&gt;

&lt;p&gt;We can use the nightlies archives for a complete search:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# webdav mount `https:&lt;span class=&quot;code-comment&quot;&gt;//nightlies.apache.org/cassandra/` to `/Volumes/cassandra`
&lt;/span&gt;cd /Volumes/cassandra

# define what we are looking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
export DTEST_CLASS=&lt;span class=&quot;code-quote&quot;&gt;&quot;replace_address_test.TestReplaceAddress&quot;&lt;/span&gt;
export DTEST_NAME=&lt;span class=&quot;code-quote&quot;&gt;&quot;test_insert_data_during_replace_same_address&quot;&lt;/span&gt;

# find builds where it failed
find Cassandra-trunk-dtest*/label=cassandra,split=* -name nosetests.xml -exec grep -q ${DTEST_CLASS} {} \; -exec grep -l &lt;span class=&quot;code-quote&quot;&gt;&quot;name=\&quot;&lt;/span&gt;${DTEST_NAME}\&lt;span class=&quot;code-quote&quot;&gt;&quot; time=\&quot;&lt;/span&gt;[0-9.]*\&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&amp;lt;error message&quot;&lt;/span&gt; {} \;

# alongside the nosetest.xml files you will find the `test_stdout.txt.xz` and `ccm_logs.tar.xz` logs
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Alternatively, to control check, find builds where it succeeded&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# alternatively, to control check, find builds where it succeeded
find Cassandra-trunk-dtest*/label=cassandra,split=* -name nosetests.xml -exec grep -q ${DTEST_CLASS} {} \; -exec grep -l &lt;span class=&quot;code-quote&quot;&gt;&quot;name=\&quot;&lt;/span&gt;${DTEST_NAME}\&lt;span class=&quot;code-quote&quot;&gt;&quot; time=\&quot;&lt;/span&gt;[0-9.]*\&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&amp;lt;/testcase&amp;gt;&quot;&lt;/span&gt; {} \;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;Pastfailuresandlogs&quot;&gt;&lt;/a&gt;Past failures and logs&lt;/h4&gt;
&lt;p&gt;The above recipe lists 54 failures (from currently what is archived in nighties.a.o).&lt;br/&gt;
 Links to the folders containing the logs are listed in the attachment  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13019247/13019247_16238-archived-failures.txt&quot; title=&quot;16238-archived-failures.txt attached to CASSANDRA-16238&quot;&gt;16238-archived-failures.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
Within just &lt;tt&gt;Cassandra-trunk-dtest&lt;/tt&gt; there&apos;s 17 failures from 193 archived runs. (9% flakiness)&lt;/p&gt;</comment>
                            <comment id="17322345" author="dcapwell" created="Thu, 15 Apr 2021 17:26:44 +0000"  >&lt;p&gt;I am reopening as this error impacts any multi-node jvm-dtest and not localized to a single test&lt;/p&gt;

&lt;p&gt;Examples:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/659/tests/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/659/tests/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;hostReplaceAbruptShutdown &#8211; org.apache.cassandra.distributed.test.hostreplacement.HostReplacementAbruptDownedInstanceTest&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: Unable to contact any seeds!
	at org.apache.cassandra.service.StorageService.bootstrap(StorageService.java:1749)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:1054)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:1015)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:799)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:729)
	at org.apache.cassandra.distributed.impl.Instance.lambda$startup$10(Instance.java:541)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15239&quot; title=&quot;[flaky in-mem dtest] nodeDownDuringMove - org.apache.cassandra.distributed.test.GossipTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15239&quot;&gt;CASSANDRA-15239&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17332737" author="brandon.williams" created="Mon, 26 Apr 2021 20:56:44 +0000"  >&lt;p&gt;Branch &lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-16238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/714/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/714/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:05,381 Gossiper.java:1296 - Node /127.0.0.1:7012 is now part of the cluster
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:05,381 StorageService.java:2730 - Node /127.0.0.1:7012 state NORMAL, token [-3074457345618258603]
[junit-timeout] INFO  [node4_GossipTasks:1] node4 2021-04-23 16:23:05,393 Gossiper.java:997 - FatClient /127.0.0.1:7012 has been silent for 0ms, removing from gossip
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:05,398 StorageService.java:2677 - New node /127.0.0.1:7012 at token -3074457345618258603
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see here that .1 is detected for the first time via gossip, and as it is going through StorageService but before it is added to TokenMetatadata, the gossiper&apos;s status check has begun running.  Since the quarantine delay is overridden to zero, without a presence in TMD the node is not a member yet and thus deemed a fat client, and removed.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:05,407 TokenMetadata.java:505 - Updating topology for /127.0.0.1:7012
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:05,414 TokenMetadata.java:505 - Updating topology for /127.0.0.1:7012
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:05,422 StorageService.java:2730 - Node /127.0.0.1:7012 state NORMAL, token [-3074457345618258603]
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:05,422 StorageService.java:2733 - Node /127.0.0.1:7012 state jump to NORMAL
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:05,447 Gossiper.java:1243 - removing expire time for endpoint : /127.0.0.1:7012
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:05,447 Gossiper.java:1244 - InetAddress /127.0.0.1:7012 is now UP
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:05,447 Gossiper.java:579 - removed /127.0.0.1:7012 from seeds, updated seeds list = []
[junit-timeout] WARN  16:23:05 Seeds list is now empty!
[junit-timeout] WARN  [node4_GossipStage:1] node4 2021-04-23 16:23:05,447 Gossiper.java:581 - Seeds list is now empty!
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:05,452 Gossiper.java:590 - removing endpoint /127.0.0.1:7012
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:05,452 Gossiper.java:561 - evicting /127.0.0.1:7012 from gossip
[junit-timeout] DEBUG [node4_GossipTasks:1] node4 2021-04-23 16:23:06,453 Gossiper.java:1025 - 0 elapsed, /127.0.0.1:7012 gossip quarantine over
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Crucially, as part of this removal the node is also removed from the seeds list, since it is listed there. The warning about the empty seed list is added from my branch.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:07,176 Gossiper.java:1296 - Node /127.0.0.1:7012 is now part of the cluster
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:07,177 StorageService.java:2730 - Node /127.0.0.1:7012 state NORMAL, token [-3074457345618258603]
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:07,189 StorageService.java:2677 - New node /127.0.0.1:7012 at token -3074457345618258603
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:07,198 TokenMetadata.java:505 - Updating topology for /127.0.0.1:7012
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:07,201 TokenMetadata.java:505 - Updating topology for /127.0.0.1:7012
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:07,208 StorageService.java:2730 - Node /127.0.0.1:7012 state NORMAL, token [-3074457345618258603]
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:07,208 StorageService.java:2733 - Node /127.0.0.1:7012 state jump to NORMAL
[junit-timeout] DEBUG [node4_GossipStage:1] node4 2021-04-23 16:23:07,220 Gossiper.java:1243 - removing expire time for endpoint : /127.0.0.1:7012
[junit-timeout] INFO  [node4_GossipStage:1] node4 2021-04-23 16:23:07,220 Gossiper.java:1244 - InetAddress /127.0.0.1:7012 is now UP
[junit-timeout] DEBUG [node4_BatchlogTasks:1] node4 2021-04-23 16:23:07,383 BatchlogManager.java:246 - Updating batchlog replay throttle to 1024 KB/s, 256 KB/s per endpoint
[junit-timeout] DEBUG [node4_isolatedExecutor:1] node4 2021-04-23 16:23:12,457 Gossiper.java:2142 - Gossip looks settled.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another round of gossip mostly papers over this problem, except:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] Unable to contact any seeds: []
[junit-timeout] java.lang.IllegalStateException: Unable to contact any seeds: []
[junit-timeout]         at org.apache.cassandra.service.StorageService.bootstrap(StorageService.java:1752)
[junit-timeout]         at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:1054)
[junit-timeout]         at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:1015)
[junit-timeout]         at org.apache.cassandra.service.StorageService.initServer(StorageService.java:799)
[junit-timeout]         at org.apache.cassandra.service.StorageService.initServer(StorageService.java:729)
[junit-timeout]         at org.apache.cassandra.distributed.impl.Instance.lambda$startup$10(Instance.java:541)
[junit-timeout]         at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
[junit-timeout]         at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
[junit-timeout]         at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
[junit-timeout]         at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
[junit-timeout]         at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
[junit-timeout]         at java.base/java.lang.Thread.run(Thread.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There&apos;s (correctly) no logic to add a removed node back as a seed.  This branch also prints the seeds list when this happens to disambiguate between problems contacting seeds, and problems like this where the problem is not having any seeds left to contact.&lt;/p&gt;

&lt;p&gt;Ultimately, quarantine delay can&apos;t be set this low.  I tried low non-zero values, but it needs to be set to at least one gossiper interval to avoid not accidentally reaping nodes as fat clients prematurely, and since ring delay was already being overridden and quarantine delay derived from that, I just removed the quarantine delay override.&lt;/p&gt;</comment>
                            <comment id="17332790" author="dcapwell" created="Mon, 26 Apr 2021 22:31:30 +0000"  >&lt;p&gt;The host replacement tests set it low, but what about the other classes which hit this (such as the original test &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/745/workflows/1c7e589e-b5af-4a56-b40a-43da424602c7/jobs/4231)?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/745/workflows/1c7e589e-b5af-4a56-b40a-43da424602c7/jobs/4231)?&lt;/a&gt;  We have seen this with nodeDownDuringMove(org.apache.cassandra.distributed.test.GossipTest) as well.&lt;/p&gt;</comment>
                            <comment id="17332802" author="dcapwell" created="Mon, 26 Apr 2021 22:57:08 +0000"  >&lt;p&gt;Review&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...driftx:CASSANDRA-16238#diff-99267a2170b04fd7dd24d6c6bf2ba1fc26d6dc896cd74f8c5bd56c476e2540e4R580&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...driftx:CASSANDRA-16238#diff-99267a2170b04fd7dd24d6c6bf2ba1fc26d6dc896cd74f8c5bd56c476e2540e4R580&lt;/a&gt; - nit: you can call isEmpty rather than size&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the host replacement tests, I set that field low to help find issues, so if this case happens more frequently because of that I am cool removing it; but we do see this outside of these classes as well.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;.1 is detected for the first time via gossip, and as it is going through StorageService but before it is added to TokenMetatadata, the gossiper&apos;s status check has begun running&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If I understand you, the call to StorageService.onChange (which calls handleStateNormal) happens-after gossip status check, so removes the state? GossipDigestAck2 should be handled in the gossip stage and eventually call applyNewStates to apply the state and trigger notifications, but doStatusCheck is called in the GossipTasks thread pool, which checks isGossipOnlyMember which returns true in this case (as state isn&apos;t fully settled yet), at which point we schedule a task in the gossip stage to remove (but at this point the isGossipOnlyMember(endpoint) == false).  &lt;/p&gt;

&lt;p&gt;If I understand you correctly, this feels like a race condition where we read data not fully committed, which feels like a bug (which is why it was set to 0 in the first place).  Do I understand you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17333296" author="brandon.williams" created="Tue, 27 Apr 2021 14:34:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;but we do see this outside of these classes as well.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t seen those yet.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If I understand you, the call to StorageService.onChange (which calls handleStateNormal) happens-after gossip status check, so removes the state?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s hard to know the exact order but it&apos;s clear from the first few log lines that the status check and onChange are happening concurrently.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If I understand you correctly, this feels like a race condition where we read data not fully committed, which feels like a bug (which is why it was set to 0 in the first place). Do I understand you Brandon Williams?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That may be the case as well, but yes you understand my theory thus far.&lt;/p&gt;

</comment>
                            <comment id="17334402" author="dcapwell" created="Wed, 28 Apr 2021 02:03:00 +0000"  >&lt;p&gt;If this is a race reading un-committed data, then the patch below might work around it (double check locking, but with queues)&lt;/p&gt;

&lt;p&gt;Patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ git diff
diff --git a/src/java/org/apache/cassandra/gms/Gossiper.java b/src/java/org/apache/cassandra/gms/Gossiper.java
index 699f235bd3..e82b107bac 100644
--- a/src/java/org/apache/cassandra/gms/Gossiper.java
+++ b/src/java/org/apache/cassandra/gms/Gossiper.java
@@ -928,6 +928,11 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Gossiper &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; IFailureDetectionEventListener, GossiperMBean
                 {
                     logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;FatClient {} has been silent &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; {}ms, removing from gossip&quot;&lt;/span&gt;, endpoint, fatClientTimeout);
                     runInGossipStageBlocking(() -&amp;gt; {
+                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isGossipOnlyMember(endpoint))
+                        {
+                            &lt;span class=&quot;code-comment&quot;&gt;// updating gossip and token metadata are not atomic, but rely on the single threaded gossip stage
&lt;/span&gt;+                            &lt;span class=&quot;code-comment&quot;&gt;// since status checks are done outside the gossip stage, need to confirm the state of the endpoint
&lt;/span&gt;+                            &lt;span class=&quot;code-comment&quot;&gt;// to make sure that the previous read data was correct
&lt;/span&gt;+                            logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Race condition marking {} as a FatClient; ignoring&quot;&lt;/span&gt;, endpoint);
+                            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
+                        }
                         removeEndpoint(endpoint); &lt;span class=&quot;code-comment&quot;&gt;// will put it in justRemovedEndpoints to respect quarantine delay
&lt;/span&gt;                         evictFromMembership(endpoint); &lt;span class=&quot;code-comment&quot;&gt;// can get rid of the state immediately
&lt;/span&gt;                     });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17334869" author="brandon.williams" created="Wed, 28 Apr 2021 16:49:34 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] WARN  [node4_GossipStage:1] node4 2021-04-28 16:02:24,532 Gossiper.java:1002 - Race condition marking /127.0.0.2:7012 as a FatClient; ignoring
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That will work too.&lt;/p&gt;</comment>
                            <comment id="17335687" author="brandon.williams" created="Thu, 29 Apr 2021 17:10:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-16238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Branch&lt;/a&gt; &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/716/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/716/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17335714" author="dcapwell" created="Thu, 29 Apr 2021 17:32:18 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17335741" author="brandon.williams" created="Thu, 29 Apr 2021 18:22:48 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13246065">CASSANDRA-15239</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13019247" name="16238-archived-failures.txt" size="5048" author="mck" created="Sat, 23 Jan 2021 19:16:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k4ko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/3a610066eb3df5603d8a4d0fd491e0233c708eb5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/3a610066eb3df5603d8a4d0fd491e0233c708eb5&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>