<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11087] Queries on compact storage tables in mixed version clusters can return incorrect results</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11087</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Whilst writing a dtest for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11045&quot; title=&quot;Legacy SSTables for KEYS indexes can&amp;#39;t be read in 3.0+&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11045&quot;&gt;&lt;del&gt;CASSANDRA-11045&lt;/del&gt;&lt;/a&gt;, it becomes apparent that queries on compact storage tables are broken during the 3.0 upgrade (and this has probably been the case since day 1). &lt;/p&gt;

&lt;p&gt;tl;dr In a cluster with a mix of &amp;lt; 3.0 and 3.0 nodes, reads on COMPACT STORAGE tables may not include all results. &lt;/p&gt;

&lt;p&gt;To repro: tables are created and data written before any nodes are upgraded to 3.0+, some nodes are then upgraded putting the cluster into a mixed state.&lt;br/&gt;
Now, when a query is run where the coordinator is a &amp;lt; 3.0 node, any 3.0+ replica which has not yet run upgradesstables always returns 0 results.  Once upgradesstables is run, the replica returns the correct results. Likewise, if the data is inserted after the node is upgraded, the results are correct. If the 3.0 node acts as the coordinator, the results are also correct and so once all nodes are upgraded, the problem goes away.&lt;/p&gt;

&lt;p&gt;The behaviour can be seen for both single partition and range requests as &lt;a href=&quot;https://github.com/beobal/cassandra-dtest/commit/91bb9ffd8fb761ad3454187d2f05f05a6e7af930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this dtest&lt;/a&gt; demonstrates.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12934816">CASSANDRA-11087</key>
            <summary>Queries on compact storage tables in mixed version clusters can return incorrect results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Jan 2016 14:04:45 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:43 +0000</updated>
                            <resolved>Tue, 2 Feb 2016 14:50:46 +0000</resolved>
                                        <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.3</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15121530" author="pauloricardomg" created="Thu, 28 Jan 2016 14:15:15 +0000"  >&lt;p&gt;Good catch! This would&apos;ve probably been catch by the upgrade dtests of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10563&quot; title=&quot;Integrate new upgrade test into dtest upgrade suite&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10563&quot;&gt;&lt;del&gt;CASSANDRA-10563&lt;/del&gt;&lt;/a&gt;, once they&apos;re merged in the main upgrade suite which include an intermediate mixed-versions step (not included in the current version) (just letting you know so you can probably reuse those here).&lt;/p&gt;</comment>
                            <comment id="15121688" author="beobal" created="Thu, 28 Jan 2016 15:25:40 +0000"  >&lt;p&gt;The problem is that &lt;tt&gt;AbstractSSTableReader::readStaticRow&lt;/tt&gt; doesn&apos;t interact well (in this case) with &lt;tt&gt;ReadCommand::isForThrift&lt;/tt&gt; always being set to true when a command is deserialized from a 2.x node. This causes an empty static row to be returned on the replica, whereas it should contain all of the compact columns (as it does when the 3.0 node is the coordinator).&lt;/p&gt;</comment>
                            <comment id="15121889" author="thobbs" created="Thu, 28 Jan 2016 17:00:53 +0000"  >&lt;p&gt;Should we add a flag to the upgrade tests to control flushing before upgrading?  It seems like we want to test both behaviors (to ensure commitlog replay is also covered), but there could easily be other legacy sstable reading bugs out there.&lt;/p&gt;</comment>
                            <comment id="15121928" author="beobal" created="Thu, 28 Jan 2016 17:26:27 +0000"  >&lt;p&gt;That sounds a good idea, perhaps that could be added under &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10563&quot; title=&quot;Integrate new upgrade test into dtest upgrade suite&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10563&quot;&gt;&lt;del&gt;CASSANDRA-10563&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15126281" author="beobal" created="Mon, 1 Feb 2016 14:14:51 +0000"  >&lt;p&gt;I&apos;ve pushed a fix for the command deserialization &amp;amp; opened a &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/777&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest pr&lt;/a&gt; to add a test for this particular scenario. I do agree that we should add more comprehensive coverage of the configuration space during upgrades, but I don&apos;t want to block this fix.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/11087-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11087-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11087-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11087-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/11087-3.3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11087-3.3&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11087-3.3-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11087-3.3-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/11087-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11087-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11087-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11087-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The 3.3 and trunk branches contain an additional fix to &lt;tt&gt;ReadCommandVerbHandler&lt;/tt&gt; which since 3.2 has not used the correct serializer.&lt;/p&gt;</comment>
                            <comment id="15126390" author="slebresne" created="Mon, 1 Feb 2016 15:30:30 +0000"  >&lt;p&gt;Mostly lgtm but a few remarks (the 1st one matter, the 2 others are nits really):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Pretty sure we only need to add this for compact tables (in fact, compact static ones since that&apos;s the only kind that can have statics) so it. In fact, for non-compact tables, &lt;tt&gt;metadata.compactValueColumn()&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt; and I suspect that might be a problem.&lt;/li&gt;
	&lt;li&gt;Style wise, I&apos;d prefer brackets for the &lt;tt&gt;else&lt;/tt&gt; part of the modified &lt;tt&gt;if&lt;/tt&gt; condition since the &lt;tt&gt;then&lt;/tt&gt; part has some.&lt;/li&gt;
	&lt;li&gt;Might be worth a small comment as to why we need this (if only to link back to this issue).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15128352" author="beobal" created="Tue, 2 Feb 2016 14:50:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Pretty sure we only need to add this for compact tables (in fact, compact static ones since that&apos;s the only kind that can have statics)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t think this is actually a problem, because pre-3.0 any query on a non-compact table would be a slice and not a names query, so we wouldn&apos;t hit this path. There&apos;s probably a chance that you could do this via thrift if you really tried hard enough, so I&apos;ve added the condition along with some explanation in the comments and committed to 3.0 in &lt;tt&gt;b21df5b70a22ed8bef61dd34d77d71bdfe475922&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2s3hj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>