<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8090] NullPointerException when using prepared statements</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8090</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Due to the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4914&quot; title=&quot;Aggregation functions in CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4914&quot;&gt;&lt;del&gt;CASSANDRA-4914&lt;/del&gt;&lt;/a&gt;, using a prepared statement from multiple threads leads to a race condition where the simple selection may be reset from a different thread, causing the following NPE:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException: null
	at org.apache.cassandra.cql3.ResultSet.addRow(ResultSet.java:63) ~[main/:na]
	at org.apache.cassandra.cql3.statements.Selection$ResultSetBuilder.build(Selection.java:372) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:1120) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:283) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:260) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:213) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:63) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:226) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:481) ~[main/:na]
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:133) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:438) [main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:334) [main/:na]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_67]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:163) [main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:103) [main/:na]
	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_67]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reproduced this using the stress tool:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; ./tools/bin/cassandra-stress user profile=tools/cqlstress-example.yaml ops\(insert=1,simple1=1\)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You&apos;ll need to change the &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select:&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; line to be /1000 to prevent the illegal query exceptions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12747042">CASSANDRA-8090</key>
            <summary>NullPointerException when using prepared statements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="carlyeks">Carl Yeksigian</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Oct 2014 15:00:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:31 +0000</updated>
                            <resolved>Thu, 23 Oct 2014 09:05:31 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14171069" author="tjake" created="Tue, 14 Oct 2014 15:26:39 +0000"  >&lt;p&gt;Actually any stress read now fails.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&#10140;  cassandra git:(trunk) &#10007; ./tools/bin/cassandra-stress read n=1000000 -rate threads=50
Warming up READ with 50000 iterations...
INFO  15:23:24 Using data-center name &lt;span class=&quot;code-quote&quot;&gt;&apos;datacenter1&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; DCAwareRoundRobinPolicy (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is incorrect, please provide the correct datacenter name with DCAwareRoundRobinPolicy constructor)
Connected to cluster: Test Cluster
INFO  15:23:24 New Cassandra host localhost/127.0.0.1:9042 added
Datatacenter: datacenter1; Host: localhost/127.0.0.1; Rack: rack1
java.io.IOException: Operation x0 on key(s) [4f4c344d323535353430]: Data returned was not validated

	at org.apache.cassandra.stress.Operation.error(Operation.java:153)
	at org.apache.cassandra.stress.Operation.timeWithRetry(Operation.java:125)
	at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:99)
	at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:107)
	at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:281)
	at org.apache.cassandra.stress.StressAction$Consumer.run(StressAction.java:320)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14172218" author="blerer" created="Wed, 15 Oct 2014 10:05:35 +0000"  >&lt;p&gt;The patch is on &lt;a href=&quot;https://github.com/blerer/cassandra/compare/CASSANDRA-8090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;.&lt;br/&gt;
The problem came from the fact that when fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4914&quot; title=&quot;Aggregation functions in CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4914&quot;&gt;&lt;del&gt;CASSANDRA-4914&lt;/del&gt;&lt;/a&gt; I introduced some state within the selectors (not realising that the selector are called by multiple threads) for the needs of aggregations.&lt;br/&gt;
To solve that problem I had to introduce unshared state. This could be done by either having some unshared selector states outside of the selectors or by instanciating a new set of selectors for each request.&lt;br/&gt;
I try both approach but finally settled for the second one as it was making the code easier to understand.&lt;br/&gt;
To do that the patch introduce some new classes extending Selector.Factory. Those classes are generated when the statement is prepared and they are then used to generate the Selector instances at execution time.&lt;br/&gt;
As the Selection class was becoming to big and difficult to understand I extracted the Selector classes into separate files.  &lt;/p&gt;
</comment>
                            <comment id="14172222" author="blerer" created="Wed, 15 Oct 2014 10:08:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; can you review?&lt;/p&gt;</comment>
                            <comment id="14175089" author="slebresne" created="Fri, 17 Oct 2014 14:15:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;I try both approach but finally settled for the second one as it was making the code easier to understand.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could you try to explain why the first one was less easy to understand? A priori I&apos;m not a huge fan of copying selectors every time (and of all those factories) and I think I would have naturally gone towards some per-query state that would be passed to selectors.&lt;/p&gt;</comment>
                            <comment id="14175172" author="blerer" created="Fri, 17 Oct 2014 15:46:11 +0000"  >&lt;p&gt;With the fact that functions can be nested within functions you end up with a tree structure of Selectors were each one of them might or might not need to store some state.&lt;br/&gt;
The first approach to solve that problem is to use a Map to store the state and to pass that map to each selector.&lt;br/&gt;
The problems that I see with that approach is that we will end up doing a lot of map lookups (e.g. if we have 5 columns and 10 000 rows we will end up doing 50 000 map lookups). To avoid that performance cost I tried to have a state container which is somehow iterable in the selector order but as the selectors have a tree structure the result that I got was looking a bit hacky and it was alway involving casting each time we were retrieving the state (which I found quite ugly)&lt;br/&gt;
As we were any way forced to create the same (or a bit less) number of state objects than selectors I choosed to keep the state and the method together and to create a new set of selectors each time but for that I needed a factory.    &lt;/p&gt;</comment>
                            <comment id="14178450" author="slebresne" created="Tue, 21 Oct 2014 14:18:25 +0000"  >&lt;p&gt;Ok. I&apos;m still bugged by the fact we now have to copy the selectors even when there is no aggregations, but I don&apos;t have a very good alternative to suggest so that will do for now.&lt;br/&gt;
Mostly good on the patch but 2 minor nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;since selection is now quite a few classes, could make sense to move what&apos;s selection related to a cql3/selection package (instead of having it all in cql3/statements).&lt;/li&gt;
	&lt;li&gt;I&apos;d rename &lt;tt&gt;containsNoAggregateSelectorFactories&lt;/tt&gt; to &lt;tt&gt;containsAggregateFunction&lt;/tt&gt;: we use it only negated and the double-negation is harder to read (I also don&apos;t think the &quot;SelectorFactories&quot; part adds much since the method is on &lt;tt&gt;SelectorFactories&lt;/tt&gt; but that&apos;s more of a personal taste). Similarly, &lt;tt&gt;containsOnlyAggretateSelectorFactories&lt;/tt&gt; could just be &lt;tt&gt;containsScalarFunction&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14179899" author="blerer" created="Wed, 22 Oct 2014 13:36:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Ok. I&apos;m still bugged by the fact we now have to copy the selectors even when there is no aggregations, but I don&apos;t have a very good alternative to suggest so that will do for now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I do not like it so much either but I did not find a nice approach to avoid it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;d rename containsNoAggregateSelectorFactories to containsAggregateFunction: we use it only negated and the double-negation is harder to read (I also don&apos;t think the &quot;SelectorFactories&quot; part adds much since the method is on SelectorFactories but that&apos;s more of a personal taste). Similarly, containsOnlyAggretateSelectorFactories could just be containsScalarFunction.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have simplified the name of the methods but I could not renamed as you suggested as it does not really have the same meaning.&lt;br/&gt;
What we want is that either all the selectors are the one of aggregate functions &lt;tt&gt;containsOnlyAggretateFunctions&lt;/tt&gt; or that we do not have any aggregate (which does not means that it is a scalar function, it can be a column value) &lt;tt&gt;containsNoAggregateFunctions&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have a new patch &lt;a href=&quot;https://github.com/blerer/cassandra/compare/CASSANDRA-8090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, were I renamed the 2 methods and moves the selection classes to a new package.&lt;/p&gt;

&lt;p&gt;I also noticed that the function selectors were creating an Iterator (by using a for each instead of a normal for) and a List to hold (the function arguments) for each call (e.g. 10 000 row read with a function will result in 20 000 object created). So I optimized them by reusing the List and using normal for loop. &lt;/p&gt;</comment>
                            <comment id="14181148" author="slebresne" created="Thu, 23 Oct 2014 09:05:19 +0000"  >&lt;p&gt;+1, committed with my minor nit below fixed, thanks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but I could not renamed as you suggested as it does not really have the same meaning.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My main point was that, at least for &lt;tt&gt;containsNoAggregateFunctions&lt;/tt&gt;, it&apos;s always use negated and the double negation is annoying to read. So it&apos;s a fair point that it can be a column value, but I changed it to &lt;tt&gt;doesAggregation&lt;/tt&gt; and killed the double negations. I left &lt;tt&gt;containsOnlyAggretateFunctions&lt;/tt&gt; alone, it&apos;s fine I guess since it&apos;s not always negated.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12614844">CASSANDRA-4914</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20zo7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324945">2.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>