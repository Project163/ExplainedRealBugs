<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12689] All MutationStage threads blocked, kills server</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12689</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Under heavy load (e.g. due to repair during normal operations), a lot of NullPointerExceptions occur in MutationStage. Unfortunately, the log is not very chatty, trace is missing:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-09-22T06:29:47+00:00 cas6 [MutationStage-1] org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService Uncaught exception on thread Thread[MutationStage-1,5,main]: {}
2016-09-22T06:29:47+00:00 cas6 #011java.lang.NullPointerException: null
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, after some time, in most cases ALL threads in MutationStage pools are completely blocked. This leads to piling up pending tasks until server runs OOM and is completely unresponsive due to GC. Threads will NEVER unblock until server restart. Even if load goes completely down, all hints are paused, and no compaction or repair is running. Only restart helps.&lt;/p&gt;

&lt;p&gt;I can understand that pending tasks in MutationStage may pile up under heavy load, but tasks should be processed and dequeud after load goes down. This is definitively not the case. This looks more like a an unhandled exception leading to a stuck lock.&lt;/p&gt;

&lt;p&gt;Stack trace from jconsole, all Threads in MutationStage show same trace.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Name: MutationStage-48
State: WAITING on java.util.concurrent.CompletableFuture$Signaller@fcc8266
Total blocked: 137  Total waited: 138.513
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Stack trace: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sun.misc.Unsafe.park(Native Method)
java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1693)
java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3323)
java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1729)
java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)
com.google.common.util.concurrent.Uninterruptibles.getUninterruptibly(Uninterruptibles.java:137)
org.apache.cassandra.db.Mutation.apply(Mutation.java:227)
org.apache.cassandra.db.Mutation.apply(Mutation.java:241)
org.apache.cassandra.hints.Hint.apply(Hint.java:96)
org.apache.cassandra.hints.HintVerbHandler.doVerb(HintVerbHandler.java:91)
org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:66)
java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162)
org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:134)
org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109)
java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13006891">CASSANDRA-12689</key>
            <summary>All MutationStage threads blocked, kills server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brstgt">Benjamin Roth</assignee>
                                    <reporter username="brstgt">Benjamin Roth</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Sep 2016 16:59:01 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:57 +0000</updated>
                            <resolved>Fri, 28 Oct 2016 20:48:56 +0000</resolved>
                                        <fixVersion>3.0.10</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Feature/Materialized Views</component>
                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15513841" author="brstgt" created="Thu, 22 Sep 2016 17:12:36 +0000"  >&lt;p&gt;As a graph this may look like this: &lt;a href=&quot;https://cl.ly/0N3l0D1v1P1H&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cl.ly/0N3l0D1v1P1H&lt;/a&gt;&lt;br/&gt;
You can see the mutations increase linearly. The drop was always after having restarted C*.&lt;br/&gt;
This is just an example, this scenarios happened much more often.&lt;/p&gt;

&lt;p&gt;This is the load graph of the same time window: &lt;a href=&quot;https://cl.ly/2m1S2K081o3n&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cl.ly/2m1S2K081o3n&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15514073" author="brstgt" created="Thu, 22 Sep 2016 18:21:57 +0000"  >&lt;p&gt;Same situation, different node, different trace:&lt;/p&gt;

&lt;p&gt;Name: MutationStage-37&lt;br/&gt;
State: WAITING on java.util.concurrent.CompletableFuture$Signaller@1e1dc9eb&lt;br/&gt;
Total blocked: 58  Total waited: 709.137&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)&lt;br/&gt;
java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1693)&lt;br/&gt;
java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3323)&lt;br/&gt;
java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1729)&lt;br/&gt;
java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)&lt;br/&gt;
com.google.common.util.concurrent.Uninterruptibles.getUninterruptibly(Uninterruptibles.java:137)&lt;br/&gt;
org.apache.cassandra.db.Mutation.apply(Mutation.java:227)&lt;br/&gt;
org.apache.cassandra.db.Mutation.apply(Mutation.java:241)&lt;br/&gt;
org.apache.cassandra.service.StorageProxy$$Lambda$249/1210907398.run(Unknown Source)&lt;br/&gt;
org.apache.cassandra.service.StorageProxy$8.runMayThrow(StorageProxy.java:1410)&lt;br/&gt;
org.apache.cassandra.service.StorageProxy$LocalMutationRunnable.run(StorageProxy.java:2628)&lt;br/&gt;
java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162)&lt;br/&gt;
org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:134)&lt;br/&gt;
org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109)&lt;br/&gt;
java.lang.Thread.run(Thread.java:745)&lt;/p&gt;

&lt;p&gt;Load Graph of affected node: &lt;a href=&quot;https://cl.ly/201c3T3f0M0s&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cl.ly/201c3T3f0M0s&lt;/a&gt;&lt;br/&gt;
Mutations: &lt;a href=&quot;https://cl.ly/0T2R3b0y2435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cl.ly/0T2R3b0y2435&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15515614" author="brstgt" created="Fri, 23 Sep 2016 06:53:02 +0000"  >&lt;p&gt;I don&apos;t know if this is the reason for this issue but I guess there is a bug in Keyspace.apply. If aquiring lock for MV update with a future fails, the method wont return but still continue, even though the future completes with exception. I guess there is a simple &quot;return&quot; missing after future.completeExceptionally. In Trunk this is line 486.&lt;/p&gt;

&lt;p&gt;                    if (!isClReplay &amp;amp;&amp;amp; (System.currentTimeMillis() - mutation.createdAt) &amp;gt; DatabaseDescriptor.getWriteRpcTimeout())&lt;br/&gt;
                    {&lt;br/&gt;
                        logger.trace(&quot;Could not acquire lock for {} and table {}&quot;, ByteBufferUtil.bytesToHex(mutation.key().getKey()), columnFamilyStores.get(cfid).name);&lt;br/&gt;
                        Tracing.trace(&quot;Could not acquire MV lock&quot;);&lt;br/&gt;
                        if (future != null)&lt;br/&gt;
                            future.completeExceptionally(new WriteTimeoutException(WriteType.VIEW, ConsistencyLevel.LOCAL_ONE, 0, 1));&lt;br/&gt;
                        else&lt;br/&gt;
                            throw new WriteTimeoutException(WriteType.VIEW, ConsistencyLevel.LOCAL_ONE, 0, 1);&lt;br/&gt;
                    }&lt;/p&gt;

&lt;p&gt;Not only that the mutation is applied without a lock, wich certainly induces race conditions or corruptions, in the finally block the locks are unlocked but if lock has not been acquired, the corresponding entry in &quot;locks&quot; is null, thus throwing a NPE.&lt;/p&gt;</comment>
                            <comment id="15515738" author="stefania" created="Fri, 23 Sep 2016 08:00:03 +0000"  >&lt;p&gt;I tend to agree that there should be a return after &lt;tt&gt;future.completeExceptionally&lt;/tt&gt;. I also think there should be a check in the finally block to make sure each lock is not null, plus the locks seem to be released twice.&lt;/p&gt;

&lt;p&gt;The related tickets should be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10779&quot; title=&quot;Mutations do not block for completion under view lock contention&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10779&quot;&gt;&lt;del&gt;CASSANDRA-10779&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10981&quot; title=&quot;Consider striping view locks by key and cfid&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10981&quot;&gt;&lt;del&gt;CASSANDRA-10981&lt;/del&gt;&lt;/a&gt;, cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15517163" author="brstgt" created="Fri, 23 Sep 2016 18:15:49 +0000"  >&lt;p&gt;Adding the return statements fixed all the NPEs in the log. Unfortunately the MutationStage problem occured once again.&lt;br/&gt;
Will observe it. I turned on the newly implemented RateBasedBackPressure, will see if it changes anything.&lt;/p&gt;</comment>
                            <comment id="15517463" author="brstgt" created="Fri, 23 Sep 2016 20:18:54 +0000"  >&lt;p&gt;Some more graphs: You can see that really absolutely NO mutations are applied any more, once the situation occurs:&lt;/p&gt;

&lt;p&gt;Completed Tasks: &lt;a href=&quot;https://cl.ly/323O3T0i3e0P&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cl.ly/323O3T0i3e0P&lt;/a&gt;&lt;br/&gt;
Pending Tasks: &lt;a href=&quot;https://cl.ly/0Y0o0E0l011W&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cl.ly/0Y0o0E0l011W&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15519287" author="brstgt" created="Sat, 24 Sep 2016 16:43:41 +0000"  >&lt;p&gt;I guess I found the cause of the problem (at least I&apos;m pretty sure).&lt;br/&gt;
There is a race condition in calling Keyspace.apply in a blocking manner from Mutation.apply. See Mutation line 227, Uninterruptibles.getUninterruptibly(applyFuture(durableWrites))&lt;/p&gt;

&lt;p&gt;When this is called AND the lock for MV update could not be aquired, THEN the apply is being deferred on MutationStage queue and Mutation.apply is waiting for this deferred task to finish, right? So this Thread (MutationStageWorker) is blocked until the deferred future is completed and cannot process any other tasks in the mutation queue.&lt;br/&gt;
But what if all mutation workers are currently busy and in the same situation? Then the deferred tasks will never be processed, the futures will never complete and all workers are waiting for their futures to be completed which will never happen =&amp;gt; Complete DEADLOCK.&lt;/p&gt;

&lt;p&gt;More abstract: A blocking call in any stage MUST NEVER defer itself on its own stage.&lt;br/&gt;
Simple example: Imagine a queue with 1 worker. That worker is processing a task of this queue. This task enqueues another task on the same queue and wait for it to finish. It never will, as there is only one worker and this one is now blocked.&lt;/p&gt;

&lt;p&gt;Possible solutions:&lt;br/&gt;
1. complete future before defer. Would resolve that special issue but that would mean &quot;fire and forget&quot; and that is not what futures are made for&lt;br/&gt;
2. Do not block in Mutation.apply or use Mutation.applyFuture in critical situations - probably fine solution but harder to implement and big impact on existing code&lt;br/&gt;
3. My personally preferred option: Introduce &quot;deferrable&quot; flag in Keyspace.apply and set it to false when called from a blocking context. If true then dont defer current apply but retry in loop until success or writeTimout is reached, maybe with a small sleep time depending on writeTimeout (e.g. writeTimeout / 100).&lt;/p&gt;

&lt;p&gt;Apart from all that:&lt;br/&gt;
If a caller is waiting (blocking) for a future to finish it absolutely makes no sense to defer it to be processed by another thread in the future for not to block the current thread (see comment on line 492 in Keyspace). The caller thread is blocked anyway by waiting for the future to complete.&lt;/p&gt;

&lt;p&gt;Does someone agree?&lt;/p&gt;</comment>
                            <comment id="15519532" author="brstgt" created="Sat, 24 Sep 2016 19:45:51 +0000"  >&lt;p&gt;Please check this commit: &lt;a href=&quot;https://github.com/Jaumo/cassandra/commit/2f4fd84680e7a29baece58a035a740e9fbf3a1c5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Jaumo/cassandra/commit/2f4fd84680e7a29baece58a035a740e9fbf3a1c5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Sorry if this is not &quot;the way to go&quot;. I never contributed code to cassandra before and I am not very familiar with the codebase and your workflows.&lt;/p&gt;</comment>
                            <comment id="15521533" author="zznate" created="Sun, 25 Sep 2016 22:36:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brstgt&quot; class=&quot;user-hover&quot; rel=&quot;brstgt&quot;&gt;brstgt&lt;/a&gt; Thanks for this. Can you create a failing test for the original condition via dtest (&lt;a href=&quot;https://github.com/riptano/cassandra-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest&lt;/a&gt;) and verify that this fix works?&lt;/p&gt;

&lt;p&gt;Feel free to ping back for assistance with dtest if needed. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Sorry if this is not &quot;the way to go&quot;. I never contributed code to cassandra before and I am not very familiar with the codebase and your workflows.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Take a look at the following for details regarding development workflow: &lt;a href=&quot;http://cassandra.apache.org/doc/latest/development/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassandra.apache.org/doc/latest/development/index.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let us know on cassandra-dev IRC or dev@ mail list if you have any additional questions. &lt;/p&gt;

&lt;p&gt;Again, thanks for the effort on the analysis and patch submission. &lt;/p&gt;</comment>
                            <comment id="15529034" author="brstgt" created="Wed, 28 Sep 2016 09:25:05 +0000"  >&lt;p&gt;I was able to tack that bug down and prove it with a negative dtest and was able to prove my fix with a positive dtest. (&lt;a href=&quot;https://gist.github.com/brstgt/339d20994828794c8f374bc987b7b6d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/brstgt/339d20994828794c8f374bc987b7b6d7&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;To be able to run that tests I had to do some hacks (&lt;a href=&quot;https://github.com/Jaumo/cassandra/commit/6b6806b9ba60c9b7111f00451aec4c6182199702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Jaumo/cassandra/commit/6b6806b9ba60c9b7111f00451aec4c6182199702&lt;/a&gt;) so that there is only a single mutation worker and to fail to aquire MV locks in a determined order. The test is not deterministic if there is more than 1 worker, because then race conditions will pop up.&lt;/p&gt;

&lt;p&gt;From my point of view there is a solid proof of my theory. Please apply my patch. I deployed it already on our production system and it also seems to work there - at least there were no more deadlocks under high load.&lt;/p&gt;

&lt;p&gt;Ah, btw: That bug is as old as MVs are.&lt;/p&gt;

&lt;p&gt;If there are questions, please get back to me.&lt;/p&gt;</comment>
                            <comment id="15536555" author="jmckenzie" created="Fri, 30 Sep 2016 17:41:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; to review.&lt;/p&gt;</comment>
                            <comment id="15537409" author="thobbs" created="Fri, 30 Sep 2016 23:32:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brstgt&quot; class=&quot;user-hover&quot; rel=&quot;brstgt&quot;&gt;brstgt&lt;/a&gt; thanks for the patch!  I think you selected the best approach for now.  My main concern is that it&apos;s error prone (in terms of blocking callers using the wrong method), but I&apos;m not sure how feasible it is to avoid that without a larger overhaul (e.g. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10993&quot; title=&quot;Make read and write requests paths fully non-blocking, eliminate related stages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10993&quot;&gt;CASSANDRA-10993&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Here&apos;s my feedback on the patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I think the sleep in between lock acquisition attempts could be too long when write timeouts are higher than the default.  I would be in favor of switching to a low, hard-coded timeout (maybe somewhere around 10ms), as it shouldn&apos;t be common for the lock to be held longer than this.  A longer sleep could introduce unnecessary latency spikes under light contention.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;PaxosState.commit()&lt;/tt&gt; needs to switch to &lt;tt&gt;applyNotDeferrable()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Adding some javadocs to the various &lt;tt&gt;apply()&lt;/tt&gt; methods to state when each should be used would be good, and help to avoid accidental misuse in the future.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also have a few code style nitpicks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For single-line &lt;tt&gt;if/else&lt;/tt&gt; bodies, we don&apos;t use curly braces (see the &lt;tt&gt;TEST_FAIL_MV_LOCKS_COUNT&lt;/tt&gt; handling)&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;isDeferrable&lt;/tt&gt; override can just be written as &lt;tt&gt;isDeferrable |= TEST_FORCE_DEFERABLE_MUTATIONS&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The name &lt;tt&gt;TEST_FORCE_DEFERABLE_MUTATIONS&lt;/tt&gt; was typo&apos;d (should be &lt;tt&gt;DEFERRABLE&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;You can use &lt;tt&gt;Integer.getInteger(&quot;cassandra.test...&quot;)&lt;/tt&gt; and &lt;tt&gt;Boolean.getBoolean()&lt;/tt&gt; when setting &lt;tt&gt;TEST_FAIL_MV_LOCKS_COUNT&lt;/tt&gt; and &lt;tt&gt;TEST_FORCE_DEFERRABLE_MUTATIONS&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding the new dtest, that looks like a very nice start.  Would you mind opening a pull request against the &lt;a href=&quot;https://github.com/riptano/cassandra-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest repo&lt;/a&gt; referencing this ticket?  I can provide feedback for the test on the pull request.&lt;/p&gt;

&lt;p&gt;Thanks again for taking the time to fix this.&lt;/p&gt;</comment>
                            <comment id="15537972" author="brstgt" created="Sat, 1 Oct 2016 06:03:40 +0000"  >&lt;p&gt;Hi Tyler,&lt;/p&gt;

&lt;p&gt;Thanks for the review. Of course this solution is error prone, but as I stated earlier it&apos;s IMHO the only one that fixes it now with no risk.&lt;/p&gt;

&lt;p&gt;I had a conversation with @zznate these days and he asked me to remove that &quot;ugly test switches&quot; like TEST_FORCE_DEFERABLE_MUTATIONS.&lt;br/&gt;
I personally don&apos;t care - I am just a newbie to CS. Either I can leave the test switches in, apply your feedback and commit that dtest or I throw them away but then this situation is not testable any more with dtest. &lt;br/&gt;
And the next problem with dtest is: Only the positive test works nice. The negative test ends in write timeouts and shows tons of errors. I implemented it for a proof but I would not recommend to commit it. So the TEST_FORCE_DEFERABLE_MUTATIONS can also be thrown away, it&apos;s only required for the negative test.&lt;br/&gt;
If I commit that dtest, should I create a new test file or append that test to an existing one?&lt;br/&gt;
So, @thobbs + @zznate please tell me how to move on.&lt;/p&gt;

&lt;p&gt;I already thought that PaxosState.commit maybe will allso need to be not deferrable but was not sure if that also happens within the mutation stage. Unfortunately I am missing the bigger picture in the CS code at the moment.&lt;/p&gt;</comment>
                            <comment id="15546666" author="thobbs" created="Tue, 4 Oct 2016 21:08:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;Thanks for the review. Of course this solution is error prone, but as I stated earlier it&apos;s IMHO the only one that fixes it now with no risk.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I agree with that assessment.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Either I can leave the test switches in, apply your feedback and commit that dtest or I throw them away but then this situation is not testable any more with dtest. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe test switches are acceptable when there&apos;s not a reasonable alternative for testing something.  So, I would keep them here until we have a better alternative (such as this being unit-testable).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The negative test ends in write timeouts and shows tons of errors. I implemented it for a proof but I would not recommend to commit it. So the TEST_FORCE_DEFERABLE_MUTATIONS can also be thrown away, it&apos;s only required for the negative test.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Alright, let&apos;s remove that test and &lt;tt&gt;TEST_FORCE_DEFERABLE_MUTATIONS&lt;/tt&gt;, then.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If I commit that dtest, should I create a new test file or append that test to an existing one?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would add the new test class to &lt;tt&gt;materialized_views_test.py&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I already thought that PaxosState.commit maybe will allso need to be not deferrable but was not sure if that also happens within the mutation stage.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I double checked this and it looks like it will get run on the mutation stage: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/MessagingService.java#L266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/MessagingService.java#L266&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me know if you have any other questions I can help with.&lt;/p&gt;</comment>
                            <comment id="15548429" author="brstgt" created="Wed, 5 Oct 2016 11:20:53 +0000"  >&lt;p&gt;New commit with your feedback: &lt;a href=&quot;https://github.com/Jaumo/cassandra/commit/a79de2aae7f15c5794aacda442a13a8e4a91d65e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Jaumo/cassandra/commit/a79de2aae7f15c5794aacda442a13a8e4a91d65e&lt;/a&gt;&lt;br/&gt;
I also created a PR in dtests&lt;/p&gt;</comment>
                            <comment id="15581333" author="brstgt" created="Mon, 17 Oct 2016 06:05:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; Is there a reason why you didn&apos;t merge my patch yet?&lt;/p&gt;</comment>
                            <comment id="15586933" author="thobbs" created="Tue, 18 Oct 2016 22:52:41 +0000"  >&lt;p&gt;Sorry, I&apos;ve been focused on other work.  Your latest commit looks good, so I&apos;ll try to wrap this up tomorrow.  I believe the patch needs to be backported to 3.0 (since the bug seems to exist there as well), but I can handle that if you need.&lt;/p&gt;</comment>
                            <comment id="15589154" author="thobbs" created="Wed, 19 Oct 2016 16:21:05 +0000"  >&lt;p&gt;I&apos;ve backported the patch to 3.0 and started CI test runs:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-12689-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-12689-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12689-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12689-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-12689-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-12689-3.X&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12689-3.X-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12689-3.X-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-12689-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-12689-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12689-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12689-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15590920" author="brstgt" created="Thu, 20 Oct 2016 06:05:03 +0000"  >&lt;p&gt;Is there anything left for me to do? If not, thanks for your help!&lt;/p&gt;</comment>
                            <comment id="15613199" author="thobbs" created="Thu, 27 Oct 2016 21:01:22 +0000"  >&lt;p&gt;It looks like there are some problems with the existing dtests in my 3.0 backport, I&apos;ll need to spend a bit of time fixing those.&lt;/p&gt;</comment>
                            <comment id="15613256" author="thobbs" created="Thu, 27 Oct 2016 21:20:25 +0000"  >&lt;p&gt;Okay, I believe I fixed the problem, and I&apos;ve restarted the 3.0 tests.&lt;/p&gt;</comment>
                            <comment id="15616518" author="thobbs" created="Fri, 28 Oct 2016 20:48:42 +0000"  >&lt;p&gt;The new test results look good, so +1, committed to 3.0 as &lt;tt&gt;d38a732ce15caab57ce6dddb3c0d6a436506db29&lt;/tt&gt; and merged up to 3.X and trunk.  Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13020295">CASSANDRA-12905</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brstgt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33yn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>