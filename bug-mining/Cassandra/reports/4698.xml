<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13384] Legacy caching options can prevent 3.0 upgrade</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13384</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In 2.1, we wrote caching options as a JSONified map, but we tolerated raw strings &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/cache/CachingOptions.java#L42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&quot;ALL&quot;, &quot;KEYS_ONLY&quot;, &quot;ROWS_ONLY&quot;, and &quot;NONE&quot;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If a 2.1 node with any of these strings is upgraded to 3.0, the legacy schema migration will fail.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13059612">CASSANDRA-13384</key>
            <summary>Legacy caching options can prevent 3.0 upgrade</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="jjirsa">Jeff Jirsa</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Mar 2017 04:20:16 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Wed, 29 Mar 2017 00:32:37 +0000</resolved>
                                        <fixVersion>3.0.13</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15945598" author="jjirsa" created="Tue, 28 Mar 2017 17:30:20 +0000"  >&lt;p&gt;No patch for trunk, we don&apos;t expect 2.x -&amp;gt; 4.0 upgrades, they have to go through 3.0, which will handle the upgrade. &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; utest &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtest &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.0-13384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.0-13384-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.0-13384-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.11-13384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.11-13384-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/jeffjirsa-cassandra-3.11-13384-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

</comment>
                            <comment id="15945610" author="JIRAUSER308715" created="Tue, 28 Mar 2017 17:38:35 +0000"  >&lt;p&gt;Change looks good to me, but maybe we should add an upgrade dtest which triggers the issue?&lt;/p&gt;</comment>
                            <comment id="15945688" author="jjirsa" created="Tue, 28 Mar 2017 18:31:46 +0000"  >&lt;p&gt;How strong is your desire to see a dtest? I think it&apos;s a reasonable ask, but it&apos;s also a LOT of effort. &lt;/p&gt;

&lt;p&gt;The dtest upgrade logic that exists requires a consistent native proto version through the test. Since 2.0 and 3.0 don&apos;t have a common native proto, none of the existing rolling tests can be used - we&apos;d have to write a new harness that shuts down the session and reconnects midway through the test, which is do-able, but a fair amount of effort for something that seems like it&apos;s testable with a unit test.&lt;/p&gt;
</comment>
                            <comment id="15945738" author="jjirsa" created="Tue, 28 Mar 2017 19:02:01 +0000"  >&lt;p&gt;Note: 3.11 seems to have made &lt;tt&gt;testReport/junit/org.apache.cassandra.schema/LegacySchemaMigratorTest&lt;/tt&gt; flakey&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    [junit] Testcase: testMigrateLegacyCachingOptions(org.apache.cassandra.schema.LegacySchemaMigratorTest):	FAILED
    [junit] This assertion failure is probably due to accessing Schema.instance from client-mode tools - See CASSANDRA-8143.
    [junit] junit.framework.AssertionFailedError: This assertion failure is probably due to accessing Schema.instance from client-mode tools - See CASSANDRA-8143.
    [junit] 	at org.apache.cassandra.config.CFMetaData.&amp;lt;init&amp;gt;(CFMetaData.java:286)
    [junit] 	at org.apache.cassandra.config.CFMetaData.&amp;lt;init&amp;gt;(CFMetaData.java:65)
    [junit] 	at org.apache.cassandra.config.CFMetaData$Builder.build(CFMetaData.java:1328)
    [junit] 	at org.apache.cassandra.config.CFMetaData.compile(CFMetaData.java:427)
    [junit] 	at org.apache.cassandra.db.SystemKeyspace.compile(SystemKeyspace.java:435)
    [junit] 	at org.apache.cassandra.db.SystemKeyspace.&amp;lt;clinit&amp;gt;(SystemKeyspace.java:116)
    [junit] 	at org.apache.cassandra.schema.LegacySchemaMigrator.&amp;lt;clinit&amp;gt;(LegacySchemaMigrator.java:65)
    [junit] 	at org.apache.cassandra.schema.LegacySchemaMigratorTest.testMigrateLegacyCachingOptions(LegacySchemaMigratorTest.java:106)
    [junit]
    [junit]
    [junit] Testcase: testMigrate(org.apache.cassandra.schema.LegacySchemaMigratorTest):	Caused an ERROR
    [junit] Could not initialize &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.db.SystemKeyspace
    [junit] java.lang.NoClassDefFoundError: Could not initialize &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.db.SystemKeyspace
    [junit] 	at org.apache.cassandra.config.Schema.&amp;lt;init&amp;gt;(Schema.java:70)
    [junit] 	at org.apache.cassandra.config.Schema.&amp;lt;clinit&amp;gt;(Schema.java:49)
    [junit] 	at org.apache.cassandra.cql3.functions.UDFunction.&amp;lt;init&amp;gt;(UDFunction.java:215)
    [junit] 	at org.apache.cassandra.cql3.functions.JavaBasedUDFunction.&amp;lt;init&amp;gt;(JavaBasedUDFunction.java:190)
    [junit] 	at org.apache.cassandra.cql3.functions.UDFunction.create(UDFunction.java:233)
    [junit] 	at org.apache.cassandra.schema.LegacySchemaMigratorTest.keyspaceWithUDFs(LegacySchemaMigratorTest.java:374)
    [junit] 	at org.apache.cassandra.schema.LegacySchemaMigratorTest.keyspacesToMigrate(LegacySchemaMigratorTest.java:293)
    [junit] 	at org.apache.cassandra.schema.LegacySchemaMigratorTest.testMigrate(LegacySchemaMigratorTest.java:72)
    [junit]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Investigating to see if it&apos;s a test problem or regression.&lt;/p&gt;</comment>
                            <comment id="15945953" author="jjirsa" created="Tue, 28 Mar 2017 20:58:49 +0000"  >&lt;p&gt;There&apos;s a second commit that more explicitly initializes the tests, which handles potential problems in ordering. With that change, I&apos;ve executed the unit test 150 times locally and once on CI without error. &lt;/p&gt;

&lt;p&gt;Back to you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt; - how strongly do you feel that the dtest is necessary?&lt;/p&gt;</comment>
                            <comment id="15946064" author="JIRAUSER308715" created="Tue, 28 Mar 2017 22:14:12 +0000"  >&lt;p&gt;So I did some more investigation here with some test upgrades myself and after creating a table on 2.0 and upgrading to 2.1 the schema seemingly has the correct json formatted thing in it.  But if you then immediately upgrade to 3.0 with a kill -9 stop, 3.0 fails to start.  If you instead flush before upgrading to 3.0 the json version of the schema is flushed to disk, and everything is fine.  I&apos;m not sure it is worth adding ugly legacy conversion hacks in 3.x for this super edge case of &quot;upgrade as fast as I can without flushing&quot;.&lt;/p&gt;</comment>
                            <comment id="15946070" author="JIRAUSER308715" created="Tue, 28 Mar 2017 22:17:25 +0000"  >&lt;p&gt;Anyway, this code works.  Adding basically dead code to 3.x seems ugly to me, but it is possible to hit this if you upgrade fast enough, so I guess it may be worth adding it, since we can drop it on merge to master.&lt;/p&gt;</comment>
                            <comment id="15946073" author="jjirsa" created="Tue, 28 Mar 2017 22:20:25 +0000"  >&lt;p&gt;I intend to drop it on the merge to master - would only exist for 3.0 and 3.11&lt;/p&gt;</comment>
                            <comment id="15946079" author="JIRAUSER308715" created="Tue, 28 Mar 2017 22:23:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15946290" author="jjirsa" created="Wed, 29 Mar 2017 00:32:37 +0000"  >&lt;p&gt;Committed to 3.0 as &lt;tt&gt;6edc26824747b204fefc31478db833667d5d5892&lt;/tt&gt;, merged into 3.11, and then skipped trunk (did &lt;tt&gt;merge -s ours&lt;/tt&gt;, but only updated CHANGES, so the code will not exist for 4.0).&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt; . &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cvfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jjordan</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjordan]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>