<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:56:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9882] DTCS (maybe other strategies) can block flushing when there are lots of sstables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9882</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;MemtableFlushWriter tasks can get blocked by Compaction getNextBackgroundTask.  This is in a wonky cluster with 200k sstables in the CF, but seems bad for flushing to be blocked by getNextBackgroundTask when we are trying to make these new &quot;smart&quot; strategies that may take some time to calculate what to do.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;MemtableFlushWriter:21&quot; daemon prio=10 tid=0x00007ff7ad965000 nid=0x6693 waiting for monitor entry [0x00007ff78a667000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at org.apache.cassandra.db.compaction.WrappingCompactionStrategy.handleNotification(WrappingCompactionStrategy.java:237)
	- waiting to lock &amp;lt;0x00000006fcdbbf60&amp;gt; (a org.apache.cassandra.db.compaction.WrappingCompactionStrategy)
	at org.apache.cassandra.db.DataTracker.notifyAdded(DataTracker.java:518)
	at org.apache.cassandra.db.DataTracker.replaceFlushed(DataTracker.java:178)
	at org.apache.cassandra.db.compaction.AbstractCompactionStrategy.replaceFlushed(AbstractCompactionStrategy.java:234)
	at org.apache.cassandra.db.ColumnFamilyStore.replaceFlushed(ColumnFamilyStore.java:1475)
	at org.apache.cassandra.db.Memtable$FlushRunnable.runMayThrow(Memtable.java:336)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1127)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

   Locked ownable synchronizers:
	- &amp;lt;0x0000000743b3ac38&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)

&quot;MemtableFlushWriter:19&quot; daemon prio=10 tid=0x00007ff7ac57a000 nid=0x649b waiting for monitor entry [0x00007ff78b8ee000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at org.apache.cassandra.db.compaction.WrappingCompactionStrategy.handleNotification(WrappingCompactionStrategy.java:237)
	- waiting to lock &amp;lt;0x00000006fcdbbf60&amp;gt; (a org.apache.cassandra.db.compaction.WrappingCompactionStrategy)
	at org.apache.cassandra.db.DataTracker.notifyAdded(DataTracker.java:518)
	at org.apache.cassandra.db.DataTracker.replaceFlushed(DataTracker.java:178)
	at org.apache.cassandra.db.compaction.AbstractCompactionStrategy.replaceFlushed(AbstractCompactionStrategy.java:234)
	at org.apache.cassandra.db.ColumnFamilyStore.replaceFlushed(ColumnFamilyStore.java:1475)
	at org.apache.cassandra.db.Memtable$FlushRunnable.runMayThrow(Memtable.java:336)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297)
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1127)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

&quot;CompactionExecutor:14&quot; daemon prio=10 tid=0x00007ff7ad359800 nid=0x4d59 runnable [0x00007fecce3ea000]
   java.lang.Thread.State: RUNNABLE
	at org.apache.cassandra.io.sstable.SSTableReader.equals(SSTableReader.java:628)
	at com.google.common.collect.ImmutableSet.construct(ImmutableSet.java:206)
	at com.google.common.collect.ImmutableSet.construct(ImmutableSet.java:220)
	at com.google.common.collect.ImmutableSet.access$000(ImmutableSet.java:74)
	at com.google.common.collect.ImmutableSet$Builder.build(ImmutableSet.java:531)
	at com.google.common.collect.Sets$1.immutableCopy(Sets.java:606)
	at org.apache.cassandra.db.ColumnFamilyStore.getOverlappingSSTables(ColumnFamilyStore.java:1352)
	at org.apache.cassandra.db.compaction.DateTieredCompactionStrategy.getNextBackgroundSSTables(DateTieredCompactionStrategy.java:88)
	at org.apache.cassandra.db.compaction.DateTieredCompactionStrategy.getNextBackgroundTask(DateTieredCompactionStrategy.java:65)
	- locked &amp;lt;0x00000006fcdbbf00&amp;gt; (a org.apache.cassandra.db.compaction.DateTieredCompactionStrategy)
	at org.apache.cassandra.db.compaction.WrappingCompactionStrategy.getNextBackgroundTask(WrappingCompactionStrategy.java:72)
	- locked &amp;lt;0x00000006fcdbbf60&amp;gt; (a org.apache.cassandra.db.compaction.WrappingCompactionStrategy)
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:238)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12848660">CASSANDRA-9882</key>
            <summary>DTCS (maybe other strategies) can block flushing when there are lots of sstables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="jeremiah">Jeremiah Jordan</reporter>
                        <labels>
                            <label>dtcs</label>
                    </labels>
                <created>Thu, 23 Jul 2015 19:03:44 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:59 +0000</updated>
                            <resolved>Tue, 18 Aug 2015 09:03:23 +0000</resolved>
                                        <fixVersion>2.0.17</fixVersion>
                    <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>3.0 beta 1</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="14681807" author="krummas" created="Tue, 11 Aug 2015 13:38:37 +0000"  >&lt;p&gt;so, problem is that DTCS checks for expired sstables among all sstables on disk, every time we get a new background task, and this can take a long time if there are many sstables on disk&lt;/p&gt;

&lt;p&gt;patch here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/9882&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/9882&lt;/a&gt; which only checks every 10 minutes&lt;/p&gt;</comment>
                            <comment id="14681893" author="thorntsg" created="Tue, 11 Aug 2015 14:47:07 +0000"  >&lt;p&gt;Edit: trying to remember formatting - haven&apos;t posted anything for a while&lt;/p&gt;

&lt;p&gt;Also have seen this behavior under LCS.  Again with a cluster that had 150-200K sstables.  First thread below executed for a very, very long time and held onto a lock that blocked flushes and compactions (and some jmx methods).  Glanced at the code and saw some nested loops each going through all sstables but didn&apos;t look deeper than that.&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;CompactionExecutor:12&quot; daemon prio=10 tid=0x00002ad7735244a0 nid=0x81f6 runnable [0x00002ad7beb60000]
   java.lang.Thread.State: RUNNABLE
	at org.apache.cassandra.dht.Bounds.intersects(Bounds.java:67)
	at org.apache.cassandra.db.compaction.LeveledManifest.overlapping(LeveledManifest.java:459)
	at org.apache.cassandra.db.compaction.LeveledManifest.overlapping(LeveledManifest.java:445)
	at org.apache.cassandra.db.compaction.LeveledManifest.getCandidatesFor(LeveledManifest.java:520)
	at org.apache.cassandra.db.compaction.LeveledManifest.getCompactionCandidates(LeveledManifest.java:307)
	- locked &amp;lt;0x00000006b02c9a30&amp;gt; (a org.apache.cassandra.db.compaction.LeveledManifest)
	at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.getMaximalTask(LeveledCompactionStrategy.java:121)
	at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.getNextBackgroundTask(LeveledCompactionStrategy.java:113)
	- locked &amp;lt;0x00000006b0315410&amp;gt; (a org.apache.cassandra.db.compaction.LeveledCompactionStrategy)
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:192)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

   Locked ownable synchronizers:
	- &amp;lt;0x0000000739a196c0&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)

&quot;FlushWriter:26&quot; daemon prio=10 tid=0x00002ad697d84210 nid=0x941f waiting for monitor entry [0x00002ad7bfb5f000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at org.apache.cassandra.db.compaction.LeveledManifest.add(LeveledManifest.java:118)
	- waiting to lock &amp;lt;0x00000006b02c9a30&amp;gt; (a org.apache.cassandra.db.compaction.LeveledManifest)
	at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:181)
	at org.apache.cassandra.db.DataTracker.notifyAdded(DataTracker.java:461)
	at org.apache.cassandra.db.DataTracker.replaceFlushed(DataTracker.java:179)
	at org.apache.cassandra.db.compaction.AbstractCompactionStrategy.replaceFlushed(AbstractCompactionStrategy.java:231)
	at org.apache.cassandra.db.ColumnFamilyStore.replaceFlushed(ColumnFamilyStore.java:1151)
	at org.apache.cassandra.db.Memtable$FlushRunnable.runMayThrow(Memtable.java:346)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

   Locked ownable synchronizers:
	- &amp;lt;0x00000006c8c12568&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)

&quot;CompactionExecutor:15&quot; daemon prio=10 tid=0x00002ad697eb9640 nid=0x81fa waiting for monitor entry [0x00002ad7bea5c000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at org.apache.cassandra.db.compaction.LeveledManifest.replace(LeveledManifest.java:128)
	- waiting to lock &amp;lt;0x00000006b02c9a30&amp;gt; (a org.apache.cassandra.db.compaction.LeveledManifest)
	at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:186)
	at org.apache.cassandra.db.DataTracker.notifySSTablesChanged(DataTracker.java:454)
	at org.apache.cassandra.db.DataTracker.replaceCompactedSSTables(DataTracker.java:267)
	at org.apache.cassandra.db.ColumnFamilyStore.replaceCompactedSSTables(ColumnFamilyStore.java:1146)
	at org.apache.cassandra.db.compaction.CompactionTask.replaceCompactedSSTables(CompactionTask.java:330)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:254)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

   Locked ownable synchronizers:
	- &amp;lt;0x00000007399e4110&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)

&quot;CompactionExecutor:11&quot; daemon prio=10 tid=0x00002ad773523ed0 nid=0x81f5 waiting on condition [0x00002ad7beba1000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &amp;lt;0x00000007976adaf0&amp;gt; (a java.util.concurrent.FutureTask)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
	at java.util.concurrent.FutureTask.awaitDone(FutureTask.java:425)
	at java.util.concurrent.FutureTask.get(FutureTask.java:187)
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:409)
	at org.apache.cassandra.db.SystemKeyspace.forceBlockingFlush(SystemKeyspace.java:459)
	at org.apache.cassandra.db.SystemKeyspace.finishCompaction(SystemKeyspace.java:205)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:237)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)

   Locked ownable synchronizers:
	- &amp;lt;0x00000007399c4a60&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)

&quot;RMI TCP Connection(130)-10.129.124.20&quot; daemon prio=10 tid=0x00002ad5d8598750 nid=0xc054 waiting for monitor entry [0x00002ad7bdce5000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at org.apache.cassandra.db.compaction.LeveledManifest.getEstimatedTasks(LeveledManifest.java:620)
	- waiting to lock &amp;lt;0x00000006b02c9a30&amp;gt; (a org.apache.cassandra.db.compaction.LeveledManifest)
	at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.getEstimatedRemainingTasks(LeveledCompactionStrategy.java:173)
	at org.apache.cassandra.metrics.CompactionMetrics$1.value(CompactionMetrics.java:64)
	at org.apache.cassandra.metrics.CompactionMetrics$1.value(CompactionMetrics.java:57)
  ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14682252" author="JIRAUSER308715" created="Tue, 11 Aug 2015 18:35:31 +0000"  >&lt;p&gt;So not doing that every time will probably help some.  In the case I saw it was taking 10s of minutes for the call to finish, how often it happens should probably be configurable in some way.  Since your 10 minute number is just a guess.&lt;/p&gt;</comment>
                            <comment id="14682256" author="jbellis" created="Tue, 11 Aug 2015 18:36:33 +0000"  >&lt;p&gt;I don&apos;t see any value in making this configurable.&lt;/p&gt;</comment>
                            <comment id="14682314" author="krummas" created="Tue, 11 Aug 2015 19:05:01 +0000"  >&lt;p&gt;Pushed another commit to the repo that fixes the unit test failure: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9882-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9882-testall/&lt;/a&gt; hopefully this will trigger a proper dtest run as well: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9882-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9882-dtest/&lt;/a&gt;. It also sets the lastExpiredCheck time after the calculation to always have 10 minutes of non-calculation &lt;/p&gt;</comment>
                            <comment id="14687393" author="yukim" created="Tue, 11 Aug 2015 21:13:04 +0000"  >&lt;p&gt;As Sean&apos;s log above suggests, I think this can happen on other compaction strategy as well.&lt;br/&gt;
Compaction strategies try as much as possible in &lt;tt&gt;AbstractCompactionStrategy#getNextbackgroundTask&lt;/tt&gt; to create new compaction task with &lt;tt&gt;while(true)&lt;/tt&gt; loop.&lt;br/&gt;
The method is &lt;tt&gt;synchronized&lt;/tt&gt; so until compaction strategy find compacting sstables and mark them compacting, other &lt;tt&gt;synchronized&lt;/tt&gt; methods like &lt;tt&gt;handleNotification&lt;/tt&gt; is blocked.&lt;/p&gt;

&lt;p&gt;I suggest just removing &lt;tt&gt;while(true)&lt;/tt&gt; loop from all compaction strategies and let them try to find the next available candidates in the next background compaction round.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9592&quot; title=&quot;`Periodically attempt to submit background compaction tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9592&quot;&gt;&lt;del&gt;CASSANDRA-9592&lt;/del&gt;&lt;/a&gt; keeps submitting background compaction so it should keep compaction continue to work.&lt;/p&gt;

&lt;p&gt;Patch here: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/9882-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/9882-2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14693305" author="krummas" created="Wed, 12 Aug 2015 10:43:58 +0000"  >&lt;p&gt;I&apos;m not sure this is the way forward, the only&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; time we loop here is if we fail to mark sstables as compacting, and that should be very rare. If it is not very rare, this patch could stall compactions for 5 minutes. Perhaps we could move the looping outside of the synchronized block though? Something like this: &lt;a href=&quot;https://github.com/krummas/cassandra/blob/79191d5d04d29e386855a04bfc080c49fe5a97b4/src/java/org/apache/cassandra/db/compaction/LeveledCompactionStrategy.java#L109-L157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/blob/79191d5d04d29e386855a04bfc080c49fe5a97b4/src/java/org/apache/cassandra/db/compaction/LeveledCompactionStrategy.java#L109-L157&lt;/a&gt; might work?&lt;/p&gt;

&lt;p&gt;I also really think we need to do what is in my patch above as calculating the expired sstables can take a very long time with many sstables (does not really matter if we loop or not if that method takes minutes to call)&lt;/p&gt;</comment>
                            <comment id="14693607" author="yukim" created="Wed, 12 Aug 2015 14:42:21 +0000"  >&lt;p&gt;Hmm, ok, I see DTCS&apos;s iterating all SSTables takes time. But as Jeremiah pointed out, 10 min of interval seems unoptimized.&lt;/p&gt;

&lt;p&gt;How about we reduce the scope of locking from synchronized method to using read-write lock? It looks like we are just guarding &lt;tt&gt;sstables&lt;/tt&gt; field, we only need it to determine uncompacting SSTables. After that we just unlock the lock and run the heavy loop just fine I guess?&lt;/p&gt;

&lt;p&gt;Edit: We are using compaction strategies through WrappingCompactionStrategy, and it is the root of locking. Other approach may be moving SSTable notifications to other thread so it doesn&apos;t block flushing etc.&lt;/p&gt;</comment>
                            <comment id="14694063" author="JIRAUSER308715" created="Wed, 12 Aug 2015 19:44:29 +0000"  >&lt;p&gt;I think there are two things here to deal with.&lt;/p&gt;

&lt;p&gt;1. A compaction strategy taking a long time in getNextBackgroundTask can block other stuff&lt;br/&gt;
2. That DTCS can take 10s of minutes to finish the getNextBackgroundTask calculation.&lt;/p&gt;

&lt;p&gt;I&apos;ve now seen this happen in a few more clusters running DTCS, one of them C* 2.0.15 based.  So we need to figure something out.  Even if we solve #1 so we don&apos;t mess up the rest of the system, #2 is still a big problem, as DTCS compaction just gets further and further behind when the &quot;time to figure out what to do&quot; gets so big.&lt;/p&gt;</comment>
                            <comment id="14694362" author="yukim" created="Wed, 12 Aug 2015 22:54:06 +0000"  >&lt;p&gt;Besides checking expiring SSTables, &lt;tt&gt;DateTieredCompactionStrategy#getCompactionCandidate&lt;/tt&gt; seems heavyweight also, it iterates over many SSTables to sort, filter, find max timestamp etc.&lt;br/&gt;
Can we do some of those works and cache them when SSTables are added/removed?&lt;/p&gt;</comment>
                            <comment id="14695094" author="krummas" created="Thu, 13 Aug 2015 11:44:55 +0000"  >&lt;p&gt;Been running some experiments with 10k sstables, and the majority of the time (95%+) spent is spent on calculating overlapping sstables for getFullyExpiredSSTables.&lt;/p&gt;

&lt;p&gt;Patch here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/9882-overlapping&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/9882-overlapping&lt;/a&gt; - it does the following;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;break out the looping into non-synchronized methods&lt;/li&gt;
	&lt;li&gt;only check for expired sstables every 10 minutes&lt;/li&gt;
	&lt;li&gt;and the scary part: normalizes the intervals searched in getOverlappingSSTables - if we give getOverlappingSSTables many overlapping sstables to search (which we likely do in the DTCS case), we will reduce the number of times we search the interval tree a lot.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14695451" author="yukim" created="Thu, 13 Aug 2015 16:10:58 +0000"  >&lt;p&gt;Thanks for the patch.&lt;/p&gt;

&lt;p&gt;getOverlappingSSTables change looks good to me. Unit tests are covering every path.&lt;/p&gt;

&lt;p&gt;I suggest:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Let&apos;s not touch synchronized part in this ticket. It is more complicated than what I thought before. I think we need to think about whole WrappingCompactionStrategy/CompactionStrategyManager involving each compaction strategy.&lt;/li&gt;
	&lt;li&gt;Please add comment above 10 min check why we are doing this.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14699092" author="krummas" created="Mon, 17 Aug 2015 07:02:58 +0000"  >&lt;p&gt;ok, committed with a comment and without the synchronized-change&lt;/p&gt;</comment>
                            <comment id="14699112" author="krummas" created="Mon, 17 Aug 2015 07:21:48 +0000"  >&lt;p&gt;missed a dtest failure, reopening to fix&lt;/p&gt;

&lt;p&gt;reason is that we only check for expired every 10 minutes now: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9882-2.2-dtest/lastCompletedBuild/testReport/compaction_test/TestCompaction_with_DateTieredCompactionStrategy/dtcs_deletion_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9882-2.2-dtest/lastCompletedBuild/testReport/compaction_test/TestCompaction_with_DateTieredCompactionStrategy/dtcs_deletion_test/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14699148" author="krummas" created="Mon, 17 Aug 2015 07:58:23 +0000"  >&lt;p&gt;fix here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/9882-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/9882-fix&lt;/a&gt; - adds a compaction parameter for DTCS that sets the check frequency to be able to override it in tests&lt;/p&gt;

&lt;p&gt;dtest fix: &lt;a href=&quot;https://github.com/krummas/cassandra-dtest/commits/marcuse/9882-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra-dtest/commits/marcuse/9882-fix&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14699956" author="yukim" created="Mon, 17 Aug 2015 18:08:02 +0000"  >&lt;p&gt;+1 for fixup.&lt;br/&gt;
Also created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10099&quot; title=&quot;Improve concurrency in CompactionStrategyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10099&quot;&gt;&lt;del&gt;CASSANDRA-10099&lt;/del&gt;&lt;/a&gt; to further discuss concurrency issue.&lt;/p&gt;</comment>
                            <comment id="14700969" author="krummas" created="Tue, 18 Aug 2015 09:03:23 +0000"  >&lt;p&gt;ok, thanks, committed and pull request submitted&lt;/p&gt;</comment>
                            <comment id="14703083" author="JIRAUSER308715" created="Wed, 19 Aug 2015 14:21:27 +0000"  >&lt;p&gt;Should expired_sstable_check_frequency_seconds be added to cqlsh completion?&lt;/p&gt;</comment>
                            <comment id="14703088" author="krummas" created="Wed, 19 Aug 2015 14:24:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;Should expired_sstable_check_frequency_seconds be added to cqlsh completion?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I intentionally left it out as it is something users should never tweak, no strong feelings though, so if you want it in, I can add it&lt;/p&gt;</comment>
                            <comment id="14703090" author="JIRAUSER308715" created="Wed, 19 Aug 2015 14:25:52 +0000"  >&lt;p&gt;nope, just wanted to make sure.&lt;/p&gt;</comment>
                            <comment id="14717602" author="aweisberg" created="Thu, 27 Aug 2015 21:54:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://docs.google.com/document/d/1kccPqxEAoYQpT0gXnp20MYQUDmjOrakAeQhf6vkqjGo/edit#&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Added reference to this to the CVH doc&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2huu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>