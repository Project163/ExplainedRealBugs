<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8808] CQLSSTableWriter: close does not work + more than one table throws ex</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8808</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have encountered the following two issues:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When closing the CQLSSTableWriter it just hangs the process and does nothing. (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8281&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-8281&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;When writing more than one table throws ex. (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8251&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-8251&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These issue can be reproduced with the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;test.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.config.Config;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.io.sstable.CQLSSTableWriter;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
  Config.setClientMode(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

  CQLSSTableWriter w1 = CQLSSTableWriter.builder()
    .inDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/kspc/t1&quot;&lt;/span&gt;)
    .forTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE kspc.t1 ( id  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (id));&quot;&lt;/span&gt;)
    .using(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO kspc.t1 (id) VALUES ( ? );&quot;&lt;/span&gt;)
    .build();

  CQLSSTableWriter w2 = CQLSSTableWriter.builder()
    .inDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/kspc/t2&quot;&lt;/span&gt;)
    .forTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE kspc.t2 ( id  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (id));&quot;&lt;/span&gt;)
    .using(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO kspc.t2 (id) VALUES ( ? );&quot;&lt;/span&gt;)
    .build();

  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    w1.addRow(1);
    w2.addRow(1);
    w1.close();
    w2.close();
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(e);
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;The error&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.ExceptionInInitializerError
        at org.apache.cassandra.db.Keyspace.initCf(Keyspace.java:324)
        at org.apache.cassandra.db.Keyspace.&amp;lt;init&amp;gt;(Keyspace.java:277)
        at org.apache.cassandra.db.Keyspace.open(Keyspace.java:119)
        at org.apache.cassandra.db.Keyspace.open(Keyspace.java:96)
        at org.apache.cassandra.cql3.statements.UpdateStatement.addUpdateForKey(UpdateStatement.java:101)
        at org.apache.cassandra.io.sstable.CQLSSTableWriter.rawAddRow(CQLSSTableWriter.java:226)
        at org.apache.cassandra.io.sstable.CQLSSTableWriter.addRow(CQLSSTableWriter.java:145)
        at org.apache.cassandra.io.sstable.CQLSSTableWriter.addRow(CQLSSTableWriter.java:120)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:606)
        at org.codehaus.groovy.runtime.callsite.PojoMetaMethodSite$PojoCachedMethodSite.invoke(PojoMetaMethodSite.java:189)
        at org.codehaus.groovy.runtime.callsite.PojoMetaMethodSite.call(PojoMetaMethodSite.java:53)
        at org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCall(CallSiteArray.java:45)
        at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:108)
        at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:120)
        at com.allthingsmonitoring.utils.BulkDataLoader.main(BulkDataLoader.groovy:415)
Caused by: java.lang.NullPointerException
        at org.apache.cassandra.config.DatabaseDescriptor.getFlushWriters(DatabaseDescriptor.java:1053)
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;clinit&amp;gt;(ColumnFamilyStore.java:85)
        ... 18 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have just tested the in the cassandra-2.1 branch and the issue still persists.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12775142">CASSANDRA-8808</key>
            <summary>CQLSSTableWriter: close does not work + more than one table throws ex</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="syepes">Sebastian YEPES FERNANDEZ</reporter>
                        <labels>
                            <label>cql</label>
                    </labels>
                <created>Sat, 14 Feb 2015 15:02:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:20 +0000</updated>
                            <resolved>Thu, 5 Mar 2015 17:53:08 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14325072" author="yukim" created="Tue, 17 Feb 2015 22:59:25 +0000"  >&lt;p&gt;I think it is better to eliminate the path that we access Keyspace/ColumnFamilyStore from CQLSSTableWrtier.&lt;br/&gt;
It seems we only use that for secondary index update which we don&apos;t need.&lt;/p&gt;</comment>
                            <comment id="14332151" author="blerer" created="Sun, 22 Feb 2015 12:43:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; Let&apos;s seat together at some point this week and see how we can fix CQLSSTableWriter for good (including: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8572&quot; title=&quot;CQLSSTableWriter shouldn&amp;#39;t trigger cassandra specific initializations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8572&quot;&gt;CASSANDRA-8572&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8251&quot; title=&quot;CQLSSTableWriter.builder() throws ex when more than one table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8251&quot;&gt;&lt;del&gt;CASSANDRA-8251&lt;/del&gt;&lt;/a&gt;) &lt;/p&gt;</comment>
                            <comment id="14346700" author="blerer" created="Wed, 4 Mar 2015 10:35:16 +0000"  >&lt;p&gt;The patch has been build on top of the one of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8251&quot; title=&quot;CQLSSTableWriter.builder() throws ex when more than one table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8251&quot;&gt;&lt;del&gt;CASSANDRA-8251&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The patch use &lt;tt&gt;Config.isClientMode&lt;/tt&gt; to prevent:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;DatabaseDescriptor&lt;/tt&gt; to trigger unecessary threads&lt;/li&gt;
	&lt;li&gt;calls to &lt;tt&gt;Keyspace&lt;/tt&gt; which cause errors due to the uncomplete configuration&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt; must always be used on the client side, &lt;tt&gt;Config.setClientMode(true)&lt;/tt&gt; is called in a static initialization in &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In trunk the client mode had been removed by mistake by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7820&quot; title=&quot;Remove fat client mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7820&quot;&gt;&lt;del&gt;CASSANDRA-7820&lt;/del&gt;&lt;/a&gt;. The patch for trunk re-introduce it.&lt;/p&gt;</comment>
                            <comment id="14348005" author="yukim" created="Thu, 5 Mar 2015 02:26:46 +0000"  >&lt;p&gt;All these patches work as expected. Checked with my bulk loader example (&lt;a href=&quot;https://github.com/yukim/cassandra-bulkload-example/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra-bulkload-example/&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;Couple of suggestions:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think it&apos;d be better to add overloading UpdateStatement#addUpdateForKey that has boolean param for checking secondary index, instead of accessing Config.isClientMode directly.&lt;/li&gt;
	&lt;li&gt;Can you add comment to CQLSSTableWriterClientTest what it&apos;s checking? I guess it&apos;s checking CQLSSTableWriter not throwing any exceptions.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14348722" author="blerer" created="Thu, 5 Mar 2015 13:20:19 +0000"  >&lt;p&gt;The new patches contains the following changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;overload &lt;tt&gt;UpdateStatement.addUpdateForKey&lt;/tt&gt; with a new boolean parameter &lt;tt&gt;validateIndexColumns&lt;/tt&gt; to check if the secondary index validation must be done.&lt;/li&gt;
	&lt;li&gt;add some assertions in {{CQLSSTableWriterClientTest }} to check if the SSTable files have been created.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14349167" author="yukim" created="Thu, 5 Mar 2015 17:53:08 +0000"  >&lt;p&gt;Thanks, +1 and committed.&lt;/p&gt;</comment>
                            <comment id="14354188" author="iamaleksey" created="Tue, 10 Mar 2015 03:02:39 +0000"  >&lt;p&gt;Relabeling as 2.0.14, since it&apos;s not in the currently being tested cassandra-2.0.13 branch (we can cherry-pick it into cassandra-2.0.13 if we decide it&apos;s major enough, just updating JIRA to reflect the current state).&lt;/p&gt;</comment>
                            <comment id="14380046" author="syepes" created="Wed, 25 Mar 2015 15:31:14 +0000"  >&lt;p&gt;Any change this could be included in the  2.1.4 branch?&lt;/p&gt;</comment>
                            <comment id="14383660" author="syepes" created="Fri, 27 Mar 2015 11:00:39 +0000"  >&lt;p&gt;For anyone interested, I have just created a related issue that was introduced in 2.1.3&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9052&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-9052&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12752750">CASSANDRA-8251</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12777609">CASSANDRA-8864</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12786162">CASSANDRA-9052</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12778718">CASSANDRA-8884</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12702812" name="CASSANDRA-8808-2.0-V2.txt" size="15641" author="blerer" created="Thu, 5 Mar 2015 13:20:19 +0000"/>
                            <attachment id="12702437" name="CASSANDRA-8808-2.0.txt" size="13111" author="blerer" created="Wed, 4 Mar 2015 10:35:16 +0000"/>
                            <attachment id="12702813" name="CASSANDRA-8808-2.1-V2.txt" size="15889" author="blerer" created="Thu, 5 Mar 2015 13:20:19 +0000"/>
                            <attachment id="12702438" name="CASSANDRA-8808-2.1.txt" size="13057" author="blerer" created="Wed, 4 Mar 2015 10:35:16 +0000"/>
                            <attachment id="12702817" name="CASSANDRA-8808-trunk-V2.txt" size="19991" author="blerer" created="Thu, 5 Mar 2015 13:39:05 +0000"/>
                            <attachment id="12702439" name="CASSANDRA-8808-trunk.txt" size="18540" author="blerer" created="Wed, 4 Mar 2015 10:35:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25n3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>