<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6892] Cassandra 2.0.x validates Thrift columns incorrectly and causes InvalidRequestException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6892</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I just upgrade my local dev machine to Cassandra 2.0, which causes one of my automated tests to fail now. With the latest 1.2.x it was working fine.&lt;/p&gt;

&lt;p&gt;The Exception I get on my client (using Hector) is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;me.prettyprint.hector.api.exceptions.HInvalidRequestException: InvalidRequestException(why:(Expected 8 or 0 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (21)) [MDS_0][MasterdataIndex][key2] failed validation)
	at me.prettyprint.cassandra.service.ExceptionsTranslatorImpl.translate(ExceptionsTranslatorImpl.java:52)
	at me.prettyprint.cassandra.connection.HConnectionManager.operateWithFailover(HConnectionManager.java:265)
	at me.prettyprint.cassandra.model.ExecutingKeyspace.doExecuteOperation(ExecutingKeyspace.java:113)
	at me.prettyprint.cassandra.model.MutatorImpl.execute(MutatorImpl.java:243)
	at me.prettyprint.cassandra.service.template.AbstractColumnFamilyTemplate.executeBatch(AbstractColumnFamilyTemplate.java:115)
	at me.prettyprint.cassandra.service.template.AbstractColumnFamilyTemplate.executeIfNotBatched(AbstractColumnFamilyTemplate.java:163)
	at me.prettyprint.cassandra.service.template.ColumnFamilyTemplate.update(ColumnFamilyTemplate.java:69)
	at com.mycompany.spring3utils.dataaccess.cassandra.AbstractCassandraDAO.doUpdate(AbstractCassandraDAO.java:482)
	....
Caused by: InvalidRequestException(why:(Expected 8 or 0 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (21)) [MDS_0][MasterdataIndex][key2] failed validation)
	at org.apache.cassandra.thrift.Cassandra$batch_mutate_result.read(Cassandra.java:20833)
	at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:78)
	at org.apache.cassandra.thrift.Cassandra$Client.recv_batch_mutate(Cassandra.java:964)
	at org.apache.cassandra.thrift.Cassandra$Client.batch_mutate(Cassandra.java:950)
	at me.prettyprint.cassandra.model.MutatorImpl$3.execute(MutatorImpl.java:246)
	at me.prettyprint.cassandra.model.MutatorImpl$3.execute(MutatorImpl.java:1)
	at me.prettyprint.cassandra.service.Operation.executeAndSetResult(Operation.java:104)
	at me.prettyprint.cassandra.connection.HConnectionManager.operateWithFailover(HConnectionManager.java:258)
	... 46 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The schema of my column family is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create column family MasterdataIndex with
    compression_options = {sstable_compression:SnappyCompressor, chunk_length_kb:64} and
    comparator = UTF8Type and
    key_validation_class = &lt;span class=&quot;code-quote&quot;&gt;&apos;CompositeType(UTF8Type,LongType)&apos;&lt;/span&gt; and
    default_validation_class = BytesType;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the error message it looks like Cassandra is trying to validate the value with the key-validator! (My value in this case it 21 bytes long)&lt;/p&gt;


&lt;p&gt;I studied the Cassandra 2.0 code and found something wrong. It seems in CFMetaData.addDefaultKeyAliases it passes the KeyValidator into ColumnDefinition.partitionKeyDef. Inside ColumnDefinition the validator is expected to be the value validator!&lt;/p&gt;

&lt;p&gt;In CFMetaData:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;ColumnDefinition&amp;gt; addDefaultKeyAliases(List&amp;lt;ColumnDefinition&amp;gt; pkCols)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; pkCols.size(); i++)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pkCols.get(i) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            {
                &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; idx = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                AbstractType&amp;lt;?&amp;gt; type = keyValidator;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (keyValidator &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CompositeType)
                {
                    idx = i;
                    type = ((CompositeType)keyValidator).types.get(i);
                }
                &lt;span class=&quot;code-comment&quot;&gt;// For compatibility sake, we call the first alias &lt;span class=&quot;code-quote&quot;&gt;&apos;key&apos;&lt;/span&gt; rather than &lt;span class=&quot;code-quote&quot;&gt;&apos;key1&apos;&lt;/span&gt;. This
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// is inconsistent with column alias, but it&apos;s probably not worth risking breaking compatibility now.
&lt;/span&gt;                ByteBuffer name = ByteBufferUtil.bytes(i == 0 ? DEFAULT_KEY_ALIAS : DEFAULT_KEY_ALIAS + (i + 1));
                ColumnDefinition newDef = ColumnDefinition.partitionKeyDef(name, type, idx); &lt;span class=&quot;code-comment&quot;&gt;// type is LongType in my &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, as it uses keyValidator !!!
&lt;/span&gt;                column_metadata.put(newDef.name, newDef);
                pkCols.set(i, newDef);
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pkCols;
    }
...
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; AbstractType&amp;lt;?&amp;gt; getValidator() &lt;span class=&quot;code-comment&quot;&gt;// in ThriftValidation &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is expected to be the value validator!
&lt;/span&gt;    {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; validator;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12702590">CASSANDRA-6892</key>
            <summary>Cassandra 2.0.x validates Thrift columns incorrectly and causes InvalidRequestException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="christianmovi">Christian Spriegel</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Mar 2014 09:33:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:51 +0000</updated>
                            <resolved>Wed, 2 Apr 2014 12:03:03 +0000</resolved>
                                        <fixVersion>2.0.7</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13941557" author="christianmovi" created="Thu, 20 Mar 2014 09:44:20 +0000"  >&lt;p&gt;Edit: The following is not true. It probably makes sense for index-columns.&lt;/p&gt;

&lt;p&gt;I think addDefaultKeyAliases() should use the defaultValidator instead of keyValidator in instanciate the ColumnDefinition. Looks like a copy&amp;amp;paste mistake &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;ColumnDefinition&amp;gt; addDefaultKeyAliases(List&amp;lt;ColumnDefinition&amp;gt; pkCols)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; pkCols.size(); i++)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pkCols.get(i) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            {
                &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; idx = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                AbstractType&amp;lt;?&amp;gt; type = keyValidator;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (keyValidator &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CompositeType)
                {
                    idx = i;
                    type = ((CompositeType)keyValidator).types.get(i);
                }
                &lt;span class=&quot;code-comment&quot;&gt;// For compatibility sake, we call the first alias &lt;span class=&quot;code-quote&quot;&gt;&apos;key&apos;&lt;/span&gt; rather than &lt;span class=&quot;code-quote&quot;&gt;&apos;key1&apos;&lt;/span&gt;. This
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// is inconsistent with column alias, but it&apos;s probably not worth risking breaking compatibility now.
&lt;/span&gt;                ByteBuffer name = ByteBufferUtil.bytes(i == 0 ? DEFAULT_KEY_ALIAS : DEFAULT_KEY_ALIAS + (i + 1));
                ColumnDefinition newDef = ColumnDefinition.partitionKeyDef(name, defaultValidator, idx); &lt;span class=&quot;code-comment&quot;&gt;// SHOULD USE defaultValidator HERE!
&lt;/span&gt;                column_metadata.put(newDef.name, newDef);
                pkCols.set(i, newDef);
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pkCols;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13941559" author="christianmovi" created="Thu, 20 Mar 2014 09:46:22 +0000"  >&lt;p&gt;Attached patch file&lt;/p&gt;</comment>
                            <comment id="13941567" author="christianmovi" created="Thu, 20 Mar 2014 09:52:38 +0000"  >&lt;p&gt;Two questions remain:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Should it even call addDefaultKeyAliases() for my legacy thrift CF?&lt;/li&gt;
	&lt;li&gt;Why did it work for some columns and failed for just some? (my test was able to insert two columns and failed with the third column it was inserting into this row)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13941578" author="christianmovi" created="Thu, 20 Mar 2014 10:03:59 +0000"  >&lt;p&gt;Cancel my patch. It works for me, but I think the real cause is outside of addDefaultKeyAliases().&lt;/p&gt;</comment>
                            <comment id="13942536" author="thobbs" created="Thu, 20 Mar 2014 23:46:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christianmovi&quot; class=&quot;user-hover&quot; rel=&quot;christianmovi&quot;&gt;christianmovi&lt;/a&gt; Is this test running against an existing 1.2 cluster that was upgraded to 2.0?  Or does it start a fresh 2.0 cluster?&lt;/p&gt;</comment>
                            <comment id="13942946" author="christianmovi" created="Fri, 21 Mar 2014 10:22:17 +0000"  >&lt;p&gt;I tried both:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;First I upgraded from C 1.2.15 to 2.0.6.&lt;/li&gt;
	&lt;li&gt;Then I deleted the entire data folder and started with a fresh installation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will try to provide more information on the weekend...&lt;/p&gt;</comment>
                            <comment id="13943315" author="thobbs" created="Fri, 21 Mar 2014 17:59:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christianmovi&quot; class=&quot;user-hover&quot; rel=&quot;christianmovi&quot;&gt;christianmovi&lt;/a&gt; thanks, that would be useful.  So far I didn&apos;t have any luck reproducing.  Just to check, was the schema created with cassandra-cli/thrift or with CQL?&lt;/p&gt;</comment>
                            <comment id="13943457" author="christianmovi" created="Fri, 21 Mar 2014 19:45:41 +0000"  >&lt;p&gt;I think this must be some special case I am stumbling upon. This error does only happen for a single testcase (out of &amp;gt;1100), and there are actually some values in that column family.&lt;/p&gt;

&lt;p&gt;My schema creation is a bit more complicated:&lt;br/&gt;
First create the schema by calling cassandra-cli from inside my unit test. Right after that I modify the schema though Hector/thrift and disable gc-grace for my test-schema:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Cluster cluster = keyspace.getCluster();
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; keyspaceName = keyspace.getKeyspace().getKeyspaceName();
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KeyspaceDefinition keyspaceDefinition = cluster.describeKeyspace(keyspaceName);
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;ColumnFamilyDefinition&amp;gt; cfDefs = keyspaceDefinition.getCfDefs();
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ColumnFamilyDefinition cfDef : cfDefs)
            {
                cfDef.setGcGraceSeconds(0);
                cfDef.setMemtableFlushAfterMins(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
                cfDef.setReadRepairChance(0.0);
                cfDef.setKeyCacheSavePeriodInSeconds(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
                cluster.updateColumnFamily(cfDef);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I could imagine that modifying the schema through thrift breaks/broke the schema for 2.0. &lt;/p&gt;</comment>
                            <comment id="13943544" author="thobbs" created="Fri, 21 Mar 2014 21:08:16 +0000"  >&lt;p&gt;After investigating this a bit with Christian, it turns out the column that was failing the insert was named &quot;key2&quot;, which was one of the key aliases.  I didn&apos;t think that key aliases were supposed to affect validation of Thrift columns, but after looking at some tickets and code, it seems like that may be intentional.  Can anybody confirm that?&lt;/p&gt;</comment>
                            <comment id="13943555" author="christianmovi" created="Fri, 21 Mar 2014 21:12:18 +0000"  >&lt;p&gt;Tyler can reproduce the issue now, but I am posting this anyway &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The thrift-schema:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create column family MasterdataIndex with
    compression_options = {sstable_compression:SnappyCompressor, chunk_length_kb:64} and
    comparator = UTF8Type and
    key_validation_class = &lt;span class=&quot;code-quote&quot;&gt;&apos;CompositeType(UTF8Type,LongType)&apos;&lt;/span&gt; and
    default_validation_class = BytesType;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With the following data:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] list MasterdataIndex ;
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; limit of 100
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; cell limit of 100
-------------------
RowKey: G:1
=&amp;gt; (name=GOOD, value=474f4f44, timestamp=1395434320342000)
-------------------
RowKey: K:1
=&amp;gt; (name=key0, value=160218046b6579301804474f4f4416c29a0c160000, timestamp=1395434320347001)
=&amp;gt; (name=key1, value=160218046b6579311804474f4f4416c49a0c160000, timestamp=1395434320351001)

2 Rows Returned.
Elapsed time: 30 msec(s).
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(and a &quot;key2&quot; which failed to insert)&lt;/p&gt;



&lt;p&gt;results in the following CFMetaData.toString():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.cassandra.config.CFMetaData@54196399[
cfId=1d46d5a5-726e-3610-b08e-ebeca28b6325,ksName=MDS_0,
cfName=MasterdataIndex,
cfType=Standard,
comparator=org.apache.cassandra.db.marshal.UTF8Type,
comment=,readRepairChance=0.1,dclocalReadRepairChance=0.0,replicateOnWrite=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
gcGraceSeconds=864000,
defaultValidator=org.apache.cassandra.db.marshal.BytesType,
keyValidator=org.apache.cassandra.db.marshal.CompositeType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.LongType),minCompactionThreshold=4,maxCompactionThreshold=32,
column_metadata=
{
java.nio.HeapByteBuffer[pos=0 lim=4 cap=4]=ColumnDefinition{name=6b657932, validator=org.apache.cassandra.db.marshal.LongType, type=PARTITION_KEY, componentIndex=1, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}, 
java.nio.HeapByteBuffer[pos=0 lim=3 cap=3]=ColumnDefinition{name=6b6579, validator=org.apache.cassandra.db.marshal.UTF8Type, type=PARTITION_KEY, componentIndex=0, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
},
compactionStrategyClass=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy,compactionStrategyOptions={},compressionOptions={sstable_compression=org.apache.cassandra.io.compress.SnappyCompressor, chunk_length_kb=64},bloomFilterFpChance=&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&amp;gt;,memtable_flush_period_in_ms=0,caching=KEYS_ONLY,defaultTimeToLive=0,speculative_retry=NONE,indexInterval=128,populateIoCacheOnFlush=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,droppedColumns={},triggers={}]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13943557" author="jbellis" created="Fri, 21 Mar 2014 21:12:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;I didn&apos;t think that key aliases were supposed to affect validation of Thrift columns, but after looking at some tickets and code, it seems like that may be intentional. Can anybody confirm that?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Confirmed&lt;/p&gt;</comment>
                            <comment id="13943561" author="thobbs" created="Fri, 21 Mar 2014 21:16:25 +0000"  >&lt;p&gt;Besides doing &lt;tt&gt;ALTER TABLE &amp;lt;table&amp;gt; RENAME key2 TO &amp;lt;new_name&amp;gt;&lt;/tt&gt;, is there another workaround?  (The key aliases don&apos;t show up in the normal column metadata, so I don&apos;t think Thrift clients could drop that.)&lt;/p&gt;</comment>
                            <comment id="13943580" author="christianmovi" created="Fri, 21 Mar 2014 21:23:17 +0000"  >&lt;p&gt;Ok, its easily reproducable with CLI:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] set MasterdataIndex[&lt;span class=&quot;code-quote&quot;&gt;&apos;K:1&apos;&lt;/span&gt;][key0] = 1122112211221122112211221122AAFF11AAFF;
Value inserted.
Elapsed time: 1.08 msec(s).


[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] set MasterdataIndex[&lt;span class=&quot;code-quote&quot;&gt;&apos;K:1&apos;&lt;/span&gt;][key1] = 1122112211221122112211221122AAFF11AAFF;
Value inserted.
Elapsed time: 1.08 msec(s).


[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] set MasterdataIndex[&lt;span class=&quot;code-quote&quot;&gt;&apos;K:1&apos;&lt;/span&gt;][key] = 1122112211221122112211221122AAFF11AAFF;
(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; didn&apos;t validate.) [MDS_0][MasterdataIndex][key] failed validation
InvalidRequestException(why:(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; didn&apos;t validate.) [MDS_0][MasterdataIndex][key] failed validation)
	at org.apache.cassandra.thrift.Cassandra$insert_result.read(Cassandra.java:16640)
	at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:78)
	at org.apache.cassandra.thrift.Cassandra$Client.recv_insert(Cassandra.java:848)
	at org.apache.cassandra.thrift.Cassandra$Client.insert(Cassandra.java:832)
	at org.apache.cassandra.cli.CliClient.executeSet(CliClient.java:982)
	at org.apache.cassandra.cli.CliClient.executeCLIStatement(CliClient.java:225)
	at org.apache.cassandra.cli.CliMain.processStatementInteractive(CliMain.java:213)
	at org.apache.cassandra.cli.CliMain.main(CliMain.java:343)


[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] set MasterdataIndex[&lt;span class=&quot;code-quote&quot;&gt;&apos;K:1&apos;&lt;/span&gt;][key2] = 1122112211221122112211221122AAFF11AAFF;
(Expected 8 or 0 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (19)) [MDS_0][MasterdataIndex][key2] failed validation
InvalidRequestException(why:(Expected 8 or 0 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (19)) [MDS_0][MasterdataIndex][key2] failed validation)
	at org.apache.cassandra.thrift.Cassandra$insert_result.read(Cassandra.java:16640)
	at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:78)
	at org.apache.cassandra.thrift.Cassandra$Client.recv_insert(Cassandra.java:848)
	at org.apache.cassandra.thrift.Cassandra$Client.insert(Cassandra.java:832)
	at org.apache.cassandra.cli.CliClient.executeSet(CliClient.java:982)
	at org.apache.cassandra.cli.CliClient.executeCLIStatement(CliClient.java:225)
	at org.apache.cassandra.cli.CliMain.processStatementInteractive(CliMain.java:213)
	at org.apache.cassandra.cli.CliMain.main(CliMain.java:343)


[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] list MasterdataIndex ;
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; limit of 100
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; cell limit of 100
-------------------
RowKey: K:1
=&amp;gt; (name=key0, value=1122112211221122112211221122aaff11aaff, timestamp=1395437337904000)
=&amp;gt; (name=key1, value=1122112211221122112211221122aaff11aaff, timestamp=1395437341326000)

2 Rows Returned.
Elapsed time: 2.35 msec(s).
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS_0] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13943614" author="thobbs" created="Fri, 21 Mar 2014 21:53:38 +0000"  >&lt;p&gt;Hmm, I&apos;m not convinced this was entirely intentional.  This behavior didn&apos;t exist in 1.2; you could insert a column named &quot;key&quot; with no validation problems.  It looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5125&quot; title=&quot;Support indexes on composite column components (clustered columns)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5125&quot;&gt;&lt;del&gt;CASSANDRA-5125&lt;/del&gt;&lt;/a&gt; started this.  That ticket (and the code changes) don&apos;t directly acknowledge this regression, which makes me think it was accidental.&lt;/p&gt;

&lt;p&gt;In any case, it effectively creates reserved column names for Thrift clients, which is problematic.&lt;/p&gt;</comment>
                            <comment id="13943624" author="jbellis" created="Fri, 21 Mar 2014 22:00:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;The key aliases don&apos;t show up in the normal column metadata&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Now I&apos;m confused, I thought we&apos;re talking about &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;struct CfDef {
...
    28: optional binary key_alias,
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13943630" author="thobbs" created="Fri, 21 Mar 2014 22:06:02 +0000"  >&lt;p&gt;No, I&apos;m referring to the CFMetadata.column_metadata, which affects column validation.  Specifically, CFMetadata.addDefaultKeyAliases() is what adds the key aliases to column_metadata.&lt;/p&gt;</comment>
                            <comment id="13943642" author="christianmovi" created="Fri, 21 Mar 2014 22:13:41 +0000"  >&lt;p&gt;With CQLSH the insert works fine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:MDS&amp;gt; select * from &lt;span class=&quot;code-quote&quot;&gt;&quot;MasterdataIndex&quot;&lt;/span&gt;;

 key | key2 | column1 | value
-----+------+---------+------------------------------------------
   K |    1 |    key1 | 0x1122112211221122112211221122aaff11aaff

cqlsh:MDS&amp;gt; insert into &lt;span class=&quot;code-quote&quot;&gt;&quot;MasterdataIndex&quot;&lt;/span&gt; (key, key2, column1, value) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;K&apos;&lt;/span&gt;,1,&lt;span class=&quot;code-quote&quot;&gt;&apos;key2&apos;&lt;/span&gt;,0x1122112211221122112211221122aaff11aaff);
cqlsh:MDS&amp;gt; select * from &lt;span class=&quot;code-quote&quot;&gt;&quot;MasterdataIndex&quot;&lt;/span&gt;;

 key | key2 | column1 | value
-----+------+---------+------------------------------------------
   K |    1 |    key1 | 0x1122112211221122112211221122aaff11aaff
   K |    1 |    key2 | 0x1122112211221122112211221122aaff11aaff

cqlsh:MDS&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can even list the value afterwards using CLI:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS] list MasterdataIndex;
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; limit of 100
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; cell limit of 100
-------------------
RowKey: K:1
=&amp;gt; (name=key1, value=1122112211221122112211221122aaff11aaff, timestamp=1395439811520000)
=&amp;gt; (name=key2, value=1122112211221122112211221122aaff11aaff, timestamp=1395439922582000)

1 Row Returned.
Elapsed time: 2.02 msec(s).
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@MDS] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13943723" author="christianmovi" created="Fri, 21 Mar 2014 23:34:54 +0000"  >&lt;p&gt;Imho taking the thrift-columname to access column_metadata must be wrong. I think in ThriftValidation.validateColumnData() should not work on CFMetaData.column_metadata, but on regularColumns or regularAndStaticColumns() instead.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;: Do you guys think I am on the right track here?&lt;/p&gt;</comment>
                            <comment id="13949799" author="thobbs" created="Thu, 27 Mar 2014 19:01:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christianmovi&quot; class=&quot;user-hover&quot; rel=&quot;christianmovi&quot;&gt;christianmovi&lt;/a&gt; not quite.  This problem runs deeper than just Thrift validation.  It looks like it may also affect compaction, cleanup, scrub, sstable2json/json2sstable, although I haven&apos;t written any tests to verify that yet.  It also looks like column aliases and the value alias may have a similar effect, though it&apos;s less clear to me what cases they could have an effect on.&lt;/p&gt;</comment>
                            <comment id="13951038" author="thobbs" created="Fri, 28 Mar 2014 16:57:25 +0000"  >&lt;p&gt;Attached patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-6892&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) ensures that key aliases and column aliases aren&apos;t used improperly for validation.&lt;/p&gt;

&lt;p&gt;Primarily this affects inserts through Thrift.  If data was inserted pre-2.0 with a key alias for the column name, sstable2json/json2sstable and scrub could also be affected.  (I say pre-2.0 because post-2.0, that data would have (erroneously) failed validation on insert.)&lt;/p&gt;

&lt;p&gt;I didn&apos;t look simple (or necessarily correct) to remove the aliases from CFMetaData.column_metadata, so I added methods to get the ColumnDefinition or validator for columns &lt;em&gt;outside&lt;/em&gt; of cql3.  I&apos;m not perfectly happy with this; if anybody can think of a better way to enforce the correct behavior, I would appreciate it.&lt;/p&gt;</comment>
                            <comment id="13954862" author="christianmovi" created="Sun, 30 Mar 2014 23:05:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;: I ran my tests with your patch. Works fine for me.&lt;/p&gt;</comment>
                            <comment id="13955305" author="slebresne" created="Mon, 31 Mar 2014 15:38:10 +0000"  >&lt;p&gt;The fact that a default alias could conflict with a column name introduced through thrift is definitively not on purpose. And in fact, this is not really just limited to default aliases since with a compact table with 1 clustering column, you currently cannot add a value for that clustering column if it conflicts with any of the CQL column names (which don&apos;t have to be &quot;default&quot; aliases in particular). Or rather, CQL will let you insert it, but if you scrub later, it will tell you the data is invalid which is bogus.&lt;/p&gt;

&lt;p&gt;All this to say that this is not really entirely thrift related, and is really a bug in getColumnDefinitionFromColumnName (and that&apos;s what we should fix). This method should never return a definition that is not a REGULAR or STATIC one, since that&apos;s the only 2 cases where a column definition is &quot;stored&quot; inside an internal column/cell name.  That, plus the fact that getValueValidator() should always use getColumnDefinitionFromColumnName, since it&apos;s really only ever used when dealing with cell names. So anyway, attaching a v2 that does those modifications: it fixes getColumnDefinitionFromColumnName and fix getValueValidator to use it (renaming it to getValueValidatorFromColumnName for consistency sake). Also remove Schema.getValueValidator as it is a really unecessary (but that&apos;s more of a nit). The patch does include the unit tests from the first patch and adds a new one for the &apos;compact table with clustering column&apos; case I describe above.&lt;/p&gt;</comment>
                            <comment id="13955927" author="christianmovi" created="Tue, 1 Apr 2014 00:16:04 +0000"  >&lt;p&gt;I ran my tests again with the second patch. Again no errors.&lt;/p&gt;</comment>
                            <comment id="13957001" author="thobbs" created="Tue, 1 Apr 2014 20:55:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; thanks, your approach is nice.&lt;/p&gt;

&lt;p&gt;I have a few nits about your patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Most of the methods in ScrubTest.java are accidentally commented out.&lt;/li&gt;
	&lt;li&gt;Try to add javadocs for methods instead of normal comments (e.g. &lt;tt&gt;ColumnDefinition.isPartOfCellName()&lt;/tt&gt;).  I know you use vim, but it&apos;s helpful with IDEs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;Column.validateFields()&lt;/tt&gt;, the cfdef variable is unused.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other than that, +1&lt;/p&gt;</comment>
                            <comment id="13957573" author="slebresne" created="Wed, 2 Apr 2014 12:03:03 +0000"  >&lt;p&gt;Committed (with nits fixed), thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12637864" name="6892-2.0-v2.txt" size="47587" author="slebresne" created="Mon, 31 Mar 2014 15:45:41 +0000"/>
                            <attachment id="12637449" name="6892-2.0.txt" size="23942" author="thobbs" created="Fri, 28 Mar 2014 16:57:25 +0000"/>
                            <attachment id="12635759" name="CASSANDRA-6892_V1.patch" size="969" author="christianmovi" created="Thu, 20 Mar 2014 09:46:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380929</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tmrr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381208</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326170">2.0.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>