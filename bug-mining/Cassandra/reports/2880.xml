<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7372] Exception when querying a composite-keyed table with a collection index</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7372</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Given the following schema:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  
CREATE TABLE products (
      account text,
      id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
      categories set&amp;lt;text&amp;gt;,
      PRIMARY KEY (account, id)
);

CREATE INDEX cat_index ON products(categories);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;  

&lt;p&gt;The following query fails with an exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM products WHERE account = &lt;span class=&quot;code-quote&quot;&gt;&apos;xyz&apos;&lt;/span&gt; AND categories CONTAINS &lt;span class=&quot;code-quote&quot;&gt;&apos;lmn&apos;&lt;/span&gt;;
errors={}, last_host=127.0.0.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The exception in cassandra&apos;s log is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  17:01:49 Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-2,5,main]: {}
java.lang.RuntimeException: java.lang.IndexOutOfBoundsException
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2015) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_25]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:162) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:103) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:724) ~[na:1.7.0_25]
Caused by: java.lang.IndexOutOfBoundsException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.db.composites.Composites$EmptyComposite.get(Composites.java:60) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.index.composites.CompositesIndexOnCollectionKey.makeIndexColumnPrefix(CompositesIndexOnCollectionKey.java:78) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.index.composites.CompositesSearcher.makePrefix(CompositesSearcher.java:82) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.index.composites.CompositesSearcher.getIndexedIterator(CompositesSearcher.java:116) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.index.composites.CompositesSearcher.search(CompositesSearcher.java:68) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.index.SecondaryIndexManager.search(SecondaryIndexManager.java:589) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.ColumnFamilyStore.search(ColumnFamilyStore.java:2060) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.db.RangeSliceCommand.executeLocally(RangeSliceCommand.java:131) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.service.StorageProxy$LocalRangeSliceRunnable.runMayThrow(StorageProxy.java:1368) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2011) ~[apache-cassandra-2.1.0-rc1.jar:2.1.0-rc1]
	... 4 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following query however works&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM products WHERE categories CONTAINS &lt;span class=&quot;code-quote&quot;&gt;&apos;lmn&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12720148">CASSANDRA-7372</key>
            <summary>Exception when querying a composite-keyed table with a collection index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mishail">Mikhail Stepura</assignee>
                                    <reporter username="ghais">Ghais Issa</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Jun 2014 17:05:13 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:43 +0000</updated>
                            <resolved>Thu, 12 Jun 2014 18:12:47 +0000</resolved>
                                        <fixVersion>2.1 rc2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14025708" author="mishail" created="Mon, 9 Jun 2014 20:40:54 +0000"  >&lt;p&gt;Patch to handle an empty composite in &lt;tt&gt;CompositesIndexOnCollectionKey.makeIndexColumnPrefix()&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14026201" author="slebresne" created="Tue, 10 Jun 2014 07:24:40 +0000"  >&lt;p&gt;Why do we end up with an empty composite there? That feels wrong and so I&apos;m not sure  creating an index entry for it is the right fix. Will look more closely when I&apos;m not on a phone.&lt;/p&gt;</comment>
                            <comment id="14027114" author="mishail" created="Tue, 10 Jun 2014 22:08:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why do we end up with an empty composite there?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well, we have no &lt;tt&gt;columnRestrictions&lt;/tt&gt; (in SelectStatement) in that case, so &lt;tt&gt;CompositesSearcher.makePrefix()&lt;/tt&gt; has to deal with &lt;tt&gt;SliceQueryFilter(EMPTY, EMPTY)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;makePrefix&lt;/tt&gt; handles only the situation where &lt;tt&gt;key&lt;/tt&gt; is empty, returning an empty composite, and dtests cover exactly this use-case (no restriction on a partition key) : &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/blob/master/cql_tests.py#L3521&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/blob/master/cql_tests.py#L3521&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;//1. works because CompositesSearcher.makePrefix handles the empty key. This is covered by dtests
&lt;/span&gt;SELECT * FROM products WHERE categories CONTAINS &lt;span class=&quot;code-quote&quot;&gt;&apos;lmn&apos;&lt;/span&gt;;

&lt;span class=&quot;code-comment&quot;&gt;//2. IndexOutOfBoundsException. Fails to create the startPrefix at CompositesSearcher.getIndexedIterator
&lt;/span&gt;SELECT * FROM products WHERE account = &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; AND categories CONTAINS &lt;span class=&quot;code-quote&quot;&gt;&apos;lmn&apos;&lt;/span&gt;;

&lt;span class=&quot;code-comment&quot;&gt;//3. IndexOutOfBoundsException. Fails to create the endPrefix at CompositesSearcher.getIndexedIterator
&lt;/span&gt;SELECT * FROM products WHERE account = &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; AND id &amp;gt; 6 AND categories CONTAINS &lt;span class=&quot;code-quote&quot;&gt;&apos;lmn&apos;&lt;/span&gt;;

&lt;span class=&quot;code-comment&quot;&gt;//4. Works fine
&lt;/span&gt;SELECT * FROM products WHERE account = &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; AND id &amp;gt; 6 AND id &amp;lt; 1000 AND categories CONTAINS &lt;span class=&quot;code-quote&quot;&gt;&apos;lmn&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14027377" author="mishail" created="Wed, 11 Jun 2014 03:47:17 +0000"  >&lt;p&gt;Attaching v3 of the patch with changes for &lt;tt&gt;CompositesSearcher.makePrefix&lt;/tt&gt; only&lt;/p&gt;</comment>
                            <comment id="14029418" author="slebresne" created="Thu, 12 Jun 2014 17:07:34 +0000"  >&lt;p&gt;+1 on v3.&lt;/p&gt;

&lt;p&gt;Minor code style nit: we generally prefer avoiding a negation in a &lt;tt&gt;if&lt;/tt&gt; if there is a &lt;tt&gt;else&lt;/tt&gt;. I&apos;d also save some characters by using &lt;tt&gt;prefix = columnName.isEmpty() ? ... : ...;&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14029536" author="mishail" created="Thu, 12 Jun 2014 18:12:47 +0000"  >&lt;p&gt;Committed with both nits fixed&lt;/p&gt;</comment>
                            <comment id="14029750" author="jkrupan" created="Thu, 12 Jun 2014 20:24:26 +0000"  >&lt;p&gt;(Nit: The description says &quot;composite-keyed table&quot;, but the example is for a &quot;compound key&quot;.)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12720812">CASSANDRA-7383</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12649737" name="CASSANDRA-2.1-7372-v3.patch" size="5320" author="mishail" created="Wed, 11 Jun 2014 03:47:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mishail]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398347</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wkx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398474</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326658">2.1 rc1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326658">2.1 rc1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>