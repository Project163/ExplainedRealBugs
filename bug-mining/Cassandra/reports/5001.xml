<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14080] Handle incompletely written hint descriptors during startup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14080</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Continuation of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12728&quot; title=&quot;Handling partially written hint files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12728&quot;&gt;&lt;del&gt;CASSANDRA-12728&lt;/del&gt;&lt;/a&gt; bug.&lt;/p&gt;

&lt;p&gt;Problem: Cassandra didn&apos;t start due to 0 size hints files&lt;/p&gt;

&lt;p&gt;Log form v3.0.14:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [main] 2017-11-28 19:10:13,554 StorageService.java:575 - Cassandra version: 3.0.14
INFO  [main] 2017-11-28 19:10:13,555 StorageService.java:576 - Thrift API version: 20.1.0
INFO  [main] 2017-11-28 19:10:13,555 StorageService.java:577 - CQL supported versions: 3.4.0 (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: 3.4.0)
ERROR [main] 2017-11-28 19:10:13,592 CassandraDaemon.java:710 - Exception encountered during startup
org.apache.cassandra.io.FSReadError: java.io.EOFException
        at org.apache.cassandra.hints.HintsDescriptor.readFromFile(HintsDescriptor.java:142) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193) ~[na:1.8.0_141]
        at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175) ~[na:1.8.0_141]
        at java.util.Iterator.forEachRemaining(Iterator.java:116) ~[na:1.8.0_141]
        at java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801) ~[na:1.8.0_141]
        at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:481) ~[na:1.8.0_141]
        at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:471) ~[na:1.8.0_141]
        at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708) ~[na:1.8.0_141]
        at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) ~[na:1.8.0_141]
        at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:499) ~[na:1.8.0_141]
        at org.apache.cassandra.hints.HintsCatalog.load(HintsCatalog.java:65) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.hints.HintsService.&amp;lt;init&amp;gt;(HintsService.java:88) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.hints.HintsService.&amp;lt;clinit&amp;gt;(HintsService.java:63) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.service.StorageProxy.&amp;lt;clinit&amp;gt;(StorageProxy.java:121) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method) ~[na:1.8.0_141]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:264) ~[na:1.8.0_141]
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:585) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:570) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:346) [apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:569) [apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:697) [apache-cassandra-3.0.14.jar:3.0.14]
Caused by: java.io.EOFException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at java.io.RandomAccessFile.readInt(RandomAccessFile.java:803) ~[na:1.8.0_141]
        at org.apache.cassandra.hints.HintsDescriptor.deserialize(HintsDescriptor.java:237) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.hints.HintsDescriptor.readFromFile(HintsDescriptor.java:138) ~[apache-cassandra-3.0.14.jar:3.0.14]
        ... 20 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;p&gt;After several 0 size hints files deletion Cassandra started successfully.&lt;/p&gt;

&lt;p&gt;Jeff Jirsa added a comment - Yesterday&lt;br/&gt;
Aleksandr Ivanov can you open a new JIRA and link it back to this one? It&apos;s possible that the original patch didn&apos;t consider 0 byte files (I don&apos;t have time to go back and look at the commit, and it was long enough ago that I&apos;ve forgotten) - were all of your files 0 bytes?&lt;/p&gt;

&lt;p&gt;Not all, 8..10 hints files were with 0 size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13121897">CASSANDRA-14080</key>
            <summary>Handle incompletely written hint descriptors during startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alourie">Alex Lourie</assignee>
                                    <reporter username="alekiv">Aleksandr Ivanov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Nov 2017 12:06:13 +0000</created>
                <updated>Tue, 7 Mar 2023 11:52:23 +0000</updated>
                            <resolved>Thu, 29 Mar 2018 13:05:16 +0000</resolved>
                                        <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Hints</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16272582" author="iamaleksey" created="Thu, 30 Nov 2017 12:10:22 +0000"  >&lt;p&gt;There has been a resolved JIRA some time ago to not write out empty hints files - don&apos;t have the number handy, but try searching for it.&lt;/p&gt;</comment>
                            <comment id="16272591" author="alekiv" created="Thu, 30 Nov 2017 12:19:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;, this particular report is about handling empty hints files during Cassandra start. Seems currently this situation is not handled properly.&lt;/p&gt;</comment>
                            <comment id="16272592" author="iamaleksey" created="Thu, 30 Nov 2017 12:21:52 +0000"  >&lt;p&gt;Sorry. I don&apos;t mean that you shouldn&apos;t file/have filed this JIRA. Just saying that the similar one we closed recenlty-ish might have some useful context, so you might want to look it up and link to this one.&lt;/p&gt;</comment>
                            <comment id="16273111" author="jjirsa" created="Thu, 30 Nov 2017 18:22:59 +0000"  >&lt;p&gt;Probably: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13740&quot; title=&quot;Orphan hint file gets created while node is being removed from cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13740&quot;&gt;&lt;del&gt;CASSANDRA-13740&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16276232" author="alourie" created="Mon, 4 Dec 2017 02:48:12 +0000"  >&lt;p&gt;A patch for trunk is in &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...alourie:CASSANDRA-14080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...alourie:CASSANDRA-14080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16276671" author="iamaleksey" created="Mon, 4 Dec 2017 11:56:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; Nope. Talking about a JIRA specifically about writing out empty hint buffers into empty files.&lt;/p&gt;

&lt;p&gt;That would do it - although I&apos;d prefer to just slap a second filter call instead of combining the two here.&lt;/p&gt;

&lt;p&gt;What I&apos;d prefer even more is if we looked into why an empty hint file gets written in the first place and taking care of it. Which would have the added benefit of not having confusing empty files around.&lt;/p&gt;</comment>
                            <comment id="16276672" author="iamaleksey" created="Mon, 4 Dec 2017 11:58:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11090&quot; title=&quot;Avoid creating empty hint files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11090&quot;&gt;&lt;del&gt;CASSANDRA-11090&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://github.com/apache/cassandra/commit/1f626087c8819b75f17fcbe757603fc0026d3cc1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/1f626087c8819b75f17fcbe757603fc0026d3cc1&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="16277796" author="alourie" created="Tue, 5 Dec 2017 00:16:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; That should prevent empty hint files to be written as much as C* is concerned. The problem is that we have no way to reproduce creation of the empty hint files and for all we know these hint files could have been created from external circumstances such as corrupt disks. We should still handle 0 length files but this isn&apos;t a ticket for a long drawn out investigation with possibly no results.&lt;/p&gt;</comment>
                            <comment id="16278491" author="iamaleksey" created="Tue, 5 Dec 2017 12:50:37 +0000"  >&lt;p&gt;If that&apos;s the intent, then maybe we should probably generalize it beyond handling empty files? As that&apos;s just one of many possible manifestations of corruption.&lt;/p&gt;</comment>
                            <comment id="16281313" author="alourie" created="Thu, 7 Dec 2017 04:19:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; Would you mind elaborating, please, which other manifestations of corruption you have in mind? I thought crc32 checks are supposed to cover those other cases.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16289283" author="iamaleksey" created="Wed, 13 Dec 2017 13:55:43 +0000"  >&lt;p&gt;Having any incomplete header, perhaps? For the purposes of this ticket, does it matter if the file has size 0 or size 1?&lt;/p&gt;</comment>
                            <comment id="16295098" author="alourie" created="Mon, 18 Dec 2017 15:05:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I was under the impression that CRC check would handle that.&lt;br/&gt;
I had a look at the deserialization code that does the CRC check, and the problem is that &lt;em&gt;any&lt;/em&gt; CRC check error (including incomplete header or file size 0) will end up as an FSError, which will cause C* to fail on start. So I&apos;ve reworked a patch from just checking the size to be &amp;gt; 0 to ignoring the corrupted files instead (including one of size 0). Would that be a better solution for the types of issues you were thinking about?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16348176" author="alourie" created="Thu, 1 Feb 2018 08:19:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; it would be great if you could give a feedback on the&#160;previous comment. Thanks!&lt;/p&gt;</comment>
                            <comment id="16415011" author="alourie" created="Tue, 27 Mar 2018 04:42:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&#160;I would appreciate if you could have a look at this. Thanks!&lt;/p&gt;</comment>
                            <comment id="16418872" author="iamaleksey" created="Thu, 29 Mar 2018 12:09:21 +0000"  >&lt;p&gt;The logic is sound. Let me have a look and commit.&lt;/p&gt;</comment>
                            <comment id="16418908" author="iamaleksey" created="Thu, 29 Mar 2018 12:36:25 +0000"  >&lt;p&gt;So, arguably the original code was written somewhat lazily (by me).&lt;/p&gt;

&lt;p&gt;Swallowing any IOException there and re-trhowing as an FSError, while making the code slightly simpler - by avoiding the need to handle IOException properly elsewhere - was too blunt.&lt;/p&gt;

&lt;p&gt;We should still throw the FSError on checksum mismatches - but not in other scenarios. I&apos;ll expand a bit, on top of your patch, to differentiate between these two different exceptions.&lt;/p&gt;</comment>
                            <comment id="16418960" author="iamaleksey" created="Thu, 29 Mar 2018 13:03:52 +0000"  >&lt;p&gt;Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/68079e4b2ed4e58dbede70af45414b3d4214e195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;68079e4b2ed4e58dbede70af45414b3d4214e195&lt;/a&gt;&#160;and merged up with 3.11 and trunk, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13008389">CASSANDRA-12728</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12934880">CASSANDRA-11090</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[alourie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nduf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12340362">3.0.14</customfieldvalue>
    <customfieldvalue id="12351720">5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>