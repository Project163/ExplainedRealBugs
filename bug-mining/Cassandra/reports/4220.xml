<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11513] Result set is not unique on primary key (cql)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11513</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;cqlsh 5.0.1 | Cassandra 3.4 | CQL spec 3.4.0 | Native protocol v4&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Run followings,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;drop table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists test0;
CREATE TABLE test0 (
    pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    b text,
    s text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
    PRIMARY KEY (pk, a)
);

insert into test0 (pk,a,b,s) values (0,1,&lt;span class=&quot;code-quote&quot;&gt;&apos;b1&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;hello b1&apos;&lt;/span&gt;);
insert into test0 (pk,a,b,s) values (0,2,&lt;span class=&quot;code-quote&quot;&gt;&apos;b2&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;hello b2&apos;&lt;/span&gt;);
insert into test0 (pk,a,b,s) values (0,3,&lt;span class=&quot;code-quote&quot;&gt;&apos;b3&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;hello b3&apos;&lt;/span&gt;);
create index on test0 (b);
insert into test0 (pk,a,b,s) values (0,2,&lt;span class=&quot;code-quote&quot;&gt;&apos;b2 again&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;b2 again&apos;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now select one record based on primary key, we got all three records.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:ops&amp;gt; select * from test0 where pk=0 and a=2;

 pk | a | s        | b
----+---+----------+----------
  0 | 1 | b2 again |       b1
  0 | 2 | b2 again | b2 again
  0 | 3 | b2 again |       b3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:ops&amp;gt; desc test0;

CREATE TABLE ops.test0 (
    pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    b text,
    s text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
    PRIMARY KEY (pk, a)
) WITH CLUSTERING ORDER BY (a ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = {&lt;span class=&quot;code-quote&quot;&gt;&apos;keys&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;ALL&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;rows_per_partition&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NONE&apos;&lt;/span&gt;}
    AND comment = &apos;&apos;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;min_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;}
    AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;chunk_length_in_kb&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;64&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;&lt;/span&gt;}
    AND crc_check_chance = 1.0
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99PERCENTILE&apos;&lt;/span&gt;;
CREATE INDEX test0_b_idx ON ops.test0 (b);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12956572">CASSANDRA-11513</key>
            <summary>Result set is not unique on primary key (cql)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkni">Joel Knighton</assignee>
                                    <reporter username="postgres">Tianshi Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Apr 2016 17:47:45 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:37 +0000</updated>
                            <resolved>Mon, 18 Apr 2016 13:22:12 +0000</resolved>
                                        <fixVersion>3.6</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15229241" author="jkni" created="Wed, 6 Apr 2016 22:13:21 +0000"  >&lt;p&gt;I bisected this, and it looks like this problem was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9986&quot; title=&quot;Remove SliceableUnfilteredRowIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9986&quot;&gt;&lt;del&gt;CASSANDRA-9986&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15229605" author="jkni" created="Thu, 7 Apr 2016 03:28:57 +0000"  >&lt;p&gt;I looked into this because it looked interesting. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9986&quot; title=&quot;Remove SliceableUnfilteredRowIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9986&quot;&gt;&lt;del&gt;CASSANDRA-9986&lt;/del&gt;&lt;/a&gt; removed the SliceableUnfilteredRowIterator. In &lt;tt&gt;SinglePartitionReadCommand.queryMemtablesAndSSTablesInTimestampOrder&lt;/tt&gt; and also &lt;tt&gt;queryMemtablesAndDiskInternal&lt;/tt&gt;, it switched from using &lt;tt&gt;ClusteringIndexFilter.filter&lt;/tt&gt; to &lt;tt&gt;filter.getSlices&lt;/tt&gt; and handing these slices to sstable.iterator. This caused the problem.&lt;/p&gt;

&lt;p&gt;Before, if after reduceFilter we still needed to find a static and we had no clustering, the filter would make no attempt to read farther than the static row. Now, if clustering is empty, we produce no slices in &lt;tt&gt;getSlices&lt;/tt&gt;, and so when the sstable gets an iterator, it never sets a slice for the reader and instead reads the whole partition. It seems to me that AbstractSSTableIterator doesn&apos;t correctly handle the case of empty slices in general and that we can reproduce this with a condition like &lt;tt&gt;a &amp;gt; 7 AND a &amp;lt; 5&lt;/tt&gt;. I also think that the index was unrelated and only caused a flush to disk.&lt;/p&gt;

&lt;p&gt;(There&apos;s probably some imprecision here, but that should get someone most of the way there.)&lt;/p&gt;</comment>
                            <comment id="15229867" author="slebresne" created="Thu, 7 Apr 2016 08:03:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;It seems to me that AbstractSSTableIterator doesn&apos;t correctly handle the case of empty slices in general&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed. Do you want to give a shot at a patch?&lt;/p&gt;</comment>
                            <comment id="15230417" author="postgres" created="Thu, 7 Apr 2016 15:37:54 +0000"  >&lt;p&gt;Cassandra community is awesome! Should buy you a beer, Joel.&lt;/p&gt;</comment>
                            <comment id="15234265" author="jkni" created="Sun, 10 Apr 2016 19:36:04 +0000"  >&lt;p&gt;I&apos;ve uploaded a small patch that adds a NoRowsReader (analogous to the noRowsIterator used in the memtable case) as well as tests covering when slices is empty. This is the most elegant and least invasive solution I could find, but I&apos;m pretty unfamiliar with this part of the codebase, so any alternatives suggestion would be appreciated.&lt;/p&gt;

&lt;p&gt;CI looks clean relative to upstream.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/11513-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11513-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-11513-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-11513-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15245646" author="slebresne" created="Mon, 18 Apr 2016 13:22:12 +0000"  >&lt;p&gt;Lgtm, +1. Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12960334">CASSANDRA-11619</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12978647">CASSANDRA-12003</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jkni]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vqfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334622">3.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>