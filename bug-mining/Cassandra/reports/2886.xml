<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7401] Memtable.maybeUpdateLiveRatio goes into an endless loop when currentOperations is zero</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7401</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I was describing an error the other day on the mailing list, where the MemoryMeter would go into an endless loop. This happened multiple times last week, unfortunetaly I cannot reproduce it at the moment.&lt;/p&gt;

&lt;p&gt;The whole cassandra server got unresponsive and logged about 7000k messages per second into the log:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;...&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;MemoryMeter:1&amp;#93;&lt;/span&gt; 2014-06-14 19:24:09,488 Memtable.java (line 481) CFS(Keyspace=&apos;MDS&apos;, ColumnFamily=&apos;ResponsePortal&apos;) liveRatio is 64.0 (just-counted was 64.0).  calculation took 0ms for 0 cells&lt;br/&gt;
...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The cause for this seems to be Memtable.maybeUpdateLiveRatio(), which cannot handle currentOperations (and liveRatioComputedAt) to be zero. The loop will iterate endlessly:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            ...
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (operations &amp;lt; 2 * last) &lt;span class=&quot;code-comment&quot;&gt;// does never &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt; when zero: 0 &amp;lt; 0 is not &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One thing I cannot explain: How can the operationcount be zero when maybeUpdateLiveRatio() gets called?&lt;/p&gt;

&lt;p&gt;is it possible that addAndGet in resolve() increases by 0  in some cases?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;currentOperations.addAndGet(cf.getColumnCount() + (cf.isMarkedForDelete() ? 1 : 0) + cf.deletionInfo().rangeCount()); &lt;span class=&quot;code-comment&quot;&gt;// can &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; be zero? &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nevertheless, the attached patch fixes the endless loop. Feel free to reassign this ticket or create a followup ticket if currentOperations should not be zero.&lt;/p&gt;

&lt;p&gt;kind regards,&lt;br/&gt;
Christian&lt;/p&gt;</description>
                <environment></environment>
        <key id="12721373">CASSANDRA-7401</key>
            <summary>Memtable.maybeUpdateLiveRatio goes into an endless loop when currentOperations is zero</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="christianmovi">Christian Spriegel</assignee>
                                    <reporter username="christianmovi">Christian Spriegel</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jun 2014 09:58:43 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:42 +0000</updated>
                            <resolved>Wed, 18 Jun 2014 01:12:11 +0000</resolved>
                                        <fixVersion>2.0.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14033894" author="christianmovi" created="Tue, 17 Jun 2014 15:10:43 +0000"  >&lt;p&gt;Tonight, one of our servers was hanging again.&lt;/p&gt;

&lt;p&gt;I now deployed a custom-cassandra with the patch on our systems. I will report if it still happens...&lt;/p&gt;</comment>
                            <comment id="14034029" author="jbellis" created="Tue, 17 Jun 2014 16:49:47 +0000"  >&lt;p&gt;Looks related to the &quot;start new memtable w/ the old memtable&apos;s liveRatio&quot; thing we were talking about.&lt;/p&gt;</comment>
                            <comment id="14034693" author="iamaleksey" created="Wed, 18 Jun 2014 01:09:40 +0000"  >&lt;p&gt;Committed in 9afc2097ef8e806b9916e623815202b0f43d1cfc (&lt;a href=&quot;https://github.com/apache/cassandra/commit/9afc2097ef8e806b9916e623815202b0f43d1cfc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/9afc2097ef8e806b9916e623815202b0f43d1cfc&lt;/a&gt;) (replaced &amp;lt; with &amp;lt;=).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Looks related to the &quot;start new memtable w/ the old memtable&apos;s liveRatio&quot; thing we were talking about.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s not, at least directly it isn&apos;t.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;is it possible that addAndGet in resolve() increases by 0 in some cases?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Apparently yes, it is - when the CF has no cells in it, no range tombstones, and isn&apos;t top-level marked for deletion.&lt;br/&gt;
I have NO idea where that CF originated from, and don&apos;t even know where to start looking. If you find out - let us know.&lt;/p&gt;</comment>
                            <comment id="14035104" author="christianmovi" created="Wed, 18 Jun 2014 08:12:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;: Thanks!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Apparently yes, it is - when the CF has no cells in it, no range tombstones, and isn&apos;t top-level marked for deletion.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That is what I got from the code too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I have NO idea where that CF originated from, and don&apos;t even know where to start looking. If you find out - let us know.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I also was not able to figure this out. If I do, I will let you know.&lt;/p&gt;
</comment>
                            <comment id="14060404" author="christianmovi" created="Mon, 14 Jul 2014 07:34:07 +0000"  >&lt;p&gt;I just found my log message in our logfiles (where my custom-build is running):&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:43&amp;#93;&lt;/span&gt; 2014-07-13 18:06:11,365 Memtable.java (line 184) TEST - This would be a crash: Memtable-ResponsePortal@908155793(0/0 serialized/live bytes, 0 ops)&lt;/p&gt;

&lt;p&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:46&amp;#93;&lt;/span&gt; 2014-07-13 18:06:11,365 Memtable.java (line 184) TEST - This would be a crash: Memtable-ResponsePortal@908155793(0/0 serialized/live bytes, 0 ops)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It shows that the Memtable can be empty. Why that is, I have no idea.&lt;/p&gt;

&lt;p&gt;Nevertheless, the fix works.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12650536" name="MemtableFixV1.patch" size="604" author="christianmovi" created="Mon, 16 Jun 2014 09:59:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[christianmovi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399569</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 19 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ws9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399678</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326712">2.0.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>