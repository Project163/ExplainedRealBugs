<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4150] Allow larger cache capacities than 2GB</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4150</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The problem is that capacity is a Integer which can maximum hold 2 GB,&lt;br/&gt;
I will post a fix to CLHM in the mean time we might want to remove the maximumWeightedCapacity code path (atleast for Serializing cache) and implement it in our code.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12550874">CASSANDRA-4150</key>
            <summary>Allow larger cache capacities than 2GB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vijay2win@yahoo.com">Vijay</assignee>
                                    <reporter username="vijay2win@yahoo.com">Vijay</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Apr 2012 20:08:54 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:35 +0000</updated>
                            <resolved>Thu, 7 Jun 2012 04:26:46 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13253718" author="vijay2win@yahoo.com" created="Fri, 13 Apr 2012 20:30:59 +0000"  >&lt;p&gt;issue: &lt;a href=&quot;http://code.google.com/p/concurrentlinkedhashmap/issues/detail?id=33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://code.google.com/p/concurrentlinkedhashmap/issues/detail?id=33&lt;/a&gt; created.&lt;/p&gt;</comment>
                            <comment id="13254190" author="vijay2win@yahoo.com" created="Sat, 14 Apr 2012 20:17:50 +0000"  >&lt;p&gt;For the records the comments from issue in CLHM library:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I think a long capacity is fine, but I&apos;m not actively working on a next release to roll this into soon. If this is critical than it could be a patch release. You are of course welcome to fork if neither of those options are okay.&lt;/p&gt;

&lt;p&gt;I helped my former colleagues at Google with Guava&apos;s CacheBuilder (formerly MapMaker), which could be considered the successor to this project. There the maximum weight is a long.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;IRC: Guava doesnt support descendingKeySetWithLimit&lt;br/&gt;
Possibly fork the CLHM code into Cassandra code base or drop the hotkey&apos;s method and use guava (Thats the only limitation which i see for now).&lt;/p&gt;</comment>
                            <comment id="13270979" author="vijay2win@yahoo.com" created="Wed, 9 May 2012 00:40:29 +0000"  >&lt;p&gt;CLHM (Ben) fixed the issue:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Fixed in v1.3. I plan on releasing this tonight.&lt;/p&gt;

&lt;p&gt;Also introduced EntryWeigher&amp;lt;K, V&amp;gt; to allow key/value weighing. We fixed this oversight in Guava&apos;s CacheBuilder from the get-go. &lt;/p&gt;

&lt;p&gt;I believe Cassandra wanted entry weighers too, but it wasn&apos;t high priority (no bug filed). Please consider adopting it when you upgrade the library.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13275162" author="jbellis" created="Tue, 15 May 2012 03:58:05 +0000"  >&lt;p&gt;Using MemoryMeter on a hot path like cache updates scares me a bit &amp;#8211; it&apos;s pretty slow.  Might want to switch to using the dataSize * liveRatio measurement that memtables use.&lt;/p&gt;

&lt;p&gt;Aside #1: So basically current 1.1 CLHM is totally broken since it has a capacity of X MB but weighs each item as one byte?&lt;/p&gt;

&lt;p&gt;Aside #2: I don&apos;t see any use of IRCP with useMemoryWeigher=false, looks like we can remove that parameter&lt;/p&gt;</comment>
                            <comment id="13275163" author="jbellis" created="Tue, 15 May 2012 04:00:36 +0000"  >&lt;p&gt;Aside #3: would prefer to assert value.size() &amp;lt; Integer.MAX_VALUE in SC.Weigher, instead of having a Math.min call in there.  Strongly doubt the rest of the code would support serialized values larger than that anyway.&lt;/p&gt;</comment>
                            <comment id="13275165" author="jbellis" created="Tue, 15 May 2012 04:06:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;So basically current 1.1 CLHM is totally broken since it has a capacity of X MB but weighs each item as one byte?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;(If that&apos;s the case, we should target this for 1.1.1.)&lt;/p&gt;</comment>
                            <comment id="13275173" author="vijay2win@yahoo.com" created="Tue, 15 May 2012 04:41:33 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;&amp;gt; Using MemoryMeter on a hot path like cache updates scares me a bit &#8211; it&apos;s pretty slow. Might want to switch to using the dataSize * liveRatio measurement that memtables use.&lt;br/&gt;
Will do.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt; So basically current 1.1 CLHM is totally broken since it has a capacity of X MB but weighs each item as one byte?&lt;br/&gt;
No we assume that the KeyCache to be 48 byte long average size (CacheService.AVERAGE_KEY_CACHE_ROW_SIZE)... &lt;br/&gt;
basically, cache capacity = keyCacheInMemoryCapacity / AVERAGE_KEY_CACHE_ROW_SIZE&lt;br/&gt;
hence each entry is considered to be 1 byte/one entry. (Kind of hackie may be we didn&apos;t have EntryWeigher i guess, now that we have it we can get rid of that logic).&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt; I don&apos;t see any use of IRCP with useMemoryWeigher=false, looks like we can remove that parameter&lt;br/&gt;
We still need it if we dont have Jamm Enabled.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt; would prefer to assert value.size() &amp;lt; Integer.MAX_VALUE in SC.Weigher&lt;br/&gt;
Will do, Plz let me know if everything else is fine...&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt;If that&apos;s the case, we should target this for 1.1.1&lt;br/&gt;
Either ways we have to target for 1.1.1 because the serialized cache is broken &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="13276387" author="vijay2win@yahoo.com" created="Wed, 16 May 2012 01:59:01 +0000"  >&lt;p&gt;The problem with the liveRatio is that it is variable and we might have a leak if we use the ratio... &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Lets say when we add the entry we have a ratio of 1.2 and when the entry is removed we will have the ratio of 1.1 then we will leak some space for cache utilization. So it will be better if this number doesn&apos;t change.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;0001 removes memory meter and does changes to fix the issue.&lt;br/&gt;
0002 adds entry weight and small refactor to change the Provider interface as suggested.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13276879" author="jbellis" created="Wed, 16 May 2012 16:55:49 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.       EntryWeigher&amp;lt;KeyCacheKey, RowIndexEntry&amp;gt; weigher = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EntryWeigher&amp;lt;KeyCacheKey, RowIndexEntry&amp;gt;()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; weightOf(KeyCacheKey key, RowIndexEntry value)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; key.serializedSize() + value.serializedSize();
            }
        };
        ICache&amp;lt;KeyCacheKey, RowIndexEntry&amp;gt; kc = ConcurrentLinkedHashCache.create(keyCacheInMemoryCapacity, weigher);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the serialized size for a non-serialized cache looks fishy to me.&lt;/p&gt;</comment>
                            <comment id="13280486" author="vijay2win@yahoo.com" created="Mon, 21 May 2012 21:02:34 +0000"  >&lt;p&gt;Partially committed 0001 d to 1.1.1 and trunk, which will remove the limitation of 2 GB which this ticket was originally ment to do.&lt;br/&gt;
for 0002 i am working on calculating the object overhead + size without using reflection. Thanks!&lt;/p&gt;</comment>
                            <comment id="13281744" author="vijay2win@yahoo.com" created="Wed, 23 May 2012 17:40:15 +0000"  >&lt;p&gt;Before i go ahead with the complicated implementation (touching most of the cache values), i did a smoke test and thought of sharing the results.&lt;/p&gt;

&lt;p&gt;lgmac-vparthsarathy:cass vparthasarathy$ java -javaagent:/Users/vparthasarathy/Documents/workspace/cassandraT11/lib/jamm-0.2.5.jar -jar ~/Desktop/TestJamm.jar 100000000&lt;br/&gt;
Using reflection took: 25954&lt;br/&gt;
Using NativeCalculation took: 178&lt;br/&gt;
Using MemoryMeter took: 992&lt;br/&gt;
lgmac-vparthsarathy:cass vparthasarathy$ &lt;/p&gt;

&lt;p&gt;I used  &lt;a href=&quot;https://github.com/twitter/commons/blob/master/src/java/com/twitter/common/objectsize/ObjectSizeCalculator.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twitter/commons/blob/master/src/java/com/twitter/common/objectsize/ObjectSizeCalculator.java&lt;/a&gt; for reflection test.&lt;/p&gt;</comment>
                            <comment id="13290535" author="jbellis" created="Wed, 6 Jun 2012 22:43:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;Lets say when we add the entry we have a ratio of 1.2 and when the entry is removed we will have the ratio of 1.1 then we will leak some space for cache utilization. So it will be better if this number doesn&apos;t change&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did some code diving into CLHM &amp;#8211; it looks like it annotates the cache entry with the weight-at-put-time, and uses that in remove or replace.  If so, I think MemoryMeter might be fine after all.&lt;/p&gt;

&lt;p&gt;OTOH if the cache isn&apos;t churning maybe MemoryMeter is just fine the way it is.&lt;/p&gt;

&lt;p&gt;I&apos;m inclined to close this and just open a new ticket for updating to CLHM 1.3 in 1.2 and including keys in our weights.  Thoughts?&lt;/p&gt;</comment>
                            <comment id="13290782" author="vijay2win@yahoo.com" created="Thu, 7 Jun 2012 04:26:46 +0000"  >&lt;blockquote&gt;
&lt;p&gt;just open a new ticket for updating to CLHM 1.3 in 1.2 and including keys in our weights. Thoughts?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done! opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4315&quot; title=&quot;Use EntryWeigher instead of Weigher to Measuring the cache.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4315&quot;&gt;&lt;del&gt;CASSANDRA-4315&lt;/del&gt;&lt;/a&gt;... Thanks!&lt;/p&gt;</comment>
                            <comment id="13290967" author="cburroughs" created="Thu, 7 Jun 2012 12:36:05 +0000"  >&lt;p&gt;I&apos;m having trouble following what happened from this ticket and 4315 (&quot;just open a new ticket for updating to CLHM 1.3 in 1.2... &quot;).  Isn&apos;t 02672936f635c93e84ed6625bb994e1628da5a9b in the 1.1 branch and we already upgraded to CLHM 1.3?&lt;/p&gt;

&lt;p&gt; &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=02672936f635c93e84ed6625bb994e1628da5a9b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=02672936f635c93e84ed6625bb994e1628da5a9b&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13291102" author="vijay2win@yahoo.com" created="Thu, 7 Jun 2012 16:14:31 +0000"  >&lt;p&gt;Yes we did upgrade it to CLHM 1.3 in both Cassandra 1.1 and Cassandra 1.2 to fix the original issue mentioned in the ticket.&lt;/p&gt;

&lt;p&gt;Ben (author of CLHM) also added EntryWeight&amp;lt;K, V&amp;gt; to CLHM 1.3 on our request. Which is 0002 part of the patch originally submitted. &lt;br/&gt;
To use EntryWeights we needed to calculate the memory size&apos;s (We where trying out multiple options using MemoryMeter or using other mechanisms) of the Key and Value, we where trying that in this ticket.&lt;/p&gt;

&lt;p&gt;Hence &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4315&quot; title=&quot;Use EntryWeigher instead of Weigher to Measuring the cache.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4315&quot;&gt;&lt;del&gt;CASSANDRA-4315&lt;/del&gt;&lt;/a&gt; was opened to continue the work of updating CLHM Weigher&amp;lt;V&amp;gt; to CLHM EntryWeight&amp;lt;K, V&amp;gt;.&lt;/p&gt;</comment>
                            <comment id="13293730" author="ssmith" created="Tue, 12 Jun 2012 16:18:10 +0000"  >&lt;p&gt;It looks like the Maven dependencies in build.xml weren&apos;t updated to reference CLHM 1.3:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
&amp;lt;dependency groupId=&quot;com.googlecode.concurrentlinkedhashmap&quot; artifactId=&quot;concurrentlinkedhashmap-lru&quot; version=&quot;1.2&quot;/&amp;gt;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As a result, the &lt;a href=&quot;http://mojo.codehaus.org/cassandra-maven-plugin/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Cassandra Maven Plugin&lt;/a&gt; blows up if you try to make it use Cassandra 1.1.1.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
[ERROR] 10:59:07,698 Exception encountered during startup
[INFO] java.lang.NoSuchMethodError: com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap$Builder.maximumWeightedCapacity(J)Lcom/googlecode/concurrentlinkedhashmap/ConcurrentLinkedHashMap$Builder;
[INFO]     at org.apache.cassandra.cache.ConcurrentLinkedHashCache.create(ConcurrentLinkedHashCache.java:70)
[INFO]     at org.apache.cassandra.cache.ConcurrentLinkedHashCache.create(ConcurrentLinkedHashCache.java:70)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13293833" author="vijay2win@yahoo.com" created="Tue, 12 Jun 2012 18:41:21 +0000"  >&lt;p&gt;Thanks! committed to 1.1 and trunk.&lt;/p&gt;</comment>
                            <comment id="13531520" author="tooda01" created="Thu, 13 Dec 2012 21:16:08 +0000"  >&lt;p&gt;The Maven plugin issue still exists with Cassandra 1.1.5&lt;/p&gt;</comment>
                            <comment id="13531596" author="jbellis" created="Thu, 13 Dec 2012 22:44:37 +0000"  >&lt;p&gt;Feel free to attach a patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12527553" name="0001-CASSANDRA-4139-v2.patch" size="18218" author="vijay2win@yahoo.com" created="Wed, 16 May 2012 01:59:01 +0000"/>
                            <attachment id="12526080" name="0001-CASSANDRA-4150.patch" size="15326" author="vijay2win@yahoo.com" created="Wed, 9 May 2012 00:40:29 +0000"/>
                            <attachment id="12526081" name="0002-Use-EntryWeigher-for-HeapCache.patch" size="8502" author="vijay2win@yahoo.com" created="Wed, 9 May 2012 00:40:29 +0000"/>
                            <attachment id="12527554" name="0002-add-bytes-written-metric-v2.patch" size="14307" author="vijay2win@yahoo.com" created="Wed, 16 May 2012 01:59:01 +0000"/>
                            <attachment id="12526079" name="concurrentlinkedhashmap-lru-1.3.jar" size="54199" author="vijay2win@yahoo.com" created="Wed, 9 May 2012 00:40:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235738</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gskf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96058</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>