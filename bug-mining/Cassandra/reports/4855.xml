<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13747] Fix AssertionError in short read protection</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13747</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;tt&gt;ShortReadRowProtection.moreContents()&lt;/tt&gt; expects that by the time we get to that method, the global post-reconciliation counter was already applied to the current partition. However, sometimes it won&#8217;t get applied, and the global counter continues counting with &lt;tt&gt;rowInCurrentPartition&lt;/tt&gt; value not reset from previous partition, which in the most obvious case would trigger the assertion we are observing - &lt;tt&gt;assert !postReconciliationCounter.isDoneForPartition();&lt;/tt&gt;. In other cases it&#8217;s possible because of this lack of reset to query a node for too few extra rows, causing unnecessary SRP data requests.&lt;/p&gt;

&lt;p&gt;Why is the counter not always applied to the current partition?&lt;/p&gt;

&lt;p&gt;The merged &lt;tt&gt;PartitionIterator&lt;/tt&gt; returned from &lt;tt&gt;DataResolver.resolve()&lt;/tt&gt; has two transformations applied to it, in the following order:&lt;br/&gt;
&lt;tt&gt;Filter&lt;/tt&gt; - to purge non-live data from partitions, and to discard empty partitions altogether (except for Thrift)&lt;br/&gt;
&lt;tt&gt;Counter&lt;/tt&gt;, to count and stop iteration&lt;/p&gt;

&lt;p&gt;Problem is, &lt;tt&gt;Filter&lt;/tt&gt; &#8217;s &lt;tt&gt;applyToPartition()&lt;/tt&gt; code that discards empty partitions (&lt;tt&gt;closeIfEmpty()&lt;/tt&gt; method) would sometimes consume the iterator, triggering short read protection &lt;b&gt;before&lt;/b&gt; &lt;tt&gt;Counter&lt;/tt&gt; &#8217;s &lt;tt&gt;applyToPartition()&lt;/tt&gt; gets called and resets its &lt;tt&gt;rowInCurrentPartition&lt;/tt&gt; sub-counter.&lt;/p&gt;

&lt;p&gt;We should not be consuming iterators until all transformations are applied to them. For transformations it means that they cannot consume iterators unless they are the last transformation on the stack.&lt;/p&gt;

&lt;p&gt;The linked branch fixes the problem by splitting &lt;tt&gt;Filter&lt;/tt&gt; into two transformations. The original - &lt;tt&gt;Filter&lt;/tt&gt; - that does filtering within partitions - and a separate &lt;tt&gt;EmptyPartitionsDiscarder&lt;/tt&gt;, that discards empty partitions from &lt;tt&gt;PartitionIterators&lt;/tt&gt;. Thus &lt;tt&gt;DataResolve.resolve()&lt;/tt&gt;, when constructing its &lt;tt&gt;PartitionIterator&lt;/tt&gt;, now does merge first, then applies &lt;tt&gt;Filter&lt;/tt&gt;, then &lt;tt&gt;Counter&lt;/tt&gt;, and only then, as its last (third) transformation - the &lt;tt&gt;EmptyPartitionsDiscarder&lt;/tt&gt;. Being the last one applied, it&#8217;s legal for it to consume the iterator, and triggering &lt;tt&gt;moreContents()&lt;/tt&gt; is now no longer a problem.&lt;/p&gt;

&lt;p&gt;Fixes: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/13747-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/13747-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/13747-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;. dtest &lt;a href=&quot;https://github.com/iamaleksey/cassandra-dtest/commits/13747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13092855">CASSANDRA-13747</key>
            <summary>Fix AssertionError in short read protection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                            <label>Correctness</label>
                    </labels>
                <created>Mon, 7 Aug 2017 11:15:20 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:01 +0000</updated>
                            <resolved>Tue, 29 Aug 2017 11:37:46 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16117564" author="iamaleksey" created="Mon, 7 Aug 2017 23:42:11 +0000"  >&lt;p&gt;Stack trace for the triggered assertion:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError
	at org.apache.cassandra.service.DataResolver$ShortReadProtection$ShortReadRowProtection.moreContents(DataResolver.java:449)
	at org.apache.cassandra.service.DataResolver$ShortReadProtection$ShortReadRowProtection.moreContents(DataResolver.java:412)
	at org.apache.cassandra.db.transform.BaseIterator.tryGetMoreContents(BaseIterator.java:111)
	at org.apache.cassandra.db.transform.BaseIterator.hasMoreContents(BaseIterator.java:101)
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:155)
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:369)
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:189)
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:158)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:509)
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:369)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129)
	at org.apache.cassandra.db.transform.FilteredRows.isEmpty(FilteredRows.java:50)
	at org.apache.cassandra.db.transform.Filter.closeIfEmpty(Filter.java:73)
	at org.apache.cassandra.db.transform.Filter.applyToPartition(Filter.java:43)
	at org.apache.cassandra.db.transform.Filter.applyToPartition(Filter.java:26)
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:96)
	at org.apache.cassandra.service.StorageProxy$SingleRangeResponse.computeNext(StorageProxy.java:2200)
	at org.apache.cassandra.service.StorageProxy$SingleRangeResponse.computeNext(StorageProxy.java:2172)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:92)
	at org.apache.cassandra.service.StorageProxy$RangeCommandIterator.computeNext(StorageProxy.java:2243)
	at org.apache.cassandra.service.StorageProxy$RangeCommandIterator.computeNext(StorageProxy.java:2210)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:92)
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:707)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16130085" author="benedict" created="Thu, 17 Aug 2017 08:21:18 +0000"  >&lt;p&gt;The patch looks good, but while reviewing I got a little suspicious of the modified line &lt;tt&gt;DataResolver:479&lt;/tt&gt;, as it seemed that &lt;tt&gt;n&lt;/tt&gt; and &lt;tt&gt;x&lt;/tt&gt; were the wrong way around... and, reading the comment of intent directly above, and reproducing the calculation, they are indeed.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;Assuming, now correctly defined, that &lt;tt&gt;n &amp;lt;= x&lt;/tt&gt;, this also obviates the need for the &lt;tt&gt;Math.max(x, 1)&lt;/tt&gt; you have introduced.  This must be true, given that we can only have a short-read triggered in the case that we have yielded too few rows, so we must have fewer than we requested (even if other rows we didn&apos;t know about were introduced by other peers).&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;This is &lt;em&gt;probably&lt;/em&gt; a significant enough bug that it warrants its own ticket for record keeping, though I&apos;m fairly agnostic on that decision.  &lt;/p&gt;

&lt;p&gt;I&apos;m a little concerned about our current short read behaviour, as right now it seems we should be requesting exactly one row, for any size of under-read, which could mean extremely poor performance in case of large under-reads.&lt;/p&gt;

&lt;p&gt;I would suggest that the outer unconditional &lt;tt&gt;Math.max&lt;/tt&gt; is a bad idea, has been (poorly) insulating us from this error, and that we should first be asserting that the calculation yields a value &lt;tt&gt;&amp;gt;= 0&lt;/tt&gt; before setting to 1.&lt;/p&gt;</comment>
                            <comment id="16139983" author="iamaleksey" created="Thu, 24 Aug 2017 12:38:23 +0000"  >&lt;p&gt;Thanks for the review.&lt;/p&gt;

&lt;p&gt;I&apos;ve decided to tackle the related issue you in a &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13794&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;separate ticket&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Will commit this once tests are happy.&lt;/p&gt;</comment>
                            <comment id="16145148" author="iamaleksey" created="Tue, 29 Aug 2017 11:37:22 +0000"  >&lt;p&gt;Didn&#8217;t get a clean CI run, but these are the issues flagged:&lt;/p&gt;

&lt;p&gt;On 3.0 and 3.11, &lt;tt&gt;RemoveTest&lt;/tt&gt; failed due to a port being used by another process. Passed locally, with and without compression.&lt;br/&gt;
On 3.0, &lt;tt&gt;ClientWarningsTest&lt;/tt&gt; timed out. Passed locally.&lt;/p&gt;

&lt;p&gt;5 dtest failures in 3.0 with unrelated failure reasons. Unfortunately currently unable to get a clean run on ASF Jenkins.&lt;/p&gt;

&lt;p&gt;Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/a7cb009f8a3f4d0e0293111bfcfff3d404a37a89&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a7cb009f8a3f4d0e0293111bfcfff3d404a37a89&lt;/a&gt; and merged with 3.11 and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13097299">CASSANDRA-13794</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ihjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>