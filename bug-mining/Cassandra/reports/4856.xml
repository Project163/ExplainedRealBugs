<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13700] Heartbeats can cause gossip information to go permanently missing on certain nodes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13700</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;tt&gt;Gossiper.getStateForVersionBiggerThan&lt;/tt&gt;, we add the &lt;tt&gt;HeartBeatState&lt;/tt&gt; from the corresponding &lt;tt&gt;EndpointState&lt;/tt&gt; to the &lt;tt&gt;EndpointState&lt;/tt&gt; to send. When we&apos;re getting state for ourselves, this means that we add a reference to the local &lt;tt&gt;HeartBeatState&lt;/tt&gt;. Then, once we&apos;ve built a message (in either the Syn or Ack handler), we send it through the &lt;tt&gt;MessagingService&lt;/tt&gt;. In the case that the &lt;tt&gt;MessagingService&lt;/tt&gt; is sufficiently slow, the &lt;tt&gt;GossipTask&lt;/tt&gt; may run before serialization of the Syn or Ack. This means that when the &lt;tt&gt;GossipTask&lt;/tt&gt; acquires the gossip &lt;tt&gt;taskLock&lt;/tt&gt;, it may increment the &lt;tt&gt;HeartBeatState&lt;/tt&gt; version of the local node as stored in the endpoint state map. Then, when we finally serialize the Syn or Ack, we&apos;ll follow the reference to the &lt;tt&gt;HeartBeatState&lt;/tt&gt; and serialize it with a higher version than we saw when constructing the Ack or Ack2.&lt;/p&gt;

&lt;p&gt;Consider the case where we see &lt;tt&gt;HeartBeatState&lt;/tt&gt; with version 4 when constructing an Ack and send it through the &lt;tt&gt;MessagingService&lt;/tt&gt;. Then, we add some piece of state with version 5 to our local &lt;tt&gt;EndpointState&lt;/tt&gt;. If &lt;tt&gt;GossipTask&lt;/tt&gt; runs and increases the &lt;tt&gt;HeartBeatState&lt;/tt&gt; version to 6 before the &lt;tt&gt;MessageOut&lt;/tt&gt; containing the Ack is serialized, the node receiving the Ack will believe it is current to version 6, despite the fact that it has never received a message containing the &lt;tt&gt;ApplicationState&lt;/tt&gt; tagged with version 5.&lt;/p&gt;

&lt;p&gt;I&apos;ve reproduced in this in several versions; so far, I believe this is possible in all versions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13088570">CASSANDRA-13700</key>
            <summary>Heartbeats can cause gossip information to go permanently missing on certain nodes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkni">Joel Knighton</assignee>
                                    <reporter username="jkni">Joel Knighton</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Jul 2017 21:50:15 +0000</created>
                <updated>Fri, 15 May 2020 08:01:28 +0000</updated>
                            <resolved>Mon, 24 Jul 2017 20:29:30 +0000</resolved>
                                        <fixVersion>2.1.19</fixVersion>
                    <fixVersion>2.2.11</fixVersion>
                    <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="16094744" author="jasobrown" created="Thu, 20 Jul 2017 14:14:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkni&quot; class=&quot;user-hover&quot; rel=&quot;jkni&quot;&gt;jkni&lt;/a&gt; Fantastic debugging here, Joel. We have seen this problem, as well, with missing STATUS and TOKENS entries.&lt;/p&gt;

&lt;p&gt;I followed this through, and I believe you are correct. Just to point out (because I had to dig and reason through it), the key problem is (as Joel points out) the shared mutable state of &lt;tt&gt;HeartBeatState&lt;/tt&gt;. In &lt;tt&gt;Gossiper.getStateForVersionBiggerThan&lt;/tt&gt;, when the local node is building up the &lt;tt&gt;Map&amp;lt;ApplicationState, VersionedValue&amp;gt; states&lt;/tt&gt; about itself, if any states are added after the function returns &lt;b&gt;and&lt;/b&gt; the heartbeat is incremented before serialization, the peer will get the updated heartbeat value but not the updated states (as we the set of states for the local node that we&apos;re sending over was already constructed a priori the serialization).&lt;/p&gt;

&lt;p&gt;Off the top of my head, I think there are at least two possible ways to fix this:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;clone the &lt;tt&gt;HeartBeatState&lt;/tt&gt; when constructing the &lt;tt&gt;EndpointState&lt;/tt&gt; to return from &lt;tt&gt;Gossiper.getStateForVersionBiggerThan&lt;/tt&gt;. That way it&apos;s not referencing mutable heartbeat state.&lt;/li&gt;
	&lt;li&gt;execute the &lt;tt&gt;GossipTask&lt;/tt&gt; on the same thread the we receive the gossip syn/ack/ack2 messages (on the &lt;tt&gt;Stage.GOSSIP&lt;/tt&gt; thread). That way we force (almost) all references to gossip&apos;s stated mutable state into one thread.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The first option is simpler, smaller in scope, and certainly safer.&lt;br/&gt;
The second option is has performance implications, especially if the &lt;tt&gt;GossipTask&lt;/tt&gt; takes a while to execute, then we could start backing up the tasks on the stage. This option, though, has the &quot;possibility&quot; of eliminating more of the state race bugs that we seems to continually uncover as time goes on. (Side note: there are still some updates to local Gossip state from the main thread (via &lt;tt&gt;StorageService&lt;/tt&gt;) at startup, and the response to the &lt;tt&gt;EchoMessage&lt;/tt&gt; is on the wrong thread, as well.)&lt;/p&gt;

&lt;p&gt;Joel, can you share the method of how you are able to reproduce this?&lt;/p&gt;</comment>
                            <comment id="16094748" author="jasobrown" created="Thu, 20 Jul 2017 14:17:02 +0000"  >&lt;p&gt;We also might need to make &lt;tt&gt;HeartBeatState.version&lt;/tt&gt; volatile, but I&apos;m still thinking about it (just adding it here for discussion)&lt;/p&gt;</comment>
                            <comment id="16094911" author="jkni" created="Thu, 20 Jul 2017 16:25:03 +0000"  >&lt;p&gt;Thanks, Jason! In this case, I agree the first option is safer for this issue. Something like the second likely makes sense eventually, at least as part of a larger audit of correctness issues in gossip. I believe your volatile suggestion is correct.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a lot of helpful information to reproduce this; it reproduces in larger clusters, particularly with higher latency levels. We can see the effects locally with a few well-timed sleeps in MessagingService, but that isn&apos;t terribly representative.&lt;/p&gt;

&lt;p&gt;Branches pushed here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/13700-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13700-2.1&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/13700-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13700-2.2&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/13700-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13700-3.0&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/13700-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13700-3.11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jkni/cassandra/tree/13700-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13700-trunk&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;There&apos;s a somewhat conceptually similar issue when we bump the gossip generation in the middle of constructing a reply - I believe that&apos;s the cause in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11825&quot; title=&quot;NPE in gossip&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11825&quot;&gt;CASSANDRA-11825&lt;/a&gt;, which presents similar problems. I&apos;m choosing to address them separately because they&apos;re indeed distinct problems and 11825 requires an additional trigger (enabling and disabling gossip during runtime).&lt;/p&gt;</comment>
                            <comment id="16095087" author="jasobrown" created="Thu, 20 Jul 2017 17:58:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16095090" author="jasobrown" created="Thu, 20 Jul 2017 17:59:57 +0000"  >&lt;p&gt;re: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11825&quot; title=&quot;NPE in gossip&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11825&quot;&gt;CASSANDRA-11825&lt;/a&gt;. Yes, shared mutable state strikes again, and thanks for addressing them separately &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16099074" author="jkni" created="Mon, 24 Jul 2017 20:29:30 +0000"  >&lt;p&gt;Thanks! Tests looked good on all branches.&lt;/p&gt;

&lt;p&gt;Committed to 2.1 as &lt;tt&gt;2290c0d4b0c20ce3407ae2c542e580c75a5ab337&lt;/tt&gt; and merged forward through 2.2, 3.0, 3.11, and trunk.&lt;/p&gt;</comment>
                            <comment id="16103667" author="jasobrown" created="Thu, 27 Jul 2017 18:36:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkni&quot; class=&quot;user-hover&quot; rel=&quot;jkni&quot;&gt;jkni&lt;/a&gt; In our internal review of this change, we discovered that that patch can be made incrementally safer. In &lt;tt&gt;Gossiper#getStateForVersionBiggerThan()&lt;/tt&gt;, we &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/gms/Gossiper.java#L899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;get the generation&lt;/a&gt;, but it&apos;s possible the &lt;tt&gt;epState.getHeartBeatState()&lt;/tt&gt; could have been swapped out before the next line executes (where we get the version).&lt;/p&gt;

&lt;p&gt;Are you ok if I make the following small change to &lt;tt&gt;Gossiper#getStateForVersionBiggerThan()&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; localHbGeneration = epState.getHeartBeatState().getGeneration();
-            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; localHbVersion = epState.getHeartBeatState().getHeartBeatVersion();
+            HeartBeatState heartBeatState = epState.getHeartBeatState();
+            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; localHbGeneration = heartBeatState.getGeneration();
+            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; localHbVersion = heartBeatState.getHeartBeatVersion();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Basically, just grab a reference the the same `HeartBeatState` that we&apos;ll use for both the generation and version. Of course, this does not protect against that `HeartBeatState` instance being mutated, but at least we can be smarter about what we reference from the `epState`.&lt;/p&gt;</comment>
                            <comment id="16108999" author="jkni" created="Tue, 1 Aug 2017 14:32:05 +0000"  >&lt;p&gt;I&apos;m not sure of any places in the current codebase where the distinction matters in practice, but the change is cleaner and makes the code more tolerant of changes elsewhere, so +1.&lt;/p&gt;</comment>
                            <comment id="16145523" author="jasobrown" created="Tue, 29 Aug 2017 15:54:34 +0000"  >&lt;p&gt;pushed the minor fix as sha &lt;tt&gt;6b927783ba0777d3dd7c2c3311b246a8dbce5b59&lt;/tt&gt; to 2.1+.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jkni]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12994" cascade-level="1"><![CDATA[Unavailable]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hrn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12340362">3.0.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>