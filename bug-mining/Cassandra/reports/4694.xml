<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13277] Duplicate results with secondary index on static column</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13277</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As a follow up of &lt;a href=&quot;http://www.mail-archive.com/user@cassandra.apache.org/msg50816.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@cassandra.apache.org/msg50816.html&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Duplicate results appear with secondary index on static column with RF &amp;gt; 1.&lt;br/&gt;
Number of results vary depending on consistency level.&lt;/p&gt;

&lt;p&gt;Here is a CCM session to reproduce the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;romain@debian:~$ ccm create 39 -n 3 -v 3.9 -s
Current cluster is now: 39
romain@debian:~$ ccm node1 cqlsh
Connected to 39 at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 3.9 | CQL spec 3.4.2 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; CREATE KEYSPACE test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 2};
cqlsh&amp;gt; CREATE TABLE test.idx_static (id text, id2 bigint &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, added timestamp, source text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, dest text, primary key (id, added));
cqlsh&amp;gt; CREATE index ON test.idx_static (id2);
cqlsh&amp;gt; INSERT INTO test.idx_static (id, id2, added, source, dest) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;id1&apos;&lt;/span&gt;, 22,&lt;span class=&quot;code-quote&quot;&gt;&apos;2017-01-28&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;src1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dst1&apos;&lt;/span&gt;);
cqlsh&amp;gt; SELECT * FROM test.idx_static where id2=22;

 id  | added                           | id2 | source | dest
-----+---------------------------------+-----+--------+------
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1

(2 rows)
cqlsh&amp;gt; CONSISTENCY ALL 
Consistency level set to ALL.
cqlsh&amp;gt; SELECT * FROM test.idx_static where id2=22;

 id  | added                           | id2 | source | dest
-----+---------------------------------+-----+--------+------
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1

(3 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When RF matches the number of nodes, it works as expected.&lt;/p&gt;

&lt;p&gt;Example with RF=3 and 3 nodes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;romain@debian:~$ ccm create 39 -n 3 -v 3.9 -s
Current cluster is now: 39

romain@debian:~$ ccm node1 cqlsh
Connected to 39 at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 3.9 | CQL spec 3.4.2 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.

cqlsh&amp;gt; CREATE KEYSPACE test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 3};
cqlsh&amp;gt; CREATE TABLE test.idx_static (id text, id2 bigint &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, added timestamp, source text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, dest text, primary key (id, added));
cqlsh&amp;gt; CREATE index ON test.idx_static (id2);
cqlsh&amp;gt; INSERT INTO test.idx_static (id, id2, added, source, dest) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;id1&apos;&lt;/span&gt;, 22,&lt;span class=&quot;code-quote&quot;&gt;&apos;2017-01-28&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;src1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dst1&apos;&lt;/span&gt;);
cqlsh&amp;gt; SELECT * FROM test.idx_static where id2=22;

 id  | added                           | id2 | source | dest
-----+---------------------------------+-----+--------+------
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1

(1 rows)
cqlsh&amp;gt; CONSISTENCY all
Consistency level set to ALL.
cqlsh&amp;gt; SELECT * FROM test.idx_static where id2=22;

 id  | added                           | id2 | source | dest
-----+---------------------------------+-----+--------+------
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Example with RF = 2 and 2 nodes:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;romain@debian:~$ ccm create 39 -n 2 -v 3.9 -s
Current cluster is now: 39
romain@debian:~$ ccm node1 cqlsh
Connected to 39 at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 3.9 | CQL spec 3.4.2 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; CREATE KEYSPACE test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 2};
cqlsh&amp;gt; CREATE TABLE test.idx_static (id text, id2 bigint &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, added timestamp, source text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, dest text, primary key (id, added));
cqlsh&amp;gt; INSERT INTO test.idx_static (id, id2, added, source, dest) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;id1&apos;&lt;/span&gt;, 22,&lt;span class=&quot;code-quote&quot;&gt;&apos;2017-01-28&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;src1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dst1&apos;&lt;/span&gt;);
cqlsh&amp;gt; CREATE index ON test.idx_static (id2);
cqlsh&amp;gt; INSERT INTO test.idx_static (id, id2, added, source, dest) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;id1&apos;&lt;/span&gt;, 22,&lt;span class=&quot;code-quote&quot;&gt;&apos;2017-01-28&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;src1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dst1&apos;&lt;/span&gt;);
cqlsh&amp;gt; SELECT * FROM test.idx_static where id2=22;

 id  | added                           | id2 | source | dest
-----+---------------------------------+-----+--------+------
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1

(1 rows)
cqlsh&amp;gt; CONSISTENCY ALL 
Consistency level set to ALL.
cqlsh&amp;gt; SELECT * FROM test.idx_static where id2=22;

 id  | added                           | id2 | source | dest
-----+---------------------------------+-----+--------+------
 id1 | 2017-01-27 23:00:00.000000+0000 |  22 |   src1 | dst1

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13046699">CASSANDRA-13277</key>
            <summary>Duplicate results with secondary index on static column</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adelapena">Andres de la Pe&#241;a</assignee>
                                    <reporter username="rha">Romain Hardouin</reporter>
                        <labels>
                            <label>2i</label>
                    </labels>
                <created>Mon, 27 Feb 2017 18:06:59 +0000</created>
                <updated>Fri, 15 May 2020 07:59:31 +0000</updated>
                            <resolved>Tue, 28 Mar 2017 11:24:17 +0000</resolved>
                                        <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/2i Index</component>
                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15940277" author="adelapena" created="Fri, 24 Mar 2017 13:06:27 +0000"  >&lt;p&gt;The underlying problem can be reproduced with a single node:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE k WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};

CREATE TABLE k.c (
	pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, 
	ck &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, 
	sc &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;
	primary key (pk, ck)
);

CREATE index ON k.c (sc);

INSERT INTO k.c (pk, ck, sc) values (1, 2, 3);
INSERT INTO k.c (pk, ck, sc) values (-1, 2, 3);

SELECT token(pk), pk, ck, sc FROM k.c where sc = 3 AND token(pk) &amp;gt; 0;
 system.token(pk)     | pk | ck | sc
----------------------+----+----+----
 -4069959284402364209 |  1 |  2 |  3
  7297452126230313552 | -1 |  2 |  3

SELECT token(pk), pk, ck, sc FROM k.c where sc = 3 AND token(pk) &amp;lt;= 0;
 system.token(pk)     | pk | ck | sc
----------------------+----+----+----
 -4069959284402364209 |  1 |  2 |  3
  7297452126230313552 | -1 |  2 |  3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is produced because &lt;tt&gt;CompositesSearcher&lt;/tt&gt; doesn&apos;t verify that index hits satisfy command&apos;s key constraint when dealing with static columns, as it is done with regular columns.&lt;/p&gt;

&lt;p&gt;The provided examples don&apos;t specify key restrictions but they fail when RF is lesser than the number of nodes because they are internally split into subqueries directed to specific token ranges. Replicas ignore the token range restriction and the coordinator receives duplicate rows from unexpected token ranges, as it is shown in the previous example.&lt;/p&gt;

&lt;p&gt;An initial version of the patch can be found here.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:13277-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-13277-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-13277-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...adelapena:13277-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-13277-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-13277-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15944905" author="blerer" created="Tue, 28 Mar 2017 10:07:28 +0000"  >&lt;p&gt;Nice finding! The patch looks good. Thanks.&lt;/p&gt;</comment>
                            <comment id="15944979" author="blerer" created="Tue, 28 Mar 2017 11:24:17 +0000"  >&lt;p&gt;Comitted into 3.11 at 41befde2273724e2070a28cd6c47a407e3e4426a and merged into trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3aoon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337344">3.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>