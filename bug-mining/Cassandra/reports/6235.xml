<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:27:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18507] Partial compaction can resurrect deleted data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18507</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If there isn&apos;t enough disk space available to compact all existing sstables, Cassandra will attempt to perform a partial compaction by removing sstables from the set of candidate sstables to be compacted, starting with the largest one. It is possible that the sstable removed from the set of sstables to compact contains data for which there are tombstones in another (more recent) sstable. Since the overlaps between sstables is computed when the &lt;tt&gt;CompactionController&lt;/tt&gt; is created, and the &lt;tt&gt;CompactionController&lt;/tt&gt; is created before the removal of any sstables from the set of sstables to be compacted this computed overlap will be outdated when checking which sstables are covered by certain tombstones. This leads to the faulty conclusion that the tombstones can be pruned during the compaction, causing the data to be resurrected.&lt;/p&gt;

&lt;p&gt;The issue is present in Cassandra 4.0 and 4.1. Cassandra 3.11 creates the &lt;tt&gt;CompactionController&lt;/tt&gt; after the set of sstables to compact has been reduced, and is thus not affected. &lt;tt&gt;trunk&lt;/tt&gt; does not appear to support partial compactions at all, but instead refuses to compact when the disk is full.&lt;/p&gt;

&lt;p&gt;This regression appears to have been introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13068&quot; title=&quot;Fully expired sstable not dropped when running out of disk space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13068&quot;&gt;&lt;del&gt;CASSANDRA-13068&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13535502">CASSANDRA-18507</key>
            <summary>Partial compaction can resurrect deleted data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="toblin">Tobias Lindaaker</assignee>
                                    <reporter username="toblin">Tobias Lindaaker</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 May 2023 10:19:50 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:41 +0000</updated>
                            <resolved>Thu, 18 May 2023 17:43:44 +0000</resolved>
                                        <fixVersion>4.0.10</fixVersion>
                    <fixVersion>4.1.2</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17720890" author="JIRAUSER300240" created="Tue, 9 May 2023 10:24:15 +0000"  >&lt;p&gt;Here is a fix for Cassandra 4.0: branch &lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507-4.0&lt;/a&gt;, commit &lt;a href=&quot;https://github.com/thobe/cassandra/commit/285323eee48aaf0ff800d0aaba96b94238174e52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;285323eee48aaf0ff800d0aaba96b94238174e52&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17720896" author="JIRAUSER300240" created="Tue, 9 May 2023 10:49:53 +0000"  >&lt;p&gt;Same fix for Cassandra 4.1: branch &lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507-4.1&lt;/a&gt;, commit &lt;a href=&quot;https://github.com/thobe/cassandra/commit/186b7876bd7f82a50409877427bf420b76854a91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;186b7876bd7f82a50409877427bf420b76854a91&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Only the test case required minimal adaptation between 4.0 and 4.1.&lt;/p&gt;</comment>
                            <comment id="17721103" author="dcapwell" created="Tue, 9 May 2023 22:29:42 +0000"  >&lt;p&gt;I reverted the change to src so only the test exists, I then ran it and seems the jvm is crashing?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] Testcase: org.apache.cassandra.db.compaction.PartialCompactionsTest:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;:       Caused an ERROR
[junit-timeout] Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
[junit-timeout] junit.framework.AssertionFailedError: Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]         at org.apache.cassandra.anttasks.TestHelper.execute(TestHelper.java:53)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]
[junit-timeout]
[junit-timeout] Test org.apache.cassandra.db.compaction.PartialCompactionsTest FAILED (crashed)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17721105" author="dcapwell" created="Tue, 9 May 2023 22:33:04 +0000"  >&lt;p&gt;I pulled in the src changes and still the test is crashing &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] Testcase: org.apache.cassandra.db.compaction.PartialCompactionsTest:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;:       Caused an ERROR
[junit-timeout] Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
[junit-timeout] junit.framework.AssertionFailedError: Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]         at org.apache.cassandra.anttasks.TestHelper.execute(TestHelper.java:53)
[junit-timeout]         at java.util.Vector.forEach(Vector.java:1277)
[junit-timeout]
[junit-timeout]
[junit-timeout] Test org.apache.cassandra.db.compaction.PartialCompactionsTest FAILED (crashed)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17721127" author="dcapwell" created="Wed, 10 May 2023 00:10:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toblin&quot; class=&quot;user-hover&quot; rel=&quot;toblin&quot;&gt;toblin&lt;/a&gt; can you take a look at the test and make sure it passes, and that it detects the issue if you revert the change to src?&lt;/p&gt;</comment>
                            <comment id="17721234" author="JIRAUSER300240" created="Wed, 10 May 2023 07:45:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; that&apos;s odd. When I run the test with the source unchanged (/reverted) I get:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] Testcase: shouldNotRemoveTombstonesShadowingDataExcludedFromCompaction(org.apache.cassandra.db.compaction.PartialCompactionsTest): FAILED
[junit-timeout] remaining live rows after compaction expected:&amp;lt;100&amp;gt; but was:&amp;lt;105&amp;gt;
[junit-timeout] junit.framework.AssertionFailedError: remaining live rows after compaction expected:&amp;lt;100&amp;gt; but was:&amp;lt;105&amp;gt;
[junit-timeout] at org.apache.cassandra.db.compaction.PartialCompactionsTest.shouldNotRemoveTombstonesShadowingDataExcludedFromCompaction(PartialCompactionsTest.java:90)
[junit-timeout] at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout] at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[junit-timeout] at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout] 
[junit-timeout] 
[junit-timeout] Test org.apache.cassandra.db.compaction.PartialCompactionsTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
And with the source changes in place:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] INFO&#160; [main] 2023-05-10 09:01:05,369 ColumnFamilyStore.java:2655 - Truncate of PartialCompactionsTest.shouldNotRemoveTombstonesShadowingDataExcludedFromCompaction is complete
[junit-timeout] ------------- ---------------- ---------------
&#160;&#160; [delete] Deleting directory .../cassandra-4.1/build/test/cassandra/commitlog
&#160;&#160; [delete] Deleting directory .../cassandra-4.1/build/test/cassandra/data
&#160;&#160; [delete] Deleting directory .../cassandra-4.1/build/test/cassandra/saved_caches
&#160;&#160; [delete] Deleting directory .../cassandra-4.1/build/test/cassandra/hints


BUILD SUCCESSFUL
Total time: 24 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Same exact result on both the &lt;tt&gt;cassandra-4.0&lt;/tt&gt; branch and the &lt;tt&gt;cassandra-4.1&lt;/tt&gt; branch.&lt;/p&gt;

&lt;p&gt;Maybe I&apos;m doing something non-standard when running tests? I&apos;ve primarily been running with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant test -Dtest.name=PartialCompactionsTest -Duse.jdk11=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But in order to rule out the possibility of this being Java version related, I also tried with Java 8 now, and that had the exact same outcome as well.&lt;/p&gt;

&lt;p&gt;So next I&apos;m wondering if the difference you are experiencing is platform related. I&apos;ve been running on MacOS. So I tried running the test in a docker container (&lt;tt&gt;eclipse-temurin:8-jdk-jammy&lt;/tt&gt;). That also works in the same way as when running natively on my machine, and is able to detect the issue when the change to source is reverted.&lt;/p&gt;

&lt;p&gt;Even if I run the test as part of a larger set of tests it works the way it is intended to.&lt;/p&gt;

&lt;p&gt;Please let me know if I should be running the test in a different way, or what I should be doing to reproduce the failure you are experiencing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17721470" author="dcapwell" created="Wed, 10 May 2023 16:45:53 +0000"  >&lt;p&gt;That&apos;s weird... I know &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; is looking at this patch as well.&lt;/p&gt;</comment>
                            <comment id="17721472" author="dcapwell" created="Wed, 10 May 2023 16:48:09 +0000"  >&lt;p&gt;Overall the patch LGTM... its not clear why the test doesn&apos;t work on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; and my laptop, but think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; can help here.&lt;/p&gt;

&lt;p&gt;For the core patch, I am +1.  I do think we will want this test for trunk just to make sure this regression doesn&apos;t come back.&lt;/p&gt;</comment>
                            <comment id="17721799" author="krummas" created="Thu, 11 May 2023 14:17:53 +0000"  >&lt;p&gt;+1 on the patch, very nice catch&lt;/p&gt;

&lt;p&gt;pushed an alternative/additional test here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.1&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.0&lt;/a&gt; &lt;br/&gt;
but the existing test is fine as well I think (though we might have a general problem running tests with java11 on macos?)&lt;/p&gt;

&lt;p&gt;running cci:&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/868/workflows/0ab45cff-4d06-4f25-ba55-e19a8dcb1ad2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra/868/workflows/0ab45cff-4d06-4f25-ba55-e19a8dcb1ad2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/869/workflows/a7502533-0524-4669-b450-a8bd3897cb34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra/869/workflows/a7502533-0524-4669-b450-a8bd3897cb34&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17721821" author="edimitrova" created="Thu, 11 May 2023 15:06:34 +0000"  >&lt;p&gt;Hey everyone,&lt;/p&gt;

&lt;p&gt;I also have a Mac available so decided to test on my end too. I can confirm that I pulled &lt;a href=&quot;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.1&lt;/a&gt;&#160;and &lt;a href=&quot;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/tree/CASSANDRA-18507-4.0&lt;/a&gt;. &#160;Then:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant realclean
ant jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
ant test -Dtest.name=PartialCompactionsTest -Duse.jdk11=true &lt;br/&gt;
Everything finished successfully for me.&lt;/p&gt;

&lt;p&gt;To be on the safe side I also tested with JDK 8. I ran this with both branches.&lt;/p&gt;

&lt;p&gt;I tried on&#160;Mac Book pro from 2018,&#160;MAC OS 12.06&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
openjdk version &lt;span class=&quot;code-quote&quot;&gt;&quot;11.0.2&quot;&lt;/span&gt; 2019-01-15
OpenJDK &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment 18.9 (build 11.0.2+9)
OpenJDK 64-Bit Server VM 18.9 (build 11.0.2+9, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java version &lt;span class=&quot;code-quote&quot;&gt;&quot;1.8.0_231&quot;&lt;/span&gt;
Java(TM) SE &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment (build 1.8.0_231-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.231-b11, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt;, can you push to run also the JDK 11 workflow In CI, please? I noticed you started only JDK8 workflow.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;I do think we will want this test for trunk just to make sure this regression doesn&apos;t come back.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That sounds like a great idea to me.&lt;/p&gt;</comment>
                            <comment id="17721848" author="krummas" created="Thu, 11 May 2023 16:55:49 +0000"  >&lt;p&gt;j8/j11 runs;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra?branch=CASSANDRA-18507-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra?branch=CASSANDRA-18507-4.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra?branch=CASSANDRA-18507-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra?branch=CASSANDRA-18507-4.1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17722872" author="JIRAUSER300240" created="Mon, 15 May 2023 17:19:18 +0000"  >&lt;p&gt;I have pushed an update that structures the test to be more in line with how other tests works. This also makes it possible to add other test cases to that test class in the future (I&apos;d made a mistake in the setup that prevented that before). I&apos;m not sure if this has any effect on the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; had with running the test or not.&lt;br/&gt;
I also incorporated the JVM-DTest that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; wrote, since I think it seems useful to have that level of testing for this as well.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507-4.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507-4.1&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have also done some further analysis of the behavior of this test on &lt;tt&gt;trunk&lt;/tt&gt;. I said before that the problem does not manifest on &lt;tt&gt;trunk&lt;/tt&gt;. However, after further analysis, it seems that is because &lt;tt&gt;trunk&lt;/tt&gt; uses a different method for checking for available disk space, so the limiting that&apos;s done in my test (and the limiting don in the JVM-DTest that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; wrote) does not work to trigger a partial compaction, but later there is a different check that &lt;em&gt;is&lt;/em&gt; triggered by the limiting in my test that rejects the compaction due to lack of disk space. I had misinterpreted this as partial compactions not being supported at all, but I&apos;ll see if I can revise the test to be applicable to &lt;tt&gt;trunk&lt;/tt&gt; as well in order to see if this problem also occurs there.&lt;/p&gt;</comment>
                            <comment id="17723092" author="JIRAUSER300240" created="Tue, 16 May 2023 11:11:43 +0000"  >&lt;p&gt;After updating the tests to emulate insufficient disk space correctly for &lt;tt&gt;trunk&lt;/tt&gt;, I can conclude that the problem occurs there as well. Here is a branch with changes applicable for &lt;tt&gt;trunk&lt;/tt&gt;: &lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17723295" author="dcapwell" created="Tue, 16 May 2023 22:02:11 +0000"  >&lt;p&gt;the trunk patch LGTM, +1&lt;/p&gt;

&lt;p&gt;If &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; doesn&apos;t merge today, ill merge tomorrow; assuming he is +1 to trunk patch&lt;/p&gt;</comment>
                            <comment id="17723405" author="JIRAUSER300240" created="Wed, 17 May 2023 10:32:32 +0000"  >&lt;p&gt;I have updated the branches to make sure they are in sync. I have also pushed branches of &lt;tt&gt;4.1&lt;/tt&gt; and &lt;tt&gt;trunk&lt;/tt&gt; where the change history is based on merging the changes forward from the previous version instead, in case that is more helpful:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;4.1&lt;/tt&gt;: &lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507-4.1-merge&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507-4.1-merge&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;trunk&lt;/tt&gt;: &lt;a href=&quot;https://github.com/thobe/cassandra/tree/CASSANDRA-18507-merge&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thobe/CASSANDRA-18507-merge&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also added a change to logging that would have made debugging this issue when we first encountered it a little bit quicker.&lt;/p&gt;</comment>
                            <comment id="17723739" author="dcapwell" created="Wed, 17 May 2023 21:36:12 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-18507-cassandra-4.0-82D47737-2369-4747-BEBD-045157D71017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-18507-cassandra-4.0-82D47737-2369-4747-BEBD-045157D71017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2466/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-18507-cassandra-4.1-82D47737-2369-4747-BEBD-045157D71017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-18507-cassandra-4.1-82D47737-2369-4747-BEBD-045157D71017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2467/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-18507-trunk-82D47737-2369-4747-BEBD-045157D71017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-18507-trunk-82D47737-2369-4747-BEBD-045157D71017&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;build|unknown&amp;#93;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17723962" author="dcapwell" created="Thu, 18 May 2023 16:35:35 +0000"  >&lt;p&gt;4.0 has org.apache.cassandra.distributed.test.FailingRepairTest crash right away; I don&apos;t see any logs... this repo for me locally as well as CI (&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/2124/workflows/2862d46f-0728-4617-b1a3-1ba15baa672e/jobs/27702/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/2124/workflows/2862d46f-0728-4617-b1a3-1ba15baa672e/jobs/27702/tests&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;4.1 looks to be flaky tests&lt;/p&gt;

&lt;p&gt;trunk looks good other than upgrade tests... I think I mentioned this to people on slack awhile back... this doesn&apos;t look related to your work so I think it&apos;s fine to ignore for this patch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toblin&quot; class=&quot;user-hover&quot; rel=&quot;toblin&quot;&gt;toblin&lt;/a&gt; can you take a look at the repair test in 4.0?  Curious if you can repo and figure out what&apos;s going on.&lt;/p&gt;</comment>
                            <comment id="17723969" author="brandon.williams" created="Thu, 18 May 2023 16:49:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; that looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18366&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.FailingRepairTest - testFailingMessage[VALIDATION_REQ/parallel/true]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18366&quot;&gt;&lt;del&gt;CASSANDRA-18366&lt;/del&gt;&lt;/a&gt; to me.&lt;/p&gt;</comment>
                            <comment id="17723986" author="dcapwell" created="Thu, 18 May 2023 17:32:07 +0000"  >&lt;p&gt;ill test out 4.0 in isolation to double check&lt;/p&gt;</comment>
                            <comment id="17723987" author="dcapwell" created="Thu, 18 May 2023 17:33:53 +0000"  >&lt;p&gt;thanks for pointing that out, confirmed it fails in cassandra-4.0 branch as well.&lt;/p&gt;

&lt;p&gt;With that, CI is clean&lt;/p&gt;</comment>
                            <comment id="17723989" author="dcapwell" created="Thu, 18 May 2023 17:35:32 +0000"  >&lt;p&gt;starting the merge now&lt;/p&gt;</comment>
                            <comment id="17723991" author="dcapwell" created="Thu, 18 May 2023 17:44:00 +0000"  >&lt;p&gt;Thanks for all the hard work!  merged to 4.0, 4.1, and trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[toblin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hs08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350367">4.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/1053e3b475829c7f2d0dc4ab59322d5819d1496a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/1053e3b475829c7f2d0dc4ab59322d5819d1496a&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Unit Tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>