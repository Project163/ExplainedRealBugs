<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9037] Terminal UDFs evaluated at prepare time throw protocol version error</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9037</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a pure function with only terminal arguments (or with no arguments) is used in a where clause, it&apos;s executed at prepare time and &lt;tt&gt;Server.CURRENT_VERSION&lt;/tt&gt; passed as the protocol version for serialization purposes. For native functions, this isn&apos;t a problem, but UDFs use classes in the bundled java-driver-core jar for (de)serialization of args and return values. When &lt;tt&gt;Server.CURRENT_VERSION&lt;/tt&gt; is greater than the highest version supported by the bundled java driver the execution fails with the following exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [SharedPool-Worker-1] 2015-03-24 18:10:59,391 QueryMessage.java:132 - Unexpected error during query
org.apache.cassandra.exceptions.FunctionExecutionException: execution of &apos;ks.overloaded[text]&apos; failed: java.lang.IllegalArgumentException: No protocol version matching integer version 4
    at org.apache.cassandra.exceptions.FunctionExecutionException.create(FunctionExecutionException.java:35) ~[main/:na]
    at org.apache.cassandra.cql3.udf.gen.Cksoverloaded_1.execute(Cksoverloaded_1.java) ~[na:na]
    at org.apache.cassandra.cql3.functions.FunctionCall.executeInternal(FunctionCall.java:78) ~[main/:na]
    at org.apache.cassandra.cql3.functions.FunctionCall.access$200(FunctionCall.java:34) ~[main/:na]
    at org.apache.cassandra.cql3.functions.FunctionCall$Raw.execute(FunctionCall.java:176) ~[main/:na]
    at org.apache.cassandra.cql3.functions.FunctionCall$Raw.prepare(FunctionCall.java:161) ~[main/:na]
    at org.apache.cassandra.cql3.SingleColumnRelation.toTerm(SingleColumnRelation.java:108) ~[main/:na]
    at org.apache.cassandra.cql3.SingleColumnRelation.newEQRestriction(SingleColumnRelation.java:143) ~[main/:na]
    at org.apache.cassandra.cql3.Relation.toRestriction(Relation.java:127) ~[main/:na]
    at org.apache.cassandra.cql3.restrictions.StatementRestrictions.&amp;lt;init&amp;gt;(StatementRestrictions.java:126) ~[main/:na]
    at org.apache.cassandra.cql3.statements.SelectStatement$RawStatement.prepareRestrictions(SelectStatement.java:787) ~[main/:na]
    at org.apache.cassandra.cql3.statements.SelectStatement$RawStatement.prepare(SelectStatement.java:740) ~[main/:na]
    at org.apache.cassandra.cql3.QueryProcessor.getStatement(QueryProcessor.java:488) ~[main/:na]
    at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:252) ~[main/:na]
    at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:246) ~[main/:na]
    at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:119) ~[main/:na]
    at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:475) [main/:na]
    at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:371) [main/:na]
    at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
    at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
    at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_71]
    at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [main/:na]
    at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
    at java.lang.Thread.run(Thread.java:745) [na:1.7.0_71]
Caused by: java.lang.IllegalArgumentException: No protocol version matching integer version 4
    at com.datastax.driver.core.ProtocolVersion.fromInt(ProtocolVersion.java:89) ~[cassandra-driver-core-2.1.2.jar:na]
    at org.apache.cassandra.cql3.functions.UDFunction.compose(UDFunction.java:177) ~[main/:na]
    ... 25 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is currently the case on trunk following the bump of &lt;tt&gt;Server.CURRENT_VERSION&lt;/tt&gt; to 4 by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7660&quot; title=&quot;Indicate PK columns in &amp;quot;prepared&amp;quot; native protocol responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7660&quot;&gt;&lt;del&gt;CASSANDRA-7660&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12785500">CASSANDRA-9037</key>
            <summary>Terminal UDFs evaluated at prepare time throw protocol version error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Mar 2015 11:53:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:17 +0000</updated>
                            <resolved>Fri, 3 Apr 2015 17:54:27 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14379776" author="beobal" created="Wed, 25 Mar 2015 12:13:43 +0000"  >&lt;p&gt;We should use the version from &lt;tt&gt;ProtocolVersion.NEWEST_SUPPORTED&lt;/tt&gt; to ensure we don&apos;t get ahead of the included driver. Unfortunately, C* uses a simple int to represent this version (in &lt;tt&gt;QueryOptions&lt;/tt&gt; for instance) but the driver&apos;s &lt;tt&gt;ProtocolVersion&lt;/tt&gt; doesn&apos;t expose the version number in this way so I&apos;ve opened &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA-700&lt;/a&gt; to do so.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/9037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This branch&lt;/a&gt; includes a unit test &amp;amp; a SNAPSHOT driver jar build from &lt;a href=&quot;https://github.com/datastax/java-driver/pull/308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the JAVA-700 pull request&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14380757" author="thobbs" created="Wed, 25 Mar 2015 20:59:51 +0000"  >&lt;p&gt;Overall the patch looks good, just a couple of comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There are some (apparently) unrelated changes to CqlRecordReader included&lt;/li&gt;
	&lt;li&gt;Can you add a test case that uses literal function arguments (especially collections)?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14381759" author="beobal" created="Thu, 26 Mar 2015 11:41:39 +0000"  >&lt;p&gt;Thanks Tyler, I&apos;ve pushed another commit to the branch with additional tests as requested.&lt;/p&gt;

&lt;p&gt;The changes to CqlRecordReader aren&apos;t unrelated, its inner WrappedRow class implements com.datastax.driver.core.Row which has been extended since version 2.1.2 of the driver (in &lt;a href=&quot;https://github.com/datastax/java-driver/commit/5c1e121f0cc6e39e4d1349bb30f409ae486b3d97#diff-3b8ffce5c217f9096226305ecfd5a49a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5c1e121f&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://github.com/datastax/java-driver/commit/a0c42dd24f65d3b6e7c558dce68ae1b48c6da7f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a0c42dd2&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14384113" author="thobbs" created="Fri, 27 Mar 2015 16:41:42 +0000"  >&lt;p&gt;It just occurred to me that we can&apos;t execute terminal functions at prepare-time if they return a collection.  The reason is that the protocol version isn&apos;t known yet, and the serialization of the collection depends on the protocol version.  So, we should either avoid executing if the return type is a collection type (or tuple or UDT that contains a collection), or execute anyway and handle re-serialization at execute time if the protocol version is not v3+.  I&apos;m guessing the first option is significantly simpler to implement.&lt;/p&gt;</comment>
                            <comment id="14384227" author="thobbs" created="Fri, 27 Mar 2015 17:45:49 +0000"  >&lt;p&gt;Linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8996&quot; title=&quot;dtests should pass on trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8996&quot;&gt;&lt;del&gt;CASSANDRA-8996&lt;/del&gt;&lt;/a&gt;, as this is responsible for the failure of the &lt;tt&gt;user_functions_test.TestUserFunctions.udf_overload_test&lt;/tt&gt; dtest.&lt;/p&gt;</comment>
                            <comment id="14393131" author="beobal" created="Thu, 2 Apr 2015 18:36:25 +0000"  >&lt;p&gt;Rebased and pushed with an additional commit to defer execution of terminal functions until statement execution where either the return type or any of the args are collections. (&lt;a href=&quot;https://github.com/beobal/cassandra/tree/9037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Also, this does indeed fix &lt;tt&gt;user_functions_test.TestUserFunctions.udf_overload_test&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14393255" author="thobbs" created="Thu, 2 Apr 2015 19:56:06 +0000"  >&lt;p&gt;I don&apos;t think we need to defer for collection args, only return types.  The get() method for collection Terminals (e.g. &lt;tt&gt;Lists.Value.get()&lt;/tt&gt;) serializes the collection based on the requested protocol version (the highest version supported by the driver, in this case).  The function will also execute assuming that same protocol version, so it will have no problems deserializing the collection.  The reason that the return type specifically is problematic is that the function results may need further processing (such as another function call) or reserialization (if the protocol version is less than 3).  Basically, the serialization format for the results has to match the protocol version in use.&lt;/p&gt;

&lt;p&gt;Also, don&apos;t forget to handle tuple and UDT return types specially.  If they contain collections, those collections will be serialized with the format for whatever protocol version we execute the function with.&lt;/p&gt;</comment>
                            <comment id="14394198" author="slebresne" created="Fri, 3 Apr 2015 08:28:30 +0000"  >&lt;p&gt;Fyi, as I suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7557&quot; title=&quot;User permissions for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7557&quot;&gt;&lt;del&gt;CASSANDRA-7557&lt;/del&gt;&lt;/a&gt;, I suggest we just entirely get rid of function execution at prepare time. The short version is that it&apos;s imo starting to add way more complexity than it&apos;s worth as an optimization.&lt;/p&gt;</comment>
                            <comment id="14394433" author="beobal" created="Fri, 3 Apr 2015 13:39:21 +0000"  >&lt;p&gt;WFM, I&apos;ve pushed a new version of the branch which simply removes that prepare time execution.&lt;/p&gt;</comment>
                            <comment id="14394769" author="thobbs" created="Fri, 3 Apr 2015 17:54:27 +0000"  >&lt;p&gt;+1, committed as 7d68ced.  This also resolves the failing dtests.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12783375">CASSANDRA-8996</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12709276" name="9037-final.txt" size="2721" author="thobbs" created="Fri, 3 Apr 2015 17:53:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27c0v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324945">2.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>