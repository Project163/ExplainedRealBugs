<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:34:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19902] StorageService JMX mbean is not available during bootstrap</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19902</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Looks like the seemingly harmless cosmetic patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; causes the StorageServiceMBean to not be available during bootstrap. This causes commands like &quot;nodetool nestats/status/etc&quot; to not be available on the boostrapping node with the following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
- StackTrace --
javax.management.InstanceNotFoundException: org.apache.cassandra.db:type=StorageService
        at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.getMBean(DefaultMBeanServerInterceptor.java:1083)
        at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.getAttribute(DefaultMBeanServerInterceptor.java:637)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This ticket is just to revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt;, we can re-add the improvement of that ticket later.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13591236">CASSANDRA-19902</key>
            <summary>StorageService JMX mbean is not available during bootstrap</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulo">Paulo Motta</assignee>
                                    <reporter username="paulo">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Sep 2024 01:56:14 +0000</created>
                <updated>Mon, 28 Jul 2025 07:54:19 +0000</updated>
                            <resolved>Mon, 28 Jul 2025 07:53:31 +0000</resolved>
                                        <fixVersion>5.0.5</fixVersion>
                                    <component>Tool/nodetool</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17879754" author="paulo" created="Fri, 6 Sep 2024 04:21:27 +0000"  >&lt;p&gt;I&apos;m surprised this was not caught on a test, but I guess it needs a ccm dtest to reproduce.&lt;/p&gt;

&lt;p&gt;5.0 patch: &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-19902-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-19902-5.0&lt;/a&gt;&lt;br/&gt;
CI: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/60/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/60/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s not clear if this affects trunk due to TCM changes, I&apos;ll check.&lt;/p&gt;</comment>
                            <comment id="17902115" author="paulo" created="Sun, 1 Dec 2024 17:16:08 +0000"  >&lt;p&gt;It turns out it was trickier to revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; than to just fix this regression, because there was no test to verify the original behavior and this somewhat overlaps in trunk with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18330&quot; title=&quot;Delivery of CEP-21: Transactional Cluster Metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18330&quot;&gt;&lt;del&gt;CASSANDRA-18330&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19384&quot; title=&quot;Avoid exposing intermediate node state during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19384&quot;&gt;&lt;del&gt;CASSANDRA-19384&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To give a little context on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt;, StorageServiceMBean was being published before StorageService had finished initializing. This caused weird errors (ie. AssertionError) when nodetool was queried before StorageService initialization was complete.&lt;/p&gt;

&lt;p&gt;The fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; was to only publish the JMX interface after StorageService has finished initializing. An unintended side-effect was that StorageServiceMBean is no longer available during bootstrap on 5.0, preventing commands like &quot;nodetool netstats&quot;/&quot;nodetool status&quot;/&quot;nodetool gossipinfo&quot; on the bootstrapping node.&lt;/p&gt;

&lt;p&gt;I created a JVM dtest &lt;a href=&quot;https://github.com/apache/cassandra/pull/3717/commits/b03d7df8fa9405b8b2c2bc7b1cbf2d877d77a2ad&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; based on &lt;tt&gt;GossipTest.testPreventStoppingGossipDuringBootstrap&lt;/tt&gt;. This test passes on 4.1 while fails on 5.0, indicating there was an uncaught change of behavior introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The fix on 5.0 is straightforward: publish StorageServiceMbean on StorageService.initServer before bootstrap starts and not only after it finishes (done &lt;a href=&quot;https://github.com/apache/cassandra/pull/3717/commits/bb45635ff4abaa9b5d6d2984b0f888323200fe19&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Interestingly on trunk the StorageServiceMbean is being published during bootstrap as expected as this was fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19384&quot; title=&quot;Avoid exposing intermediate node state during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19384&quot;&gt;&lt;del&gt;CASSANDRA-19384&lt;/del&gt;&lt;/a&gt;, but &lt;a href=&quot;https://github.com/apache/cassandra/blob/3f9176318b094c10f996ab7653ce5659ea69018f/test/distributed/org/apache/cassandra/distributed/test/ring/BootstrapTest.java#L328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this test assertion&lt;/a&gt; fails - indicating the node state is being incorrectly reported as &quot;STARTING&quot; instead of &quot;JOINING&quot; during bootstrap.&lt;/p&gt;

&lt;p&gt;I think reason for this is because StorageService.getOperationMode was just returning the actual CMS state &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L3818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;if StorageService.initialized flag is set&lt;/a&gt;, which is not the case while the node is bootstrapping. I think the fix to this is to return the CMS state if the log had finished replaying, &lt;a href=&quot;https://github.com/apache/cassandra/pull/3716/commits/9613e3854ecd2665b091aa0a574fe833fa4ee994&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;done here&lt;/a&gt;. Let me know if this makes sense &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I suspect the root cause for both &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19384&quot; title=&quot;Avoid exposing intermediate node state during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19384&quot;&gt;&lt;del&gt;CASSANDRA-19384&lt;/del&gt;&lt;/a&gt; is because StorageServiceMbean was &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/service/StorageService.java#L490&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;being published in StorageService construtor&lt;/a&gt; before these patches, causing it to be published in the first access to StorageService.instance before the basic server scaffolding was initialized by &lt;tt&gt;CassandraDaemon.setup&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I think the correct fix to the issue above is to publish StorageServiceMbean during StorageService.initServer since at that point everything needed to serve JMX commands should have been initialized and what is not should be guarded by StorageService.initialized flag. I think this allow us to simplify and remove all external uses of StorageService.registerMBeans safely as done &lt;a href=&quot;https://github.com/apache/cassandra/pull/3716/commits/2e9004f7fa100bedfcccbff352c8a47a0435642e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In addition to this I also included these two cosmetic fixes to do some cleanup:&lt;br/&gt;
1) Extract StorageService mbean name to constant (&lt;a href=&quot;https://github.com/apache/cassandra/pull/3716/commits/d94a126cb09ccf8b8869c8e13a0b35dc96ca41ce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;)&lt;br/&gt;
2) Remove StorageService.jmxObjectName since I didn&apos;t find a reason for this variable, seems to have been introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4767&quot; title=&quot;Need some indication of node repair success or failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4767&quot;&gt;&lt;del&gt;CASSANDRA-4767&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://github.com/apache/cassandra/pull/3716/commits/3f9176318b094c10f996ab7653ce5659ea69018f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;I submitted preliminary CI, looks like unrelated failures - will try to get a cleaner run:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0 PR&lt;/a&gt; &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/88/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0-CI&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3716&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk PR&lt;/a&gt; &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/87/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk-CI&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Let me know if you can review this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; since this overlaps with CMS and is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19384&quot; title=&quot;Avoid exposing intermediate node state during startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19384&quot;&gt;&lt;del&gt;CASSANDRA-19384&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17902377" author="krummas" created="Mon, 2 Dec 2024 17:56:22 +0000"  >&lt;p&gt;I&apos;ll review&lt;/p&gt;</comment>
                            <comment id="17902483" author="paulo" created="Tue, 3 Dec 2024 01:40:05 +0000"  >&lt;p&gt;Thanks Marcus! Looks like there are some test failures on 5.0 patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/89/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/89/testReport/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/89/testReport/org.apache.cassandra.distributed.test/RepairTest/Tests___jvm_dtest_jdk11_1_12___testForcedNormalRepairWithOneNodeDown__jdk11_x86_64/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RepairTest.testForcedNormalRepairWithOneNodeDown&lt;/a&gt; looks to be tracked on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18440&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.RepairTest.testForcedNormalRepairWithOneNodeDown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18440&quot;&gt;&lt;del&gt;CASSANDRA-18440&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;TriggersTest and RowCacheTest were calling StorageService.initServer multiple times causing this error when attempting to register StorageServiceMbean:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
java.lang.RuntimeException: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=StorageService
    at org.apache.cassandra.utils.MBeanWrapper$OnException.lambda$static$0(MBeanWrapper.java:365)
    at org.apache.cassandra.utils.MBeanWrapper$PlatformMBeanWrapper.registerMBean(MBeanWrapper.java:184)
    at org.apache.cassandra.utils.MBeanWrapper.registerMBean(MBeanWrapper.java:97)
    at org.apache.cassandra.utils.MBeanWrapper.registerMBean(MBeanWrapper.java:101)
    at org.apache.cassandra.service.StorageService.registerMBeans(StorageService.java:549)
Caused by: javax.management.InstanceAlreadyExistsException: org.apache.cassandra.db:type=StorageService
    at java.management/com.sun.jmx.mbeanserver.Repository.addMBean(Repository.java:436)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Updated these tests to call StorageService.initServer only once on @BeforeClass: &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/5f5098413052baf08a256eac65b6efdbdfafa4fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TriggersTest&lt;/a&gt;, &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/99b6b913f1636b08a81919c7ed68c6a309fd426b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RowCacheTest&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Also updated StorageService.registerMbeans to be idempotent (only log warning if Mbean is already registered): &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/9af38834d62636568593c78f7d349b09c85b8f9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Submitted new 5.0 run: &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/91/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/91/&lt;/a&gt;&lt;br/&gt;
also new trunk run with updates: &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/92/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/92/&lt;/a&gt; (pending)&lt;/p&gt;</comment>
                            <comment id="17902687" author="paulo" created="Tue, 3 Dec 2024 15:25:00 +0000"  >&lt;p&gt;5.0 CI is nearly good, except the test I added &lt;tt&gt;testStorageServiceMBeanIsPublishedOnJMXDuringBootstrap&lt;/tt&gt; &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/91/testReport/org.apache.cassandra.distributed.test.ring/BootstrapTest/Tests___jvm_dtest_jdk11_9_12___testStorageServiceMBeanIsPublishedOnJMXDuringBootstrap__jdk11_x86_64/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failed&lt;/a&gt; due to the use of &lt;tt&gt;MBeanWrapper.getMBeanWrapper&lt;/tt&gt; instead of &lt;tt&gt;MbeanWrapper.instance&lt;/tt&gt; to implement JMX registration idempotency on &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/9af38834d62636568593c78f7d349b09c85b8f9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9af38&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I fixed &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/830dfa0c08c0bd988c76b2b34d418d2c01df2ebc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and resubmitted for 5.0: &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/93/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/93/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Looks like this introduced a couple of &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/92/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failures&lt;/a&gt; on DecommissionTest on trunk - will cancel the patch while I look into it.&lt;/p&gt;</comment>
                            <comment id="17903847" author="paulo" created="Sun, 8 Dec 2024 01:24:09 +0000"  >&lt;p&gt;fixed a few more jvm dtests on &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commits/CASSANDRA-19902-trunk/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19902-trunk&lt;/a&gt; and submitted new run &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/95/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-devbranch-5/95/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;if these look good will cleanup before setting back to patch available&lt;/p&gt;</comment>
                            <comment id="17904575" author="smiklosovic" created="Tue, 10 Dec 2024 16:48:31 +0000"  >&lt;p&gt;I will gladly review too.&lt;/p&gt;</comment>
                            <comment id="17906023" author="smiklosovic" created="Mon, 16 Dec 2024 13:04:24 +0000"  >&lt;p&gt;Looks good on paper, I am just trying to understand what happens when StorageService is indeed available during bootstrap and e.g. various nodetool commands are executed, proceeding just happily because StorageService is there, but StorageService might return meaningless / not accurate results back to nodetool which will try to parse what StorageService returned and for some weird reason it will not be able to.&#160;&lt;/p&gt;

&lt;p&gt;Now it returns something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 $ ./bin/nodetool status
error: No nodes present in the cluster. Has &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node finished starting up?
-- StackTrace --
java.lang.RuntimeException: No nodes present in the cluster. Has &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node finished starting up?
&#160; &#160; &#160; &#160; at org.apache.cassandra.dht.Murmur3Partitioner.describeOwnership(Murmur3Partitioner.java:309)
&#160; &#160; &#160; &#160; at org.apache.cassandra.service.StorageService.getEffectiveOwnership(StorageService.java:4066)
&#160; &#160; &#160; &#160; at org.apache.cassandra.service.StorageService.effectiveOwnershipWithPort(StorageService.java:4098)
&#160; &#160; &#160; &#160; at org.apache.cassandra.service.StorageService.effectiveOwnershipWithPort(StorageService.java:264) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which makes sense (albeit I would get rid of that stacktrace), but I am not sure every command is prepared for cases when StorageService is available, while the node has not boostrapped fully yet.&lt;/p&gt;

&lt;p&gt;We would need to check that every operation in storage service makes sense to be executed even node is not bootstrapped fully and if it is not then we would need to throw like above. &lt;/p&gt;

&lt;p&gt;This also means that we can invoke StorageServiceMBean methods before the node is fully bootstrapped / up. Is not this opening us to various potential problems when we are able to set something prematurely, messing up with the bootstrap process itself? &lt;/p&gt;</comment>
                            <comment id="17928796" author="paulo" created="Thu, 20 Feb 2025 13:43:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; you make a good point, but this is the current behavior pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I propose merging the 5.0 patch to revert to original behavior and make JMX available again during bootstrap, and address trunk on a follow-up ticket since this is a bit more involved due to TCM changes.&lt;/p&gt;

&lt;p&gt;LMK wdyt.&lt;/p&gt;</comment>
                            <comment id="17928832" author="smiklosovic" created="Thu, 20 Feb 2025 15:26:17 +0000"  >&lt;p&gt;I dont know, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; what do you think?&lt;/p&gt;</comment>
                            <comment id="17929607" author="krummas" created="Mon, 24 Feb 2025 08:25:07 +0000"  >&lt;p&gt;sounds good to me&lt;/p&gt;</comment>
                            <comment id="18003520" author="JIRAUSER290337" created="Mon, 7 Jul 2025 13:10:24 +0000"  >&lt;p&gt;Is there a chance this can go in the next fixpack (e.g. 5.0.5). The bug also prevents commands that can change the configuration on the fly to work (e.g. increasing the number of compactors, if the bootstrap is taking a long time because there are index builds for large tables, but to few compactors) in addition to make it more difficult than necessary to understand what is happening in the bootstrapping node.&#160; While JMX is up and is accessible via other means, it makes it awkward not to be able o run nodetool commands during bootstrap.&lt;/p&gt;</comment>
                            <comment id="18003533" author="paulo" created="Mon, 7 Jul 2025 13:50:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alberto.bortolan&quot; class=&quot;user-hover&quot; rel=&quot;alberto.bortolan&quot;&gt;alberto.bortolan&lt;/a&gt; makes sense, I&apos;ll make this a blocker for 5.0.5 and prepare a patch this week.&lt;/p&gt;</comment>
                            <comment id="18005079" author="smiklosovic" created="Mon, 14 Jul 2025 08:04:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt;, where is your patch? Is this still a blocker? Should we still wait before 5.0.5 is staged?&lt;/p&gt;</comment>
                            <comment id="18005170" author="paulo" created="Mon, 14 Jul 2025 15:20:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; I&apos;d like to get this in 5.0.5 if possible - I&apos;ll try to get a patch by EoD.&lt;/p&gt;</comment>
                            <comment id="18005256" author="paulo" created="Tue, 15 Jul 2025 00:14:51 +0000"  >&lt;p&gt;Pushed rebased 5.0 PR that initializes StorageService JMX bean just before bootstrap on &lt;tt&gt;StorageService::init&lt;/tt&gt; and add a regression test: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3717&lt;/a&gt; &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this essentially gets us back to 4.1 state where JMX is available again during bootstrap, but doesn&apos;t ensure all commands will work since this is a more involved refactoring effort.&lt;/li&gt;
	&lt;li&gt;5.0 CI: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/324/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/324/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For trunk the regression test is failing differently, JMX is available during bootstrap but the returned node state is &lt;tt&gt;STARTING&lt;/tt&gt; instead of &lt;tt&gt;JOINING&lt;/tt&gt; which is a behavior change, not sure if&apos;s expected: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3716&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3716&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;trunk CI: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/325/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/325/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I don&apos;t have time to address trunk now and would like to unblock the 5.0 patch so I will mark the trunk regression test as ignored and create a new ticket to address separately.&lt;/p&gt;

&lt;p&gt;Trunk regression test is failing with&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] Testcase: testStorageServiceMBeanIsPublishedOnJMXDuringBootstrap(org.apache.cassandra.distributed.test.ring.BootstrapTest)-_jdk11:      Caused an ERROR
[junit-timeout] java.lang.AssertionError: Should not fail to connect via JMX before bootstrap is completed.
[junit-timeout] java.util.concurrent.ExecutionException: java.lang.AssertionError: Should not fail to connect via JMX before bootstrap is completed.
[junit-timeout]         at java.base/java.util.concurrent.FutureTask.report(FutureTask.java:122)
[junit-timeout]         at java.base/java.util.concurrent.FutureTask.get(FutureTask.java:191)
[junit-timeout]         at org.apache.cassandra.distributed.test.ring.BootstrapTest.testStorageServiceMBeanIsPublishedOnJMXDuringBootstrap(BootstrapTest.java:348)
[junit-timeout]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[junit-timeout]         at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout] Caused by: java.lang.AssertionError: Should not fail to connect via JMX before bootstrap is completed.
[junit-timeout]         at org.apache.cassandra.distributed.test.ring.BootstrapTest.lambda$testStorageServiceMBeanIsPublishedOnJMXDuringBootstrap$10(BootstrapTest.java:331)
[junit-timeout]         at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
[junit-timeout]         at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
[junit-timeout]         at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
[junit-timeout]         at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
[junit-timeout]         at java.base/java.lang.Thread.run(Thread.java:829)
[junit-timeout]         at org.apache.cassandra.distributed.test.ring.BootstrapTest.lambda$testStorageServiceMBeanIsPublishedOnJMXDuringBootstrap$10(BootstrapTest.java:327)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="18009512" author="smiklosovic" created="Thu, 24 Jul 2025 09:56:41 +0000"  >&lt;p&gt;I think it is correct that it returns STARTING instead of JOINING. There is TCM in place in trunk which treats theses things a little bit differently, because the server indeed has not been initialized yet. It would return JOINING if it was in BOOT_REPLACING or BOOTSTRAPPING. &lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; would you give it a quick look?&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L3681-L3682&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L3681-L3682&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18009518" author="smiklosovic" created="Thu, 24 Jul 2025 10:32:43 +0000"  >&lt;p&gt;Actually it is quite suspicious behaviour, if I enrich operationMode() like this&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Mode operationMode()
    {
        NodeId nodeId = ClusterMetadata.current().myNodeId();
        NodeState nodeState1 = ClusterMetadata.current().myNodeState();

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isInitialized())
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Mode.STARTING;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and I put breakpoints while a node starts, it might happen that nodeState1 will be &quot;JOINED&quot; while it will return StorageService.Mode.STARTING just because it was not fully initialized (isInitialized() will return false) which is set to true by StorageService.completeInitialization() at the very end of StorageService.initServer(). Basically operationMode will return STARTING as long as initServer is not at the end. I guess that operationMode() should reflect the mode while initServer() is still running. I am not sure why we would wait so long until the end of initServer to start to return the true mode as is seen via NodeState. &lt;/p&gt;

&lt;p&gt;When I remove &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isInitialized())
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Mode.STARTING;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;from operationMode() then your test in trunk just passes as node&apos;s state will be BOOTSTRAPPING which will translate to Mode.JOINING which your test asserts. I believe this is the correct behavior.&lt;/p&gt;

&lt;p&gt;I will run CI to see where it breaks if I remove it like that.&lt;/p&gt;</comment>
                            <comment id="18009529" author="beobal" created="Thu, 24 Jul 2025 11:09:53 +0000"  >&lt;p&gt;I don&apos;t have the full history in front of me at the moment, but I remember that when we were implementing this for CEP-21 we were careful to preserve behaviour in this area, even where it may have been easy to make it &quot;more logical&quot;. That was quite fiddly, but the python dtests were a great help actually. Of course, there may well have been things we missed, but I&apos;d be quite confident that if this is what trunk does now it&apos;s what trunk/5.0 did at the time, which was before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; landed.&lt;/p&gt;</comment>
                            <comment id="18009545" author="smiklosovic" created="Thu, 24 Jul 2025 11:29:17 +0000"  >&lt;p&gt;Let&apos;s see how CI will look like. Very curious what it breaks.&lt;/p&gt;

&lt;p&gt; Also, for example here (1), there is &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; Mode operationMode = Mode.STARTING;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;removed from StorageService. It was used in isDecommissioned() / isDecommissioning in StorageService but that patch started to do &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isDecommissioned()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; operationMode() == DECOMMISSIONED;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where operationMode() is the method we are discussing above. So, basically, if you called &quot;isDecommissioned&quot; while node was executing initServer() (I know it is weird to call it during that, just for the sake of argument), it would return &quot;STARTING&quot;, which would evaluate whole method correctly by returning false as it is not equal to DECOMMISSIONED but it does not derive that mode from TCM&apos;s NodeState as it should but it is deriving it from the fact that initServer() is not finished yet which is quite strange ...&lt;/p&gt;


&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/pull/3646/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3646/files&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18009557" author="smiklosovic" created="Thu, 24 Jul 2025 11:44:20 +0000"  >&lt;p&gt;What I am not completely sure about is what happens when somebody calls operationMode() while ClusterMetadata.current().myNodeState() would return null. Then null would be fed to that switch .... &lt;/p&gt;

&lt;p&gt;So in that sense &quot;if (!isInitialized())&quot; serves as &quot;insurance&quot; that by the time myNodeState() is called in that method, initServer() finished so it returns something meaningful. &lt;/p&gt;

&lt;p&gt;If that happens (myNodeState is null) I would return STARTING. &lt;/p&gt;</comment>
                            <comment id="18009797" author="paulo" created="Thu, 24 Jul 2025 22:57:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;Of course, there may well have been things we missed, but I&apos;d be quite confident that if this is what trunk does now it&apos;s what trunk/5.0 did at the time, which was before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; landed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;When &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11537&quot; title=&quot;Give clear error when certain nodetool commands are issued before server is ready&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11537&quot;&gt;&lt;del&gt;CASSANDRA-11537&lt;/del&gt;&lt;/a&gt; landed, the mode was set to &lt;tt&gt;JOINING&lt;/tt&gt; before &lt;tt&gt;initServer&lt;/tt&gt; had finished initialization on &lt;a href=&quot;https://github.com/apache/cassandra/blob/035705f49464a4854482e1f1280a7af45f7f0203/src/java/org/apache/cassandra/service/StorageService.java#L1837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StorageService.Init &amp;gt; StorageService.joinTokenRing &amp;gt; StorageService.prepareForBootstrap&lt;/a&gt;, while currently the actual state is only returned after &lt;a href=&quot;#L879&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;StorageService.init&lt;/a&gt; completes which I think is after bootstrap completes. I wouldn&apos;t be surprised this is not caught by a dtest since it&apos;s pretty specific, you&apos;d need to query nodetool netstats operation mode during bootstrap and parse the output to check it&apos;s JOINING.&lt;/p&gt;

&lt;p&gt;I did a quick local test with 2 docker instances and added a sleep &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/dht/BootStrapper.java#L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; simulating a long bootstrap and confirmed that even though &lt;tt&gt;node1&lt;/tt&gt; sees &lt;tt&gt;node2&lt;/tt&gt; as UJ, &lt;tt&gt;node2&lt;/tt&gt; see its operation mode as &lt;tt&gt;STARTING&lt;/tt&gt; instead of the expected &lt;tt&gt;JOINING as in 4.1&lt;/tt&gt;, so I believe this is legit. I believe this mostly affects bootstrap/replace since this is done within StorageService.init.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
$ ./nodetool.sh node1 status -r
Datacenter: datacenter1
=======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address            Load       Tokens  Owns (effective)  Host ID                               Rack
UN  node1              73.91 KiB  16      100.0%            6d194555-f6eb-41d0-c000-000000000001  rack1
UJ  node2.casstest  ?          16      ?                 6d194555-f6eb-41d0-c000-000000000002  rack1

$ ./nodetool.sh node2 netstats
Mode: STARTING
Not sending any streams.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;So in that sense &quot;if (!isInitialized())&quot; serves as &quot;insurance&quot; that by the time myNodeState() is called in that method, initServer() finished so it returns something meaningful. If that happens (myNodeState is null) I would return STARTING.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I would think this is the proper behavior, since it may be possible that CMS has not finished initializing when operationMode() is queried, even though this would be pretty unlikely.&lt;/p&gt;</comment>
                            <comment id="18009988" author="smiklosovic" created="Fri, 25 Jul 2025 16:12:27 +0000"  >&lt;p&gt;It seems to fail a lot of Accord-related tests. Fails as well locally, reverting it to return STARTING until initServer is done passes Accord tests again. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/351/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/351/#showFailuresLink&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Might also fail on something else but that Accord stuff is most visible.&lt;/p&gt;

&lt;p&gt;I am not too eager do deal with that for now. Unfortunately it is more wired to the internals than we thought.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; what do you suggest as next steps? We might just commit that test and ignore it as you suggested. &lt;/p&gt;</comment>
                            <comment id="18010000" author="paulo" created="Fri, 25 Jul 2025 16:53:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Paulo Motta what do you suggest as next steps? We might just commit that test and ignore it as you suggested.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, let&apos;s do that so this does not block 5.0.5 release. Because in any case that&apos;s another potential unrelated issue uncovered by that test that we can investigate in a separate JIRA, and trunk is not affected by &lt;tt&gt;StorageService JMX mbean is not available during bootstrap&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Is 5.0 good to merge as is? Or should we rebase and run another round of tests ?&lt;/p&gt;</comment>
                            <comment id="18010237" author="paulo" created="Mon, 28 Jul 2025 00:57:11 +0000"  >&lt;ul&gt;
	&lt;li&gt;created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20795&quot; title=&quot;Operation mode is STARTING instead of JOINING during bootstrap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20795&quot;&gt;CASSANDRA-20795&lt;/a&gt; to address operation mode issue separately&lt;/li&gt;
	&lt;li&gt;rebased and prepare 5.0 patch for commit: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3717&lt;/a&gt;
	&lt;ul&gt;
		&lt;li&gt;5.0 ci: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/356/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/356/&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added regression test to trunk with &lt;a href=&quot;https://github.com/apache/cassandra/pull/3716/files#diff-6d840066a6a8bd936bf9b5916d6fceb612056bd24c32e3ab5dc28e5503eced97R327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this assertion commented&lt;/a&gt;: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3716&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3716&lt;/a&gt;
	&lt;ul&gt;
		&lt;li&gt;trunk ci: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/357/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/357/&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="18010284" author="smiklosovic" created="Mon, 28 Jul 2025 07:25:26 +0000"  >&lt;p&gt;+1, commencing committing&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13624700">CASSANDRA-20795</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12957248">CASSANDRA-11537</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[paulo]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="13163" cascade-level=""><![CDATA[Code]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1r9qg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353513">5.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/07163cfb5172b8b848e8ecf43581311280154e70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/07163cfb5172b8b848e8ecf43581311280154e70&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;regression dtest + CHANGES.txt&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>