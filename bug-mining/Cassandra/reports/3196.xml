<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8131] Short-circuited query results from collection index query</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8131</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After watching Jonathan&apos;s 2014 summit video, I wanted to give collection indexes a try as they seem to be a fit for a &quot;search by key/values&quot; usage pattern we have in our setup. Doing some test queries that I expect users would do against the table, a short-circuit behavior came up:&lt;/p&gt;

&lt;p&gt;Here&apos;s the whole transcript:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE by_sets (id int PRIMARY KEY, datakeys set&amp;lt;text&amp;gt;, datavars set&amp;lt;text&amp;gt;);
CREATE INDEX by_sets_datakeys ON by_sets (datakeys);
CREATE INDEX by_sets_datavars ON by_sets (datavars);
INSERT INTO by_sets (id, datakeys, datavars) VALUES (1, {&apos;a&apos;}, {&apos;b&apos;});
INSERT INTO by_sets (id, datakeys, datavars) VALUES (2, {&apos;c&apos;}, {&apos;d&apos;});
INSERT INTO by_sets (id, datakeys, datavars) VALUES (3, {&apos;e&apos;}, {&apos;f&apos;});
INSERT INTO by_sets (id, datakeys, datavars) VALUES (4, {&apos;a&apos;}, {&apos;z&apos;});
SELECT * FROM by_sets;

 id | datakeys | datavars
----+----------+----------
  1 |    {&apos;a&apos;} |    {&apos;b&apos;}
  2 |    {&apos;c&apos;} |    {&apos;d&apos;}
  4 |    {&apos;a&apos;} |    {&apos;z&apos;}
  3 |    {&apos;e&apos;} |    {&apos;f&apos;}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We then tried this query which short-circuited:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;a&apos; AND datakeys CONTAINS &apos;c&apos;;

 id | datakeys | datavars
----+----------+----------
  1 |    {&apos;a&apos;} |    {&apos;b&apos;}
  4 |    {&apos;a&apos;} |    {&apos;z&apos;}

(2 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Instead of receveing 3 rows, which match the datakeys CONTAINS &apos;a&apos; AND datakeys CONTAINS &apos;c&apos; we only got the first.&lt;/p&gt;

&lt;p&gt;Doing the same, but with CONTAINS &apos;c&apos; first, ignores the second AND.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;c&apos; AND datakeys CONTAINS &apos;a&apos; ;

 id | datakeys | datavars
----+----------+----------
  2 |    {&apos;c&apos;} |    {&apos;d&apos;}

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also, on a side-note, I have two indexes on both datakeys and datavars. But when trying to run a query such as:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select * from by_sets WHERE datakeys CONTAINS &apos;a&apos; AND datavars CONTAINS &apos;z&apos;;
code=2200 [Invalid query] message=&quot;Cannot execute this query as it might involve data filtering and thus may have unpredictable performance. 
If you want to execute this query despite the performance unpredictability, use ALLOW FILTERING&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The second column, after AND (even if I inverse the order) requires an &quot;allow filtering&quot; clause yet the column is indexed an an in-memory &quot;join&quot; of the primary keys of these sets on the coordinator could build up the result.&lt;/p&gt;

&lt;p&gt;Could anyone explain the short-circuit behavior?&lt;br/&gt;
And the requirement for &quot;allow-filtering&quot; on a secondly indexed column?&lt;/p&gt;

&lt;p&gt;If they&apos;re not bugs but intended they should be documented better, at least their limitations.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Debian Wheezy, Oracle JDK, Cassandra 2.1&lt;/p&gt;</environment>
        <key id="12748725">CASSANDRA-8131</key>
            <summary>Short-circuited query results from collection index query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="Antauri">Catalin Alexandru Zamfir</reporter>
                        <labels>
                            <label>collections</label>
                            <label>cql3</label>
                            <label>cqlsh</label>
                            <label>query</label>
                            <label>queryparser</label>
                            <label>triaged</label>
                    </labels>
                <created>Thu, 16 Oct 2014 21:34:05 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:31 +0000</updated>
                            <resolved>Tue, 21 Oct 2014 14:41:32 +0000</resolved>
                                        <fixVersion>2.1.1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14174567" author="mshuler" created="Fri, 17 Oct 2014 01:06:16 +0000"  >&lt;p&gt;On the cassandra-2.1 branch, commit 440824c, I get some different behavior:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mshuler@hana:~$ cqlsh 
Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.1.1-SNAPSHOT | CQL spec 3.2.0 | Native protocol v3]
Use HELP for help.
cqlsh&amp;gt; CREATE KEYSPACE test WITH replication = {&apos;class&apos;: &apos;SimpleStrategy&apos; , &apos;replication_factor&apos;: 1 };
cqlsh&amp;gt; USE test ;
cqlsh:test&amp;gt; CREATE TABLE by_sets (id int PRIMARY KEY, datakeys set&amp;lt;text&amp;gt;, datavars set&amp;lt;text&amp;gt;);
cqlsh:test&amp;gt; CREATE INDEX by_sets_datakeys ON by_sets (datakeys);
cqlsh:test&amp;gt; CREATE INDEX by_sets_datavars ON by_sets (datavars);
cqlsh:test&amp;gt; INSERT INTO by_sets (id, datakeys, datavars) VALUES (1, {&apos;a&apos;}, {&apos;b&apos;});
cqlsh:test&amp;gt; INSERT INTO by_sets (id, datakeys, datavars) VALUES (2, {&apos;c&apos;}, {&apos;d&apos;});
cqlsh:test&amp;gt; INSERT INTO by_sets (id, datakeys, datavars) VALUES (3, {&apos;e&apos;}, {&apos;f&apos;});
cqlsh:test&amp;gt; INSERT INTO by_sets (id, datakeys, datavars) VALUES (4, {&apos;a&apos;}, {&apos;z&apos;});
cqlsh:test&amp;gt; SELECT * FROM by_sets;

 id | datakeys | datavars
----+----------+----------
  1 |    {&apos;a&apos;} |    {&apos;b&apos;}
  2 |    {&apos;c&apos;} |    {&apos;d&apos;}
  4 |    {&apos;a&apos;} |    {&apos;z&apos;}
  3 |    {&apos;e&apos;} |    {&apos;f&apos;}

(4 rows)
cqlsh:test&amp;gt; SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;a&apos; AND datakeys CONTAINS &apos;c&apos;;

 id | datakeys | datavars
----+----------+----------

(0 rows)
cqlsh:test&amp;gt; SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;c&apos; AND datakeys CONTAINS &apos;a&apos; ;

 id | datakeys | datavars
----+----------+----------

(0 rows)
cqlsh:test&amp;gt; SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;a&apos;;

 id | datakeys | datavars
----+----------+----------
  1 |    {&apos;a&apos;} |    {&apos;b&apos;}
  4 |    {&apos;a&apos;} |    {&apos;z&apos;}

(2 rows)
cqlsh:test&amp;gt; SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;c&apos;;

 id | datakeys | datavars
----+----------+----------
  2 |    {&apos;c&apos;} |    {&apos;d&apos;}

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14174860" author="antauri" created="Fri, 17 Oct 2014 08:53:17 +0000"  >&lt;p&gt;Here&apos;s our version of Cassandra (if it helps):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# Note our keyspace has NetworkTopologyStrategy and RF: 3.

[cqlsh 5.0.1 | Cassandra 2.1.0 | CQL spec 3.2.0 | Native protocol v3]
Use HELP for help.
cqlsh&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14174954" author="slebresne" created="Fri, 17 Oct 2014 11:38:55 +0000"  >&lt;p&gt;I don&apos;t really remember which issue fixed that, but it appears to have been fixed since 2.1.0 given what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt; reports (you are wrong in assuming that {{ SELECT * FROM by_sets WHERE datakeys CONTAINS &apos;a&apos; AND datakeys CONTAINS &apos;c&apos;;}} should return 3 rows. It&apos;s a &lt;tt&gt;AND&lt;/tt&gt;, you&apos;re asking for the row whose &lt;tt&gt;datakeys&lt;/tt&gt; contains both &apos;a&apos; and &apos;c&apos;, and no row match that).&lt;/p&gt;

&lt;p&gt;That said, there is a small validation bug in that we shouldn&apos;t be allowing those queries (the ones with 2 &lt;tt&gt;CONTAINS&lt;/tt&gt;) without &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; since we do use server side filtering to handle those. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; can you have a look at why that is?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;requires an &quot;allow filtering&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Any 2ndary index query that that has more than one restriction will require &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; because server side we only ever query a 2ndary index with one expression, and we filter out results if there is more expressions. And that is exactly the definition of when &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; is required.&lt;/p&gt;</comment>
                            <comment id="14175030" author="antauri" created="Fri, 17 Oct 2014 12:57:16 +0000"  >&lt;p&gt;True. I was threw off by the &quot;CONTAINS&quot; which I interpreted as a search, basically linking to &quot;searches&quot; (CONTAINS) in the same result set (at least in my mind). Cassandra does not support OR to reach the goal we&apos;re trying to achieve.&lt;/p&gt;

&lt;p&gt;Instead, I&apos;ve tried this, which I guess it&apos;s already fixed (should have returned one row):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;insert into by_sets (id, datakeys, datavars) values (5, {&apos;a&apos;, &apos;c&apos;}, {&apos;q&apos;});
select * from by_sets WHERE datakeys CONTAINS &apos;a&apos; AND datakeys CONTAINS &apos;c&apos; ;

 id | datakeys   | datavars
----+------------+----------
  5 | {&apos;a&apos;, &apos;c&apos;} |    {&apos;q&apos;}
  1 |      {&apos;a&apos;} |    {&apos;b&apos;}
  4 |      {&apos;a&apos;} |    {&apos;z&apos;}

(3 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14176905" author="blerer" created="Mon, 20 Oct 2014 13:54:01 +0000"  >&lt;p&gt;The problem was coming from the fact the code was checking the number of restrictions and that contains and contains key relations were merge into one restriction.&lt;/p&gt;</comment>
                            <comment id="14176976" author="antauri" created="Mon, 20 Oct 2014 15:26:00 +0000"  >&lt;p&gt;What 2.1 minor version do you think will have this fix available? I currently cannot apply the patch, as our DevOps use only officially released versions but would like to re-test this scenario again in a later version.&lt;/p&gt;</comment>
                            <comment id="14177530" author="mshuler" created="Mon, 20 Oct 2014 21:46:29 +0000"  >&lt;p&gt;I updated the fixVer to 2.1.2 - 2.1.1 is currently being voted on, so we&apos;ll try to commit to the next release.&lt;/p&gt;</comment>
                            <comment id="14178215" author="slebresne" created="Tue, 21 Oct 2014 09:56:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;What 2.1 minor version do you think will have this fix available?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you mean, in which minor version will the query return the right result (i.e. nothing), then it will be 2.1.1. The patch on this ticket will probably only make 2.1.2, but that patch only fix the &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; validation issue.&lt;/p&gt;</comment>
                            <comment id="14178225" author="slebresne" created="Tue, 21 Oct 2014 10:11:22 +0000"  >&lt;p&gt;Regarding the patch, mostly lgtm but 2 minor nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The &lt;tt&gt;Iterables.getLast&lt;/tt&gt; in &lt;tt&gt;needFiltering&lt;/tt&gt; feels misguiding in that there is no reason to use the last. It just happen that we&apos;re in a branch where &lt;tt&gt;stmt.restrictedColumns&lt;/tt&gt; can only have one element and we want that single element. So I&apos;d rather use &lt;tt&gt;Iterables.getOnlyElement&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;isRestrictedByMultipleContains&lt;/tt&gt;, I&apos;d either check that &lt;tt&gt;metadataRestrictions.get()&lt;/tt&gt; don&apos;t return &lt;tt&gt;null&lt;/tt&gt; or at least assert it (I know it can&apos;t be &lt;tt&gt;null&lt;/tt&gt; in the context of this patch, but it would be easy to misuse that method in the future). Similarly, I&apos;d add a &lt;tt&gt;instanceof Contains&lt;/tt&gt; on the result of that &lt;tt&gt;get&lt;/tt&gt; so that we don&apos;t have a bug waiting to happen if we ever allow other type of restriction on collections.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14178331" author="blerer" created="Tue, 21 Oct 2014 12:15:41 +0000"  >&lt;p&gt;This patch use &lt;tt&gt;getOnlyElement&lt;/tt&gt; instead of &lt;tt&gt;getLast&lt;/tt&gt; and add an &lt;tt&gt;instanceof Contains&lt;/tt&gt; in &lt;tt&gt;isRestrictedByMultipleContains&lt;/tt&gt;.&lt;br/&gt;
I did not check for null because the instanceof is already doing it.&lt;/p&gt;</comment>
                            <comment id="14178463" author="slebresne" created="Tue, 21 Oct 2014 14:41:32 +0000"  >&lt;p&gt;Committed (to 2.1.1 after all since we&apos;ll have to re-roll and that&apos;s a simple one), thanks.&lt;/p&gt;</comment>
                            <comment id="14202700" author="antauri" created="Fri, 7 Nov 2014 21:18:28 +0000"  >&lt;p&gt;You probably don&apos;t get this too often, but we just got it fixed with the normal updates today. I&apos;d just wanna say: &quot;Thank you!&quot; if it means something to your team.&lt;/p&gt;</comment>
                            <comment id="14203148" author="jbellis" created="Sat, 8 Nov 2014 02:22:20 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12676080" name="CASSANDRA-8131-V2.txt" size="8486" author="blerer" created="Tue, 21 Oct 2014 12:15:41 +0000"/>
                            <attachment id="12675824" name="CASSANDRA-8131.txt" size="8354" author="blerer" created="Mon, 20 Oct 2014 13:54:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i219of:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>