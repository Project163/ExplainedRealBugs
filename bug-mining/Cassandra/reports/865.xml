<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2514] batch_mutate operations with CL=LOCAL_QUORUM throw TimeOutException when there aren&apos;t sufficient live nodes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2514</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a 2 DC setup with RF = 4. There are 2 nodes in each DC. Following is the keyspace definition:&lt;br/&gt;
&amp;lt;snip&amp;gt;&lt;br/&gt;
keyspaces:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;name: KeyspaceMetadata&lt;br/&gt;
      replica_placement_strategy: org.apache.cassandra.locator.NetworkTopologyStrategy&lt;br/&gt;
      strategy_options:&lt;br/&gt;
        DC1 : 2&lt;br/&gt;
        DC2 : 2&lt;br/&gt;
      replication_factor: 4&lt;br/&gt;
&amp;lt;/snip&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I shutdown all except one node and waited for the live node to recognize that other nodes are dead. Following is the nodetool ring output on the live node:&lt;br/&gt;
Address         Status State   Load            Owns    Token                                       &lt;br/&gt;
                                                       169579575332184635438912517119426957796     &lt;br/&gt;
10.17.221.19    Down   Normal  ?               29.20%  49117425183422571410176530597442406739      &lt;br/&gt;
10.17.221.17    Up     Normal  81.64 KB        4.41%   56615248844645582918169246064691229930      &lt;br/&gt;
10.16.80.54     Down   Normal  ?               21.13%  92563519227261352488017033924602789201      &lt;br/&gt;
10.17.221.18    Down   Normal  ?               45.27%  169579575332184635438912517119426957796     &lt;/p&gt;

&lt;p&gt;I expect UnavailableException when I send batch_mutate request to node that is up. However, it returned TimeOutException:&lt;br/&gt;
TimedOutException()&lt;br/&gt;
    at org.apache.cassandra.thrift.Cassandra$batch_mutate_result.read(Cassandra.java:16493)&lt;br/&gt;
    at org.apache.cassandra.thrift.Cassandra$Client.recv_batch_mutate(Cassandra.java:916)&lt;br/&gt;
    at org.apache.cassandra.thrift.Cassandra$Client.batch_mutate(Cassandra.java:890)&lt;/p&gt;

&lt;p&gt;Following is the cassandra-topology.properties&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Cassandra Node IP=Data Center:Rack&lt;br/&gt;
10.17.221.17=DC1:RAC1&lt;br/&gt;
10.17.221.19=DC1:RAC2&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;10.17.221.18=DC2:RAC1&lt;br/&gt;
10.16.80.54=DC2:RAC2&lt;/p&gt;</description>
                <environment>&lt;p&gt;1. Cassandra 0.7.4 running on RHEL 5.5&lt;br/&gt;
2. 2 DC setup&lt;br/&gt;
3. RF = 4 (DC1 = 2, DC2 = 2)&lt;br/&gt;
4. CL = LOCAL_QUORUM&lt;/p&gt;</environment>
        <key id="12504738">CASSANDRA-2514</key>
            <summary>batch_mutate operations with CL=LOCAL_QUORUM throw TimeOutException when there aren&apos;t sufficient live nodes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nar3ndra">Narendra Sharma</assignee>
                                    <reporter username="nar3ndra">Narendra Sharma</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Apr 2011 00:29:23 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:01 +0000</updated>
                            <resolved>Wed, 20 Apr 2011 18:16:02 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13021875" author="nar3ndra" created="Wed, 20 Apr 2011 00:37:43 +0000"  >&lt;p&gt;I think the issue is because DatacenterWriteResponseHandler.assureSufficientLiveNodes is not checking for live nodes.&lt;/p&gt;

&lt;p&gt;DatacenterWriteResponseHandler.assureSufficientLiveNodes works on writeEndpoints. writeEndpoints contains list of the all the endpoints (may be more if there are nodes bootstrapping).&lt;/p&gt;

&lt;p&gt;I think either writeEndpoints should ignore dead/unreachable nodes or DatacenterWriteResponseHandler.assureSufficientLiveNodes should use hintedEndpoints.keySet() as that contains the live endpoints.&lt;br/&gt;
I compared the implementation with WriteResponseHandler.assureSufficientLiveNodes and found that it uses hintedEndpoints.&lt;/p&gt;


&lt;p&gt;I am attaching the patch that works for me.&lt;/p&gt;</comment>
                            <comment id="13021877" author="nar3ndra" created="Wed, 20 Apr 2011 00:41:08 +0000"  >&lt;p&gt;Use hintedEndpoints instead of writeEndpoints to work on live endpoints only.&lt;/p&gt;</comment>
                            <comment id="13021883" author="nar3ndra" created="Wed, 20 Apr 2011 00:52:25 +0000"  >&lt;p&gt;The code to reproduce this issue is a simple batch mutate operation. The operation I performed involved adding 2 columns to a SuperColumn. Let me know if it is not reproducible. I will provide the sample code.&lt;/p&gt;</comment>
                            <comment id="13022199" author="jbellis" created="Wed, 20 Apr 2011 16:32:18 +0000"  >&lt;p&gt;Good catch, that is a bug.&lt;/p&gt;

&lt;p&gt;v2 adds a couple improvements:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;only count the hinted endpoint towards live count if it&apos;s a normal write destination (hints can be sent elsewhere if all the write destinations are dead)&lt;/li&gt;
	&lt;li&gt;similar fix for DSWRH (EACH_QUORUM)&lt;/li&gt;
	&lt;li&gt;unrelated fix in WRH for CL.ANY not to continue through to the CL.Q/ALL code&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13022200" author="jbellis" created="Wed, 20 Apr 2011 16:32:55 +0000"  >&lt;p&gt;how does that look to you?&lt;/p&gt;</comment>
                            <comment id="13022238" author="nar3ndra" created="Wed, 20 Apr 2011 17:22:08 +0000"  >&lt;p&gt;Looks good to me. &lt;/p&gt;

&lt;p&gt;Just one comment/question:&lt;br/&gt;
hintedEndpoints is subset of writeEndpoints. So is the additional check writeEndpoints.contains(destination), while we are iterating over hintedEndpoints, needed? I think assert would be better here.&lt;/p&gt;
</comment>
                            <comment id="13022248" author="jbellis" created="Wed, 20 Apr 2011 17:32:02 +0000"  >&lt;p&gt;That&apos;s the point, hintedEndpoints is &lt;b&gt;usually&lt;/b&gt; but not always a subset of writeEndpoints. Here is the code from getHintedEndpoints:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// assign dead endpoints to be hinted to the closest live one, or to the local node
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// (since it is trivially the closest) &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; none are alive.  This way, the cost of doing
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// a hint is only adding the hint header, rather than doing a full extra write, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; any
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// destination nodes are alive.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a 2nd pass on targets instead of using temporary storage,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// to optimize &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the common &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (everything was alive).
&lt;/span&gt;        InetAddress localAddress = FBUtilities.getLocalAddress();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InetAddress ep : targets)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (map.containsKey(ep))
                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!StorageProxy.shouldHint(ep))
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (logger.isDebugEnabled())
                    logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;not hinting &quot;&lt;/span&gt; + ep + &lt;span class=&quot;code-quote&quot;&gt;&quot; which has been down &quot;&lt;/span&gt; + Gossiper.instance.getEndpointDowntime(ep) + &lt;span class=&quot;code-quote&quot;&gt;&quot;ms&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
            }

            InetAddress destination = map.isEmpty()
                                    ? localAddress
                                    : snitch.getSortedListByProximity(localAddress, map.keySet()).get(0);
            map.put(destination, ep);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13022249" author="jbellis" created="Wed, 20 Apr 2011 17:33:25 +0000"  >&lt;p&gt;that is: our last-resort local hint storage may not be part of writeEndpoints (probably won&apos;t be, on a large cluster).&lt;/p&gt;</comment>
                            <comment id="13022258" author="nar3ndra" created="Wed, 20 Apr 2011 17:53:45 +0000"  >&lt;p&gt;Got it. In my setup I had HH disabled. So I overlooked the rest of the getHintedEndpoints.&lt;/p&gt;

&lt;p&gt;The change looks good to me now. Thanks!&lt;/p&gt;
</comment>
                            <comment id="13022267" author="jbellis" created="Wed, 20 Apr 2011 18:16:02 +0000"  >&lt;p&gt;committed, thanks!&lt;/p&gt;</comment>
                            <comment id="13022332" author="hudson" created="Wed, 20 Apr 2011 19:46:08 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #451 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/Cassandra-0.7/451/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/hudson/job/Cassandra-0.7/451/&lt;/a&gt;)&lt;br/&gt;
    fixes for verifying destinationavailability under hinted conditions&lt;br/&gt;
patch by Narendra Sharma and jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2514&quot; title=&quot;batch_mutate operations with CL=LOCAL_QUORUM throw TimeOutException when there aren&amp;#39;t sufficient live nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2514&quot;&gt;&lt;del&gt;CASSANDRA-2514&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476909" name="2514-v2.txt" size="2568" author="jbellis" created="Wed, 20 Apr 2011 16:32:18 +0000"/>
                            <attachment id="12476809" name="CASSANDRA-2514.patch" size="696" author="nar3ndra" created="Wed, 20 Apr 2011 00:41:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[nar3ndra]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20667</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbtb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93344</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>