<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:29:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19187] nodetool assassinate may cause thread serialization for that node</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19187</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When assassinate an ip address that is not in the gossip map, a &quot;corrupted&quot; entry will be inserted into the gossip map. &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/gms/Gossiper.java#L810&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;(1)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For example, if we do &quot;nodetool assassinate 10.1.1.1&quot;&lt;/p&gt;

&lt;p&gt;we will get an entry like below by running &quot;nodetool gossipinfo&quot;:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/10.1.1.1
&#160; generation:1702006511
&#160; heartbeat:9999
&#160; STATUS:209516:LEFT,-8393921141401589197,1702265651923
&#160; STATUS_WITH_PORT:209515:LEFT,-8393921141401589197,1702265651923
&#160; TOKENS: not present &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This entry in endpointStateMap will cause issue for &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/gms/Gossiper.java#L2284&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;isUpgradingFromVersionLowerThan&lt;/a&gt; function. Because the &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/gms/Gossiper.java#L191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgradeFromVersionSupplier&lt;/a&gt; supplier will always set the &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/gms/Gossiper.java#L216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;allHostsHaveKnownVersion&lt;/a&gt; flag to false so no memoized value will be returned. The &quot;get&quot; function will always require a lock from this &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/ExpiringMemoizingSupplier.java#L66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If application is using &quot;fetchAll&quot;, the native-transport-requests thread will hit this &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/db/filter/ColumnFilter.java#L574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt;. This means all the native-transport-requests thread is serialized, also, the lock is shared by GossipStage threads. It means if a node in a cluster with the corrupted gossip map is restart, the node will run into this problem.&lt;/p&gt;

&lt;p&gt;To fix the issue,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Why we want to add a dummy entry for nodetool assassinate if the endpoint is not in the map anymore. Should we do nothing or throw exception if the node is not in the gossip map anymore?&lt;/li&gt;
	&lt;li&gt;Before checking if a version is null, we should make sure the node is not a dead node. A decommissioned node, a left node should not be considered part of the cluster anymore when calculating &quot;upgradeInProgressPossible&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13561189">CASSANDRA-19187</key>
            <summary>nodetool assassinate may cause thread serialization for that node</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curlylrt">Runtian Liu</assignee>
                                    <reporter username="curlylrt">Runtian Liu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Dec 2023 17:58:59 +0000</created>
                <updated>Tue, 26 Mar 2024 10:38:28 +0000</updated>
                            <resolved>Thu, 11 Jan 2024 11:19:48 +0000</resolved>
                                        <fixVersion>4.0.12</fixVersion>
                    <fixVersion>4.1.4</fixVersion>
                    <fixVersion>5.0-rc1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Cluster/Membership</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17794824" author="brandon.williams" created="Fri, 8 Dec 2023 18:16:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why we want to add a dummy entry for nodetool assassinate if the endpoint is not in the map anymore. Should we do nothing or throw exception if the node is not in the gossip map anymore?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is intentional to insert a dummy entry if the node doesn&apos;t exist, because there can be an issue where a node is quickly being discovered and expiring, and throwing an exception makes it very difficult to assassinate that node.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Before checking if a version is null, we should make sure the node is not a dead node. A decommissioned node, a left node should not be considered part of the cluster anymore when calculating &quot;upgradeInProgressPossible&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, this is what needs to be fixed.&lt;/p&gt;</comment>
                            <comment id="17794915" author="JIRAUSER291682" created="Sat, 9 Dec 2023 05:15:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; , please review the PR: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If this looks good, I&apos;ll create pull request for 4.1 and 5.0 as well. Since we have TCM merged in trunk, I think this gossip related code should not be needed?&lt;/p&gt;</comment>
                            <comment id="17794942" author="brandon.williams" created="Sat, 9 Dec 2023 11:12:46 +0000"  >&lt;p&gt;This looks good to me, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt;.  I don&apos;t think we need this in trunk due to TCM as you say, but maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; can confirm.&lt;/p&gt;</comment>
                            <comment id="17795657" author="beobal" created="Tue, 12 Dec 2023 09:49:50 +0000"  >&lt;p&gt;Seems right, this specific instance of checking cluster versions via gossip was removed in 5.0 because we don&apos;t support upgrades from &amp;lt; 4.0 there, but in general we can more reliably get peer version info from &lt;tt&gt;ClusterMetadata.current.directory&lt;/tt&gt; now.&lt;/p&gt;</comment>
                            <comment id="17795917" author="brandon.williams" created="Tue, 12 Dec 2023 20:01:12 +0000"  >&lt;p&gt;Thanks, Sam!&lt;/p&gt;</comment>
                            <comment id="17796502" author="JIRAUSER291682" created="Thu, 14 Dec 2023 00:35:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; please review:&lt;/p&gt;

&lt;p&gt;4.0 : &lt;a href=&quot;https://github.com/apache/cassandra/pull/2978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.1: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2992&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5.0: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2993&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17796891" author="brandon.williams" created="Thu, 14 Dec 2023 20:00:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; that 4.0 link is for another ticket. I used the one you originally linked &lt;a href=&quot;https://github.com/apache/cassandra/pull/2978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1416/workflows/2cafb3ad-057c-4fa4-a638-f8877912c60d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1416/workflows/d4e03537-c49e-4e2d-8910-156d23732321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1414/workflows/a019c2cd-64b5-4b57-a554-5881de6fd3c7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1414/workflows/11889dfa-7d86-4fb7-a713-874dfc3a0552&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1415/workflows/821eb0bd-9af4-48a9-a50e-a9e1aab75a4e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1415/workflows/54d783aa-3fca-4531-9a80-6ab8b47472b2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17796898" author="JIRAUSER291682" created="Thu, 14 Dec 2023 20:34:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; , thanks, updated the 4.0 link.&lt;/p&gt;</comment>
                            <comment id="17796907" author="brandon.williams" created="Thu, 14 Dec 2023 21:09:28 +0000"  >&lt;p&gt;Unfortunately there seems to be some flakiness in testAssassinatedNodeWillNotContributeToVersionCalculation.&lt;/p&gt;</comment>
                            <comment id="17797000" author="JIRAUSER291682" created="Fri, 15 Dec 2023 04:31:00 +0000"  >&lt;p&gt;Updated the test&lt;/p&gt;</comment>
                            <comment id="17797166" author="brandon.williams" created="Fri, 15 Dec 2023 12:45:42 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1417/workflows/df7032b2-c33b-4960-936e-fa817131de34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1417/workflows/d42eb7de-0b45-492c-ab20-7143c4e33537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1419/workflows/11ffc188-d516-4287-a78d-e213e38eb055&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1419/workflows/a75fa383-0e9c-429a-ba52-962e04bf6cfc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1418/workflows/1041ab90-3cf4-46a4-9062-6cc1d3d20741&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1418/workflows/5d108993-69f8-4bb8-a616-93a1d904ff1a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17797263" author="brandon.williams" created="Fri, 15 Dec 2023 17:31:16 +0000"  >&lt;p&gt;Looks like it still had a &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1417/workflows/d42eb7de-0b45-492c-ab20-7143c4e33537/jobs/67140/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17797876" author="JIRAUSER291682" created="Sun, 17 Dec 2023 05:03:48 +0000"  >&lt;p&gt;Updated the test, I&apos;m not able to reproduce the failure though.&lt;/p&gt;</comment>
                            <comment id="17799184" author="JIRAUSER291682" created="Wed, 20 Dec 2023 22:00:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; could you please try the tests again?&lt;/p&gt;</comment>
                            <comment id="17801773" author="brandon.williams" created="Tue, 2 Jan 2024 12:55:09 +0000"  >&lt;p&gt;I&apos;ve started just the repeated test for 4.0 &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1420/workflows/a9d53818-ee40-43f3-a9a3-e57087a5a0a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17801876" author="brandon.williams" created="Tue, 2 Jan 2024 17:38:33 +0000"  >&lt;p&gt;Just the repeated tests:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1420/workflows/0a168da1-c2e8-4da4-b001-ae9f96e95588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1420/workflows/a9d53818-ee40-43f3-a9a3-e57087a5a0a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1421/workflows/08063fdc-5449-4934-b2cc-29a6b0012ce6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1421/workflows/35092cdc-37fa-456f-91c4-760285917cdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1422/workflows/6877cced-1df0-4b1c-8d66-34cebcf2e8dc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1422/workflows/8f57d636-542e-457d-a3de-4930af0d9b02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17801884" author="brandon.williams" created="Tue, 2 Jan 2024 17:56:57 +0000"  >&lt;p&gt;Everything passed, +1 from me.&lt;/p&gt;</comment>
                            <comment id="17802087" author="smiklosovic" created="Wed, 3 Jan 2024 09:34:15 +0000"  >&lt;p&gt;Just a heads-up that &quot;hasMajorVersion3Nodes&quot; method in Gossiper which is used in tests in the patches for this ticket will change its name here &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/ba01b094bcb50766b3dae2da6e4e5dde4579b829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pauloricardomg/cassandra/commit/ba01b094bcb50766b3dae2da6e4e5dde4579b829&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That is patch for 5.0 for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18999&quot; title=&quot;Gossiper::hasMajorVersion3Nodes returns true when a cluster is upgrading patch version without Cassandra 3 nodes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18999&quot;&gt;&lt;del&gt;CASSANDRA-18999&lt;/del&gt;&lt;/a&gt; (similar renaming will be done in 4.0 and 4.1) &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; is driving the merge of that, all is done, we just seem to struggle to run upgrade dtests in Circle due to our free plans for branches of 4.0, 4.1, 5.0, please find the details here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18999?focusedCommentId=17801825&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17801825&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-18999?focusedCommentId=17801825&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17801825&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So, just saying, that if we happen to merge &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18999&quot; title=&quot;Gossiper::hasMajorVersion3Nodes returns true when a cluster is upgrading patch version without Cassandra 3 nodes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18999&quot;&gt;&lt;del&gt;CASSANDRA-18999&lt;/del&gt;&lt;/a&gt; first, then the renaming of that method will need to be reflected in this patch too. The logic of that method is changed slightly as well. &lt;/p&gt;</comment>
                            <comment id="17802089" author="smiklosovic" created="Wed, 3 Jan 2024 09:34:55 +0000"  >&lt;p&gt;I am +1 on this, just keep in mind my last comment upon merge.&lt;/p&gt;</comment>
                            <comment id="17802148" author="brandon.williams" created="Wed, 3 Jan 2024 12:40:56 +0000"  >&lt;p&gt;Actually, I&apos;m not sure about this test fix.  How does asserting that we can memoize help us?&lt;/p&gt;</comment>
                            <comment id="17802165" author="smiklosovic" created="Wed, 3 Jan 2024 13:00:11 +0000"  >&lt;p&gt;I asked here if that is what you mean (1). After looking at it I think that might be just reverted?&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/pull/2993#discussion_r1429182591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2993#discussion_r1429182591&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17802166" author="brandon.williams" created="Wed, 3 Jan 2024 13:02:22 +0000"  >&lt;p&gt;If we go back to asserting the version is null, that is what makes the test flaky, though.&lt;/p&gt;</comment>
                            <comment id="17802180" author="smiklosovic" created="Wed, 3 Jan 2024 13:49:05 +0000"  >&lt;p&gt;I am not sure what is behind that flakiness yet. Can somebody elaborate on that? In order to get null there, we return NO_UPGRADE_IN_PROGRESS from upgradeFromVersionSupplier ? What is flaky about that? I shall return to this later ... &lt;/p&gt;</comment>
                            <comment id="17802229" author="brandon.williams" created="Wed, 3 Jan 2024 15:52:37 +0000"  >&lt;p&gt;I suspect we need to figure out why the endpoint state map&apos;s size was not 4 one time in the original flaky result.  If we explicitly add 3 states and then assassinate another non-existing node it should be 4, so something odd is happening here.  That said, I also suspect this is all just a test issue.&lt;/p&gt;</comment>
                            <comment id="17802298" author="JIRAUSER291682" created="Wed, 3 Jan 2024 18:41:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; the reason it was flaky for checking the size of the map was that the first 3 states may get removed because of this &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/gms/Gossiper.java#L1062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If the test took longer, the second and third state will be removed because they have been silent for too long. The 3 states/nodes are not set properly and for the purpose of this test, we don&apos;t really care about they other 3 nodes, we just need to make sure the non-existing node is in the state map.&lt;/p&gt;</comment>
                            <comment id="17802316" author="brandon.williams" created="Wed, 3 Jan 2024 20:30:14 +0000"  >&lt;p&gt;I see, thanks, that makes sense.  I guess that leaves us with...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In order to get null there, we return NO_UPGRADE_IN_PROGRESS from upgradeFromVersionSupplier ? What is flaky about that?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem is that sometimes we don&apos;t get null as we expect, but instead get the current version, as seen &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1417/workflows/d42eb7de-0b45-492c-ab20-7143c4e33537/jobs/67140/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17803436" author="smiklosovic" created="Fri, 5 Jan 2024 07:29:46 +0000"  >&lt;p&gt;Do I get it right this is not ready for the commit then? I think until we answer remaining questions about the flakiness etc we can&apos;t ship that ... &lt;/p&gt;</comment>
                            <comment id="17803534" author="brandon.williams" created="Fri, 5 Jan 2024 12:57:01 +0000"  >&lt;p&gt;That matches my read on the situation.&lt;/p&gt;</comment>
                            <comment id="17803680" author="JIRAUSER291682" created="Fri, 5 Jan 2024 18:59:34 +0000"  >&lt;p&gt;Do we know how many times the repeat tests have run before it failed? Not sure why it failed but could we try the repeat test again with reverting the last commit? I mean it should pass even without last commit. I tried to reproduce this but I couldn&apos;t.&lt;/p&gt;</comment>
                            <comment id="17803693" author="brandon.williams" created="Fri, 5 Jan 2024 20:15:20 +0000"  >&lt;p&gt;The repeated test is set to run for 500 iterations, so it was less than that but we don&apos;t know exactly.  I did a couple of runs with the last commit reverted and it also failed under 500 iterations both times, and I ran it in isolation where the default runs the whole class, so at least we know it&apos;s not interference from another test.&lt;/p&gt;</comment>
                            <comment id="17803716" author="JIRAUSER291682" created="Fri, 5 Jan 2024 22:50:10 +0000"  >&lt;p&gt;Updated the 4.0 pull request to use more proper setup test.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If this works, I&apos;ll update the other two PRs.&lt;/p&gt;</comment>
                            <comment id="17803727" author="brandon.williams" created="Fri, 5 Jan 2024 23:30:06 +0000"  >&lt;p&gt;That passed &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1449/workflows/6135e434-0b2a-43c9-bd15-3a3adf54019d/jobs/70447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1k times&lt;/a&gt; and I also checked the &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1450/workflows/c84aa22d-5bad-4074-a0d7-5811412ca379/jobs/70537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;full class&lt;/a&gt; to be sure.  I think you&apos;ve done it, we just need to do the other branches now.&lt;/p&gt;</comment>
                            <comment id="17803729" author="JIRAUSER291682" created="Fri, 5 Jan 2024 23:45:05 +0000"  >&lt;p&gt;Updated the other two branches as well:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;4.0 :&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2978&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.1:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2992&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5.0:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2993&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17803731" author="brandon.williams" created="Sat, 6 Jan 2024 00:05:19 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-test2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1450/workflows/c84aa22d-5bad-4074-a0d7-5811412ca379/jobs/70537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;repeated&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1452/workflows/ca3174ea-f163-4aef-bc48-d3da4081b8a8/jobs/70748&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;repeated&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19187-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1451/workflows/0629e608-44b2-44c6-aace-0c63e198bb7c/jobs/70749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;repeated&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Everything passed, +1 from me again.&lt;/p&gt;</comment>
                            <comment id="17804167" author="smiklosovic" created="Mon, 8 Jan 2024 08:35:16 +0000"  >&lt;p&gt;I will merge this after we resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18999&quot; title=&quot;Gossiper::hasMajorVersion3Nodes returns true when a cluster is upgrading patch version without Cassandra 3 nodes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18999&quot;&gt;&lt;del&gt;CASSANDRA-18999&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[curlylrt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1m5fc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/ee9e41878258914a5546e65dfd862e122be5d09c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/ee9e41878258914a5546e65dfd862e122be5d09c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Test added, CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>