<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10822] SSTable data loss when upgrading with row tombstone present</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10822</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I ran into an issue when upgrading between 2.1.11 to 3.0.0 (and also cassandra-3.0 branch) where subsequent rows were lost within a partition where there is a row tombstone present.&lt;/p&gt;

&lt;p&gt;Here&apos;s a scenario that reproduces the issue.&lt;/p&gt;

&lt;p&gt;Using ccm create a single node cluster at 2.1.11:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ccm create -n 1 -v 2.1.11 -s financial&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Run the following queries to create schema, populate some data and then delete some data for november:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;drop keyspace if exists financial;

create keyspace if not exists financial with replication = {&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 1 };

create table if not exists financial.symbol_history (
  symbol text,
  name text static,
  year int,
  month int,
  day int,
  volume bigint,
  close double,
  open double,
  low double,
  high double,
  primary key((symbol, year), month, day)
) with CLUSTERING ORDER BY (month desc, day desc);

insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 1, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 2, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 3, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 4, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 5, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 6, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 7, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 8, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 9, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 10, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 11, 1, 100);
insert into financial.symbol_history (symbol, name, year, month, day, volume) values (&apos;CORP&apos;, &apos;MegaCorp&apos;, 2004, 12, 1, 100);

delete from financial.symbol_history where symbol=&apos;CORP&apos; and year = 2004 and month=11;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Flush and run sstable2json on the sole Data.db file:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm node1 flush
sstable2json /path/to/file.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The output should look like the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;CORP:2004&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;::name&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;MegaCorp&quot;&lt;/span&gt;,1449457517033030],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;12:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457517033030],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;12:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457517033030],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;11:_&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;11:!&quot;&lt;/span&gt;,1449457564983269,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,1449457564],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;10:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516313738],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;10:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516313738],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;9:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516310205],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;9:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516310205],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;8:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516235664],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;8:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516235664],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;7:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516233535],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;7:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516233535],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;6:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516231458],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;6:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516231458],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;5:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516228307],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;5:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516228307],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;4:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516225415],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;4:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516225415],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;3:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516222811],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;3:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516222811],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;2:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516220301],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;2:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516220301],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;1:1:&quot;&lt;/span&gt;,&quot;&quot;,1449457516210758],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;1:1:volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457516210758]]}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Prepare for upgrade&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm node1 nodetool snapshot financial
ccm node1 nodetool drain
ccm node1 stop
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Upgrade to cassandra-3.0 and start the node&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm node1 setdir -v git:cassandra-3.0
ccm node1 start
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run command in cqlsh and observe only 1 row is returned!  It appears that all data following november is gone.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; select * from financial.symbol_history;

 symbol | year | month | day | name     | close | high | low  | open | volume
--------+------+-------+-----+----------+-------+------+------+------+--------
   CORP | 2004 |    12 |   1 | MegaCorp |  null | null | null | null |    100
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Upgrade sstables and query again and you&apos;ll observe the same problem.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm node1 nodetool upgradesstables financial
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I modified the 2.2 version of sstable2json so that it works with 3.0 (couldn&apos;t help myself &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;), and observed 2 RangeTombstoneBoundMarker occurrences for 1 delete and the rest of the data missing.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[
{
 &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;CORP:2004&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;&quot;&lt;/span&gt;: {
  &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: {
    [&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;MegaCorp&quot;&lt;/span&gt;,1449457517033030]
  }
 },
 &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt;: [
  {
   &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt;: {&lt;span class=&quot;code-quote&quot;&gt;&quot;month&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;12&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;day&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;},
   &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: {
     [&lt;span class=&quot;code-quote&quot;&gt;&quot;volume&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;100&quot;&lt;/span&gt;,1449457517033030]
   }
  },
  {
   &lt;span class=&quot;code-quote&quot;&gt;&quot;tombstone&quot;&lt;/span&gt;: [&lt;span class=&quot;code-quote&quot;&gt;&quot;11:*&quot;&lt;/span&gt;,1449457564983269,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,1449457564]
  },
  {
   &lt;span class=&quot;code-quote&quot;&gt;&quot;tombstone&quot;&lt;/span&gt;: [&lt;span class=&quot;code-quote&quot;&gt;&quot;11:*&quot;&lt;/span&gt;,1449457564983269,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,1449457564]
  }
 ]
}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not sure why this is happening, but I should point out that I&apos;m using static columns here and that I&apos;m using reverse order for my clustering, so maybe that makes a difference.  I&apos;ll try without static columns / regular ordering to see if that makes a difference and update the ticket.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12919560">CASSANDRA-10822</key>
            <summary>SSTable data loss when upgrading with row tombstone present</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blambov">Branimir Lambov</assignee>
                                    <reporter username="andrew.tolbert">Andy Tolbert</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Dec 2015 03:32:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:48 +0000</updated>
                            <resolved>Mon, 14 Dec 2015 10:14:47 +0000</resolved>
                                        <fixVersion>3.0.2</fixVersion>
                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="15044324" author="andrew.tolbert" created="Mon, 7 Dec 2015 03:41:01 +0000"  >&lt;p&gt;Verified that using static columns, and reversing the clustering order doesn&apos;t make a difference either.&lt;/p&gt;</comment>
                            <comment id="15045321" author="mshuler" created="Mon, 7 Dec 2015 17:42:27 +0000"  >&lt;p&gt;Just so I&apos;m clear, does the same thing happen going through an upgrade of 2.1 -&amp;gt; 2.2 -&amp;gt; 3.0? If that hasn&apos;t been tested, we can probably work on that.&lt;/p&gt;</comment>
                            <comment id="15045324" author="andrew.tolbert" created="Mon, 7 Dec 2015 17:44:46 +0000"  >&lt;p&gt;I haven&apos;t tried it yet, but I agree it would be good to try.  Will give it a shot and let you know (might not get a chance to try until tomorrow).&lt;/p&gt;</comment>
                            <comment id="15045374" author="rhatch" created="Mon, 7 Dec 2015 18:08:13 +0000"  >&lt;p&gt;This appears to be happening when upgrading through 2.2 on the way to 3.0.&lt;/p&gt;

&lt;p&gt;Confirmed happening on 3.0.0 as well as 3.0 head.&lt;/p&gt;

&lt;p&gt;As Andy stated, the static column isn&apos;t needed to see the issue.&lt;/p&gt;</comment>
                            <comment id="15045537" author="rhatch" created="Mon, 7 Dec 2015 19:22:06 +0000"  >&lt;p&gt;Happens on 2.2 upgrading to 3.0 as well, 2.1 not necessary.&lt;/p&gt;</comment>
                            <comment id="15047563" author="rhatch" created="Tue, 8 Dec 2015 22:09:38 +0000"  >&lt;p&gt;(caveat: possibly unrelated) After upgrade I run sstableverify on the node and get this exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Verifying BigTableReader(path=&apos;/home/rhatch/.ccm/financial/node1/data/financial/symbol_history-801411b09df711e581e7ff4e6f1f6740/financial-symbol_history-ka-1-Data.db&apos;) (1403 bytes)
Checking computed hash of BigTableReader(path=&apos;/home/rhatch/.ccm/financial/node1/data/financial/symbol_history-801411b09df711e581e7ff4e6f1f6740/financial-symbol_history-ka-1-Data.db&apos;) 
Error verifying BigTableReader(path=&apos;/home/rhatch/.ccm/financial/node1/data/financial/symbol_history-801411b09df711e581e7ff4e6f1f6740/financial-symbol_history-ka-1-Data.db&apos;): java.nio.file.NoSuchFileException: /home/rhatch/.ccm/financial/node1/data/financial/symbol_history-801411b09df711e581e7ff4e6f1f6740/financial-symbol_history-ka-1-Digest.adler32
java.lang.RuntimeException: java.nio.file.NoSuchFileException: /home/rhatch/.ccm/financial/node1/data/financial/symbol_history-801411b09df711e581e7ff4e6f1f6740/financial-symbol_history-ka-1-Digest.adler32
	at org.apache.cassandra.io.util.ChannelProxy.openChannel(ChannelProxy.java:55)
	at org.apache.cassandra.io.util.ChannelProxy.&amp;lt;init&amp;gt;(ChannelProxy.java:66)
	at org.apache.cassandra.io.util.RandomAccessReader.open(RandomAccessReader.java:504)
	at org.apache.cassandra.io.util.DataIntegrityMetadata$FileDigestValidator.&amp;lt;init&amp;gt;(DataIntegrityMetadata.java:113)
	at org.apache.cassandra.io.util.DataIntegrityMetadata.fileDigestValidator(DataIntegrityMetadata.java:98)
	at org.apache.cassandra.db.compaction.Verifier.verify(Verifier.java:102)
	at org.apache.cassandra.tools.StandaloneVerifier.main(StandaloneVerifier.java:103)
Caused by: java.nio.file.NoSuchFileException: /home/rhatch/.ccm/financial/node1/data/financial/symbol_history-801411b09df711e581e7ff4e6f1f6740/financial-symbol_history-ka-1-Digest.adler32
	at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
	at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
	at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
	at sun.nio.fs.UnixFileSystemProvider.newFileChannel(UnixFileSystemProvider.java:177)
	at java.nio.channels.FileChannel.open(FileChannel.java:287)
	at java.nio.channels.FileChannel.open(FileChannel.java:335)
	at org.apache.cassandra.io.util.ChannelProxy.openChannel(ChannelProxy.java:51)
	... 6 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After running upgradesstables verify works fine (though the data is still not present).&lt;/p&gt;</comment>
                            <comment id="15048682" author="slebresne" created="Wed, 9 Dec 2015 13:41:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.tolbert&quot; class=&quot;user-hover&quot; rel=&quot;andrew.tolbert&quot;&gt;andrew.tolbert&lt;/a&gt; It would great if you could turn that reproduction script into a dtest. Our coverage of upgrade scenario is really bad (as exemplified by this) and we need to fix that ASAP.&lt;/p&gt;</comment>
                            <comment id="15048834" author="rhatch" created="Wed, 9 Dec 2015 15:38:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.tolbert&quot; class=&quot;user-hover&quot; rel=&quot;andrew.tolbert&quot;&gt;andrew.tolbert&lt;/a&gt; I&apos;ve got a dtest in progress and hoping to be able to use the same to bisect the issue soon.&lt;/p&gt;</comment>
                            <comment id="15048951" author="andrew.tolbert" created="Wed, 9 Dec 2015 16:42:54 +0000"  >&lt;p&gt;Excellent, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15049655" author="rhatch" created="Wed, 9 Dec 2015 23:51:26 +0000"  >&lt;p&gt;Haven&apos;t been able to get a good bisect &amp;#8211; keep running into peripheral issues (understandably since I&apos;m testing in the space between releases). I have the basic skeleton of a dtest, just need to polish it up a bit and can commit by tomorrow morning.&lt;/p&gt;</comment>
                            <comment id="15050973" author="blambov" created="Thu, 10 Dec 2015 13:46:19 +0000"  >&lt;p&gt;&lt;tt&gt;UnfilteredDeserializer.OldFormatDeserializer.AtomIterator&lt;/tt&gt; was filtering out content before the tombstone tracker had a chance to close tombstones ranges that end before that content. Patch is linked below, also fixes NPE on scrub from missing &lt;tt&gt;SerilizationHeader&lt;/tt&gt; in legacy sstables.&lt;/p&gt;

&lt;p&gt;I am counting on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt;&apos;s dtest to serve as a regression test for this.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/10822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blambov/job/blambov-10822-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15050989" author="slebresne" created="Thu, 10 Dec 2015 14:00:28 +0000"  >&lt;p&gt;Patch mostly lgtm but a few remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;UnfilteredDeserializer.OldFormatDeserializer.AtomIterator.hasNext()&lt;/tt&gt; can now be simplified a bit (no need to loop in particular).&lt;/li&gt;
	&lt;li&gt;The comment at the beginning of &lt;tt&gt;UnfilteredDeserializer.OldFormatDeserializer.UnfilteredIterator.hasNext()&lt;/tt&gt; can be updated to say &quot;.. or the atom might be shadowed&quot;.&lt;/li&gt;
	&lt;li&gt;Not totally sure about the scrub-related fix as &lt;tt&gt;SSTableWriter&lt;/tt&gt; is supposed to be fine with a &lt;tt&gt;null&lt;/tt&gt; header for legacy tables. Can you elaborate on what is breaking without that change exactly?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15051003" author="blambov" created="Thu, 10 Dec 2015 14:09:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Not totally sure about the scrub-related fix as &lt;tt&gt;SSTableWriter&lt;/tt&gt; is supposed to be fine with a &lt;tt&gt;null&lt;/tt&gt; header for legacy tables. Can you elaborate on what is breaking without that change exactly?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The specific failure I had was in &lt;tt&gt;ColumnIndex.Builder.writePartitionHeader(UnfilteredRowIterator)&lt;/tt&gt;. It appeared to me that a header &lt;em&gt;is&lt;/em&gt; necessary for similar things to work, but let me know if you prefer a different way to solve the problem.&lt;/p&gt;</comment>
                            <comment id="15051012" author="blambov" created="Thu, 10 Dec 2015 14:15:24 +0000"  >&lt;p&gt;Updated the &lt;a href=&quot;https://github.com/blambov/cassandra/tree/10822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; to apply the other two comments.&lt;/p&gt;</comment>
                            <comment id="15051015" author="slebresne" created="Thu, 10 Dec 2015 14:18:23 +0000"  >&lt;p&gt;Sorry, I wasn&apos;t thinking straight (I was thinking of &lt;tt&gt;SSTableReader&lt;/tt&gt; not &lt;tt&gt;SSTableWriter&lt;/tt&gt;). That change is fine.&lt;/p&gt;</comment>
                            <comment id="15051822" author="rhatch" created="Thu, 10 Dec 2015 23:13:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; proto dtest here: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/test_10822?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/compare/test_10822?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To run this locally, set CASSANDRA_DIR in your env and build cassandra in that location, then run the dtest with something like:&lt;br/&gt;
nosetests -xvs upgrade_tests/other_test.py&lt;/p&gt;</comment>
                            <comment id="15052525" author="slebresne" created="Fri, 11 Dec 2015 09:39:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt; Have you tried running that dtest on Branimir&apos;s branch?&lt;/p&gt;</comment>
                            <comment id="15053008" author="rhatch" created="Fri, 11 Dec 2015 16:55:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Ran against &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;&apos;s branch this morning, 20 repetitions of the test pass fine. (I ran multiple times to be sure, because when running against 3.0 as a control, I was only intermittently seeing the issue this morning. I&apos;ll work to make the test more deterministic however).&lt;/p&gt;

&lt;p&gt;This test is running an upgrade on two nodes, cl.one, rf=1, are there any other cases that might be useful to keep as regression tests going forward?&lt;/p&gt;</comment>
                            <comment id="15055749" author="slebresne" created="Mon, 14 Dec 2015 10:14:47 +0000"  >&lt;p&gt;Alright, committed.&lt;/p&gt;

&lt;p&gt;[], can you commit your test to the dtests (let&apos;s commit it even if it only catch the problem intermittently and work on improving it afterwards).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This test is running an upgrade on two nodes, cl.one, rf=1, are there any other cases that might be useful to keep as regression tests going forward?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That exact problem doesn&apos;t have to do with replication so it&apos;s fine for this ticket. That said, in a perfect world, we&apos;re run all of our upgrade test in different configurations &quot;just in case&quot;.&lt;/p&gt;</comment>
                            <comment id="15058350" author="rhatch" created="Tue, 15 Dec 2015 17:13:18 +0000"  >&lt;p&gt;dtest committed, and passing on 3.0.2. (test also passes on trunk but that&apos;s vetting an upgrade from 3.0.1 to trunk, which presumably wouldn&apos;t have the issue in the first place).&lt;/p&gt;</comment>
                            <comment id="15058628" author="rhatch" created="Tue, 15 Dec 2015 19:35:33 +0000"  >&lt;p&gt;dtest passes on 3.1.1 as well. (though again, this would be an upgrade from 3.0.1 to 3.1.1)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pifj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    <customfieldvalue id="12334152">3.0.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>