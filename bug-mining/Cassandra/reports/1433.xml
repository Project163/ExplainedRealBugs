<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3735] Fix &quot;Unable to create hard link&quot; SSTableReaderTest error messages</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3735</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Sample failure (on Windows):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] java.io.IOException: Exception while executing the command: cmd /c mklink /H C:\Users\Jonathan\projects\cassandra\git\build\test\cassandra\data\Keyspace1\backups\Standard1-hc-1-Index.db c:\Users\Jonathan\projects\cassandra\git\build\test\cassandra\data\Keyspace1\Standard1-hc-1-Index.db,command error Code: 1, command output: Cannot create a file when that file already exists.
    [junit]
    [junit]     at org.apache.cassandra.utils.CLibrary.exec(CLibrary.java:213)
    [junit]     at org.apache.cassandra.utils.CLibrary.createHardLinkWithExec(CLibrary.java:188)
    [junit]     at org.apache.cassandra.utils.CLibrary.createHardLink(CLibrary.java:151)
    [junit]     at org.apache.cassandra.io.sstable.SSTableReader.createLinks(SSTableReader.java:833)

    [junit]     at org.apache.cassandra.db.DataTracker$1.runMayThrow(DataTracker.java:161)
    [junit]     at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
    [junit]     at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
    [junit]     at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    [junit]     at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    [junit]     at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:98)
    [junit]     at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:206)
    [junit]     at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    [junit]     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    [junit]     at java.lang.Thread.run(Thread.java:662)
    [junit] ERROR 17:10:17,111 Fatal exception in thread Thread[NonPeriodicTasks:1,5,main]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12538275">CASSANDRA-3735</key>
            <summary>Fix &quot;Unable to create hard link&quot; SSTableReaderTest error messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jan 2012 23:11:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:42 +0000</updated>
                            <resolved>Mon, 6 Feb 2012 16:10:21 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13185330" author="jbellis" created="Thu, 12 Jan 2012 23:26:45 +0000"  >&lt;p&gt;Two parts:&lt;/p&gt;

&lt;p&gt;first makes it so loadNewSSTables won&apos;t reset sstable generation to a lower value than it currently is.&lt;/p&gt;

&lt;p&gt;second removes the (hard linked) sstables from the incremental backups directory, so that when loadNewSSTables links them back in they won&apos;t conflict.&lt;/p&gt;

&lt;p&gt;patch 2 doesn&apos;t actually work on Windows because something is keeping the Data component open.  Java6 just says &quot;delete failed;&quot; java7&apos;s Files.delete says &quot;java.nio.file.FileSystemException: build\test\cassandra\data\Keyspace1\backups\Standard1-hc-1-Data.db: The process cannot access the file because it is being used by another process.&quot;  (Even after I prototyped &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3734&quot; title=&quot;Support native link w/o JNA in Java7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3734&quot;&gt;&lt;del&gt;CASSANDRA-3734&lt;/del&gt;&lt;/a&gt; to use Files.createLink instead of ProcessBuilder, so that&apos;s not the &quot;other process.&quot;)&lt;/p&gt;

&lt;p&gt;I&apos;m guessing it&apos;s counting something (what?) that opened the original Data, towards the link entry as well.  But, this should be enough to make the messages go away on Linux, which takes a more permissive view of deleting files opened elsewhere.&lt;/p&gt;</comment>
                            <comment id="13190984" author="slebresne" created="Mon, 23 Jan 2012 10:23:26 +0000"  >&lt;p&gt;This seems to handle most of the warnings. However (on 1.0 branch):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;SSTableReaderTest doesn&apos;t pass on linux either. It ends up with the following trace:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testcase: testPersistentStatisticsFromOlderIndexedSSTable(org.apache.cassandra.io.sstable.SSTableReaderTest):	Caused an ERROR
    [junit] Failed to delete /home/mcmanus/Git/cassandra/build/test/cassandra/data/Keyspace1/backups
    [junit] java.io.IOException: Failed to delete /home/mcmanus/Git/cassandra/build/test/cassandra/data/Keyspace1/backups
    [junit] 	at org.apache.cassandra.io.util.FileUtils.deleteWithConfirm(FileUtils.java:54)
    [junit] 	at org.apache.cassandra.io.util.FileUtils.deleteRecursive(FileUtils.java:237)
    [junit] 	at org.apache.cassandra.io.sstable.SSTableReaderTest.clearAndLoad(SSTableReaderTest.java:167)
    [junit] 	at org.apache.cassandra.io.sstable.SSTableReaderTest.assertIndexQueryWorks(SSTableReaderTest.java:260)
    [junit] 	at org.apache.cassandra.io.sstable.SSTableReaderTest.testPersistentStatisticsFromOlderIndexedSSTable(SSTableReaderTest.java:251)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;I get a &quot;Largest generation seen in loaded sstables was 8, which may overlap with native sstable files (generation 8)&quot; warning during ColumnFamilyStoreTest, followed by  a (not surpising) &apos;Unable to create hard link&apos;, in testSliceByNamesCommandOldMetatada. I believe a quick fix could be to have clearUnsafe reset the generation for the CF. Another solution would be to make loadNewSSTables smarter/less fragile by having it &apos;reserve&apos; a generation for each of the new file to load from the current generation and rename the loaded files accordingly.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13200642" author="scode" created="Sun, 5 Feb 2012 02:52:42 +0000"  >&lt;p&gt;Attaching new version of 0002* that works (but still with the left-overs already mentioned by jbellis/sylvain) post &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2794&quot; title=&quot;Scrub fails on system with blocked compaction with java.io.FileNotFoundException / Too many open files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2794&quot;&gt;&lt;del&gt;CASSANDRA-2794&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13200666" author="scode" created="Sun, 5 Feb 2012 06:17:18 +0000"  >&lt;p&gt;Correction, the conversion to post-2794 did remove the failure of the SSTableReaderTest. Or at least it&apos;s no longer happening for me on trunk with the attached patch (v2). Likely because it&apos;s only removing specific sstable components given by the iterator, rather than trying to recursively delete backups, but I don&apos;t pretend to understand exactly what the history of changes is that caused it to start failing to delete it to begin with.&lt;/p&gt;

&lt;p&gt;With repsect to the &apos;Largest generation seen...&apos; warning, I get that too, but I don&apos;t see any subsequent hard link creation failures, nor do I understand why I would if the files are created without using the counter and the quick fix just suppresses the warning? But I&apos;m probably missing something. I do have failing hard linking in ThriftValidationTest though. Maybe this is a side-effect that you&apos;re referring to?&lt;/p&gt;

&lt;p&gt;In any case, attaching the trivial (if I understood the suggestion correctly) reset patch that supresses the warning.&lt;/p&gt;

</comment>
                            <comment id="13201363" author="slebresne" created="Mon, 6 Feb 2012 16:10:21 +0000"  >&lt;p&gt;I still had one remaining link error with v2 in CFSTest, but that was because tests runs with incremental backup and 2 tests were reusing the same CF with just a clearUnsafe in between, so the backup were kept around. I&apos;ve moved the removal of backups from the SSTableReader.clearAndLoad() method introduced by the patches to CFS.clearUnsafe() directly to avoid this. I took the liberty to commit with that last change. I don&apos;t get any link related exceptions anymore.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12510437" name="0001-fix-generation-update-in-loadNewSSTables.patch" size="1627" author="jbellis" created="Thu, 12 Jan 2012 23:26:45 +0000"/>
                            <attachment id="12513276" name="0002-remove-incremental-backups-before-reloading-sstables-v2.patch" size="4856" author="scode" created="Sun, 5 Feb 2012 02:52:41 +0000"/>
                            <attachment id="12510438" name="0002-remove-incremental-backups-before-reloading-sstables.patch" size="3492" author="jbellis" created="Thu, 12 Jan 2012 23:26:45 +0000"/>
                            <attachment id="12513285" name="0003-reset-file-index-generator-on-reset.patch" size="597" author="scode" created="Sun, 5 Feb 2012 06:17:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>223781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gnlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95253</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>