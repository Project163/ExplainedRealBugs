<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13363] Fix racy read command serialization</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13363</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Constantly see this error in the log without any additional information or a stack trace.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/10.0.1.26,5,main]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ArrayIndexOutOfBoundsException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Logger: org.apache.cassandra.service.CassandraDaemon&lt;br/&gt;
Thrdead: MessagingService-Incoming-/10.0.1.12&lt;br/&gt;
Method: uncaughtException&lt;br/&gt;
File: CassandraDaemon.java&lt;br/&gt;
Line: 229&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 6, Cassandra 3.10&lt;/p&gt;</environment>
        <key id="13058159">CASSANDRA-13363</key>
            <summary>Fix racy read command serialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="arokhin">Artem Rokhin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 22 Mar 2017 09:22:14 +0000</created>
                <updated>Tue, 25 Jun 2019 10:33:41 +0000</updated>
                            <resolved>Wed, 30 Aug 2017 16:39:47 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>18</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="15953455" author="slebresne" created="Mon, 3 Apr 2017 13:18:00 +0000"  >&lt;p&gt;I really don&apos;t think we can do anything about it unless you provide a full stack trace.&lt;/p&gt;</comment>
                            <comment id="15953460" author="ifesdjeen" created="Mon, 3 Apr 2017 13:22:14 +0000"  >&lt;p&gt;You can turn off &lt;tt&gt;OmitStackTraceInFastThrow&lt;/tt&gt; if it&apos;s on, my guess is that the stack trace might be emitted because the amount of thrown exceptions has reached a threshold and was optimised away.&lt;/p&gt;</comment>
                            <comment id="15962703" author="arokhin" created="Mon, 10 Apr 2017 10:48:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; Thank you, turned it off. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; I&apos;ll let you know when/if the issue is reproduced. &lt;/p&gt;</comment>
                            <comment id="15997117" author="arokhin" created="Thu, 4 May 2017 17:30:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Looks like we met the exception again. With a stack trace this time. Is that helpful?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 17:22:43 Exception in thread Thread[MessagingService-Incoming-/10.0.1.12,5,main]
java.lang.ArrayIndexOutOfBoundsException: 71
    at org.apache.cassandra.db.filter.AbstractClusteringIndexFilter$FilterSerializer.deserialize(AbstractClusteringIndexFilter.java:74) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.db.SinglePartitionReadCommand$Deserializer.deserialize(SinglePartitionReadCommand.java:1021) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:638) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:568) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.io.ForwardingVersionedSerializer.deserialize(ForwardingVersionedSerializer.java:50) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.13.jar:3.0.13]
    at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.13.jar:3.0.13]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15997119" author="arokhin" created="Thu, 4 May 2017 17:33:07 +0000"  >&lt;p&gt;Quick update - Cassandra version now is 3.0.13&lt;/p&gt;

&lt;p&gt;And worth to mention that 3 nodes Cassandra cluster becomes completely unreposnsive after that exception. &lt;/p&gt;

&lt;p&gt;Exception itself occures on all 3 nodes.&lt;/p&gt;</comment>
                            <comment id="16091427" author="shashikantkulkarni" created="Tue, 18 Jul 2017 11:23:58 +0000"  >&lt;p&gt;Hello,&lt;br/&gt;
I am also facing the similar issue so adding my comment here. I have Apache Cassandra v3.9, with 3 node in cluster. Replication factor 2. Same datacenter. CentOS 6.8, Java 8&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [MessagingService-Incoming-/10.0.0.111] 2017-07-06 14:26:02,506 CassandraDaemon.java:226 - Exception in thread Thread[MessagingService-Incoming-/10.0.0.111,5,main]
java.lang.IndexOutOfBoundsException: index (2) must be less than size (2)
	at com.google.common.base.Preconditions.checkElementIndex(Preconditions.java:310) ~[guava-18.0.jar:na]
	at com.google.common.base.Preconditions.checkElementIndex(Preconditions.java:292) ~[guava-18.0.jar:na]
	at com.google.common.collect.RegularImmutableList.get(RegularImmutableList.java:65) ~[guava-18.0.jar:na]
	at org.apache.cassandra.db.ClusteringPrefix$Serializer.deserializeValuesWithoutSize(ClusteringPrefix.java:359) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.ClusteringBoundOrBoundary$Serializer.deserializeValues(ClusteringBoundOrBoundary.java:179) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.ClusteringBoundOrBoundary$Serializer.deserialize(ClusteringBoundOrBoundary.java:161) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.Slice$Serializer.deserialize(Slice.java:322) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.Slices$Serializer.deserialize(Slices.java:336) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.filter.ClusteringIndexSliceFilter$SliceDeserializer.deserialize(ClusteringIndexSliceFilter.java:174) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.filter.AbstractClusteringIndexFilter$FilterSerializer.deserialize(AbstractClusteringIndexFilter.java:77) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.SinglePartitionReadCommand$Deserializer.deserialize(SinglePartitionReadCommand.java:1041) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:696) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:626) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.io.ForwardingVersionedSerializer.deserialize(ForwardingVersionedSerializer.java:50) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:114) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:190) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.9.0.jar:3.9.0]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.9.0.jar:3.9.0]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this exception the cluster becomes unresponsive and start throwing errors if we try to query for web application.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="16115355" author="zhaoyan" created="Sat, 5 Aug 2017 10:18:57 +0000"  >&lt;p&gt;Hello,&lt;br/&gt;
I am also facing the similar issue so adding my comment here.&lt;/p&gt;

&lt;p&gt;cassandra 3.0.14  jdk8&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [MessagingService-Incoming-/10.xx.0.205] 2017-08-05 18:12:38,319 CassandraDaemon.java:207 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/10.xx.0.205,5,main]
java.lang.ArrayIndexOutOfBoundsException: 36
        at org.apache.cassandra.db.Slice$Bound$Serializer.deserialize(Slice.java:542) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.Slice$Serializer.deserialize(Slice.java:335) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.Slices$Serializer.deserialize(Slices.java:346) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.filter.ClusteringIndexSliceFilter$SliceDeserializer.deserialize(ClusteringIndexSliceFilter.java:176) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.filter.AbstractClusteringIndexFilter$FilterSerializer.deserialize(AbstractClusteringIndexFilter.java:77) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.SinglePartitionReadCommand$Deserializer.deserialize(SinglePartitionReadCommand.java:1031) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:638) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:568) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.io.ForwardingVersionedSerializer.deserialize(ForwardingVersionedSerializer.java:50) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.14.jar:3.0.14]
ERROR [MessagingService-Incoming-/10.xx.0.205] 2017-08-05 18:12:39,994 CassandraDaemon.java:207 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/10.xx.0.205,5,main]
java.lang.ArrayIndexOutOfBoundsException: 103
        at org.apache.cassandra.db.filter.AbstractClusteringIndexFilter$FilterSerializer.deserialize(AbstractClusteringIndexFilter.java:74) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.SinglePartitionReadCommand$Deserializer.deserialize(SinglePartitionReadCommand.java:1031) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:638) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.db.ReadCommand$Serializer.deserialize(ReadCommand.java:568) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.io.ForwardingVersionedSerializer.deserialize(ForwardingVersionedSerializer.java:50) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.14.jar:3.0.14]
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.14.jar:3.0.14]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16115480" author="jjirsa" created="Sat, 5 Aug 2017 18:00:04 +0000"  >&lt;p&gt;Relevant code is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ClusteringIndexFilter deserialize(DataInputPlus in, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; version, CFMetaData metadata) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
        {
            Kind kind = Kind.values()[in.readUnsignedByte()]; &lt;span class=&quot;code-comment&quot;&gt;// We read a &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;, and then &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to find the kind, and we&apos;re way outside of the array
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; reversed = in.readBoolean();

            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; kind.deserializer.deserialize(in, version, metadata, reversed);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Slice.Bound deserialize(DataInputPlus in, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; version, List&amp;lt;AbstractType&amp;lt;?&amp;gt;&amp;gt; types) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
            {
                Kind kind = Kind.values()[in.readByte()]; &lt;span class=&quot;code-comment&quot;&gt;// same thing, read a &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;, way outside of the array
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; deserializeValues(in, kind, version, types);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16115515" author="jjirsa" created="Sat, 5 Aug 2017 21:08:56 +0000"  >&lt;blockquote&gt;
&lt;p&gt;And worth to mention that 3 nodes Cassandra cluster becomes completely unreposnsive after that exception.&lt;br/&gt;
Exception itself occures on all 3 nodes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Does a cluster restart help, or does it stay broken?&lt;/p&gt;

&lt;p&gt;Did you recently do any changes? Changing schemas?  Do you see any signs of physical hardware errors (interface counters showing errors)?&lt;/p&gt;</comment>
                            <comment id="16115701" author="zhaoyan" created="Sun, 6 Aug 2017 08:22:26 +0000"  >&lt;p&gt;please  see  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12435&quot; title=&quot;Cassandra timeout when using secondary index in cluster mode.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12435&quot;&gt;&lt;del&gt;CASSANDRA-12435&lt;/del&gt;&lt;/a&gt;   same question.&lt;/p&gt;

&lt;p&gt;when I query with index  ( use expr)  by java driver,  It will appear&#12290;&lt;/p&gt;

&lt;p&gt;as I test,  3.0.10-3.0.14  all has this problem&#12290;&lt;/p&gt;</comment>
                            <comment id="16119329" author="zhaoyan" created="Wed, 9 Aug 2017 02:37:17 +0000"  >&lt;p&gt;I apply one patch here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/137&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16119377" author="githubbot" created="Wed, 9 Aug 2017 03:59:10 +0000"  >&lt;p&gt;GitHub user johnyannj opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/137&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13363&quot; title=&quot;Fix racy read command serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13363&quot;&gt;&lt;del&gt;CASSANDRA-13363&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12435&quot; title=&quot;Cassandra timeout when using secondary index in cluster mode.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12435&quot;&gt;&lt;del&gt;CASSANDRA-12435&lt;/del&gt;&lt;/a&gt; fix index flag before not be consistent with follow data content&lt;/p&gt;

&lt;p&gt;    fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13363&quot; title=&quot;Fix racy read command serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13363&quot;&gt;&lt;del&gt;CASSANDRA-13363&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12435&quot; title=&quot;Cassandra timeout when using secondary index in cluster mode.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12435&quot;&gt;&lt;del&gt;CASSANDRA-12435&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    when the command will be executed by local node and target node.&lt;br/&gt;
    the command.index will be reload by local thread.&lt;/p&gt;

&lt;p&gt;    when code reach indexFlag(command.index.isPresent())  is false&lt;br/&gt;
    but reach if (command.index.isPresent()) , it is changed to true, because the &quot;command.index&quot; has been loaded by local execute thread.&lt;/p&gt;

&lt;p&gt;    the command.index can be reload by target node, so it&apos;s serialize is optional&#12290; but the flag must be consistent with follow data content.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/johnyannj/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/johnyannj/cassandra&lt;/a&gt; johnyannj-patch-fix-13363&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/137.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/137.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #137&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5050ff51b1f62fe7a678be01f79ff962a0fd6caa&lt;br/&gt;
Author: zhaoyan &amp;lt;zhaoyan@zhaoyanblog.com&amp;gt;&lt;br/&gt;
Date:   2017-08-09T02:35:46Z&lt;/p&gt;

&lt;p&gt;    Update ReadCommand.java&lt;/p&gt;

&lt;p&gt;    fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13363&quot; title=&quot;Fix racy read command serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13363&quot;&gt;&lt;del&gt;CASSANDRA-13363&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12435&quot; title=&quot;Cassandra timeout when using secondary index in cluster mode.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12435&quot;&gt;&lt;del&gt;CASSANDRA-12435&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    when the command will be executed by local node and target node.&lt;br/&gt;
    the command.index will be reload by local thread.&lt;/p&gt;

&lt;p&gt;    when code reach indexFlag(command.index.isPresent())  is false&lt;br/&gt;
    but reach if (command.index.isPresent()) , it is changed to true, because the &quot;command.index&quot; has been loaded by local execute thread.&lt;/p&gt;

&lt;p&gt;    the command.index can be reload by target node, so it&apos;s serialize is optional&#12290; but the flag must be consistent with follow data content.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16119394" author="jjirsa" created="Wed, 9 Aug 2017 04:24:12 +0000"  >&lt;p&gt;Marking patch available&lt;/p&gt;</comment>
                            <comment id="16125838" author="iamaleksey" created="Mon, 14 Aug 2017 15:29:14 +0000"  >&lt;p&gt;The problem is real, and the patch does work, but I&apos;m afraid it doesn&apos;t quite solve the issue completely.&lt;/p&gt;

&lt;p&gt;There is also an issue involving &lt;tt&gt;serializedSize()&lt;/tt&gt;. &lt;tt&gt;index&lt;/tt&gt; field might be empty at the time when we calculate the size of the message, and switch to non-empty afterwards. It&apos;s not currently an issue since &lt;tt&gt;READ_COMMAND&lt;/tt&gt; is not using a &lt;tt&gt;CallbackDeterminedSerializer&lt;/tt&gt; but it&apos;s still a bug.&lt;/p&gt;

&lt;p&gt;The proper fix would be to make sure the field never changes and is only set once at construction time. While at it, might also want to refactor it to not be &lt;tt&gt;Optional&lt;/tt&gt;. &lt;tt&gt;Optional&lt;/tt&gt; is reserved for return types, not object fields and method arguments.&lt;/p&gt;

&lt;p&gt;Give me a couple hours to try work it out properly?&lt;/p&gt;</comment>
                            <comment id="16128526" author="zhaoyan" created="Wed, 16 Aug 2017 09:14:36 +0000"  >&lt;p&gt;hi @Aleksey Yeschenko&lt;/p&gt;

&lt;p&gt;thank you for your review.&lt;br/&gt;
the serializedSize()  is real a hidden trouble&#12290;&lt;/p&gt;

&lt;p&gt;I do agree with you that&#65306;&lt;br/&gt;
&quot;The proper fix would be to make sure the field never changes and is only set once at construction time.&quot;&lt;/p&gt;

&lt;p&gt;the index is designed as lazy load , load once , and not set at construction time,    so  I think its load may be very hard.&lt;/p&gt;

&lt;p&gt;What about removing index from the readcommand&#8216;s  serialize?&lt;/p&gt;</comment>
                            <comment id="16128589" author="beobal" created="Wed, 16 Aug 2017 10:05:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhaoyan&quot; class=&quot;user-hover&quot; rel=&quot;zhaoyan&quot;&gt;zhaoyan&lt;/a&gt; &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the index is designed as lazy load , load once , and not set at construction time, so I think its load may be very hard&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This was true at one point, but in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10215&quot; title=&quot;Reduce redundant secondary index selection lookups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10215&quot;&gt;&lt;del&gt;CASSANDRA-10215&lt;/del&gt;&lt;/a&gt; that changed so that we could avoid performing the lookup to determine which index to use multiple times during the query execution. That patch was didn&apos;t really go far enough though (which is my bad), as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; points out there are several shortcomings with it; it shouldn&apos;t be using &lt;tt&gt;Optional&lt;/tt&gt;, the field should be final and so forth. &lt;/p&gt;

&lt;p&gt;However, there is also another issue at play here. Queries with secondary indexes were historically always executed as partition range queries, as their results can span multiple partitions. Even when a partition key restriction is present, we convert the query to a range read command and the index field &lt;b&gt;is&lt;/b&gt; always set at construction time (in &lt;tt&gt;SelectStatement::getRangeCommand&lt;/tt&gt;), so it is never lazily loaded. There is a related bug though, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11617&quot; title=&quot;The presence of custom index expressions doesn&amp;#39;t set the indexing flag in StatementRestrictions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11617&quot;&gt;CASSANDRA-11617&lt;/a&gt;, which causes queries with a partition key restriction &amp;amp;&amp;amp; a custom index expression to be executed as single partition read command. When these are created (in &lt;tt&gt;SelectStatement::getSliceCommands&lt;/tt&gt;), we &lt;b&gt;don&apos;t&lt;/b&gt; ensure that the index is loaded at construction time (because we weren&apos;t expecting any query with an index to generate such a command). So in this case, the lazy loading happens when the command is executed locally, leading to the race causing the serialization issues you&apos;re seeing. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What about removing index from the readcommand&#8216;s serialize?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This would partially undo &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10215&quot; title=&quot;Reduce redundant secondary index selection lookups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10215&quot;&gt;&lt;del&gt;CASSANDRA-10215&lt;/del&gt;&lt;/a&gt; and require each replica to figure out which index to use, which is potentially expensive (relatively) and unnecesary.&lt;/p&gt;

&lt;p&gt;So to cut a long story short, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&apos;s diagnosis and solution are correct, making sure that where an index is appropriate it gets set on the read command during construction is the right  way to fix this. The more thorough refactoring, which should have been done in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10215&quot; title=&quot;Reduce redundant secondary index selection lookups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10215&quot;&gt;&lt;del&gt;CASSANDRA-10215&lt;/del&gt;&lt;/a&gt;, is also a good idea.  &lt;/p&gt;</comment>
                            <comment id="16131564" author="zhaoyan" created="Fri, 18 Aug 2017 01:12:19 +0000"  >&lt;p&gt;Hi @Sam Tunnicliffe &lt;/p&gt;

&lt;p&gt;Thank you for your patient explanation.&lt;/p&gt;

&lt;p&gt;I has one more question&#65306; &lt;/p&gt;

&lt;p&gt;&quot;This would partially undo &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10215&quot; title=&quot;Reduce redundant secondary index selection lookups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10215&quot;&gt;&lt;del&gt;CASSANDRA-10215&lt;/del&gt;&lt;/a&gt; and require each replica to figure out which index to use, &quot;&lt;/p&gt;

&lt;p&gt;Does it take a lot of time to do &quot;the lookup to determine which index to use &quot;?&lt;/p&gt;

&lt;p&gt;1=&amp;gt;send the command to other replica, must after the local replica figure out which index to use .&lt;br/&gt;
2=&amp;gt;send to all replica, all replica figure it out itself.&lt;/p&gt;

&lt;p&gt;which looks better?&lt;/p&gt;</comment>
                            <comment id="16131999" author="beobal" created="Fri, 18 Aug 2017 10:03:45 +0000"  >&lt;blockquote&gt;&lt;p&gt; Does it take a lot of time to do &quot;the lookup to determine which index to use &quot;?&lt;/p&gt;

&lt;p&gt;1=&amp;gt;send the command to other replica, must after the local replica figure out which index to use .&lt;br/&gt;
2=&amp;gt;send to all replica, all replica figure it out itself.&lt;/p&gt;

&lt;p&gt;which looks better?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Through profiling, we found that a non-trivial amount of time was spent in &lt;tt&gt;SecondaryIndexManager::getBestIndexFor&lt;/tt&gt;. Part of the problem was that once found, there was no index field on the command to set, so originally this lookup was being done 3 or 4 times per-query, on every replica. &lt;br/&gt;
Once that was fixed, it made sense to just do the index lookup once when the command is constructed, so it could be included in the serialization &amp;amp; so save the replicas from having to do the lookup. So the lookup goes from being performed (4 x num_replicas) times to once per query, which seems like a good idea generally. &lt;/p&gt;
</comment>
                            <comment id="16133059" author="iamaleksey" created="Fri, 18 Aug 2017 14:52:52 +0000"  >&lt;p&gt;Doing it at most once on each replica is probably not a big deal at all. But I&apos;d rather not change current behaviour (except fix this issue). Which would also mean we&apos;d be able to implement &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10214&quot; title=&quot;Enable index selection to be overridden on a per query basis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10214&quot;&gt;CASSANDRA-10214&lt;/a&gt; at any point without a protocol change.&lt;/p&gt;</comment>
                            <comment id="16135088" author="iamaleksey" created="Mon, 21 Aug 2017 12:10:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhaoyan&quot; class=&quot;user-hover&quot; rel=&quot;zhaoyan&quot;&gt;zhaoyan&lt;/a&gt; Thanks again for the initial analysis. And that patch would 100% prevent the AIOOBE, just not fix the underlying issue entirely.&lt;/p&gt;

&lt;p&gt;A more comprehensive refactoring to fix the race for good:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;4.0&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13363-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13363-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13363-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/211/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/212/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/213/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; can you please review?&lt;/p&gt;

&lt;p&gt;EDIT: Added test results&lt;/p&gt;</comment>
                            <comment id="16145451" author="beobal" created="Tue, 29 Aug 2017 15:12:17 +0000"  >&lt;p&gt;LGTM except now that &lt;tt&gt;findIndex&lt;/tt&gt; is baked into &lt;tt&gt;SinglePartitionReadCommand&lt;/tt&gt;, we perform a lookup through &lt;tt&gt;SIM::getBestIndexFor&lt;/tt&gt; when creating the commands to actually read from index tables in &lt;tt&gt;CompositesSearcher&lt;/tt&gt; &amp;amp; &lt;tt&gt;KeysSearcher&lt;/tt&gt;. Also, because those commands are created using the base table&apos;s CFM, we actually end up finding an index (the one we&apos;re in the process of searching). In practice, I don&apos;t suppose this is much of a problem as the execution of those commands is done directly through &lt;tt&gt;queryMemtableAndDisk&lt;/tt&gt;, so we don&apos;t attempt to erroneously use the index. However, it is confusing and more seriously, it breaks &lt;tt&gt;secondary_index_test:TestSecondaryIndexes.test_only_coordinator_chooses_index_for_query&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Aside from that, I just have a couple of tiny nits, feel free to ignore either/both:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;getBestIndexFor(ReadCommand)&lt;/tt&gt; is now only used by tests which could easily be tweaked to use the version which takes a &lt;tt&gt;RowFilter&lt;/tt&gt;. OFC, that trivial method doesn&apos;t really muck up the the &lt;tt&gt;SIM&lt;/tt&gt; API, so nbd if it stays, but it isn&apos;t really adding anything either so &#175;&amp;#95;(&#12484;)_/&#175;&lt;/p&gt;

&lt;p&gt;In some methods of &lt;tt&gt;*ReadCommand&lt;/tt&gt;, the long lists of args are formatted 1 per line, and in others are in a single line. e.g. &lt;tt&gt;SPRC::create&lt;/tt&gt; vs &lt;tt&gt;SPRC::copy&lt;/tt&gt; etc. All of these are already touched by this patch, so they may as well be consistently formatted.&lt;/p&gt;</comment>
                            <comment id="16145701" author="iamaleksey" created="Tue, 29 Aug 2017 17:10:36 +0000"  >&lt;p&gt;Thanks for the review. Pushed a commit addressing the issues to the same branch (and rebased on top of most recent 3.0 while at it). Tests scheduled/running: &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/17&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;, &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/223/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16145771" author="beobal" created="Tue, 29 Aug 2017 17:50:39 +0000"  >&lt;p&gt;LGTM and the failing dtest is passing for me locally now, so +1 assuming CI is still happy.&lt;/p&gt;</comment>
                            <comment id="16147576" author="iamaleksey" created="Wed, 30 Aug 2017 16:39:24 +0000"  >&lt;p&gt;The only unit test that failed was &lt;tt&gt;ViewFilteringTest&lt;/tt&gt;, due to a timeout. Reran locally, it passed. No new dtests seems to be affected (11 failures total).&lt;/p&gt;

&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/7f297bcf8aced983cbc9c4103d0ebefc1789f0dd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7f297bcf8aced983cbc9c4103d0ebefc1789f0dd&lt;/a&gt; to 3.0 and merged up.&lt;/p&gt;
</comment>
                            <comment id="16872252" author="zmalik" created="Tue, 25 Jun 2019 10:33:41 +0000"  >&lt;p&gt;Hi,&#160;&lt;/p&gt;

&lt;p&gt;we are facing similar issue in cassandra 3.0.16 where this racy condition is supposed to be fixed. In&#160;our case it is happening during bootstrap time&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 19:38:22 [Stream #f1c709f0-9418-11e9-8599-931b65954728] Streaming error occurred
java.lang.IndexOutOfBoundsException: Index: 2, Size: 2
	at java.util.ArrayList.rangeCheck(ArrayList.java:657) ~[na:1.8.0_162]
	at java.util.ArrayList.get(ArrayList.java:433) ~[na:1.8.0_162]
	at org.apache.cassandra.db.ClusteringPrefix$Serializer.deserializeValuesWithoutSize(ClusteringPrefix.java:346) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.RangeTombstone$Bound$Serializer.deserializeValues(RangeTombstone.java:212) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.RangeTombstone$Bound$Serializer.deserialize(RangeTombstone.java:202) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeOne(UnfilteredSerializer.java:407) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserialize(UnfilteredSerializer.java:373) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$CurrentFormatIterator.computeNext(SSTableSimpleIterator.java:87) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$CurrentFormatIterator.computeNext(SSTableSimpleIterator.java:65) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.StreamReader$StreamDeserializer.hasNext(StreamReader.java:263) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.ColumnIndex$Builder.build(ColumnIndex.java:111) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.db.ColumnIndex.writeAndBuildIndex(ColumnIndex.java:52) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter.append(BigTableWriter.java:149) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.io.sstable.SimpleSSTableMultiWriter.append(SimpleSSTableMultiWriter.java:45) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.StreamReader.writePartition(StreamReader.java:172) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.compress.CompressedStreamReader.read(CompressedStreamReader.java:107) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:54) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:43) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:59) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:294) ~[apache-cassandra-3.0.16.jar:3.0.16]
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79) [apache-cassandra-3.0.16.jar:3.0.16]
	at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_162]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;This causes streaming errors and as a consequence&#160;the node stays in JOINING state.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12996552">CASSANDRA-12435</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cmhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>