<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2590] row delete breaks read repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2590</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2589&quot; title=&quot;row deletes do not remove columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2589&quot;&gt;&lt;del&gt;CASSANDRA-2589&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Working at CL ALL can get inconsistent reads after row deletion. Reproduced on the 0.7 and 0.8 source. &lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;two node cluster with rf 2 and HH turned off&lt;/li&gt;
	&lt;li&gt;insert rows via cli&lt;/li&gt;
	&lt;li&gt;flush both nodes&lt;/li&gt;
	&lt;li&gt;shutdown node 1&lt;/li&gt;
	&lt;li&gt;connect to node 2 via cli and delete one row&lt;/li&gt;
	&lt;li&gt;bring up node 1&lt;/li&gt;
	&lt;li&gt;connect to node 1 via cli and issue get with CL ALL&lt;/li&gt;
	&lt;li&gt;first get returns the deleted row, second get returns zero rows.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;RowRepairResolver.resolveSuperSet() resolves a local CF with the old row columns, and the remote CF which is marked for deletion. CF.resolve() does not pay attention to the deletion flags and the resolved CF has both markedForDeletion set and a column with a lower timestamp. The return from resolveSuperSet() is used as the return for the read without checking if the cols are relevant. &lt;/p&gt;

&lt;p&gt;Also when RowRepairResolver.mabeScheduleRepairs() runs it sends two mutations. Node 1 is given the row level deletation, and Node 2 is given a mutation to write the old (and now deleted) column from node 2. I have some log traces for this if needed. &lt;/p&gt;

&lt;p&gt;A quick fix is to check for relevant columns in the RowRepairResolver, will attach shortly.    &lt;/p&gt;</description>
                <environment></environment>
        <key id="12505899">CASSANDRA-2590</key>
            <summary>row delete breaks read repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amorton">Aaron Morton</assignee>
                                    <reporter username="amorton">Aaron Morton</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 May 2011 03:44:51 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:00 +0000</updated>
                            <resolved>Thu, 9 Jun 2011 13:51:09 +0000</resolved>
                                        <fixVersion>0.7.7</fixVersion>
                    <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13027541" author="amorton" created="Mon, 2 May 2011 04:06:39 +0000"  >&lt;p&gt;unit test to show columns in a deleted CF after calling resolve() and a hack fix for the use case described above.&lt;/p&gt;</comment>
                            <comment id="13028434" author="jbellis" created="Tue, 3 May 2011 21:20:30 +0000"  >&lt;p&gt;So the problem is that something in repair isn&apos;t calling removeDeleted?  That&apos;s the approach we normally take; it&apos;s like your ensureRelevant, but it doesn&apos;t mutate the original copy (which is important since the original might be part of a cache).  Here&apos;s your test modified to use that:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testEnsureRelevant()
    {
        ColumnFamily cf1 = ColumnFamily.create(&lt;span class=&quot;code-quote&quot;&gt;&quot;Keyspace1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Standard1&quot;&lt;/span&gt;);
        cf1.addColumn(column(&lt;span class=&quot;code-quote&quot;&gt;&quot;one&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, 0));

        ColumnFamily cf2 = ColumnFamily.create(&lt;span class=&quot;code-quote&quot;&gt;&quot;Keyspace1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Standard1&quot;&lt;/span&gt;);
        cf2.delete((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() / 1000), 1);

        cf2.resolve(cf1);
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; cf2.getColumnCount() == 1;
        
        ColumnFamily cleaned = ColumnFamilyStore.removeDeleted(cf2, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; cleaned == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13028462" author="jbellis" created="Tue, 3 May 2011 22:01:22 +0000"  >&lt;p&gt;... but that&apos;s not what we want for RowRepairResolver. (I freely admit that dealing with tombstones is subtle and tricky. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;removeDeleted will give you back a version of the row with any GC-able tombstones removed. That&apos;s not what we want for read repair; we want to preserve tombstones, but we want a &quot;canonical&quot; representation of only the minimum tombstones necessary. (Technically, this doesn&apos;t matter for the repair per se, because repairing obsolete data is harmless. What we&apos;re concerned with is getting the right result back to the client, and thriftifyColumns &amp;amp; friends in CassandraServer assume that canonicalization has been performed previously.)&lt;/p&gt;

&lt;p&gt;So we do want to do what you were doing with ensureRelevant, but it&apos;s a little more complex than that because we have the same problem at the supercolumn level, as at the row level.&lt;/p&gt;

&lt;p&gt;QueryFilter.collectCollatedColumns is responsible for doing this when merging different versions from memtables and sstables, so we just need to wire it up in RRR. Here&apos;s a patch that uses an IdentityQueryFilter to do this.&lt;/p&gt;</comment>
                            <comment id="13030265" author="amorton" created="Sat, 7 May 2011 03:08:56 +0000"  >&lt;p&gt;Thanks, am doing some more tests on super columns&lt;/p&gt;</comment>
                            <comment id="13030672" author="amorton" created="Mon, 9 May 2011 10:04:37 +0000"  >&lt;p&gt;2590-v3 uses removeDeleted() in RowRepairResolver.resolveSuperset() and includes tests in RowResolverTest.Patch is for 0.8.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2621&quot; title=&quot;sub columns under deleted CF returned &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2621&quot;&gt;&lt;del&gt;CASSANDRA-2621&lt;/del&gt;&lt;/a&gt; shows that QueryFilter.collectCollatedColumns() returns a CF with deleted columns and the caller should use removeDeleted. &lt;/p&gt;

&lt;p&gt;Continuing to use CF.resolve() seemed like the minimum change. Let me know if you think we should still use QueryFilter to resolve the differences. &lt;/p&gt;</comment>
                            <comment id="13046292" author="jbellis" created="Thu, 9 Jun 2011 00:45:36 +0000"  >&lt;p&gt;I think we&apos;re almost there.&lt;/p&gt;

&lt;p&gt;The trick is you actually need &lt;em&gt;both&lt;/em&gt; collectCollatedColumns and removeDeleted, since rD assumes cCC has already been called (which it is, when we&apos;re merging versions from different sstables...  but not when we&apos;re merging versions from different replicas, as in RRR).&lt;/p&gt;

&lt;p&gt;Added a test (testResolveDeletedSuper) to illustrate this.  Fails against v3 (rD but no cCC) but passes w/ v4 (cCC and rD).&lt;/p&gt;</comment>
                            <comment id="13046398" author="slebresne" created="Thu, 9 Jun 2011 08:37:18 +0000"  >&lt;p&gt;+1 on v4, we do need both calls.&lt;/p&gt;

&lt;p&gt;That being said, we should probably refactor that part of the code someday because it is not the cleanest thing ever. And there is probably ways to avoid those two phases (which does do some duplicate works I believe).&lt;/p&gt;</comment>
                            <comment id="13046543" author="jbellis" created="Thu, 9 Jun 2011 13:51:09 +0000"  >&lt;p&gt;committed.  thanks Aaron!&lt;/p&gt;</comment>
                            <comment id="13046554" author="hudson" created="Thu, 9 Jun 2011 14:08:59 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #504 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.7/504/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.7/504/&lt;/a&gt;)&lt;br/&gt;
    fix removing columns and subcolumns that are supressed by a row orsupercolumn tombstone during replica resolution&lt;br/&gt;
patch by Aaron Morton and jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2590&quot; title=&quot;row delete breaks read repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2590&quot;&gt;&lt;del&gt;CASSANDRA-2590&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1133873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1133873&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/test/unit/org/apache/cassandra/service/RowResolverTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/test/unit/org/apache/cassandra/Util.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/test/unit/org/apache/cassandra/db/TableTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/service/RowRepairResolver.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12506480">CASSANDRA-2621</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12478579" name="0001-2590-v3.patch" size="10502" author="amorton" created="Mon, 9 May 2011 10:04:37 +0000"/>
                            <attachment id="12477928" name="0001-cf-resolve-test-and-possible-solution-for-read-repai.patch" size="3038" author="amorton" created="Mon, 2 May 2011 04:06:39 +0000"/>
                            <attachment id="12478099" name="2590-v2.txt" size="1778" author="jbellis" created="Tue, 3 May 2011 22:01:22 +0000"/>
                            <attachment id="12481882" name="2590-v4-0.7.txt" size="11801" author="jbellis" created="Thu, 9 Jun 2011 00:45:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[amorton]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20715</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gc9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93419</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>