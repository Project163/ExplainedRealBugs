<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11848] replace address can &quot;succeed&quot; without actually streaming anything</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11848</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When you do a replace address and the new node has the same IP as the node it is replacing, then the following check can let the replace be successful even if we think all the other nodes are down: &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/dht/RangeStreamer.java#L271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/dht/RangeStreamer.java#L271&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As the FailureDetectorSourceFilter will exclude the other nodes, so an empty stream plan gets executed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12971279">CASSANDRA-11848</key>
            <summary>replace address can &quot;succeed&quot; without actually streaming anything</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="jeremiah">Jeremiah Jordan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 May 2016 20:04:31 +0000</created>
                <updated>Tue, 14 Oct 2025 12:09:28 +0000</updated>
                            <resolved>Thu, 26 May 2016 00:14:48 +0000</resolved>
                                        <fixVersion>2.1.15</fixVersion>
                    <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.7</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15297360" author="pauloricardomg" created="Mon, 23 May 2016 23:47:04 +0000"  >&lt;p&gt;Reproduced this with a &lt;a href=&quot;https://github.com/pauloricardomg/cassandra-dtest/blob/f2b023ac8da68b31288221f95d21bed235d93ba4/replace_address_test.py#L460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simple replace_address dtest&lt;/a&gt;. Also &lt;a href=&quot;https://github.com/pauloricardomg/cassandra-dtest/blob/f2b023ac8da68b31288221f95d21bed235d93ba4/bootstrap_test.py#L180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;added bootstrap dtests&lt;/a&gt; to verify that bootstrap fails if any replica is down when &lt;tt&gt;cassandra.consistent.rangemovement=true&lt;/tt&gt; or if more than RF replicas are down and &lt;tt&gt;cassandra.consistent.rangemovement=false&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;What happens is that &lt;tt&gt;replace_address&lt;/tt&gt; node does not consider itself a pending endpoint, but instead replaces the old node with itself on &lt;tt&gt;TokenMetadata&lt;/tt&gt;, so it considers itself a valid source on &lt;tt&gt;RangeStreamer.getRangeFetchMap&lt;/tt&gt;, even though it only stream from other replicas. In practice, this means the replacing node only stream from alive replicas and silently ignore down replicas (even if all other replicas are down).&lt;/p&gt;

&lt;p&gt;Considering the local a node a valid source was added on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4200&quot; title=&quot;Move error on 1 node cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4200&quot;&gt;&lt;del&gt;CASSANDRA-4200&lt;/del&gt;&lt;/a&gt; since it&apos;s a valid scenario during single-node moves. While &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8523&quot; title=&quot;Writes should be sent to a replacement node which has a new IP while it is streaming in data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8523&quot;&gt;&lt;del&gt;CASSANDRA-8523&lt;/del&gt;&lt;/a&gt; should fix this by making replace go through the normal bootstrap path, the simple fix for now is to not consider the local node a valid source during bootstraps/replaces. This does not affect &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4200&quot; title=&quot;Move error on 1 node cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4200&quot;&gt;&lt;del&gt;CASSANDRA-4200&lt;/del&gt;&lt;/a&gt; dtest &lt;tt&gt;topology_test.py:TestTopology.move_single_node_test&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Patch and tests below:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.7&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-11848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-11848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.7...pauloricardomg:3.7-11848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-11848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...pauloricardomg:11848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11848-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11848-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11848-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.7-11848-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11848-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11848-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11848-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11848-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.7-11848-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11848-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;For some reason I&apos;m not able to submit tests to cassCI. I will try again later and report back here when tests are available.&lt;/p&gt;</comment>
                            <comment id="15298210" author="pauloricardomg" created="Tue, 24 May 2016 14:01:45 +0000"  >&lt;p&gt;dtest failure due to minor test nit (renamed variable just before committing), will resubmit and update when tests look good.&lt;/p&gt;</comment>
                            <comment id="15298501" author="pauloricardomg" created="Tue, 24 May 2016 16:57:26 +0000"  >&lt;p&gt;canceling patch to address the case when there are keyspaces with RF=1 to avoid replace from failing (default &lt;tt&gt;system_auth&lt;/tt&gt; RF).&lt;/p&gt;</comment>
                            <comment id="15299052" author="pauloricardomg" created="Tue, 24 May 2016 22:26:19 +0000"  >&lt;p&gt;Updated &lt;tt&gt;RangeStreamer&lt;/tt&gt; to ignore insufficient sources for keyspaces with RF=1 only when &lt;tt&gt;-Dcassandra.consistent.rangemovement=false&lt;/tt&gt; and instead log the following warning for each missing range:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;WARN  2016-05-24 18:52:39,431 RangeStreamer.java:308 - Unable to find sufficient sources for streaming range (-6995524237582729504,-6946419755126646166] in keyspace keyspace1 with RF=1. Keyspace might be missing data.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;replace_address&lt;/tt&gt; already considers &lt;tt&gt;cassandra.consistent.rangemovement=false&lt;/tt&gt;, the tests no longer fail due to &lt;tt&gt;auth_keyspace&lt;/tt&gt; having &lt;tt&gt;rf=1&lt;/tt&gt; but log warnings instead.&lt;/p&gt;

&lt;p&gt;Also added new bootstrap tests to check that normal bootstrap should fail when there is a down replica and a keyspace with &lt;tt&gt;rf=1&lt;/tt&gt; and &lt;tt&gt;-Dcassandra.consistent.rangemovement=true&lt;/tt&gt;, and should succeed and log a warning when &lt;tt&gt;-Dcassandra.consistent.rangemovement=false&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I also added another related dtest to check that in a multi-dc environment with replication {&lt;tt&gt;&apos;class&apos;: &apos;NetworkTopologyStrategy&apos;, &apos;dc1&apos;: 1, &apos;dc2&apos;: 1&lt;/tt&gt;} a replace_address of a node in DC2 correctly replicates data from DC1 without logging warnings (since data is present on other DC).&lt;/p&gt;

&lt;p&gt;Branches above updated and tests resubmitted (running now). Will set to patch available when they are finished and look good.&lt;/p&gt;</comment>
                            <comment id="15299195" author="pauloricardomg" created="Wed, 25 May 2016 00:05:43 +0000"  >&lt;p&gt;Tests look good now*, this is ready for review.&lt;/p&gt;

&lt;p&gt;*1 Please ignore failure of &lt;tt&gt;bootstrap_test.TestBootstrap.simple_bootstrap_test_small_streaming_socket_timeout_in_ms&lt;/tt&gt; which is a new test from another branch that I included in the commit by mistake (already remove from dtest branch).&lt;br/&gt;
*2 &lt;tt&gt;bootstrap_test.TestBootstrap.resumable_bootstrap_test&lt;/tt&gt; failed on 3.0 and trunk, but it seems it&apos;s due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11414&quot; title=&quot;dtest failure in bootstrap_test.TestBootstrap.resumable_bootstrap_test&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11414&quot;&gt;&lt;del&gt;CASSANDRA-11414&lt;/del&gt;&lt;/a&gt;. I tested locally and works. Resubmitted just in case.&lt;/p&gt;</comment>
                            <comment id="15301184" author="yukim" created="Thu, 26 May 2016 00:14:48 +0000"  >&lt;p&gt;Thanks for the patch Paulo.&lt;br/&gt;
+1 and committed as &lt;tt&gt;6100eb2c1c73b197ea276e8ece232962a0e7b9d2&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12982460">CASSANDRA-12084</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2y8gf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334783">2.1.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>