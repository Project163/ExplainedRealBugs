<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16949] Fix flaky test org.apache.cassandra.transport.CQLConnectionTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16949</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1037/workflows/c728d370-49b9-41aa-bdfb-8c41cf0355d8/jobs/6577/parallel-runs/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1037/workflows/c728d370-49b9-41aa-bdfb-8c41cf0355d8/jobs/6577/parallel-runs/3&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] Testsuite: org.apache.cassandra.transport.CQLConnectionTest
[junit-timeout] Testsuite: org.apache.cassandra.transport.CQLConnectionTest Tests run: 9, Failures: 4, Errors: 0, Skipped: 0, Time elapsed: 12.926 sec
[junit-timeout] 
[junit-timeout] Testcase: handleCorruptionOfLargeMessageFrame(org.apache.cassandra.transport.CQLConnectionTest):	FAILED
[junit-timeout] &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
[junit-timeout] junit.framework.AssertionFailedError
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:484)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:446)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.handleCorruptionOfLargeMessageFrame(CQLConnectionTest.java:217)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[junit-timeout] 	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout] 
[junit-timeout] 
[junit-timeout] Testcase: testNegativeEnvelopeBodySize(org.apache.cassandra.transport.CQLConnectionTest):	FAILED
[junit-timeout] expected:&amp;lt;[]0L&amp;gt; but was:&amp;lt;[52424]0L&amp;gt;
[junit-timeout] junit.framework.AssertionFailedError: expected:&amp;lt;[]0L&amp;gt; but was:&amp;lt;[52424]0L&amp;gt;
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
[junit-timeout] 	at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest$AllocationObserver.lambda$verifier$0(CQLConnectionTest.java:850)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:492)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:446)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testNegativeEnvelopeBodySize(CQLConnectionTest.java:326)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[junit-timeout] 	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout] 
[junit-timeout] 
[junit-timeout] Testcase: testUnrecoverableMessageDecodingErrors(org.apache.cassandra.transport.CQLConnectionTest):	FAILED
[junit-timeout] expected:&amp;lt;[]0L&amp;gt; but was:&amp;lt;[52424]0L&amp;gt;
[junit-timeout] junit.framework.AssertionFailedError: expected:&amp;lt;[]0L&amp;gt; but was:&amp;lt;[52424]0L&amp;gt;
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
[junit-timeout] 	at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest$AllocationObserver.lambda$verifier$0(CQLConnectionTest.java:850)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:492)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testUnrecoverableMessageDecodingErrors(CQLConnectionTest.java:392)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[junit-timeout] 	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout] 
[junit-timeout] 
[junit-timeout] Testcase: testRecoverableEnvelopeDecodingErrors(org.apache.cassandra.transport.CQLConnectionTest):	FAILED
[junit-timeout] &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
[junit-timeout] junit.framework.AssertionFailedError
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.runTest(CQLConnectionTest.java:430)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testEnvelopeDecodingErrors(CQLConnectionTest.java:292)
[junit-timeout] 	at org.apache.cassandra.transport.CQLConnectionTest.testRecoverableEnvelopeDecodingErrors(CQLConnectionTest.java:264)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout] 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
[junit-timeout] 	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout] 
[junit-timeout] 
[junit-timeout] Test org.apache.cassandra.transport.CQLConnectionTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13400827">CASSANDRA-16949</key>
            <summary>Fix flaky test org.apache.cassandra.transport.CQLConnectionTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jlewandowski">Jacek Lewandowski</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Sep 2021 16:24:43 +0000</created>
                <updated>Wed, 4 Oct 2023 17:06:00 +0000</updated>
                            <resolved>Wed, 4 Oct 2023 17:05:06 +0000</resolved>
                                        <fixVersion>4.0.12</fixVersion>
                    <fixVersion>4.1.4</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17635462" author="adelapena" created="Thu, 17 Nov 2022 17:12:13 +0000"  >&lt;p&gt;Just hit an error on &lt;tt&gt;CQLConnectionTest#handleCorruptionOfLargeMessageFrame&lt;/tt&gt; on CircleCI for trunk:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2504/workflows/431c2a2d-0311-4b98-94d1-bebdb841b362/jobs/24586/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/2504/workflows/431c2a2d-0311-4b98-94d1-bebdb841b362/jobs/24586/tests&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError
	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:488)
	at org.apache.cassandra.transport.CQLConnectionTest.testFrameCorruption(CQLConnectionTest.java:450)
	at org.apache.cassandra.transport.CQLConnectionTest.testUnrecoverableEnvelopeDecodingErrors(CQLConnectionTest.java:315)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It can easily be reproduced on trunk with the multiplexer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -m -e REPEATED_UTESTS=org.apache.cassandra.transport.CQLConnectionTest
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2505/workflows/e67dd2a9-87a0-4a2b-92e9-db204c5703a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/2505/workflows/e67dd2a9-87a0-4a2b-92e9-db204c5703a6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This ticket has been closed as a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16677&quot; title=&quot;Test Failure: Fix flaky ConnectionTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16677&quot;&gt;CASSANDRA-16677&lt;/a&gt;, but it seems that ticket is for &lt;tt&gt;o.a.c.net.ConnectionTest&lt;/tt&gt;, whereas the failures here are for &lt;tt&gt;o.a.c.transport.CQLConnectionTest&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="17767895" author="jlewandowski" created="Fri, 22 Sep 2023 08:49:18 +0000"  >&lt;p&gt;This test is weird. &lt;/p&gt;

&lt;p&gt;Looking at the script:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            client.connect(address, port);
            assertTrue(client.isConnected());

            &lt;span class=&quot;code-comment&quot;&gt;// Only install the transform after protocol negotiation is complete
&lt;/span&gt;            controller.withPayloadTransform(transform);

            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; messageCount; i++)
                client.send(envelopeProvider.apply(i));

            client.awaitResponses();
            &lt;span class=&quot;code-comment&quot;&gt;// Client has disconnected
&lt;/span&gt;            assertFalse(client.isConnected());
            &lt;span class=&quot;code-comment&quot;&gt;// But before it did, it sent an error response
&lt;/span&gt;            Envelope received = client.inboundMessages.poll();
            assertNotNull(received); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;----------------------- ERROR
&lt;/span&gt;            Message.Response response = Message.responseDecoder().decode(client.channel, received);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see that we first wait for the error message, then expect the connection to be closed, and eventually, we read the message asserting its content. &lt;/p&gt;

&lt;p&gt;So, the first thing is that &lt;tt&gt;client.awaitResponses()&lt;/tt&gt; awaits two messages and returns regardless of whether it is successful. Only one message is being sent - the error message, so the statement always times out. Irrespective of whether the server completes its job or not, we expect the client to be disconnected - it is enough to add a small sleep in the &lt;tt&gt;ExceptionHandlers&lt;/tt&gt; before the connection should be closed and the test starts to fail at &lt;tt&gt;assertFalse(client.isConnected())&lt;/tt&gt;. Eventually - we test it with networking, and since we only make sure that the error message is sent before the connection is closed, we cannot guarantee the order of events will be retained on the client side. It is even more apparent in real deployments. &lt;/p&gt;

&lt;p&gt;So, if I&apos;m not wrong, the expectation that the client receives and processes the error message before closing the connection without expecting any ack from the client does not make sense. If we want to verify that such a message is sent before closing the connection on the server side, we should implement the test differently - assert that the message was sent rather than received. Otherwise, if we expect the client to process the error message before closing the connection, we should expect some ack from the client before the server closes the connection.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; wdyt ?&lt;/p&gt;</comment>
                            <comment id="17767933" author="beobal" created="Fri, 22 Sep 2023 09:58:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;So, the first thing is that client.awaitResponses() awaits two messages and returns regardless of whether it is successful. Only one message is being sent - the error message, so the statement always times out. Irrespective of whether the server completes its job or not, we expect the client to be disconnected&lt;/p&gt;&lt;/blockquote&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// Client needs to expect multiple responses or else awaitResponses returns
// after the error is first received and we race between handling the exception
// caused by remote disconnection and checking the connection status.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;i.e. if we don&apos;t coerce the client into additional waiting, the client may not have finished reacting to the server closing the connection before we check. An alternative would be to add a sleep between the two:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client.awaitResponses();
TimeUnit.SECONDS.sleep(1);
&lt;span class=&quot;code-comment&quot;&gt;// Client has disconnected
&lt;/span&gt;assertFalse(client.isConnected());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;we cannot guarantee the order of events will be retained on the client side. It is even more apparent in real deployments.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t quite understand this. For sure we in a real deployment we cannot guarantee the order of events on the client side as we don&apos;t control the client, but we do in a test like this.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;we should implement the test differently - assert that the message was sent rather than received&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If I remember right (but it&apos;s been a while, sorry), then the reasoning for doing it this way was mostly that it was easier/cleaner/less invasive to have a custom test client that we could inspect than to modify the server side in a way that is only really useful for testing.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;we should expect some ack from the client before the server closes the connection&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not really, the sending of the error response is really just an optimisation to try and avoid client side timeouts. It&apos;s especially optimistic given we have so little control over how disparate client implementations deal with errors/timeouts (and even stream tracking). The server doesn&apos;t need to wait for an ack before closing.&lt;/p&gt;</comment>
                            <comment id="17767954" author="jlewandowski" created="Fri, 22 Sep 2023 10:58:08 +0000"  >&lt;p&gt;I saw that comment, but I don&apos;t get it - is that &lt;tt&gt;await&lt;/tt&gt; deliberately used as a sleep? We get a single message - can we just await even longer for a single message to arrive, then check what that message is (assert it is an error), and finally assert that the connection is closed in a &lt;tt&gt;Awaitlily&lt;/tt&gt; loop?&lt;/p&gt;
</comment>
                            <comment id="17767970" author="beobal" created="Fri, 22 Sep 2023 11:41:55 +0000"  >&lt;p&gt;Yep, I think that would probably work just as welI (I don&apos;t think we had started using &lt;tt&gt;Awaitility&lt;/tt&gt; when the test was first written, or maybe I just wasn&apos;t aware of it then).&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17767973" author="jlewandowski" created="Fri, 22 Sep 2023 11:43:23 +0000"  >&lt;p&gt;Let&apos;s try that then, maybe it will help getting rid of this flakiness. Thanks for explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17769541" author="jlewandowski" created="Wed, 27 Sep 2023 10:54:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/903/workflows/0dceaede-a0ee-4bbf-af12-d97ad99e6bd1/jobs/30926/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/903/workflows/0dceaede-a0ee-4bbf-af12-d97ad99e6bd1/jobs/30926/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17769579" author="jlewandowski" created="Wed, 27 Sep 2023 12:42:37 +0000"  >&lt;p&gt;Comparing to the successful run, there are two message missing in the failing run:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [epollEventLoopGroup-20-2] Discarded inbound message BufferPoolAllocator$Wrapped(ridx: 0, widx: 65528, cap: 65536) that reached at the tail of the pipeline. Please check your pipeline configuration.
DEBUG [epollEventLoopGroup-20-2] Discarded message pipeline : [DefaultChannelPipeline$TailContext#0]. Channel : [id: 0xa5a32134, L:/127.0.0.1:33245 ! R:/127.0.0.1:37322].
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17769646" author="jlewandowski" created="Wed, 27 Sep 2023 14:30:54 +0000"  >&lt;p&gt;Ha! I&apos;ve managed to reproduce it quite reliably! Just added a short sleep in the &lt;tt&gt;SimpleClient#maybeWrite&lt;/tt&gt; loop.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;, I admit that my previous explanation was wrong.&lt;/p&gt;

&lt;p&gt;When the messages are being sent, they are split into frames. The corrupted frame is not the last one the test tries to send. Also, those messages are sent asynchronously.&lt;/p&gt;

&lt;p&gt;The test expects the connection to be closed by the server, and the client can no longer read from the channel. As a result, we get an exception, which marks the connection as closed. In such a case, we can expect the custom error message to appear in the buffer. &lt;/p&gt;

&lt;p&gt;However, there is a race - the client may fail due to the inability to send some remaining frames. This can be clearly seen when we log the error message from the exception handling code:&lt;/p&gt;

&lt;p&gt;expected behaviour:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [TEST-CLIENT:1] 2023-09-27 15:25:31,673 CQLConnectionTest.java:1059 - Connection exception: 
java.io.IOException: Connection reset by peer
	at java.base/sun.nio.ch.FileDispatcherImpl.read0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)
	at java.base/sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:276)
	at java.base/sun.nio.ch.IOUtil.read(IOUtil.java:233)
	at java.base/sun.nio.ch.IOUtil.read(IOUtil.java:223)
	at java.base/sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:356)
	at io.netty.buffer.UnpooledDirectByteBuf.setBytes(UnpooledDirectByteBuf.java:570)
	at io.netty.buffer.AbstractByteBuf.writeBytes(AbstractByteBuf.java:1132)
	at io.netty.channel.socket.nio.NioSocketChannel.doReadBytes(NioSocketChannel.java:357)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:151)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;unexpected behaviour (with sleep in flush loop on the client side):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [TEST-CLIENT:1] 2023-09-27 15:31:01,896 CQLConnectionTest.java:1059 - Connection exception: 
java.io.IOException: Connection reset by peer
	at java.base/sun.nio.ch.FileDispatcherImpl.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:113)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:50)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:462)
	at io.netty.channel.socket.nio.NioSocketChannel.doWrite(NioSocketChannel.java:415)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.flush0(AbstractChannel.java:931)
	at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.flush0(AbstractNioChannel.java:354)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.flush(AbstractChannel.java:895)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.flush(DefaultChannelPipeline.java:1372)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush0(AbstractChannelHandlerContext.java:921)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush(AbstractChannelHandlerContext.java:907)
	at io.netty.channel.AbstractChannelHandlerContext.flush(AbstractChannelHandlerContext.java:893)
	at io.netty.channel.ChannelOutboundHandlerAdapter.flush(ChannelOutboundHandlerAdapter.java:125)
	at io.netty.channel.AbstractChannelHandlerContext.invokeFlush0(AbstractChannelHandlerContext.java:925)
	at io.netty.channel.AbstractChannelHandlerContext.invokeWriteAndFlush(AbstractChannelHandlerContext.java:941)
	at io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:966)
	at io.netty.channel.AbstractChannelHandlerContext.writeAndFlush(AbstractChannelHandlerContext.java:934)
	at org.apache.cassandra.transport.SimpleClient$SimpleFlusher.writeLargeMessage(SimpleClient.java:820)
	at org.apache.cassandra.transport.SimpleClient$SimpleFlusher.maybeWrite(SimpleClient.java:744)
	at org.apache.cassandra.transport.SimpleClient$SimpleFlusher.lambda$schedule$0(SimpleClient.java:722)
	at io.netty.util.concurrent.PromiseTask.runTask(PromiseTask.java:98)
	at io.netty.util.concurrent.ScheduledFutureTask.run(ScheduledFutureTask.java:159)
	at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In particular, I presume that the failure scenario is as follows:&lt;br/&gt;
1. C sends the correct frames&lt;br/&gt;
2. C sends the corrupted frame&lt;br/&gt;
3. S receives the corrupted frame, sends the error message, and closes the connection&lt;br/&gt;
4. C sends the correct frames&lt;br/&gt;
5. OS responds with RST as the socket is already closed&lt;br/&gt;
6. C receives RST before anything else (before the error message and legitimate connection close request from the S)&lt;br/&gt;
7. C closes the connection&lt;/p&gt;</comment>
                            <comment id="17769665" author="jlewandowski" created="Wed, 27 Sep 2023 15:13:38 +0000"  >&lt;p&gt;I think that to fix this flakiness we have to make sure that the test corrupts the last frame. Perhaps it would be better to corrupt the frame on the client side so that it is certain that no more frames are tried to be sent after the corrupted frame?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17769926" author="beobal" created="Thu, 28 Sep 2023 07:04:54 +0000"  >&lt;p&gt;That doesn&apos;t sound unreasonable. I think it&apos;s a nice property of the test to &lt;em&gt;not&lt;/em&gt; rely on it being the last sent frame that&apos;s corrupt, but obviously that&apos;s invalidated if it makes the test unreliable.&#160;&lt;/p&gt;</comment>
                            <comment id="17769930" author="jlewandowski" created="Thu, 28 Sep 2023 07:10:02 +0000"  >&lt;p&gt;alternatively, if we want to reliably verify the error message is sent, we can use byteman and not rely the client receiving it - this is probably a simpler approach and we verify exactly what we want to verify.&lt;/p&gt;</comment>
                            <comment id="17770183" author="beobal" created="Thu, 28 Sep 2023 17:33:19 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;</comment>
                            <comment id="17770188" author="beobal" created="Thu, 28 Sep 2023 17:37:25 +0000"  >&lt;p&gt;We may as well commit this to 4.0/4.1/5.0 as this is essentially a test-only fix (SimpleClient is only used in tests / stress and the changes there only really amount to additional TRACE logging anyway). WDYT?&lt;/p&gt;</comment>
                            <comment id="17771378" author="jlewandowski" created="Tue, 3 Oct 2023 08:33:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;We may as well commit this to 4.0/4.1/5.0 as this is essentially a test-only fix (SimpleClient is only used in tests / stress and the changes there only really amount to additional TRACE logging anyway). WDYT?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;sure&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13379304">CASSANDRA-16677</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13519653">CASSANDRA-18161</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uv3k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12349261">4.0.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/8486d678b0ee89931627aa5a00a2c5577f93f0a0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/8486d678b0ee89931627aa5a00a2c5577f93f0a0&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run repeated tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>