<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14815] SEPExecutor does not fully shut down</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14815</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When trying to shut down an SEP Executor, a parked worked will still be parked on:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sun.misc.Unsafe.park(Native Method)
java.util.concurrent.locks.LockSupport.park(LockSupport.java:304)
org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:88)
io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13190994">CASSANDRA-14815</key>
            <summary>SEPExecutor does not fully shut down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="ifesdjeen">Alex Petrov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Oct 2018 17:24:10 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:56 +0000</updated>
                            <resolved>Tue, 15 Jan 2019 19:20:28 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16646799" author="ifesdjeen" created="Thu, 11 Oct 2018 17:31:36 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/281/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/8022c393-5c08-4643-84ae-a778b2a53656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16705020" author="benedict" created="Fri, 30 Nov 2018 16:54:15 +0000"  >&lt;p&gt;I&apos;ve pushed a modified approach &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s a rare possible race condition, but unilaterally invoking &lt;tt&gt;set(Work.DEAD)&lt;/tt&gt; would not have guaranteed that the state was set to &lt;tt&gt;DEAD&lt;/tt&gt;, as there are places in the state machine where a worker may also unilaterally self-assign its state, knowing that nobody else would interfere with it.  In this case the state change would be lost.&lt;/p&gt;

&lt;p&gt;Perhaps this wouldn&apos;t be the end of the world, but if instead we introduce a &lt;tt&gt;pool.shuttingDown&lt;/tt&gt; boolean, and we check this only in the two places we might need to - namely when we cannot assign ourselves work (which will be the case if all executors have been shutdown), and when stopping ourselves (in case we have somehow been very delayed in stopping, and so the original termination did not signal us), we can also avoid introducing a new &lt;tt&gt;COWArrayList&lt;/tt&gt; to manage all of the worker threads.&lt;/p&gt;

&lt;p&gt;Oh, also, a spelling nit in the &lt;tt&gt;MAGIC&lt;/tt&gt; thread name indicator.&lt;/p&gt;</comment>
                            <comment id="16705112" author="benedict" created="Fri, 30 Nov 2018 18:18:55 +0000"  >&lt;p&gt;There is a downside to the approach I&apos;ve taken, which is that the threads are not guaranteed to have stopped by the time shutdown exits.  I&apos;ve added a follow-up commit that reduces this window, but this is still not a guarantee.  I think this commit is probably better to exclude, but I&apos;ll await your feedback.  I have a final commit that just has the test method invoke &lt;tt&gt;join()&lt;/tt&gt; on each matching thread with a short wait parameter, so that they have the opportunity to stop themselves.&lt;/p&gt;</comment>
                            <comment id="16708609" author="ifesdjeen" created="Tue, 4 Dec 2018 12:05:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Thank you for the review,&lt;/p&gt;

&lt;p&gt;You&apos;re right, I haven&apos;t noticed there are other calls to &lt;tt&gt;set&lt;/tt&gt; that would overwrite this state; CAS this used only during transition between executors, and all the other time worker is an exclusive owner. I did have a similar version to yours, but the way I implemented it initially (atomic boolean for stop signal and waiting twice on descheduled and once on spinning queues to make sure all tasks are drained), but thought we can do better. I like your version, however as it improves in terms of how we signal shutdown without having to spin.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed two minor suggestions: one is to take break out of the nested if and second - remove (seemingly) redundant call to &lt;tt&gt;terminateWorkers&lt;/tt&gt;, let me know what you think.&lt;/p&gt;</comment>
                            <comment id="16708628" author="benedict" created="Tue, 4 Dec 2018 12:22:04 +0000"  >&lt;p&gt;Yes, these changes are good.  +1. &lt;/p&gt;

&lt;p&gt;But: we should update the comments in &lt;tt&gt;terminateWorkers&lt;/tt&gt;, and we should add a comment to &lt;tt&gt;STOP_SIGNALLED&lt;/tt&gt; that it may ONLY be assigned in &lt;tt&gt;maybeStop&lt;/tt&gt; as we now depend on this for correctness of termination of the threads.  We should perhaps also put a comment under &lt;tt&gt;doWaitSpin&lt;/tt&gt; that we &lt;b&gt;must&lt;/b&gt; continue here to re-check &lt;tt&gt;isShuttingDown&lt;/tt&gt;.  Neither of these are strict requirements of the design, so whilst they shouldn&apos;t change, we should document the dependencies.&lt;/p&gt;</comment>
                            <comment id="16708704" author="ifesdjeen" created="Tue, 4 Dec 2018 13:32:15 +0000"  >&lt;p&gt;I&apos;ve pushed two more small changes: modify two of three suggested comments and revert wait-related code as unless we can wait for threads to &lt;em&gt;really&lt;/em&gt; stop, it seems to add not enough to justify the complexity. Let me know what you think.&lt;/p&gt;</comment>
                            <comment id="16709023" author="benedict" created="Tue, 4 Dec 2018 17:39:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/blob/cd7235d004d5ec99cb937fe213dd99b044782083/src/java/org/apache/cassandra/concurrent/SharedExecutorPool.java#L134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; I meant for &quot;enter the SPINNING state,&quot; to become something like &quot;are runnable&quot;, because we no longer require they enter the SPINNING state to check the condition (although we do enter the spinning state, it is no longer a requirement).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/commit/cd7235d004d5ec99cb937fe213dd99b044782083#diff-d9febddfa9880b152f1b86242708b862R83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; something slightly more descriptive about why would be useful, such as &quot;if the pool is terminating, but we have been assigned STOP_SIGNALLED, if we do not continue to re-check pool.shuttingDown this thread will block forever&quot;&lt;/p&gt;

&lt;p&gt;Otherwise, +1 LGTM&lt;/p&gt;</comment>
                            <comment id="16710137" author="ifesdjeen" created="Wed, 5 Dec 2018 14:44:20 +0000"  >&lt;p&gt;Thank you for the review, committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/eea68a2cfeb0134510deaaa5540afdf6d0c6ee7e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;eea68a2cfeb0134510deaaa5540afdf6d0c6ee7e&lt;/a&gt; to trunk.&lt;/p&gt;</comment>
                            <comment id="16710165" author="JIRAUSER308715" created="Wed, 5 Dec 2018 15:03:13 +0000"  >&lt;p&gt;I assume fixver here was 4.0? &#160;If not please correct it.&lt;/p&gt;</comment>
                            <comment id="16710168" author="benedict" created="Wed, 5 Dec 2018 15:03:49 +0000"  >&lt;p&gt;Actually, it would be great to backport this to 3.0, so that we can utilise it for mixed-version in-jvm dtests once they are backported.&lt;/p&gt;</comment>
                            <comment id="16710199" author="ifesdjeen" created="Wed, 5 Dec 2018 15:12:27 +0000"  >&lt;p&gt;Good point; I will reopen for back port.&lt;/p&gt;</comment>
                            <comment id="16743321" author="benedict" created="Tue, 15 Jan 2019 19:20:28 +0000"  >&lt;p&gt;The backport work for this is being tracked/handled in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14931&quot; title=&quot;Backport In-JVM dtests to 2.2, 3.0 and 3.11&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14931&quot;&gt;&lt;del&gt;CASSANDRA-14931&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z3hz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>