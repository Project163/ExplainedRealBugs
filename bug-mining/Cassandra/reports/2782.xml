<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6546] disablethrift results in unclosed file descriptors</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6546</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Disabling thrift results in unclosed thrift sockets being left around.&lt;/p&gt;


&lt;p&gt;Steps to reproduce and observe:&lt;/p&gt;

&lt;p&gt;1. Have a handful of clients connect via thrift.&lt;br/&gt;
2. Disable thrift.&lt;br/&gt;
3. Enable thrift, have the clients reconnect.&lt;br/&gt;
4. Observe netstat or lsof, and you&apos;ll find a lot of thrift sockets in CLOSE_WAIT state, and they&apos;ll never go away.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Also verifiable from org.apache.cassandra.metrics:type=Client,name=connectedThriftClients MBean.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;What&apos;s extra fun about this is the leaked sockets still count towards your maximum RPC thread count. As a result, toggling thrift enough times will result in an rpc_max_threads number of CLOSED_WAIT sockets, with no new clients able to connect.&lt;/p&gt;

&lt;p&gt;This was reproduced with HSHA. I haven&apos;t tried it in sync yet.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12687183">CASSANDRA-6546</key>
            <summary>disablethrift results in unclosed file descriptors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mishail">Mikhail Stepura</assignee>
                                    <reporter username="alienth">Jason Harvey</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Jan 2014 13:23:40 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:56 +0000</updated>
                            <resolved>Thu, 1 May 2014 22:25:14 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                    <fixVersion>2.0.8</fixVersion>
                    <fixVersion>2.1 rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13862019" author="alienth" created="Fri, 3 Jan 2014 23:18:57 +0000"  >&lt;p&gt;Might be a regression of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3867&quot; title=&quot;Disablethrift and Enablethrift can leaves behind zombie connections on THSHA server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3867&quot;&gt;&lt;del&gt;CASSANDRA-3867&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13935284" author="enigmacurry" created="Fri, 14 Mar 2014 17:24:04 +0000"  >&lt;p&gt;Tested the following:&lt;/p&gt;

&lt;p&gt;Scenario 1:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;rpc_max_threads: 16&lt;/li&gt;
	&lt;li&gt;rpc_server_type: sync&lt;/li&gt;
	&lt;li&gt;Create 16 pycassa thrift connections, try to create one more, it blocks due to rpc_max_threads reached. Seems like correct behavior.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Scenario 2:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;rpc_max_threads: 16&lt;/li&gt;
	&lt;li&gt;rpc_server_type: sync&lt;/li&gt;
	&lt;li&gt;Create 16 pycassa thrift connections, disable thrift, reenable thrift, try to create 16 more thrift connections, it works, and connectedThriftClients mbean counts up to ~32. This can be looped as many times as you want, until maximum sockets allowed by ulimit is reached (1024 on my machine). netstat shows all of those connections in ESTABLISHED state on my machine.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Scenario 3:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;rpc_max_threads: 16&lt;/li&gt;
	&lt;li&gt;rpc_server_type: hsha&lt;/li&gt;
	&lt;li&gt;Create as many connections as you want, it never blocks until Linux ulimit is reached (1024 on my machine). With hsha enabled, rpc_max_threads does not cap the number of connections, though that may be to due the asynchronous design. I haven&apos;t figured out how to check how many actual threads are running.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Scenario 4:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;rpc_max_threads: 16&lt;/li&gt;
	&lt;li&gt;rpc_server_type: hsha&lt;/li&gt;
	&lt;li&gt;Same scenario as 3 but introduce thrift disable/reenable between 16 connection starts. Same effect, create as many connections as you want up to ulimit.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Scenario 2 seems like a definite bug, I&apos;m not sure about 3 and 4.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/blob/262b2918250aa53b8010804023a35f288d9e9073/thrift_hsha_test.py#L19&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&apos;s the script I&apos;m using to test&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13977497" author="jbellis" created="Tue, 22 Apr 2014 21:46:56 +0000"  >&lt;p&gt;Do you want to take a stab at this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mishail&quot; class=&quot;user-hover&quot; rel=&quot;mishail&quot;&gt;mishail&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13977509" author="mishail" created="Tue, 22 Apr 2014 21:53:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; will do&lt;/p&gt;</comment>
                            <comment id="13985953" author="mishail" created="Wed, 30 Apr 2014 19:25:11 +0000"  >&lt;p&gt;I&apos;ve reproduced the problem on 1.2 with HSHA, for some reason &lt;tt&gt;ThriftSessionManager.connectionComplete(SocketAddress)&lt;/tt&gt; is never called in this case.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mstepura-mac:logs mikhail$ lsof -p 84299 | grep CLOSE_WAIT | wc -l
     150
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And all those 150 connections are still sitting in ThriftSessionManager&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://issues.apache.org/jira/images/icons/attach/noimage.png&quot; imagetext=&quot;2014-04-30 12-22-17.png&quot; align=&quot;absmiddle&quot; border=&quot;0&quot; /&gt;&lt;br/&gt;
&lt;img src=&quot;https://issues.apache.org/jira/images/icons/attach/noimage.png&quot; imagetext=&quot;2014-04-30 12-22-58.png&quot; align=&quot;absmiddle&quot; border=&quot;0&quot; /&gt;&lt;/p&gt;</comment>
                            <comment id="13986068" author="mishail" created="Wed, 30 Apr 2014 20:54:39 +0000"  >&lt;p&gt;So, we have to cleanup slector keys in HSHA server before closing the selector itself.&lt;/p&gt;

&lt;p&gt;There is no such issue with the SYNC server, and behavior observed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt; in &quot;Scenario 2&quot; happens because his script didn&apos;t close the connections from &lt;b&gt;the client side&lt;/b&gt;, and all those ESTABLISHED connections are actually held by the client. As soon as the client(s) close the connections (using &lt;tt&gt;pool.dispose()&lt;/tt&gt; in dtest for ex.) those ESTABLISHED will be gone. And that is correct.&lt;/p&gt;

&lt;p&gt;In case of HSHA those ESTABLISHED would become CLOSE_WAIT, and attached patch cleans them up.&lt;/p&gt;</comment>
                            <comment id="13986111" author="mishail" created="Wed, 30 Apr 2014 21:25:14 +0000"  >&lt;p&gt;I&apos;m observing the same CLOSE_WAIT behavior with for 2.0 (using THsHaDisruptorServer). Need to figure out how to fix that&lt;/p&gt;</comment>
                            <comment id="13986181" author="mishail" created="Wed, 30 Apr 2014 22:47:41 +0000"  >&lt;p&gt;To fix this for 2.x we have to use the latest build of &lt;tt&gt;thrift-server&lt;/tt&gt; - &lt;a href=&quot;https://github.com/xedin/disruptor_thrift_server/pull/7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xedin/disruptor_thrift_server/pull/7&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13987046" author="brandon.williams" created="Thu, 1 May 2014 21:55:07 +0000"  >&lt;p&gt;+1, but we shouldn&apos;t call it 0.3.4 unless it&apos;s actually an 0.3.4 release.&lt;/p&gt;</comment>
                            <comment id="13987082" author="mishail" created="Thu, 1 May 2014 22:25:04 +0000"  >&lt;p&gt;Commited that as &lt;tt&gt;thrift-server-internal-only-0.3.3.jar&lt;/tt&gt;&lt;br/&gt;
Pushed dtest as well &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/47&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12642719" name="CASSANDRA-6546-1.2.patch" size="1117" author="mishail" created="Wed, 30 Apr 2014 20:54:39 +0000"/>
                            <attachment id="12642765" name="CASSANDRA-6546-2.x.patch" size="213361" author="mishail" created="Wed, 30 Apr 2014 23:17:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mishail]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366178</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r4bj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366489</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325022">1.2.11</customfieldvalue>
    <customfieldvalue id="12326472">2.0.7</customfieldvalue>
    <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>