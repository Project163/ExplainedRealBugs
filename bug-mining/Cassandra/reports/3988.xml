<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10374] List and Map values incorrectly limited to 64k size</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10374</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;With the v3 native protocol, we switched from encoding collection element sizes with shorts to ints.  However, in &lt;tt&gt;Lists.java&lt;/tt&gt; and &lt;tt&gt;Maps.java&lt;/tt&gt;, we still validate that list and map values are smaller than &lt;tt&gt;MAX_UNSIGNED_SHORT&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Map keys and set elements are stored in the cell name, so they&apos;re implicitly limited to the cell name size limit of 64k.  However, for non-frozen collections, this limitation should not apply, so we probably don&apos;t want to perform this check here for those either.&lt;/p&gt;

&lt;p&gt;The fix should include tests where we exceed the 64k limit for frozen and non-frozen collections.  In the case of non-frozen lists and maps, we should verify that the 64k cell-name size limit is enforced in a friendly way.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12888636">CASSANDRA-10374</key>
            <summary>List and Map values incorrectly limited to 64k size</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Sep 2015 18:45:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:55 +0000</updated>
                            <resolved>Thu, 3 Dec 2015 21:59:39 +0000</resolved>
                                        <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15036070" author="blerer" created="Wed, 2 Dec 2015 16:27:59 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blerer/cassandra/tree/10374-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blerer/cassandra/tree/10374-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blerer/cassandra/tree/10374-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10374-2.1-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10374-2.2-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10374-3.0-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10374-2.1-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10374-2.2-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-10374-3.0-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The patches for &lt;tt&gt;2.1&lt;/tt&gt; and &lt;tt&gt;2.2&lt;/tt&gt; make sure that we accept list and map values greater than 64k and that we reject set elements and map keys which result in a cellname bigger than 64k.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;3.0&lt;/tt&gt; the limit for map key and set elements is 2G. The patch makes sure that we accept values and keys greater than 64k everywhere.&lt;/p&gt;</comment>
                            <comment id="15037514" author="slebresne" created="Thu, 3 Dec 2015 08:53:42 +0000"  >&lt;p&gt;It occurred to me that we might not want to commit this to 2.1/2.2. The problem is that those versions still support the protocol v1 and v2, so while you can insert values greater than 64k in collections, another client that is using v1/v2 wouldn&apos;t be able to read it correctly. I suppose we could say that if you start using this you should be sticking to the protocol v3, but it&apos;s still feel a bit easy to shoot yourself in the foot. And 3.0 removes pre-v3 protocol versions, so this feels like the ideal version to lift that limitation (in theory you can still have a mixed-version cluster with pre-3.0 nodes that talk to clients using the v2 protocol, but that is starting to be far fetched since you&apos;d kind of need to upgrade your client to v3 first if you want to start a 3.0 upgrade).&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;m +1 on the 3.0 patch but I haven&apos;t looked closely to the other versions. And I suggest we commit to 3.0 only unless someone has a strong objection (knowing that if someone is motivated enough to have this in previous versions, he can apply the attached patches manually).&lt;/p&gt;</comment>
                            <comment id="15037583" author="fabryb" created="Thu, 3 Dec 2015 09:53:43 +0000"  >&lt;p&gt;Is there an EASY way to prevent v1/v2 clients acces to values bigger than 64K so it&apos;s safe to release this in 2.1/2.2 without side effects ?&lt;/p&gt;

&lt;p&gt;For example: we have implemented a table that is needing about 200KB per value with this bug in mind and assuming (probably bad idea) that this bug would have been fixed soon in 2.1/2.2 as stated in Fix Versions.&lt;br/&gt;
I assume 3.0 would not be declared stable very soon, so we are waiting for this fix&lt;/p&gt;</comment>
                            <comment id="15037602" author="fabryb" created="Thu, 3 Dec 2015 10:09:21 +0000"  >&lt;p&gt;Maybe we can add a new configuration option (something like &quot;enable_big_collection_values&quot;) which is default to false in 2.1 and 2.2 so nothing changes unless some wants it, and is default to true on &amp;gt;= 3.0 (or doesn&apos;t exist at all), with a proper comment (in 2.1/2.2) which inform users that enabling that option breakes compatibility with protocols v1 and v2.&lt;/p&gt;

&lt;p&gt;Can this be good enough ?&lt;/p&gt;</comment>
                            <comment id="15037659" author="slebresne" created="Thu, 3 Dec 2015 10:55:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe we can add a new configuration option&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We avoid adding new configuration unless the justification for it is strong, as multiplying configuration options ends up more confusing than helpful (it also need to be documented and whatnot). That case absolutely does not meet our standard for justifying a configuration option.&lt;/p&gt;

&lt;p&gt;The thing is, using big values for collections is a bad idea in the first place as collection are always read entirely. Surely there is few cases that are reasonable yet run into that limit, and that&apos;s why we&apos;re looking at removing it, but this ticket is, I would argue, more of a an improvement and a minor one. Which justify in itself limiting it to 3.0.&lt;/p&gt;

&lt;p&gt;Further, we&apos;re actually not lifting the limit entirely in 2.1/2.2: because we still have the internal limitation on the cell name, the only case where we effectively allow &amp;gt; 64k values are lists and map values (not map key in particular). And for list, I would argue that using large-ish values is an even worst idea than for collections in general since they sometime trigger a read-before-write. And I certainly wouldn&apos;t want this to become a justification for going with lists over sets as it&apos;s a bad idea in the long term.&lt;/p&gt;

&lt;p&gt;So to sum up, in 2.1/2.2, committing this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;is a problem for earlier protocol version&lt;/li&gt;
	&lt;li&gt;create inconsistencies in collections (not all collections are limited similarly)&lt;/li&gt;
	&lt;li&gt;is arguably only vaguely reasonable for map values.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I do strongly think 3.0-only is the most reasonable thing to do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we have implemented a table that is needing about 200KB per value with this bug in mind and assuming (probably bad idea) that this bug would have been fixed soon in 2.1/2.2&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As hinted above, I&apos;d argue that requiring 200KB values in collections is probably the first bad idea, but relying on the tentative &quot;Fix versions&quot; of an unresolved ticket is certainly something to avoid. But as my previous comment said, if you&apos;re in that unfortunate situation, you still have the option of applying the patch locally.&lt;/p&gt;</comment>
                            <comment id="15038676" author="blerer" created="Thu, 3 Dec 2015 21:59:39 +0000"  >&lt;p&gt;Committed in 3.0 at bc9a61fc851791926e8d2b6134f2bbca68a0ae11 and merged into 3.1 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12914411">CASSANDRA-10732</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2l4t3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>