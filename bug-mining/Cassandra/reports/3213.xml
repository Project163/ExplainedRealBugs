<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7510] Notify clients that bootstrap is finished over binary protocol</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7510</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently, Cassandra will notify clients when a new node is added to a cluster. However, that node is typically not usable yet. It first needs to gossip its key range and finish loading all its assigned data before it allows clients to connect. Depending on the amount of data this may take quite a while. The clients in the mean time have no clue about the bootstrap status of that node. The only thing they can do is periodically check if it will accept a connection. &lt;/p&gt;

&lt;p&gt;My proposal would be to send an additional UP event when the bootstrap is done, this allows clients to mark the node initially as down/unavailable and simply wait for the UP event to arrive.&lt;/p&gt;

&lt;p&gt;Kind regards,&lt;br/&gt;
Joost&lt;/p&gt;</description>
                <environment></environment>
        <key id="12725949">CASSANDRA-7510</key>
            <summary>Notify clients that bootstrap is finished over binary protocol</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="Reuzel">Joost Reuzel</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Jul 2014 06:30:31 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:41 +0000</updated>
                            <resolved>Mon, 3 Nov 2014 17:01:15 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.2</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14054816" author="slebresne" created="Tue, 8 Jul 2014 10:45:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;My proposal would be to send an additional UP event when the bootstrap is done&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Frankly, I never intended the onAdd notification to be sent before the bootstrap, it&apos;s more a bug that never got fixed. Imo, it doesn&apos;t make a whole lot of sense to notify client at all until a node has been properly boostrapped, so I would &lt;b&gt;strongly&lt;/b&gt; prefer just fixing onAdd notifications so it&apos;s send only when the node is ready. Similarly, onUp is actually sent before the the native protocol server has been initialized because there is currently no proper place to do it. So really, what we should fix is that onAdd/onUp events for a given node should only be sent when the node in question is ready to receive connection on the native protocol server. This might require adding an additional gossip state/message so a node advertise when the protocol server is up and ready. &lt;/p&gt;</comment>
                            <comment id="14055374" author="reuzel" created="Tue, 8 Jul 2014 19:37:42 +0000"  >&lt;p&gt;Sounds even better.&lt;/p&gt;</comment>
                            <comment id="14055972" author="slebresne" created="Wed, 9 Jul 2014 07:57:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; do you have an idea of where would be a best place for moving the current notifications so we get closer to &quot;fired when the node is ready to receive native protocol requests&quot;? Regarding bootstrap, I suspect it shouldn&apos;t be too hard to make it fired after the bootstrap rather than before it but I&apos;m not entirely sure where exactly we would need to put that. But if we want to really fire the events when the native protocol server is ready, as I said above, I suspect we might a new &quot;I&apos;m ready&quot; gossip message or something like that. Or do we?&lt;/p&gt;</comment>
                            <comment id="14056171" author="brandon.williams" created="Wed, 9 Jul 2014 12:33:08 +0000"  >&lt;p&gt;We shouldn&apos;t need a new gossip state for this, I think what you want to do is change the onJoinCluster notification you&apos;re doing in SS.onAlive to actually be in SS.handleStateNormal, sort of like you do for sending onMove, except when the node hasn&apos;t moved.  Going to normal is the &quot;I&apos;m ready&quot; message already.&lt;/p&gt;</comment>
                            <comment id="14056186" author="brandon.williams" created="Wed, 9 Jul 2014 12:44:33 +0000"  >&lt;p&gt;Rough patch illustrating what I mean, but totally untested.&lt;/p&gt;</comment>
                            <comment id="14056193" author="slebresne" created="Wed, 9 Jul 2014 12:53:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Going to normal is the &quot;I&apos;m ready&quot; message already&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you sure that it means &quot;I&apos;m ready to receive client connections&quot;? My reading of the code is that STATUS_NORMAL is sent as part of SS.joinTokenRing which is itself part of SS.initServer. The latter being called in CassandraDaemon.setup &lt;b&gt;before&lt;/b&gt; we start the thrift and native protocol servers.&lt;/p&gt;

&lt;p&gt;Let me be clear: we currently send the onAdd notification before bootstrap which is wrong and we should at least move that to SS.handleStateNormal so it&apos;s send at the end of bootstrapping. I&apos;m on board with that part. However, I think that doesn&apos;t get us all the way to where we want to be, which is that we want to send onAdd/onUp notification only once the native protocol server is ready to accept connections.&lt;/p&gt;</comment>
                            <comment id="14056228" author="brandon.williams" created="Wed, 9 Jul 2014 13:32:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Are you sure that it means &quot;I&apos;m ready to receive client connections&quot;? My reading of the code is that STATUS_NORMAL is sent as part of SS.joinTokenRing which is itself part of SS.initServer. The latter being called in CassandraDaemon.setup before we start the thrift and native protocol servers.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If the node needs to bootstrap, it will send JOINING because joinTokenRing will call bootstrap which sets it.  It won&apos;t send NORMAL until bootstrap finishes and then it calls setTokens.  Now, this is all before it returns control from initServer back to CassandraDaemon.setup, so there is a &lt;b&gt;very&lt;/b&gt; small chance it could gossip it to another node before the rpc servers are started, but the only way around that is giving control of rpc startup to SS which feels ugly.&lt;/p&gt;</comment>
                            <comment id="14057851" author="reuzel" created="Thu, 10 Jul 2014 19:47:17 +0000"  >&lt;p&gt;Small additional question on this from a client programmer: Does the proposed change of sending the STATUS_NORMAL state later also mean that until that time the node does not show up in the system.peers table? The bootstrap process can take quite some time, and when a client is started, it will typically inspect the system.peers table for other nodes to contact. It would be great if a bootstrapping node is not (yet) available there, as a fresh client instance will otherwise encounter the same issue as reported above. &lt;/p&gt;

&lt;p&gt;Finally, it would be great if the current up/down(/bootstrapping) status is noted in the system.peers table so a client does not have to find out the hard way, but I suppose that may be another JIRA item.&lt;/p&gt;

&lt;p&gt;Thanks for the excellent support&lt;/p&gt;</comment>
                            <comment id="14173956" author="brandon.williams" created="Thu, 16 Oct 2014 17:03:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does the proposed change of sending the STATUS_NORMAL state later also mean that until that time the node does not show up in the system.peers table?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="14179082" author="thobbs" created="Tue, 21 Oct 2014 20:53:06 +0000"  >&lt;p&gt;I tested this out with a ccm cluster, and there&apos;s still a pretty large gap (8 seconds) between when the notification is sent and when the native protocol server is actually started.  It looks like most of that is due to waiting for gossip to settle:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [main] 2014-10-21 15:43:50,430 StorageService.java (line 1515) Node /127.0.0.4 state jump to normal
 INFO [main] 2014-10-21 15:43:50,444 CassandraDaemon.java (line 543) Waiting for gossip to settle before accepting client requests...
 INFO [CompactionExecutor:7] 2014-10-21 15:43:53,066 ColumnFamilyStore.java (line 794) Enqueuing flush of Memtable-compactions_in_progress@1446920230(0/0 serialized/live bytes, 1 ops)
 INFO [FlushWriter:1] 2014-10-21 15:43:53,067 Memtable.java (line 355) Writing Memtable-compactions_in_progress@1446920230(0/0 serialized/live bytes, 1 ops)
 INFO [FlushWriter:1] 2014-10-21 15:43:53,084 Memtable.java (line 395) Completed flushing /home/thobbs/.ccm/devcluster/node4/data/system/compactions_in_progress/system-compactions_in_progress-jb-2-Data.db (42 bytes) for commitlog position ReplayPosition(segmentId=1413924189183, position=13357643)
 INFO [CompactionExecutor:7] 2014-10-21 15:43:53,091 CompactionTask.java (line 287) Compacted 7 sstables to [/home/thobbs/.ccm/devcluster/node4/data/duration_test/ints/duration_test-ints-jb-8,].  2,672,491 bytes to 2,098,615 (~78% of original) in 2,755ms = 0.726459MB/s.  4,167 total partitions merged to 3,325.  Partition merge counts were {1:2497, 2:814, 3:14, }
 INFO [OptionalTasks:1] 2014-10-21 15:43:56,468 MeteredFlusher.java (line 58) flushing high-traffic column family CFS(Keyspace=&apos;duration_test&apos;, ColumnFamily=&apos;ints&apos;) (estimated 20392963 bytes)
 INFO [OptionalTasks:1] 2014-10-21 15:43:56,469 ColumnFamilyStore.java (line 794) Enqueuing flush of Memtable-ints@1788959623(3053505/20392963 serialized/live bytes, 136710 ops)
 INFO [FlushWriter:1] 2014-10-21 15:43:56,470 Memtable.java (line 355) Writing Memtable-ints@1788959623(3053505/20392963 serialized/live bytes, 136710 ops)
 INFO [FlushWriter:1] 2014-10-21 15:43:56,963 Memtable.java (line 395) Completed flushing /home/thobbs/.ccm/devcluster/node4/data/duration_test/ints/duration_test-ints-jb-9-Data.db (281136 bytes) for commitlog position ReplayPosition(segmentId=1413924189183, position=14376181)
 INFO [main] 2014-10-21 15:43:58,445 CassandraDaemon.java (line 575) No gossip backlog; proceeding
 INFO [main] 2014-10-21 15:43:58,551 Server.java (line 156) Starting listening for CQL clients on /127.0.0.4:9042...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I expect that in larger clusters the gap will be even larger.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure that we can do anything about this without adding something new to gossip, though.&lt;/p&gt;</comment>
                            <comment id="14183495" author="brandon.williams" created="Fri, 24 Oct 2014 21:10:34 +0000"  >&lt;p&gt;Argh, gossip settling.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure that we can do anything about this without adding something new to gossip, though.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure we can either, and it&apos;d be strange if we did, since we&apos;d essentially have two events that mean &apos;ready&apos; unless we did something like suppress the rpc_address state until it was bound, but that probably breaks clients in some other way at this point.&lt;/p&gt;</comment>
                            <comment id="14192416" author="thobbs" created="Fri, 31 Oct 2014 20:24:53 +0000"  >&lt;p&gt;Well, this is definitely an improvement over what we currently have, so I&apos;ll +1 committing this for now and open a new ticket to figure out the best way to delay UP notifications until the rpc server has started.&lt;/p&gt;</comment>
                            <comment id="14192463" author="thobbs" created="Fri, 31 Oct 2014 20:46:41 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8236&quot; title=&quot;Delay &amp;quot;node up&amp;quot; and &amp;quot;node added&amp;quot; notifications until native protocol server is started&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8236&quot;&gt;&lt;del&gt;CASSANDRA-8236&lt;/del&gt;&lt;/a&gt; for a more complete solution.&lt;/p&gt;</comment>
                            <comment id="14194731" author="brandon.williams" created="Mon, 3 Nov 2014 17:01:15 +0000"  >&lt;p&gt;SGTM, committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12654792" name="7510.txt" size="1270" author="brandon.williams" created="Wed, 9 Jul 2014 12:44:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404107</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xjrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404147</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>