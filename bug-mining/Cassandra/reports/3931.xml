<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10258] Reject counter writes in CQLSSTableWriter</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10258</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We use CQLSStableWriter to produce testing datasets.&lt;/p&gt;

&lt;p&gt;Here are the steps to reproduce this issue :&lt;/p&gt;

&lt;p&gt;1) definition of a table with counter&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE my_counter (
  my_id text,
  my_counter counter,
  PRIMARY KEY (my_id)
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) with CQLSSTableWriter initialize this table (about 2millions entries) with this insert order (one insert / key only)&lt;br/&gt;
&lt;tt&gt;UPDATE myks.my_counter SET my_counter = my_counter + ? WHERE my_id = ?&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;3) load the files written by CQLSSTableWriter with sstableloader in your cassandra cluster (tested on a single node and a 3 nodes cluster)&lt;/p&gt;

&lt;p&gt;4) start a process that updates the counters (we used 3millions entries distributed on the key my_id)&lt;/p&gt;

&lt;p&gt;5) after a while try to query a key in the my_counter table&lt;br/&gt;
&lt;tt&gt;cqlsh:myks&amp;gt; select * from my_counter where my_id=&apos;0000001&apos;;&lt;/tt&gt;&lt;br/&gt;
Request did not complete within rpc_timeout.&lt;/p&gt;

&lt;p&gt;In the logs of cassandra (2.0.12) :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:3] 2015-05-28 15:53:39,491 CassandraDaemon.java (line 258) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:3,1,main]
java.lang.AssertionError: Wrong &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;type.
        at org.apache.cassandra.db.CounterUpdateColumn.reconcile(CounterUpdateColumn.java:70)
        at org.apache.cassandra.db.ArrayBackedSortedColumns.resolveAgainst(ArrayBackedSortedColumns.java:147)
        at org.apache.cassandra.db.ArrayBackedSortedColumns.addColumn(ArrayBackedSortedColumns.java:126)
        at org.apache.cassandra.db.ColumnFamily.addColumn(ColumnFamily.java:121)
        at org.apache.cassandra.db.compaction.PrecompactedRow$1.reduce(PrecompactedRow.java:120)
        at org.apache.cassandra.db.compaction.PrecompactedRow$1.reduce(PrecompactedRow.java:115)
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:112)
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:98)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138)
        at org.apache.cassandra.db.filter.SliceQueryFilter.collectReducedColumns(SliceQueryFilter.java:191)
        at org.apache.cassandra.db.compaction.PrecompactedRow.merge(PrecompactedRow.java:144)
        at org.apache.cassandra.db.compaction.PrecompactedRow.merge(PrecompactedRow.java:103)
        at org.apache.cassandra.db.compaction.PrecompactedRow.&amp;lt;init&amp;gt;(PrecompactedRow.java:85)
        at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:196)
        at org.apache.cassandra.db.compaction.CompactionIterable$Reducer.getReduced(CompactionIterable.java:74)
        at org.apache.cassandra.db.compaction.CompactionIterable$Reducer.getReduced(CompactionIterable.java:55)
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:115)
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:98)
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138)
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:164)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the logs of cassandra v2.1.5 :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  [SharedPool-Worker-38] 2015-06-11 16:39:06,008  AbstractTracingAwareExecutorService.java:169 - Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-38,5,
main]: {}
java.lang.AssertionError: Wrong &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;type: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.db.BufferCounterUpdateCell
        at org.apache.cassandra.db.AbstractCell.reconcileCounter(AbstractCell.java:211) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.BufferCounterCell.reconcile(BufferCounterCell.java:118) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.filter.QueryFilter$1.reduce(QueryFilter.java:122) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.filter.QueryFilter$1.reduce(QueryFilter.java:116) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:114) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:100) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143) ~[guava-16.0.1.jar:na]
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138) ~[guava-16.0.1.jar:na]
        at org.apache.cassandra.db.filter.NamesQueryFilter.collectReducedColumns(NamesQueryFilter.java:100) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.filter.QueryFilter.collateColumns(QueryFilter.java:108) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:82) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:69) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:314) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:62) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1900) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1758) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:346) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.SliceByNamesReadCommand.getRow(SliceByNamesReadCommand.java:53) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.CounterMutation.getCurrentValuesFromCFS(CounterMutation.java:262) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.CounterMutation.getCurrentValues(CounterMutation.java:229) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.CounterMutation.processModifications(CounterMutation.java:197) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.db.CounterMutation.apply(CounterMutation.java:124) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.service.StorageProxy$8.runMayThrow(StorageProxy.java:1155) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2191) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_45]
        at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) ~[cassandra-all-2.1.5.469.jar:2.1.5.469]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [cassandra-all-2.1.5.469.jar:2.1.5.469]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;same exception as issue &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7188&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-7188&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux Debian Wheezie 7.8 / Oracle Java 1.7.0_67&lt;br/&gt;
Ubuntu 14.04.3 LTS / Oracle Java 1.7.0_75&lt;br/&gt;
Cassandra 2.0.12 2.1.5 2.1.8&lt;/p&gt;</environment>
        <key id="12861596">CASSANDRA-10258</key>
            <summary>Reject counter writes in CQLSSTableWriter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="gviel_cdlk">Guillaume VIEL</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Sep 2015 14:47:21 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:57 +0000</updated>
                            <resolved>Tue, 10 Nov 2015 13:49:44 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14963228" author="vadim_ps" created="Mon, 19 Oct 2015 12:32:28 +0000"  >&lt;p&gt;We have the same behavior on  counter&apos;s table in cassandra 2.1.8. In the case of inserting data only through sstable the data was successfully inserts and reads. In the case of mixed inserts (java-driver CQL and jmx-sstableloader) in  same column-family we had read timeout and warning in cassandra.log (below):&lt;/p&gt;

&lt;p&gt;java.lang.AssertionError: Wrong class type: class org.apache.cassandra.db.BufferCounterUpdateCell&lt;br/&gt;
        at org.apache.cassandra.db.AbstractCell.reconcileCounter(AbstractCell.java:211) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.BufferCounterCell.reconcile(BufferCounterCell.java:118) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.filter.QueryFilter$1.reduce(QueryFilter.java:122) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.filter.QueryFilter$1.reduce(QueryFilter.java:116) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:114) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:100) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-16.0.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-16.0.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.filter.SliceQueryFilter.collectReducedColumns(SliceQueryFilter.java:264) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.filter.QueryFilter.collateColumns(QueryFilter.java:108) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.filter.QueryFilter.collateOnDiskAtom(QueryFilter.java:82) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.RowIteratorFactory$2.getReduced(RowIteratorFactory.java:99) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.RowIteratorFactory$2.getReduced(RowIteratorFactory.java:71) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:117) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:100) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-16.0.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-16.0.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore$8.computeNext(ColumnFamilyStore.java:2048) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore$8.computeNext(ColumnFamilyStore.java:2044) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-2.1.8.621.jar:2.1.8.621&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-16.0.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-16.0.1.jar:na&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14966144" author="pauloricardomg" created="Wed, 21 Oct 2015 02:36:39 +0000"  >&lt;p&gt;I was able to reproduce the issue above with a simple &lt;a href=&quot;https://github.com/apache/cassandra/commit/24ab53e4b3b6512488b9ba119f777a84ebd6fa0b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test case&lt;/a&gt; on Cassandra 2.1.&lt;/p&gt;

&lt;p&gt;The problem is that &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt; serializes &lt;tt&gt;CounterUpdateCell&lt;/tt&gt; objects without being applied by a counter leader replica, so they cannot be reconciled with ordinary &lt;tt&gt;CounterCell&lt;/tt&gt; objects during reads/compactions. Another limitation with &lt;tt&gt;CQLSStableWriter&lt;/tt&gt; and counters on 2.1, is that multiple counter updates to the same partition are not coalesced by &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt;, so only the last counter update is applied.&lt;/p&gt;

&lt;p&gt;Surprisingly enough, on 3.0, it&apos;s not possible to reproduce this issue, because &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt; abolished the &lt;tt&gt;CounterUpdateCells&lt;/tt&gt; altogether, so &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt; counter cells are treated as remote shards during reconcile. Furthermore, the &lt;tt&gt;PartitionUpdate&lt;/tt&gt; abstraction, also introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt;, merges all updates to the same partition before serialization on &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt;, so multiple updates to the same partition are indeed coalesced on 3.0.&lt;/p&gt;

&lt;p&gt;We could fix the 2.1 behavior by special-casing the counter cell creation on &lt;tt&gt;UpdateParameters.addCounter()&lt;/tt&gt; when &lt;tt&gt;Config.isClientMode()&lt;/tt&gt; (an indication that the &lt;tt&gt;CQLSStableWriter&lt;/tt&gt; is running) and creating a remote &lt;tt&gt;CounterCell&lt;/tt&gt; instead, as done &lt;a href=&quot;https://github.com/apache/cassandra/blob/5449ad7b7e1b1930c07e0ea80ac3c3e2882633b5/src/java/org/apache/cassandra/cql3/UpdateParameters.java#L79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;in this commented block&lt;/a&gt;. This would mimic the 3.0 behavior and treat &lt;tt&gt;CQLSStableWriter&lt;/tt&gt; counters as a remote shard.&lt;/p&gt;

&lt;p&gt;A hidden nit in this solution (and also on 3.0) is that a remote counter context is created for each &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt; session that updates counters, and afaik we currently have no way of discarding old counter contexts. So, new counter contexts created by &lt;tt&gt;CQLSStableWriter&lt;/tt&gt; can potentially grow unbounded, what could affect performance significantly. Maybe after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6506&quot; title=&quot;counters++ split counter context shards into separate cells&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6506&quot;&gt;CASSANDRA-6506&lt;/a&gt; we will be able to discard &quot;inactive&quot; counter contexts, and be able to support counters on &lt;tt&gt;CQLSStableWriter&lt;/tt&gt; more efficiently.&lt;/p&gt;

&lt;p&gt;While we don&apos;t have a solution for cleaning inactive/temporary counter contexts, I propose we disable counters usage by default on &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt;, or at least make it harder to use (with a flag/warning, for instance), since it might still be useful for testing scenarios. What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;? Do you see a better alternative?&lt;/p&gt;</comment>
                            <comment id="14966801" author="slebresne" created="Wed, 21 Oct 2015 13:24:35 +0000"  >&lt;p&gt;I think we should just forbid the use of counters in CQLSSTableWriter (in all version to be clear). By design, counters require for their efficiency that shards are only created on replicas, so that the set of &quot;node id&quot; contained in any counter stay relatively low. CQLSSTableWriter just doesn&apos;t fulfill that assumption and I don&apos;t think there is anything we can do about it. Generating a fake &quot;node id&quot; for each CQLSSTableWriter (which is what ends up happening) has a very high potential to blow the context sizes and it&apos;s a bad idea: you are much better off just using normal CQL updates if you want to load counters (sure that may be slower, but slower is better than broken).&lt;/p&gt;

&lt;p&gt;On top of that problem, there is the fact that if a given instance of CQLSSTableWriter increments the same counter twice, we &lt;b&gt;cannot&lt;/b&gt; guarantee that both increment will be added together because we cannot guarantee both increment will make it into the same sstable. If they don&apos;t (make it into the same sstable), then whatever node the sstables ends up to will consider those 2 separate shards as &quot;remote&quot; and won&apos;t add these together (we&apos;ll probably end up with a broken shard warning in fact).&lt;/p&gt;

&lt;p&gt;So really, the simplest and imo best solution is to add &quot;you cannot write sstable yourself with CQLSSTableWriter&quot; to the list of counters limitations.&lt;/p&gt;</comment>
                            <comment id="14969662" author="pauloricardomg" created="Thu, 22 Oct 2015 18:58:29 +0000"  >&lt;p&gt;Thanks for the quick feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Attached trivial patch and simple test forbidding counter updates on &lt;tt&gt;CQLSStableWriter&lt;/tt&gt;. Mind reviewing/committing?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14971292" author="iamaleksey" created="Fri, 23 Oct 2015 16:25:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;So really, the simplest and imo best solution is to add &quot;you cannot write sstable yourself with CQLSSTableWriter&quot; to the list of counters limitations.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Basically, this.&lt;/p&gt;</comment>
                            <comment id="14998603" author="iamaleksey" created="Tue, 10 Nov 2015 13:48:53 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/3674ad9dab8f29173d7d4ee82488a8e9ea586240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3674ad9dab8f29173d7d4ee82488a8e9ea586240&lt;/a&gt; to 2.1, merged with 2.2, 3.0, 3.1, and trunk. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jr1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328860">2.0.12</customfieldvalue>
    <customfieldvalue id="12329874">2.1.5</customfieldvalue>
    <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>