<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:41:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6483] Possible Collections.sort assertion failure in STCS.filterColdSSTables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6483</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have observed the following stack trace periodically:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalArgumentException: Comparison method violates its general contract!
        at java.util.TimSort.mergeLo(TimSort.java:747)
        at java.util.TimSort.mergeAt(TimSort.java:483)
        at java.util.TimSort.mergeCollapse(TimSort.java:410)
        at java.util.TimSort.sort(TimSort.java:214)
        at java.util.TimSort.sort(TimSort.java:173)
        at java.util.Arrays.sort(Arrays.java:659)
        at java.util.Collections.sort(Collections.java:217)
        at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.filterColdSSTables(SizeTieredCompactionStrategy.java:94)
        at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.getNextBackgroundSSTables(SizeTieredCompactionStrategy.java:59)
        at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.getNextBackgroundTask(SizeTieredCompactionStrategy.java:229)
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:191)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The comparator ant SizeTieredCompactionStrategy line 94 breaks the assertions in the new JDK7 default sort algorithm, because (I think just) the hotness value (based on meter) may be modified concurrently by another thread&lt;/p&gt;

&lt;p&gt;This bug appears to have been introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6109&quot; title=&quot;Consider coldness in STCS compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6109&quot;&gt;&lt;del&gt;CASSANDRA-6109&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12684385">CASSANDRA-6483</key>
            <summary>Possible Collections.sort assertion failure in STCS.filterColdSSTables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="graham sanderson">graham sanderson</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Fri, 13 Dec 2013 00:42:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:57 +0000</updated>
                            <resolved>Fri, 13 Dec 2013 23:13:53 +0000</resolved>
                                        <fixVersion>2.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13846982" author="graham sanderson" created="Fri, 13 Dec 2013 00:43:37 +0000"  >&lt;p&gt;Note the java option java.util.Arrays.useLegacyMergeSort could be used as a workaround, but it is unclear to me if that would produce desirable results&lt;/p&gt;</comment>
                            <comment id="13846987" author="graham sanderson" created="Fri, 13 Dec 2013 00:46:42 +0000"  >&lt;p&gt;The simplest fix is probably just to precompute an IdentityMap to any of the mutable data, and use it from within the comparator (since the comparator happens to be non static)&lt;/p&gt;

&lt;p&gt;Alternatively use a List of a new wrapper type and sort that instead.&lt;/p&gt;</comment>
                            <comment id="13847129" author="graham sanderson" created="Fri, 13 Dec 2013 03:53:18 +0000"  >&lt;p&gt;Adding my questions from dev-email thread&lt;/p&gt;

&lt;p&gt;Note that the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6109&quot; title=&quot;Consider coldness in STCS compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6109&quot;&gt;&lt;del&gt;CASSANDRA-6109&lt;/del&gt;&lt;/a&gt; feature claims to be &#8220;off&#8221; by default, however it isn&#8217;t immediately clear to me from that patch how &#8220;off&#8221; is implemented, and whether it is supposed to go down that code path even when &#8220;off&quot;&lt;/p&gt;

&lt;p&gt;I&#8217;m guessing there is no actual downside (other than ERROR level messages in the logs which cause alerts), since it just fails a subset of compactions?&lt;/p&gt;</comment>
                            <comment id="13847922" author="thobbs" created="Fri, 13 Dec 2013 21:31:38 +0000"  >&lt;p&gt;Attached patch 6483-2.0-v1.patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-6483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) builds a map of hotness values prior to the sort and uses that for comparisons.  I also made &lt;tt&gt;filterColdSSTables()&lt;/tt&gt; skip unneeded work if we won&apos;t be able to filter anything anyway.&lt;/p&gt;</comment>
                            <comment id="13847928" author="thobbs" created="Fri, 13 Dec 2013 21:37:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Note that the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6109&quot; title=&quot;Consider coldness in STCS compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6109&quot;&gt;&lt;del&gt;CASSANDRA-6109&lt;/del&gt;&lt;/a&gt; feature claims to be &#8220;off&#8221; by default, however it isn&#8217;t immediately clear to me from that patch how &#8220;off&#8221; is implemented, and whether it is supposed to go down that code path even when &#8220;off&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I answered this on the dev ML, but I&apos;ll repeat it here for others who are interested.  The default max_cold_reads_ratio is 0.0, so &lt;tt&gt;filterColdSSTables()&lt;/tt&gt; shouldn&apos;t filter any SSTables.  When writing this patch, I realized that even with that set to 0.0, SSTables that have no read activity at all would still be filtered out.  However, after this patch, that&apos;s no longer true, and a setting of 0.0 will prevent any filtering at all.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&#8217;m guessing there is no actual downside (other than ERROR level messages in the logs which cause alerts), since it just fails a subset of compactions?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s correct, this shouldn&apos;t cause any other problems, only delay some compactions.&lt;/p&gt;</comment>
                            <comment id="13848045" author="jbellis" created="Fri, 13 Dec 2013 23:13:53 +0000"  >&lt;p&gt;LGTM, committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12778734">CASSANDRA-8885</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12671094">CASSANDRA-6109</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12618692" name="6483-2.0-v1.patch" size="3181" author="thobbs" created="Fri, 13 Dec 2013 21:31:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363457</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qnfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363763</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325322">2.0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>