<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11159] SASI indexes don&apos;t switch memtable on flush</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11159</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;SASI maintains its own in-memory structures for indexing the contents of a base Memtable. On flush, these are simply discarded &amp;amp; replaced with an new instance, whilst the on disk index is built as the base memtable is flushed to SSTables. &lt;/p&gt;

&lt;p&gt;SASIIndex implements INotificationHandler and this switching of the index memtable is triggered by receipt of a MemtableRenewedNotification. In the original SASI implementation, one of the necessary modifications to C* was to emit this notification from DataTracker::switchMemtable, but this was overlooked when porting to 3.0. The net result is that the index memtable is never switched out, which eventually leads to OOME. &lt;/p&gt;

&lt;p&gt;Simply applying the original modification isn&apos;t entirely appropriate though, as it creates a window where it&apos;s possible for the index memtable to have been switched, but the flushwriter is yet to finish writing the new index sstables. During this window, index entries will be missing and query results inaccurate. &lt;/p&gt;

&lt;p&gt;I propose leaving Tracker::switchMemtable as is, so that INotificationConsumers are only notified from there when truncating, but adding similar notifications in Tracker::replaceFlushed, to fire after the View is updated. &lt;/p&gt;

&lt;p&gt;I&apos;m leaning toward re-using MemtableRenewedNotification for this as semantically I don&apos;t believe there&apos;s any meaningful difference between the flush and truncation cases here. If anyone has a compelling argument for a new notification type though to distinguish the two events, I&apos;m open to hear it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12938525">CASSANDRA-11159</key>
            <summary>SASI indexes don&apos;t switch memtable on flush</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xedin">Pavel Yaskevich</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Feb 2016 14:31:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:42 +0000</updated>
                            <resolved>Tue, 16 Feb 2016 21:15:48 +0000</resolved>
                                        <fixVersion>3.4</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15142806" author="beobal" created="Thu, 11 Feb 2016 14:34:00 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15143404" author="xedin" created="Thu, 11 Feb 2016 20:04:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; Sounds good to me!&lt;/p&gt;</comment>
                            <comment id="15143939" author="xedin" created="Fri, 12 Feb 2016 03:00:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; I ended up working on this today and it looks like we can&apos;t get away with simply switching index memtable after Tracker::replaceFlushed updated the view, because it would mean that some of the data from current memtable is going to be erased prematurely, ColumnIndex needs to keep a list of memtables pending flush much like View. I&apos;ve added two additional notifications - switched and discarded and a SASI test to make sure that everything is properly switched/discarded to &lt;a href=&quot;https://github.com/xedin/cassandra/tree/CASSANDRA-11159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11159&lt;/a&gt; branch. Please take a look and let me know what you think.&lt;/p&gt;</comment>
                            <comment id="15148650" author="beobal" created="Tue, 16 Feb 2016 14:24:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;ColumnIndex needs to keep a list of memtables pending flush&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I had suspected that might well be the case, the changes &amp;amp; test on your branch LGTM. &lt;/p&gt;

&lt;p&gt;I guess I might be tempted to mark &lt;tt&gt;getCurrentMemtable&lt;/tt&gt; and &lt;tt&gt;getPendingMemtables&lt;/tt&gt; in &lt;tt&gt;ColumnIndex&lt;/tt&gt; with &lt;tt&gt;@VisibleForTesting&lt;/tt&gt;, but that&apos;s pretty minor tbh.&lt;/p&gt;</comment>
                            <comment id="15149315" author="xedin" created="Tue, 16 Feb 2016 21:15:48 +0000"  >&lt;p&gt;Added @VisibleForTesting and committed. Thanks you for review, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2sq3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>