<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12149] NullPointerException on SELECT using index with token restrictions fully overriden by other PK restrictions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12149</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If I execute the sequence of queries (see the attached file), Cassandra aborts a connection reporting NPE on server side. SELECT query without token range filter works, but does not work when token range filter is specified. My intent was to issue multiple SELECT queries targeting the same single partition, filtered by a column indexed by SASI, partitioning results by different token ranges.&lt;/p&gt;

&lt;p&gt;Output from cqlsh on SELECT is the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; SELECT namespace, entity, timestamp, feature1, feature2 FROM mykeyspace.myrecordtable WHERE namespace = &lt;span class=&quot;code-quote&quot;&gt;&apos;ns2&apos;&lt;/span&gt; AND entity = &lt;span class=&quot;code-quote&quot;&gt;&apos;entity2&apos;&lt;/span&gt; AND feature1 &amp;gt; 11 AND feature1 &amp;lt; 31  AND token(namespace, entity) &amp;lt;= 9223372036854775807;
ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.NullPointerException&quot;&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12987686">CASSANDRA-12149</key>
            <summary>NullPointerException on SELECT using index with token restrictions fully overriden by other PK restrictions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="avkonst">Andrey Konstantinov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Jul 2016 03:59:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:27 +0000</updated>
                            <resolved>Tue, 25 Oct 2016 15:17:39 +0000</resolved>
                                        <fixVersion>3.10</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15367187" author="avkonst" created="Fri, 8 Jul 2016 04:00:53 +0000"  >&lt;p&gt;Please, let me know if you need more information.&lt;/p&gt;</comment>
                            <comment id="15367199" author="avkonst" created="Fri, 8 Jul 2016 04:08:11 +0000"  >&lt;p&gt;File with CQL queries causing the issue.&lt;/p&gt;</comment>
                            <comment id="15367255" author="doanduyhai" created="Fri, 8 Jul 2016 05:48:38 +0000"  >&lt;p&gt;WHich version of Cassandra are you using ?&lt;/p&gt;</comment>
                            <comment id="15367294" author="avkonst" created="Fri, 8 Jul 2016 06:29:59 +0000"  >&lt;p&gt;It is 3.7.0.&lt;/p&gt;</comment>
                            <comment id="15367302" author="doanduyhai" created="Fri, 8 Jul 2016 06:44:57 +0000"  >&lt;p&gt;I can try to test and reproduce&lt;/p&gt;</comment>
                            <comment id="15367719" author="iamaleksey" created="Fri, 8 Jul 2016 14:16:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; poke ^&lt;/p&gt;</comment>
                            <comment id="15368137" author="xedin" created="Fri, 8 Jul 2016 18:31:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; are you still planing to look at this or do you want me to?&lt;/p&gt;</comment>
                            <comment id="15368141" author="doanduyhai" created="Fri, 8 Jul 2016 18:32:35 +0000"  >&lt;p&gt;I&apos;ll debug this issue this weekend using the given sample dataset&lt;/p&gt;</comment>
                            <comment id="15369264" author="doanduyhai" created="Sat, 9 Jul 2016 19:42:33 +0000"  >&lt;p&gt;The query used = &lt;tt&gt;SELECT namespace, entity, timestamp, feature1, feature2 FROM mykeyspace.myrecordtable WHERE namespace = &apos;ns2&apos; AND entity = &apos;entity2&apos; AND feature1= 11 AND token(namespace, entity) &amp;lt;= 9223372036854775807;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Ok, after successfully re-producing the NPE in debug mode, it is &lt;b&gt;not&lt;/b&gt; a SASI bug but is rather related to how Cassandra optimises the &lt;b&gt;WHERE&lt;/b&gt; clause in general.&lt;/p&gt;

&lt;p&gt; NPE root cause is &lt;tt&gt;slice.bound(b) == null&lt;/tt&gt; in &lt;tt&gt;TokenRestriction.bounds(Bound b, QueryOptions options)&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;ByteBuffer&amp;gt; bounds(Bound b, QueryOptions options) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InvalidRequestException
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.singletonList(slice.bound(b).bindAndGet(options));
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Going up the call stack, the culprit is at &lt;tt&gt;StatementRestrictions.getPartitionKeyBounds(IPartitioner p, QueryOptions options)&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; AbstractBounds&amp;lt;PartitionPosition&amp;gt; getPartitionKeyBounds(IPartitioner p,
                                                                    QueryOptions options)
    {
        ByteBuffer startKeyBytes = getPartitionKeyBound(Bound.START, options);
        ByteBuffer finishKeyBytes = getPartitionKeyBound(Bound.END, options);
        ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; Since we have no lower bound restriction on the &lt;tt&gt;token(namespace, entity)&lt;/tt&gt;, the call to &lt;tt&gt;getPartitionKeyBound(Bound.START, options)&lt;/tt&gt; generates the NPE.&lt;/p&gt;

&lt;p&gt; I try another query without using secondary index &lt;tt&gt;SELECT namespace, entity, timestamp, feature1, feature2 FROM mykeyspace.myrecordtable WHERE namespace = &apos;ns2&apos; AND entity = &apos;entity2&apos; AND token(namespace, entity) &amp;lt;= 9223372036854775807;&lt;/tt&gt; and this time, no NPE.&lt;/p&gt;

&lt;p&gt; The place in the call stack where both queries diverge is at &lt;tt&gt;SelectStatements.getQuery(QueryOptions options, int nowInSec, int userLimit, int perPartitionLimit)&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ReadQuery getQuery(QueryOptions options, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nowInSec, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; userLimit, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; perPartitionLimit) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; RequestValidationException
    {
        DataLimits limit = getDataLimits(userLimit, perPartitionLimit);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (restrictions.isKeyRange() || restrictions.usesSecondaryIndexing())
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getRangeCommand(options, limit, nowInSec);

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getSliceCommands(options, limit, nowInSec);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; When using secondary index, we fall in the &lt;b&gt;if&lt;/b&gt; condition obviously. When NOT using secondary index as per my 2nd SELECT statement, the &lt;b&gt;if&lt;/b&gt; condition is not verified so the code path is &lt;tt&gt;return getSliceCommands(options, limit, nowInSec);&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt; Strangely enough, even with the 2nd SELECT, &lt;tt&gt;restrictions.isKeyRange()&lt;/tt&gt; should be &lt;b&gt;true&lt;/b&gt;, why is it &lt;b&gt;false&lt;/b&gt; ????&lt;/p&gt;

&lt;p&gt; The culprit is at &lt;tt&gt;StatementRestrictions.processPartitionKeyRestrictions(boolean hasQueriableIndex)&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partitionKeyRestrictions.isOnToken())
            isKeyRange = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasUnrestrictedPartitionKeyComponents())
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!partitionKeyRestrictions.isEmpty())
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!hasQueriableIndex)
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; invalidRequest(&lt;span class=&quot;code-quote&quot;&gt;&quot;Partition key parts: %s must be restricted as other parts are&quot;&lt;/span&gt;,
                                             Joiner.on(&lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt;).join(getPartitionKeyUnrestrictedComponents()));
                }

                isKeyRange = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                usesSecondaryIndexing = hasQueriableIndex;
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; Condition &lt;tt&gt;if (partitionKeyRestrictions.isOnToken())&lt;/tt&gt; evaluates to &lt;b&gt;false&lt;/b&gt; so variable &lt;em&gt;isKeyRange&lt;/em&gt; is never set to &lt;b&gt;true&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt; Condition &lt;tt&gt;if (partitionKeyRestrictions.isOnToken())&lt;/tt&gt; evaluates to &lt;b&gt;false&lt;/b&gt; because of &lt;tt&gt;TokenFilter.isOnToken()&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isOnToken()
    {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; all partition key columns have non-token restrictions, we can simply use the token range to filter
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// those restrictions and then ignore the token range
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; restrictions.size() &amp;lt; tokenRestriction.size();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; Here, since there are &lt;b&gt;more&lt;/b&gt; conditions on primary key than on token restriction, the SELECT is not considered to be a token restriction, which is sensible.&lt;/p&gt;

&lt;p&gt; By the way, if we look at the original WHERE clause &lt;tt&gt;WHERE namespace = &apos;ns2&apos; AND entity = &apos;entity2&apos; AND feature1= 11 AND token(namespace, entity) &amp;lt;= 9223372036854775807;&lt;/tt&gt;, the restriction using &lt;b&gt;token&lt;/b&gt; function is &lt;b&gt;useless&lt;/b&gt; because we already provide the complete partition key restriction.&lt;/p&gt;

&lt;p&gt; And I tried the original query by removing &lt;tt&gt;token(namespace, entity) &amp;lt;= 9223372036854775807&lt;/tt&gt; and it works like a charm.&lt;/p&gt;

&lt;p&gt; I would consider this JIRA to be &lt;b&gt;not an issue&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avkonst&quot; class=&quot;user-hover&quot; rel=&quot;avkonst&quot;&gt;avkonst&lt;/a&gt;&lt;/p&gt;


</comment>
                            <comment id="15369283" author="avkonst" created="Sat, 9 Jul 2016 20:44:49 +0000"  >&lt;p&gt;Yes, there is no NPE without token condition, but NPE is an issue, it aborts all connections with a client.&lt;/p&gt;

&lt;p&gt;You said that token condition is useless when there is partition key constraint. Thank you for this, and could you, please, clarify few things for me?: I use cassandra-spark-connector to generate token ranges for me to partition my custom RDD in spark (even if I know it hits a single partition in Cassandra, and CassandraPartitionGenerator from the connector knows this too). I could use clustering column to partition SELECT results within a single Cassandra partition, but in this case I would need to know values of a clustering column (and I do not know this in time of a query). How could I partition SELECT results hitting a single large Cassandra partition, when I do not know values of clustering columns? Thanks!&lt;/p&gt;</comment>
                            <comment id="15371429" author="doanduyhai" created="Mon, 11 Jul 2016 19:08:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;How could I partition SELECT results hitting a single large Cassandra partition, when I do not know values of clustering columns?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt; Use server-side paging:&lt;/p&gt;

&lt;p&gt; &quot;SELECT * FROM mytable WHERE partition = &apos;xxx&apos;&quot;&lt;/p&gt;

&lt;p&gt; Then set a fetchSize on the statement using the driver and then retrieve an Iterator from the ResultSet and start iterating with &lt;tt&gt;while(iterator.hasNext())&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15371786" author="avkonst" created="Mon, 11 Jul 2016 22:25:48 +0000"  >&lt;p&gt;Thanks! Yes, this is to fetch rows sequentially by one machine. My goal was to fetch half of a partition by one machine and another half by the second machine. It seems it is impossible to do this without knowing split clustering key value.&lt;/p&gt;</comment>
                            <comment id="15507009" author="ifesdjeen" created="Tue, 20 Sep 2016 16:19:55 +0000"  >&lt;p&gt;We should probably at least add a sensible error message, even if it&apos;s not a bug in itself (i.e. the behaviour is expected).&lt;/p&gt;</comment>
                            <comment id="15545436" author="ifesdjeen" created="Tue, 4 Oct 2016 14:06:52 +0000"  >&lt;p&gt;This problem was not related strictly to SASI, so I have adjusted the title accordingly. Example code that&apos;d fail:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testTokenAndIndex() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, d &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (a, b, c))&quot;&lt;/span&gt;);
        createIndex(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE INDEX ON %s(c)&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i++)
        {
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a,b,c,d) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;, i, i, i, i);
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a,b,c,d) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;, i, i + 10, i + 10, i + 10);
        }

        beforeAndAfterFlush(() -&amp;gt; {
            assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE token(a) &amp;gt; token(8) AND a = 9 AND c = 9 ALLOW FILTERING&quot;&lt;/span&gt;),
                       row(9, 9, 9, 9));

            assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE token(a) &amp;gt; token(8) AND a &amp;gt; 8 ALLOW FILTERING&quot;&lt;/span&gt;),
                       row(9, 9, 9, 9),
                       row(9, 19, 19, 19));
        });
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We could use non-token restrictions when token restrictions are fully overriden by other results.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12149-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12149-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12149-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12149-3.X&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-3.X-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-3.X-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;tt&gt;3.0&lt;/tt&gt; is not applicable as we do not allow slices on non-token PK restrictions there.&lt;/p&gt;</comment>
                            <comment id="15592089" author="blerer" created="Thu, 20 Oct 2016 15:13:51 +0000"  >&lt;p&gt;Thanks for the patch.&lt;br/&gt;
I wonder if the &lt;tt&gt;TokenFilter::hasBound&lt;/tt&gt; and &lt;tt&gt;TokenFilter::isInclusive&lt;/tt&gt; methods should not be updated in a similar way. They are not called if &lt;tt&gt;isOnToken&lt;/tt&gt; is &lt;tt&gt;false&lt;/tt&gt; but I believe that it will make the code more bullet proof.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;TokenFilter::bound&lt;/tt&gt; method can be simplified to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isOnToken() ? tokenRestriction.bounds(bound, options) : restrictions.bounds(bound, options);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15595502" author="ifesdjeen" created="Fri, 21 Oct 2016 15:59:40 +0000"  >&lt;p&gt;Thanks for the review. &lt;/p&gt;

&lt;p&gt;Sure, I can&apos;t see how adding this check may hurt. I&apos;ve also updated comment on the class to make it clearer that we &quot;fall back&quot; to non-token restrictions when possible and re-triggered CI.&lt;/p&gt;</comment>
                            <comment id="15603000" author="blerer" created="Mon, 24 Oct 2016 19:46:47 +0000"  >&lt;p&gt;While thinking about it, I realized that the &lt;tt&gt;TokenFilter::isOnToken&lt;/tt&gt; method might not return the correct result.&lt;br/&gt;
If we have a query like &lt;tt&gt;SELECT * FROM %s WHERE token(a, b) &amp;gt; token(10, 10) AND a &amp;lt; 8 AND b &amp;lt; 8 ALLOW FILTERING&lt;/tt&gt;, as &lt;tt&gt;a&lt;/tt&gt; and &lt;tt&gt;b&lt;/tt&gt; have a non token restriction the &lt;tt&gt;TokenFilter::isOnToken&lt;/tt&gt; method will return &lt;tt&gt;false&lt;/tt&gt;. Due to that, Cassandra will believe that the query is not a range query and as the call to &lt;tt&gt;TokenFilter::needFiltering&lt;/tt&gt; will return &lt;tt&gt;true&lt;/tt&gt; in &lt;tt&gt;StatementRestrictions:getPartitionKeyBound&lt;/tt&gt; the token restriction will be completely ignored.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced with the following test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testFilteringOnAllPartitionKeysWithTokenRestriction() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, d &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY ((a, b), c))&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i++)
        {
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a,b,c,d) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;, i, i, i, i);
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a,b,c,d) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;, i, i + 10, i + 10, i + 10);
        }

        assertEmpty(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE token(a, b) &amp;gt; token(10, 10)&quot;&lt;/span&gt;));
        assertEmpty(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE token(a, b) &amp;gt; token(10, 10) AND a &amp;lt; 8 AND b &amp;lt; 8 ALLOW FILTERING&quot;&lt;/span&gt;));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sorry for not noticing the problem sooner.&lt;/p&gt;</comment>
                            <comment id="15605164" author="ifesdjeen" created="Tue, 25 Oct 2016 12:17:39 +0000"  >&lt;p&gt;Great find! I&apos;ve added one more test, which would actually yield the results between token and non-token restriction. I&apos;ve fixed it by not falling back to non-token restrictions when filtering, since because of token restriction we already know the ring part that should be queried.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12149-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12149-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12149-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12149-3.X&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-3.X-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12149-3.X-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15605572" author="blerer" created="Tue, 25 Oct 2016 15:12:34 +0000"  >&lt;p&gt;Thanks for the new patch.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15605584" author="blerer" created="Tue, 25 Oct 2016 15:17:40 +0000"  >&lt;p&gt;Committed into 3.X at b98a40605a4eeaf9347401b8f9ed9f0fe297c745 and merged into trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12816762" name="CASSANDRA-12149.txt" size="2007" author="avkonst" created="Fri, 8 Jul 2016 04:08:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30oqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335693">3.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>