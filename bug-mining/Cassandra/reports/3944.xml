<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10422] Avoid anticompaction when doing subrange repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10422</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If we do split the owned range in say 1000 parts, and then do one repair each, we could potentially anticompact every sstable 1000 times (ie, we anticompact the repaired range out 1000 times). We should avoid anticompacting at all in these cases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12901576">CASSANDRA-10422</key>
            <summary>Avoid anticompaction when doing subrange repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>repair</label>
                    </labels>
                <created>Wed, 30 Sep 2015 12:35:51 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:54 +0000</updated>
                            <resolved>Tue, 17 Nov 2015 09:23:01 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14980688" author="aweisberg" created="Thu, 29 Oct 2015 16:06:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; Is this as simple as having a repair that has a start/end token(s) specified ignoring (or rejecting) the incremental repair flag? Say &lt;a href=&quot;https://github.com/apache/cassandra/blob/ef1b4c0f5a8e0677efd3ec25fa735782ce1b1480/src/java/org/apache/cassandra/repair/messages/RepairOption.java#L143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here in RepairOption.parse&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14980807" author="aweisberg" created="Thu, 29 Oct 2015 17:02:36 +0000"  >&lt;p&gt;Looks like the 2.2 code merges to 3.0 and trunk without issue. Tests running now.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/apache:cassandra-2.1...aweisberg:CASSANDRA-10422-2.1?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10422-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10422-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/apache:cassandra-2.2...aweisberg:CASSANDRA-10422-2.2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10422-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10422-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14981146" author="krummas" created="Thu, 29 Oct 2015 19:54:25 +0000"  >&lt;p&gt;Just had a very quick look, in 2.2+ we do incremental repair by default (and we also anticompact after full repairs) so we need to tell the other nodes whether this is a &apos;global&apos; repair or not: &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.2/src/java/org/apache/cassandra/repair/messages/PrepareMessage.java#L45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.2/src/java/org/apache/cassandra/repair/messages/PrepareMessage.java#L45&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14981297" author="aweisberg" created="Thu, 29 Oct 2015 21:17:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; do we do incremental repair + subrange repair outside of that path via nodetool?&lt;/p&gt;

&lt;p&gt;I am not following why additional work is necessary if there is no path to start this problematic repair combination? The isIncremental flag is propagated to the other nodes, and that is what drives anti-compaction on other nodes right? So if we don&apos;t allow a repair to start with the combination of incremental and subrange there shouldn&apos;t be an issue.&lt;/p&gt;

&lt;p&gt;When you say full repair what do you mean? Not a repair of a subrange? I thought that is the situation where we want to anti-compact.&lt;/p&gt;



</comment>
                            <comment id="14998893" author="krummas" created="Tue, 10 Nov 2015 16:55:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; (sorry for not replying quicker) - isIncremental is for telling the other nodes which sstables to use when doing the repair (for merkle tree calculation and streaming, if isIncremental is true, we will only use the sstables that are not marked as repaired) - isGlobal is used to tell the other nodes if we can actually do the anticompaction - if all nodes that have the range are included in the repair.&lt;/p&gt;

&lt;p&gt;In 2.2+, even if you add -full we are going to do anticompaction&lt;/p&gt;</comment>
                            <comment id="14998949" author="aweisberg" created="Tue, 10 Nov 2015 17:22:39 +0000"  >&lt;p&gt;OK so I do I even want to bother with preventing them from requesting subrange repair with incremental repair since it is orthogonal to anti-compaction in 2.2? For 2.1 it&apos;s sufficient to prevent them from requesting the problem combination?&lt;/p&gt;
</comment>
                            <comment id="14998954" author="krummas" created="Tue, 10 Nov 2015 17:26:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;do I even want to bother with preventing them from requesting subrange repair with incremental repair &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, I think we can just skip anticompaction in this case. Maybe output a warning?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For 2.1 it&apos;s sufficient to prevent them from requesting the problem combination?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes&lt;/p&gt;</comment>
                            <comment id="15007325" author="aweisberg" created="Mon, 16 Nov 2015 21:11:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; this is ready for review again.&lt;/p&gt;</comment>
                            <comment id="15008347" author="krummas" created="Tue, 17 Nov 2015 09:23:01 +0000"  >&lt;p&gt;+1, committed&lt;/p&gt;

&lt;p&gt;also added a few dtests: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/664&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/664&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mgbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>