<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:13:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15027] Handle IR prepare phase failures less race prone by waiting for all results</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15027</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Handling incremental repairs as a coordinator begins by sending a &lt;tt&gt;PrepareConsistentRequest&lt;/tt&gt; message to all participants, which may also include the coordinator itself. Participants will run anti-compactions upon receiving such a message and report the result of the operation back to the coordinator.&lt;/p&gt;

&lt;p&gt;Once we receive a failure response from any of the participants, we fail-fast in &lt;tt&gt;CoordinatorSession.handlePrepareResponse()&lt;/tt&gt;, which will in turn completes&#160;the &lt;tt&gt;prepareFuture&lt;/tt&gt; that &lt;tt&gt;RepairRunnable&lt;/tt&gt; is blocking on. Then the repair command will terminate with an error status, as expected.&lt;/p&gt;

&lt;p&gt;The issue is that in case the node will both be coordinator and participant, we may end up with a local session and submitted anti-compactions, which will be executed without any coordination with the coordinator session (on same node). This may result in situations where running repair commands right after another, may cause overlapping execution of anti-compactions that will cause the following (misleading) message to show up in the logs and will cause the repair to fail again:&lt;br/&gt;
 &quot;Prepare phase for incremental repair session %s has failed because it encountered intersecting sstables belonging to another incremental repair session (%s). This is by starting an incremental repair session before a previous one has completed. Check nodetool repair_admin for hung sessions and fix them.&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13216314">CASSANDRA-15027</key>
            <summary>Handle IR prepare phase failures less race prone by waiting for all results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="spod">Stefan Podkowinski</assignee>
                                    <reporter username="spod">Stefan Podkowinski</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Feb 2019 07:49:55 +0000</created>
                <updated>Fri, 15 May 2020 08:01:43 +0000</updated>
                            <resolved>Fri, 22 Feb 2019 18:57:27 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16770869" author="spodxx@gmail.com" created="Mon, 18 Feb 2019 08:42:30 +0000"  >&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-15027]&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&#160;[trunk&lt;/a&gt;[ &lt;a href=&quot;https://circleci.com/workflow-run/2b027f87-cf45-48ee-8eae-45a563701bc6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt; ]&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16774515" author="bdeggleston" created="Thu, 21 Feb 2019 21:32:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt;. I&#8217;ve extended your code so that in addition to waiting for other anti-compactions to complete, the coordinator also pro-actively cancels ongoing anti-compactions on the other participants. This avoids wasting time waiting for anti-compactions on other machines. The code does 3 things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Adds a session state check to the&#160;&lt;tt&gt;isStopRequested&lt;/tt&gt; method in the anti-compaction iterator.&lt;/li&gt;
	&lt;li&gt;The coordinator now sends failure messages to all participants when it receives a failure message from one of them in the prepare phase. It does not mark these participants as having failed internally though, since that would cause the nodetool session to immediately complete. Instead, it waits until it&#8217;s received messages from all the other nodes.&lt;/li&gt;
	&lt;li&gt;The participants will now respond with a failed prepare message if the anti-compaction completes, but the session was failed in the mean time. This prevents a dead lock on the coordinator in the case where the participant received a failure message between the time the anti-compaction completes and the callback fires.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Let me know what you think. If everything looks ok to you, I&#8217;m +1 on committing.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15027-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;br/&gt;
 &lt;a href=&quot;https://circleci.com/gh/bdeggleston/workflows/cassandra/tree/15027-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16775178" author="spodxx@gmail.com" created="Fri, 22 Feb 2019 14:15:49 +0000"  >&lt;p&gt;Your updates look like valuable improvement over the initial&#160;patch. I&apos;m +1 in general&#160;as for the changes, but also&#160;fixed some additional minor issues and added a new tests:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/commits/CASSANDRA-15027&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-15027&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://circleci.com/workflow-run/2b444c33-a54c-46b5-9923-bcded8bcf465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/2b444c33-a54c-46b5-9923-bcded8bcf465&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please see comments with each commit in branch above for details.&lt;/p&gt;

&lt;p&gt;Also happy to discuss any of the changes (most likely the last commit) in another jira, if you feel it&apos;s out of scope for this ticket.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="16775361" author="bdeggleston" created="Fri, 22 Feb 2019 16:43:47 +0000"  >&lt;p&gt;Nice. Your follow on changes look good to me, I have 2 nits, but those can just be fixed on commit.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;We should log the session id in compaction manager when an anti-compaction is cancelled (and probably when there&apos;s an error as well)&lt;/li&gt;
	&lt;li&gt;Some error handling should be added to the commit fixing the race between proposeFuture and hasFailure so nodetool doesn&apos;t hang if there&apos;s an error in the callback&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;edit: proposed fixes &lt;a href=&quot;https://github.com/bdeggleston/cassandra/commit/02d7d9e09983db0d4661486b17adc375e17be24f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16775437" author="spodxx@gmail.com" created="Fri, 22 Feb 2019 17:41:59 +0000"  >&lt;p&gt;LGTM +1&lt;/p&gt;</comment>
                            <comment id="16775505" author="bdeggleston" created="Fri, 22 Feb 2019 18:57:27 +0000"  >&lt;p&gt;Committed to trunk as&#160;9bde713ee8883f70d130efb6290ec0e6daea524f, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[spod]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi12wo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>bdeggleston</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>