<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:18:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16307] GROUP BY queries with paging can return deleted data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16307</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;tt&gt;GROUP BY&lt;/tt&gt; queries using paging and CL&amp;gt;ONE/LOCAL_ONE. This dtest reproduces the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Cluster cluster = init(Cluster.create(2)))
{
    cluster.schemaChange(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s.t (pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ck &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (pk, ck))&quot;&lt;/span&gt;));
    ICoordinator coordinator = cluster.coordinator(1);
    coordinator.execute(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s.t (pk, ck) VALUES (0, 0)&quot;&lt;/span&gt;), ConsistencyLevel.ALL);
    coordinator.execute(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s.t (pk, ck) VALUES (1, 1)&quot;&lt;/span&gt;), ConsistencyLevel.ALL);
    
    cluster.get(1).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM %s.t WHERE pk=0 AND ck=0&quot;&lt;/span&gt;));
    cluster.get(2).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM %s.t WHERE pk=1 AND ck=1&quot;&lt;/span&gt;));
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query = withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s.t GROUP BY pk&quot;&lt;/span&gt;);
    Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; rows = coordinator.executeWithPaging(query, ConsistencyLevel.ALL, 1);
    assertRows(Iterators.toArray(rows, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[].class));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Using a 2-node cluster and RF=2, the test inserts two partitions in both nodes. Then it locally deletes each row in a separate node, so each node sees a different partition alive, but reconciliation should produce no alive partitions. However, a &lt;tt&gt;GROUP BY&lt;/tt&gt; query using a page size of 1 wrongly returns one of the rows.&lt;/p&gt;

&lt;p&gt;This has been detected during &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16180&quot; title=&quot;4.0 Quality: Coordination Test Audit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16180&quot;&gt;&lt;del&gt;CASSANDRA-16180&lt;/del&gt;&lt;/a&gt;, and it is probably related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15459&quot; title=&quot;Short read protection doesn&amp;#39;t work on group-by queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15459&quot;&gt;&lt;del&gt;CASSANDRA-15459&lt;/del&gt;&lt;/a&gt;, which solved a similar problem for group-by queries with limit, instead of paging.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13343356">CASSANDRA-16307</key>
            <summary>GROUP BY queries with paging can return deleted data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="adelapena">Andres de la Pe&#241;a</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Nov 2020 16:57:25 +0000</created>
                <updated>Thu, 25 Feb 2021 10:10:31 +0000</updated>
                            <resolved>Mon, 15 Feb 2021 11:56:33 +0000</resolved>
                                        <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Coordination</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17241147" author="dcapwell" created="Mon, 30 Nov 2020 23:58:52 +0000"  >&lt;p&gt;Any idea if this impacts 3.x as well?&lt;/p&gt;</comment>
                            <comment id="17241159" author="adelapena" created="Tue, 1 Dec 2020 00:39:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; Yes, it affects 3.11 and trunk, but not 3.0 because it doesn&apos;t have group-by queries.&lt;/p&gt;</comment>
                            <comment id="17262465" author="blerer" created="Mon, 11 Jan 2021 08:06:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; I let my backlog grow to big. I will unassign myself from this ticket. I anybody has some available cycles he can feel free to pick it up.&lt;/p&gt;</comment>
                            <comment id="17277259" author="ifesdjeen" created="Tue, 2 Feb 2021 16:25:44 +0000"  >&lt;p&gt;Good news: this is just an artifact of faulty pager in in-jvm dtests.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/884&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ifesdjeen/cassandra?branch=16307-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17277434" author="michaelsembwever" created="Tue, 2 Feb 2021 20:10:33 +0000"  >&lt;p&gt;ci-cassandra runs for &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-jvm-dtest/207/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jvm-dtest&lt;/a&gt; and &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-jvm-dtest-upgrade/205/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jvm-dtest-upgrade&lt;/a&gt;. (No idea if the latter was needed.)&lt;/p&gt;</comment>
                            <comment id="17277441" author="adelapena" created="Tue, 2 Feb 2021 20:42:42 +0000"  >&lt;p&gt;That&apos;s a nice finding! However I think that it only solves some of the problems with paging and &lt;tt&gt;GROUP BY&lt;/tt&gt;. The test above was an attempt to simplify &lt;a href=&quot;https://github.com/apache/cassandra/blob/16075ed5c7429b3dd30d1e894b20e3598b8b9a10/test/distributed/org/apache/cassandra/distributed/test/ShortReadProtectionTest.java#L301-L347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the original tests&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16180&quot; title=&quot;4.0 Quality: Coordination Test Audit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16180&quot;&gt;&lt;del&gt;CASSANDRA-16180&lt;/del&gt;&lt;/a&gt; where we found the problem. I&apos;m afraid that a test more faithful to the original still fails:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Cluster cluster = init(Cluster.create(2)))
{
    cluster.schemaChange(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s.t (pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ck &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (pk, ck))&quot;&lt;/span&gt;));

    cluster.get(1).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s.t (pk, ck) VALUES (1, 1) USING TIMESTAMP 0&quot;&lt;/span&gt;));
    cluster.get(1).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM %s.t WHERE pk=0 AND ck=0&quot;&lt;/span&gt;));
    cluster.get(1).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s.t (pk, ck) VALUES (2, 2) USING TIMESTAMP 0&quot;&lt;/span&gt;));

    cluster.get(2).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM %s.t WHERE pk=1 AND ck=1&quot;&lt;/span&gt;));
    cluster.get(2).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s.t (pk, ck) VALUES (0, 0) USING TIMESTAMP 0&quot;&lt;/span&gt;));
    cluster.get(2).executeInternal(withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM %s.t WHERE pk=2 AND ck=2&quot;&lt;/span&gt;));

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query = withKeyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s.t GROUP BY pk&quot;&lt;/span&gt;);
    Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; rows = cluster.coordinator(1).executeWithPaging(query, ConsistencyLevel.ALL, 1);
    assertRows(Iterators.toArray(rows, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[].class));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Apparently this can also be reproduced with a Python dtest, suggesting that the problem is not only caused by in-jvm dtests:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
cluster = &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.cluster
cluster.populate(2).start()
node1, node2 = cluster.nodelist()

session = &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.patient_exclusive_cql_connection(node1, consistency_level=ConsistencyLevel.ONE)
create_ks(session, &lt;span class=&quot;code-quote&quot;&gt;&apos;ks&apos;&lt;/span&gt;, 2)
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;CREATE TABLE ks.t (pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ck &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (pk, ck))&apos;&lt;/span&gt;)

node2.stop()
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;INSERT INTO ks.t (pk, ck) VALUES (1, 1) USING TIMESTAMP 0&apos;&lt;/span&gt;)
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;DELETE FROM ks.t WHERE pk=0 AND ck=0&apos;&lt;/span&gt;)
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;INSERT INTO ks.t (pk, ck) VALUES (2, 2) USING TIMESTAMP 0&apos;&lt;/span&gt;)
node2.start()

node1.stop()
session = &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.patient_exclusive_cql_connection(node2, consistency_level=ConsistencyLevel.ONE)
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;DELETE FROM ks.t WHERE pk=1 AND ck=1&apos;&lt;/span&gt;)
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;INSERT INTO ks.t (pk, ck) VALUES (0, 0) USING TIMESTAMP 0&apos;&lt;/span&gt;)
session.execute(&lt;span class=&quot;code-quote&quot;&gt;&apos;DELETE FROM ks.t WHERE pk=2 AND ck=2&apos;&lt;/span&gt;)
node1.start()

session = &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.patient_exclusive_cql_connection(node1, consistency_level=ConsistencyLevel.ALL)
session.default_fetch_size = 1
assert_none(session, &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM ks.t GROUP BY pk&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17277486" author="ifesdjeen" created="Tue, 2 Feb 2021 21:54:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; thanks for elaborating. This looks like a separate problem. I&apos;ll open a separate jira for one of the bugs. I&apos;m sure that testing/fixing the new problem will be much easier now when paging is working. &lt;/p&gt;</comment>
                            <comment id="17278336" author="maedhroz" created="Wed, 3 Feb 2021 20:05:45 +0000"  >&lt;p&gt;Just started to take a look at the trunk patch, but before I get too far, I see a failure for &lt;a href=&quot;https://app.circleci.com/pipelines/github/ifesdjeen/cassandra/148/workflows/c586d0ab-7fa0-4c13-a6d1-c927bb55342a/jobs/3153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CompactStorageUpgradeTest#compactStoragePagingTest &lt;/a&gt; that looks new (and might be related, given it touches paging).&lt;/p&gt;</comment>
                            <comment id="17279021" author="adelapena" created="Thu, 4 Feb 2021 18:13:59 +0000"  >&lt;p&gt;I&apos;ve just confirmed that &lt;tt&gt;CompactStorageUpgradeTest#compactStoragePagingTest&lt;/tt&gt; consistently fails with the patch, and it works by reverting it.&lt;/p&gt;</comment>
                            <comment id="17279067" author="ifesdjeen" created="Thu, 4 Feb 2021 18:48:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; I&apos;ve fixed the test right away, just didn&apos;t expect the patch is going to get attention right away, and was focusing on fixing the real group by/paging/srp bug. The test failure in compact storage upgrade test is just a conseqeunce of the test not complying to &lt;tt&gt;Iterator&lt;/tt&gt; interface and not calling &lt;tt&gt;hasNext&lt;/tt&gt; before calling &lt;tt&gt;next&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;That said, I&apos;m pretty close to the fix of the actual issue, just running some more Harry tests to verify the fix. It is caused by the fact that for group by, we&apos;re increasing data limit counters only after the next row was seen, which is why SRP thinks there&apos;s no need to try to fetch more contents.&lt;/p&gt;

&lt;p&gt;UPD: I&apos;ll move the in-jvm dtest paging problem to a &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16427&quot; title=&quot;In-JVM dtest paging does not handle Group By correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16427&quot;&gt;&lt;del&gt;CASSANDRA-16427&lt;/del&gt;&lt;/a&gt;, and will put &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; as reviewers there. Thank you!&lt;/p&gt;</comment>
                            <comment id="17280846" author="ifesdjeen" created="Mon, 8 Feb 2021 08:34:16 +0000"  >&lt;p&gt;The problem here turned out to be that the Group By pager incorrectly interacts with SRP.&#160;&lt;/p&gt;

&lt;p&gt;In short, we have multiple implementations of paging counters: one is regular CQL one and, the other is Group By. CQL one is counting rows as it sees them. Group By is counting rows its going to return (in other words, groups) only when it encounters the next group (or partition/data end).&lt;/p&gt;

&lt;p&gt;The problem is that when issuing SRP, we rely on correctness of these counters. And if counter says that iterator couldn&#8217;t give enough data to exhaust limits, we&#8217;re not going to ask for more data. In case of regular counters it all works as expected, but with group by counters, we&#8217;ll say that we have seen 1 row less every time, and won&#8217;t issue SRP. In other words, if one of the nodes holds a row followed by the tombstone, current behaviour will prevent SRP from getting triggered and tombstone from being visible, since group will be unfinished, and it doesn&#8217;t make sense to ask the node for more data since it couldn&#8217;t even satisfy the current data limit.&lt;/p&gt;

&lt;p&gt;A straightforward solution to this would have been to just start counting groups as we&#8217;re encountering them. However, here the problem is that if we say that we have a group as soon as we see the first row that belongs to it, internal pager will think that there&#8217;s no need to continue, since data limits are satisfied.&lt;/p&gt;

&lt;p&gt;The patch is introducing a distinction between &lt;tt&gt;needsMoreContents&lt;/tt&gt; (better name pending) and &lt;tt&gt;isDone&lt;/tt&gt;. This allows us to know we need to fetch more rows in case we haven&#8217;t seen either end of data, or next row. I think we can even start counting groups right away instead of delaying counting till we see the next group to (potentially) simplify the logic, however I wanted to leave a larger refactoring to a separate patch.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:16307-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ifesdjeen/cassandra?branch=16307-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...ifesdjeen:16307-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ifesdjeen/cassandra?branch=16307-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17281001" author="beobal" created="Mon, 8 Feb 2021 12:35:08 +0000"  >&lt;p&gt;Looks good to me, assuming that you&apos;re planning to include the logic inversion patch on the 3.11 branch too. One minor nit is the naming of the new methods. They feel slightly off because counters/limits don&apos;t have content, so maybe a better options could be:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;maybeUnderCounted / maybeUnderCountedForPartition&lt;/tt&gt; or &lt;tt&gt;maybeShort / maybeShortForPartition&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="17283026" author="ifesdjeen" created="Thu, 11 Feb 2021 13:18:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;&#160;I&apos;ve tried out a slightly different approach, suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, which is to use &lt;tt&gt;command.isExhausted&lt;/tt&gt;. Since it has a logic that checks whether or not the counter is exhausted (in other words, we&apos;ve reached &lt;em&gt;either&lt;/em&gt; row limit, or group limit), it works for this case. Works for rows, since we count them as we see, and works for groups since we&apos;ll only count the group as soon as iterator is closed or we encounter the next group. One of the advantages of using this approach is that we will avoid an extra page request for cases when group limit coincides with row limit. Would you be able to take another look?&lt;/p&gt;</comment>
                            <comment id="17283550" author="blerer" created="Fri, 12 Feb 2021 08:24:48 +0000"  >&lt;p&gt;The patches look good to me.  &lt;/p&gt;</comment>
                            <comment id="17283753" author="beobal" created="Fri, 12 Feb 2021 15:07:12 +0000"  >&lt;p&gt;+1 LGTM too.&lt;/p&gt;</comment>
                            <comment id="17284679" author="ifesdjeen" created="Mon, 15 Feb 2021 11:56:33 +0000"  >&lt;p&gt;Thank you for the review! &lt;/p&gt;

&lt;p&gt;Committed to 3.11 with &lt;a href=&quot;https://github.com/apache/cassandra/commit/f258ae67516d53752c8d1f0a2576d72471ed427f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;f258ae67516d53752c8d1f0a2576d72471ed427f&lt;/a&gt; and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/7cddbd40ce6b326df533fd6d3c4131ef70b3b068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="13357022">CASSANDRA-16427</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13333699">CASSANDRA-16180</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13275270">CASSANDRA-15459</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12989" cascade-level="1"><![CDATA[Consistency]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0l22w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/7cddbd40ce6b326df533fd6d3c4131ef70b3b068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/7cddbd40ce6b326df533fd6d3c4131ef70b3b068&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Tests included. Harry tests are under way.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>