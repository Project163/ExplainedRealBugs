<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2769] Cannot Create Duplicate Compaction Marker</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2769</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Concurrent compaction can trigger the following exception when two threads compact the same sstable. DataTracker attempts to prevent this but apparently not successfully.&lt;/p&gt;

&lt;p&gt;java.io.IOError: java.io.IOException: Unable to create compaction marker&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableReader.markCompacted(SSTableReader.java:638)&lt;br/&gt;
	at org.apache.cassandra.db.DataTracker.removeOldSSTablesSize(DataTracker.java:321)&lt;br/&gt;
	at org.apache.cassandra.db.DataTracker.replace(DataTracker.java:294)&lt;br/&gt;
	at org.apache.cassandra.db.DataTracker.replaceCompactedSSTables(DataTracker.java:255)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.replaceCompactedSSTables(ColumnFamilyStore.java:932)&lt;br/&gt;
	at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:173)&lt;br/&gt;
	at org.apache.cassandra.db.compaction.CompactionManager$1.call(CompactionManager.java:119)&lt;br/&gt;
	at org.apache.cassandra.db.compaction.CompactionManager$1.call(CompactionManager.java:102)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: java.io.IOException: Unable to create compaction marker&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableReader.markCompacted(SSTableReader.java:634)&lt;br/&gt;
	... 12 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12510353">CASSANDRA-2769</key>
            <summary>Cannot Create Duplicate Compaction Marker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="bcoverston">Benjamin Coverston</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jun 2011 20:15:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:57 +0000</updated>
                            <resolved>Fri, 17 Jun 2011 15:01:22 +0000</resolved>
                                        <fixVersion>0.8.2</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13049613" author="stuhood" created="Wed, 15 Jun 2011 05:35:12 +0000"  >&lt;p&gt;Is this in trunk, or in 0.8.0?&lt;/p&gt;</comment>
                            <comment id="13049614" author="bcoverston" created="Wed, 15 Jun 2011 05:36:43 +0000"  >&lt;p&gt;Yes, in both.&lt;/p&gt;</comment>
                            <comment id="13049731" author="slebresne" created="Wed, 15 Jun 2011 11:43:29 +0000"  >&lt;p&gt;Alright, there is a bunch of problems, one of which affects 0.8 and trunk and could cause this stackTrace. The others are due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1610&quot; title=&quot;Pluggable Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1610&quot;&gt;&lt;del&gt;CASSANDRA-1610&lt;/del&gt;&lt;/a&gt; and thus only affect trunk (but one of those can also result in the attached stackTrace).&lt;/p&gt;

&lt;p&gt;The problem affecting 0.8 and trunk is related to a left over line in doCleanup() that is wrongly unmarking a sstable from the compacting set before having removed it from the active set of sstables. Thus another compaction could start compacting this sstable and we&apos;ll end up marking the file as compacted twice (and we would have duplicated the sstable, which is a problem for counters).&lt;br/&gt;
Patch 0001-0.8.0-Remove-useless-unmarkCompacting-in-doCleanup.patch removes it and is against 0.8.&lt;/p&gt;

&lt;p&gt;Trunk has a few problems of its own:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If disk space is not sufficient to compact all sstables, it computes the smallestSSTables set that fits, but doesn&apos;t use it. Attached first patch (0001-Do-compact-only-smallerSSTables.patch) fixes that.&lt;/li&gt;
	&lt;li&gt;The CompactionTask logic wrongly decorrelates the set of sstables that are successfully marked from the ones it did compact. That is, it grabs a list of sstables it wants to compact, then call markCompacting on them, but does not check if all of them are successfully marked and compact the original list instead.&lt;br/&gt;
  In effect, a task will recompact sstables that are already being compacted by other task and the given file will be compacted twice (or more) and marked compacted multiple times.&lt;br/&gt;
  Attached patch (0002-Only-compact-what-has-been-succesfully-marked-as-com.patch) fixes this by changing the sstables set of a given CompactionTask to whatever has been successfully marked only. Since the marking involves updating the task, I&apos;ve move the logic to AbstractCompactionTask where it seems to make more sense to me.&lt;/li&gt;
	&lt;li&gt;For some reason, the markCompacting added for CompactionTasks was refusing to mark (and compact) anything if the set of sstable was bigger that MaxCompactionThreshold. This means that as soon as the number of sstables (of same size) in the column family would exceed the threshold, no compaction would be started. This is not the expected behavior. The second patch also fixes this by reusing the original markCompacting that handles this correctly.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13049919" author="jbellis" created="Wed, 15 Jun 2011 17:49:29 +0000"  >&lt;p&gt;the 0.8 patch looks good.  (i did notice that some of the other post-markCompactiong code checks for null or empty, others just check for null &amp;#8211; one of these is probably wrong.)&lt;/p&gt;</comment>
                            <comment id="13049923" author="slebresne" created="Wed, 15 Jun 2011 17:55:52 +0000"  >&lt;p&gt;Alright, I&apos;ve committed the 0.8 patch. I&apos;ll have a look at the checks.&lt;/p&gt;</comment>
                            <comment id="13050081" author="alanliang" created="Wed, 15 Jun 2011 22:22:46 +0000"  >&lt;p&gt;Instead of letting DataTracker#markCompacting modify the subset of sstables to be compacted, I think it might be cleaner if it didn&apos;t and relied on the CompactionStrategy to select the correct sstables. We can do this by having the CompactionStrategy get the non compacting sstables from the DataTracker and work with those to generate the buckets. The strategy should also be responsible for creating buckets that fit within the min/max thresholds. #markCompacting would then be changed such that it can either accept/reject a bucket to be compacted instead of modifying the subset. #markCompacting will also serve to handle the race condition of the DataTracker being inaccurate, whereby, it will move on to other buckets.&lt;/p&gt;

&lt;p&gt;With this, we can avoid generating buckets that are already compacting and it gives full control of what actually is compacted by the CompactionStrategy.&lt;/p&gt;

&lt;p&gt;What do you guys think?&lt;/p&gt;</comment>
                            <comment id="13050579" author="jbellis" created="Thu, 16 Jun 2011 17:31:41 +0000"  >&lt;p&gt;For trunk patches, I&apos;m not comfortable w/ 0001 reassigning the sstables field on general principles either.  We could have the compaction proceed using smallerSSTables as a simpler alternative, but in general this organization feels like negative progress from the 0.8 doCompaction/doCompactionWithoutSizeEstimation.&lt;/p&gt;

&lt;p&gt;trunk 0002 looks fine.&lt;/p&gt;</comment>
                            <comment id="13050864" author="hudson" created="Fri, 17 Jun 2011 02:20:45 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #173 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/173/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/173/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="13050890" author="bcoverston" created="Fri, 17 Jun 2011 03:59:49 +0000"  >&lt;p&gt;I think Alan has a good point. I don&apos;t think it&apos;s an appropriate role of the data tracker to modify the set of sstables to be compacted in a task. It&apos;s been a bit of a struggle to hack around the behavior of the DataTracker to ensure my compactions happen in the order I want with the SSTables that I want. That should probably be the exclusive domain compaction strategy.&lt;/p&gt;</comment>
                            <comment id="13050958" author="slebresne" created="Fri, 17 Jun 2011 10:18:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;For trunk patches, I&apos;m not comfortable w/ 0001 reassigning the sstables field on general principles either. We could have the compaction proceed using smallerSSTables as a simpler alternative, but in general this organization feels like negative progress from the 0.8 doCompaction/doCompactionWithoutSizeEstimation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Attaching v2 that doesn&apos;t reassign the sstables field.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think Alan has a good point. I don&apos;t think it&apos;s an appropriate role of the data tracker to modify the set of sstables to be compacted in a task.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I do not disagree with that. However I&apos;d like that we fix trunk as a first priority. It&apos;s a pain to work on other issues (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2521&quot; title=&quot;Move away from Phantom References for Compaction/Memtable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2521&quot;&gt;&lt;del&gt;CASSANDRA-2521&lt;/del&gt;&lt;/a&gt; for instance) while it is broken (and the goal must be to do our best to always have a working trunk). The attached patches doesn&apos;t really change any behavior, it just fixes the bugs, so let&apos;s get that in first before thinking about refactoring.&lt;/p&gt;</comment>
                            <comment id="13051086" author="bcoverston" created="Fri, 17 Jun 2011 14:11:47 +0000"  >&lt;p&gt;I&apos;m sorry I didn&apos;t mean to imply it should be fixed &lt;em&gt;here&lt;/em&gt;. I&apos;ll find a more appropriate venue to vent these frustrations &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13051113" author="jbellis" created="Fri, 17 Jun 2011 14:54:22 +0000"  >&lt;p&gt;+1 v2&lt;/p&gt;</comment>
                            <comment id="13051121" author="slebresne" created="Fri, 17 Jun 2011 15:01:22 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                            <comment id="13051130" author="hudson" created="Fri, 17 Jun 2011 15:21:09 +0000"  >&lt;p&gt;Integrated in Cassandra #931 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/931/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/931/&lt;/a&gt;)&lt;br/&gt;
    Fix compaction of the same sstable by multiple thread&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2769&quot; title=&quot;Cannot Create Duplicate Compaction Marker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2769&quot;&gt;&lt;del&gt;CASSANDRA-2769&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1136904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1136904&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/compaction/CompactionTask.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/DataTracker.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/compaction/CompactionManager.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/compaction/AbstractCompactionTask.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12482653" name="0001-0.8.0-Remove-useless-unmarkCompacting-in-doCleanup.patch" size="5449" author="slebresne" created="Wed, 15 Jun 2011 11:43:29 +0000"/>
                            <attachment id="12482916" name="0001-Do-compact-only-smallerSSTables-v2.patch" size="8632" author="slebresne" created="Fri, 17 Jun 2011 10:18:45 +0000"/>
                            <attachment id="12482654" name="0001-Do-compact-only-smallerSSTables.patch" size="1260" author="slebresne" created="Wed, 15 Jun 2011 11:43:29 +0000"/>
                            <attachment id="12482917" name="0002-Only-compact-what-has-been-succesfully-marked-as-com-v2.patch" size="7192" author="slebresne" created="Fri, 17 Jun 2011 10:18:45 +0000"/>
                            <attachment id="12482655" name="0002-Only-compact-what-has-been-succesfully-marked-as-com.patch" size="7192" author="slebresne" created="Wed, 15 Jun 2011 11:43:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20819</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gdcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93592</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>