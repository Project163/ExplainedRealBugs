<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5145] CQL3 BATCH authorization caching bug</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5145</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;cql3.BatchStatement:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public void checkAccess(ClientState state) throws InvalidRequestException
    {
        Set&amp;lt;String&amp;gt; cfamsSeen = new HashSet&amp;lt;String&amp;gt;();
        for (ModificationStatement statement : statements)
        {
            // Avoid unnecessary authorizations.
            if (!(cfamsSeen.contains(statement.columnFamily())))
            {
                state.hasColumnFamilyAccess(statement.keyspace(), statement.columnFamily(), Permission.MODIFY);
                cfamsSeen.add(statement.columnFamily());
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In CQL3 we can use fully-qualified name of the cf and so a batch can contain mutations for different keyspaces. And when caching cfamsSeen, we ignore the keyspace. This can be exploited to modify any CF in any keyspace so long as the malicious user has CREATE+MODIFY permissions on some keyspace (any keyspace). All you need is to create a table in your ks with the same name as the table you want to modify and perform a batch update.&lt;/p&gt;

&lt;p&gt;Example: an attacker doesn&apos;t have permissions, but wants to modify k1.demo table. The attacker controls k2 keyspace. The attacker creates k2.demo table and then does the following request:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:k2&amp;gt; begin batch
      ... insert into k2.demo ..
      ... insert into k1.demo ..
      ... apply batch;
cqlsh:k2&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;.. and successfully modifies k1.demo table since &apos;demo&apos; cfname will be cached.&lt;/p&gt;

&lt;p&gt;Thrift&apos;s batch_mutate and atomic_batch_mutate are not affected since the only allow mutations to a single ks. CQL2 batches are not affected since they don&apos;t do any caching.&lt;/p&gt;

&lt;p&gt;We should either get rid of caching here or switch cfamsSeen to a Map&amp;lt;String, Set&amp;lt;String&amp;gt;&amp;gt;.&lt;/p&gt;

&lt;p&gt;Personally, I&apos;d rather do the latter now, and get rid of caching here completely once &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4295&quot; title=&quot;Implement caching of authorization results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4295&quot;&gt;&lt;del&gt;CASSANDRA-4295&lt;/del&gt;&lt;/a&gt; is resolved. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12627102">CASSANDRA-5145</key>
            <summary>CQL3 BATCH authorization caching bug</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jan 2013 02:04:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:19 +0000</updated>
                            <resolved>Fri, 11 Jan 2013 16:43:39 +0000</resolved>
                                        <fixVersion>1.1.9</fixVersion>
                    <fixVersion>1.2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13551154" author="slebresne" created="Fri, 11 Jan 2013 15:04:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;d rather do the latter now&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m good with that, though I would not even bother with a map of sets, but just add &lt;tt&gt;statement.keyspace() + &quot;:&quot; + statement.columnFamily()&lt;/tt&gt; to cfamsSeen.&lt;/p&gt;</comment>
                            <comment id="13551166" author="iamaleksey" created="Fri, 11 Jan 2013 15:23:20 +0000"  >&lt;p&gt;Thought about that, but if we later allow &apos;:&apos; in ks/cf names, for example, this would bite us again, since there would be now way to distinguish between (ks: &quot;ks:1&quot;, cf: &quot;demo&quot;) and (ks: &quot;ks&quot;, cf: &quot;1:demo&quot;) and a similar attack would happen.&lt;/p&gt;

&lt;p&gt;Now, this may not be a valid concern, but I&apos;d rather not risk by depending on cql grammar here.&lt;/p&gt;</comment>
                            <comment id="13551193" author="slebresne" created="Fri, 11 Jan 2013 15:38:19 +0000"  >&lt;p&gt;I estimate the change of allowing &apos;:&apos; in ks/cf names before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4295&quot; title=&quot;Implement caching of authorization results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4295&quot;&gt;&lt;del&gt;CASSANDRA-4295&lt;/del&gt;&lt;/a&gt; to 0 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. In fact I kind of doubt we&apos;ll ever allow it (there&apos;s no real use and there&apos;s no point in potentially screwing up tools that rely on those name not containing &apos;:&apos;). But really, I&apos;m perfectly fine with a map of sets.&lt;/p&gt;</comment>
                            <comment id="13551225" author="slebresne" created="Fri, 11 Jan 2013 16:29:38 +0000"  >&lt;p&gt;+1 (nit: we can alias the Set to avoid 2 get()) &lt;/p&gt;</comment>
                            <comment id="13551245" author="iamaleksey" created="Fri, 11 Jan 2013 16:43:39 +0000"  >&lt;p&gt;Thanks, committed (with the nit taken care of).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12564432" name="5145.txt" size="1466" author="aleksey" created="Fri, 11 Jan 2013 16:09:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>303860</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17g3r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>251578</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>