<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5614] W/O specified columns ASPCSI does not get notified of deletes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5614</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m working on a secondary index implementation based on the composite index type.&lt;/p&gt;

&lt;p&gt;AbstractSimplePerColumnSecondaryIndex.java#delete is not called when CQL delete statements do not specify columns.&lt;/p&gt;

&lt;p&gt;When I specify columns it is called. Pretty sure this is a bug.&lt;/p&gt;

&lt;p&gt;Setup:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; create KEYSPACE foo WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};
cqlsh&amp;gt; use foo;
cqlsh:foo&amp;gt; CREATE TABLE albums (artist text, album text, rating &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, release &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (artist, album));
cqlsh:foo&amp;gt; CREATE INDEX ON albums (rating);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:foo&amp;gt; insert into albums (artist, album, rating, release) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;artist&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;album&apos;&lt;/span&gt;, 1, 2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does not get called here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:foo&amp;gt; DELETE FROM albums where artist=&lt;span class=&quot;code-quote&quot;&gt;&apos;artist&apos;&lt;/span&gt; and album=&lt;span class=&quot;code-quote&quot;&gt;&apos;album&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:foo&amp;gt; insert into albums (artist, album, rating, release) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;artist&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;album&apos;&lt;/span&gt;, 1, 2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;gets called here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:foo&amp;gt; DELETE rating FROM albums where artist=&lt;span class=&quot;code-quote&quot;&gt;&apos;artist&apos;&lt;/span&gt; and album=&lt;span class=&quot;code-quote&quot;&gt;&apos;album&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12651026">CASSANDRA-5614</key>
            <summary>W/O specified columns ASPCSI does not get notified of deletes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="bcoverston">Benjamin Coverston</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jun 2013 02:29:21 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:12 +0000</updated>
                            <resolved>Tue, 6 Aug 2013 19:17:45 +0000</resolved>
                                        <fixVersion>2.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13675957" author="jbellis" created="Wed, 5 Jun 2013 14:19:09 +0000"  >&lt;p&gt;We probably need to &quot;expand&quot; row deletes into column tombstones for the benefit of the index.&lt;/p&gt;</comment>
                            <comment id="13676057" author="bcoverston" created="Wed, 5 Jun 2013 15:53:07 +0000"  >&lt;p&gt;Instead of expanding them, at least for the purposes of what I&apos;m doing, I would be OK with just getting keybytes, and column if column had a special marker for a row tombstone. That way I know the whole row was deleted up front (and I can take one action) rather than getting a notification per column.&lt;/p&gt;</comment>
                            <comment id="13676161" author="jbellis" created="Wed, 5 Jun 2013 17:42:33 +0000"  >&lt;p&gt;(Oops, wrong Sam.)&lt;/p&gt;</comment>
                            <comment id="13706971" author="beobal" created="Fri, 12 Jul 2013 14:19:42 +0000"  >&lt;p&gt;I&apos;m tempted to say that this is not a problem because it works as expected with both KeysIndex &amp;amp; CompositesIndex. Yes, the presence of range rather than individual column tombstones in the DeletionInfo means that the index isn&apos;t updated directly at update time, but the index repair-on-read compensates for that at query time. &lt;/p&gt;

&lt;p&gt;We could take the deletion info from the update &amp;amp; use that in some new deleteAll method on SIM.Updater which iterates through the indexed columns issuing deletes, but AFAICT that would require reads to aquire the existing indexed values.&lt;/p&gt;</comment>
                            <comment id="13707412" author="jbellis" created="Fri, 12 Jul 2013 21:44:30 +0000"  >&lt;p&gt;I don&apos;t see how this is different from &quot;pretend the user had deleted the indexed columns by name&quot; as far as read-before-write goes.&lt;/p&gt;</comment>
                            <comment id="13707501" author="beobal" created="Fri, 12 Jul 2013 22:56:35 +0000"  >&lt;p&gt;To delete from the 2i cf you need the old column value to derive the 2i cf key. When a column is deleted by name and that column is present in the memtable, we have the value and so can do that. When the named column isn&apos;t in the memtable, then we don&apos;t have the old value so we skip the delete and treat the operation as an insert. In SIM.StandardUpdater this is a no-op when isMarkedForDelete() == true, so even when the column is named if it&apos;s not in the memtable ASPCSI.delete is never called.&lt;/p&gt;</comment>
                            <comment id="13710358" author="jbellis" created="Tue, 16 Jul 2013 22:07:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;When a column is deleted by name and that column is present in the memtable, we have the value and so can do that. When the named column isn&apos;t in the memtable, then we don&apos;t have the old value&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, but we know the old value is in the sstable and will be cleaned out on compaction.&lt;/p&gt;

&lt;p&gt;So I still don&apos;t see what would break here if we &quot;expand&quot; the tombstone to the indexed columns &amp;#8211; the same logic applies, we either get it from the memtable or at compaction time.&lt;/p&gt;

&lt;p&gt;(I &lt;b&gt;think&lt;/b&gt; we apply row tombstones to indexed data correctly in compaction already &amp;#8211; if so, all we need to do is handle the memtable case, and not actually create extra tombstones.)&lt;/p&gt;</comment>
                            <comment id="13716905" author="beobal" created="Tue, 23 Jul 2013 18:43:00 +0000"  >&lt;p&gt;First, we aren&apos;t doing the right thing in compaction either. Neither PCR or LCR clean up the index in the face of range tombstones, relying on repairs at read time to purge obsolete entries.&lt;br/&gt;
Looking into this, it also seems that PCR &amp;amp; LCR actually generate different SSTables. Although they&apos;re functionally equivalent, those that come from PCR don&apos;t have any columns covered by a RangeTombstone. SSTables generated by LCR do contain these redundant extra columns.&lt;/p&gt;

&lt;p&gt;eg: if we have two SSTables:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;6e697276616e61&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;columns&quot;&lt;/span&gt;: 
	[
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:&quot;&lt;/span&gt;,&quot;&quot;,1374246211348000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:rating&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;4&quot;&lt;/span&gt;,1374246211348000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:release&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,1374246211348000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:&quot;&lt;/span&gt;,&quot;&quot;,1374246211365000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:rating&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt;,1374246211365000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:release&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;,1374246211365000]
	]
}]

[{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;6e697276616e61&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;columns&quot;&lt;/span&gt;: 
	[
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:!&quot;&lt;/span&gt;,1374246212053000,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,1374246212]
	]
}]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When compacted with PCR we end up with in :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[{
	&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;6e697276616e61&quot;&lt;/span&gt;,
	&lt;span class=&quot;code-quote&quot;&gt;&quot;columns&quot;&lt;/span&gt;: [
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:&quot;&lt;/span&gt;,&quot;&quot;,1374246658577000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:rating&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;4&quot;&lt;/span&gt;,1374246658577000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:release&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,1374246658577000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:!&quot;&lt;/span&gt;,1374246659274000,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,1374246659]
	]
}]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But with LCR we get:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[{
	&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;6e697276616e61&quot;&lt;/span&gt;,
	&lt;span class=&quot;code-quote&quot;&gt;&quot;columns&quot;&lt;/span&gt;: [
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:&quot;&lt;/span&gt;,&quot;&quot;,1374246211348000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:rating&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;4&quot;&lt;/span&gt;,1374246211348000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;bleach:release&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,1374246211348000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:!&quot;&lt;/span&gt;,1374246212053000,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,1374246212], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:&quot;&lt;/span&gt;,&quot;&quot;,1374246211365000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:rating&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt;,1374246211365000], 
		[&lt;span class=&quot;code-quote&quot;&gt;&quot;nevermind:release&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;,1374246211365000]
	]
}]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first patch fixes PCR to clean up indexes properly.  &lt;br/&gt;
The second fixes LCR so that it generates SSTables like PCR &amp;amp; fixes its index cleanup. &lt;br/&gt;
The third adds the index cleanup for memtable updates with RT.&lt;/p&gt;</comment>
                            <comment id="13717914" author="jbellis" created="Wed, 24 Jul 2013 02:52:03 +0000"  >&lt;p&gt;Thanks! Do you have a github branch for this?&lt;/p&gt;</comment>
                            <comment id="13718111" author="beobal" created="Wed, 24 Jul 2013 08:11:29 +0000"  >&lt;p&gt;I realised I&apos;d missed the case where the timestamp on a column is greater than the RT&apos;s max, so attaching a fourth patch which handles that. &lt;br/&gt;
My github branch is &lt;a href=&quot;https://github.com/beobal/cassandra/tree/5614&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/beobal/cassandra/tree/5614&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13731133" author="jbellis" created="Tue, 6 Aug 2013 19:17:45 +0000"  >&lt;p&gt;Rebased and committed to 2.0.1.  The most significant change was to include columns in the same mutation as the tombstone in the loop here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Column currentColumn : Iterables.concat(current.map.values(), cm))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12593757" name="0001-CASSANDRA-5614-PreCompactedRow-updates-2i-correctly.patch" size="6835" author="samt" created="Tue, 23 Jul 2013 18:42:31 +0000"/>
                            <attachment id="12593758" name="0002-CASSANDRA-5614-LazilyCompactedRow-outputs-SSTables-a.patch" size="6649" author="samt" created="Tue, 23 Jul 2013 18:42:31 +0000"/>
                            <attachment id="12593759" name="0003-CASSANDRA-5614-Memtable-updates-with-RowTombstone-up.patch" size="3793" author="samt" created="Tue, 23 Jul 2013 18:42:31 +0000"/>
                            <attachment id="12593884" name="0004-CASSANDRA-5614-Consider-timestamps-when-checking-col.patch" size="1253" author="samt" created="Wed, 24 Jul 2013 08:11:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>331352</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1l5xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>331685</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>