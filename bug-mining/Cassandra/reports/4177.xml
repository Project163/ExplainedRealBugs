<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11344] Fix bloom filter sizing with LCS</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11344</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7272&quot; title=&quot;Add &amp;quot;Major&amp;quot; Compaction to LCS and split sstables during STCS major compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7272&quot;&gt;&lt;del&gt;CASSANDRA-7272&lt;/del&gt;&lt;/a&gt; we most often over allocate the bloom filter size with LCS&lt;/p&gt;</description>
                <environment></environment>
        <key id="12949031">CASSANDRA-11344</key>
            <summary>Fix bloom filter sizing with LCS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Fri, 11 Mar 2016 09:18:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:39 +0000</updated>
                            <resolved>Wed, 16 Mar 2016 08:51:01 +0000</resolved>
                                        <fixVersion>2.2.6</fixVersion>
                    <fixVersion>3.0.5</fixVersion>
                    <fixVersion>3.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15190688" author="krummas" created="Fri, 11 Mar 2016 09:19:55 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/bloomfiltersizing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/bloomfiltersizing&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/bloomfiltersizing-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/bloomfiltersizing-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/bloomfiltersizing-3.5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/bloomfiltersizing-3.5&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-3.5-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-3.5-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/bloomfiltersizing-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/bloomfiltersizing-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-bloomfiltersizing-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15190905" author="pauloricardomg" created="Fri, 11 Mar 2016 13:16:51 +0000"  >&lt;p&gt;LGTM, I&apos;ll just resubmit &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9830&quot; title=&quot;Option to disable bloom filter in highest level of LCS sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9830&quot;&gt;&lt;del&gt;CASSANDRA-9830&lt;/del&gt;&lt;/a&gt; cstar runs with this fix to compare results.&lt;/p&gt;</comment>
                            <comment id="15194350" author="pauloricardomg" created="Mon, 14 Mar 2016 23:05:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9830&quot; title=&quot;Option to disable bloom filter in highest level of LCS sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9830&quot;&gt;&lt;del&gt;CASSANDRA-9830&lt;/del&gt;&lt;/a&gt; results are much more consistent and bloom filter sizes have gone down from 60~100MB to ~10MB. The fix also is &lt;a href=&quot;https://www.mail-archive.com/user@cassandra.apache.org/msg46633.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;confirmed&lt;/a&gt; by a mailing user who have been facing OOMs due to large bloom filters.&lt;/p&gt;

&lt;p&gt;I created a &lt;a href=&quot;https://github.com/pauloricardomg/cassandra-dtest/tree/11344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;regression dtest&lt;/a&gt; to check that bloom filter are within a certain range (100K keys, bf should be between 50KB and 100KB, it&apos;s 500KB in the broken version) and resubmitted above dtests with this branch. Feel free to mark as ready to commit when/if tests are passing.&lt;/p&gt;</comment>
                            <comment id="15195001" author="krummas" created="Tue, 15 Mar 2016 09:32:43 +0000"  >&lt;p&gt;The dtest was timing out (we need more than one sstable to do compaction with LCS)&lt;/p&gt;

&lt;p&gt;dtest fixed here: &lt;a href=&quot;https://github.com/krummas/cassandra-dtest/commits/paulo/11344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra-dtest/commits/paulo/11344&lt;/a&gt; - also makes sure that the DTCS/STCS bloom filter sizes make sense&lt;/p&gt;

&lt;p&gt;and builds above retriggered&lt;/p&gt;</comment>
                            <comment id="15195172" author="krummas" created="Tue, 15 Mar 2016 12:11:28 +0000"  >&lt;p&gt;pushed a new commit to the branches above with better sstable count estimation - before it only summed up the total size of the sstables, now it gets an approximated expected compaction ratio. Otherwise we allocate too small bloomfilters.&lt;/p&gt;</comment>
                            <comment id="15195492" author="pauloricardomg" created="Tue, 15 Mar 2016 15:35:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;before it only summed up the total size of the sstables, now it gets an approximated expected compaction ratio.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;nice catch. dtest look good now. I resubmitted &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9830&quot; title=&quot;Option to disable bloom filter in highest level of LCS sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9830&quot;&gt;&lt;del&gt;CASSANDRA-9830&lt;/del&gt;&lt;/a&gt; cstar runs to make sure results are still consistent with the new estimation. will mark this as ready to commit when that is finished and looks good.&lt;/p&gt;

&lt;p&gt;as a minor style nit before committing, could you just move the compaction ratio estimation to a separate method so it doesn&apos;t crowd the &lt;tt&gt;MaxSSTableSizeWriter&lt;/tt&gt; constructor?&lt;/p&gt;</comment>
                            <comment id="15196388" author="pauloricardomg" created="Tue, 15 Mar 2016 22:37:27 +0000"  >&lt;p&gt;cstar results look good, marking as ready to commit.&lt;/p&gt;</comment>
                            <comment id="15197041" author="krummas" created="Wed, 16 Mar 2016 08:51:01 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                            <comment id="15197265" author="pauloricardomg" created="Wed, 16 Mar 2016 13:03:47 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest pr&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12799727" name="CASSANDRA-11344-2.2.patch" size="2314" author="pauloricardomg" created="Wed, 20 Apr 2016 11:40:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uibr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pauloricardomg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>