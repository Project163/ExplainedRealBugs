<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12144] Undeletable / duplicate rows after upgrading from 2.2.4 to 3.0.7</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12144</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We upgraded our cluster today and now have a some rows that refuse to delete.&lt;/p&gt;

&lt;p&gt;Here are some example traces.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/vishnevskiy/36aa18c468344ea22d14f9fb9b99171d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/vishnevskiy/36aa18c468344ea22d14f9fb9b99171d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Even weirder.&lt;/p&gt;

&lt;p&gt;Updating the row and querying it back results in 2 rows even though the id is the clustering key.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;user_id            | id                 | since                    | type
-------------------+--------------------+--------------------------+------
116138050710536192 | 153047019424972800 |                     null |    0
116138050710536192 | 153047019424972800 | 2016-05-30 14:53:08+0000 |    2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then deleting it again only removes the new one.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:discord_relationships&amp;gt; DELETE FROM relationships WHERE user_id = 116138050710536192 AND id = 153047019424972800;
cqlsh:discord_relationships&amp;gt; SELECT * FROM relationships WHERE user_id = 116138050710536192 AND id = 153047019424972800;

 user_id            | id                 | since                    | type
--------------------+--------------------+--------------------------+------
 116138050710536192 | 153047019424972800 | 2016-05-30 14:53:08+0000 |    2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We tried repairing, compacting, scrubbing. No Luck.&lt;/p&gt;

&lt;p&gt;Not sure what to do. Is anyone aware of this?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12987121">CASSANDRA-12144</key>
            <summary>Undeletable / duplicate rows after upgrading from 2.2.4 to 3.0.7</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="stanislav">Stanislav Vishnevskiy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Jul 2016 11:07:01 +0000</created>
                <updated>Mon, 20 Apr 2020 18:02:13 +0000</updated>
                            <resolved>Tue, 19 Jul 2016 10:08:01 +0000</resolved>
                                        <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                                                                <comments>
                            <comment id="15364288" author="iamaleksey" created="Wed, 6 Jul 2016 13:18:31 +0000"  >&lt;p&gt;I&apos;m suspecting that upgrading is irrelevant here, you just have high timestamps in those rows, that are in the future, so deletes do not override them with now(). What&apos;s the writeTime() on those columns?&lt;/p&gt;</comment>
                            <comment id="15364569" author="thobbs" created="Wed, 6 Jul 2016 16:32:00 +0000"  >&lt;p&gt;Can you also paste the schema for that table?&lt;/p&gt;</comment>
                            <comment id="15364659" author="stanislav" created="Wed, 6 Jul 2016 17:15:52 +0000"  >&lt;p&gt;The writetime on the rows is in the GitHub gist.&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt;  SELECT WRITETIME(since), WRITETIME(type) FROM discord_relationships.relationships WHERE  user_id = 116138050710536192 AND id = 153047019424972800;

 writetime(since) | writetime(type)
------------------+------------------
 1464619988173052 | 1464619988173052
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So that was written on May 30th.&lt;/p&gt;

&lt;p&gt;This cluster is half a year old and exhibited zero issues until yesterday pretty much right after the upgrade finished. We also are noticing a weird key cache hit rate right from when the upgrade finished.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://i.imgur.com/JDihdGO.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://i.imgur.com/JDihdGO.png&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The schema is as follows.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE KEYSPACE discord_relationships WITH replication = {&apos;class&apos;: &apos;NetworkTopologyStrategy&apos;, &apos;us-east1&apos;: &apos;3&apos;}  AND durable_writes = true;

CREATE TABLE discord_relationships.relationships (
    user_id bigint,
    id bigint,
    since timestamp,
    type tinyint,
    PRIMARY KEY (user_id, id)
) WITH CLUSTERING ORDER BY (id ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = {&apos;keys&apos;: &apos;ALL&apos;, &apos;rows_per_partition&apos;: &apos;NONE&apos;}
    AND comment = &apos;&apos;
    AND compaction = {&apos;class&apos;: &apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;, &apos;max_threshold&apos;: &apos;32&apos;, &apos;min_threshold&apos;: &apos;4&apos;}
    AND compression = {&apos;chunk_length_in_kb&apos;: &apos;64&apos;, &apos;class&apos;: &apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;}
    AND crc_check_chance = 1.0
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = &apos;99PERCENTILE&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15364824" author="thobbs" created="Wed, 6 Jul 2016 18:27:35 +0000"  >&lt;p&gt;Hmm, so there are multiple rows with the same primary key.  Have you run upgradesstables yet?&lt;/p&gt;</comment>
                            <comment id="15364833" author="stanislav" created="Wed, 6 Jul 2016 18:31:32 +0000"  >&lt;p&gt;Yup for some rows somehow it manages to have multiple rows for the same primary key. Only old rows it seems that existed prior to the upgrade.&lt;/p&gt;

&lt;p&gt;We followed the steps outlines in this document.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.datastax.com/en/latest-upgrade/upgrade/cassandra/upgrdBestPractCassandra.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.datastax.com/en/latest-upgrade/upgrade/cassandra/upgrdBestPractCassandra.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Which included running upgradesstables before and after the upgrade.&lt;/p&gt;</comment>
                            <comment id="15364882" author="thobbs" created="Wed, 6 Jul 2016 18:54:21 +0000"  >&lt;p&gt;Is it possible for you to upload the sstables somewhere for the node that owns that partition?&lt;/p&gt;</comment>
                            <comment id="15365044" author="stanislav" created="Wed, 6 Jul 2016 20:42:06 +0000"  >&lt;p&gt;Email sent.&lt;/p&gt;</comment>
                            <comment id="15365148" author="ifesdjeen" created="Wed, 6 Jul 2016 21:28:46 +0000"  >&lt;p&gt;Hi Stanislav,&lt;/p&gt;

&lt;p&gt;Could you also CC me? I can take a look at it, too.  &lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="15365165" author="stanislav" created="Wed, 6 Jul 2016 21:37:19 +0000"  >&lt;p&gt;I sent you an email.&lt;/p&gt;</comment>
                            <comment id="15367832" author="ifesdjeen" created="Fri, 8 Jul 2016 15:42:39 +0000"  >&lt;p&gt;&lt;tt&gt;2.x&lt;/tt&gt; storage format doesn&apos;t guarantee that there&apos;ll be a single range tombstone, or that tombstones will be in the certain order relative to the cells. Under some circumstances (which I unfortunately could not reproduce), we were in the situation when we had multiple tombstones, followed by the row:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;11111&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:_&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:!&quot;&lt;/span&gt;,&amp;lt;timestamp&amp;gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,&amp;lt;local_deletion_time&amp;gt;], (*1)
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:_&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:!&quot;&lt;/span&gt;,&amp;lt;timestamp&amp;gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;,&amp;lt;local_deletion_time&amp;gt;], (*2)
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:&quot;&lt;/span&gt;,&quot;&quot;,&amp;lt;time&amp;gt;],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:c1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;xxxxxx&quot;&lt;/span&gt;,&amp;lt;time&amp;gt;],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;12345:c2&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;yyyyyy&quot;&lt;/span&gt;,&amp;lt;time&amp;gt;]]}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which was resulting into two rows: one tombstone made from the &lt;tt&gt;(*1)&lt;/tt&gt; and second one, live row made from the tombstone and cells following it (since delete time was that the cells should be live). &lt;/p&gt;

&lt;p&gt;This was resulting into the two rows in the new storage format after &lt;tt&gt;sstableupgrade&lt;/tt&gt;. During the iteration, the first tombstone row was read out, although since second row was also read out and since the rest of merge iterators (superceeding delete might have been in memtable, or any other sstable) were exhausted, it was treated as a completely normal live row. Undeletable since all deletes would only affect the tombstone, whose clustering was matching. &lt;/p&gt;

&lt;p&gt;I&apos;ve made a patch that captures this edge case.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12144-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/upgrade_tests-all-12144-3.0/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12144-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/upgrade_tests-all-12144-trunk/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;ll run the CI and submit patch if it&apos;s successful (particularly interested in upgrade dtests). &lt;/p&gt;

&lt;p&gt;After talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, we might have to also provide a fix for the scrub tool that&apos;d detect and fix such cases.&lt;/p&gt;

&lt;p&gt;Very big thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stanislav&quot; class=&quot;user-hover&quot; rel=&quot;stanislav&quot;&gt;stanislav&lt;/a&gt; for providing information required to track this issue down.&lt;/p&gt;</comment>
                            <comment id="15371559" author="ifesdjeen" created="Mon, 11 Jul 2016 20:36:07 +0000"  >&lt;p&gt;I&apos;ve written a patch for scrub as well. &lt;/p&gt;

&lt;p&gt;I&apos;ve also ran upgrade tests from 2.2 SSTables to 3.0 both through &lt;tt&gt;sstableupgrade&lt;/tt&gt; and through &quot;broken&quot; trunk + &lt;tt&gt;scrub&lt;/tt&gt;. All paths show same results for a large sample of data. I&apos;m re-running all tests plus upgrade tests now.&lt;/p&gt;</comment>
                            <comment id="15372780" author="ifesdjeen" created="Tue, 12 Jul 2016 12:08:47 +0000"  >&lt;p&gt;Created broken sstables for both 2.0 and 3.0 storage formats and wrote some unit tests to reproduce the failures and make the review possibly easier.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12144-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/upgrade_tests-all-12144-3.0/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12144-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/upgrade_tests-all-12144-trunk/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;m re-running the tests again (although only changes were my added sstables and tests). &lt;br/&gt;
Unfortunately, upgrade tests are not very representative as they&apos;re throwing similar failures (in similar amounts on &lt;a href=&quot;https://cassci.datastax.com/view/Upgrades/job/upgrade_tests-all/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;), also failures look more like assertion mismatches. &lt;/p&gt;</comment>
                            <comment id="15382392" author="slebresne" created="Mon, 18 Jul 2016 14:54:46 +0000"  >&lt;p&gt;Mostly look good, just a couple of nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I&apos;d rename &lt;tt&gt;MergingSStableIterator&lt;/tt&gt; as &quot;merging sstables&quot; is a thing and it&apos;s not at all what that class is doing. Call it maybe &lt;tt&gt;RowMergingSSTableIterator&lt;/tt&gt; or &lt;tt&gt;FixDuplicatedRowSSTableIterator&lt;/tt&gt;? Also, as that&apos;s pretty specific to scrub and we shouldn&apos;t be using that anywhere else, so I&apos;d maybe move that inside Scrubber (if we had a scrub package, i&apos;d have more it there, but we don&apos;t).&lt;/li&gt;
	&lt;li&gt;Could maybe move the exception handling code of &lt;tt&gt;SSTableIdentityIterator&lt;/tt&gt; into some reusable function to avoid duplication.&lt;/li&gt;
	&lt;li&gt;In the codebase, when a case of a &lt;tt&gt;if&lt;/tt&gt; is short and exit from the control flow, we tend to deal with it first to limit indentation. Concretely, I mean that in &lt;tt&gt;MergingSSTableIterator.computeNext()&lt;/tt&gt;, it&apos;d be more idiomatic to the codebase to do:
  &lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  if (!iterator.next())
      return endOfData();

  Unfiltered next = iterator.next();
  if (!next.isRow())
      return next;

  ...
  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15382393" author="slebresne" created="Mon, 18 Jul 2016 14:55:38 +0000"  >&lt;p&gt;Also, I don&apos;t really know what are the current state of upgrade tests, so probably not at all that patch fault, but the ones you link above have quite a few failures.&lt;/p&gt;</comment>
                            <comment id="15382564" author="ifesdjeen" created="Mon, 18 Jul 2016 16:45:11 +0000"  >&lt;p&gt;I&apos;ve renamed &lt;tt&gt;MergingSStableIterator&lt;/tt&gt; to &lt;tt&gt;RowMergingSSTableIterator&lt;/tt&gt; and placed it inside the &lt;tt&gt;Scrubber&lt;/tt&gt;. Agree this is a better place for it to vbe.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;SSTableIdentityIterator&lt;/tt&gt;, I&apos;ve added a &lt;tt&gt;doCompute&lt;/tt&gt; method, that contains just iteration logic, which left &lt;tt&gt;computeNext&lt;/tt&gt; with all the error handling, so it deduplicated the code.&lt;/p&gt;

&lt;p&gt;Also, the short-circuit within &lt;tt&gt;doCompute&lt;/tt&gt; that returns &lt;tt&gt;endOfData()&lt;/tt&gt; is added.&lt;/p&gt;

&lt;p&gt;I&apos;m re-running &lt;tt&gt;dtests&lt;/tt&gt;. The first run coincided with the 500+ failures, and second one was made from forked job, so was not very representative. I&apos;ve run it through &lt;tt&gt;upgrade_tests-all-custom_branch_runs&lt;/tt&gt; which should work better, rebased and re-triggered all CI tests. I&apos;ll check results tomorrow, as they&apos;ll presumably run for longer time.&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12144-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12144-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-12144-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Upgrades/job/upgrade_tests-all-custom_branch_runs/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade tests (matrix)&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15383796" author="ifesdjeen" created="Tue, 19 Jul 2016 08:33:18 +0000"  >&lt;p&gt;Upgrade tests look ok. Yesterday we discovered that the upgrade tests were triggered against the incorrect `3_0` release. I&apos;ve checked all the failures locally against trunk, and they all are happening without the patch as well. Also, they look unrelated, as some of them (paging tests) are failing on non-upgraded nodes. &lt;/p&gt;

&lt;p&gt;Summary of failing tests:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select_with_alias_test
basic_compound_paging_test
test_paging_using_secondary_indexes
basic_paging_test
test_paging_using_secondary_indexes_with_static_cols
test_with_allow_filtering
map_keys_indexing_test
basic_compound_paging_tet
static_columns_paging_test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;CI results look ok as well.&lt;/p&gt;</comment>
                            <comment id="15383890" author="slebresne" created="Tue, 19 Jul 2016 10:08:01 +0000"  >&lt;p&gt;Great and +1 on the changes. Committed, thanks.&lt;/p&gt;</comment>
                            <comment id="15575533" author="jlida" created="Fri, 14 Oct 2016 14:37:57 +0000"  >&lt;p&gt;Do you know if this bug also affects upgrading from 2.1.9 to 3.0.8?&lt;/p&gt;</comment>
                            <comment id="15575565" author="ifesdjeen" created="Fri, 14 Oct 2016 14:51:55 +0000"  >&lt;p&gt;Yes, &lt;tt&gt;3.0.8&lt;/tt&gt; is affected. You should upgrade to &lt;tt&gt;3.0.9&lt;/tt&gt; for correct behaviour. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12991118">CASSANDRA-12246</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12972450">CASSANDRA-11887</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13010263">CASSANDRA-12756</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13035206">CASSANDRA-13125</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="13117589">CASSANDRA-14008</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30l9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>