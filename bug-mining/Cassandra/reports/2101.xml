<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:37:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5391] SSL problems with inter-DC communication</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5391</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I get SSL and snappy compression errors in multiple datacenter setup.&lt;/p&gt;

&lt;p&gt;The setup is simple: 3 nodes in AWS east, 3 nodes in Rackspace. I use slightly modified Ec2MultiRegionSnitch in Rackspace (I just added a regex able to parse the Rackspace/Openstack availability zone which happens to be in unusual format).&lt;/p&gt;

&lt;p&gt;During &lt;tt&gt;nodetool rebuild&lt;/tt&gt; tests I managed to (consistently) trigger the following error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-03-19 12:42:16.059+0100 [Thread-13] [DEBUG] IncomingTcpConnection.java(79) org.apache.cassandra.net.IncomingTcpConnection: IOException reading from socket; closing
java.io.IOException: FAILED_TO_UNCOMPRESS(5)
	at org.xerial.snappy.SnappyNative.throw_error(SnappyNative.java:78)
	at org.xerial.snappy.SnappyNative.rawUncompress(Native Method)
	at org.xerial.snappy.Snappy.rawUncompress(Snappy.java:391)
	at org.apache.cassandra.io.compress.SnappyCompressor.uncompress(SnappyCompressor.java:93)
	at org.apache.cassandra.streaming.compress.CompressedInputStream.decompress(CompressedInputStream.java:101)
	at org.apache.cassandra.streaming.compress.CompressedInputStream.read(CompressedInputStream.java:79)
	at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:337)
	at org.apache.cassandra.utils.BytesReadTracker.readUnsignedShort(BytesReadTracker.java:140)
	at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:361)
	at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:371)
	at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:160)
	at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:122)
	at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:226)
	at org.apache.cassandra.net.IncomingTcpConnection.handleStream(IncomingTcpConnection.java:166)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:66)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The exception is raised during DB file download. What is strange is the following:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the exception is raised only when rebuildig from AWS into Rackspace&lt;/li&gt;
	&lt;li&gt;the exception is raised only when all nodes are up and running in AWS (all 3). In other words, if I bootstrap from one or two nodes in AWS, the command succeeds.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Packet-level inspection revealed malformed packets &lt;em&gt;on both ends of communication&lt;/em&gt; (the packet is considered malformed on the machine it originates on).&lt;/p&gt;

&lt;p&gt;Further investigation raised two more concerns:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;We managed to get another stacktrace when testing the scenario. The exception was raised only once during the tests and was raised when I throttled the inter-datacenter bandwidth to 1Mbps.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: javax.net.ssl.SSLException: bad record MAC
	at com.google.common.base.Throwables.propagate(Throwables.java:160)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:32)
	at java.lang.Thread.run(Thread.java:662)
Caused by: javax.net.ssl.SSLException: bad record MAC
	at com.sun.net.ssl.internal.ssl.Alerts.getSSLException(Alerts.java:190)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.fatal(SSLSocketImpl.java:1649)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.fatal(SSLSocketImpl.java:1607)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:859)
	at com.sun.net.ssl.internal.ssl.SSLSocketImpl.readDataRecord(SSLSocketImpl.java:755)
	at com.sun.net.ssl.internal.ssl.AppInputStream.read(AppInputStream.java:75)
	at org.apache.cassandra.streaming.compress.CompressedInputStream$Reader.runMayThrow(CompressedInputStream.java:151)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	... 1 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is pure SSL error with no snappy interference.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I managed to trigger the exception during &lt;tt&gt;nodetool repair&lt;/tt&gt; tests when replacing dead node with a new one &lt;em&gt;on the aws side&lt;/em&gt;, which means the problem is not restricted to the one-way scenario only.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-03-27 14:06:03.033+0100 [Thread-137] [INFO] StreamInSession.java(136) org.apache.cassandra.streaming.StreamInSession: Streaming of file /path/to/cassandra/data/ks/cf/ks-cf-ib-2-Data.db sections=3 progress=0/20513 - 0% for org.apache.cassandra.streaming.StreamInSession@14450ae7 failed: requesting a retry.
2013-03-27 14:06:03.033+0100 [Thread-138] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-98-Data.db
2013-03-27 14:06:03.033+0100 [Thread-138] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-98-Filter.db
2013-03-27 14:06:03.034+0100 [Thread-138] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-98-TOC.txt
2013-03-27 14:06:03.034+0100 [Thread-137] [DEBUG] IncomingTcpConnection.java(91) org.apache.cassandra.net.IncomingTcpConnection: IOException reading from socket; closing
java.io.IOException: FAILED_TO_UNCOMPRESS(5)
	at org.xerial.snappy.SnappyNative.throw_error(SnappyNative.java:78)
	at org.xerial.snappy.SnappyNative.rawUncompress(Native Method)
	at org.xerial.snappy.Snappy.rawUncompress(Snappy.java:391)
	at org.apache.cassandra.io.compress.SnappyCompressor.uncompress(SnappyCompressor.java:93)
	at org.apache.cassandra.streaming.compress.CompressedInputStream.decompress(CompressedInputStream.java:101)
	at org.apache.cassandra.streaming.compress.CompressedInputStream.read(CompressedInputStream.java:79)
	at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)
	at org.apache.cassandra.utils.BytesReadTracker.readUnsignedShort(BytesReadTracker.java:140)
	at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:361)
	at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:371)
	at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:160)
	at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:122)
	at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:238)
	at org.apache.cassandra.net.IncomingTcpConnection.handleStream(IncomingTcpConnection.java:178)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:78)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;$ /etc/alternatives/jre_1.6.0/bin/java -version&lt;br/&gt;
java version &quot;1.6.0_23&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_23-b05)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 19.0-b09, mixed mode)&lt;br/&gt;
$ uname -a&lt;br/&gt;
Linux hostname 2.6.32-358.2.1.el6.x86_64 #1 SMP Tue Mar 12 14:18:09 CDT 2013 x86_64 x86_64 x86_64 GNU/Linux&lt;br/&gt;
$ cat /etc/redhat-release &lt;br/&gt;
Scientific Linux release 6.3 (Carbon)&lt;br/&gt;
$ facter | grep ec2&lt;br/&gt;
...&lt;br/&gt;
ec2_placement =&amp;gt; availability_zone=us-east-1d&lt;br/&gt;
...&lt;br/&gt;
$ rpm -qi cassandra&lt;br/&gt;
cassandra-1.2.3-1.el6.cmp1.noarch&lt;br/&gt;
(custom built rpm from cassandra tarball distribution)&lt;/p&gt;</environment>
        <key id="12639310">CASSANDRA-5391</key>
            <summary>SSL problems with inter-DC communication</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="ondrej.cernos">Ond&#345;ej &#268;erno&#353;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Mar 2013 13:43:45 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:15 +0000</updated>
                            <resolved>Thu, 4 Apr 2013 00:33:47 +0000</resolved>
                                        <fixVersion>1.2.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13615303" author="ondrej.cernos" created="Wed, 27 Mar 2013 14:23:25 +0000"  >&lt;p&gt;With SSL switched off all the scenarios work well.&lt;/p&gt;</comment>
                            <comment id="13615380" author="ondrej.cernos" created="Wed, 27 Mar 2013 15:24:14 +0000"  >&lt;p&gt;After clarifying &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5390&quot; title=&quot;Cassandra doesn&amp;#39;t respect internode compression settings&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5390&quot;&gt;&lt;del&gt;CASSANDRA-5390&lt;/del&gt;&lt;/a&gt; I tried to switch to &lt;tt&gt;DeflateCompressor&lt;/tt&gt; SSTable compression algorithm. The problem is compression-algorithm independent:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-03-27 16:19:57.633+0100 [Thread-31] [INFO] StreamInSession.java(136) org.apache.cassandra.streaming.StreamInSession: component=c4 Streaming of file /mnt/ebs/cassandra/data/c4/user_profile_settings/c4-user_profile_settings-ib-2-Data.db sections=130 progress=0/1628502 - 0% for org.apache.cassandra.streaming.StreamInSession@20f92649 failed: requesting a retry.
2013-03-27 16:19:57.633+0100 [Thread-31] [DEBUG] IncomingTcpConnection.java(91) org.apache.cassandra.net.IncomingTcpConnection: component=c4 IOException reading from socket; closing
java.io.IOException: CRC unmatched
	at org.apache.cassandra.streaming.compress.CompressedInputStream.decompress(CompressedInputStream.java:111)
	at org.apache.cassandra.streaming.compress.CompressedInputStream.read(CompressedInputStream.java:79)
	at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)
	at org.apache.cassandra.utils.BytesReadTracker.readUnsignedShort(BytesReadTracker.java:140)
	at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:361)
	at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:371)
	at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:160)
	at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:122)
	at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:238)
	at org.apache.cassandra.net.IncomingTcpConnection.handleStream(IncomingTcpConnection.java:178)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:78)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13615442" author="ondrej.cernos" created="Wed, 27 Mar 2013 16:19:35 +0000"  >&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;With SSTable compression switched off the bug disappears. When I run nodetool rebuild us-east on a Rackspace node, it fetches the data correctly and when I compare the md5 of the DB file on an AWS node (after flush and compaction), it is exactly the same as on the Rackspace node.&lt;br/&gt;
It means the problem is only with compressed SSTables, but the problem is independent on chosen compression algorithm. And only with SSL switched on for inter-DC communication.&lt;/p&gt;</comment>
                            <comment id="13615459" author="jbellis" created="Wed, 27 Mar 2013 16:29:13 +0000"  >&lt;p&gt;Can you shed any light, Jake?&lt;/p&gt;</comment>
                            <comment id="13615479" author="tjake" created="Wed, 27 Mar 2013 16:49:05 +0000"  >&lt;p&gt;Nope, we don&apos;t use SSL.  Does it work when you disable internode compression?&lt;/p&gt;</comment>
                            <comment id="13615499" author="ondrej.cernos" created="Wed, 27 Mar 2013 17:03:49 +0000"  >&lt;p&gt;Internode compression settings didn&apos;t have any influence on the problem. The case is very strange:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;it happens only when SSTables are compressed (see the update above)&lt;/li&gt;
	&lt;li&gt;it is independent on SSTable compression implementation however (also see above)&lt;/li&gt;
	&lt;li&gt;it happens only when &quot;enough&quot; (all 3) nodes are switched on in AWS. With 2 or 1 only the problem disappears&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Do you have a recommendation on what to investigate further? I already asked the network team to check networking - they say all is ok - and our operations, who also cannot identify anything, except for the fact MTU is different in Rackspace and AWS, so packet from AWS to Rackspace get fragmented.&lt;/p&gt;</comment>
                            <comment id="13616307" author="ondrej.cernos" created="Thu, 28 Mar 2013 14:44:56 +0000"  >&lt;p&gt;I am becoming quite sure the problem is a race condition in Cassandra code handling decompression of sstables when these are streamed from the remote datacenter.&lt;/p&gt;

&lt;p&gt;Both traces - when snappy is used and when the java zip is used - share the same calls, see above.&lt;/p&gt;

&lt;p&gt;I switched trace level in log4j and this is what I found:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;when 2 and more nodes live in the remote DC, cassandra fires two threads downloading the same file&lt;/li&gt;
	&lt;li&gt;when only 1 node lives in the remote DC, only one thread downloads the file&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is how it looks in log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-03-28 13:44:57.301+0100 [Thread-22] [DEBUG] StreamInSession.java(104) org.apache.cassandra.streaming.StreamInSession: Adding file /path/to/cassandra/data/ks/cf/ks-cf-ib-2-Data.db to Stream Request queue
2013-03-28 13:44:57.301+0100 [Thread-22] [DEBUG] StreamInSession.java(104) org.apache.cassandra.streaming.StreamInSession: Adding file /path/to/cassandra/data/ks/cf/ks-cf-ib-1-Data.db to Stream Request queue
2013-03-28 13:44:57.338+0100 [Thread-23] [DEBUG] StreamInSession.java(104) org.apache.cassandra.streaming.StreamInSession: Adding file /path/to/cassandra/data/ks/cf/ks-cf-ib-2-Data.db to Stream Request queue
2013-03-28 13:44:57.340+0100 [Thread-23] [DEBUG] StreamInSession.java(104) org.apache.cassandra.streaming.StreamInSession: Adding file /path/to/cassandra/data/ks/cf/ks-cf-ib-1-Data.db to Stream Request queue
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And here is the result grepped on the two threads:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-03-28 13:44:57.477+0100 [Thread-22] [TRACE] SSTableWriter.java(145) org.apache.cassandra.io.sstable.SSTableWriter: wrote DecoratedKey(-8516046549581000893, 6663363133663230623932663663303732623735653332643964616261623165) at 183591
2013-03-28 13:44:57.477+0100 [Thread-22] [TRACE] SSTableWriter.java(463) org.apache.cassandra.io.sstable.SSTableWriter: wrote index entry: org.apache.cassandra.db.RowIndexEntry@7b553d18 at 16192
2013-03-28 13:44:57.477+0100 [Thread-22] [TRACE] SSTableWriter.java(145) org.apache.cassandra.io.sstable.SSTableWriter: wrote DecoratedKey(-8513551951874950453, 3934363831326161323235653165613662613039346233356264386461653735) at 183995
2013-03-28 13:44:57.478+0100 [Thread-22] [TRACE] SSTableWriter.java(463) org.apache.cassandra.io.sstable.SSTableWriter: wrote index entry: org.apache.cassandra.db.RowIndexEntry@d5f0688 at 16238
2013-03-28 13:44:57.501+0100 [Thread-22] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-1-Data.db
2013-03-28 13:44:57.501+0100 [Thread-22] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-1-Filter.db
2013-03-28 13:44:57.501+0100 [Thread-22] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-1-TOC.txt
2013-03-28 13:44:57.501+0100 [Thread-22] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-1-CompressionInfo.db
2013-03-28 13:44:57.502+0100 [Thread-22] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-1-Index.db
2013-03-28 13:44:57.502+0100 [Thread-22] [DEBUG] SSTable.java(154) org.apache.cassandra.io.sstable.SSTable: Deleted /path/to/cassandra/data/ks/cf/ks-cf-tmp-ib-1
2013-03-28 13:44:57.503+0100 [Thread-22] [INFO] StreamInSession.java(136) org.apache.cassandra.streaming.StreamInSession: Streaming of file /path/to/cassandra/data/ks/cf/ks-cf-ib-2-Data.db sections=130 progress=67628/1583497 - 4% for org.apache.cassandra.streaming.StreamInSession@21400eb0 failed: requesting a retry.
2013-03-28 13:44:57.504+0100 [Thread-22] [DEBUG] IncomingTcpConnection.java(91) org.apache.cassandra.net.IncomingTcpConnection: IOException reading from socket; closing
java.io.IOException: CRC unmatched
        at org.apache.cassandra.streaming.compress.CompressedInputStream.decompress(CompressedInputStream.java:111)
        at org.apache.cassandra.streaming.compress.CompressedInputStream.read(CompressedInputStream.java:79)
        at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)
        at org.apache.cassandra.utils.BytesReadTracker.readUnsignedShort(BytesReadTracker.java:140)
        at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:361)
        at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:371)
        at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:160)
        at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:122)
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:238)
        at org.apache.cassandra.net.IncomingTcpConnection.handleStream(IncomingTcpConnection.java:178)
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:78)

2013-03-28 13:44:58.070+0100 [Thread-23] [TRACE] SSTableWriter.java(463) org.apache.cassandra.io.sstable.SSTableWriter: wrote index entry: org.apache.cassandra.db.RowIndexEntry@db766c1 at 106582
2013-03-28 13:44:58.071+0100 [Thread-23] [TRACE] SSTableWriter.java(145) org.apache.cassandra.io.sstable.SSTableWriter: wrote DecoratedKey(-4829320003365722996, 6333383266393230353964313666633136356335333437353637373735653065) at 1217942
2013-03-28 13:44:58.071+0100 [Thread-23] [TRACE] SSTableWriter.java(463) org.apache.cassandra.io.sstable.SSTableWriter: wrote index entry: org.apache.cassandra.db.RowIndexEntry@3bb0ff0 at 106628
2013-03-28 13:44:58.071+0100 [Thread-23] [TRACE] SSTableWriter.java(145) org.apache.cassandra.io.sstable.SSTableWriter: wrote DecoratedKey(-4827623571007838156, 6162376162333238393739643930336266616566393039376131366238386166) at 1218191
2013-03-28 13:44:58.071+0100 [Thread-23] [TRACE] SSTableWriter.java(463) org.apache.cassandra.io.sstable.SSTableWriter: wrote index entry: org.apache.cassandra.db.RowIndexEntry@6e135779 at 106674
2013-03-28 13:44:58.091+0100 [Thread-23] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-2-Data.db
2013-03-28 13:44:58.091+0100 [Thread-23] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-2-Filter.db
2013-03-28 13:44:58.091+0100 [Thread-23] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-2-TOC.txt
2013-03-28 13:44:58.091+0100 [Thread-23] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-2-CompressionInfo.db
2013-03-28 13:44:58.091+0100 [Thread-23] [DEBUG] FileUtils.java(110) org.apache.cassandra.io.util.FileUtils: Deleting ks-cf-tmp-ib-2-Index.db
2013-03-28 13:44:58.091+0100 [Thread-23] [DEBUG] SSTable.java(154) org.apache.cassandra.io.sstable.SSTable: Deleted /path/to/cassandra/data/ks/cf/ks-cf-tmp-ib-2
2013-03-28 13:44:58.091+0100 [Thread-23] [INFO] StreamInSession.java(136) org.apache.cassandra.streaming.StreamInSession: Streaming of file /path/to/cassandra/data/ks/cf/ks-cf-ib-2-Data.db sections=131 progress=406399/1638227 - 24% for org.apache.cassandra.streaming.StreamInSession@37d40164 failed: requesting a retry.
2013-03-28 13:44:58.092+0100 [Thread-23] [DEBUG] IncomingTcpConnection.java(91) org.apache.cassandra.net.IncomingTcpConnection: IOException reading from socket; closing
java.io.IOException: CRC unmatched
        at org.apache.cassandra.streaming.compress.CompressedInputStream.decompress(CompressedInputStream.java:111)
        at org.apache.cassandra.streaming.compress.CompressedInputStream.read(CompressedInputStream.java:79)
        at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)
        at org.apache.cassandra.utils.BytesReadTracker.readUnsignedShort(BytesReadTracker.java:140)
        at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:361)
        at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:371)
        at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:160)
        at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:122)
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:238)
        at org.apache.cassandra.net.IncomingTcpConnection.handleStream(IncomingTcpConnection.java:178)
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:78)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is common for snappy and java zip:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at org.apache.cassandra.streaming.compress.CompressedInputStream.read(CompressedInputStream.java:79)
	at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:320)
	at org.apache.cassandra.utils.BytesReadTracker.readUnsignedShort(BytesReadTracker.java:140)
	at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:361)
	at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:371)
	at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:160)
	at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:122)
	at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:238)
	at org.apache.cassandra.net.IncomingTcpConnection.handleStream(IncomingTcpConnection.java:178)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:78)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the download runs in single thread, the problem disappears.&lt;/p&gt;</comment>
                            <comment id="13616355" author="ondrej.cernos" created="Thu, 28 Mar 2013 15:32:35 +0000"  >&lt;p&gt;How does cassandra compute the number of threads involved in streaming?&lt;/p&gt;</comment>
                            <comment id="13616383" author="yukim" created="Thu, 28 Mar 2013 16:06:03 +0000"  >&lt;p&gt;When sending file, it is single-threaded per destination.&lt;/p&gt;</comment>
                            <comment id="13616475" author="ondrej.cernos" created="Thu, 28 Mar 2013 17:55:00 +0000"  >&lt;p&gt;How does this information match the observed behaviour? I can clearly see two threads downloading the file.&lt;/p&gt;</comment>
                            <comment id="13617037" author="yukim" created="Fri, 29 Mar 2013 03:34:03 +0000"  >&lt;p&gt;CompressedFileStreamTask is not sending the right part of the file when using inter-node encryption, and that causes various IOException described here.&lt;/p&gt;

&lt;p&gt;Patch attached for fix.&lt;/p&gt;</comment>
                            <comment id="13617182" author="iamaleksey" created="Fri, 29 Mar 2013 08:38:36 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13617398" author="yukim" created="Fri, 29 Mar 2013 14:59:06 +0000"  >&lt;p&gt;Committed. Thanks!&lt;/p&gt;</comment>
                            <comment id="13620761" author="jan.chochol" created="Wed, 3 Apr 2013 09:18:20 +0000"  >&lt;p&gt;Hi everyone, I am working with Ondrej on same problem.&lt;br/&gt;
I just looked to patch (git commit cc6429e2722e764dce8cad77660732146ed596ab) and I am not sure that it is exactly correct.&lt;br/&gt;
Problematic situation is, when &lt;tt&gt;length&lt;/tt&gt; &amp;gt; &lt;tt&gt;CHUNK_SIZE&lt;/tt&gt; (in &lt;tt&gt;CompressedFileStreamTask.stream()&lt;/tt&gt;). In this case data will be sent in more chunks, but before every chunk this code will be executed:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;file.seek(section.left);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Sending only first chunk every time will probably lead to described error.&lt;br/&gt;
I would suggest to move &lt;tt&gt;file.seek&lt;/tt&gt; before beginning of &lt;tt&gt;while&lt;/tt&gt; cycle (than file pointer will be moved by &lt;tt&gt;readFully&lt;/tt&gt;) or change mentioned code to&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;file.seek(section.left + bytesTransferred);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13620785" author="krummas" created="Wed, 3 Apr 2013 09:40:31 +0000"  >&lt;p&gt;that sounds and looks reasonable, reopening to let @yukim have a look&lt;/p&gt;</comment>
                            <comment id="13620791" author="ondrej.cernos" created="Wed, 3 Apr 2013 09:49:32 +0000"  >&lt;p&gt;I tested the patch and verified it doesn&apos;t fix the issue.&lt;/p&gt;</comment>
                            <comment id="13620853" author="ondrej.cernos" created="Wed, 3 Apr 2013 11:29:42 +0000"  >&lt;p&gt;I tried Jan&apos;s proposal to move the seek out of the while loop and let the pointer be moved by the readFully method call, but with no luck. I&apos;ll let someone with more Cassandra internals knowledge to dive into this.&lt;/p&gt;</comment>
                            <comment id="13620901" author="yukim" created="Wed, 3 Apr 2013 13:15:09 +0000"  >&lt;p&gt;Jan, Ond&#345;ej,&lt;/p&gt;

&lt;p&gt;Thanks for reporting.&lt;br/&gt;
What I wanted to do was to position the file pointer to the beginning of section for each loop, as uncompressed version do.&lt;br/&gt;
I attached two patches (-1.2.3 to apply for 1.2.3 release and -1.2 for current 1.2 branch). Can you try these?&lt;/p&gt;</comment>
                            <comment id="13621012" author="ondrej.cernos" created="Wed, 3 Apr 2013 15:58:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12576777/5391-1.2.3.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;This&lt;/a&gt; patch seems to work. So the issue may be resolved now. Thanks!&lt;/p&gt;</comment>
                            <comment id="13621581" author="yukim" created="Thu, 4 Apr 2013 00:33:47 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="13697313" author="mikelococo" created="Mon, 1 Jul 2013 23:14:59 +0000"  >&lt;p&gt;I don&apos;t think I see any code changes in the 1.1.x branch as a result of this bug. Does the bug not apply to 1.1.x (aka, it was introduced in the 1.2.0 streaming refactor?), or does 1.1.12 (and 1.1.9, on which Datastax Enterprise is based) still suffer from this?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12638877">CASSANDRA-5381</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12639306">CASSANDRA-5390</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12576777" name="5391-1.2.3.txt" size="1352" author="yukim" created="Wed, 3 Apr 2013 13:15:09 +0000"/>
                            <attachment id="12576020" name="5391-1.2.txt" size="1227" author="yukim" created="Fri, 29 Mar 2013 03:34:03 +0000"/>
                            <attachment id="12576778" name="5391-v2-1.2.txt" size="1332" author="yukim" created="Wed, 3 Apr 2013 13:15:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>319780</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j6cf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320121</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>