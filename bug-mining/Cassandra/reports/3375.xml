<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8707] Move SegmentedFile, IndexSummary and BloomFilter to utilising RefCounted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8707</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There are still a few bugs with resource management, especially around SSTableReader cleanup, esp. when intermixing with compaction. This migration should help. We can simultaneously &quot;simplify&quot; the logic in SSTableReader to not track the replacement chain, only to take a new reference to each of the underlying resources.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12771353">CASSANDRA-8707</key>
            <summary>Move SegmentedFile, IndexSummary and BloomFilter to utilising RefCounted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Jan 2015 14:35:21 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:57 +0000</updated>
                            <resolved>Wed, 11 Feb 2015 15:24:34 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14298807" author="benedict" created="Fri, 30 Jan 2015 16:24:04 +0000"  >&lt;p&gt;I&apos;ve uploaded a patch &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/8707-safercleanup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There are a couple of minor semi-extraneous commits tweaking slightly the design just introduced in 7705, in particular:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;introducing a ref() method for those instances where we expect never to fail&lt;/li&gt;
	&lt;li&gt;Letting Ref and RefCounted hold a reference to the thing they&apos;re counting, so that Ref.referent() can be supported&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The patch itself then has some ground works:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Encapsulate SSTableReader.readMeter, so it isn&apos;t accessed directly&lt;/li&gt;
	&lt;li&gt;Introduce a new SharedCloseable interface that represents a Closeable that can be shared by creating a new instance via sharedCopy(); each instance can treated as distinct, but the underlying resources will only be closed once all of them are. it is backed by RefCounted, and just provides a convenient abstraction.&lt;/li&gt;
	&lt;li&gt;Make IndexSummary, IFilter and SegmentedFile implement SharedCloseable&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Finally we do the guts of the patch, which is refactoring the cleanup in SSTableReader so that instead of maintaining a chain of replacements, we have three tiers of resource management: instance-only, type-shared (TEMPLINK/FINAL), and global. Each have their own reference count managed to ensure safe cleanup. The instance-only fields include the major ones: dfile, ifile, summary and filter, as these are all managed directly via SharedCloseable. The type-shared and global manage general cleanup, such as dropping page cache, trashing read meter data, deleting files, etc.&lt;/p&gt;

&lt;p&gt;Hopefully only the last bit is the only that requires considerable attention, and whilst it is a little verbose the logic should be much easier to understand the before, and hence much safer. It will also give us all of the new debug info if we get it wrong.&lt;/p&gt;

&lt;p&gt;This patch exposes a number of new LEAK DETECTED warnings in unit tests which I want to work through, but I suspect mostly are down to creating and discarding sstables directly in the test methods. &lt;/p&gt;</comment>
                            <comment id="14299286" author="benedict" created="Fri, 30 Jan 2015 22:14:35 +0000"  >&lt;p&gt;I&apos;ve pushed an update to the repository with numerous fixes to the test cases suppressing all leak detection (except in RefCountedTest, where they&apos;re intended). In doing so I came across several meaningful memory leaks that I&apos;ve also fixed. The worst offender being the bloom filter from SSTableWriter, which was not being freed. Users performing bulk transformations could have presumably been badly affected by this. &lt;/p&gt;</comment>
                            <comment id="14299930" author="benedict" created="Sat, 31 Jan 2015 18:36:18 +0000"  >&lt;p&gt;I was playing with another small refactor to the ref counting code, and somehow managed to butcher my git history so that I overrode my backup copy with the new version as well (still not sure what I did), and uploaded it. The upshot is there&apos;s an extra refactor in there. I can attempt to rollback the change if you prefer, but it isn&apos;t too drastic and I think makes the API cleaner.&lt;/p&gt;

&lt;p&gt;Essentially, I remerged RefCountedImpl with Ref, but in the opposite way. Now you just create a Ref object, which sorts out creating all of the background gubbins. The Ref object both manages a single reference and the creation of new references. This simplifies some of the new helper classes I&apos;ve created, and I think creates a lower cognitive burden on the user of the API. The biggest upshot is there is no concept of a sharedRef(); the first Ref you create you can simply stash somewhere (which we do in SSTableReader). I think this is cleaner, as it&apos;s not always necessary to have a &quot;sharedRef&quot;. &lt;/p&gt;

&lt;p&gt;Let me know what you think. I&apos;ve done my best to keep all of the changes into relatively small easily digested commits, so hopefully the review burden won&apos;t be too problematic. But we can rework it if necessary.&lt;/p&gt;</comment>
                            <comment id="14303053" author="krummas" created="Tue, 3 Feb 2015 10:33:05 +0000"  >&lt;ul&gt;
	&lt;li&gt;SSTableDeletingTask - why not notify when deleting tmplink files?&lt;/li&gt;
	&lt;li&gt;Memory - looks like a fix for some other issue included, break that out in a new ticket?&lt;/li&gt;
	&lt;li&gt;BloomFilter - the protected copy constructor, why not use the hashCount and bitset from the copy that is passed in?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In general I think the new class hierarchy inside SSTableReader (TypeManager/GlobalManager/TidyManager/TypeTidy/InstanceTidier) needs to be simplified and documented (basically no comments at all right now). I find it very hard to follow, perhaps it is because of the naming of the classes (for example, the name &quot;TypeManager&quot; is quite generic and tells me very little) or that they are nested and access each others private fields.&lt;/p&gt;</comment>
                            <comment id="14303099" author="benedict" created="Tue, 3 Feb 2015 11:24:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;SSTableDeletingTask - why not notify when deleting tmplink files?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We never did before - in fact we never called this for tmplink files previously, but since they could fail to delete for whatever reason, it seemed sensible to make it be called for those whilst cleaning this up. I&apos;m assuming listeners to deletion notifications care about &lt;em&gt;actual&lt;/em&gt; deletion, as opposed to deletion of an interim file, so I expect the prior behaviour is correct.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Memory - looks like a fix for some other issue included, break that out in a new ticket?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Split out into &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8726&quot; title=&quot;throw OOM in Memory if we fail to allocate&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8726&quot;&gt;&lt;del&gt;CASSANDRA-8726&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;BloomFilter - the protected copy constructor, why not use the hashCount and bitset from the copy that is passed in?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In general I think the new class hierarchy inside SSTableReader (TypeManager/GlobalManager/TidyManager/TypeTidy/InstanceTidier) needs to be simplified and documented (basically no comments at all right now). I find it very hard to follow, perhaps it is because of the naming of the classes (for example, the name &quot;TypeManager&quot; is quite generic and tells me very little) or that they are nested and access each others private fields.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK, I&apos;ll see what I can do to comment that better. The minimal comments were &quot;One Per X&quot; which perhaps weren&apos;t very clear - they are expanding umbrellas of shared state: instance, descriptor &quot;type&quot;, and global (&quot;per logical sstable&quot;). The XManager is just a shared abstraction for tracking the umbrellas, so when a new reader is constructed it asks a manager for a reference to its shared state. I&apos;ll see if I can make this much clearer.&lt;/p&gt;</comment>
                            <comment id="14303145" author="benedict" created="Tue, 3 Feb 2015 11:57:40 +0000"  >&lt;p&gt;OK, I&apos;ve force pushed a version with comments in a directly proceeding commit to the introduction of that refactor. Let me know if it is still insufficient.&lt;/p&gt;

&lt;p&gt;It is &lt;em&gt;possible&lt;/em&gt; we could simplify by not distinguishing between the global and per-descriptor-type state. We could, for instance, only support getCurrentReplacement() for like-types, and only persist read meter stats for FINAL files. The only thing that would be explicitly wrong would be the dropping of the page cache, which might happen prematurely. The reason I like the separation, however, is that it directly maps onto the actual lifecycles, so (excepting the initial acclimation) there is a lower cognitive burden for understanding how and when cleanup occurs; and there are no caveats to the other pieces of state and where you can use them. My current view is there is too much special casing going on, and it&apos;s introducing bugs, so I want to move to abstractions that map as closely to use as possible.&lt;/p&gt;</comment>
                            <comment id="14303167" author="benedict" created="Tue, 3 Feb 2015 12:20:29 +0000"  >&lt;p&gt;I&apos;ve split the Memory change out into &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8726&quot; title=&quot;throw OOM in Memory if we fail to allocate&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8726&quot;&gt;&lt;del&gt;CASSANDRA-8726&lt;/del&gt;&lt;/a&gt;, and will upload a version omitting it and the BF change shortly.&lt;/p&gt;</comment>
                            <comment id="14303566" author="jmckenzie" created="Tue, 3 Feb 2015 16:53:51 +0000"  >&lt;p&gt;For the record - I&apos;m vary wary of anything touching SSTableDeletingTask on 2.1 w/regards to Windows.  That being said - changes there look fine and don&apos;t appear to break anything obvious to my testing over here.  Only thing that popped up with a mixed stress and major compaction running concurrently was &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8535&quot; title=&quot;java.lang.RuntimeException: Failed to rename XXX to YYY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8535&quot;&gt;&lt;del&gt;CASSANDRA-8535&lt;/del&gt;&lt;/a&gt; as expected.&lt;/p&gt;</comment>
                            <comment id="14303571" author="benedict" created="Tue, 3 Feb 2015 16:56:31 +0000"  >&lt;p&gt;The behaviour is the same on Windows (well, some stuff unrelated to deletion has been moved out). it is largely the same on Linux, it&apos;s just run for early opened files as well.&lt;/p&gt;</comment>
                            <comment id="14304901" author="krummas" created="Wed, 4 Feb 2015 10:30:21 +0000"  >&lt;ul&gt;
	&lt;li&gt;class comments in RefCounted and Ref out of date (we don&apos;t have any RefCounted.Impl anymore for example)&lt;/li&gt;
	&lt;li&gt;make SegmentedFile.Cleanup abstract and remove the empty tidy implementation. There is an instance created in BufferedSegmentedFile, I think it would be clearer if the empty tidy() method is implemented there.&lt;/li&gt;
	&lt;li&gt;A few unused SharedClosable imports in the *SegmentedFile files&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Still waiting for a simplification of the class hierarchy in SSTableReader as it is very hard to follow (though, yes, it is perhaps simpler than the linked list approach).&lt;/p&gt;

&lt;p&gt;If it is as simple as it can be, I&apos;m almost inclined to suggest that we should stop doing early opening of compaction results as I doubt the complexity is worth it, we have had so many issues with this since we released it (quite a few caused by me trying to fix other issues with it).&lt;/p&gt;</comment>
                            <comment id="14305068" author="benedict" created="Wed, 4 Feb 2015 13:26:36 +0000"  >&lt;p&gt;Well, all I will say is that I wash my hands of resource cleanup problems without some variant of this patch. It has already caught several memory leaks before even being committed and used in the wild (all unrelated to the reasons I started it).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Still waiting for a simplification of the class hierarchy&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I offered one suggestion, that I think makes it worse but does simplify it. Another is to eliminate all of the XManager classes and just have them duplicate the code for lookup in a statically referenced ConcurrentMap. I did it this way first, but found the code duplication very ugly. I&apos;m honestly not sure what the problem is here, though, as it seems to map pretty straightforwardly onto how things work.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m almost inclined to suggest that we should stop doing early opening of compaction results &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We would have to also stop doing summary resampling, as that was broken prior to the introduction of the linked-list chain, and is probably still subtly broken and brittle. The only distinction with this patch would be the ability to (without caveat) merge GlobalTidy and TypeTidy, but this seems like a small win, since we could do this now, as I suggested, but would still prefer not to.&lt;/p&gt;</comment>
                            <comment id="14305114" author="krummas" created="Wed, 4 Feb 2015 14:14:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;simplify by not distinguishing between the global and per-descriptor-type state.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;eliminate all of the XManager classes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;merge GlobalTidy and TypeTidy&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;lets try that?&lt;/p&gt;</comment>
                            <comment id="14305137" author="benedict" created="Wed, 4 Feb 2015 14:21:28 +0000"  >&lt;p&gt;Like I said, I&apos;d &lt;em&gt;really&lt;/em&gt; rather not merge GlobalTidy and TypeTidy, but can if you&apos;re really set on it. By doing so we trade some slight class hierarchy simplcity for special casing, and the latter always leads to problems further down the line. I&apos;ll offer up a version with the XManager classes removed for now, and see where that gets us.&lt;/p&gt;</comment>
                            <comment id="14305146" author="krummas" created="Wed, 4 Feb 2015 14:24:49 +0000"  >&lt;p&gt;Imo &quot;special casing&quot; is fine if the special case is the only thing you need right now, I&apos;d prefer making it more generic when we need to&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;ll offer up a version with the XManager classes removed for now,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;sounds good&lt;/p&gt;</comment>
                            <comment id="14305155" author="benedict" created="Wed, 4 Feb 2015 14:29:42 +0000"  >&lt;p&gt;Special casing is where many of our recent bugs have come from, as far as I can tell. They interplay with each other in ways we cannot easily predict, especially when focusing on one area of the codebase. We think &quot;it&apos;ll be fine here, as it doesn&apos;t touch anything else, and I&apos;ve got a handle on what it does&quot; - then we remember validation compaction in LCS that breaks our assumption, for instance.&lt;/p&gt;</comment>
                            <comment id="14305447" author="benedict" created="Wed, 4 Feb 2015 16:27:53 +0000"  >&lt;p&gt;OK, uploaded a version with all of the outstanding nits addressed and the XManager hierarchy removed. It doesn&apos;t look so ugly, to be honest, so we can definitely manage with this if it makes it sufficiently clearer. I have my fingers crossed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14307337" author="tjake" created="Thu, 5 Feb 2015 15:02:16 +0000"  >&lt;p&gt;I want to give this code time to bake and give users some relief in the meantime with the other ~100 fixes in 2.1.3. &lt;/p&gt;

&lt;p&gt;I suggest we push this to 2.1.4 as well as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8683&quot; title=&quot;Ensure early reopening has no overlap with replaced files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8683&quot;&gt;&lt;del&gt;CASSANDRA-8683&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8744&quot; title=&quot;Ensure SSTableReader.first/last are honoured universally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8744&quot;&gt;&lt;del&gt;CASSANDRA-8744&lt;/del&gt;&lt;/a&gt;.  I suggest we disable incremental compaction for 2.1.3 which should avoid most of these bugs.  &lt;/p&gt;</comment>
                            <comment id="14308989" author="krummas" created="Fri, 6 Feb 2015 11:20:33 +0000"  >&lt;p&gt;I think the penny has finally dropped for me, the thing I&apos;m missing now is more &quot;why?&quot;-comments, for example, why do we need to copy CompressionMetadata in CM.Writer#open(..) if finish type is final and not otherwise? In general, more &quot;why?&quot;-comments than &quot;what?&quot; would be helpful, at least around the tricky parts, I think future readers will appreciate that.&lt;/p&gt;

&lt;p&gt;Also, I think we need some high level documentation with concrete examples about the life cycle of sstables. I think this part of the code would be much simpler to maintain with a description of why and when the different cases occur.&lt;/p&gt;

&lt;p&gt;So, I&apos;m +1 once we have some documentation (perhaps as a big comment on top in SSTableReader?), and a bit of a tweak to the current code comments to focus more on why we do certain things.&lt;/p&gt;</comment>
                            <comment id="14309098" author="benedict" created="Fri, 6 Feb 2015 13:12:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, I think we need some high level documentation with concrete examples about the life cycle of sstables. ... (perhaps as a big comment on top in SSTableReader?)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This seems like an excellent idea, and this ticket seems like a good opportunity to introduce it, although it will have to be revised with each of my follow ons. It didn&apos;t really occur to me to do this since that is all unchanged here, but it has grown overtime to be very non-obvious. It would be helpful if, once I&apos;ve introdiced a high-level overview, the individuals familiar with the &lt;em&gt;tool&lt;/em&gt; or special compaction lifecycles (or others) could amend the SSTableReader description to make it clear how they are expected to behave and treat sstables, and what assumptions they utilise, as that is often subtly different and I am not at all an expert in those areas.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the penny has finally dropped for me, the thing I&apos;m missing now is more &quot;why?&quot;-comments, for example, why do we need to copy CompressionMetadata in CM.Writer#open(..) if finish type is final and not otherwise?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could you list the places you think need this service? Since the code outside of SSTableReader tidying is largely functionally unchanged, only swapping in a new API, it&apos;s not clear which bits need this, outside of the high level overview. This particular spot, for instance, had this behaviour previously (and it&apos;s about resizing, rather than copying, since we now know the final size of the data so can release it). One of the follow tickets also cleans this particular spot up a little, by introducing an enum specific to it that describes the reasons for opening (which should make that more obvious). I&apos;m hoping a small follow up I&apos;ve yet to publish will also simplify that particular bit further. I&apos;m more than happy to flesh out comments, but would appreciate an outline of which bits you think have been lacking historically.&lt;/p&gt;</comment>
                            <comment id="14309166" author="krummas" created="Fri, 6 Feb 2015 14:13:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;It would be helpful if, once I&apos;ve introdiced a high-level overview, the individuals familiar with the tool or special compaction lifecycles (or others) could amend the SSTableReader description&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Absolutely, for now I think that a concrete explanation of what happens to an sstable that is early opened and one that is cloneWithNewStart(..):ed is enough&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Could you list the places you think need this service? Since the code outside of SSTableReader tidying is largely functionally unchanged&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is mostly to avoid future confusion, and I figured now was a good time to clear up the confusing bits since we are touching those code parts (when would we do that otherwise?). I know most of the code was just moved around from other places and it was terrible before this, but that doesn&apos;t really stop us from making it easier for the future.&lt;/p&gt;

&lt;p&gt;I just want a small &apos;why&apos; instead of a comment stating the obvious:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// we don&apos;t want to alert deletions &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// get a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; reference to the shared descriptor-type tidy&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Those are just two examples, once the life cycle description is done, I can add the comments about the details I found confusing&lt;/p&gt;</comment>
                            <comment id="14309214" author="benedict" created="Fri, 6 Feb 2015 14:27:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;I just want a small &apos;why&apos; instead of a comment stating the obvious:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m honestly not meaning to be obtuse here, I&apos;m just looking for help. For some of this code I struggle(d) to see how I could make it clearer, so just dropped in a few comments willynilly. In your latter example, I do my best to explain the why at the top of each of the Tidy classes, and especially the InstanceTidier, that outlines the hierarchy. Here I was just duplicating some information so that the concept that was being related to was directly mentioned. This is why I ask for guidance, because whilst it may &lt;em&gt;now&lt;/em&gt; be clear to you it wasn&apos;t before, but conversely it is not at all clear to me what &lt;em&gt;isn&apos;t/wasn&apos;t&lt;/em&gt; clear, and I really need some help knowing where to fill in. The why comments seem to already be there for me in that second example, excepting the class-level outline of the lifecycle.&lt;/p&gt;</comment>
                            <comment id="14309217" author="krummas" created="Fri, 6 Feb 2015 14:31:10 +0000"  >&lt;p&gt;As I said, I&apos;ll walk over the code properly and explain the parts I struggled with.&lt;/p&gt;

&lt;p&gt;I think the problem is that once you spend the time to understand it, it is obvious&lt;/p&gt;</comment>
                            <comment id="14309226" author="benedict" created="Fri, 6 Feb 2015 14:38:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;As I said, I&apos;ll walk over the code properly and explain the parts I struggled with.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks. I do want the code to be clear, and would also like to contribute to that where I am able, so if there are specific things you think I can elaborate on better, please do point me to them and leave it to me. &lt;/p&gt;

&lt;p&gt;Like you say, the code is made up of a lot of individually obvious things, that aren&apos;t obvious as a whole, and I&apos;ve been lost in the weeds long enough to not be able to tell the difference between the two.&lt;/p&gt;</comment>
                            <comment id="14312612" author="benedict" created="Mon, 9 Feb 2015 18:48:32 +0000"  >&lt;p&gt;I&apos;ve pushed an update with a single mega comment at the head of sstablereader. I&apos;m still not 100% sure I&apos;ve either nailed all of the stuff that should be covered, or that it&apos;s clear, so please do criticise and point out places it could be improved. Obviously it will also get tweaks in all of the upcoming patches that modify its behaviour.&lt;/p&gt;

&lt;p&gt;I took the liberty of backporting the new OpenReason MOVED_START since it helps with the docs as well.&lt;/p&gt;</comment>
                            <comment id="14313868" author="krummas" created="Tue, 10 Feb 2015 09:15:17 +0000"  >&lt;p&gt;ok, lgtm, +1&lt;/p&gt;

&lt;p&gt;pushed 3 small comments to &lt;a href=&quot;https://github.com/krummas/cassandra/commits/bes/8707-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/bes/8707-2&lt;/a&gt; (with a rebase)&lt;/p&gt;

&lt;p&gt;I&apos;ll fill out the details about compaction in the comment in SSTableReader in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8764&quot; title=&quot;Refactor the way we notify compaction strategies about early opened files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8764&quot;&gt;&lt;del&gt;CASSANDRA-8764&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14313887" author="benedict" created="Tue, 10 Feb 2015 09:27:57 +0000"  >&lt;p&gt;Thanks. I&apos;ll commit once 2.1.3 is out. I&apos;ve actually pushed a really tiny update to your version &lt;a href=&quot;https://github.com/belliottsmith/cassandra/commits/bes/8707-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; that makes SharedCloseableImpl.close() idempotent; this isn&apos;t important here, but will be useful later, and is encouraged by the API in AutoCloseable.&lt;/p&gt;</comment>
                            <comment id="14315199" author="benedict" created="Tue, 10 Feb 2015 23:47:05 +0000"  >&lt;p&gt;Pushed a small fix (and unit test) that explains the behaviour encountered by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudrealt&quot; class=&quot;user-hover&quot; rel=&quot;aboudrealt&quot;&gt;aboudrealt&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8683&quot; title=&quot;Ensure early reopening has no overlap with replaced files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8683&quot;&gt;&lt;del&gt;CASSANDRA-8683&lt;/del&gt;&lt;/a&gt;, which I will rebase off this&lt;/p&gt;</comment>
                            <comment id="14316158" author="benedict" created="Wed, 11 Feb 2015 12:54:28 +0000"  >&lt;p&gt;Updated &lt;a href=&quot;https://github.com/belliottsmith/cassandra/commits/bes/8707-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; branch to include all of the follow up nits. If I could get a final +1 on these nits, i&apos;ll merge.&lt;/p&gt;</comment>
                            <comment id="14316351" author="benedict" created="Wed, 11 Feb 2015 15:24:34 +0000"  >&lt;p&gt;Committed, without the final addendum as that appears to not really be related to this ticket&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12762431">CASSANDRA-8508</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i250fr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>