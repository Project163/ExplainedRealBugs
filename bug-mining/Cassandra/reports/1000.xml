<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2870] dynamic snitch + read repair off can cause LOCAL_QUORUM reads to return spurious UnavailableException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2870</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When Read Repair is off, we want to avoid doing requests to more nodes than necessary to satisfy the ConsistencyLevel.  ReadCallback does this here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.endpoints = repair || resolver &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RowRepairResolver
                       ? endpoints
                       : endpoints.subList(0, &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(endpoints.size(), blockfor)); &lt;span class=&quot;code-comment&quot;&gt;// min so as to not &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; exception until assureSufficient is called&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see that it is assuming that the &quot;endpoints&quot; list is sorted in order of preferred-ness for the read.&lt;/p&gt;

&lt;p&gt;Then the LOCAL_QUORUM code in DatacenterReadCallback checks to see if we have enough nodes to do the read:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; localEndpoints = 0;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InetAddress endpoint : endpoints)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (localdc.equals(snitch.getDatacenter(endpoint)))
                localEndpoints++;
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (localEndpoints &amp;lt; blockfor)
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnavailableException();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So if repair is off (so we truncate our endpoints list) AND dynamic snitch has decided that nodes in another DC are to be preferred over local ones, we&apos;ll throw UE even if all the replicas are healthy.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12513176">CASSANDRA-2870</key>
            <summary>dynamic snitch + read repair off can cause LOCAL_QUORUM reads to return spurious UnavailableException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jul 2011 19:22:10 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:56 +0000</updated>
                            <resolved>Fri, 8 Jul 2011 16:38:02 +0000</resolved>
                                        <fixVersion>0.7.8</fixVersion>
                    <fixVersion>0.8.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13061527" author="jbellis" created="Thu, 7 Jul 2011 19:34:34 +0000"  >&lt;p&gt;patch extracts the &quot;give me the minimum set of endpoints necessary&quot; code into preferredEndpoints(), and makes it DC-aware for LOCAL_QUORUM reads.&lt;/p&gt;</comment>
                            <comment id="13061846" author="slebresne" created="Fri, 8 Jul 2011 08:40:03 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13062048" author="jbellis" created="Fri, 8 Jul 2011 16:38:02 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13062053" author="hudson" created="Fri, 8 Jul 2011 16:52:27 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #526 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.7/526/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.7/526/&lt;/a&gt;)&lt;br/&gt;
    fix possibility of spuriousUnavailableException for LOCAL_QUORUM reads with dynamic snitch and read repair disabled&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2870&quot; title=&quot;dynamic snitch + read repair off can cause LOCAL_QUORUM reads to return spurious UnavailableException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2870&quot;&gt;&lt;del&gt;CASSANDRA-2870&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1144380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1144380&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/service/ReadCallback.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/service/DatacenterReadCallback.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13062256" author="jeromatron" created="Fri, 8 Jul 2011 23:51:44 +0000"  >&lt;p&gt;This also appears to affect 0.7.6 and when read repair is not off.  I didn&apos;t set read repair on my CFs (defaults to 100%) and tried a simple rowcount pig script using read consistency LOCAL_QUORUM and it fails with UE.  I would think if that&apos;s the case, the priority should be higher and it should go in 0.7.7.  Any thoughts?&lt;/p&gt;</comment>
                            <comment id="13062308" author="jbellis" created="Sat, 9 Jul 2011 03:51:26 +0000"  >&lt;p&gt;This has been present since LOCAL_QUORUM was introduced, so it&apos;s not a new regression.  And a reasonable workaround exists (disable dynamic snitch).  So no, I don&apos;t think we should hold up 0.7.7 for this.&lt;/p&gt;</comment>
                            <comment id="13062324" author="jeromatron" created="Sat, 9 Jul 2011 05:38:42 +0000"  >&lt;p&gt;Okay - it just seemed like a higher priority issue with the scope expanded.  We&apos;ll probably just disable dynamic snitch until the fix is in a release then.&lt;/p&gt;</comment>
                            <comment id="13064609" author="patrickubs" created="Wed, 13 Jul 2011 14:40:46 +0000"  >&lt;p&gt;In the default configuration of 0.7.6-2 (and other versions) LOCAL_QUORUM reads dont work. This is not a minor bug and should be fixed in the next release.&lt;br/&gt;
By default configuration I mean the tar ball that is distributed by the cassandra website.&lt;br/&gt;
The fact that it is not a regression just shows that this functionality was never properly tested.&lt;/p&gt;</comment>
                            <comment id="13064621" author="jbellis" created="Wed, 13 Jul 2011 14:59:02 +0000"  >&lt;p&gt;It will be fixed in 0.7.8; 0.7.7 entered the release process before this was reported.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12485644" name="2870.txt" size="2931" author="jbellis" created="Thu, 7 Jul 2011 19:34:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20874</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gdyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93691</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>