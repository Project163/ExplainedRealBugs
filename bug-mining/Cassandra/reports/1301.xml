<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:27:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3530] Header class not thread safe, but mutated by multiple threads</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3530</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;With Cassandra 1.0.3 we are getting exceptions like,&lt;/p&gt;

&lt;p&gt;Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;WRITE-/xx.xx.xx.xx,5,main&amp;#93;&lt;/span&gt;java.util.ConcurrentModificationException        &lt;br/&gt;
        at java.util.Hashtable$Enumerator.next(Unknown Source)&lt;br/&gt;
        at org.apache.cassandra.net.Header.serializedSize(Header.java:97)        &lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.messageLength(OutboundTcpConnection.java:164)&lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.write(OutboundTcpConnection.java:154)        &lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:115)        &lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:94)&lt;/p&gt;

&lt;p&gt;and,&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;WRITE-/xx.xx.xx.xx&amp;#93;&lt;/span&gt; 2011-11-24 22:08:28,981 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;WRITE-/10.30.12.79,5,main&amp;#93;&lt;/span&gt;java.lang.NullPointerException        &lt;br/&gt;
        at org.apache.cassandra.net.Header.serializedSize(Header.java:101)&lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.messageLength(OutboundTcpConnection.java:164)&lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.write(OutboundTcpConnection.java:154)&lt;br/&gt;
        at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:115)        &lt;br/&gt;
	at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:94)&lt;/p&gt;

&lt;p&gt;It looks like Header is not thread safe, but the same header instance is modified concurrently while being sent to several threads in StorageProxy.sendMessages. &lt;/p&gt;

&lt;p&gt;This bug eventually causes the node to OOM, as it kills the OutboundTcpConnection thread, which means nothing is dequeing from queue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12532664">CASSANDRA-3530</key>
            <summary>Header class not thread safe, but mutated by multiple threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="sgbridges">Sean Bridges</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Nov 2011 00:11:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:45 +0000</updated>
                            <resolved>Fri, 25 Nov 2011 09:55:42 +0000</resolved>
                                        <fixVersion>1.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13156943" author="sgbridges" created="Fri, 25 Nov 2011 00:15:17 +0000"  >&lt;p&gt;Patch makes Header nearly immutable.  setDetails and removeDetails now return a copy of the Header with the modifications, rather than modifying the original.&lt;/p&gt;</comment>
                            <comment id="13156972" author="jbellis" created="Fri, 25 Nov 2011 03:38:20 +0000"  >&lt;p&gt;Are you running in a multi-DC environment?&lt;/p&gt;</comment>
                            <comment id="13156973" author="jbellis" created="Fri, 25 Nov 2011 03:39:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Patch makes Header nearly immutable&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What are the changes in OutboundTcpConnection trying to do?&lt;/p&gt;</comment>
                            <comment id="13156980" author="sbridges" created="Fri, 25 Nov 2011 04:22:51 +0000"  >&lt;p&gt;We are running in a multi dc environment.&lt;/p&gt;

&lt;p&gt;The changes in OutboundTcpConnection prevent the thread from dieing in case of a RuntimeException.  When the thread dies the node eventually runs out of memory as the queue never gets emptied.&lt;/p&gt;</comment>
                            <comment id="13157011" author="jbellis" created="Fri, 25 Nov 2011 07:43:07 +0000"  >&lt;p&gt;v2 attached (against 1.0 branch):&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;simplifies OTC change to just catch Exception in existing try/catch in writeConnected&lt;/li&gt;
	&lt;li&gt;some style updates to Header/Message changes, but functionality is unchanged&lt;/li&gt;
	&lt;li&gt;updated StorageProxy to only need one header copy instead of the horribly inefficient process used previously&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13157013" author="jbellis" created="Fri, 25 Nov 2011 07:49:29 +0000"  >&lt;p&gt;This affects 0.8 as well (and would have affected 0.7 if not for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3472&quot; title=&quot;Actually uses efficient cross DC writes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3472&quot;&gt;&lt;del&gt;CASSANDRA-3472&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13157016" author="jbellis" created="Fri, 25 Nov 2011 07:58:25 +0000"  >&lt;p&gt;version of v2 for 0.8.  Omitted the OTC change since in 0.8 it&apos;s just shoving a bytebuffer over the wire, there&apos;s not really any non-IOExceptions to worry about.&lt;/p&gt;</comment>
                            <comment id="13157073" author="hudson" created="Fri, 25 Nov 2011 10:17:43 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #404 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/404/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/404/&lt;/a&gt;)&lt;br/&gt;
    avoid race in OutboundTcpConnection in multi-DC setups&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3530&quot; title=&quot;Header class not thread safe, but mutated by multiple threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3530&quot;&gt;&lt;del&gt;CASSANDRA-3530&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1206098&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1206098&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/RowMutationVerbHandler.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/net/Header.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/net/Message.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageProxy.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13157176" author="jbellis" created="Fri, 25 Nov 2011 14:44:24 +0000"  >&lt;p&gt;Looking at this in the morning, I think I was wrong about it affecting 0.8, since all the Message wrangling (including the Message -&amp;gt; byte[] conversion in sendOneWay) happens on the StorageProxy thread.  I think we should revert from 0.8.8.&lt;/p&gt;</comment>
                            <comment id="13157196" author="slebresne" created="Fri, 25 Nov 2011 15:33:45 +0000"  >&lt;p&gt;There is no StorageProxy thread per-se, is there? Why wouldn&apos;t 0.8 be subject to the same concurrency bug as reported on that issue?&lt;/p&gt;</comment>
                            <comment id="13157199" author="jbellis" created="Fri, 25 Nov 2011 15:43:05 +0000"  >&lt;p&gt;Because in 0.8 there is only one thread touching any given Message in StorageProxy + MessagingService.  Once OTC gets it, MS has already turned it into a byte[] (which OTC then copies to its Socket buffer).&lt;/p&gt;

&lt;p&gt;To avoid the unnecessary intermediate byte[], for 1.0 we switch to OTC getting the Message objects.  So in the multi-DC case you can have a 2nd thread (the OTC one) sending a Message, while the SP thread updates its Header.&lt;/p&gt;</comment>
                            <comment id="13157202" author="slebresne" created="Fri, 25 Nov 2011 15:48:48 +0000"  >&lt;p&gt;Ok. I&apos;m fine reverting this then, though I would also be fine keeping it in. I prefer the new copying methods, and it does improve the code a bit in StorageProxy, and I don&apos;t see many chance for this to introduce new bugs (but obviously there is always one).&lt;/p&gt;</comment>
                            <comment id="13157208" author="jbellis" created="Fri, 25 Nov 2011 15:53:13 +0000"  >&lt;p&gt;I&apos;m going to revert then; if I hadn&apos;t incorrectly thought this bug affected 0.8, it would be clear we shouldn&apos;t backport it just to clean things up a bit.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12505074" name="3530-0.8.txt" size="7946" author="jbellis" created="Fri, 25 Nov 2011 07:58:25 +0000"/>
                            <attachment id="12505073" name="3530-v2.txt" size="7940" author="jbellis" created="Fri, 25 Nov 2011 07:43:06 +0000"/>
                            <attachment id="12505045" name="CASSANDRA-3530.patch" size="8402" author="sgbridges" created="Fri, 25 Nov 2011 00:15:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>218397</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gl1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94839</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>