<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6598] upgradesstables does not upgrade indexes causing startup error.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6598</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Upgrading a cluster from 1.1.12 -&amp;gt; 1.2.13 -&amp;gt; 2.0 HEAD fails due to upgradesstables not upgrading the index files.&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# Make sure ccm has all the versions we need:
ccm create -v git:cassandra-2.0 test
ccm remove 
ccm create -v git:cassandra-1.2.13 test
ccm remove

# Create a 1.1.12 cluster:
ccm create -v git:cassandra-1.1.12 test
# Set cluster partitioner:
perl -p -i -e &lt;span class=&quot;code-quote&quot;&gt;&apos;s/partitioner: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;/partitioner: RandomPartitioner/gi&apos;&lt;/span&gt; ~/.ccm/test/cluster.conf

ccm populate -n 1
ccm start
ccm node1 stress -- --operation=INSERT --family-type=Standard --num-keys=10000 --create-index=KEYS --compression=SnappyCompressor --compaction-strategy=LeveledCompactionStrategy
ccm flush

ccm node1 drain
ccm status
# Wait until node1 shows DOWN.

# Set cluster version:
perl -p -i -e &lt;span class=&quot;code-quote&quot;&gt;&apos;s/git_cassandra-1.1.12/git_cassandra-1.2.13/gi&apos;&lt;/span&gt; ~/.ccm/test/cluster.conf

# Upgrade node1:
ccm node1 updateconf
ccm node1 start

# Upgrade sstables:
~/.ccm/test/node1/bin/nodetool -p 7100 upgradesstables

ls ~/.ccm/test/node1/data/Keyspace1/Standard1/

# Note the versions on files. Data has been upgraded to version *ic* but indexes are left on version *hf*.


# Upgrade to 2.0:
ccm flush
ccm node1 drain
ccm status
# Wait until node1 shows DOWN.
# Set cluster version:
perl -p -i -e &lt;span class=&quot;code-quote&quot;&gt;&apos;s/git_cassandra-1.2.13/git_cassandra-2.0/gi&apos;&lt;/span&gt; ~/.ccm/test/cluster.conf
ccm node1 updateconf
ccm node1 start
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On this last upgrade attempt, cassandra 2.0 complains that the version for the indexes is incorrect:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: Can&apos;t open incompatible SSTable! Current version jb, found file: /home/ryan/.ccm/test/node1/data/Keyspace1/Standard1/Keyspace1-Standard1.Idx1-hf-1
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:411)
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:393)
        at org.apache.cassandra.db.index.AbstractSimplePerColumnSecondaryIndex.init(AbstractSimplePerColumnSecondaryIndex.java:52)
        at org.apache.cassandra.db.index.SecondaryIndexManager.addIndexedColumn(SecondaryIndexManager.java:274)
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:279)
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:416)
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:388)
        at org.apache.cassandra.db.Keyspace.initCf(Keyspace.java:309)
        at org.apache.cassandra.db.Keyspace.&amp;lt;init&amp;gt;(Keyspace.java:266)
        at org.apache.cassandra.db.Keyspace.open(Keyspace.java:110)
        at org.apache.cassandra.db.Keyspace.open(Keyspace.java:88)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:273)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:462)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:549)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The same test can be done starting from 1.2 upgrading to 2.0. The index files do not upgrade in this scenario either, however, there is not the same error, possibly because 2.0 is tolerant of version 1.2 indexes?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12689306">CASSANDRA-6598</key>
            <summary>upgradesstables does not upgrade indexes causing startup error.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="enigmacurry">Ryan McGuire</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Jan 2014 18:16:20 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:55 +0000</updated>
                            <resolved>Fri, 17 Jan 2014 00:35:27 +0000</resolved>
                                        <fixVersion>1.2.14</fixVersion>
                    <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13873738" author="brandon.williams" created="Thu, 16 Jan 2014 18:46:01 +0000"  >&lt;p&gt;Even &apos;upgradesstables -a&apos; doesn&apos;t upgrade the index.  Strangely, when following these steps (albeit not in ccm) I get a different error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO 18:43:59,336 Opening /var/lib/cassandra/data/system/local/system-local-ic-6 (497 bytes)
ERROR 18:43:59,678 Exception encountered during startup
java.lang.NullPointerException
        at org.apache.cassandra.utils.ByteBufferUtil.string(ByteBufferUtil.java:167)
        at org.apache.cassandra.serializers.AbstractTextSerializer.deserialize(AbstractTextSerializer.java:39)
        at org.apache.cassandra.serializers.AbstractTextSerializer.deserialize(AbstractTextSerializer.java:26)
        at org.apache.cassandra.db.marshal.AbstractType.compose(AbstractType.java:142)
        at org.apache.cassandra.cql3.UntypedResultSet$Row.getString(UntypedResultSet.java:97)
        at org.apache.cassandra.config.CFMetaData.fromSchemaNoColumnsNoTriggers(CFMetaData.java:1640)
        at org.apache.cassandra.config.CFMetaData.fromSchema(CFMetaData.java:1683)
        at org.apache.cassandra.config.KSMetaData.deserializeColumnFamilies(KSMetaData.java:307)
        at org.apache.cassandra.config.KSMetaData.fromSchema(KSMetaData.java:288)
        at org.apache.cassandra.db.DefsTables.loadFromKeyspace(DefsTables.java:130)
        at org.apache.cassandra.config.DatabaseDescriptor.loadSchemas(DatabaseDescriptor.java:525)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:242)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:462)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:549)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13873840" author="brandon.williams" created="Thu, 16 Jan 2014 19:52:12 +0000"  >&lt;p&gt;The problem is that if you don&apos;t specify the ks/cf, seconday indexes aren&apos;t added in getValidColumnFamilies.  Patch against 1.2 to solve this.  This being the case, you can workaround this problem by specifying the ks/cf explicitly.&lt;/p&gt;

&lt;p&gt;For 2.0, it seems like we should actually be able to open this file, and just warn that upgradesstables needs to be run on it.&lt;/p&gt;</comment>
                            <comment id="13873895" author="brandon.williams" created="Thu, 16 Jan 2014 20:32:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;For 2.0, it seems like we should actually be able to open this file, and just warn that upgradesstables needs to be run on it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, unfortunately it&apos;s not that simple since 2.0 doesn&apos;t know how to open hf files.  Patch to fix the NPE though.&lt;/p&gt;</comment>
                            <comment id="13873897" author="enigmacurry" created="Thu, 16 Jan 2014 20:34:31 +0000"  >&lt;p&gt;The patch for 1.2 is tested, lgtm.&lt;/p&gt;</comment>
                            <comment id="13873915" author="enigmacurry" created="Thu, 16 Jan 2014 20:51:03 +0000"  >&lt;p&gt;The 2.0 patch works, no errors, upgraded to 2.1.&lt;/p&gt;

&lt;p&gt;I confirm that the upgrade of indexes past 1.2 is still failing, but there are no errors, and it appears that 2.0 and 2.1 have no problems loading and dealing with version &lt;b&gt;ic&lt;/b&gt; (1.2) indexes.&lt;/p&gt;</comment>
                            <comment id="13873918" author="jbellis" created="Thu, 16 Jan 2014 20:53:38 +0000"  >&lt;p&gt;+1 on 6598.txt (space after &lt;tt&gt;for&lt;/tt&gt; though)&lt;/p&gt;

&lt;p&gt;Not sure on the npe patch, are those really optional?  /cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13873919" author="brandon.williams" created="Thu, 16 Jan 2014 20:54:01 +0000"  >&lt;p&gt;Once 1.2 is full upgraded you&apos;re safe, because 2.0 has code to read ic sstables, but not hf.  So if you start from 1.1 and go to 1.2 (without the patch) and then 2.0, you&apos;re kind of stuck, because 2.0 can&apos;t read hf and now your system tables are jb, which 1.2 can&apos;t read, so going backward and trying again isn&apos;t an option.  I think the simplest thing to do here is cover this in NEWS.TXT.&lt;/p&gt;</comment>
                            <comment id="13873926" author="enigmacurry" created="Thu, 16 Jan 2014 20:58:56 +0000"  >&lt;p&gt;Would there be any reason to prefer jb or ka indexes over ic, though? If upgradesstables doesn&apos;t do it, then is the proposed solution to drop and recreate indexes?&lt;/p&gt;</comment>
                            <comment id="13873929" author="brandon.williams" created="Thu, 16 Jan 2014 21:01:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Would there be any reason to prefer jb or ka indexes over ic, though?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not really.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If upgradesstables doesn&apos;t do it, then is the proposed solution to drop and recreate indexes?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s probably the simplest, if not cheapest, option.&lt;/p&gt;</comment>
                            <comment id="13873947" author="brandon.williams" created="Thu, 16 Jan 2014 21:12:27 +0000"  >&lt;p&gt;Committed first patch.&lt;/p&gt;</comment>
                            <comment id="13874083" author="brandon.williams" created="Thu, 16 Jan 2014 22:43:03 +0000"  >&lt;p&gt;Proposed NEWS.TXT changes.&lt;/p&gt;</comment>
                            <comment id="13874089" author="jbellis" created="Thu, 16 Jan 2014 22:45:44 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13874118" author="brandon.williams" created="Thu, 16 Jan 2014 23:07:42 +0000"  >&lt;p&gt;Committed NEWS changes.  We&apos;ll wait and see what Aleksey says about the NPE, but I&apos;m pretty sure it&apos;s because that CF never touched CQL at any point in its life.&lt;/p&gt;</comment>
                            <comment id="13874181" author="iamaleksey" created="Fri, 17 Jan 2014 00:03:20 +0000"  >&lt;p&gt;+1, it&apos;s at least harmless, but (I think) shouldn&apos;t be happening post &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5800&quot; title=&quot;Support pre-1.2 release CQL3 tables in CqlPagingRecordReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5800&quot;&gt;&lt;del&gt;CASSANDRA-5800&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13874216" author="brandon.williams" created="Fri, 17 Jan 2014 00:35:27 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12623465" name="6598-2.0-npe.txt" size="1518" author="brandon.williams" created="Thu, 16 Jan 2014 20:32:33 +0000"/>
                            <attachment id="12623452" name="6598.txt" size="1617" author="brandon.williams" created="Thu, 16 Jan 2014 19:52:12 +0000"/>
                            <attachment id="12623508" name="news-2.0.txt" size="863" author="brandon.williams" created="Thu, 16 Jan 2014 22:43:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368273</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rh5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368578</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325761">2.0.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>