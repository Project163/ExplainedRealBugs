<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7000] Assertion in SSTableReader during repair.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7000</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I ran a &lt;tt&gt;git bisect run&lt;/tt&gt; using the attached bisect script. Repro code:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# 5dfe241: trunk as of my git bisect run
# 345772d: empirically determined &quot;good&quot; commit.
git bisect start 5dfe241 345772d
git bisect run ./sstablereader-assertion-bisect-helper-v2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first failing commit is 5ebadc1 (first parent of &lt;tt&gt;refs/bisect/bad&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;Prior to 5ebadc1, SSTableReader#close() never checked reference count. After 5ebadc1, there was an assertion for &lt;tt&gt;references.get() == 0&lt;/tt&gt;. However, since the reference count is initialized to 1, a SSTableReader#close() was always guaranteed to either throw an AssertionError or to be a second call to SSTableReader#tidy() on the same SSTableReader.&lt;/p&gt;

&lt;p&gt;The attached patch chooses an in-between behavior. It requires the reference count to match the initialization value of 1 for SSTableReader#close(), and the same behavior as 5ebadc1 otherwise.&lt;/p&gt;

&lt;p&gt;This allows repair to finish successfully, but I&apos;m not 100% certain what the desired behavior is for SSTableReader#close(). Should it close without regard to reference count, as it did pre-5ebadc1?&lt;/p&gt;

&lt;p&gt;Edit: accidentally uploaded a flawed version of &lt;tt&gt;sstablereader-assertion-bisect-helper&lt;/tt&gt; (doesn&apos;t work out-of-the-box with &lt;tt&gt;git bisect&lt;/tt&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12707210">CASSANDRA-7000</key>
            <summary>Assertion in SSTableReader during repair.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="usrbincc">Ben Chan</assignee>
                                    <reporter username="usrbincc">Ben Chan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Apr 2014 17:00:09 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:49 +0000</updated>
                            <resolved>Fri, 11 Apr 2014 16:35:15 +0000</resolved>
                                                            <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13963302" author="jbellis" created="Tue, 8 Apr 2014 18:53:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; to review.&lt;/p&gt;

&lt;p&gt;is this against 2.0 or 2.1?&lt;/p&gt;</comment>
                            <comment id="13963638" author="usrbincc" created="Tue, 8 Apr 2014 23:51:26 +0000"  >&lt;p&gt;It was against 5ebadc1, but applies cleanly against the current trunk (ccef061 as of this moment). I&apos;m getting a problem with ccef061 with a failure at &lt;tt&gt;ccm start&lt;/tt&gt;, but here is an (admittedly simple) before/after test for e1e91be:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;W=https://issues.apache.org/jira/secure/attachment
for url in \
  $W/12639219/sstablereader-assertion.patch \
  $W/12639294/sstablereader-assertion-bisect-helper-v2
do [ -e $(basename $url) ] || curl -sO $url; done &amp;amp;&amp;amp;
chmod +x sstablereader-assertion-bisect-helper-v2

git checkout e1e91be

# sanity check downloaded scripts as always
./sstablereader-assertion-bisect-helper-v2 &amp;amp;&amp;amp; echo ok

# should fail &quot;before&quot; and work &quot;after&quot;
git apply sstablereader-assertion.patch &amp;amp;&amp;amp;
./sstablereader-assertion-bisect-helper-v2 &amp;amp;&amp;amp; echo ok
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(You can ignore all the errors due to patches that don&apos;t apply; I needed to fix a build problem in order to successfully run the bisect.)&lt;/p&gt;</comment>
                            <comment id="13964853" author="yukim" created="Thu, 10 Apr 2014 00:41:44 +0000"  >&lt;p&gt;Ping, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Snapshot repair opens snapshotted SSTables, creates MT against them, and close them when it&apos;s done.&lt;br/&gt;
While doing so, validation compaction does not acquire reference since SSTables are from snapshot.&lt;/p&gt;

&lt;p&gt;Now, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6912&quot; title=&quot;SSTableReader.isReplaced does not allow for safe resource cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6912&quot;&gt;&lt;del&gt;CASSANDRA-6912&lt;/del&gt;&lt;/a&gt; introduced tidy method which is called both from close and releaseReference assumes reference is 0, thus causing AE when doing repair(and breaking repair dtest. see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7005&quot; title=&quot;repair_test dtest fails on 2.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7005&quot;&gt;&lt;del&gt;CASSANDRA-7005&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Patch works for repair scenario, but foundamentally I&apos;m not sure this is the way to go. Shouldn&apos;t SSTableReader be closable regardless of reference acuired?&lt;/p&gt;</comment>
                            <comment id="13965530" author="thobbs" created="Thu, 10 Apr 2014 16:49:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;While doing so, validation compaction does not acquire reference since SSTables are from snapshot.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Opening the SSTableReader implicitly involves acquiring a reference (they always start with a reference count of 1)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t SSTableReader be closable regardless of reference acuired?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think so, but perhaps I&apos;m missing a case where it would make sense to close an SSTable with a non-zero reference count.  I believe the correct patch would be to release the reference on the SSTableReaders after the validation compaction has completed instead of directly calling close().&lt;/p&gt;</comment>
                            <comment id="13965728" author="yukim" created="Thu, 10 Apr 2014 19:11:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; I think you are right. Attached v2 to fix validation compaction to release reference on snapshot repair.&lt;/p&gt;

&lt;p&gt;I also added message to AssertinoError on SSTR#tidy, but explicitly throwing exception(IllegalStateException for example) may be nicer.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=usrbincc&quot; class=&quot;user-hover&quot; rel=&quot;usrbincc&quot;&gt;usrbincc&lt;/a&gt; Can you test if this fixes your test?&lt;/p&gt;</comment>
                            <comment id="13965794" author="thobbs" created="Thu, 10 Apr 2014 20:14:26 +0000"  >&lt;p&gt;+1 on the patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;explicitly throwing exception(IllegalStateException for example) may be nicer&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds reasonable to me.&lt;/p&gt;</comment>
                            <comment id="13965809" author="benedict" created="Thu, 10 Apr 2014 20:36:30 +0000"  >&lt;p&gt;Not sure if we want to tack this onto the same ticket, but the same basic problem seems to occur elsewhere as well: some referrers of sstablereader do not acquire a reference prior to accessing resources that will be closed when ref count hits zero. I found specifically CFS.estimatedKeysForRange, CFS.keySamples, couldn&apos;t see any others.&lt;/p&gt;

&lt;p&gt;This latter is the cause of the currently failing unit test for 2.1&lt;/p&gt;</comment>
                            <comment id="13966551" author="usrbincc" created="Fri, 11 Apr 2014 14:20:44 +0000"  >&lt;p&gt;Just to confirm, repair works fine with&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# current trunk
git checkout 471f5cc34c99
git apply 7000-2.1-v2.txt 7000.supplement.txt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think SSTableReader#close as it currently stands still doesn&apos;t quite make sense. But since it isn&apos;t actually used anywhere (post-patch), it may be easier to just slap a TODO on it.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// Or how about this? Works if the last reference was released, and fails in
// tidy() otherwise.
public void close()
{
    references.decrementAndGet();
    tidy(false);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13966679" author="yukim" created="Fri, 11 Apr 2014 16:03:43 +0000"  >&lt;p&gt;I committed v2 and supplement to 2.1 and trunk with AE in tidy changed to IllegalStateException.&lt;/p&gt;

&lt;p&gt;I think we can completely drop &apos;implements Closable&apos;/close method. It is no longer used, and if used by accident after release, it will likely to cause exception.&lt;br/&gt;
Thoughts?&lt;/p&gt;</comment>
                            <comment id="13966684" author="benedict" created="Fri, 11 Apr 2014 16:05:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we can completely drop &apos;implements Closable&apos;/close method. It is no longer used, and if used by accident after release, it will likely to cause exception.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If it&apos;s now unused, +100&lt;/p&gt;</comment>
                            <comment id="13966741" author="yukim" created="Fri, 11 Apr 2014 16:35:15 +0000"  >&lt;p&gt;OK, removed Closable and pushed.&lt;/p&gt;

&lt;p&gt;Closing this one. Thanks everyone!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12707236">CASSANDRA-7005</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12732298">CASSANDRA-7705</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12703162">CASSANDRA-6912</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12639633" name="7000-2.1-v2.txt" size="1986" author="yukim" created="Thu, 10 Apr 2014 19:11:06 +0000"/>
                            <attachment id="12639647" name="7000.supplement.txt" size="1934" author="benedict" created="Thu, 10 Apr 2014 20:36:30 +0000"/>
                            <attachment id="12639218" name="sstablereader-assertion-bisect-helper" size="1707" author="usrbincc" created="Tue, 8 Apr 2014 17:00:09 +0000"/>
                            <attachment id="12639294" name="sstablereader-assertion-bisect-helper-v2" size="1816" author="usrbincc" created="Tue, 8 Apr 2014 23:09:36 +0000"/>
                            <attachment id="12639219" name="sstablereader-assertion.patch" size="1537" author="usrbincc" created="Tue, 8 Apr 2014 17:00:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[usrbincc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385533</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uf0v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385800</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>