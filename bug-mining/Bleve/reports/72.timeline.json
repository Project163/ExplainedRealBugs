[{"id":290805462,"node_id":"MDEyOkxhYmVsZWRFdmVudDI5MDgwNTQ2Mg==","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/290805462","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2015-04-27T12:18:28Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/96628899","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-96628899","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":96628899,"node_id":"MDEyOklzc3VlQ29tbWVudDk2NjI4ODk5","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-04-27T12:19:49Z","updated_at":"2015-04-27T12:19:49Z","body":"This is definitely a bug, but I'd like to try and reproduce it (the line numbers in the trace don't seem to correspond with the code in your bleve-bench repo)\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/96628899/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/96695132","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-96695132","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":96695132,"node_id":"MDEyOklzc3VlQ29tbWVudDk2Njk1MTMy","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-04-27T15:09:59Z","updated_at":"2015-04-27T15:09:59Z","body":"I haven't been able to reproduce it yet, though I may ask @steveyen to help me review the relevant sections of code later today.\n\nCan you let me know which bleve commit you're on, and if possible provide the datasource file you used for testing?\n\nThanks\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/96695132/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":290979846,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjkwOTc5ODQ2","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/290979846","actor":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2015-04-27T15:09:59Z","performed_via_github_app":null},{"id":290979847,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI5MDk3OTg0Nw==","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/290979847","actor":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2015-04-27T15:09:59Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/96719663","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-96719663","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":96719663,"node_id":"MDEyOklzc3VlQ29tbWVudDk2NzE5NjYz","user":{"login":"otoolep","id":536312,"node_id":"MDQ6VXNlcjUzNjMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/536312?v=4","gravatar_id":"","url":"https://api.github.com/users/otoolep","html_url":"https://github.com/otoolep","followers_url":"https://api.github.com/users/otoolep/followers","following_url":"https://api.github.com/users/otoolep/following{/other_user}","gists_url":"https://api.github.com/users/otoolep/gists{/gist_id}","starred_url":"https://api.github.com/users/otoolep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/otoolep/subscriptions","organizations_url":"https://api.github.com/users/otoolep/orgs","repos_url":"https://api.github.com/users/otoolep/repos","events_url":"https://api.github.com/users/otoolep/events{/privacy}","received_events_url":"https://api.github.com/users/otoolep/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-04-27T15:49:52Z","updated_at":"2015-04-27T15:49:52Z","body":"Let me see if can reproduce it. I forced-pushed a couple of times last night, that's why the line numbers are off.\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/96719663/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"otoolep","id":536312,"node_id":"MDQ6VXNlcjUzNjMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/536312?v=4","gravatar_id":"","url":"https://api.github.com/users/otoolep","html_url":"https://github.com/otoolep","followers_url":"https://api.github.com/users/otoolep/followers","following_url":"https://api.github.com/users/otoolep/following{/other_user}","gists_url":"https://api.github.com/users/otoolep/gists{/gist_id}","starred_url":"https://api.github.com/users/otoolep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/otoolep/subscriptions","organizations_url":"https://api.github.com/users/otoolep/orgs","repos_url":"https://api.github.com/users/otoolep/repos","events_url":"https://api.github.com/users/otoolep/events{/privacy}","received_events_url":"https://api.github.com/users/otoolep/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/97888867","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-97888867","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":97888867,"node_id":"MDEyOklzc3VlQ29tbWVudDk3ODg4ODY3","user":{"login":"otoolep","id":536312,"node_id":"MDQ6VXNlcjUzNjMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/536312?v=4","gravatar_id":"","url":"https://api.github.com/users/otoolep","html_url":"https://github.com/otoolep","followers_url":"https://api.github.com/users/otoolep/followers","following_url":"https://api.github.com/users/otoolep/following{/other_user}","gists_url":"https://api.github.com/users/otoolep/gists{/gist_id}","starred_url":"https://api.github.com/users/otoolep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/otoolep/subscriptions","organizations_url":"https://api.github.com/users/otoolep/orgs","repos_url":"https://api.github.com/users/otoolep/repos","events_url":"https://api.github.com/users/otoolep/events{/privacy}","received_events_url":"https://api.github.com/users/otoolep/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-04-30T17:28:56Z","updated_at":"2015-04-30T17:28:56Z","body":"I tried a couple more times, but have not managed to reproduce this. Perhaps it was something about the earlier state of my code, but unfortunately I no longer have the code. :-(\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/97888867/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"otoolep","id":536312,"node_id":"MDQ6VXNlcjUzNjMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/536312?v=4","gravatar_id":"","url":"https://api.github.com/users/otoolep","html_url":"https://github.com/otoolep","followers_url":"https://api.github.com/users/otoolep/followers","following_url":"https://api.github.com/users/otoolep/following{/other_user}","gists_url":"https://api.github.com/users/otoolep/gists{/gist_id}","starred_url":"https://api.github.com/users/otoolep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/otoolep/subscriptions","organizations_url":"https://api.github.com/users/otoolep/orgs","repos_url":"https://api.github.com/users/otoolep/repos","events_url":"https://api.github.com/users/otoolep/events{/privacy}","received_events_url":"https://api.github.com/users/otoolep/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/97893746","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-97893746","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":97893746,"node_id":"MDEyOklzc3VlQ29tbWVudDk3ODkzNzQ2","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-04-30T17:42:11Z","updated_at":"2015-04-30T17:42:11Z","body":"@steveyen helped me review the code.  We did theorize one way it could happen.  If you were to add a document to a batch, after you already started executing the batch, there could be a data race between where we compute how many items we expect to read from a result channel, and how many items we actually push onto the work channel.\n\nObviously your code would not do this by design, but I can see how it could happen during development.\n\nThe next question is what should be done to prevent this.  Right now Batches are a use-once model, so calls to Index/Delete/SetInternal/DeleteInternal after executing the batch are not correct.  Unfortunately, not all these operations return an error today.  One option is to modify the signature to return an error.  Another option is to have the methods acquire a lock, in this case any calls to modify the batch during execution would block.  At first the second option appears like a hack to provide safety, while not letting the user know there is a problem... But, I'd like to consider a future where we can reuse the batches by calling a Reset() method, this could avoid some unnecessary allocations.\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/97893746/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":294300941,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50Mjk0MzAwOTQx","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/294300941","actor":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2015-04-30T17:42:11Z","performed_via_github_app":null},{"id":294300942,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI5NDMwMDk0Mg==","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/294300942","actor":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2015-04-30T17:42:11Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/97900683","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-97900683","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":97900683,"node_id":"MDEyOklzc3VlQ29tbWVudDk3OTAwNjgz","user":{"login":"otoolep","id":536312,"node_id":"MDQ6VXNlcjUzNjMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/536312?v=4","gravatar_id":"","url":"https://api.github.com/users/otoolep","html_url":"https://github.com/otoolep","followers_url":"https://api.github.com/users/otoolep/followers","following_url":"https://api.github.com/users/otoolep/following{/other_user}","gists_url":"https://api.github.com/users/otoolep/gists{/gist_id}","starred_url":"https://api.github.com/users/otoolep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/otoolep/subscriptions","organizations_url":"https://api.github.com/users/otoolep/orgs","repos_url":"https://api.github.com/users/otoolep/repos","events_url":"https://api.github.com/users/otoolep/events{/privacy}","received_events_url":"https://api.github.com/users/otoolep/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-04-30T18:07:43Z","updated_at":"2015-04-30T18:07:43Z","body":"Actually, this might make sense. When I first coded this I forgot to ask for a  new batch after I started executing the new batch. So I was re-using batch objects. This has been fixed now in my code.\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/97900683/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"otoolep","id":536312,"node_id":"MDQ6VXNlcjUzNjMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/536312?v=4","gravatar_id":"","url":"https://api.github.com/users/otoolep","html_url":"https://github.com/otoolep","followers_url":"https://api.github.com/users/otoolep/followers","following_url":"https://api.github.com/users/otoolep/following{/other_user}","gists_url":"https://api.github.com/users/otoolep/gists{/gist_id}","starred_url":"https://api.github.com/users/otoolep/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/otoolep/subscriptions","organizations_url":"https://api.github.com/users/otoolep/orgs","repos_url":"https://api.github.com/users/otoolep/repos","events_url":"https://api.github.com/users/otoolep/events{/privacy}","received_events_url":"https://api.github.com/users/otoolep/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/102065962","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-102065962","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":102065962,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMjA2NTk2Mg==","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-05-14T15:06:20Z","updated_at":"2015-05-14T15:06:20Z","body":"Confirmed I was able to cause the same crash in a test case.  Evaluating our options...\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/102065962/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":306136881,"node_id":"MDExOkNsb3NlZEV2ZW50MzA2MTM2ODgx","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/306136881","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"328bc73ed03709abf9eca1345ad760088995aa37","commit_url":"https://api.github.com/repos/blevesearch/bleve/commits/328bc73ed03709abf9eca1345ad760088995aa37","created_at":"2015-05-15T19:07:20Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/102496269","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-102496269","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":102496269,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMjQ5NjI2OQ==","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2015-05-15T19:10:33Z","updated_at":"2015-05-15T19:10:33Z","body":"To summarize what I put into the commit message.  The Batch object was never intended to be thread-safe and this particular panic was actually a manifestation of inadvertently mutating the batch by multiple go-routines at the same time.  To address this we have done 2 things:\n1.  Documentation more clearly states that Batch is not thread-safe.\n2.  The code can detect SOME cases when this is happening.  When it does, it avoids a preventable panic and instead returns an error upside_down.UnsafeBatchUseDetected.  Users should not rely on this detecting all cases, rather it is designed to be a more helpful way of detecting inadvertent usage than a panic.\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/102496269/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T02:09:39Z","updated_at":"2018-05-30T02:09:39Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/blevesearch/blevex/issues/41","repository_url":"https://api.github.com/repos/blevesearch/blevex","labels_url":"https://api.github.com/repos/blevesearch/blevex/issues/41/labels{/name}","comments_url":"https://api.github.com/repos/blevesearch/blevex/issues/41/comments","events_url":"https://api.github.com/repos/blevesearch/blevex/issues/41/events","html_url":"https://github.com/blevesearch/blevex/issues/41","id":327545156,"node_id":"MDU6SXNzdWUzMjc1NDUxNTY=","number":41,"title":"panic: send on closed channel using the IndexBatcher","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-05-30T01:55:56Z","updated_at":"2018-05-30T03:02:39Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":42612983,"node_id":"MDEwOlJlcG9zaXRvcnk0MjYxMjk4Mw==","name":"blevex","full_name":"blevesearch/blevex","private":false,"owner":{"login":"blevesearch","id":8562608,"node_id":"MDEyOk9yZ2FuaXphdGlvbjg1NjI2MDg=","avatar_url":"https://avatars.githubusercontent.com/u/8562608?v=4","gravatar_id":"","url":"https://api.github.com/users/blevesearch","html_url":"https://github.com/blevesearch","followers_url":"https://api.github.com/users/blevesearch/followers","following_url":"https://api.github.com/users/blevesearch/following{/other_user}","gists_url":"https://api.github.com/users/blevesearch/gists{/gist_id}","starred_url":"https://api.github.com/users/blevesearch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blevesearch/subscriptions","organizations_url":"https://api.github.com/users/blevesearch/orgs","repos_url":"https://api.github.com/users/blevesearch/repos","events_url":"https://api.github.com/users/blevesearch/events{/privacy}","received_events_url":"https://api.github.com/users/blevesearch/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/blevesearch/blevex","description":"Bleve Extensions","fork":false,"url":"https://api.github.com/repos/blevesearch/blevex","forks_url":"https://api.github.com/repos/blevesearch/blevex/forks","keys_url":"https://api.github.com/repos/blevesearch/blevex/keys{/key_id}","collaborators_url":"https://api.github.com/repos/blevesearch/blevex/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/blevesearch/blevex/teams","hooks_url":"https://api.github.com/repos/blevesearch/blevex/hooks","issue_events_url":"https://api.github.com/repos/blevesearch/blevex/issues/events{/number}","events_url":"https://api.github.com/repos/blevesearch/blevex/events","assignees_url":"https://api.github.com/repos/blevesearch/blevex/assignees{/user}","branches_url":"https://api.github.com/repos/blevesearch/blevex/branches{/branch}","tags_url":"https://api.github.com/repos/blevesearch/blevex/tags","blobs_url":"https://api.github.com/repos/blevesearch/blevex/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/blevesearch/blevex/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/blevesearch/blevex/git/refs{/sha}","trees_url":"https://api.github.com/repos/blevesearch/blevex/git/trees{/sha}","statuses_url":"https://api.github.com/repos/blevesearch/blevex/statuses/{sha}","languages_url":"https://api.github.com/repos/blevesearch/blevex/languages","stargazers_url":"https://api.github.com/repos/blevesearch/blevex/stargazers","contributors_url":"https://api.github.com/repos/blevesearch/blevex/contributors","subscribers_url":"https://api.github.com/repos/blevesearch/blevex/subscribers","subscription_url":"https://api.github.com/repos/blevesearch/blevex/subscription","commits_url":"https://api.github.com/repos/blevesearch/blevex/commits{/sha}","git_commits_url":"https://api.github.com/repos/blevesearch/blevex/git/commits{/sha}","comments_url":"https://api.github.com/repos/blevesearch/blevex/comments{/number}","issue_comment_url":"https://api.github.com/repos/blevesearch/blevex/issues/comments{/number}","contents_url":"https://api.github.com/repos/blevesearch/blevex/contents/{+path}","compare_url":"https://api.github.com/repos/blevesearch/blevex/compare/{base}...{head}","merges_url":"https://api.github.com/repos/blevesearch/blevex/merges","archive_url":"https://api.github.com/repos/blevesearch/blevex/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/blevesearch/blevex/downloads","issues_url":"https://api.github.com/repos/blevesearch/blevex/issues{/number}","pulls_url":"https://api.github.com/repos/blevesearch/blevex/pulls{/number}","milestones_url":"https://api.github.com/repos/blevesearch/blevex/milestones{/number}","notifications_url":"https://api.github.com/repos/blevesearch/blevex/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/blevesearch/blevex/labels{/name}","releases_url":"https://api.github.com/repos/blevesearch/blevex/releases{/id}","deployments_url":"https://api.github.com/repos/blevesearch/blevex/deployments","created_at":"2015-09-16T20:57:51Z","updated_at":"2025-10-04T17:36:40Z","pushed_at":"2024-03-23T06:37:04Z","git_url":"git://github.com/blevesearch/blevex.git","ssh_url":"git@github.com:blevesearch/blevex.git","clone_url":"https://github.com/blevesearch/blevex.git","svn_url":"https://github.com/blevesearch/blevex","homepage":null,"size":273,"stargazers_count":46,"watchers_count":46,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":23,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":15,"license":null,"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":23,"open_issues":15,"watchers":46,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"I'm trying to use the IndexBatcher in this repo and get a panic:\r\n\r\n```\r\npanic: send on closed channel\r\n\r\ngoroutine 20 [running]:\r\ngithub.com/blevesearch/bleve/index.AnalysisWorker(0xc4200961e0, 0xc420096240)\r\n\t/Users/prologic/go/src/github.com/blevesearch/bleve/index/analysis.go:107 +0x7b\r\ncreated by github.com/blevesearch/bleve/index.NewAnalysisQueue\r\n\t/Users/prologic/go/src/github.com/blevesearch/bleve/index/analysis.go:94 +0xcd\r\n```\r\n\r\nNot really sure what's triggering this yet... Filing here for visibility.","reactions":{"url":"https://api.github.com/repos/blevesearch/blevex/issues/41/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blevesearch/blevex/issues/41/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393008137","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393008137","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393008137,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzAwODEzNw==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T02:15:02Z","updated_at":"2018-05-30T02:15:02Z","body":"Is this the same as blevesearch/bleve#41 ?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393008137/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393009218","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393009218","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393009218,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzAwOTIxOA==","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T02:21:41Z","updated_at":"2018-05-30T02:21:41Z","body":"I just posted to the same effect on https://github.com/blevesearch/blevex/issues/41 â€“ The root cause of the panic is the same, but the reason we get into this state is likely different and unique to the automatic index batcher.  The pattern bleve uses is to figure out how many items are going to be analyzed, build a channel, pass it to the analysis queue, and read off EXACTLY the expected number of items.  We then close and move on.  However in this case, another analyzed document was written to the channel AFTER we already closed it.  As we observed in this issue, this can happen if you start to execute a batch, and the keep mutating the batch without waiting for the batch execution to finish.  I'm  not very familiar with the automatic index batcher, so I'm reviewing it now to see if I spot anything.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393009218/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393011858","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393011858","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393011858,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzAxMTg1OA==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T02:38:44Z","updated_at":"2018-05-30T02:38:44Z","body":"Yeah I'm going to have to modify this IndexBatcher a bit. I'm not too familiar with this pattern it implements however. Do you know why we do this whole song 'n dance of blocking the callers up to the period interval? Why not just fill a  buffer and write batches up to buffer_size? Or just fill a buffer and empty and batch the contents of the buffered operations very X interval?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393011858/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393011938","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393011938","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393011938,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzAxMTkzOA==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T02:39:20Z","updated_at":"2018-05-30T02:39:20Z","body":"Or in other words; its not **clear** to me why you'd want to block your callers at all? Certainly in my case I'd rather not to get a higher write throughput.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393011938/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393012706","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393012706","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393012706,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzAxMjcwNg==","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T02:44:20Z","updated_at":"2018-05-30T02:44:20Z","body":"At Couchbase we do something closer to what you've described.  We just build batches of the sizes we like, execute them and recycle them.  It's straightforward and works well for us.  The user who contributed this wanted to try and hide the batching entirely and just expose a simpler API that didn't do any explicit batching.  It sounds like you should just avoid using this automatic batcher.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393012706/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393021869","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393021869","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393021869,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzAyMTg2OQ==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-05-30T03:51:39Z","updated_at":"2018-05-30T03:51:39Z","body":"So... I'm able to repro this with this very simple naive batching indxer:\r\n\r\n```#!go\r\npackage je\r\n\r\nimport (\r\n\t\"sync\"\r\n\t\"time\"\r\n\r\n\tlog \"github.com/sirupsen/logrus\"\r\n\r\n\t\"github.com/blevesearch/bleve\"\r\n)\r\n\r\ntype bleveIndex bleve.Index\r\n\r\ntype IndexBatcher struct {\r\n\tsync.Mutex\r\n\tbleveIndex\r\n\r\n\tinterval time.Duration\r\n\tclose    chan bool\r\n\tbatch    *bleve.Batch\r\n}\r\n\r\nfunc NewIndexBatcher(index bleve.Index, interval time.Duration) bleve.Index {\r\n\tib := &IndexBatcher{\r\n\t\tbleveIndex: index,\r\n\r\n\t\tbatch:    index.NewBatch(),\r\n\t\tinterval: interval,\r\n\t\tclose:    make(chan bool),\r\n\t}\r\n\r\n\tgo ib.batchloop()\r\n\treturn ib\r\n}\r\n\r\nfunc (ib *IndexBatcher) batchloop() {\r\n\tt := time.NewTicker(ib.interval)\r\n\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase <-t.C:\r\n\t\t\tib.Lock()\r\n\t\t\terr := ib.Batch(ib.batch)\r\n\t\t\tif err != nil {\r\n\t\t\t\tlog.Errorf(\"error batching: %s\", err)\r\n\t\t\t}\r\n\t\t\tib.batch.Reset()\r\n\t\t\tib.Unlock()\r\n\t\tcase <-ib.close:\r\n\t\t\tbreak\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc (ib *IndexBatcher) Close() error {\r\n\tib.close <- true\r\n\treturn ib.bleveIndex.Close()\r\n}\r\n\r\nfunc (ib *IndexBatcher) Index(id string, data interface{}) error {\r\n\tib.Lock()\r\n\terr := ib.batch.Index(id, data)\r\n\tib.Unlock()\r\n\r\n\treturn err\r\n}\r\n\r\nfunc (ib *IndexBatcher) Delete(id string) error {\r\n\tib.Lock()\r\n\tib.batch.Delete(id)\r\n\tib.Unlock()\r\n\treturn nil\r\n}\r\n\r\nfunc (ib *IndexBatcher) SetInternal(key, val []byte) error {\r\n\tib.Lock()\r\n\tib.batch.SetInternal(key, val)\r\n\tib.Unlock()\r\n\treturn nil\r\n}\r\n\r\nfunc (ib *IndexBatcher) DeleteInternal(key []byte) error {\r\n\tib.Lock()\r\n\tib.batch.DeleteInternal(key)\r\n\tib.Unlock()\r\n\treturn nil\r\n}\r\n```\r\n\r\nCrash:\r\n\r\n```\r\npanic: send on closed channel\r\n\r\ngoroutine 19 [running]:\r\ngithub.com/blevesearch/bleve/index.AnalysisWorker(0xc42014e060, 0xc42014e0c0)\r\n\t/Users/prologic/go/src/github.com/blevesearch/bleve/index/analysis.go:107 +0x7b\r\ncreated by github.com/blevesearch/bleve/index.NewAnalysisQueue\r\n\t/Users/prologic/go/src/github.com/blevesearch/bleve/index/analysis.go:94 +0xcd\r\n```\r\n\r\nWhich is exactly at the same place.\r\n\r\nI don't see how if I have a mutex guard around all `Batch{...}` operations how this is possible?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393021869/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393772443","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393772443","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393772443,"node_id":"MDEyOklzc3VlQ29tbWVudDM5Mzc3MjQ0Mw==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-01T06:16:00Z","updated_at":"2018-06-01T06:16:00Z","body":"Can we please get some more eyes on this and consider reopening? I've crawled through my simple indexer with a fine tooth comb and can't understand where the problem lies.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393772443/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393855750","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393855750","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393855750,"node_id":"MDEyOklzc3VlQ29tbWVudDM5Mzg1NTc1MA==","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-01T11:42:20Z","updated_at":"2018-06-01T11:42:20Z","body":"I've added a main function, here is a complete example, but it does not crash for me.  Maybe you're configuring the batcher differently, or using it differently, can you take a look?\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"os\"\r\n\t\"sync\"\r\n\t\"time\"\r\n\r\n\t\"log\"\r\n\r\n\t\"github.com/blevesearch/bleve\"\r\n)\r\n\r\ntype bleveIndex bleve.Index\r\n\r\ntype IndexBatcher struct {\r\n\tsync.Mutex\r\n\tbleveIndex\r\n\r\n\tinterval time.Duration\r\n\tclose    chan bool\r\n\tbatch    *bleve.Batch\r\n}\r\n\r\nfunc NewIndexBatcher(index bleve.Index, interval time.Duration) bleve.Index {\r\n\tib := &IndexBatcher{\r\n\t\tbleveIndex: index,\r\n\r\n\t\tbatch:    index.NewBatch(),\r\n\t\tinterval: interval,\r\n\t\tclose:    make(chan bool),\r\n\t}\r\n\r\n\tgo ib.batchloop()\r\n\treturn ib\r\n}\r\n\r\nfunc (ib *IndexBatcher) batchloop() {\r\n\tt := time.NewTicker(ib.interval)\r\n\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase <-t.C:\r\n\t\t\tib.Lock()\r\n\t\t\terr := ib.Batch(ib.batch)\r\n\t\t\tif err != nil {\r\n\t\t\t\tlog.Printf(\"error batching: %s\", err)\r\n\t\t\t}\r\n\t\t\tib.batch.Reset()\r\n\t\t\tib.Unlock()\r\n\t\tcase <-ib.close:\r\n\t\t\tbreak\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc (ib *IndexBatcher) Close() error {\r\n\tib.close <- true\r\n\treturn ib.bleveIndex.Close()\r\n}\r\n\r\nfunc (ib *IndexBatcher) Index(id string, data interface{}) error {\r\n\tib.Lock()\r\n\terr := ib.batch.Index(id, data)\r\n\tib.Unlock()\r\n\r\n\treturn err\r\n}\r\n\r\nfunc (ib *IndexBatcher) Delete(id string) error {\r\n\tib.Lock()\r\n\tib.batch.Delete(id)\r\n\tib.Unlock()\r\n\treturn nil\r\n}\r\n\r\nfunc (ib *IndexBatcher) SetInternal(key, val []byte) error {\r\n\tib.Lock()\r\n\tib.batch.SetInternal(key, val)\r\n\tib.Unlock()\r\n\treturn nil\r\n}\r\n\r\nfunc (ib *IndexBatcher) DeleteInternal(key []byte) error {\r\n\tib.Lock()\r\n\tib.batch.DeleteInternal(key)\r\n\tib.Unlock()\r\n\treturn nil\r\n}\r\n\r\nfunc main() {\r\n\tos.RemoveAll(\"/tmp/btest38\")\r\n\r\n\tm := bleve.NewIndexMapping()\r\n\tidx, err := bleve.New(\"/tmp/btest38\", m)\r\n\tif err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n\r\n\tib := NewIndexBatcher(idx, 200*time.Millisecond)\r\n\r\n\tfor i := 0; i < 1000; i++ {\r\n\t\terr = ib.Index(fmt.Sprintf(\"%d\", i), map[string]interface{}{\r\n\t\t\t\"name\": fmt.Sprintf(\"%d\", i),\r\n\t\t\t\"body\": \"something\",\r\n\t\t})\r\n\t\tif err != nil {\r\n\t\t\tlog.Fatalf(\"error indexing through batcher: %v\", err)\r\n\t\t}\r\n\t\ttime.Sleep(10 * time.Millisecond)\r\n\t}\r\n\terr = ib.Close()\r\n\tif err != nil {\r\n\t\tlog.Fatalf(\"error closing batcher: %v\", err)\r\n\t}\r\n\r\n}\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393855750/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393939589","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-393939589","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":393939589,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzkzOTU4OQ==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-01T16:44:06Z","updated_at":"2018-06-01T16:44:06Z","body":"My code is identical. The test-environment is what is different. My conditions are:\r\n\r\n* Put the system under high concurrent load, say with `hey -n 1000 -c 10`\r\n* While under load do an index search\r\n\r\nThis crashes at the same spot quite consistently.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/393939589/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394125920","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-394125920","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":394125920,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDEyNTkyMA==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-03T00:17:49Z","updated_at":"2018-06-03T00:17:49Z","body":"New find; re-creating the `Batch()` object instead of calling `batch.Reset()` makes the crash go away. Not sure why though. The code looks like this (*almost verbatim from blevex*):\r\n\r\n```\r\npackage je\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"sync\"\r\n\t\"time\"\r\n\r\n\t\"github.com/blevesearch/bleve\"\r\n)\r\n\r\n// NOTE As this approach uses carefully orchestrated interactions\r\n// between a mutex, channels, and reference swapping, be sure to carefully\r\n// consider the impact of reordering statements or making changes to the\r\n// patterns present in the code. Specifically, individual operations follow the\r\n// pattern of:\r\n// - Construct empty references for result error, signal channel\r\n// - Acquire lock\r\n// - Assign references to current result error and signal channel\r\n// - Add operation to batch\r\n// - Release lock\r\n// - Wait on signal channel to close\r\n// - Return result error\r\n// While the batch loop follows the pattern on timer event:\r\n// - Acquire lock\r\n// - Execute batch\r\n// - Store result in current result error\r\n// - Make new current result error for use by operations in the next batch\r\n// - Close signal channel so that operations waiting on the completion of this\r\n//   batch will return the result pointed to by the previous result error that\r\n//   they are still holding.\r\n// - Make new current signal channel for use by operations in the next batch\r\n// - Release lock\r\n// This design minimizes the need for allocating channels, uses only one go\r\n// routine for the batching, and doesn't require tracking the number of\r\n// operations waiting on a response or looping to notify each waiting operation.\r\n\r\n// IndexBatcher can be wrapped around a Index to aggregate operations\r\n// in a concurrent / parallel context for increased throughput.\r\ntype IndexBatcher struct {\r\n\tbleveIndex\r\n\r\n\tperiod time.Duration\r\n\tcloser chan bool\r\n\r\n\t// lock is used to protect applying / resetting the batch, updating /\r\n\t// replacing the result, and signalling / replacing the signal channel from\r\n\t// the batch loop.  Elsewhere it is used for getting a reference to the\r\n\t// current result, getting a reference to the current signal channel,\r\n\t// and adding operations to the batch.\r\n\tlock   sync.Mutex\r\n\tbatch  *bleve.Batch\r\n\tresult *error\r\n\tsignal chan bool\r\n}\r\n\r\n// NewIndexBatcher returns an index that will aggregate and fire modifying\r\n// requests as a batch every period time. All other Index methods are\r\n// passed straight through to the underlying index. Period time should be\r\n// tuned to the underlying KVStore, the concurrent load, latency requirements,\r\n// and the documents / document mappings being used. Single digit (7~8)\r\n// milliseconds is a reasonable place to start.\r\nfunc NewIndexBatcher(index bleve.Index, period time.Duration) bleve.Index {\r\n\tib := &IndexBatcher{\r\n\t\tbleveIndex: index,\r\n\r\n\t\tbatch:  index.NewBatch(),\r\n\t\tperiod: period,\r\n\t\tcloser: make(chan bool),\r\n\t\tsignal: make(chan bool),\r\n\t\tresult: new(error),\r\n\t}\r\n\r\n\tgo ib.batchloop()\r\n\treturn ib\r\n}\r\n\r\n// batchloop processes batches every period and implements a clean close\r\n// operation\r\nfunc (ib *IndexBatcher) batchloop() {\r\n\tt := time.NewTicker(ib.period)\r\n\r\nBatchLoop:\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase <-t.C:\r\n\t\t\tib.lock.Lock()\r\n\t\t\tfunc() {\r\n\t\t\t\tdefer func() {\r\n\t\t\t\t\tif r := recover(); r != nil {\r\n\t\t\t\t\t\t(*ib.result) = fmt.Errorf(\"IndexBatcher caught a panic: %v\", r)\r\n\t\t\t\t\t}\r\n\t\t\t\t}()\r\n\t\t\t\t(*ib.result) = ib.Batch(ib.batch)\r\n\t\t\t}()\r\n\t\t\tib.batch = ib.bleveIndex.NewBatch()\r\n\t\t\tib.result = new(error)\r\n\t\t\tclose(ib.signal)\r\n\t\t\tib.signal = make(chan bool)\r\n\t\t\tib.lock.Unlock()\r\n\t\tcase <-ib.closer:\r\n\t\t\tbreak BatchLoop\r\n\t\t}\r\n\t}\r\n\r\n\tt.Stop()\r\n\t(*ib.result) = fmt.Errorf(\"IndexBatcher has been closed\")\r\n\tclose(ib.signal)\r\n}\r\n\r\n// Close stops the batcher returning an error to currently waiting operations\r\n// and closes the underlying Index\r\nfunc (ib *IndexBatcher) Close() error {\r\n\tib.closer <- true\r\n\treturn ib.bleveIndex.Close()\r\n}\r\n\r\n// Index the object with the specified identifier. May hold the operation for up\r\n// to ib.period time before executing in a batch.\r\nfunc (ib *IndexBatcher) Index(id string, data interface{}) error {\r\n\tvar result *error\r\n\tvar signal chan bool\r\n\tib.lock.Lock()\r\n\tresult = ib.result\r\n\tsignal = ib.signal\r\n\terr := ib.batch.Index(id, data)\r\n\tib.lock.Unlock()\r\n\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\t<-signal\r\n\treturn *result\r\n}\r\n\r\n// Delete entries for the specified identifier from the index. May hold the\r\n// operation for up to ib.period time before executing in a batch.\r\nfunc (ib *IndexBatcher) Delete(id string) error {\r\n\tvar result *error\r\n\tvar signal chan bool\r\n\tib.lock.Lock()\r\n\tresult = ib.result\r\n\tsignal = ib.signal\r\n\tib.batch.Delete(id)\r\n\tib.lock.Unlock()\r\n\r\n\t<-signal\r\n\treturn *result\r\n}\r\n\r\n// SetInternal mappings directly in the kvstore. May hold the\r\n// operation for up to ib.period time before executing in a batch.\r\nfunc (ib *IndexBatcher) SetInternal(key, val []byte) error {\r\n\tvar result *error\r\n\tvar signal chan bool\r\n\tib.lock.Lock()\r\n\tresult = ib.result\r\n\tsignal = ib.signal\r\n\tib.batch.SetInternal(key, val)\r\n\tib.lock.Unlock()\r\n\r\n\t<-signal\r\n\treturn *result\r\n}\r\n\r\n// DeleteInternal mappings directly from the kvstore. May hold the\r\n// operation for up to ib.period time before executing in a batch.\r\nfunc (ib *IndexBatcher) DeleteInternal(key []byte) error {\r\n\tvar result *error\r\n\tvar signal chan bool\r\n\tib.lock.Lock()\r\n\tresult = ib.result\r\n\tsignal = ib.signal\r\n\tib.batch.DeleteInternal(key)\r\n\tib.lock.Unlock()\r\n\r\n\t<-signal\r\n\treturn *result\r\n}\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394125920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394125938","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-394125938","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":394125938,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDEyNTkzOA==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-03T00:18:20Z","updated_at":"2018-06-03T00:18:20Z","body":"Note the lines:\r\n\r\n```#!go\r\n\tib.batch = ib.bleveIndex.NewBatch()\r\n\tib.result = new(error)\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394125938/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394126998","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-394126998","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":394126998,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDEyNjk5OA==","user":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-03T00:48:40Z","updated_at":"2018-06-03T00:48:40Z","body":"I don't think it's new information from my understanding.  Our understanding of this crash is as follows:\r\n\r\n1.  the number of updates inside a batch is computed here: https://github.com/blevesearch/bleve/blob/master/index/upsidedown/upsidedown.go#L808\r\n\r\n2. an item is put onto the analysis queue for each update here:\r\nhttps://github.com/blevesearch/bleve/blob/master/index/upsidedown/upsidedown.go#L818\r\n\r\n3.  we read the number of updates computed above in 1, off the of the analysis results channel: https://github.com/blevesearch/bleve/blob/master/index/upsidedown/upsidedown.go#L861\r\n\r\nThis crash happens when the count computed in 1 and the number of documents written in 2 are not the same.  In this original issue, this happened because the user would continue to modify a batch after it had been executed.  This is clearly not supported and thus the issue was closed.\r\n\r\nIn this case, we still don't understand why these counts are different, but this seems to still be the only way we would end up closing the channel prematurely and get the panic.  Not resetting batches avoids this entirely, but presumably is unacceptable for other reasons.  The question remains, why do we see this problem, even though the locking looks correct and the batch reuse looks to be as intended.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394126998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394134053","html_url":"https://github.com/blevesearch/bleve/issues/195#issuecomment-394134053","issue_url":"https://api.github.com/repos/blevesearch/bleve/issues/195","id":394134053,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDEzNDA1Mw==","user":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-06-03T04:24:26Z","updated_at":"2018-06-03T04:24:26Z","body":"@mschoch What I don't understand is how this is even remotely possible while all `Batch()` operations are under a mutex guard/lock? The only way I can think of is that the call to `index.Batch(batch)` itself takes the batch object and does \"asynchronous\" operations on it; meanwhile we've done a `batch.Reset()` and are now adding more documents to the batch while another batch is in progress. Meaning even through we've \"reset\" the batch object it's actually under use by the Analysis workers.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/comments/394134053/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"prologic","id":1290234,"node_id":"MDQ6VXNlcjEyOTAyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1290234?v=4","gravatar_id":"","url":"https://api.github.com/users/prologic","html_url":"https://github.com/prologic","followers_url":"https://api.github.com/users/prologic/followers","following_url":"https://api.github.com/users/prologic/following{/other_user}","gists_url":"https://api.github.com/users/prologic/gists{/gist_id}","starred_url":"https://api.github.com/users/prologic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prologic/subscriptions","organizations_url":"https://api.github.com/users/prologic/orgs","repos_url":"https://api.github.com/users/prologic/repos","events_url":"https://api.github.com/users/prologic/events{/privacy}","received_events_url":"https://api.github.com/users/prologic/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1659858915,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MTY1OTg1ODkxNQ==","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/1659858915","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2018-06-03T04:24:26Z","performed_via_github_app":null},{"id":1659858916,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDE2NTk4NTg5MTY=","url":"https://api.github.com/repos/blevesearch/bleve/issues/events/1659858916","actor":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2018-06-03T04:24:26Z","performed_via_github_app":null}]