{"url":"https://api.github.com/repos/blevesearch/bleve/issues/1166","repository_url":"https://api.github.com/repos/blevesearch/bleve","labels_url":"https://api.github.com/repos/blevesearch/bleve/issues/1166/labels{/name}","comments_url":"https://api.github.com/repos/blevesearch/bleve/issues/1166/comments","events_url":"https://api.github.com/repos/blevesearch/bleve/issues/1166/events","html_url":"https://github.com/blevesearch/bleve/issues/1166","id":423510831,"node_id":"MDU6SXNzdWU0MjM1MTA4MzE=","number":1166,"title":"perf: scorch/zap ReadUvarint()","user":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-03-20T23:06:00Z","updated_at":"2019-03-27T14:44:12Z","closed_at":"2019-03-27T14:44:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"On scorch search performance, @sreekanth-cb has been looking into pprof profiling reports, so capturing some of recent discussion and more thoughts on this...\r\n\r\nFrom the pprof's, looks like encoding/binary.ReadUvarint() and its invocation of bytes.Reader.ReadByte() show up a bunch as top contenders of the \"hot inner loop(s)\" of \"where does the time go?\".\r\n\r\nEspecially, those functions are invoked from zap's PostingIterator.readFreqNormHasLocs() method.\r\n\r\nAt first, I thought those funcs were taking up time because they were a likely point of first contact when accessing different parts of the mmap()'ed zap file.  And, I was theorizing that page-faults are \"invisible\" to golang's profiler -- so those func's weren't really actually slow -- it's just that I figured that that's where disk reads was happening.\r\n\r\nBut, @sreekanth-cb was able to run some tests on large RAM machines where major page faults weren't appearing at all, but ReadUvarint() and ReadByte() were still at the top of the pprof reports.\r\n\r\nOn the one hand, those funcs from the golang standard library are seemingly highly optimized.\r\n\r\nOn the other hand, there's a couple of checks and features there that are meant to handle general cases as a standard library, where in contrast scorch/zap might have some narrower, optimizable needs.  Some ideas...\r\n\r\n- there's safety error checking for io.EOF with the bytes.Reader.ReadByte().  In contrast, scorch/zap ought to have \"perfectly sized\" memory slices (knock on wood) where, theoretically, zap's freqNormReader never ought to run into an io.EOF.\r\n\r\n- there's some minor rune related code in bytes.Reader (that's apparently for io.RuneScanner) that might be worth avoiding for scorch/zap.\r\n\r\n- a simplified bytes.Reader.ReadByte() might be explicitly in-line'able, which may mean that we can avoid a method call in the hot-inner-loop of ReadUvarint().\r\n\r\n- zap's PostingIterator.currChunkNext() invokes readFreqNormHasLocs() but ignores the freq/norm parts of the result, so perhaps specialized methods might be faster.  e.g., something like SkipUvarint()?\r\n","closed_by":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/1166/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blevesearch/bleve/issues/1166/timeline","performed_via_github_app":null,"state_reason":"completed"}