{"url":"https://api.github.com/repos/blevesearch/bleve/issues/130","repository_url":"https://api.github.com/repos/blevesearch/bleve","labels_url":"https://api.github.com/repos/blevesearch/bleve/issues/130/labels{/name}","comments_url":"https://api.github.com/repos/blevesearch/bleve/issues/130/comments","events_url":"https://api.github.com/repos/blevesearch/bleve/issues/130/events","html_url":"https://github.com/blevesearch/bleve/issues/130","id":50771384,"node_id":"MDU6SXNzdWU1MDc3MTM4NA==","number":130,"title":"data race when querying an alias of an alias","user":{"login":"steveyen","id":30640,"node_id":"MDQ6VXNlcjMwNjQw","avatar_url":"https://avatars.githubusercontent.com/u/30640?v=4","gravatar_id":"","url":"https://api.github.com/users/steveyen","html_url":"https://github.com/steveyen","followers_url":"https://api.github.com/users/steveyen/followers","following_url":"https://api.github.com/users/steveyen/following{/other_user}","gists_url":"https://api.github.com/users/steveyen/gists{/gist_id}","starred_url":"https://api.github.com/users/steveyen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/steveyen/subscriptions","organizations_url":"https://api.github.com/users/steveyen/orgs","repos_url":"https://api.github.com/users/steveyen/repos","events_url":"https://api.github.com/users/steveyen/events{/privacy}","received_events_url":"https://api.github.com/users/steveyen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-12-03T03:14:38Z","updated_at":"2014-12-28T17:24:45Z","closed_at":"2014-12-28T17:24:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Using the cbft project (github.com/couchbaselabs/cbft) which uses bleve, using cbft commit e91ac205964, when running \"go test -race\", there are output complaints about data races.\n\nI suspect the issue is that the cbft test scenario has an IndexAlias that pointing to more IndexAliases.  So, there's concurrent access to a shared req (*SearchRequest) object from multiple bleve goroutines (spawned in MultiSearch) and that's detected by the data race detector.\n\nIn the index_alias_impl.go, there's also a juicy comment about...\n\n```\n// FIXME should create new request for\n// child queries\n```\n\n...and my guess/suspicion is that doing something like that (if the copying is done in the parent goroutine) might fix the data race.\n# \n\nWARNING: DATA RACE\nRead by goroutine 108:\n  github.com/blevesearch/bleve.MultiSearch()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:347 +0x1cb\n  github.com/blevesearch/bleve.(*indexAliasImpl).Search()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:146 +0x30b\n  github.com/blevesearch/bleve.func路001()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:363 +0xd7\n\nPrevious write by goroutine 98:\n  github.com/blevesearch/bleve.MultiSearch()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:349 +0x24b\n  github.com/blevesearch/bleve.(*indexAliasImpl).Search()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:146 +0x30b\n  github.com/blevesearch/bleve.func路001()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:363 +0xd7\n\nGoroutine 108 (running) created at:\n  github.com/blevesearch/bleve.func路002()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:369 +0x171\n  github.com/blevesearch/bleve.MultiSearch()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:374 +0x41b\n  github.com/blevesearch/bleve.(_indexAliasImpl).Search()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:146 +0x30b\n  github.com/couchbaselabs/cbft.QueryAlias()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/pindex_impl_alias.go:91 +0x4f8\n  github.com/couchbaselabs/cbft.(_QueryHandler).ServeHTTP()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/rest_index.go:188 +0x5e4\n  github.com/gorilla/mux.(*Router).ServeHTTP()\n      /Users/steveyen/go/src/github.com/gorilla/mux/mux.go:98 +0x376\n  github.com/couchbaselabs/cbft.testRESTHandlers()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/rest_test.go:100 +0x612\n  github.com/couchbaselabs/cbft.TestCreateIndexTwoNodes()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/rest_test.go:1727 +0x318f\n  testing.tRunner()\n      /usr/local/go/src/pkg/testing/testing.go:422 +0x10f\n\nGoroutine 98 (running) created at:\n  github.com/blevesearch/bleve.func路002()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:369 +0x171\n  github.com/blevesearch/bleve.MultiSearch()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:374 +0x41b\n  github.com/blevesearch/bleve.(_indexAliasImpl).Search()\n      /Users/steveyen/go/src/github.com/blevesearch/bleve/index_alias_impl.go:146 +0x30b\n  github.com/couchbaselabs/cbft.QueryAlias()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/pindex_impl_alias.go:91 +0x4f8\n  github.com/couchbaselabs/cbft.(_QueryHandler).ServeHTTP()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/rest_index.go:188 +0x5e4\n  github.com/gorilla/mux.(*Router).ServeHTTP()\n      /Users/steveyen/go/src/github.com/gorilla/mux/mux.go:98 +0x376\n  github.com/couchbaselabs/cbft.testRESTHandlers()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/rest_test.go:100 +0x612\n  github.com/couchbaselabs/cbft.TestCreateIndexTwoNodes()\n      /Users/steveyen/go/src/github.com/couchbaselabs/cbft/rest_test.go:1727 +0x318f\n  testing.tRunner()\n#       /usr/local/go/src/pkg/testing/testing.go:422 +0x10f\n","closed_by":{"login":"mschoch","id":298143,"node_id":"MDQ6VXNlcjI5ODE0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/298143?v=4","gravatar_id":"","url":"https://api.github.com/users/mschoch","html_url":"https://github.com/mschoch","followers_url":"https://api.github.com/users/mschoch/followers","following_url":"https://api.github.com/users/mschoch/following{/other_user}","gists_url":"https://api.github.com/users/mschoch/gists{/gist_id}","starred_url":"https://api.github.com/users/mschoch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mschoch/subscriptions","organizations_url":"https://api.github.com/users/mschoch/orgs","repos_url":"https://api.github.com/users/mschoch/repos","events_url":"https://api.github.com/users/mschoch/events{/privacy}","received_events_url":"https://api.github.com/users/mschoch/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/blevesearch/bleve/issues/130/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/blevesearch/bleve/issues/130/timeline","performed_via_github_app":null,"state_reason":"completed"}