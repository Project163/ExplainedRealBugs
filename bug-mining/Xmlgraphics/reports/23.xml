<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:30:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[XGC-141] image-loading configuration settings are not thread-safe</title>
                <link>https://issues.apache.org/jira/browse/XGC-141</link>
                <project id="12314221" key="XGC">XMLGraphicsCommons</project>
                    <description>&lt;p&gt;As a workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/FOP-3171&quot; title=&quot;Certain PNG images (grayscale, transparent) produce broken PDF&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FOP-3171&quot;&gt;&lt;del&gt;FOP-3171&lt;/del&gt;&lt;/a&gt; I added an &amp;lt;image-loading&amp;gt; section to the config and noticed that the settings will take effect on all subsequent renderings in the same VM, even when they use a different config or none at all. When running two or more rendering processes with different configs in parallel, the result will basically be random.&lt;/p&gt;

&lt;p&gt;At the very least, this behaviour should be documented and warned about.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13573659">XGC-141</key>
            <summary>image-loading configuration settings are not thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ssteiner">Simon Steiner</assignee>
                                    <reporter username="martin.leitner@infinica.com">Martin Leitner</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Mar 2024 10:04:32 +0000</created>
                <updated>Wed, 3 Apr 2024 08:10:04 +0000</updated>
                            <resolved>Wed, 3 Apr 2024 07:50:03 +0000</resolved>
                                    <version>2.9</version>
                                    <fixVersion>2.10</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17831715" author="JIRAUSER302961" created="Thu, 28 Mar 2024 10:41:38 +0000"  >&lt;p&gt;Hi, worth having a look at &lt;em&gt;FopConfParser.configureImageLoading.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The penalties are saved with a HashMap, so if you try to set different penalties for the same class the penalty value will be replaced with whatever was last. &lt;/p&gt;

&lt;p&gt;Does this happen if you run the processes one at a time and not in parallel?&lt;/p&gt;</comment>
                            <comment id="17831717" author="martin.leitner@infinica.com" created="Thu, 28 Mar 2024 10:46:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgoncalves&quot; class=&quot;user-hover&quot; rel=&quot;jgoncalves&quot;&gt;jgoncalves&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;when I run the processes one at a time, configured penalties will stay in effect until another process uses a config that sets a different value.&lt;/p&gt;

&lt;p&gt;When running the processes in parallel in different threads at (nearly) the same time, and they use different configs with different penalty values for the same class, it is random which config wins. I guess it is the config that is put in effect last.&lt;/p&gt;</comment>
                            <comment id="17831718" author="ssteiner1" created="Thu, 28 Mar 2024 10:50:08 +0000"  >&lt;p&gt;Are you running a different fopfactory per thread, which is required&lt;/p&gt;</comment>
                            <comment id="17831721" author="martin.leitner@infinica.com" created="Thu, 28 Mar 2024 10:53:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ssteiner&quot; class=&quot;user-hover&quot; rel=&quot;ssteiner&quot;&gt;ssteiner&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;yes, every rendering process creates its own FopFactory.&lt;/p&gt;</comment>
                            <comment id="17831870" author="ssteiner1" created="Thu, 28 Mar 2024 15:48:48 +0000"  >&lt;p&gt;what if you create a fopfactory and pass in your fop.xconf as the 2nd param:&lt;br/&gt;
FopFactory newInstance(URI baseURI, InputStream confStream)&lt;/p&gt;</comment>
                            <comment id="17832119" author="martin.leitner@infinica.com" created="Fri, 29 Mar 2024 09:38:07 +0000"  >&lt;p&gt;Attached a Maven project with 2 unit tests that demonstrate the sequential and the parallel use case.&lt;/p&gt;</comment>
                            <comment id="17832411" author="peterhull90" created="Sat, 30 Mar 2024 07:37:36 +0000"  >&lt;p&gt;I had a little dig into this. As I understand it, creating a FopFactory creates a FopFactoryBuilder, which in turn creates a FopFactoryConfigImpl. FopFactoryConfigImpl creates an ImageManager. The ImageManager stores data, including the&#160; &apos;Additional Penalties&apos; which are the issue here, in ImageImplRegistry, which is a singleton class. So ultimately it&apos;s this single instance that is responsible for the carry-over of properties from one FopFactory to the next, and it doesn&apos;t seem like there is a simple way to avoid that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; @Test
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCarryOver() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160; &#160; &#160; &#160; URI baseURI = URI.create(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//example.com/&quot;&lt;/span&gt;);
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; className = SequentialTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName();
&#160; &#160; &#160; &#160; FopFactory fopFactory1 = FopFactory.newInstance(baseURI);
&#160; &#160; &#160; &#160; fopFactory1.getImageManager().getRegistry().setAdditionalPenalty(className, Penalty.toPenalty(1234));
&#160; &#160; &#160; &#160; FopFactory fopFactory2 = FopFactory.newInstance(baseURI);
&#160; &#160; &#160; &#160; Penalty expected = Penalty.ZERO_PENALTY;
&#160; &#160; &#160; &#160; Penalty actual = fopFactory2.getImageManager().getRegistry().getAdditionalPenalty(className);
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// For a &lt;span class=&quot;code-quote&quot;&gt;&apos;fresh&apos;&lt;/span&gt; FopFactory, penalty should be the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;, zero.
&lt;/span&gt;&#160; &#160; &#160; &#160; org.junit.Assert.assertEquals(expected, actual);
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// in fact it fails because 1234 is carried over from fopFactory1 to fopFactory2.
&lt;/span&gt;&#160; &#160; }
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For reference the classes are,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.xmlgraphics.image.loader.spi.ImageImplRegistry in xmlgraphics-commons-2.9.jar&lt;/li&gt;
	&lt;li&gt;org.apache.xmlgraphics.image.loader.ImageManager in in xmlgraphics-commons-2.9.jar&lt;/li&gt;
	&lt;li&gt;org.apache.fop.apps.FopFactoryBuilder in fop-core-2.9.jar&lt;/li&gt;
	&lt;li&gt;org.apache.fop.apps.FopConfParser in fop-core-2.9.jar&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17833024" author="martin.leitner@infinica.com" created="Tue, 2 Apr 2024 06:19:00 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterhull90&quot; class=&quot;user-hover&quot; rel=&quot;peterhull90&quot;&gt;peterhull90&lt;/a&gt; for the analysis! I totally agree that this is what is going on.&lt;/p&gt;

&lt;p&gt;I do not see why there would be no simple way to avoid that.&lt;/p&gt;

&lt;p&gt;I suggest to change line 420 in &lt;font color=&quot;#000000&quot;&gt;FopFactoryBuilder&lt;/font&gt;$FopFactoryConfigImpl from&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.imageManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImageManager(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImageContextImpl(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.imageManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImageManager(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImageImplRegistry(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ImageContextImpl(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17833270" author="peterhull90" created="Tue, 2 Apr 2024 17:18:41 +0000"  >&lt;p&gt;That looks straightforward but someone who knows the codebase better will have to comment on whether it relies on having one single registry shared across all components (the two-arg constructor you mention says &quot;for testing purposes&quot; in the comments)&lt;/p&gt;</comment>
                            <comment id="17833429" author="ssteiner1" created="Wed, 3 Apr 2024 07:50:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/xmlgraphics-commons/commit/95b17e2c6508db33a51a4a0a0ab36dcd82ba5d8e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/xmlgraphics-commons/commit/95b17e2c6508db33a51a4a0a0ab36dcd82ba5d8e&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17833442" author="peterhull90@gmail.com" created="Wed, 3 Apr 2024 08:10:04 +0000"  >&lt;p&gt;Boom!&lt;/p&gt;

&lt;p&gt;Is &lt;a href=&quot;https://issues.apache.org/jira/browse/XGC-120&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/XGC-120&lt;/a&gt; related/also fixed by this?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13572947">FOP-3171</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13067740" name="fop_3172.zip" size="25184" author="martin.leitner@infinica.com" created="Fri, 29 Mar 2024 09:37:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 31 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1o9vk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>