<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:09:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TILES-585] Definition cascade attributes duplicated values under high load</title>
                <link>https://issues.apache.org/jira/browse/TILES-585</link>
                <project id="12311046" key="TILES">Tiles</project>
                    <description>&lt;p&gt;The problem concerns &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; CachingLocaleUrlDefinitionDAO.getDefinitions(Locale customizationKey) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which lacks synchronization.&lt;/p&gt;

&lt;p&gt;To reproduce the bug: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Set up few clients with different Accept-Language headers&lt;/li&gt;
	&lt;li&gt;Make the clients perform many request in short time (check out jmeter    script attached below)&lt;/li&gt;
	&lt;li&gt;the retValue contains entries with definitions with cascade attirbutes whose elements are duplicated.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We &lt;b&gt;fixed it by marking getDefinitions method synchronized&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;Here is jmeter script to reproduce bug:&lt;br/&gt;
&lt;a href=&quot;http://pastebin.com/pQT32Crx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/pQT32Crx&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For following definition:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;definition name=&lt;span class=&quot;code-quote&quot;&gt;&quot;template&quot;&lt;/span&gt; template=&lt;span class=&quot;code-quote&quot;&gt;&quot;/WEB-INF/views/template.jsp&quot;&lt;/span&gt;&amp;gt;
	&amp;lt;put-list-attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;scripts&quot;&lt;/span&gt; cascade=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;add-attribute value=&lt;span class=&quot;code-quote&quot;&gt;&quot;mstatic/js/form-validation-lang-hu.js&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;add-attribute value=&lt;span class=&quot;code-quote&quot;&gt;&quot;mstatic/js/jquery.core.min.js&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;add-attribute value=&lt;span class=&quot;code-quote&quot;&gt;&quot;mstatic/js/scripts.min.js&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;!--other attributes--&amp;gt;
	&amp;lt;/put-list-attribute&amp;gt;
&amp;lt;/definition&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cascade attributes are duplicated:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://s31.postimg.org/9z8fr06ux/image.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12982677">TILES-585</key>
            <summary>Definition cascade attributes duplicated values under high load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jakub.dziworski">Jakub Dziworski</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Jun 2016 12:52:27 +0000</created>
                <updated>Sat, 17 Oct 2020 08:45:16 +0000</updated>
                                            <version>3.0.5</version>
                                    <fixVersion>3.1.x</fixVersion>
                    <fixVersion>3.0.7</fixVersion>
                                    <component>tiles-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15348245" author="apetrelli" created="Fri, 24 Jun 2016 13:22:07 +0000"  >&lt;p&gt;I see the problem but I disagree with the solution. I think that the method:&lt;br/&gt;
checkAndloadDefinitions&lt;br/&gt;
that is already synchronized, should check if the definition have been loaded again.&lt;br/&gt;
In other words:&lt;br/&gt;
1. getDefinitions checks if the definitions are loaded. If yes, return them;&lt;br/&gt;
2. if they are not loaded, go into a critical block, check again if the definitions are loaded and, if not, load them.&lt;/p&gt;</comment>
                            <comment id="15348256" author="jakub.dziworski" created="Fri, 24 Jun 2016 13:29:22 +0000"  >&lt;p&gt;Indeed this is way better solution. Thanks.&lt;/p&gt;</comment>
                            <comment id="15349045" author="michaelsembwever" created="Sat, 25 Jun 2016 03:59:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jakub.dziworski&quot; class=&quot;user-hover&quot; rel=&quot;jakub.dziworski&quot;&gt;jakub.dziworski&lt;/a&gt;, thanks for reporting this.&lt;/p&gt;

&lt;p&gt;Would you be interested in posting the patch against &lt;tt&gt;CachingLocaleUrlDefinitionDAO&lt;/tt&gt; (or creating a github PR) to fix this as Antonio describes?&lt;br/&gt;
It would be appreciated.&lt;/p&gt;</comment>
                            <comment id="15349498" author="jakub.dziworski" created="Sat, 25 Jun 2016 08:04:13 +0000"  >&lt;p&gt;Yes. I&apos;ll do it asap (probably tuesday)&lt;/p&gt;</comment>
                            <comment id="15354663" author="githubbot" created="Wed, 29 Jun 2016 06:42:36 +0000"  >&lt;p&gt;GitHub user JakubDziworski opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/tiles/pull/9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tiles/pull/9&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/TILES-585&quot; title=&quot;Definition cascade attributes duplicated values under high load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TILES-585&quot;&gt;TILES-585&lt;/a&gt;: Definition cascade attributes duplicated values under high&#8230;&lt;/p&gt;

&lt;p&gt;    Fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/TILES-585&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/TILES-585&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/JakubDziworski/tiles&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JakubDziworski/tiles&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/TILES-585&quot; title=&quot;Definition cascade attributes duplicated values under high load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TILES-585&quot;&gt;TILES-585&lt;/a&gt;-fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/tiles/pull/9.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tiles/pull/9.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #9&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 78d9001ea5d0b02523ada36453848125d80ec6e3&lt;br/&gt;
Author: Jakub Dziworski &amp;lt;jakub.dziworski@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-29T06:41:02Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/TILES-585&quot; title=&quot;Definition cascade attributes duplicated values under high load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TILES-585&quot;&gt;TILES-585&lt;/a&gt;: Definition cascade attributes duplicated values under high load&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15374895" author="githubbot" created="Wed, 13 Jul 2016 12:13:53 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/tiles/pull/9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tiles/pull/9&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15374908" author="michaelsembwever" created="Wed, 13 Jul 2016 12:22:52 +0000"  >&lt;p&gt;Merged. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jakub.dziworski&quot; class=&quot;user-hover&quot; rel=&quot;jakub.dziworski&quot;&gt;jakub.dziworski&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15823535" author="laoseth" created="Mon, 16 Jan 2017 06:45:34 +0000"  >&lt;p&gt;This patch breaks the checkRefresh option.  In a high load situation, I wouldn&apos;t imagine you would be using this, but it is helpful during development.  Maybe change &lt;br/&gt;
if (definitionsAlreadyLoaded) &lt;/p&gt;
{
            return existingDefinitions;
        }&lt;br/&gt;
 to &lt;br/&gt;
if (definitionsAlreadyLoaded &amp;amp;&amp;amp; !checkRefresh) {            return existingDefinitions;        }</comment>
                            <comment id="15880236" author="michaelsembwever" created="Thu, 23 Feb 2017 10:37:28 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=laoseth&quot; class=&quot;user-hover&quot; rel=&quot;laoseth&quot;&gt;laoseth&lt;/a&gt; for pointing this out.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a patch to address this. I also changed the Map from being a HashMap to a ConcurrentHashMap. (IMHO the code isn&apos;t locked down enough, non-synchronized protected methods for writes, to avoid doing The Right Thing&#8482; and using the ConcurrentHashMap). Could you review it please?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jakub.dziworski&quot; class=&quot;user-hover&quot; rel=&quot;jakub.dziworski&quot;&gt;jakub.dziworski&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apetrelli&quot; class=&quot;user-hover&quot; rel=&quot;apetrelli&quot;&gt;apetrelli&lt;/a&gt; would you mind also reviewing this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12854172" name="TILES-585.patch" size="2077" author="mck" created="Thu, 23 Feb 2017 10:31:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3016f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>