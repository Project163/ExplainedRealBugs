{"url":"https://api.github.com/repos/seanmonstar/reqwest/issues/348","repository_url":"https://api.github.com/repos/seanmonstar/reqwest","labels_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/348/labels{/name}","comments_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/348/comments","events_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/348/events","html_url":"https://github.com/seanmonstar/reqwest/issues/348","id":361704233,"node_id":"MDU6SXNzdWUzNjE3MDQyMzM=","number":348,"title":"Mulitpart file uploads get stuck after upgrading to 0.9.0","user":{"login":"konstin","id":6826232,"node_id":"MDQ6VXNlcjY4MjYyMzI=","avatar_url":"https://avatars.githubusercontent.com/u/6826232?v=4","gravatar_id":"","url":"https://api.github.com/users/konstin","html_url":"https://github.com/konstin","followers_url":"https://api.github.com/users/konstin/followers","following_url":"https://api.github.com/users/konstin/following{/other_user}","gists_url":"https://api.github.com/users/konstin/gists{/gist_id}","starred_url":"https://api.github.com/users/konstin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konstin/subscriptions","organizations_url":"https://api.github.com/users/konstin/orgs","repos_url":"https://api.github.com/users/konstin/repos","events_url":"https://api.github.com/users/konstin/events{/privacy}","received_events_url":"https://api.github.com/users/konstin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":401213509,"node_id":"MDU6TGFiZWw0MDEyMTM1MDk=","url":"https://api.github.com/repos/seanmonstar/reqwest/labels/C-bug","name":"C-bug","color":"ee0701","default":false,"description":"Category: bug. Something is wrong. This is bad!"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2018-09-19T11:32:36Z","updated_at":"2018-09-20T12:42:42Z","closed_at":"2018-09-20T12:42:42Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've received a [pull request](https://github.com/PyO3/pyo3-pack/pull/5) to [pyo3-pack](https://github.com/PyO3/pyo3-pack) which upgrades reqwest to 0.9.0. Unfortunately this seems to break uploading.\r\n\r\nThe 0.8 case works and returns the expected 403:\r\n\r\n```\r\ngit clone https://github.com/PyO3/pyo3-pack\r\ncargo run -- publish -u konstin -b bin -r https://test.pypi.org/legacy/ -m hello-world/Cargo.toml -p notmypassword\r\n```\r\n\r\nIf we now add the 0.9 upgrade, we are stuck with no network activity\r\n\r\n```\r\ngit remote add ijl https://github.com/ijl/pyo3-pack\r\ngit fetch --all\r\ngit checkout ijl/up-reqwest\r\ncargo run -- publish -u konstin -b bin -r https://test.pypi.org/legacy/ -m hello-world/Cargo.toml -p notmypassword\r\n```\r\n\r\nTrying to minimize this brought me to the following code. \r\n\r\n```rust\r\nextern crate reqwest;\r\n\r\nuse reqwest::{multipart::Form, Client};\r\n\r\nfn main() {\r\n    // This can be any bigger file\r\n    let filename = \"target/debug/sslbug\";\r\n\r\n    let form = Form::new().file(\"content\", filename).unwrap();\r\n\r\n    Client::new()\r\n        .post(\"https://test.pypi.org/legacy/\")\r\n        .header(\"content-type\", \"application/json; charset=utf-8\")\r\n        .multipart(form)\r\n        .send()\r\n        .unwrap();\r\n}\r\n```\r\n\r\nThe code above works when uploading a small file (like Cargo.toml) but with bigger files (like its debug executable), it results in a panic without the program being terminated (I had to quit with ctrl+c):\r\n\r\n```\r\nthread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Error { kind: Io(Custom { kind: WouldBlock, error: StringError(\"timed out\") }), url: None }', libcore/result.rs:1009:5\r\nstack backtrace:\r\n   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace\r\n             at libstd/sys/unix/backtrace/tracing/gcc_s.rs:49\r\n   1: std::sys_common::backtrace::print\r\n             at libstd/sys_common/backtrace.rs:71\r\n             at libstd/sys_common/backtrace.rs:59\r\n   2: std::panicking::default_hook::{{closure}}\r\n             at libstd/panicking.rs:211\r\n   3: std::panicking::default_hook\r\n             at libstd/panicking.rs:227\r\n   4: std::panicking::rust_panic_with_hook\r\n             at libstd/panicking.rs:477\r\n   5: std::panicking::continue_panic_fmt\r\n             at libstd/panicking.rs:391\r\n   6: rust_begin_unwind\r\n             at libstd/panicking.rs:326\r\n   7: core::panicking::panic_fmt\r\n             at libcore/panicking.rs:77\r\n   8: core::result::unwrap_failed\r\n             at libcore/macros.rs:26\r\n   9: <core::result::Result<T, E>>::unwrap\r\n             at libcore/result.rs:808\r\n  10: sslbug::main\r\n             at src/main.rs:11\r\n  11: std::rt::lang_start::{{closure}}\r\n             at libstd/rt.rs:74\r\n  12: std::panicking::try::do_call\r\n             at libstd/rt.rs:59\r\n             at libstd/panicking.rs:310\r\n  13: __rust_maybe_catch_panic\r\n             at libpanic_unwind/lib.rs:102\r\n  14: std::rt::lang_start_internal\r\n             at libstd/panicking.rs:289\r\n             at libstd/panic.rs:392\r\n             at libstd/rt.rs:58\r\n  15: std::rt::lang_start\r\n             at libstd/rt.rs:74\r\n  16: main\r\n  17: __libc_start_main\r\n  18: _start\r\n```\r\n\r\nrustc version: `rustc 1.30.0-nightly (cb6d2dfa8 2018-09-16)`\r\noperating system: ubuntu 18.04","closed_by":{"login":"konstin","id":6826232,"node_id":"MDQ6VXNlcjY4MjYyMzI=","avatar_url":"https://avatars.githubusercontent.com/u/6826232?v=4","gravatar_id":"","url":"https://api.github.com/users/konstin","html_url":"https://github.com/konstin","followers_url":"https://api.github.com/users/konstin/followers","following_url":"https://api.github.com/users/konstin/following{/other_user}","gists_url":"https://api.github.com/users/konstin/gists{/gist_id}","starred_url":"https://api.github.com/users/konstin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konstin/subscriptions","organizations_url":"https://api.github.com/users/konstin/orgs","repos_url":"https://api.github.com/users/konstin/repos","events_url":"https://api.github.com/users/konstin/events{/privacy}","received_events_url":"https://api.github.com/users/konstin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/seanmonstar/reqwest/issues/348/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/348/timeline","performed_via_github_app":null,"state_reason":"completed"}