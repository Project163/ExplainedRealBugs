{"url":"https://api.github.com/repos/seanmonstar/reqwest/issues/2381","repository_url":"https://api.github.com/repos/seanmonstar/reqwest","labels_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/2381/labels{/name}","comments_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/2381/comments","events_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/2381/events","html_url":"https://github.com/seanmonstar/reqwest/issues/2381","id":2462257732,"node_id":"I_kwDOA7dkLM6SwxJE","number":2381,"title":"Gzip decoder returns too early while consuming TCP fragmented chuncked body","user":{"login":"Andrey36652","id":35865938,"node_id":"MDQ6VXNlcjM1ODY1OTM4","avatar_url":"https://avatars.githubusercontent.com/u/35865938?v=4","gravatar_id":"","url":"https://api.github.com/users/Andrey36652","html_url":"https://github.com/Andrey36652","followers_url":"https://api.github.com/users/Andrey36652/followers","following_url":"https://api.github.com/users/Andrey36652/following{/other_user}","gists_url":"https://api.github.com/users/Andrey36652/gists{/gist_id}","starred_url":"https://api.github.com/users/Andrey36652/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Andrey36652/subscriptions","organizations_url":"https://api.github.com/users/Andrey36652/orgs","repos_url":"https://api.github.com/users/Andrey36652/repos","events_url":"https://api.github.com/users/Andrey36652/events{/privacy}","received_events_url":"https://api.github.com/users/Andrey36652/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-08-13T02:39:24Z","updated_at":"2024-12-03T16:02:00Z","closed_at":"2024-12-03T16:01:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello. I believe a found a bug. It doesn't make HTTP response incorrect but it effectively disables connection reusing.\r\nI drew a diagram for such case.\r\n![reqwest-bug-diagram](https://github.com/user-attachments/assets/f1a7fd97-7919-4c6e-b7b9-15c98a5c681b)\r\nAs you can see Client (with activated `gzip` feature) sends request to server. Server responds with chunked gzipped body, but body somehow is fragmented at TCP level (see diagram) and those fragments are divided by some time (milliseconds at least, so you can't `read()` them together with one call). But first fragment contains **whole** gzipped bytes.\r\nGzip decoder returns (and, as consequence, Response::text() call too) immediately after decoding **last encoded** byte, i.e. it doesn't wait for full response body arrival. And then Response is dropped (because Response::text() consumes Response). And it prevents connection from being put back in pool and being reused (because connection itself is still waiting for bytes from server).\r\n\r\nI created minimal reproduction https://github.com/Andrey36652/reqwest-chunked-bug where client shoud make 3 consecutive requests to the server that responds with fragmented body (there is a 4 seconds delay between the fragments, so it should be ~12 seconds in total). But when I run it, all 3 requests are resolved immediately as you can see from timestamps (and each uses new connection).\r\n```log\r\n2024-08-13T02:27:51.666326Z  INFO reqwest_chunked_bug::server: Listening on 127.0.0.1:9955        \r\n2024-08-13T02:27:51.666796Z  INFO reqwest_chunked_bug::client: ---------- start request ----------\r\n2024-08-13T02:27:51.667219Z TRACE hyper_util::client::legacy::pool: checkout waiting for idle connection: (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:27:51.668027Z DEBUG reqwest::connect: starting new connection: http://127.0.0.1:9955/    \r\n2024-08-13T02:27:51.668307Z TRACE hyper_util::client::legacy::connect::http: Http::connect; scheme=Some(\"http\"), host=Some(\"127.0.0.1\"), port=Some(Port(9955))\r\n2024-08-13T02:27:51.668727Z DEBUG hyper_util::client::legacy::connect::http: connecting to 127.0.0.1:9955\r\n2024-08-13T02:27:51.669974Z DEBUG hyper_util::client::legacy::connect::http: connected to 127.0.0.1:9955\r\n2024-08-13T02:27:51.670344Z TRACE hyper_util::client::legacy::client: http1 handshake complete, spawning background dispatcher task\r\n2024-08-13T02:27:51.671059Z TRACE hyper_util::client::legacy::pool: checkout dropped for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:27:51.671067Z  INFO reqwest_chunked_bug::server: Accepted connection from 127.0.0.1:51348\r\n2024-08-13T02:27:51.671447Z TRACE reqwest::connect::verbose: 9a08e68e write (vectored): b\"GET / HTTP/1.1\\r\\naccept: */*\\r\\naccept-encoding: gzip\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:27:51.671533Z  INFO reqwest_chunked_bug::server: Read request from client: \"GET / HTTP/1.1\\r\\naccept: */*\\r\\naccept-encoding: gzip\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"\r\n2024-08-13T02:27:51.671811Z  INFO reqwest_chunked_bug::server: First part of response has been sent\r\n2024-08-13T02:27:51.671815Z TRACE reqwest::connect::verbose: TODO: verbose poll_read    \r\n2024-08-13T02:27:51.672606Z  INFO reqwest_chunked_bug::client: result: {\"symbol\":\"BTCUSDT\",\"openInterest\":\"70056.543\",\"time\":1723425441998}\r\n2024-08-13T02:27:51.672884Z  INFO reqwest_chunked_bug::client: ---------- end request ----------\r\n2024-08-13T02:27:51.673036Z  INFO reqwest_chunked_bug::client: ---------- start request ----------\r\n2024-08-13T02:27:51.673269Z TRACE hyper_util::client::legacy::pool: checkout waiting for idle connection: (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:27:51.673423Z DEBUG reqwest::connect: starting new connection: http://127.0.0.1:9955/    \r\n2024-08-13T02:27:51.673608Z TRACE hyper_util::client::legacy::connect::http: Http::connect; scheme=Some(\"http\"), host=Some(\"127.0.0.1\"), port=Some(Port(9955))\r\n2024-08-13T02:27:51.673722Z DEBUG hyper_util::client::legacy::connect::http: connecting to 127.0.0.1:9955\r\n2024-08-13T02:27:51.674025Z DEBUG hyper_util::client::legacy::connect::http: connected to 127.0.0.1:9955\r\n2024-08-13T02:27:51.674027Z  INFO reqwest_chunked_bug::server: Accepted connection from 127.0.0.1:51349\r\n2024-08-13T02:27:51.674169Z TRACE hyper_util::client::legacy::client: http1 handshake complete, spawning background dispatcher task\r\n2024-08-13T02:27:51.674343Z TRACE hyper_util::client::legacy::pool: checkout dropped for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:27:51.674486Z TRACE reqwest::connect::verbose: 866a12cc write (vectored): b\"GET / HTTP/1.1\\r\\naccept: */*\\r\\naccept-encoding: gzip\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:27:51.674500Z  INFO reqwest_chunked_bug::server: Read request from client: \"GET / HTTP/1.1\\r\\naccept: */*\\r\\naccept-encoding: gzip\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"\r\n2024-08-13T02:27:51.674680Z  INFO reqwest_chunked_bug::server: First part of response has been sent\r\n2024-08-13T02:27:51.674744Z TRACE reqwest::connect::verbose: TODO: verbose poll_read    \r\n2024-08-13T02:27:51.675520Z  INFO reqwest_chunked_bug::client: result: {\"symbol\":\"BTCUSDT\",\"openInterest\":\"70056.543\",\"time\":1723425441998}\r\n2024-08-13T02:27:51.675780Z  INFO reqwest_chunked_bug::client: ---------- end request ----------\r\n2024-08-13T02:27:51.676093Z  INFO reqwest_chunked_bug::client: ---------- start request ----------\r\n2024-08-13T02:27:51.676354Z TRACE hyper_util::client::legacy::pool: checkout waiting for idle connection: (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:27:51.676575Z DEBUG reqwest::connect: starting new connection: http://127.0.0.1:9955/\r\n2024-08-13T02:27:51.676834Z TRACE hyper_util::client::legacy::connect::http: Http::connect; scheme=Some(\"http\"), host=Some(\"127.0.0.1\"), port=Some(Port(9955))\r\n2024-08-13T02:27:51.677125Z DEBUG hyper_util::client::legacy::connect::http: connecting to 127.0.0.1:9955\r\n2024-08-13T02:27:51.677489Z DEBUG hyper_util::client::legacy::connect::http: connected to 127.0.0.1:9955\r\n2024-08-13T02:27:51.677773Z TRACE hyper_util::client::legacy::client: http1 handshake complete, spawning background dispatcher task\r\n2024-08-13T02:27:51.678187Z  INFO reqwest_chunked_bug::server: Accepted connection from 127.0.0.1:51350\r\n2024-08-13T02:27:51.678194Z TRACE hyper_util::client::legacy::pool: checkout dropped for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:27:51.678778Z TRACE reqwest::connect::verbose: 1110a507 write (vectored): b\"GET / HTTP/1.1\\r\\naccept: */*\\r\\naccept-encoding: gzip\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"\r\n2024-08-13T02:27:51.678844Z  INFO reqwest_chunked_bug::server: Read request from client: \"GET / HTTP/1.1\\r\\naccept: */*\\r\\naccept-encoding: gzip\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"\r\n2024-08-13T02:27:51.679286Z  INFO reqwest_chunked_bug::server: First part of response has been sent\r\n2024-08-13T02:27:51.679322Z TRACE reqwest::connect::verbose: TODO: verbose poll_read\r\n2024-08-13T02:27:51.679771Z  INFO reqwest_chunked_bug::client: result: {\"symbol\":\"BTCUSDT\",\"openInterest\":\"70056.543\",\"time\":1723425441998}\r\n2024-08-13T02:27:51.679920Z  INFO reqwest_chunked_bug::client: ---------- end request ----------\r\n2024-08-13T02:27:55.679025Z  INFO reqwest_chunked_bug::server: Second part of response has been sent\r\n2024-08-13T02:27:55.679020Z  INFO reqwest_chunked_bug::server: Second part of response has been sent\r\nthread 'thread 'tokio-runtime-worker' panicked at src\\server.rstokio-runtime-worker:' panicked at 27src\\server.rs::1427:\r\n:read_http_request failed: Os { code: 10053, kind: ConnectionAborted, message: \"Программа на вашем хост-компьютере разорвала установленное подключение.\" }14:\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\nread_http_request failed: Os { code: 10053, kind: ConnectionAborted, message: \"Программа на вашем хост-компьютере разорвала установленное подключение.\" }   \r\n2024-08-13T02:27:55.682262Z  INFO reqwest_chunked_bug::server: Second part of response has been sent\r\nthread 'tokio-runtime-worker' panicked at src\\server.rs:27:14:\r\nread_http_request failed: Os { code: 10053, kind: ConnectionAborted, message: \"Программа на вашем хост-компьютере разорвала установленное подключение.\" }\r\n```\r\nIf I disable gzip deconding in Client (uncomment line in `src/client.rs`) then behaviour is correct - each request waits until full body will be consumed and returns only after that moment.\r\n```log\r\n2024-08-13T02:30:18.447052Z  INFO reqwest_chunked_bug::server: Listening on 127.0.0.1:9955\r\n2024-08-13T02:30:18.447729Z  INFO reqwest_chunked_bug::client: ---------- start request ----------\r\n2024-08-13T02:30:18.448322Z TRACE hyper_util::client::legacy::pool: checkout waiting for idle connection: (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:18.448508Z DEBUG reqwest::connect: starting new connection: http://127.0.0.1:9955/    \r\n2024-08-13T02:30:18.448700Z TRACE hyper_util::client::legacy::connect::http: Http::connect; scheme=Some(\"http\"), host=Some(\"127.0.0.1\"), port=Some(Port(9955))\r\n2024-08-13T02:30:18.448808Z DEBUG hyper_util::client::legacy::connect::http: connecting to 127.0.0.1:9955\r\n2024-08-13T02:30:18.449165Z DEBUG hyper_util::client::legacy::connect::http: connected to 127.0.0.1:9955\r\n2024-08-13T02:30:18.449332Z TRACE hyper_util::client::legacy::client: http1 handshake complete, spawning background dispatcher task\r\n2024-08-13T02:30:18.449507Z TRACE hyper_util::client::legacy::pool: checkout dropped for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:18.449509Z  INFO reqwest_chunked_bug::server: Accepted connection from 127.0.0.1:54654\r\n2024-08-13T02:30:18.449771Z TRACE reqwest::connect::verbose: 4e2ae2db write (vectored): b\"GET / HTTP/1.1\\r\\naccept: */*\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:30:18.449804Z  INFO reqwest_chunked_bug::server: Read request from client: \"GET / HTTP/1.1\\r\\naccept: */*\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:30:18.449960Z  INFO reqwest_chunked_bug::server: First part of response has been sent\r\n2024-08-13T02:30:18.449976Z TRACE reqwest::connect::verbose: TODO: verbose poll_read\r\n2024-08-13T02:30:22.462205Z  INFO reqwest_chunked_bug::server: Second part of response has been sent\r\n2024-08-13T02:30:22.462967Z TRACE reqwest::connect::verbose: TODO: verbose poll_read    \r\n2024-08-13T02:30:22.463353Z TRACE hyper_util::client::legacy::pool: put; add idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:22.463426Z  INFO reqwest_chunked_bug::client: result: ▼♥�V*��M��Q�Rr\r\nv♫      Q�Q�/H���+I-J-.☺J�↑��陚↑♥�J2sS��♀͍�M�LML♀---j☺�Gb;D\r\n2024-08-13T02:30:22.463662Z DEBUG hyper_util::client::legacy::pool: pooling idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:22.464137Z  INFO reqwest_chunked_bug::client: ---------- end request ----------\r\n2024-08-13T02:30:22.464510Z  INFO reqwest_chunked_bug::client: ---------- start request ----------\r\n2024-08-13T02:30:22.464760Z TRACE hyper_util::client::legacy::pool: take? (\"http\", 127.0.0.1:9955): expiration = Some(300s)\r\n2024-08-13T02:30:22.464959Z DEBUG hyper_util::client::legacy::pool: reuse idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:22.465213Z TRACE reqwest::connect::verbose: 4e2ae2db write (vectored): b\"GET / HTTP/1.1\\r\\naccept: */*\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:30:22.465264Z  INFO reqwest_chunked_bug::server: Read request from client: \"GET / HTTP/1.1\\r\\naccept: */*\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:30:22.465597Z  INFO reqwest_chunked_bug::server: First part of response has been sent\r\n2024-08-13T02:30:22.465606Z TRACE reqwest::connect::verbose: TODO: verbose poll_read\r\n2024-08-13T02:30:26.475653Z  INFO reqwest_chunked_bug::server: Second part of response has been sent\r\n2024-08-13T02:30:26.476240Z TRACE reqwest::connect::verbose: TODO: verbose poll_read    \r\n2024-08-13T02:30:26.476739Z TRACE hyper_util::client::legacy::pool: put; add idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:26.476800Z  INFO reqwest_chunked_bug::client: result: ▼♥�V*��M��Q�Rr\r\nv♫      Q�Q�/H���+I-J-.☺J�↑��陚↑♥�J2sS��♀͍�M�LML♀---j☺�Gb;D\r\n2024-08-13T02:30:26.477604Z  INFO reqwest_chunked_bug::client: ---------- end request ----------\r\n2024-08-13T02:30:26.477081Z DEBUG hyper_util::client::legacy::pool: pooling idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:26.477836Z  INFO reqwest_chunked_bug::client: ---------- start request ----------\r\n2024-08-13T02:30:26.478274Z TRACE hyper_util::client::legacy::pool: take? (\"http\", 127.0.0.1:9955): expiration = Some(300s)\r\n2024-08-13T02:30:26.478447Z DEBUG hyper_util::client::legacy::pool: reuse idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:26.478758Z TRACE reqwest::connect::verbose: 4e2ae2db write (vectored): b\"GET / HTTP/1.1\\r\\naccept: */*\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:30:26.478780Z  INFO reqwest_chunked_bug::server: Read request from client: \"GET / HTTP/1.1\\r\\naccept: */*\\r\\nhost: 127.0.0.1:9955\\r\\n\\r\\n\"    \r\n2024-08-13T02:30:26.479189Z  INFO reqwest_chunked_bug::server: First part of response has been sent\r\n2024-08-13T02:30:26.479201Z TRACE reqwest::connect::verbose: TODO: verbose poll_read\r\n2024-08-13T02:30:30.483203Z  INFO reqwest_chunked_bug::server: Second part of response has been sent\r\n2024-08-13T02:30:30.484606Z TRACE reqwest::connect::verbose: TODO: verbose poll_read    \r\n2024-08-13T02:30:30.485787Z TRACE hyper_util::client::legacy::pool: put; add idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:30.485925Z  INFO reqwest_chunked_bug::client: result: ▼♥�V*��M��Q�Rr\r\nv♫      Q�Q�/H���+I-J-.☺J�↑��陚↑♥�J2sS��♀͍�M�LML♀---j☺�Gb;D\r\n2024-08-13T02:30:30.488265Z  INFO reqwest_chunked_bug::client: ---------- end request ----------\r\n2024-08-13T02:30:30.486928Z DEBUG hyper_util::client::legacy::pool: pooling idle connection for (\"http\", 127.0.0.1:9955)\r\n2024-08-13T02:30:30.489721Z  WARN reqwest_chunked_bug::server: Connection closed by client\r\n```\r\nI don't know if an error is in `reqwest` or in `async-compression` crate, and I'm afraid my knowledge isn't enough to find a solution.","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/seanmonstar/reqwest/issues/2381/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/2381/timeline","performed_via_github_app":null,"state_reason":"completed"}