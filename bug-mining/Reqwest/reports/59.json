{"url":"https://api.github.com/repos/seanmonstar/reqwest/issues/1080","repository_url":"https://api.github.com/repos/seanmonstar/reqwest","labels_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/1080/labels{/name}","comments_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/1080/comments","events_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/1080/events","html_url":"https://github.com/seanmonstar/reqwest/issues/1080","id":738965080,"node_id":"MDU6SXNzdWU3Mzg5NjUwODA=","number":1080,"title":"HTTPS System proxies are not interpreted correctly on Windows","user":{"login":"federico-terzi","id":20475953,"node_id":"MDQ6VXNlcjIwNDc1OTUz","avatar_url":"https://avatars.githubusercontent.com/u/20475953?v=4","gravatar_id":"","url":"https://api.github.com/users/federico-terzi","html_url":"https://github.com/federico-terzi","followers_url":"https://api.github.com/users/federico-terzi/followers","following_url":"https://api.github.com/users/federico-terzi/following{/other_user}","gists_url":"https://api.github.com/users/federico-terzi/gists{/gist_id}","starred_url":"https://api.github.com/users/federico-terzi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/federico-terzi/subscriptions","organizations_url":"https://api.github.com/users/federico-terzi/orgs","repos_url":"https://api.github.com/users/federico-terzi/repos","events_url":"https://api.github.com/users/federico-terzi/events{/privacy}","received_events_url":"https://api.github.com/users/federico-terzi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-11-09T11:57:02Z","updated_at":"2020-11-11T14:26:45Z","closed_at":"2020-11-11T14:26:45Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"@seanmonstar First of all, thank you for the great library and your work!\r\n\r\nI noticed a bug in the Windows system HTTPS proxy handling, in particular:\r\n* After https://github.com/seanmonstar/reqwest/pull/1005 multiple proxies are detected correctly on Windows, but requests to HTTPS domains cause the client to hang, and then fail with `The token supplied to the function is invalid`, which is the same problem reported in https://github.com/seanmonstar/reqwest/issues/416\r\n* After a bit of digging, I found the root cause of the problem. In particular, when loading the proxy settings from the registry, Reqwest makes the assumption that an HTTPS proxy should go through the HTTPS protocol, which is not the case. In general, HTTPS requests are sent to the proxy using the HTTP protocol, and then the proxy will tunnel them as TCP packets.\r\n\r\nWhen setting up a test proxy, (using Fiddler), the Windows registry entry will contain the value:\r\n\r\n```\r\nhttp=127.0.0.1:8888;https=127.0.0.1:8888\r\n```\r\n\r\nand Reqwest will interpret those as:\r\n\r\n```\r\nHTTP_PROXY=http://127.0.0.1:8888\r\nHTTPS_PROXY=https://127.0.0.1:8888\r\n```\r\n\r\nUnfortunately, this is most likely incorrect, as the HTTPS proxy should use the http protocol as well:\r\n\r\n```\r\nHTTP_PROXY=http://127.0.0.1:8888\r\nHTTPS_PROXY=http://127.0.0.1:8888\r\n```\r\n\r\nI consider it a bug and not expected behavior as most other http libraries (of other languages, such as Python) and webbrowsers are handling the proxy correctly, using the HTTP protocol.\r\n\r\n### How to reproduce\r\n\r\n1. Download and start [Fiddler](https://www.telerik.com/fiddler)\r\n2. Fiddler will automatically setup a proxy at 127.0.0.1:8888, including this entry in the Windows registry: `http=127.0.0.1:8888;https=127.0.0.1:8888`\r\n3. The following code will hang and then fail with error: `Error: reqwest::Error { kind: Request, url: Url { scheme: \"https\", host: Some(Domain(\"httpbin.org\")), port: None, path: \"/ip\", query: None, fragment: None }, source: hyper::Error(Connect, Os { code: -2146893048, kind: \r\nOther, message: \"The token supplied to the function is invalid\" }) }`\r\n\r\n```rust\r\nuse tokio::*;\r\nuse std::collections::HashMap;\r\n\r\n#[tokio::main]\r\nasync fn main() -> Result<(), Box<dyn std::error::Error>> {\r\n    let client = reqwest::Client::builder()\r\n    //.proxy(reqwest::Proxy::https(\"http://127.0.0.1:8888\")?)\r\n    .build()?;\r\n    let resp = client.get(\"https://httpbin.org/ip\").send().await?\r\n        .json::<HashMap<String, String>>()\r\n        .await?;\r\n    println!(\"{:#?}\", resp);\r\n    Ok(())\r\n}\r\n```\r\n\r\nForcing the HTTPS proxy to go though http by uncommenting the line will fix the error and behave as expected.","closed_by":{"login":"seanmonstar","id":51479,"node_id":"MDQ6VXNlcjUxNDc5","avatar_url":"https://avatars.githubusercontent.com/u/51479?v=4","gravatar_id":"","url":"https://api.github.com/users/seanmonstar","html_url":"https://github.com/seanmonstar","followers_url":"https://api.github.com/users/seanmonstar/followers","following_url":"https://api.github.com/users/seanmonstar/following{/other_user}","gists_url":"https://api.github.com/users/seanmonstar/gists{/gist_id}","starred_url":"https://api.github.com/users/seanmonstar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seanmonstar/subscriptions","organizations_url":"https://api.github.com/users/seanmonstar/orgs","repos_url":"https://api.github.com/users/seanmonstar/repos","events_url":"https://api.github.com/users/seanmonstar/events{/privacy}","received_events_url":"https://api.github.com/users/seanmonstar/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/seanmonstar/reqwest/issues/1080/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/seanmonstar/reqwest/issues/1080/timeline","performed_via_github_app":null,"state_reason":"completed"}