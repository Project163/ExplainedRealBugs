{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2140","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2140/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2140/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2140/events","html_url":"https://github.com/diesel-rs/diesel/issues/2140","id":478540946,"node_id":"MDU6SXNzdWU0Nzg1NDA5NDY=","number":2140,"title":"Missing parenthesis lead to broken SQL queries","user":{"login":"DNNX","id":447953,"node_id":"MDQ6VXNlcjQ0Nzk1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/447953?v=4","gravatar_id":"","url":"https://api.github.com/users/DNNX","html_url":"https://github.com/DNNX","followers_url":"https://api.github.com/users/DNNX/followers","following_url":"https://api.github.com/users/DNNX/following{/other_user}","gists_url":"https://api.github.com/users/DNNX/gists{/gist_id}","starred_url":"https://api.github.com/users/DNNX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DNNX/subscriptions","organizations_url":"https://api.github.com/users/DNNX/orgs","repos_url":"https://api.github.com/users/DNNX/repos","events_url":"https://api.github.com/users/DNNX/events{/privacy}","received_events_url":"https://api.github.com/users/DNNX/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/diesel-rs/diesel/milestones/16","html_url":"https://github.com/diesel-rs/diesel/milestone/16","labels_url":"https://api.github.com/repos/diesel-rs/diesel/milestones/16/labels","id":3954983,"node_id":"MDk6TWlsZXN0b25lMzk1NDk4Mw==","number":16,"title":"2.0","description":"","creator":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":40,"state":"closed","created_at":"2019-01-09T08:56:03Z","updated_at":"2024-11-24T07:42:53Z","due_on":null,"closed_at":"2022-10-27T10:21:27Z"},"comments":7,"created_at":"2019-08-08T15:26:35Z","updated_at":"2020-10-05T15:32:54Z","closed_at":"2020-10-05T15:32:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nIf you want to report a bug, we added some points below you can fill out. If you want to request a feature, feel free to remove all the irrelevant text. In addition to this [issue tracker](https://github.com/diesel-rs/diesel/issues), you can also talk to Diesel maintainers and users on [Gitter](https://gitter.im/diesel-rs/diesel).\r\n-->\r\n\r\n## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** rustc 1.36.0 (a53f9df32 2019-07-03)\r\n- **Diesel:** latest master (0cacfa080183076669112a5ccb192d9c30b8ac15)\r\n- **Database:** psql (11.1, server 11.4 (Debian 11.4-1.pgdg90+1))\r\n- **Operating System** Debian 11.4-1.pgdg90+1\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** postgres\r\n\r\n## Problem Description\r\n\r\nMissing parentheses around equality operator lead to malformed SQL queries in the best case and wrong SQL queries silently returning incorrect results in the worst case.\r\n\r\n### What are you trying to accomplish?\r\n\r\nBuild a query which corresponds to something like this:\r\n\r\n```sql\r\nSELECT (1 > 0) = true\r\n```\r\n\r\nTranslating this to diesel, the code will look like this:\r\n\r\n```rust\r\nnumbers.select((n.gt(0)).eq(true));\r\n```\r\n\r\nFull runnable test can be found in my `operator-precedence-bug` branch of diesel. Here is the full test https://github.com/DNNX/diesel/compare/master...operator-precedence-bug which can be run with `(cd diesel_tests && cargo test --features \"postgres\" --no-default-features expressions::test_operator_precedence)`.\r\n\r\n### What is the expected output?\r\n\r\nGreen test.\r\n\r\n### What is the actual output?\r\n\r\n```\r\nâžœ  diesel git:(operator-precedence-bug) âœ— (cd diesel_tests && cargo test --features \"postgres\" --no-default-features expressions::test_operator_precedence)\r\n   Compiling diesel_tests v0.1.0 (/Users/dnnx/work/diesel/diesel_tests)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 12.26s\r\n     Running /Users/dnnx/work/diesel/target/debug/deps/integration_tests-514980afda54a7bd\r\n\r\nrunning 1 test\r\ntest expressions::test_operator_precedence ... FAILED\r\n\r\nfailures:\r\n\r\n---- expressions::test_operator_precedence stdout ----\r\nthread 'expressions::test_operator_precedence' panicked at 'assertion failed: `(left == right)`\r\n  left: `Ok(true)`,\r\n right: `Err(DatabaseError(__Unknown, \"syntax error at or near \\\"=\\\"\"))`', diesel_tests/tests/expressions/mod.rs:469:5\r\nnote: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\r\n\r\n\r\nfailures:\r\n    expressions::test_operator_precedence\r\n\r\ntest result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 309 filtered out\r\n\r\nerror: test failed, to rerun pass '--test integration_tests'\r\n```\r\n\r\n### Are you seeing any additional errors?\r\n\r\nNo.\r\n\r\n### Steps to reproduce\r\n\r\n1. Check our my branch or apply the diff below to latest diesel master.\r\n2. Run `(cd diesel_tests && cargo test --features \"postgres\" --no-default-features expressions::test_operator_precedence).\r\n\r\n```diff\r\ndiff --git a/diesel_tests/tests/expressions/mod.rs b/diesel_tests/tests/expressions/mod.rs\r\nindex e6cd0b1e..2dbd584c 100644\r\n--- a/diesel_tests/tests/expressions/mod.rs\r\n+++ b/diesel_tests/tests/expressions/mod.rs\r\n@@ -454,3 +454,17 @@ fn test_arrays_b() {\r\n \r\n     assert_eq!(value, vec![7, 14]);\r\n }\r\n+\r\n+#[test]\r\n+fn test_operator_precedence() {\r\n+    use self::numbers::columns::*;\r\n+    use self::numbers::table as numbers;\r\n+\r\n+    let connection = connection();\r\n+    connection\r\n+        .execute(\"INSERT INTO numbers (n) VALUES (2)\")\r\n+        .unwrap();\r\n+    let source = numbers.select((n.gt(0)).eq(true));\r\n+\r\n+    assert_eq!(Ok(true), source.first(&connection));\r\n+}\r\n```\r\n\r\n### Additional notes\r\n\r\nI already raised this issue in https://github.com/diesel-rs/diesel/issues/2133#issuecomment-517470349, but I probably failed to express myself very clearly. \r\n\r\nThe big problem with this bug is that it may result in incorrectly working SQL queries, in particular in Mysql. Mysql is less strict about queries, so it parses things like `select 2=2=2=2` just fine, whereas Postgres rejects such queries.\r\n\r\nI tried to fix the bug myself, but I don't even know where to start. I think adding parentheses around every operator might be a solution, but there's one subtle issue with it: diesel also uses `eq` to generate `SET` part of the `UPDATE` statements - and there having parentheses around `x = <expr>` in `UPDATE foo SET x = <expr>` will be a problem.\r\n\r\n<!--\r\nPlease include as much of your codebase as needed to reproduce the error.  If the relevant files are large, please consider linking to a public repository or a [Gist](https://gist.github.com/).\r\n\r\nPlease post as much of your database schema as necessary. If you are using `infer_schema!`, you can use `diesel print-schema` and post the relevant parts from that.\r\n-->\r\n\r\n## Checklist\r\n\r\n- [x] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues) for similar issues.\r\n- [x] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n\r\n<!--\r\nThank you for your submission!  You're helping make Diesel more robust ðŸŽ‰\r\n\r\nWe'll try to respond as quickly as possible.\r\n-->\r\n","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2140/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2140/timeline","performed_via_github_app":null,"state_reason":"completed"}