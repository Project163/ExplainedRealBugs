{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2001","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2001/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2001/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2001/events","html_url":"https://github.com/diesel-rs/diesel/issues/2001","id":415402818,"node_id":"MDU6SXNzdWU0MTU0MDI4MTg=","number":2001,"title":"left_join makes it possible to try to stuff nullable values into a non-nullable Queryable","user":{"login":"icefoxen","id":1335133,"node_id":"MDQ6VXNlcjEzMzUxMzM=","avatar_url":"https://avatars.githubusercontent.com/u/1335133?v=4","gravatar_id":"","url":"https://api.github.com/users/icefoxen","html_url":"https://github.com/icefoxen","followers_url":"https://api.github.com/users/icefoxen/followers","following_url":"https://api.github.com/users/icefoxen/following{/other_user}","gists_url":"https://api.github.com/users/icefoxen/gists{/gist_id}","starred_url":"https://api.github.com/users/icefoxen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icefoxen/subscriptions","organizations_url":"https://api.github.com/users/icefoxen/orgs","repos_url":"https://api.github.com/users/icefoxen/repos","events_url":"https://api.github.com/users/icefoxen/events{/privacy}","received_events_url":"https://api.github.com/users/icefoxen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2019-02-28T01:21:31Z","updated_at":"2019-12-30T21:51:20Z","closed_at":"2019-12-30T21:51:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Setup\r\n\r\nPardon the vagueness, my database-fu is too weak to know how to explain this more concisely.  This is also slightly simplified so that I can try to explain it at all.\r\n\r\nWe have two tables, TableA and TableB.  We have two `Queryable` structs, `QueryA` and `QueryB`.  TableA and TableB have no nullable fields, and `QueryA` and `QueryB` contain no `Options`, and life is good.\r\n\r\nNow we add this:\r\n\r\n```rust\r\n#[derive(Queryable, ...)]\r\nstruct QueryC {\r\n    a: QueryA,\r\n    b: QueryB,\r\n}\r\n```\r\n\r\nWe can write a diesel query that does an inner join on A and B and stuffs the result into `QueryC`, and it works:  `table_a::dsl::table_a.inner_join(table_b::dsl::table_b).select(...).get_results<QueryC>()`.\r\n\r\nHowever, when we do a `left_join()` instead, it *compiles* but panics at runtime with `'Could not get crate list?: DeserializationError(UnexpectedNullError)'`.  The `left_join()` produces, basically, `(QueryA, Option<QueryB>)` but that's not what `QueryC` expects, and trying to make it contain that fails to compile.\r\n\r\n...except now that I test more, it *does* not-compile, as is correct, but when you do what I'm actually trying to do (which is wrap the whole bloody thing in *yet another* inner join) it fails.  Heck, I'm just going to give you the raw code:\r\n\r\n```rust\r\ntable! {\r\n    crates (id) {\r\n        id -> Int8,\r\n        name -> Varchar,\r\n    }\r\n}\r\n\r\ntable! {\r\n    crate_versions (id) {\r\n        id -> Int8,\r\n        crate_id -> Int8,\r\n        version -> Varchar,\r\n        checksum -> Varchar,\r\n        yanked -> Bool,\r\n    }\r\n}\r\n\r\ntable! {\r\n    analyze_cratefile (id) {\r\n        id -> Int8,\r\n        crate_versions_id -> Int8,\r\n        size -> Int8,\r\n        valid -> Bool,\r\n        checksum_matches -> Bool,\r\n    }\r\n}\r\n\r\n    // This is the bit that compiles and shouldn't, and panics at runtime\r\n    let crate_versions = c::crates\r\n        .inner_join(cv::crate_versions.left_join(ac::analyze_cratefile))\r\n        .select((\r\n            (cv::id, c::name, cv::version, cv::checksum, cv::yanked),\r\n            (ac::size, ac::valid, ac::checksum_matches),\r\n        ))\r\n        .order_by(c::name)\r\n        .get_results::<CrateWithAnalysis>(conn)\r\n        .expect(\"Could not get crate list?\");\r\n```\r\n\r\nI hope you can make heads or tails of this, 'cause I can't.  Please let me know if you need any more information and I'll try to provide, once I've had more than six hours of sleep.\r\n\r\n### Versions\r\n\r\n- **Rust:** 1.32\r\n- **Diesel:** 1.4\r\n- **Database:** PostgreSQL 11\r\n- **Operating System** Linux\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** postgres, extras\r\n\r\n## Checklist\r\n\r\n- [x] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues) for similar issues.\r\n- [x] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2001/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2001/timeline","performed_via_github_app":null,"state_reason":"completed"}