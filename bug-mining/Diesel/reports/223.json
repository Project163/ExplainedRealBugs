{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3301","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3301/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3301/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3301/events","html_url":"https://github.com/diesel-rs/diesel/issues/3301","id":1357683985,"node_id":"I_kwDOAnrqL85Q7J0R","number":3301,"title":"minor: create_database_if_needed assumes URL is a path","user":{"login":"silas-enf","id":99698483,"node_id":"U_kgDOBfFHMw","avatar_url":"https://avatars.githubusercontent.com/u/99698483?v=4","gravatar_id":"","url":"https://api.github.com/users/silas-enf","html_url":"https://github.com/silas-enf","followers_url":"https://api.github.com/users/silas-enf/followers","following_url":"https://api.github.com/users/silas-enf/following{/other_user}","gists_url":"https://api.github.com/users/silas-enf/gists{/gist_id}","starred_url":"https://api.github.com/users/silas-enf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silas-enf/subscriptions","organizations_url":"https://api.github.com/users/silas-enf/orgs","repos_url":"https://api.github.com/users/silas-enf/repos","events_url":"https://api.github.com/users/silas-enf/events{/privacy}","received_events_url":"https://api.github.com/users/silas-enf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193212,"node_id":"MDU6TGFiZWwyNTQxOTMyMTI=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-31T18:08:24Z","updated_at":"2022-09-21T18:25:42Z","closed_at":"2022-09-21T18:25:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Gonna ignore the template since I just found this from reading diesel_cli's source; sorry if that's a problem.\r\n\r\n```\r\n/// Creates the database specified in the connection url. It returns an error\r\n/// it was unable to create the database.\r\nfn create_database_if_needed(database_url: &str) -> DatabaseResult<()> {\r\n    match Backend::for_url(database_url) {\r\n        #[cfg(feature = \"postgres\")]\r\n        Backend::Pg => {\r\n            if PgConnection::establish(database_url).is_err() {\r\n                let (database, postgres_url) = change_database_of_url(database_url, \"postgres\");\r\n                println!(\"Creating database: {}\", database);\r\n                let mut conn = PgConnection::establish(&postgres_url)?;\r\n                query_helper::create_database(&database).execute(&mut conn)?;\r\n            }\r\n        }\r\n        #[cfg(feature = \"sqlite\")]\r\n        Backend::Sqlite => {\r\n            if !::std::path::Path::new(database_url).exists() {\r\n                println!(\"Creating database: {}\", database_url);\r\n                SqliteConnection::establish(database_url)?;\r\n            }\r\n        }\r\n        #[cfg(feature = \"mysql\")]\r\n        Backend::Mysql => {\r\n            if MysqlConnection::establish(database_url).is_err() {\r\n                let (database, mysql_url) =\r\n                    change_database_of_url(database_url, \"information_schema\");\r\n                println!(\"Creating database: {}\", database);\r\n                let mut conn = MysqlConnection::establish(&mysql_url)?;\r\n                query_helper::create_database(&database).execute(&mut conn)?;\r\n            }\r\n        }\r\n    }\r\n\r\n    Ok(())\r\n}\r\n```\r\n\r\n[Permalink to problem line](https://github.com/diesel-rs/diesel/blob/1327fba7b2d0419b631e4ff24e4ca430d62fc2fe/diesel_cli/src/database.rs#L175).\r\n\r\nThe `Backend::Sqlite` case assumes that `database_url` is a bare path (as opposed to, say, a `file:` URL, which is otherwise valid) when checking if the path exists, so it may enter the wrong branch if given a non-path argument (e.g. if given a `file:///foo/bar` url, this code seems to check for a relative path `file:/foo/bar` instead of an absolute path `/foo/bar`).","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3301/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3301/timeline","performed_via_github_app":null,"state_reason":"completed"}