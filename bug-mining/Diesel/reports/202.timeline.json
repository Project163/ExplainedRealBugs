[{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/512159258","html_url":"https://github.com/diesel-rs/diesel/issues/2123#issuecomment-512159258","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2123","id":512159258,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMjE1OTI1OA==","user":{"login":"KeenS","id":4434568,"node_id":"MDQ6VXNlcjQ0MzQ1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/4434568?v=4","gravatar_id":"","url":"https://api.github.com/users/KeenS","html_url":"https://github.com/KeenS","followers_url":"https://api.github.com/users/KeenS/followers","following_url":"https://api.github.com/users/KeenS/following{/other_user}","gists_url":"https://api.github.com/users/KeenS/gists{/gist_id}","starred_url":"https://api.github.com/users/KeenS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeenS/subscriptions","organizations_url":"https://api.github.com/users/KeenS/orgs","repos_url":"https://api.github.com/users/KeenS/repos","events_url":"https://api.github.com/users/KeenS/events{/privacy}","received_events_url":"https://api.github.com/users/KeenS/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-17T08:36:17Z","updated_at":"2019-07-17T08:36:17Z","body":"FYI, here are logs, one is diesel's, which I got by modifying diesel, and the other is PostgreSQL, which shows how nested transactions behave.\r\n\r\n```\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:99] transaction_manager = AnsiTransactionManager {\r\n    transaction_depth: Cell {\r\n        value: 0,\r\n    },\r\n}\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:99] dbg!(transaction_manager).begin_transaction(self) = Ok(\r\n    (),\r\n)\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:99] transaction_manager = AnsiTransactionManager {\r\n    transaction_depth: Cell {\r\n        value: 1,\r\n    },\r\n}\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:99] dbg!(transaction_manager).begin_transaction(self) = Ok(\r\n    (),\r\n)\r\nerror occurred: column \"foo\" does not exist\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:102] transaction_manager = AnsiTransactionManager {\r\n    transaction_depth: Cell {\r\n        value: 2,\r\n    },\r\n}\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:102] dbg!(transaction_manager).commit_transaction(self) = Err(\r\n    DatabaseError(\r\n        __Unknown,\r\n        \"current transaction is aborted, commands ignored until end of transaction block\",\r\n    ),\r\n)\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:106] transaction_manager = AnsiTransactionManager {\r\n    transaction_depth: Cell {\r\n        value: 2,\r\n    },\r\n}\r\n[/home/shun/Rust/diesel/diesel/src/connection/mod.rs:106] dbg!(transaction_manager).rollback_transaction(self) = Ok(\r\n    (),\r\n)\r\nErr(DatabaseError(__Unknown, \"current transaction is aborted, commands ignored until end of transaction block\"))\r\n[/home/shun/Rust/diesel/diesel/src/pg/transaction.rs:282] transaction_manager = AnsiTransactionManager {\r\n    transaction_depth: Cell {\r\n        value: 1,\r\n    },\r\n}\r\n[/home/shun/Rust/diesel/diesel/src/pg/transaction.rs:282] dbg!(transaction_manager).begin_transaction_sql(self.connection, &sql) = Err(\r\n    AlreadyInTransaction,\r\n)\r\nErr(AlreadyInTransaction)\r\n```\r\n\r\n```\r\npsql (11.4 (Ubuntu 11.4-0ubuntu0.19.04.1), server 9.6.13)\r\nType \"help\" for help.\r\n\r\ndatabase=# BEGIN;\r\nBEGIN\r\ndatabase=# SAVEPOINT hoge;\r\nSAVEPOINT\r\ndatabase=# SELECT foo;\r\nERROR:  column \"foo\" does not exist\r\nLINE 1: SELECT foo;\r\n               ^\r\ndatabase=# RELEASE SAVEPOINT hoge;\r\nERROR:  current transaction is aborted, commands ignored until end of transaction block\r\ndatabase=# ROLLBACK;\r\nROLLBACK\r\n```\r\n\r\nI guess the correct way to address this issue is when you get an aborted error, keep it and decrement the depth.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/512159258/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"KeenS","id":4434568,"node_id":"MDQ6VXNlcjQ0MzQ1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/4434568?v=4","gravatar_id":"","url":"https://api.github.com/users/KeenS","html_url":"https://github.com/KeenS","followers_url":"https://api.github.com/users/KeenS/followers","following_url":"https://api.github.com/users/KeenS/following{/other_user}","gists_url":"https://api.github.com/users/KeenS/gists{/gist_id}","starred_url":"https://api.github.com/users/KeenS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeenS/subscriptions","organizations_url":"https://api.github.com/users/KeenS/orgs","repos_url":"https://api.github.com/users/KeenS/repos","events_url":"https://api.github.com/users/KeenS/events{/privacy}","received_events_url":"https://api.github.com/users/KeenS/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2492435196,"node_id":"MDEyOkxhYmVsZWRFdmVudDI0OTI0MzUxOTY=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/2492435196","actor":{"login":"JohnTitor","id":25030997,"node_id":"MDQ6VXNlcjI1MDMwOTk3","avatar_url":"https://avatars.githubusercontent.com/u/25030997?v=4","gravatar_id":"","url":"https://api.github.com/users/JohnTitor","html_url":"https://github.com/JohnTitor","followers_url":"https://api.github.com/users/JohnTitor/followers","following_url":"https://api.github.com/users/JohnTitor/following{/other_user}","gists_url":"https://api.github.com/users/JohnTitor/gists{/gist_id}","starred_url":"https://api.github.com/users/JohnTitor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JohnTitor/subscriptions","organizations_url":"https://api.github.com/users/JohnTitor/orgs","repos_url":"https://api.github.com/users/JohnTitor/repos","events_url":"https://api.github.com/users/JohnTitor/events{/privacy}","received_events_url":"https://api.github.com/users/JohnTitor/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-07-18T11:46:07Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"actor":{"login":"KeenS","id":4434568,"node_id":"MDQ6VXNlcjQ0MzQ1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/4434568?v=4","gravatar_id":"","url":"https://api.github.com/users/KeenS","html_url":"https://github.com/KeenS","followers_url":"https://api.github.com/users/KeenS/followers","following_url":"https://api.github.com/users/KeenS/following{/other_user}","gists_url":"https://api.github.com/users/KeenS/gists{/gist_id}","starred_url":"https://api.github.com/users/KeenS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeenS/subscriptions","organizations_url":"https://api.github.com/users/KeenS/orgs","repos_url":"https://api.github.com/users/KeenS/repos","events_url":"https://api.github.com/users/KeenS/events{/privacy}","received_events_url":"https://api.github.com/users/KeenS/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-19T07:58:30Z","updated_at":"2019-07-19T07:58:30Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2124","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2124/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2124/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2124/events","html_url":"https://github.com/diesel-rs/diesel/issues/2124","id":470191447,"node_id":"MDU6SXNzdWU0NzAxOTE0NDc=","number":2124,"title":"Connection state gets corrupted when an panic occurs in a transaction","user":{"login":"KeenS","id":4434568,"node_id":"MDQ6VXNlcjQ0MzQ1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/4434568?v=4","gravatar_id":"","url":"https://api.github.com/users/KeenS","html_url":"https://github.com/KeenS","followers_url":"https://api.github.com/users/KeenS/followers","following_url":"https://api.github.com/users/KeenS/following{/other_user}","gists_url":"https://api.github.com/users/KeenS/gists{/gist_id}","starred_url":"https://api.github.com/users/KeenS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeenS/subscriptions","organizations_url":"https://api.github.com/users/KeenS/orgs","repos_url":"https://api.github.com/users/KeenS/repos","events_url":"https://api.github.com/users/KeenS/events{/privacy}","received_events_url":"https://api.github.com/users/KeenS/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-07-19T07:58:30Z","updated_at":"2019-07-20T15:45:38Z","closed_at":"2019-07-19T18:00:38Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":41609775,"node_id":"MDEwOlJlcG9zaXRvcnk0MTYwOTc3NQ==","name":"diesel","full_name":"diesel-rs/diesel","private":false,"owner":{"login":"diesel-rs","id":16763251,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE2NzYzMjUx","avatar_url":"https://avatars.githubusercontent.com/u/16763251?v=4","gravatar_id":"","url":"https://api.github.com/users/diesel-rs","html_url":"https://github.com/diesel-rs","followers_url":"https://api.github.com/users/diesel-rs/followers","following_url":"https://api.github.com/users/diesel-rs/following{/other_user}","gists_url":"https://api.github.com/users/diesel-rs/gists{/gist_id}","starred_url":"https://api.github.com/users/diesel-rs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diesel-rs/subscriptions","organizations_url":"https://api.github.com/users/diesel-rs/orgs","repos_url":"https://api.github.com/users/diesel-rs/repos","events_url":"https://api.github.com/users/diesel-rs/events{/privacy}","received_events_url":"https://api.github.com/users/diesel-rs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/diesel-rs/diesel","description":"A safe, extensible ORM and Query Builder for Rust","fork":false,"url":"https://api.github.com/repos/diesel-rs/diesel","forks_url":"https://api.github.com/repos/diesel-rs/diesel/forks","keys_url":"https://api.github.com/repos/diesel-rs/diesel/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diesel-rs/diesel/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diesel-rs/diesel/teams","hooks_url":"https://api.github.com/repos/diesel-rs/diesel/hooks","issue_events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/events{/number}","events_url":"https://api.github.com/repos/diesel-rs/diesel/events","assignees_url":"https://api.github.com/repos/diesel-rs/diesel/assignees{/user}","branches_url":"https://api.github.com/repos/diesel-rs/diesel/branches{/branch}","tags_url":"https://api.github.com/repos/diesel-rs/diesel/tags","blobs_url":"https://api.github.com/repos/diesel-rs/diesel/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diesel-rs/diesel/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diesel-rs/diesel/git/refs{/sha}","trees_url":"https://api.github.com/repos/diesel-rs/diesel/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diesel-rs/diesel/statuses/{sha}","languages_url":"https://api.github.com/repos/diesel-rs/diesel/languages","stargazers_url":"https://api.github.com/repos/diesel-rs/diesel/stargazers","contributors_url":"https://api.github.com/repos/diesel-rs/diesel/contributors","subscribers_url":"https://api.github.com/repos/diesel-rs/diesel/subscribers","subscription_url":"https://api.github.com/repos/diesel-rs/diesel/subscription","commits_url":"https://api.github.com/repos/diesel-rs/diesel/commits{/sha}","git_commits_url":"https://api.github.com/repos/diesel-rs/diesel/git/commits{/sha}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/comments{/number}","issue_comment_url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments{/number}","contents_url":"https://api.github.com/repos/diesel-rs/diesel/contents/{+path}","compare_url":"https://api.github.com/repos/diesel-rs/diesel/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diesel-rs/diesel/merges","archive_url":"https://api.github.com/repos/diesel-rs/diesel/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diesel-rs/diesel/downloads","issues_url":"https://api.github.com/repos/diesel-rs/diesel/issues{/number}","pulls_url":"https://api.github.com/repos/diesel-rs/diesel/pulls{/number}","milestones_url":"https://api.github.com/repos/diesel-rs/diesel/milestones{/number}","notifications_url":"https://api.github.com/repos/diesel-rs/diesel/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diesel-rs/diesel/labels{/name}","releases_url":"https://api.github.com/repos/diesel-rs/diesel/releases{/id}","deployments_url":"https://api.github.com/repos/diesel-rs/diesel/deployments","created_at":"2015-08-29T22:51:00Z","updated_at":"2025-11-09T19:31:55Z","pushed_at":"2025-11-07T18:13:31Z","git_url":"git://github.com/diesel-rs/diesel.git","ssh_url":"git@github.com:diesel-rs/diesel.git","clone_url":"https://github.com/diesel-rs/diesel.git","svn_url":"https://github.com/diesel-rs/diesel","homepage":"https://diesel.rs","size":109357,"stargazers_count":13771,"watchers_count":13771,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":1168,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":153,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["mysql","orm","postgresql","query-builder","rust","sqlite"],"visibility":"public","forks":1168,"open_issues":153,"watchers":13771,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"\r\n## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** rustc 1.36.0 (a53f9df32 2019-07-03)\r\n- **Diesel:** 1.4,2\r\n- **Database:** PostrgreSQL, psql (11.4 (Ubuntu 11.4-0ubuntu0.19.04.1), server 9.6.13)\r\n- **Operating System** Ubuntu 19.04\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** `[\"postgres\", \"r2d2\"]`\r\n\r\n## Problem Description\r\n\r\nWhen a panic occurs in a transaction, connection gets corrupted and all the following transaction fails, like #2123 .\r\nI'm not sure if this is a bug or intentional behavior but in this setup, connection in the connection pool gets unsound and it will be used other threads. It causes a disaster.\r\nThus I want it to be fixed.\r\n\r\nI guess one way to address this issue is check `TransactionManager`'s `depth` in `is_valid` of connection pool implementation.\r\n\r\n### What are you trying to accomplish?\r\n\r\nWriting an application, especially using [`actix`](https://github.com/actix/actix)'s Actor for transaction runner.\r\n\r\n### What is the expected output?\r\n\r\n`Ok(1)` \r\n\r\n### What is the actual output?\r\n\r\n`Err(AlreadyInTransaction)`\r\n\r\n### Are you seeing any additional errors?\r\n\r\n\r\n### Steps to reproduce\r\n\r\nrun code below\r\n\r\nCargo.toml\r\n```toml\r\n[package]\r\nname = \"diesel-bug-report\"\r\nversion = \"0.1.0\"\r\nedition = \"2018\"\r\n\r\n[dependencies]\r\ndiesel = {version = \"1.4.0\", features = [\"postgres\", \"r2d2\"]}\r\n```\r\n\r\nsrc/main.rs\r\n```rust\r\nuse diesel::pg::PgConnection;\r\nuse diesel::prelude::*;\r\nuse diesel::r2d2::{ConnectionManager, Pool};\r\nuse diesel::result::Error;\r\nuse std::thread;\r\n\r\nfn main() {\r\n    // create thread pool\r\n    let manager = ConnectionManager::<PgConnection>::new(\r\n        \"postgres://user:password@localhost/database\".to_string(),\r\n    );\r\n    let pool = Pool::builder()\r\n        .build(manager)\r\n        .expect(\"Failed to create pool.\");\r\n\r\n    // run a transaction in a thread.\r\n    let pool2 = pool.clone();\r\n    let handle = thread::spawn(move || {\r\n        let conn = pool2.get().unwrap();\r\n        conn.transaction(|| -> Result<(), Error> {\r\n            // panics it\r\n            panic!(\"panic\");\r\n        })\r\n    });\r\n    let ret = handle.join();\r\n    // gets error\r\n    println!(\"{:?}\", ret);\r\n\r\n    // other transaction after panic\r\n    // Note: though we are using connection pool, as its implementation is a stack,\r\n    //       we always get the connection used before.\r\n    let conn = pool.get().unwrap();\r\n    let ret = conn\r\n        .build_transaction()\r\n        .serializable()\r\n        .run(|| conn.execute(\"SELECT 1\"));\r\n    // must be Ok(1) but get Err(AlreadyInTransaction)\r\n    println!(\"{:?}\", ret);\r\n}\r\n\r\n```\r\n\r\noutput\r\n\r\n```\r\nthread '<unnamed>' panicked at 'panic', src/main.rs:21:13\r\nnote: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\r\nErr(Any)\r\nErr(AlreadyInTransaction)\r\n```\r\n\r\n## Checklist\r\n\r\n- [x] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues) for similar issues.\r\n- [x] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n\r\n<!--\r\nThank you for your submission!  You're helping make Diesel more robust ðŸŽ‰\r\n\r\nWe'll try to respond as quickly as possible.\r\n-->\r\n","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2124/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2124/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/513335276","html_url":"https://github.com/diesel-rs/diesel/issues/2123#issuecomment-513335276","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2123","id":513335276,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMzMzNTI3Ng==","user":{"login":"sgrif","id":1529387,"node_id":"MDQ6VXNlcjE1MjkzODc=","avatar_url":"https://avatars.githubusercontent.com/u/1529387?v=4","gravatar_id":"","url":"https://api.github.com/users/sgrif","html_url":"https://github.com/sgrif","followers_url":"https://api.github.com/users/sgrif/followers","following_url":"https://api.github.com/users/sgrif/following{/other_user}","gists_url":"https://api.github.com/users/sgrif/gists{/gist_id}","starred_url":"https://api.github.com/users/sgrif/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgrif/subscriptions","organizations_url":"https://api.github.com/users/sgrif/orgs","repos_url":"https://api.github.com/users/sgrif/repos","events_url":"https://api.github.com/users/sgrif/events{/privacy}","received_events_url":"https://api.github.com/users/sgrif/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-19T18:42:20Z","updated_at":"2019-07-19T18:42:20Z","body":"It looks like the issue here stems from the fact that we are only changing the transaction depth if the query succeeded. I don't think this is in any way limited to nested transactions, I believe you will get similar behavior by returning `Ok` to `transaction` when a database error occurs, even for the outer transaction\r\n\r\nThere are a few options here:\r\n\r\n- Always perform the depth change, even if an error occurs\r\n- Hold onto what the depth was before opening the transaction, and set to that instead of decrementing by 1\r\n- Attempt to rollback if committing fails\r\n- Do nothing. An error was explicitly ignored, the transaction API was lied to, and \"we don't know if this connection is safe to use or not, it's in a poisoned state\" is reasonable.\r\n\r\nIf we do change how we set the depth, we need to make sure that nothing happens if opening the transaction fails.\r\n\r\nAlways performing the depth change is somewhat of a lie, since if `RELEASE SAVEPOINT` fails, we're still at the same depth as before, we just can't run any queries except `ROLLBACK` (either the whole transaction or to a savepoint). This is probably fine since the only time we'd be using it is if you try to open another nested transaction, which would fail regardless of if we use a name that already exists or not. \r\n\r\nPrecomputing the depth change is the most \"honest\" solution I think, but it has the main problem of only working if the nested transaction fails. (e.g. if `COMMIT` fails, we'll still have a depth of 1). This is fine in the \"normal\" case, since if `COMMIT` fails, it should mean the connection itself died, so the connection is unusable anyway. However, a serialization error should result in `COMMIT` failing, but us being at a depth of 0 (you don't need to run `ROLLBACK` manually in that case). There's also the ignoring an error case above, in which case I don't know whether we need to rollback manually or not.\r\n\r\nI'm not sure if there are any consequences to attempting to rollback if committing fails.\r\n\r\nI'd love to see any PR tackling this (or comments that more strongly demonstrate that we should/shouldn't fix this) address the questions/concerns above, why it's the best option, and what the behavior is in all of the various cases","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/513335276/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sgrif","id":1529387,"node_id":"MDQ6VXNlcjE1MjkzODc=","avatar_url":"https://avatars.githubusercontent.com/u/1529387?v=4","gravatar_id":"","url":"https://api.github.com/users/sgrif","html_url":"https://github.com/sgrif","followers_url":"https://api.github.com/users/sgrif/followers","following_url":"https://api.github.com/users/sgrif/following{/other_user}","gists_url":"https://api.github.com/users/sgrif/gists{/gist_id}","starred_url":"https://api.github.com/users/sgrif/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgrif/subscriptions","organizations_url":"https://api.github.com/users/sgrif/orgs","repos_url":"https://api.github.com/users/sgrif/repos","events_url":"https://api.github.com/users/sgrif/events{/privacy}","received_events_url":"https://api.github.com/users/sgrif/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/514913261","html_url":"https://github.com/diesel-rs/diesel/issues/2123#issuecomment-514913261","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2123","id":514913261,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDkxMzI2MQ==","user":{"login":"KeenS","id":4434568,"node_id":"MDQ6VXNlcjQ0MzQ1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/4434568?v=4","gravatar_id":"","url":"https://api.github.com/users/KeenS","html_url":"https://github.com/KeenS","followers_url":"https://api.github.com/users/KeenS/followers","following_url":"https://api.github.com/users/KeenS/following{/other_user}","gists_url":"https://api.github.com/users/KeenS/gists{/gist_id}","starred_url":"https://api.github.com/users/KeenS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeenS/subscriptions","organizations_url":"https://api.github.com/users/KeenS/orgs","repos_url":"https://api.github.com/users/KeenS/repos","events_url":"https://api.github.com/users/KeenS/events{/privacy}","received_events_url":"https://api.github.com/users/KeenS/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-25T06:20:21Z","updated_at":"2019-07-25T06:20:21Z","body":"> I believe you will get similar behavior by returning Ok to transaction when a database error occurs, even for the outer transaction\r\n\r\nLogically yes, but in most cases, `COMMIT`/`ROLLBACK` likely succeeds because it terminates failed transactions.\r\n\r\n```\r\ndatabase=# BEGIN;\r\nBEGIN\r\ndatabase=# select foo;\r\nERROR:  column \"foo\" does not exist\r\nLINE 1: select foo;\r\n               ^\r\ndatabase=# COMMIT;\r\nROLLBACK\r\n```\r\n\r\nOne observation  here is you can recover error by rolling back savepoint.\r\n\r\n```\r\ndatabase=# BEGIN;\r\nBEGIN\r\ndatabase=# SAVEPOINT hoge;\r\nSAVEPOINT\r\ndatabase=# select foo;\r\nERROR:  column \"foo\" does not exist\r\nLINE 1: select foo;\r\n               ^\r\ndatabase=# ROLLBACK TO hoge;\r\nROLLBACK\r\ndatabase=# select 1;\r\n ?column?\r\n----------\r\n        1\r\n(1 row)\r\n\r\ndatabase=# COMMIT;\r\nCOMMIT\r\n```\r\n\r\nI think 'Attempt to rollback (savepoint) if committing fails' is consistent to the behavior of outer most `BEGIN` / `COMMIT` / `ROLLBACK`","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/514913261/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"KeenS","id":4434568,"node_id":"MDQ6VXNlcjQ0MzQ1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/4434568?v=4","gravatar_id":"","url":"https://api.github.com/users/KeenS","html_url":"https://github.com/KeenS","followers_url":"https://api.github.com/users/KeenS/followers","following_url":"https://api.github.com/users/KeenS/following{/other_user}","gists_url":"https://api.github.com/users/KeenS/gists{/gist_id}","starred_url":"https://api.github.com/users/KeenS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeenS/subscriptions","organizations_url":"https://api.github.com/users/KeenS/orgs","repos_url":"https://api.github.com/users/KeenS/repos","events_url":"https://api.github.com/users/KeenS/events{/privacy}","received_events_url":"https://api.github.com/users/KeenS/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/518254461","html_url":"https://github.com/diesel-rs/diesel/issues/2123#issuecomment-518254461","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2123","id":518254461,"node_id":"MDEyOklzc3VlQ29tbWVudDUxODI1NDQ2MQ==","user":{"login":"rustonaut","id":7632017,"node_id":"MDQ6VXNlcjc2MzIwMTc=","avatar_url":"https://avatars.githubusercontent.com/u/7632017?v=4","gravatar_id":"","url":"https://api.github.com/users/rustonaut","html_url":"https://github.com/rustonaut","followers_url":"https://api.github.com/users/rustonaut/followers","following_url":"https://api.github.com/users/rustonaut/following{/other_user}","gists_url":"https://api.github.com/users/rustonaut/gists{/gist_id}","starred_url":"https://api.github.com/users/rustonaut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rustonaut/subscriptions","organizations_url":"https://api.github.com/users/rustonaut/orgs","repos_url":"https://api.github.com/users/rustonaut/repos","events_url":"https://api.github.com/users/rustonaut/events{/privacy}","received_events_url":"https://api.github.com/users/rustonaut/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-05T14:20:52Z","updated_at":"2019-08-05T14:22:34Z","body":"I also think \"Attempting to rollback the savepoint if releasing it (commit) does fail\" is the best solution as it mirrors how top-level commit failure works (at last in postgres, an I guess in other DBs, too).\r\n\r\nI also would love it if the transaction manager uses the `r2d2::ManageConnection::has_broken` hook to check some fast to check invariants, i.e. that transaction depth is 0 and if they are broken drop the connection just to be on the safe side.\r\n\r\n```rust\r\nfn has_broken(&self, conn: &mut Self::Connection) -> bool {\r\n        let transaction_depth = <TransactionManager<Self::Connection>>\r\n            ::get_transaction_depth(conn.transaction_manager());\r\n\r\n        transaction_depth != 0\r\n}\r\n```\r\n\r\n(I think this is currently the only invariant which we can fastly check across all databases/)","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/518254461/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rustonaut","id":7632017,"node_id":"MDQ6VXNlcjc2MzIwMTc=","avatar_url":"https://avatars.githubusercontent.com/u/7632017?v=4","gravatar_id":"","url":"https://api.github.com/users/rustonaut","html_url":"https://github.com/rustonaut","followers_url":"https://api.github.com/users/rustonaut/followers","following_url":"https://api.github.com/users/rustonaut/following{/other_user}","gists_url":"https://api.github.com/users/rustonaut/gists{/gist_id}","starred_url":"https://api.github.com/users/rustonaut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rustonaut/subscriptions","organizations_url":"https://api.github.com/users/rustonaut/orgs","repos_url":"https://api.github.com/users/rustonaut/repos","events_url":"https://api.github.com/users/rustonaut/events{/privacy}","received_events_url":"https://api.github.com/users/rustonaut/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/518255763","html_url":"https://github.com/diesel-rs/diesel/issues/2123#issuecomment-518255763","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2123","id":518255763,"node_id":"MDEyOklzc3VlQ29tbWVudDUxODI1NTc2Mw==","user":{"login":"rustonaut","id":7632017,"node_id":"MDQ6VXNlcjc2MzIwMTc=","avatar_url":"https://avatars.githubusercontent.com/u/7632017?v=4","gravatar_id":"","url":"https://api.github.com/users/rustonaut","html_url":"https://github.com/rustonaut","followers_url":"https://api.github.com/users/rustonaut/followers","following_url":"https://api.github.com/users/rustonaut/following{/other_user}","gists_url":"https://api.github.com/users/rustonaut/gists{/gist_id}","starred_url":"https://api.github.com/users/rustonaut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rustonaut/subscriptions","organizations_url":"https://api.github.com/users/rustonaut/orgs","repos_url":"https://api.github.com/users/rustonaut/repos","events_url":"https://api.github.com/users/rustonaut/events{/privacy}","received_events_url":"https://api.github.com/users/rustonaut/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-05T14:23:54Z","updated_at":"2019-08-05T14:23:54Z","body":"Just to clarify I'm aware that this problem happens independent of r2d2, it's just that with connection pooling the reach such a bug can have is pretty big.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/518255763/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"rustonaut","id":7632017,"node_id":"MDQ6VXNlcjc2MzIwMTc=","avatar_url":"https://avatars.githubusercontent.com/u/7632017?v=4","gravatar_id":"","url":"https://api.github.com/users/rustonaut","html_url":"https://github.com/rustonaut","followers_url":"https://api.github.com/users/rustonaut/followers","following_url":"https://api.github.com/users/rustonaut/following{/other_user}","gists_url":"https://api.github.com/users/rustonaut/gists{/gist_id}","starred_url":"https://api.github.com/users/rustonaut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rustonaut/subscriptions","organizations_url":"https://api.github.com/users/rustonaut/orgs","repos_url":"https://api.github.com/users/rustonaut/repos","events_url":"https://api.github.com/users/rustonaut/events{/privacy}","received_events_url":"https://api.github.com/users/rustonaut/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"leoyvens","id":9885558,"node_id":"MDQ6VXNlcjk4ODU1NTg=","avatar_url":"https://avatars.githubusercontent.com/u/9885558?v=4","gravatar_id":"","url":"https://api.github.com/users/leoyvens","html_url":"https://github.com/leoyvens","followers_url":"https://api.github.com/users/leoyvens/followers","following_url":"https://api.github.com/users/leoyvens/following{/other_user}","gists_url":"https://api.github.com/users/leoyvens/gists{/gist_id}","starred_url":"https://api.github.com/users/leoyvens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leoyvens/subscriptions","organizations_url":"https://api.github.com/users/leoyvens/orgs","repos_url":"https://api.github.com/users/leoyvens/repos","events_url":"https://api.github.com/users/leoyvens/events{/privacy}","received_events_url":"https://api.github.com/users/leoyvens/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-09-28T22:32:06Z","updated_at":"2019-09-28T22:32:06Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/graphprotocol/graph-node/issues/1248","repository_url":"https://api.github.com/repos/graphprotocol/graph-node","labels_url":"https://api.github.com/repos/graphprotocol/graph-node/issues/1248/labels{/name}","comments_url":"https://api.github.com/repos/graphprotocol/graph-node/issues/1248/comments","events_url":"https://api.github.com/repos/graphprotocol/graph-node/issues/1248/events","html_url":"https://github.com/graphprotocol/graph-node/issues/1248","id":499827225,"node_id":"MDU6SXNzdWU0OTk4MjcyMjU=","number":1248,"title":"Error 'SAVEPOINT can only be used in transaction blocks'","user":{"login":"lutter","id":23697,"node_id":"MDQ6VXNlcjIzNjk3","avatar_url":"https://avatars.githubusercontent.com/u/23697?v=4","gravatar_id":"","url":"https://api.github.com/users/lutter","html_url":"https://github.com/lutter","followers_url":"https://api.github.com/users/lutter/followers","following_url":"https://api.github.com/users/lutter/following{/other_user}","gists_url":"https://api.github.com/users/lutter/gists{/gist_id}","starred_url":"https://api.github.com/users/lutter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lutter/subscriptions","organizations_url":"https://api.github.com/users/lutter/orgs","repos_url":"https://api.github.com/users/lutter/repos","events_url":"https://api.github.com/users/lutter/events{/privacy}","received_events_url":"https://api.github.com/users/lutter/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2019-09-28T22:20:35Z","updated_at":"2020-11-05T01:37:32Z","closed_at":"2020-09-16T16:14:12Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":130174051,"node_id":"MDEwOlJlcG9zaXRvcnkxMzAxNzQwNTE=","name":"graph-node","full_name":"graphprotocol/graph-node","private":false,"owner":{"login":"graphprotocol","id":38020273,"node_id":"MDEyOk9yZ2FuaXphdGlvbjM4MDIwMjcz","avatar_url":"https://avatars.githubusercontent.com/u/38020273?v=4","gravatar_id":"","url":"https://api.github.com/users/graphprotocol","html_url":"https://github.com/graphprotocol","followers_url":"https://api.github.com/users/graphprotocol/followers","following_url":"https://api.github.com/users/graphprotocol/following{/other_user}","gists_url":"https://api.github.com/users/graphprotocol/gists{/gist_id}","starred_url":"https://api.github.com/users/graphprotocol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/graphprotocol/subscriptions","organizations_url":"https://api.github.com/users/graphprotocol/orgs","repos_url":"https://api.github.com/users/graphprotocol/repos","events_url":"https://api.github.com/users/graphprotocol/events{/privacy}","received_events_url":"https://api.github.com/users/graphprotocol/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/graphprotocol/graph-node","description":"Graph Node indexes data from blockchains such as Ethereum and serves it over GraphQL","fork":false,"url":"https://api.github.com/repos/graphprotocol/graph-node","forks_url":"https://api.github.com/repos/graphprotocol/graph-node/forks","keys_url":"https://api.github.com/repos/graphprotocol/graph-node/keys{/key_id}","collaborators_url":"https://api.github.com/repos/graphprotocol/graph-node/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/graphprotocol/graph-node/teams","hooks_url":"https://api.github.com/repos/graphprotocol/graph-node/hooks","issue_events_url":"https://api.github.com/repos/graphprotocol/graph-node/issues/events{/number}","events_url":"https://api.github.com/repos/graphprotocol/graph-node/events","assignees_url":"https://api.github.com/repos/graphprotocol/graph-node/assignees{/user}","branches_url":"https://api.github.com/repos/graphprotocol/graph-node/branches{/branch}","tags_url":"https://api.github.com/repos/graphprotocol/graph-node/tags","blobs_url":"https://api.github.com/repos/graphprotocol/graph-node/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/graphprotocol/graph-node/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/graphprotocol/graph-node/git/refs{/sha}","trees_url":"https://api.github.com/repos/graphprotocol/graph-node/git/trees{/sha}","statuses_url":"https://api.github.com/repos/graphprotocol/graph-node/statuses/{sha}","languages_url":"https://api.github.com/repos/graphprotocol/graph-node/languages","stargazers_url":"https://api.github.com/repos/graphprotocol/graph-node/stargazers","contributors_url":"https://api.github.com/repos/graphprotocol/graph-node/contributors","subscribers_url":"https://api.github.com/repos/graphprotocol/graph-node/subscribers","subscription_url":"https://api.github.com/repos/graphprotocol/graph-node/subscription","commits_url":"https://api.github.com/repos/graphprotocol/graph-node/commits{/sha}","git_commits_url":"https://api.github.com/repos/graphprotocol/graph-node/git/commits{/sha}","comments_url":"https://api.github.com/repos/graphprotocol/graph-node/comments{/number}","issue_comment_url":"https://api.github.com/repos/graphprotocol/graph-node/issues/comments{/number}","contents_url":"https://api.github.com/repos/graphprotocol/graph-node/contents/{+path}","compare_url":"https://api.github.com/repos/graphprotocol/graph-node/compare/{base}...{head}","merges_url":"https://api.github.com/repos/graphprotocol/graph-node/merges","archive_url":"https://api.github.com/repos/graphprotocol/graph-node/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/graphprotocol/graph-node/downloads","issues_url":"https://api.github.com/repos/graphprotocol/graph-node/issues{/number}","pulls_url":"https://api.github.com/repos/graphprotocol/graph-node/pulls{/number}","milestones_url":"https://api.github.com/repos/graphprotocol/graph-node/milestones{/number}","notifications_url":"https://api.github.com/repos/graphprotocol/graph-node/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/graphprotocol/graph-node/labels{/name}","releases_url":"https://api.github.com/repos/graphprotocol/graph-node/releases{/id}","deployments_url":"https://api.github.com/repos/graphprotocol/graph-node/deployments","created_at":"2018-04-19T07:13:50Z","updated_at":"2025-11-09T11:51:48Z","pushed_at":"2025-11-07T13:14:16Z","git_url":"git://github.com/graphprotocol/graph-node.git","ssh_url":"git@github.com:graphprotocol/graph-node.git","clone_url":"https://github.com/graphprotocol/graph-node.git","svn_url":"https://github.com/graphprotocol/graph-node","homepage":"https://thegraph.com","size":337746,"stargazers_count":3080,"watchers_count":3080,"language":"Rust","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":false,"forks_count":1054,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":371,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["blockchain","developer-tools","ethereum","graphql","graphql-api","graphql-server","ipfs","protocol"],"visibility":"public","forks":1054,"open_issues":371,"watchers":3080,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Adam from Livepeer reported on Discord that subgraph [QmVodZMZUtS8ypBWf3YcziWfT6foh1bgcrqfmvn1JM4vML](https://thegraph.com/explorer/subgraph/livepeer/livepeer-canary) failed on 9/28 at 4:51 am PDT with the error\r\n```\r\nSubgraph instance failed to run: Error while processing block stream for a subgraph:\r\nstore error: SAVEPOINT can only be used in transaction blocks,\r\ncode: SubgraphSyncingFailure, id: QmVodZMZUtS8ypBWf3YcziWfT6foh1bgcrqfmvn1JM4vML\r\n\r\nFailed to set subgraph status to Failed:\r\nstore error: SAVEPOINT can only be used in transaction blocks, \r\ncode: SubgraphSyncingFailureNotRecorded,\r\nid: QmVodZMZUtS8ypBWf3YcziWfT6foh1bgcrqfmvn1JM4vML\r\n```\r\n\r\nLooking into this more, this error has been occurring since 2019-09-27 04:41:57.773 PDT on various index node pods, though I have only been able to find errors from several `index-node-community-N` pods, though that might be a red herring.\r\n\r\nThe database logs show that we are issuing statements `SAVEPOINT diesel_savepoint_1`\r\n\r\nAs background, Diesle uses savepoints to simulate nested transaction: when we call `transaction()` on a Diesel connection, Diesel checks whether we are already inside a txn, in which case it issues a `SAVEPOINT diesel_savepoint_${depth}`, otherwise it issues a `begin`. The check is based on a txn depth counter that Diesel maintains inside its [TransactionManager](https://github.com/diesel-rs/diesel/blob/master/diesel/src/connection/transaction_manager.rs#L44)\r\n\r\nThe error indicates that we somehow got into a situation where Diesel thinks we are inside a transaction when we are in fact not.\r\n\r\nAs a immediate remedy, I restarted the `index-node-community` pods.\r\n","reactions":{"url":"https://api.github.com/repos/graphprotocol/graph-node/issues/1248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/graphprotocol/graph-node/issues/1248/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/593085397","html_url":"https://github.com/diesel-rs/diesel/issues/2123#issuecomment-593085397","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2123","id":593085397,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MzA4NTM5Nw==","user":{"login":"torepettersen","id":17319716,"node_id":"MDQ6VXNlcjE3MzE5NzE2","avatar_url":"https://avatars.githubusercontent.com/u/17319716?v=4","gravatar_id":"","url":"https://api.github.com/users/torepettersen","html_url":"https://github.com/torepettersen","followers_url":"https://api.github.com/users/torepettersen/followers","following_url":"https://api.github.com/users/torepettersen/following{/other_user}","gists_url":"https://api.github.com/users/torepettersen/gists{/gist_id}","starred_url":"https://api.github.com/users/torepettersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torepettersen/subscriptions","organizations_url":"https://api.github.com/users/torepettersen/orgs","repos_url":"https://api.github.com/users/torepettersen/repos","events_url":"https://api.github.com/users/torepettersen/events{/privacy}","received_events_url":"https://api.github.com/users/torepettersen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-03-01T11:19:43Z","updated_at":"2020-03-01T11:19:43Z","body":"I experienced the same problem even without the nesting, just as @sgrif expected. I was making a test that was validating that a value should be unique and noticed that the following test was failing.\r\n\r\nI also reproduced it:\r\n```rust\r\n// main.rs\r\nuse diesel::pg::PgConnection;\r\nuse diesel::prelude::*;\r\n\r\nfn main() {\r\n    let conn = PgConnection::establish(\"postgres://postgres:password@localhost/main\").unwrap();\r\n    conn.begin_test_transaction().unwrap();\r\n\r\n    let ret = conn.execute(\"insert into foo (bar) values ('hello world')\");\r\n    println!(\"{:?}\", ret);\r\n\r\n    match conn.execute(\"insert into foo (bar) values ('hello world')\") {\r\n        Ok(_) => panic!(\"This query should fail\"),\r\n        Err(e) => println!(\"This should fail with unique constraint violation: {}\", e),\r\n    };\r\n\r\n    let ret = conn.execute(\"select * from foo where bar = 'hello world'\");\r\n    println!(\"{:?}\", ret);\r\n}\r\n```\r\nWhich gives the following output:\r\n```console\r\n$ cargo run\r\nOk(1)\r\nThis should fail with unique constraint violation: duplicate key value violates unique constraint \"foo_bar_key\"\r\nErr(DatabaseError(__Unknown, \"current transaction is aborted, commands ignored until end of transaction block\"))\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/593085397/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"torepettersen","id":17319716,"node_id":"MDQ6VXNlcjE3MzE5NzE2","avatar_url":"https://avatars.githubusercontent.com/u/17319716?v=4","gravatar_id":"","url":"https://api.github.com/users/torepettersen","html_url":"https://github.com/torepettersen","followers_url":"https://api.github.com/users/torepettersen/followers","following_url":"https://api.github.com/users/torepettersen/following{/other_user}","gists_url":"https://api.github.com/users/torepettersen/gists{/gist_id}","starred_url":"https://api.github.com/users/torepettersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torepettersen/subscriptions","organizations_url":"https://api.github.com/users/torepettersen/orgs","repos_url":"https://api.github.com/users/torepettersen/repos","events_url":"https://api.github.com/users/torepettersen/events{/privacy}","received_events_url":"https://api.github.com/users/torepettersen/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3085480207,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzA4NTQ4MDIwNw==","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/3085480207","actor":{"login":"sgrif","id":1529387,"node_id":"MDQ6VXNlcjE1MjkzODc=","avatar_url":"https://avatars.githubusercontent.com/u/1529387?v=4","gravatar_id":"","url":"https://api.github.com/users/sgrif","html_url":"https://github.com/sgrif","followers_url":"https://api.github.com/users/sgrif/followers","following_url":"https://api.github.com/users/sgrif/following{/other_user}","gists_url":"https://api.github.com/users/sgrif/gists{/gist_id}","starred_url":"https://api.github.com/users/sgrif/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgrif/subscriptions","organizations_url":"https://api.github.com/users/sgrif/orgs","repos_url":"https://api.github.com/users/sgrif/repos","events_url":"https://api.github.com/users/sgrif/events{/privacy}","received_events_url":"https://api.github.com/users/sgrif/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-03-01T11:19:44Z","performed_via_github_app":null},{"id":3085480208,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDMwODU0ODAyMDg=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/3085480208","actor":{"login":"sgrif","id":1529387,"node_id":"MDQ6VXNlcjE1MjkzODc=","avatar_url":"https://avatars.githubusercontent.com/u/1529387?v=4","gravatar_id":"","url":"https://api.github.com/users/sgrif","html_url":"https://github.com/sgrif","followers_url":"https://api.github.com/users/sgrif/followers","following_url":"https://api.github.com/users/sgrif/following{/other_user}","gists_url":"https://api.github.com/users/sgrif/gists{/gist_id}","starred_url":"https://api.github.com/users/sgrif/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgrif/subscriptions","organizations_url":"https://api.github.com/users/sgrif/orgs","repos_url":"https://api.github.com/users/sgrif/repos","events_url":"https://api.github.com/users/sgrif/events{/privacy}","received_events_url":"https://api.github.com/users/sgrif/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-03-01T11:19:44Z","performed_via_github_app":null},{"id":3110050592,"node_id":"MDE1Ok1pbGVzdG9uZWRFdmVudDMxMTAwNTA1OTI=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/3110050592","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2020-03-09T10:37:13Z","milestone":{"title":"2.0"},"performed_via_github_app":null},{"actor":{"login":"Ten0","id":9094255,"node_id":"MDQ6VXNlcjkwOTQyNTU=","avatar_url":"https://avatars.githubusercontent.com/u/9094255?v=4","gravatar_id":"","url":"https://api.github.com/users/Ten0","html_url":"https://github.com/Ten0","followers_url":"https://api.github.com/users/Ten0/followers","following_url":"https://api.github.com/users/Ten0/following{/other_user}","gists_url":"https://api.github.com/users/Ten0/gists{/gist_id}","starred_url":"https://api.github.com/users/Ten0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ten0/subscriptions","organizations_url":"https://api.github.com/users/Ten0/orgs","repos_url":"https://api.github.com/users/Ten0/repos","events_url":"https://api.github.com/users/Ten0/events{/privacy}","received_events_url":"https://api.github.com/users/Ten0/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-03-31T20:44:04Z","updated_at":"2020-03-31T20:44:04Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2346","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2346/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2346/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2346/events","html_url":"https://github.com/diesel-rs/diesel/issues/2346","id":591413607,"node_id":"MDU6SXNzdWU1OTE0MTM2MDc=","number":2346,"title":"Transaction does not close properly when failing on commit","user":{"login":"Ten0","id":9094255,"node_id":"MDQ6VXNlcjkwOTQyNTU=","avatar_url":"https://avatars.githubusercontent.com/u/9094255?v=4","gravatar_id":"","url":"https://api.github.com/users/Ten0","html_url":"https://github.com/Ten0","followers_url":"https://api.github.com/users/Ten0/followers","following_url":"https://api.github.com/users/Ten0/following{/other_user}","gists_url":"https://api.github.com/users/Ten0/gists{/gist_id}","starred_url":"https://api.github.com/users/Ten0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ten0/subscriptions","organizations_url":"https://api.github.com/users/Ten0/orgs","repos_url":"https://api.github.com/users/Ten0/repos","events_url":"https://api.github.com/users/Ten0/events{/privacy}","received_events_url":"https://api.github.com/users/Ten0/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193215,"node_id":"MDU6TGFiZWwyNTQxOTMyMTU=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2020-03-31T20:44:04Z","updated_at":"2020-04-17T15:23:27Z","closed_at":"2020-04-17T15:23:27Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":41609775,"node_id":"MDEwOlJlcG9zaXRvcnk0MTYwOTc3NQ==","name":"diesel","full_name":"diesel-rs/diesel","private":false,"owner":{"login":"diesel-rs","id":16763251,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE2NzYzMjUx","avatar_url":"https://avatars.githubusercontent.com/u/16763251?v=4","gravatar_id":"","url":"https://api.github.com/users/diesel-rs","html_url":"https://github.com/diesel-rs","followers_url":"https://api.github.com/users/diesel-rs/followers","following_url":"https://api.github.com/users/diesel-rs/following{/other_user}","gists_url":"https://api.github.com/users/diesel-rs/gists{/gist_id}","starred_url":"https://api.github.com/users/diesel-rs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diesel-rs/subscriptions","organizations_url":"https://api.github.com/users/diesel-rs/orgs","repos_url":"https://api.github.com/users/diesel-rs/repos","events_url":"https://api.github.com/users/diesel-rs/events{/privacy}","received_events_url":"https://api.github.com/users/diesel-rs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/diesel-rs/diesel","description":"A safe, extensible ORM and Query Builder for Rust","fork":false,"url":"https://api.github.com/repos/diesel-rs/diesel","forks_url":"https://api.github.com/repos/diesel-rs/diesel/forks","keys_url":"https://api.github.com/repos/diesel-rs/diesel/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diesel-rs/diesel/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diesel-rs/diesel/teams","hooks_url":"https://api.github.com/repos/diesel-rs/diesel/hooks","issue_events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/events{/number}","events_url":"https://api.github.com/repos/diesel-rs/diesel/events","assignees_url":"https://api.github.com/repos/diesel-rs/diesel/assignees{/user}","branches_url":"https://api.github.com/repos/diesel-rs/diesel/branches{/branch}","tags_url":"https://api.github.com/repos/diesel-rs/diesel/tags","blobs_url":"https://api.github.com/repos/diesel-rs/diesel/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diesel-rs/diesel/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diesel-rs/diesel/git/refs{/sha}","trees_url":"https://api.github.com/repos/diesel-rs/diesel/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diesel-rs/diesel/statuses/{sha}","languages_url":"https://api.github.com/repos/diesel-rs/diesel/languages","stargazers_url":"https://api.github.com/repos/diesel-rs/diesel/stargazers","contributors_url":"https://api.github.com/repos/diesel-rs/diesel/contributors","subscribers_url":"https://api.github.com/repos/diesel-rs/diesel/subscribers","subscription_url":"https://api.github.com/repos/diesel-rs/diesel/subscription","commits_url":"https://api.github.com/repos/diesel-rs/diesel/commits{/sha}","git_commits_url":"https://api.github.com/repos/diesel-rs/diesel/git/commits{/sha}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/comments{/number}","issue_comment_url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments{/number}","contents_url":"https://api.github.com/repos/diesel-rs/diesel/contents/{+path}","compare_url":"https://api.github.com/repos/diesel-rs/diesel/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diesel-rs/diesel/merges","archive_url":"https://api.github.com/repos/diesel-rs/diesel/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diesel-rs/diesel/downloads","issues_url":"https://api.github.com/repos/diesel-rs/diesel/issues{/number}","pulls_url":"https://api.github.com/repos/diesel-rs/diesel/pulls{/number}","milestones_url":"https://api.github.com/repos/diesel-rs/diesel/milestones{/number}","notifications_url":"https://api.github.com/repos/diesel-rs/diesel/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diesel-rs/diesel/labels{/name}","releases_url":"https://api.github.com/repos/diesel-rs/diesel/releases{/id}","deployments_url":"https://api.github.com/repos/diesel-rs/diesel/deployments","created_at":"2015-08-29T22:51:00Z","updated_at":"2025-11-09T19:31:55Z","pushed_at":"2025-11-07T18:13:31Z","git_url":"git://github.com/diesel-rs/diesel.git","ssh_url":"git@github.com:diesel-rs/diesel.git","clone_url":"https://github.com/diesel-rs/diesel.git","svn_url":"https://github.com/diesel-rs/diesel","homepage":"https://diesel.rs","size":109357,"stargazers_count":13771,"watchers_count":13771,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":1168,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":153,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["mysql","orm","postgresql","query-builder","rust","sqlite"],"visibility":"public","forks":1168,"open_issues":153,"watchers":13771,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** latest stable\r\n- **Diesel:** master\r\n- **Database:** postgres\r\n- **Operating System** linux\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** postgres\r\n\r\n## Problem Description\r\nConnection gets released to the connection pool with transaction not being closed.\r\nThen triggering \"AlreadyInTransaction: Cannot perform this operation while a transaction is open\" errors.\r\n\r\n### What are you trying to accomplish?\r\nSerializable transaction fails on transaction commit:\r\nhttps://github.com/diesel-rs/diesel/blob/5369a7a3d13b1323fcac9acf9d13256f19a970a0/diesel/src/pg/transaction.rs#L276\r\n\"DatabaseError: could not serialize access due to read/write dependencies among transactions\"\r\nConnection is released to the pool (r2d2) and should be usable again.\r\n\r\n### What is the expected output?\r\nNext requests successfully start their own transaction.\r\n\r\n### What is the actual output?\r\nAlreadyInTransaction: Cannot perform this operation while a transaction is open\r\n\r\n## Related issues\r\nhttps://github.com/diesel-rs/diesel/issues/2123\r\nIn my case, transactions are not nested but I suspect this is the same issue.\r\n\r\n## Solving\r\nI suspect catching the `DatabaseError` on `commit_transaction` and calling `rollback_transaction` would solve this issue.\r\n\r\n## Checklist\r\n\r\n- [X] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues) for similar issues.\r\n- [X] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2346/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2346/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":4057760688,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDQwNTc3NjA2ODg=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/4057760688","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"bf83de2c1609998934ac88aa0040b6687f86a830","commit_url":"https://api.github.com/repos/weiznich/diesel/commits/bf83de2c1609998934ac88aa0040b6687f86a830","created_at":"2020-12-01T15:20:24Z","performed_via_github_app":null},{"id":4057875025,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDQwNTc4NzUwMjU=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/4057875025","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"e350f0c20de4486b19dbaa86139641bb39142b5c","commit_url":"https://api.github.com/repos/weiznich/diesel/commits/e350f0c20de4486b19dbaa86139641bb39142b5c","created_at":"2020-12-01T15:42:36Z","performed_via_github_app":null},{"id":4057908731,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDQwNTc5MDg3MzE=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/4057908731","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"756c62ebdba03d490f604a84656914be882dec2e","commit_url":"https://api.github.com/repos/weiznich/diesel/commits/756c62ebdba03d490f604a84656914be882dec2e","created_at":"2020-12-01T15:49:03Z","performed_via_github_app":null},{"id":4066714354,"node_id":"MDExOkNsb3NlZEV2ZW50NDA2NjcxNDM1NA==","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/4066714354","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"756c62ebdba03d490f604a84656914be882dec2e","commit_url":"https://api.github.com/repos/diesel-rs/diesel/commits/756c62ebdba03d490f604a84656914be882dec2e","created_at":"2020-12-03T10:34:19Z","state_reason":null,"performed_via_github_app":null},{"id":4066714377,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDQwNjY3MTQzNzc=","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/4066714377","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"9fff108d5ea040121609f836510e6452edf1d871","commit_url":"https://api.github.com/repos/diesel-rs/diesel/commits/9fff108d5ea040121609f836510e6452edf1d871","created_at":"2020-12-03T10:34:20Z","performed_via_github_app":null},{"actor":{"login":"Emm","id":33265,"node_id":"MDQ6VXNlcjMzMjY1","avatar_url":"https://avatars.githubusercontent.com/u/33265?v=4","gravatar_id":"","url":"https://api.github.com/users/Emm","html_url":"https://github.com/Emm","followers_url":"https://api.github.com/users/Emm/followers","following_url":"https://api.github.com/users/Emm/following{/other_user}","gists_url":"https://api.github.com/users/Emm/gists{/gist_id}","starred_url":"https://api.github.com/users/Emm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Emm/subscriptions","organizations_url":"https://api.github.com/users/Emm/orgs","repos_url":"https://api.github.com/users/Emm/repos","events_url":"https://api.github.com/users/Emm/events{/privacy}","received_events_url":"https://api.github.com/users/Emm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-31T17:15:03Z","updated_at":"2021-10-31T17:15:03Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2935","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2935/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2935/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2935/events","html_url":"https://github.com/diesel-rs/diesel/pull/2935","id":1040531222,"node_id":"PR_kwDOAnrqL84t5OmV","number":2935,"title":"Proper depth tracking and robust broken transaction detection","user":{"login":"Emm","id":33265,"node_id":"MDQ6VXNlcjMzMjY1","avatar_url":"https://avatars.githubusercontent.com/u/33265?v=4","gravatar_id":"","url":"https://api.github.com/users/Emm","html_url":"https://github.com/Emm","followers_url":"https://api.github.com/users/Emm/followers","following_url":"https://api.github.com/users/Emm/following{/other_user}","gists_url":"https://api.github.com/users/Emm/gists{/gist_id}","starred_url":"https://api.github.com/users/Emm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Emm/subscriptions","organizations_url":"https://api.github.com/users/Emm/orgs","repos_url":"https://api.github.com/users/Emm/repos","events_url":"https://api.github.com/users/Emm/events{/privacy}","received_events_url":"https://api.github.com/users/Emm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":29,"created_at":"2021-10-31T17:15:03Z","updated_at":"2022-01-09T20:57:41Z","closed_at":"2022-01-08T20:35:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":41609775,"node_id":"MDEwOlJlcG9zaXRvcnk0MTYwOTc3NQ==","name":"diesel","full_name":"diesel-rs/diesel","private":false,"owner":{"login":"diesel-rs","id":16763251,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE2NzYzMjUx","avatar_url":"https://avatars.githubusercontent.com/u/16763251?v=4","gravatar_id":"","url":"https://api.github.com/users/diesel-rs","html_url":"https://github.com/diesel-rs","followers_url":"https://api.github.com/users/diesel-rs/followers","following_url":"https://api.github.com/users/diesel-rs/following{/other_user}","gists_url":"https://api.github.com/users/diesel-rs/gists{/gist_id}","starred_url":"https://api.github.com/users/diesel-rs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diesel-rs/subscriptions","organizations_url":"https://api.github.com/users/diesel-rs/orgs","repos_url":"https://api.github.com/users/diesel-rs/repos","events_url":"https://api.github.com/users/diesel-rs/events{/privacy}","received_events_url":"https://api.github.com/users/diesel-rs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/diesel-rs/diesel","description":"A safe, extensible ORM and Query Builder for Rust","fork":false,"url":"https://api.github.com/repos/diesel-rs/diesel","forks_url":"https://api.github.com/repos/diesel-rs/diesel/forks","keys_url":"https://api.github.com/repos/diesel-rs/diesel/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diesel-rs/diesel/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diesel-rs/diesel/teams","hooks_url":"https://api.github.com/repos/diesel-rs/diesel/hooks","issue_events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/events{/number}","events_url":"https://api.github.com/repos/diesel-rs/diesel/events","assignees_url":"https://api.github.com/repos/diesel-rs/diesel/assignees{/user}","branches_url":"https://api.github.com/repos/diesel-rs/diesel/branches{/branch}","tags_url":"https://api.github.com/repos/diesel-rs/diesel/tags","blobs_url":"https://api.github.com/repos/diesel-rs/diesel/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diesel-rs/diesel/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diesel-rs/diesel/git/refs{/sha}","trees_url":"https://api.github.com/repos/diesel-rs/diesel/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diesel-rs/diesel/statuses/{sha}","languages_url":"https://api.github.com/repos/diesel-rs/diesel/languages","stargazers_url":"https://api.github.com/repos/diesel-rs/diesel/stargazers","contributors_url":"https://api.github.com/repos/diesel-rs/diesel/contributors","subscribers_url":"https://api.github.com/repos/diesel-rs/diesel/subscribers","subscription_url":"https://api.github.com/repos/diesel-rs/diesel/subscription","commits_url":"https://api.github.com/repos/diesel-rs/diesel/commits{/sha}","git_commits_url":"https://api.github.com/repos/diesel-rs/diesel/git/commits{/sha}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/comments{/number}","issue_comment_url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments{/number}","contents_url":"https://api.github.com/repos/diesel-rs/diesel/contents/{+path}","compare_url":"https://api.github.com/repos/diesel-rs/diesel/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diesel-rs/diesel/merges","archive_url":"https://api.github.com/repos/diesel-rs/diesel/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diesel-rs/diesel/downloads","issues_url":"https://api.github.com/repos/diesel-rs/diesel/issues{/number}","pulls_url":"https://api.github.com/repos/diesel-rs/diesel/pulls{/number}","milestones_url":"https://api.github.com/repos/diesel-rs/diesel/milestones{/number}","notifications_url":"https://api.github.com/repos/diesel-rs/diesel/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diesel-rs/diesel/labels{/name}","releases_url":"https://api.github.com/repos/diesel-rs/diesel/releases{/id}","deployments_url":"https://api.github.com/repos/diesel-rs/diesel/deployments","created_at":"2015-08-29T22:51:00Z","updated_at":"2025-11-09T19:31:55Z","pushed_at":"2025-11-07T18:13:31Z","git_url":"git://github.com/diesel-rs/diesel.git","ssh_url":"git@github.com:diesel-rs/diesel.git","clone_url":"https://github.com/diesel-rs/diesel.git","svn_url":"https://github.com/diesel-rs/diesel","homepage":"https://diesel.rs","size":109357,"stargazers_count":13771,"watchers_count":13771,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":1168,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":153,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["mysql","orm","postgresql","query-builder","rust","sqlite"],"visibility":"public","forks":1168,"open_issues":153,"watchers":13771,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/diesel-rs/diesel/pulls/2935","html_url":"https://github.com/diesel-rs/diesel/pull/2935","diff_url":"https://github.com/diesel-rs/diesel/pull/2935.diff","patch_url":"https://github.com/diesel-rs/diesel/pull/2935.patch","merged_at":"2022-01-08T20:35:14Z"},"body":"* Fixes the detection of errored transaction blocks in Postgres, without relying on the English version of a localized error message (related to #2123)\r\n* Fixes connections unable to open new transactions in Postgres after a commit fails due to an `INITIALLY DEFERRED` constraint or trigger (which is quite dangerous as this breaks connection pools and is NOT detected by r2d2's `SELECT 1` check)","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2935/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2935/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"actor":{"login":"Ten0","id":9094255,"node_id":"MDQ6VXNlcjkwOTQyNTU=","avatar_url":"https://avatars.githubusercontent.com/u/9094255?v=4","gravatar_id":"","url":"https://api.github.com/users/Ten0","html_url":"https://github.com/Ten0","followers_url":"https://api.github.com/users/Ten0/followers","following_url":"https://api.github.com/users/Ten0/following{/other_user}","gists_url":"https://api.github.com/users/Ten0/gists{/gist_id}","starred_url":"https://api.github.com/users/Ten0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ten0/subscriptions","organizations_url":"https://api.github.com/users/Ten0/orgs","repos_url":"https://api.github.com/users/Ten0/repos","events_url":"https://api.github.com/users/Ten0/events{/privacy}","received_events_url":"https://api.github.com/users/Ten0/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-01-11T23:39:47Z","updated_at":"2023-01-11T23:39:47Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/events","html_url":"https://github.com/diesel-rs/diesel/issues/3470","id":1528289154,"node_id":"I_kwDOAnrqL85bF9eC","number":3470,"title":"A `ReadOnlyTransaction` error within an inner transaction doesn't rollback the savepoint","user":{"login":"jtgeibel","id":22186,"node_id":"MDQ6VXNlcjIyMTg2","avatar_url":"https://avatars.githubusercontent.com/u/22186?v=4","gravatar_id":"","url":"https://api.github.com/users/jtgeibel","html_url":"https://github.com/jtgeibel","followers_url":"https://api.github.com/users/jtgeibel/followers","following_url":"https://api.github.com/users/jtgeibel/following{/other_user}","gists_url":"https://api.github.com/users/jtgeibel/gists{/gist_id}","starred_url":"https://api.github.com/users/jtgeibel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtgeibel/subscriptions","organizations_url":"https://api.github.com/users/jtgeibel/orgs","repos_url":"https://api.github.com/users/jtgeibel/repos","events_url":"https://api.github.com/users/jtgeibel/events{/privacy}","received_events_url":"https://api.github.com/users/jtgeibel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193212,"node_id":"MDU6TGFiZWwyNTQxOTMyMTI=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2023-01-11T02:09:41Z","updated_at":"2023-01-24T16:47:12Z","closed_at":"2023-01-16T15:07:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":41609775,"node_id":"MDEwOlJlcG9zaXRvcnk0MTYwOTc3NQ==","name":"diesel","full_name":"diesel-rs/diesel","private":false,"owner":{"login":"diesel-rs","id":16763251,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE2NzYzMjUx","avatar_url":"https://avatars.githubusercontent.com/u/16763251?v=4","gravatar_id":"","url":"https://api.github.com/users/diesel-rs","html_url":"https://github.com/diesel-rs","followers_url":"https://api.github.com/users/diesel-rs/followers","following_url":"https://api.github.com/users/diesel-rs/following{/other_user}","gists_url":"https://api.github.com/users/diesel-rs/gists{/gist_id}","starred_url":"https://api.github.com/users/diesel-rs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diesel-rs/subscriptions","organizations_url":"https://api.github.com/users/diesel-rs/orgs","repos_url":"https://api.github.com/users/diesel-rs/repos","events_url":"https://api.github.com/users/diesel-rs/events{/privacy}","received_events_url":"https://api.github.com/users/diesel-rs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/diesel-rs/diesel","description":"A safe, extensible ORM and Query Builder for Rust","fork":false,"url":"https://api.github.com/repos/diesel-rs/diesel","forks_url":"https://api.github.com/repos/diesel-rs/diesel/forks","keys_url":"https://api.github.com/repos/diesel-rs/diesel/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diesel-rs/diesel/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diesel-rs/diesel/teams","hooks_url":"https://api.github.com/repos/diesel-rs/diesel/hooks","issue_events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/events{/number}","events_url":"https://api.github.com/repos/diesel-rs/diesel/events","assignees_url":"https://api.github.com/repos/diesel-rs/diesel/assignees{/user}","branches_url":"https://api.github.com/repos/diesel-rs/diesel/branches{/branch}","tags_url":"https://api.github.com/repos/diesel-rs/diesel/tags","blobs_url":"https://api.github.com/repos/diesel-rs/diesel/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diesel-rs/diesel/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diesel-rs/diesel/git/refs{/sha}","trees_url":"https://api.github.com/repos/diesel-rs/diesel/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diesel-rs/diesel/statuses/{sha}","languages_url":"https://api.github.com/repos/diesel-rs/diesel/languages","stargazers_url":"https://api.github.com/repos/diesel-rs/diesel/stargazers","contributors_url":"https://api.github.com/repos/diesel-rs/diesel/contributors","subscribers_url":"https://api.github.com/repos/diesel-rs/diesel/subscribers","subscription_url":"https://api.github.com/repos/diesel-rs/diesel/subscription","commits_url":"https://api.github.com/repos/diesel-rs/diesel/commits{/sha}","git_commits_url":"https://api.github.com/repos/diesel-rs/diesel/git/commits{/sha}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/comments{/number}","issue_comment_url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments{/number}","contents_url":"https://api.github.com/repos/diesel-rs/diesel/contents/{+path}","compare_url":"https://api.github.com/repos/diesel-rs/diesel/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diesel-rs/diesel/merges","archive_url":"https://api.github.com/repos/diesel-rs/diesel/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diesel-rs/diesel/downloads","issues_url":"https://api.github.com/repos/diesel-rs/diesel/issues{/number}","pulls_url":"https://api.github.com/repos/diesel-rs/diesel/pulls{/number}","milestones_url":"https://api.github.com/repos/diesel-rs/diesel/milestones{/number}","notifications_url":"https://api.github.com/repos/diesel-rs/diesel/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diesel-rs/diesel/labels{/name}","releases_url":"https://api.github.com/repos/diesel-rs/diesel/releases{/id}","deployments_url":"https://api.github.com/repos/diesel-rs/diesel/deployments","created_at":"2015-08-29T22:51:00Z","updated_at":"2025-11-09T19:31:55Z","pushed_at":"2025-11-07T18:13:31Z","git_url":"git://github.com/diesel-rs/diesel.git","ssh_url":"git@github.com:diesel-rs/diesel.git","clone_url":"https://github.com/diesel-rs/diesel.git","svn_url":"https://github.com/diesel-rs/diesel","homepage":"https://diesel.rs","size":109357,"stargazers_count":13771,"watchers_count":13771,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":1168,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":153,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["mysql","orm","postgresql","query-builder","rust","sqlite"],"visibility":"public","forks":1168,"open_issues":153,"watchers":13771,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** 1.66\r\n- **Diesel:** 2.0.2\r\n- **Database:** PostgreSQL 14.6\r\n- **Operating System:** Ubuntu 22.10\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** [\"postgres\"]\r\n\r\n## Problem Description\r\n\r\nStarting with diesel `2.0.0-rc.1` (commit 53bad857f30f2f32c14ae295487a88da278fb2fc of #3211) when within a nested transaction, if the inner transaction aborts because it attempts to mutate within a read-only transaction, then the connection is left in a bad state even outside of the inner transaction. Any further commands result in `current transaction is aborted, commands ignored until end of transaction block` until the outermost transaction is also rolled back. It appears that the SAVEPOINT for the inner transaction is not actually rolled back, as the equivalent series of SQL commands (including a `ROLLBACK TO SAVEPOINT ...`) does not result in such an error in `psql`.\r\n\r\n### What are you trying to accomplish?\r\n\r\nI am trying to port crates.io to diesel 2.0. Our tests are run within an outer transaction that rolls back when the test completes. In production the code will continue to work as expected as this code path has just the one transaction, but the additional transaction wrapping the entire test causes this test to fail.\r\n\r\n### What is the expected output?\r\n\r\nIt is expected that if a nested transaction encounters a `ReadOnlyTransaction` error then it should still rollback to the appropriate SAVEPOINT so that future read-only commands (such as SELECT) can be executed.\r\n\r\n### What is the actual output?\r\n\r\nThe observed output is an error stating `current transaction is aborted, commands ignored until end of transaction block`.\r\n\r\n### Are you seeing any additional errors?\r\n\r\nNo additional errors are seen.\r\n\r\n### Steps to reproduce\r\n\r\nCreate a simple test table with `cargo run` and then run `cargo test`. In diesel releases starting with `2.0.0-rc.1` the 2nd test fails with `Error: DatabaseError(Unknown, \"current transaction is aborted, commands ignored until end of transaction block\")`.\r\n\r\n```rust\r\nuse diesel::{prelude::*, sql_query};\r\n\r\nconst DATABASE_URL: &str = \"postgres:///\";\r\n\r\nfn connect() -> PgConnection {\r\n    PgConnection::establish(DATABASE_URL).unwrap()\r\n}\r\n\r\nfn main() {\r\n    sql_query(\"CREATE TABLE rollback_test (id INT PRIMARY KEY, value INT NOT NULL)\")\r\n        .execute(&mut connect())\r\n        .unwrap();\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use diesel::update;\r\n\r\n    diesel::table! {\r\n        rollback_test (id) {\r\n            id -> Int4,\r\n            value -> Int4,\r\n        }\r\n    }\r\n\r\n    fn update_with_fallback_query(conn: &mut PgConnection) -> QueryResult<()> {\r\n        conn.transaction(|conn| {\r\n            sql_query(\"SET TRANSACTION READ ONLY\").execute(conn)?;\r\n            dbg!(update(rollback_test::table)\r\n                .set(rollback_test::value.eq(0))\r\n                .execute(conn))\r\n        })\r\n        .or_else(|_| sql_query(\"SELECT 1\").execute(conn))\r\n        .map(|_| ())\r\n    }\r\n\r\n    #[test]\r\n    fn test_rollback_of_readonly() -> QueryResult<()> {\r\n        update_with_fallback_query(&mut connect())\r\n    }\r\n\r\n    /// Test that start failing at rev=\"53bad857f30f2f32c14ae295487a88da278fb2fc\"\r\n    #[test]\r\n    fn test_rollback_of_readonly_within_outer_transaction() -> QueryResult<()> {\r\n        connect().transaction(|conn| update_with_fallback_query(conn))\r\n    }\r\n}\r\n```\r\n\r\nFor comparison, here are similar SQL commands run via `psql`:\r\n\r\n```sql\r\nBEGIN;\r\nSAVEPOINT rollback_test;\r\nSET TRANSACTION READ ONLY;\r\nUPDATE rollback_test SET value=1;\r\n-- ERROR:  cannot execute UPDATE in a read-only transaction\r\nSELECT 1;\r\n-- ERROR:  current transaction is aborted, commands ignored until end of transaction block\r\nROLLBACK TO SAVEPOINT rollback_test;\r\nSELECT 1;\r\n-- No longer an error, as we've left the inner transaction.\r\n-- So diesel must not be issuing the expected savepoint rollback.\r\nCOMMIT;\r\n```\r\n\r\n## Checklist\r\n\r\n- [x] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues)  and the [disussion forum](https://github.com/diesel-rs/diesel/discussions)  for similar possible closed issues.\r\n- [x] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n- [x] This issue can be reproduced without requiring a third party crate","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]