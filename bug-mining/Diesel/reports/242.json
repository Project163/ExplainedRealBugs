{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3558","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3558/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3558/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3558/events","html_url":"https://github.com/diesel-rs/diesel/issues/3558","id":1636652195,"node_id":"I_kwDOAnrqL85hjVSj","number":3558,"title":"Binding a null value should never fail","user":{"login":"aeblyve","id":77865363,"node_id":"MDQ6VXNlcjc3ODY1MzYz","avatar_url":"https://avatars.githubusercontent.com/u/77865363?v=4","gravatar_id":"","url":"https://api.github.com/users/aeblyve","html_url":"https://github.com/aeblyve","followers_url":"https://api.github.com/users/aeblyve/followers","following_url":"https://api.github.com/users/aeblyve/following{/other_user}","gists_url":"https://api.github.com/users/aeblyve/gists{/gist_id}","starred_url":"https://api.github.com/users/aeblyve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aeblyve/subscriptions","organizations_url":"https://api.github.com/users/aeblyve/orgs","repos_url":"https://api.github.com/users/aeblyve/repos","events_url":"https://api.github.com/users/aeblyve/events{/privacy}","received_events_url":"https://api.github.com/users/aeblyve/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193212,"node_id":"MDU6TGFiZWwyNTQxOTMyMTI=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":320991993,"node_id":"MDU6TGFiZWwzMjA5OTE5OTM=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/sqlite","name":"sqlite","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-03-23T00:01:02Z","updated_at":"2023-03-31T09:49:54Z","closed_at":"2023-03-31T09:49:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nIf you want to report a bug, we added some points below which help us track down the problem faster.\r\n-->\r\n\r\n## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:**\r\n`rustc 1.68.0`\r\n- **Diesel:**\r\n`2.0.0`\r\n- **Database:**\r\n`Sqlite`\r\n- **Operating System**\r\n`NixOS`\r\n\r\n### Feature Flags\r\n\r\n- **diesel:**\r\n`[\"sqlite\", \"r2d2\"]`\r\n\r\n## Problem Description\r\n\r\n### What are you trying to accomplish?\r\n\r\nPerform a recursive CTE query to load an item from a path spec, using `sql_query` and a struct deriving `QueryableByName`\r\n\r\n### What is the expected output?\r\n\r\nThe columns desired are selected\r\n\r\n### What is the actual output?\r\n\r\n`thread 'rocket-worker-thread' panicked at 'Binding a null value should never fail. If you ever see this error message please open an issue at diesels issue tracker containing code how to trigger this message.: DatabaseError(Unknown, \"column index out of range\")', /home/leonid/.cargo/registry/src/index.crates.io-6f17d22bba15001f/diesel-2.0.3/src/sqlite/connection/stmt.rs:344:22`\r\n\r\n### Are you seeing any additional errors?\r\n\r\nN/A\r\n\r\n\r\n### Steps to reproduce\r\n\r\n<!--\r\nPlease include as much of your codebase as needed to reproduce the error.  If the relevant files are large, please consider linking to a public repository or a [Gist](https://gist.github.com/). This includes normally the following parts:\r\n\r\n* The exact code where your hit the problem\r\n* Relevant parts your schema, so any `table!` macro calls required for the\r\n* Any other type definitions involved in the code, which produces your problem\r\n-->\r\n\r\n#### main.rs\r\n```rust\r\nuse diesel::sql_types::Text;\r\nextern crate diesel;\r\nuse diesel::sqlite::SqliteConnection;\r\nuse diesel::{prelude::*, sql_query};\r\nuse dotenvy::dotenv;\r\nuse std::env;\r\n\r\nmod schema;\r\nmod models;\r\n\r\npub fn establish_connection() -> SqliteConnection {\r\n    dotenv().ok();\r\n    let database_url = env::var(\"DATABASE_URL\").expect(\"DATABASE_URL must be set\");\r\n    SqliteConnection::establish(&database_url)\r\n        .unwrap_or_else(|_| panic!(\"Error connecting to {}\", database_url))\r\n}\r\n\r\npub fn main() {\r\n    let connection = &mut establish_connection();\r\n    use self::models::Page;\r\n\r\n    use self::schema::pages::dsl::*;\r\n\r\n    // RECURSIVE SQL QUERY\r\n\r\n    // Get all paths: then, compare with the path provided\r\n    let child = sql_query(\r\n        r#\"WITH RECURSIVE CTE AS (\r\n             SELECT id, slug AS path\r\n             FROM pages\r\n             WHERE parent_id IS NULL\r\n             UNION ALL\r\n             SELECT p.id, path || '/' || slug\r\n             FROM pages p\r\n             JOIN CTE ON p.parent_id = CTE.id\r\n           )\r\n           SELECT *\r\n           FROM CTE\r\n           WHERE path = '?'\r\n\"#\r\n    );\r\n    let path = String::from(\"foo\");\r\n    println!(\"path spec is {:?}\", path);\r\n    let child = child.bind::<Text, _>(path).load::<Page>(connection);\r\n    println!(\"Child is: {:?}\", child);\r\n}\r\n```\r\n\r\n#### models.rs\r\n```rust\r\nuse crate::schema::pages;\r\nuse diesel::{prelude::*};\r\nuse diesel::sql_types::{Nullable, Integer, Text};\r\n\r\n#[derive(Queryable, QueryableByName, Insertable, Debug)]\r\n#[diesel(primary_key(id))]\r\n#[diesel(table_name = pages)]\r\npub struct Page {\r\n    #[diesel(sql_type = Nullable<Integer>)]\r\n    pub id: Option<i32>,\r\n    #[diesel(sql_type = Nullable<Integer>)]\r\n    pub parent_id: Option<i32>,\r\n    #[diesel(sql_type = Text)]\r\n    pub title: String,\r\n    #[diesel(sql_type = Text)]\r\n    pub slug: String,\r\n    #[diesel(sql_type = Text)]\r\n    pub html_content: String,\r\n}\r\n```\r\n\r\n#### schema.rs\r\n```rust\r\n// @generated automatically by Diesel CLI.\r\n\r\ndiesel::table! {\r\n    pages (id) {\r\n        id -> Nullable<Integer>,\r\n        parent_id -> Nullable<Integer>,\r\n        title -> Text,\r\n        slug -> Text,\r\n        html_content -> Text,\r\n    }\r\n}\r\n\r\n```\r\n\r\n#### up.sql for pages\r\n```sql\r\nCREATE TABLE pages (\r\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n  parent_id INTEGER,\r\n  title TEXT NOT NULL,\r\n  slug TEXT NOT NULL,\r\n  html_content TEXT NOT NULL,\r\n  FOREIGN KEY(parent_id) REFERENCES pages(id) ON DELETE CASCADE\r\n)\r\n```\r\n \r\nDatabase contains one page row in table pages,\r\n\r\n`1 | NULL | foo | foo | <p>bar</p>`\r\n\r\n\r\n## Checklist\r\n\r\n- [X] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues)  and the [disussion forum](https://github.com/diesel-rs/diesel/discussions)  for similar possible closed issues.\r\n<!--\r\nIf you are unsure if your issue is a duplicate of an existing issue please link the issue in question here\r\n--> \r\n- [X] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n- [X] This issue can be reproduced without requiring a third party crate\r\n\r\nI use dotenvy to set up the db, but it is not required.\r\n\r\n<!--\r\nThank you for your submission!  You're helping make Diesel more robust ðŸŽ‰\r\n\r\nWe'll try to respond as quickly as possible.\r\n-->\r\n","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3558/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3558/timeline","performed_via_github_app":null,"state_reason":"completed"}