{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/4349","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/4349/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/4349/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/4349/events","html_url":"https://github.com/diesel-rs/diesel/issues/4349","id":2672942804,"node_id":"I_kwDOAnrqL86fUd7U","number":4349,"title":"`.eq_any([[\"foo\"]])` on `SqlType = Array<Text>` causes runtime error on Postgres","user":{"login":"Ten0","id":9094255,"node_id":"MDQ6VXNlcjkwOTQyNTU=","avatar_url":"https://avatars.githubusercontent.com/u/9094255?v=4","gravatar_id":"","url":"https://api.github.com/users/Ten0","html_url":"https://github.com/Ten0","followers_url":"https://api.github.com/users/Ten0/followers","following_url":"https://api.github.com/users/Ten0/following{/other_user}","gists_url":"https://api.github.com/users/Ten0/gists{/gist_id}","starred_url":"https://api.github.com/users/Ten0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ten0/subscriptions","organizations_url":"https://api.github.com/users/Ten0/orgs","repos_url":"https://api.github.com/users/Ten0/repos","events_url":"https://api.github.com/users/Ten0/events{/privacy}","received_events_url":"https://api.github.com/users/Ten0/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193212,"node_id":"MDU6TGFiZWwyNTQxOTMyMTI=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":254193214,"node_id":"MDU6TGFiZWwyNTQxOTMyMTQ=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-11-19T17:27:41Z","updated_at":"2024-12-01T16:15:45Z","closed_at":"2024-12-01T16:15:45Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Setup\n\n### Versions\n\n- **Diesel:** ce6fa0bd93877391665254d9bdb23a9c895902ef\n- **Database:** Postgres\n\n### Feature Flags\n\n- **diesel:** postgres\n\n## Problem Description\n`array.eq_any(array_of_array)` doesn't work on Postgres, because Postgres doesn't have such a thing as \"array of array\". It has 2D array but [\"2-D array is a different concept\"](https://pgsql-general.postgresql.narkive.com/eJuaaIgQ/could-not-find-array-type-for-data-type-character-varying#post2).\nThis causes an error, so we should probably use the non-specialized ANSI `IN (...)` when dealing with arrays.\n\n### What are you trying to accomplish?\n```rust\ntable! {\n    posts (id) {\n        id -> Int4,\n        // ...\n        tags -> Array<Text>,\n    }\n}\n\n#[test]\n#[cfg(feature = \"postgres\")]\nfn filter_array_by_in() {\n    use crate::schema::posts::dsl::*;\n\n    let connection: &mut PgConnection = &mut connection();\n    let tag_combinations_to_look_for: &[&[&str]] = &[&[\"foo\"], &[\"foo\", \"bar\"], &[\"baz\"]];\n    let result: Vec<i32> = posts\n        .filter(tags.eq_any(tag_combinations_to_look_for))\n        .select(id)\n        .load(connection)\n        .unwrap();\n    assert_eq!(result, &[] as &[i32]);\n}\n```\n\n### What is the actual output?\n```\ncalled `Result::unwrap()` on an `Err` value: DatabaseError(Unknown, \"could not find array type for data type text[]\")\n```\n\n### What is the expected output?\nEither of:\n- test passes, serializing as `IN ($1, $2, $3)` with `$1 = [\"foo\"]`...\n- Doesn't compile, requiring an explicit writing (e.g. `.eq_any(`abc`).ansi()`) to tell it to use ANSI serialization\n\nATM AFAICT there's no way to even tell it to use ANSI serialization because of bounds here:\nhttps://github.com/diesel-rs/diesel/blob/ce6fa0bd93877391665254d9bdb23a9c895902ef/diesel/src/expression/array_comparison.rs#L100-L103\nwhich forbids the use of the ANSI implementation on `Pg` `Backend` (which seems weird since ANSI should always work, no?)\n\n(NB: All of this is useful only to the extent to which indexing will work and this behaves reasonably even if there are 500 different values in there. I recall that we did tend to prefer `= ANY` maybe because of this but I may be mistaken here, was it only for statement caching ?)\n\n### Steps to reproduce\nhttps://github.com/Ten0/diesel/commit/d6c93fd2a8af99df9bc8dc362144e6f599c6030c\n\nor dedicated working branch to fixing this:\n```\ncd diesel\ngit remote add Ten0 https://github.com/Ten0/diesel.git\ngit checkout array_eq_any\ncd diesel_tests\nDATABASE_URL=\"...\" cargo test --no-default-features --features \"postgres\" -- filter_array_by_in --nocapture\n```\n\n","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/4349/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/4349/timeline","performed_via_github_app":null,"state_reason":"completed"}