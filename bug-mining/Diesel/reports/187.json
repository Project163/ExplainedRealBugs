{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2373","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2373/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2373/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2373/events","html_url":"https://github.com/diesel-rs/diesel/issues/2373","id":604670293,"node_id":"MDU6SXNzdWU2MDQ2NzAyOTM=","number":2373,"title":"Deallocation exception when reading MySQL Time columns with \"00:00:00\" value","user":{"login":"alfonso-eusebio","id":9017519,"node_id":"MDQ6VXNlcjkwMTc1MTk=","avatar_url":"https://avatars.githubusercontent.com/u/9017519?v=4","gravatar_id":"","url":"https://api.github.com/users/alfonso-eusebio","html_url":"https://github.com/alfonso-eusebio","followers_url":"https://api.github.com/users/alfonso-eusebio/followers","following_url":"https://api.github.com/users/alfonso-eusebio/following{/other_user}","gists_url":"https://api.github.com/users/alfonso-eusebio/gists{/gist_id}","starred_url":"https://api.github.com/users/alfonso-eusebio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alfonso-eusebio/subscriptions","organizations_url":"https://api.github.com/users/alfonso-eusebio/orgs","repos_url":"https://api.github.com/users/alfonso-eusebio/repos","events_url":"https://api.github.com/users/alfonso-eusebio/events{/privacy}","received_events_url":"https://api.github.com/users/alfonso-eusebio/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193215,"node_id":"MDU6TGFiZWwyNTQxOTMyMTU=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":21,"created_at":"2020-04-22T11:11:48Z","updated_at":"2020-09-25T00:02:52Z","closed_at":"2020-06-10T11:37:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** 1.42.0\r\n- **Diesel:** 1.4.4\r\n- **Database:** MySQL/MariaDB\r\n- **Operating System** Linux\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** features = [\"mysql\", \"chrono\", \"r2d2\"]\r\n\r\n## Problem Description\r\n\r\nWhenever a table row contains a Time value of \"00:00:00\" the application crashes with a \"free(): invalid next size (fast)\" error.\r\n\r\n### What are you trying to accomplish?\r\n\r\nRead Time columns from MySQL/MariaDB that contain values set at midnight (00:00:00).\r\n\r\n### What is the expected output?\r\n\r\nNormal fetching of the rows without the application crashing.\r\n\r\n### What is the actual output?\r\n\r\nApplication crashes with a \"free(): invalid next size (fast)\".\r\n\r\n### Are you seeing any additional errors?\r\n\r\nNo other details shows even if RUST_BACKTRACE=1.\r\n\r\n### Steps to reproduce\r\n\r\nRead a MySQL table with Time columns (not DateTime) that contain \"00:00:00\" values.\r\nThe error happens even if only one of the rows contains a midnight value for Time.\r\n\r\n### Troubleshooting\r\n\r\nI don't believe that this is related to #1130 since the values are converted correctly to NaiveTime.\r\nIn fact, I've even implemented a \"solution\" similar to the one mentioned by @frol in that ticket, adapted to NaiveTime, but it didn't make any difference.\r\n\r\nThrough lots of tests and debugging sessions I've been able to narrow the problem down to the deallocation (drop) of the BindData associated with the connection.\r\nAt the point of the deallocation the data in the Binds structure (the last processed row) could be one with a midnight (00:00:00) value or it could have a non-midnight value; the error happens in both cases. As long as there was a row with a midnight value processed at some point through the StatementIterator the problem will appear.\r\n\r\nBelow is a slightly edited call stack at the point when the application crashes (VS Code debugger). Specifically, the error happens when deallocating the first Time column in the bind data (there are two).\r\n\r\n```\r\n__GI_raise (@raise:45)\r\n__GI_abort (@abort:66)\r\n__libc_message (@__libc_message:180)\r\nmalloc_printerr (@7ffff73b547c..7ffff73b5503:3)\r\n_int_free (@_int_free:201)\r\ndealloc (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/liballoc/alloc.rs:103)\r\ndealloc (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/liballoc/alloc.rs:174)\r\ndealloc_buffer<u8,alloc::alloc::Global> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/liballoc/raw_vec.rs:709)\r\ndrop<u8,alloc::alloc::Global> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/liballoc/raw_vec.rs:719)\r\ndrop_in_place<alloc::raw_vec::RawVec<u8, alloc::alloc::Global>> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\ndrop_in_place<alloc::vec::Vec<u8>> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\ndrop_in_place<diesel::mysql::connection::bind::BindData> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\ndrop_in_place<[diesel::mysql::connection::bind::BindData]> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\ndrop<diesel::mysql::connection::bind::BindData> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/liballoc/vec.rs:2320)\r\ndrop_in_place<alloc::vec::Vec<diesel::mysql::connection::bind::BindData>> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\ndrop_in_place<diesel::mysql::connection::bind::Binds> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\ndrop_in_place<diesel::mysql::connection::stmt::iterator::StatementIterator> (/home/.../.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ptr/mod.rs:174)\r\nmap<closure-0,mnemodia_common::models::week_slot::AccWeekSlot> (/home/.../.cargo/registry/src/github.com-1ecc6299db9ec823/diesel-1.4.4/src/mysql/connection/stmt/iterator.rs:37)\r\nquery_by_index<...> (/home/.../.cargo/registry/src/github.com-1ecc6299db9ec823/diesel-1.4.4/src/mysql/connection/mod.rs:77)\r\nquery_by_index<...> (/home/.../.cargo/registry/src/github.com-1ecc6299db9ec823/diesel-1.4.4/src/r2d2.rs:134)\r\n```\r\n\r\nAt the point of raising the exception I can see that at `_int_free (@_int_free:201)` the `nextsize` variable has a value of \"93825001331200\".\r\nThis is probably the cause of the specific error message. In a \"normal\" deallocation this variable has more reasonable values.\r\n\r\nIf there are no midnight values in any row the deallocation happens without a problem.\r\n\r\nFurthermore, I couldn't see any obvious issues while fetching each row in the method below (/.../diesel-1.4.4/src/mysql/connection/stmt/iterator.rs). `binds` is populated as expected, as far as I can see.\r\n\r\n\r\n```rust\r\nfn populate_row_buffers(stmt: &Statement, binds: &mut Binds) -> QueryResult<Option<()>> {\r\n    let next_row_result = unsafe { ffi::mysql_stmt_fetch(stmt.stmt.as_ptr()) };\r\n    match next_row_result as libc::c_uint {\r\n        ffi::MYSQL_NO_DATA => Ok(None),\r\n        ffi::MYSQL_DATA_TRUNCATED => binds.populate_dynamic_buffers(stmt).map(Some),\r\n        0 => {\r\n            binds.update_buffer_lengths();\r\n            Ok(Some(()))\r\n        }\r\n        _error => stmt.did_an_error_occur().map(Some),\r\n    }\r\n}\r\n```\r\n\r\n## Checklist\r\n\r\n- [X] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues) for similar issues.\r\n- [X] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n\r\n\r\n\r\nI'm not sure if this error is easy to replicate on a different system/DB/table. I'm wondering if it hasn't been reported before because it's not common, or because Time columns aren't used that much (probably DateTime is more common).\r\n\r\nThanks & regards,\r\nAlfonso\r\n\r\n\r\n","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/2373/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/2373/timeline","performed_via_github_app":null,"state_reason":"completed"}