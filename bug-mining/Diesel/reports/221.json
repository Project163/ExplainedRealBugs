{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252/events","html_url":"https://github.com/diesel-rs/diesel/issues/3252","id":1317559344,"node_id":"I_kwDOAnrqL85OiFww","number":3252,"title":"begin_test_transaction behavior changed in Diesel 2.0","user":{"login":"urkle","id":101123,"node_id":"MDQ6VXNlcjEwMTEyMw==","avatar_url":"https://avatars.githubusercontent.com/u/101123?v=4","gravatar_id":"","url":"https://api.github.com/users/urkle","html_url":"https://github.com/urkle","followers_url":"https://api.github.com/users/urkle/followers","following_url":"https://api.github.com/users/urkle/following{/other_user}","gists_url":"https://api.github.com/users/urkle/gists{/gist_id}","starred_url":"https://api.github.com/users/urkle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urkle/subscriptions","organizations_url":"https://api.github.com/users/urkle/orgs","repos_url":"https://api.github.com/users/urkle/repos","events_url":"https://api.github.com/users/urkle/events{/privacy}","received_events_url":"https://api.github.com/users/urkle/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193212,"node_id":"MDU6TGFiZWwyNTQxOTMyMTI=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-26T00:57:23Z","updated_at":"2022-08-15T09:52:31Z","closed_at":"2022-08-15T09:52:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** 1.62.1\r\n- **Diesel:** 2.0.0-rc.1\r\n- **Database:** PG 11\r\n- **Operating System** macOS 12.4\r\n\r\n### Feature Flags\r\n\r\n- **diesel:**  [\"postgres\", \"r2d2\", \"chrono\"]\r\n\r\n## Problem Description\r\n\r\nIn my 1.4.8 diesel usage I had a connection customizer that set the begin_test_transaction\r\n\r\nWhich I injected into my \"test-only\" connection pool which has a max-size of 1.\r\n\r\nThen in my tests I was able to grab the DB connection perform inserts, then drop the connection and pass the pool to the code being tested (e.g. API requests) and it would use the SAME Connection & transaction block.\r\n\r\n### What are you trying to accomplish?\r\n\r\nHappy testing with a single-connection pool.\r\n\r\n### What is the expected output?\r\n\r\nThe tests to run correctly.\r\n\r\n### What is the actual output?\r\n\r\nThe transaction is rolled back once the connection is returned to the pool and thus breaking the tests.  as the code being tests creates a new separate transaction.\r\n\r\n### Are you seeing any additional errors?\r\n\r\n\r\n### Steps to reproduce\r\n\r\nConnection customizer to call begin_test_transaction\r\n\r\n```rust\r\n    #[derive(Debug, Clone, Copy)]\r\n    struct TestConnectionCustomizer;\r\n\r\n    impl<C, E> CustomizeConnection<C, E> for TestConnectionCustomizer\r\n    where\r\n        C: diesel::Connection,\r\n    {\r\n        fn on_acquire(&self, conn: &mut C) -> Result<(), E> {\r\n            conn.begin_test_transaction()\r\n                .expect(\"Failed to start test transaction\");\r\n\r\n            Ok(())\r\n        }\r\n    }\r\n```\r\n\r\nSample test\r\n\r\n```rust\r\n#[tokio::test]\r\nasync fn my_test() {\r\n    let pool  = test_pool();\r\n    let mut db = pool.get().unwrap();\r\n    let user = UserFactory::default().insert(&mut db);\r\n    drop(db);\r\n\r\n    let obj = ObjectToTest::new(&pool);\r\n    obj.some_method(user.id);\r\n\r\n    let mut db = pool.get().unwrap();\r\n    let updated_user = users::table.filter(users::id.eq(user.id)).first(&mut db).unwrap();\r\n    drop(db);\r\n\r\n    assert_eq!(user.name, new_user.name);\r\n}\r\n```\r\n\r\nThis code works under Diesel 1.4.8 but does not in Diesel 2.0.0-rc.1\r\n\r\nHere is raw SQL queries that were run\r\n\r\n- Diesel 1.4.8\r\n\r\n```\r\nexecute <unnamed>: SET TIME ZONE 'UTC'\r\nexecute <unnamed>: SET CLIENT_ENCODING TO 'UTF8'\r\nstatement: BEGIN\r\nexecute <unnamed>: SELECT 1\r\nexecute <unnamed>: INSERT INTO \"users\" (\"name\") VALUES ($1) RETURNING \"users\".\"id\", \"users\".\"name\", \"users\".\"created_at\", \"users\".\"updated_at\"\r\nexecute <unnamed>: SELECT 1\r\nexecute <unnamed>: UPDATE \"users\" SET \"name\" = $1 WHERE \"users\".\"id\" = $2 RETURNING \"users\".\"id\", \"users\".\"name\", \"users\".\"created_at\", \"users\".\"updated_at\"\r\nexecute <unnamed>: SELECT 1\r\nexecute __diesel_stmt_0: SELECT \"users\".\"id\", \"users\".\"name\", \"users\".\"created_at\", \"users\".\"updated_at\" FROM \"users\" WHERE \"users\".\"id\" = $1 LIMIT $2\r\n-- implicit close & rollback\r\n```\r\n\r\n- Diesel 2.0.0-rc.1\r\n\r\n```\r\nexecute <unnamed>: SET TIME ZONE 'UTC'\r\nexecute <unnamed>: SET CLIENT_ENCODING TO 'UTF8'\r\nstatement: BEGIN\r\nexecute <unnamed>: SELECT 1\r\nexecute <unnamed>: INSERT INTO \"users\" (\"name\") VALUES ($1) RETURNING \"users\".\"id\", \"users\".\"name\", \"users\".\"created_at\", \"users\".\"updated_at\"\r\n-- implicit close & rollback\r\nexecute <unnamed>: SET TIME ZONE 'UTC'\r\nexecute <unnamed>: SET CLIENT_ENCODING TO 'UTF8'\r\nstatement: BEGIN\r\nexecute <unnamed>: SELECT 1\r\nexecute <unnamed>: UPDATE \"users\" SET \"name\" = $1 WHERE \"users\".\"id\" = $2 RETURNING \"users\".\"id\", \"users\".\"name\", \"users\".\"created_at\", \"users\".\"updated_at\"\r\n-- implicit close & rollback\r\nexecute <unnamed>: SET TIME ZONE 'UTC'\r\nexecute <unnamed>: SET CLIENT_ENCODING TO 'UTF8'\r\nstatement: BEGIN\r\nexecute <unnamed>: SELECT 1\r\nexecute __diesel_stmt_0: SELECT \"users\".\"id\", \"users\".\"name\", \"users\".\"created_at\", \"users\".\"updated_at\" FROM \"users\" WHERE \"users\".\"id\" = $1 LIMIT $2\r\n-- implicit close & rollback\r\n```\r\n\r\n## Checklist\r\n\r\n- [x] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues)  and the [disussion forum](https://github.com/diesel-rs/diesel/discussions)  for similar possible closed issues.\r\n<!--\r\nIf you are unsure if your issue is a duplicate of an existing issue please link the issue in question here\r\n--> \r\n- [x] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n- [x] This issue can be reproduced without requiring a third party crate\r\n","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252/timeline","performed_via_github_app":null,"state_reason":"completed"}