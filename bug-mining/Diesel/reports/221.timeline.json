[{"id":7060853173,"node_id":"LE_lADOAnrqL85OiFwwzwAAAAGk3BG1","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/7060853173","actor":{"login":"urkle","id":101123,"node_id":"MDQ6VXNlcjEwMTEyMw==","avatar_url":"https://avatars.githubusercontent.com/u/101123?v=4","gravatar_id":"","url":"https://api.github.com/users/urkle","html_url":"https://github.com/urkle","followers_url":"https://api.github.com/users/urkle/followers","following_url":"https://api.github.com/users/urkle/following{/other_user}","gists_url":"https://api.github.com/users/urkle/gists{/gist_id}","starred_url":"https://api.github.com/users/urkle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urkle/subscriptions","organizations_url":"https://api.github.com/users/urkle/orgs","repos_url":"https://api.github.com/users/urkle/repos","events_url":"https://api.github.com/users/urkle/events{/privacy}","received_events_url":"https://api.github.com/users/urkle/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-07-26T00:57:23Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/1195037949","html_url":"https://github.com/diesel-rs/diesel/issues/3252#issuecomment-1195037949","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252","id":1195037949,"node_id":"IC_kwDOAnrqL85HOtT9","user":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-26T05:56:36Z","updated_at":"2022-07-26T05:56:36Z","body":"Thanks for reporting this. This I would not consider this to be a bug, as we explicitly changed the behaviour for returning connection to the pool to consider connections with an open transaction as broken. See https://github.com/diesel-rs/diesel/pull/2935 for details. This was a long standing bug in diesel that a pool could contain connections with open transactions, which could cause all kinds of surprising behaviour.  I'm opposed to roll back that change as it improves the correctness of code in many situations.\r\nI think we should at least document this change more explicitly in our migration guide. If someone has suggestions on how to improve this situation without degrading the other use case, feel free to reach out.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/1195037949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/1195877811","html_url":"https://github.com/diesel-rs/diesel/issues/3252#issuecomment-1195877811","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252","id":1195877811,"node_id":"IC_kwDOAnrqL85HR6Wz","user":{"login":"urkle","id":101123,"node_id":"MDQ6VXNlcjEwMTEyMw==","avatar_url":"https://avatars.githubusercontent.com/u/101123?v=4","gravatar_id":"","url":"https://api.github.com/users/urkle","html_url":"https://github.com/urkle","followers_url":"https://api.github.com/users/urkle/followers","following_url":"https://api.github.com/users/urkle/following{/other_user}","gists_url":"https://api.github.com/users/urkle/gists{/gist_id}","starred_url":"https://api.github.com/users/urkle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urkle/subscriptions","organizations_url":"https://api.github.com/users/urkle/orgs","repos_url":"https://api.github.com/users/urkle/repos","events_url":"https://api.github.com/users/urkle/events{/privacy}","received_events_url":"https://api.github.com/users/urkle/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-26T19:12:00Z","updated_at":"2022-07-26T19:12:00Z","body":"@weiznich I do agree that production use should rollback on pool returning is the best default, sane, and safe behavior. \r\n\r\nThe question then is there a way I can \"reconfigure\" a pool (or create a pool-like object) to behave in a way that allows only 1 connection that maintains a transaction for the duration of that pool. \r\n\r\nAs right now I will be unable to move to Diesel 2 because of this issue as tests will no longer work in this mode. (I was really wanting to gain access to the alias! macro!)\r\n\r\nWould you be opposed to a PR adding a \"mock\" testing pool?  The real issue comes down when I am testing APIs that accept a pool not a single connection.. (in my case warp routes, or async_graphql Objects, loaders, and mutations, etc).  All things that cannot accept a single connection.   The way my code is setup everything access a New Type that I have for my DatabasePool so 99% of my code has no idea what a pool actually is, so long as it provides get()?. (which I would assume most code-bases would behave similarly).\r\n\r\nFrom looking at the code it appears the only thing I need to do is provide an alternate ConnectionManager that doesn't perform the is_broken() checks.. This method, however, seems badly named as the implementations are currently checking for outstanding or failed .  transactions. It would be nicer if there was a specific method giving me the transactions state, thus for this \"TestConnectionManager\" I could only claim \"is_broken\" when the transaction manager is in an error state only.\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/1195877811/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"urkle","id":101123,"node_id":"MDQ6VXNlcjEwMTEyMw==","avatar_url":"https://avatars.githubusercontent.com/u/101123?v=4","gravatar_id":"","url":"https://api.github.com/users/urkle","html_url":"https://github.com/urkle","followers_url":"https://api.github.com/users/urkle/followers","following_url":"https://api.github.com/users/urkle/following{/other_user}","gists_url":"https://api.github.com/users/urkle/gists{/gist_id}","starred_url":"https://api.github.com/users/urkle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urkle/subscriptions","organizations_url":"https://api.github.com/users/urkle/orgs","repos_url":"https://api.github.com/users/urkle/repos","events_url":"https://api.github.com/users/urkle/events{/privacy}","received_events_url":"https://api.github.com/users/urkle/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7067508715,"node_id":"MEE_lADOAnrqL85OiFwwzwAAAAGlQZ_r","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/7067508715","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-07-26T19:12:00Z","performed_via_github_app":null},{"id":7067508718,"node_id":"SE_lADOAnrqL85OiFwwzwAAAAGlQZ_u","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/7067508718","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-07-26T19:12:00Z","performed_via_github_app":null},{"id":7076174801,"node_id":"REFE_lADOAnrqL85OiFwwzwAAAAGlxdvR","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/7076174801","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2942e292059eb5e8cc5ad8adb58a8d1cec385aa7","commit_url":"https://api.github.com/repos/weiznich/diesel/commits/2942e292059eb5e8cc5ad8adb58a8d1cec385aa7","created_at":"2022-07-27T19:57:31Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/1197303392","html_url":"https://github.com/diesel-rs/diesel/issues/3252#issuecomment-1197303392","issue_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3252","id":1197303392,"node_id":"IC_kwDOAnrqL85HXWZg","user":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-27T19:58:59Z","updated_at":"2022-07-27T19:58:59Z","body":"I've opened #3254 with an potential fix for this.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments/1197303392/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"Ten0","id":9094255,"node_id":"MDQ6VXNlcjkwOTQyNTU=","avatar_url":"https://avatars.githubusercontent.com/u/9094255?v=4","gravatar_id":"","url":"https://api.github.com/users/Ten0","html_url":"https://github.com/Ten0","followers_url":"https://api.github.com/users/Ten0/followers","following_url":"https://api.github.com/users/Ten0/following{/other_user}","gists_url":"https://api.github.com/users/Ten0/gists{/gist_id}","starred_url":"https://api.github.com/users/Ten0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ten0/subscriptions","organizations_url":"https://api.github.com/users/Ten0/orgs","repos_url":"https://api.github.com/users/Ten0/repos","events_url":"https://api.github.com/users/Ten0/events{/privacy}","received_events_url":"https://api.github.com/users/Ten0/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-28T13:58:10Z","updated_at":"2022-07-28T13:58:10Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sfackler/r2d2/issues/130","repository_url":"https://api.github.com/repos/sfackler/r2d2","labels_url":"https://api.github.com/repos/sfackler/r2d2/issues/130/labels{/name}","comments_url":"https://api.github.com/repos/sfackler/r2d2/issues/130/comments","events_url":"https://api.github.com/repos/sfackler/r2d2/issues/130/events","html_url":"https://github.com/sfackler/r2d2/issues/130","id":1320976648,"node_id":"I_kwDOAVlJ5c5OvIEI","number":130,"title":"Allow hooking on connection get-from-pool and release-to-pool","user":{"login":"Ten0","id":9094255,"node_id":"MDQ6VXNlcjkwOTQyNTU=","avatar_url":"https://avatars.githubusercontent.com/u/9094255?v=4","gravatar_id":"","url":"https://api.github.com/users/Ten0","html_url":"https://github.com/Ten0","followers_url":"https://api.github.com/users/Ten0/followers","following_url":"https://api.github.com/users/Ten0/following{/other_user}","gists_url":"https://api.github.com/users/Ten0/gists{/gist_id}","starred_url":"https://api.github.com/users/Ten0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ten0/subscriptions","organizations_url":"https://api.github.com/users/Ten0/orgs","repos_url":"https://api.github.com/users/Ten0/repos","events_url":"https://api.github.com/users/Ten0/events{/privacy}","received_events_url":"https://api.github.com/users/Ten0/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-07-28T13:58:10Z","updated_at":"2022-08-01T10:25:54Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":22628837,"node_id":"MDEwOlJlcG9zaXRvcnkyMjYyODgzNw==","name":"r2d2","full_name":"sfackler/r2d2","private":false,"owner":{"login":"sfackler","id":1455697,"node_id":"MDQ6VXNlcjE0NTU2OTc=","avatar_url":"https://avatars.githubusercontent.com/u/1455697?v=4","gravatar_id":"","url":"https://api.github.com/users/sfackler","html_url":"https://github.com/sfackler","followers_url":"https://api.github.com/users/sfackler/followers","following_url":"https://api.github.com/users/sfackler/following{/other_user}","gists_url":"https://api.github.com/users/sfackler/gists{/gist_id}","starred_url":"https://api.github.com/users/sfackler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfackler/subscriptions","organizations_url":"https://api.github.com/users/sfackler/orgs","repos_url":"https://api.github.com/users/sfackler/repos","events_url":"https://api.github.com/users/sfackler/events{/privacy}","received_events_url":"https://api.github.com/users/sfackler/received_events","type":"User","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sfackler/r2d2","description":"A generic connection pool for Rust","fork":false,"url":"https://api.github.com/repos/sfackler/r2d2","forks_url":"https://api.github.com/repos/sfackler/r2d2/forks","keys_url":"https://api.github.com/repos/sfackler/r2d2/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sfackler/r2d2/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sfackler/r2d2/teams","hooks_url":"https://api.github.com/repos/sfackler/r2d2/hooks","issue_events_url":"https://api.github.com/repos/sfackler/r2d2/issues/events{/number}","events_url":"https://api.github.com/repos/sfackler/r2d2/events","assignees_url":"https://api.github.com/repos/sfackler/r2d2/assignees{/user}","branches_url":"https://api.github.com/repos/sfackler/r2d2/branches{/branch}","tags_url":"https://api.github.com/repos/sfackler/r2d2/tags","blobs_url":"https://api.github.com/repos/sfackler/r2d2/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sfackler/r2d2/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sfackler/r2d2/git/refs{/sha}","trees_url":"https://api.github.com/repos/sfackler/r2d2/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sfackler/r2d2/statuses/{sha}","languages_url":"https://api.github.com/repos/sfackler/r2d2/languages","stargazers_url":"https://api.github.com/repos/sfackler/r2d2/stargazers","contributors_url":"https://api.github.com/repos/sfackler/r2d2/contributors","subscribers_url":"https://api.github.com/repos/sfackler/r2d2/subscribers","subscription_url":"https://api.github.com/repos/sfackler/r2d2/subscription","commits_url":"https://api.github.com/repos/sfackler/r2d2/commits{/sha}","git_commits_url":"https://api.github.com/repos/sfackler/r2d2/git/commits{/sha}","comments_url":"https://api.github.com/repos/sfackler/r2d2/comments{/number}","issue_comment_url":"https://api.github.com/repos/sfackler/r2d2/issues/comments{/number}","contents_url":"https://api.github.com/repos/sfackler/r2d2/contents/{+path}","compare_url":"https://api.github.com/repos/sfackler/r2d2/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sfackler/r2d2/merges","archive_url":"https://api.github.com/repos/sfackler/r2d2/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sfackler/r2d2/downloads","issues_url":"https://api.github.com/repos/sfackler/r2d2/issues{/number}","pulls_url":"https://api.github.com/repos/sfackler/r2d2/pulls{/number}","milestones_url":"https://api.github.com/repos/sfackler/r2d2/milestones{/number}","notifications_url":"https://api.github.com/repos/sfackler/r2d2/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sfackler/r2d2/labels{/name}","releases_url":"https://api.github.com/repos/sfackler/r2d2/releases{/id}","deployments_url":"https://api.github.com/repos/sfackler/r2d2/deployments","created_at":"2014-08-05T03:25:09Z","updated_at":"2025-11-09T23:38:58Z","pushed_at":"2024-10-10T01:01:52Z","git_url":"git://github.com/sfackler/r2d2.git","ssh_url":"git@github.com:sfackler/r2d2.git","clone_url":"https://github.com/sfackler/r2d2.git","svn_url":"https://github.com/sfackler/r2d2","homepage":"","size":316,"stargazers_count":1622,"watchers_count":1622,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":84,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":25,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":84,"open_issues":25,"watchers":1622,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"In some cases, specific initialization/cleanup needs to be done around managed connections when fetching them from the pool and releasing them to the pool.\r\n\r\ne.g.:\r\n1. https://github.com/diesel-rs/diesel/issues/3252 with solution suggested [here](https://github.com/diesel-rs/diesel/pull/3254#issuecomment-1197380759)\r\n2. Attempting to close any open transaction on release-to-pool (solution where transactions are generally managed with RAII as suggested [here](https://github.com/sfackler/r2d2/issues/31#issuecomment-618946083) have the issues described [here](https://github.com/diesel-rs/diesel/issues/399#issuecomment-684726924)).\r\n\r\nCurrently this requires having custom wrappers around `PooledConnection` and `Pool`, which prevents from always using r2d2 directly (and requires reimplementing a whole bunch of traits on the wrappers).\r\n\r\nSomething that would remove this need would be to add `on_take_from_pool` and `on_release_to_pool` hooks to [`CustomizeConnection`](https://docs.rs/r2d2/0.8.10/r2d2/trait.CustomizeConnection.html) (or another trait if we want backwards-compat.) and/or [`ManageConnection`](https://docs.rs/r2d2/latest/r2d2/trait.ManageConnection.html).\r\n\r\nThat would solve 1. by allowing users to automatically open a test transaction `on_take_from_pool` and rolling it back `on_release_to_pool` (`on_release_to_pool` would have to be called before `is_valid`).\r\n\r\nThat would solve 2. by allowing users (and/or implementors of `ManageConnection`) to automatically *attempt* closing any open transactions `on_release_to_pool` in any way they see fit.\r\n\r\nI would imagine the overhead of the `CustomizeConnection` one to be really-not-too-high despite the dynamic dispatch because that would be absolutely negligible compared with what we actually do with the connection. (And obviously the overhead of the `ManageConnection` one would be zero because the statically dispatched no-op would be optimized out.)\r\n\r\nWould that be something that makes sense and could potentially be added to r2d2?\r\n\r\nThanks,","reactions":{"url":"https://api.github.com/repos/sfackler/r2d2/issues/130/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sfackler/r2d2/issues/130/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-29T07:07:29Z","updated_at":"2022-07-29T07:07:29Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3254","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3254/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3254/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3254/events","html_url":"https://github.com/diesel-rs/diesel/pull/3254","id":1320061430,"node_id":"PR_kwDOAnrqL848NHoi","number":3254,"title":"Fix #3252","user":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-07-27T19:57:52Z","updated_at":"2022-08-15T09:52:29Z","closed_at":"2022-08-15T09:52:29Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":41609775,"node_id":"MDEwOlJlcG9zaXRvcnk0MTYwOTc3NQ==","name":"diesel","full_name":"diesel-rs/diesel","private":false,"owner":{"login":"diesel-rs","id":16763251,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE2NzYzMjUx","avatar_url":"https://avatars.githubusercontent.com/u/16763251?v=4","gravatar_id":"","url":"https://api.github.com/users/diesel-rs","html_url":"https://github.com/diesel-rs","followers_url":"https://api.github.com/users/diesel-rs/followers","following_url":"https://api.github.com/users/diesel-rs/following{/other_user}","gists_url":"https://api.github.com/users/diesel-rs/gists{/gist_id}","starred_url":"https://api.github.com/users/diesel-rs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diesel-rs/subscriptions","organizations_url":"https://api.github.com/users/diesel-rs/orgs","repos_url":"https://api.github.com/users/diesel-rs/repos","events_url":"https://api.github.com/users/diesel-rs/events{/privacy}","received_events_url":"https://api.github.com/users/diesel-rs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/diesel-rs/diesel","description":"A safe, extensible ORM and Query Builder for Rust","fork":false,"url":"https://api.github.com/repos/diesel-rs/diesel","forks_url":"https://api.github.com/repos/diesel-rs/diesel/forks","keys_url":"https://api.github.com/repos/diesel-rs/diesel/keys{/key_id}","collaborators_url":"https://api.github.com/repos/diesel-rs/diesel/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/diesel-rs/diesel/teams","hooks_url":"https://api.github.com/repos/diesel-rs/diesel/hooks","issue_events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/events{/number}","events_url":"https://api.github.com/repos/diesel-rs/diesel/events","assignees_url":"https://api.github.com/repos/diesel-rs/diesel/assignees{/user}","branches_url":"https://api.github.com/repos/diesel-rs/diesel/branches{/branch}","tags_url":"https://api.github.com/repos/diesel-rs/diesel/tags","blobs_url":"https://api.github.com/repos/diesel-rs/diesel/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/diesel-rs/diesel/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/diesel-rs/diesel/git/refs{/sha}","trees_url":"https://api.github.com/repos/diesel-rs/diesel/git/trees{/sha}","statuses_url":"https://api.github.com/repos/diesel-rs/diesel/statuses/{sha}","languages_url":"https://api.github.com/repos/diesel-rs/diesel/languages","stargazers_url":"https://api.github.com/repos/diesel-rs/diesel/stargazers","contributors_url":"https://api.github.com/repos/diesel-rs/diesel/contributors","subscribers_url":"https://api.github.com/repos/diesel-rs/diesel/subscribers","subscription_url":"https://api.github.com/repos/diesel-rs/diesel/subscription","commits_url":"https://api.github.com/repos/diesel-rs/diesel/commits{/sha}","git_commits_url":"https://api.github.com/repos/diesel-rs/diesel/git/commits{/sha}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/comments{/number}","issue_comment_url":"https://api.github.com/repos/diesel-rs/diesel/issues/comments{/number}","contents_url":"https://api.github.com/repos/diesel-rs/diesel/contents/{+path}","compare_url":"https://api.github.com/repos/diesel-rs/diesel/compare/{base}...{head}","merges_url":"https://api.github.com/repos/diesel-rs/diesel/merges","archive_url":"https://api.github.com/repos/diesel-rs/diesel/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/diesel-rs/diesel/downloads","issues_url":"https://api.github.com/repos/diesel-rs/diesel/issues{/number}","pulls_url":"https://api.github.com/repos/diesel-rs/diesel/pulls{/number}","milestones_url":"https://api.github.com/repos/diesel-rs/diesel/milestones{/number}","notifications_url":"https://api.github.com/repos/diesel-rs/diesel/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/diesel-rs/diesel/labels{/name}","releases_url":"https://api.github.com/repos/diesel-rs/diesel/releases{/id}","deployments_url":"https://api.github.com/repos/diesel-rs/diesel/deployments","created_at":"2015-08-29T22:51:00Z","updated_at":"2025-11-09T19:31:55Z","pushed_at":"2025-11-07T18:13:31Z","git_url":"git://github.com/diesel-rs/diesel.git","ssh_url":"git@github.com:diesel-rs/diesel.git","clone_url":"https://github.com/diesel-rs/diesel.git","svn_url":"https://github.com/diesel-rs/diesel","homepage":"https://diesel.rs","size":109357,"stargazers_count":13771,"watchers_count":13771,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":1168,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":153,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["mysql","orm","postgresql","query-builder","rust","sqlite"],"visibility":"public","forks":1168,"open_issues":153,"watchers":13771,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/diesel-rs/diesel/pulls/3254","html_url":"https://github.com/diesel-rs/diesel/pull/3254","diff_url":"https://github.com/diesel-rs/diesel/pull/3254.diff","patch_url":"https://github.com/diesel-rs/diesel/pull/3254.patch","merged_at":"2022-08-15T09:52:29Z"},"body":"This commit fixes an issue where test transactions caused connection to\r\nbe marked as broken when returned to a r2d2 connection pool. It is a\r\nquite common pattern to create a connection pool with 1 connection, and\r\ncall `begin_test_transaction` on the connection before putting it into\r\nthe pool. This allows users to easily test applications using connection\r\npools without modifying an existing schema. The recent changes to our\r\ntransaction manager implementation + our r2d2 implementation broke this\r\npattern.\r\n\r\nThis commit introduces an additional flag inside of the transaction\r\nmanager state, which tracks whether `begin_test_transaction` was called\r\nor not. This flag is later used to decide whether a connection should be\r\nconsidered broken or not.\r\n\r\nIn addition this commit centralises the `is_broken`  implementation as\r\npart of the transaction manager itself + marks\r\n`transaction_manager_status_mut` as part of the unstable public\r\nAPI (this method is only useful for third party connection or\r\ntransactionmanager implementations)","reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3254/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3254/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":7187472475,"node_id":"CE_lADOAnrqL85OiFwwzwAAAAGsaCBb","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/7187472475","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"2942e292059eb5e8cc5ad8adb58a8d1cec385aa7","commit_url":"https://api.github.com/repos/diesel-rs/diesel/commits/2942e292059eb5e8cc5ad8adb58a8d1cec385aa7","created_at":"2022-08-15T09:52:31Z","state_reason":null,"performed_via_github_app":null},{"id":7187472481,"node_id":"REFE_lADOAnrqL85OiFwwzwAAAAGsaCBh","url":"https://api.github.com/repos/diesel-rs/diesel/issues/events/7187472481","actor":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"87d7d64e79e841a94bb9763a3c687e0385c07a97","commit_url":"https://api.github.com/repos/diesel-rs/diesel/commits/87d7d64e79e841a94bb9763a3c687e0385c07a97","created_at":"2022-08-15T09:52:32Z","performed_via_github_app":null}]