{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470","repository_url":"https://api.github.com/repos/diesel-rs/diesel","labels_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/labels{/name}","comments_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/comments","events_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/events","html_url":"https://github.com/diesel-rs/diesel/issues/3470","id":1528289154,"node_id":"I_kwDOAnrqL85bF9eC","number":3470,"title":"A `ReadOnlyTransaction` error within an inner transaction doesn't rollback the savepoint","user":{"login":"jtgeibel","id":22186,"node_id":"MDQ6VXNlcjIyMTg2","avatar_url":"https://avatars.githubusercontent.com/u/22186?v=4","gravatar_id":"","url":"https://api.github.com/users/jtgeibel","html_url":"https://github.com/jtgeibel","followers_url":"https://api.github.com/users/jtgeibel/followers","following_url":"https://api.github.com/users/jtgeibel/following{/other_user}","gists_url":"https://api.github.com/users/jtgeibel/gists{/gist_id}","starred_url":"https://api.github.com/users/jtgeibel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtgeibel/subscriptions","organizations_url":"https://api.github.com/users/jtgeibel/orgs","repos_url":"https://api.github.com/users/jtgeibel/repos","events_url":"https://api.github.com/users/jtgeibel/events{/privacy}","received_events_url":"https://api.github.com/users/jtgeibel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":254193212,"node_id":"MDU6TGFiZWwyNTQxOTMyMTI=","url":"https://api.github.com/repos/diesel-rs/diesel/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2023-01-11T02:09:41Z","updated_at":"2023-01-24T16:47:12Z","closed_at":"2023-01-16T15:07:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Setup\r\n\r\n### Versions\r\n\r\n- **Rust:** 1.66\r\n- **Diesel:** 2.0.2\r\n- **Database:** PostgreSQL 14.6\r\n- **Operating System:** Ubuntu 22.10\r\n\r\n### Feature Flags\r\n\r\n- **diesel:** [\"postgres\"]\r\n\r\n## Problem Description\r\n\r\nStarting with diesel `2.0.0-rc.1` (commit 53bad857f30f2f32c14ae295487a88da278fb2fc of #3211) when within a nested transaction, if the inner transaction aborts because it attempts to mutate within a read-only transaction, then the connection is left in a bad state even outside of the inner transaction. Any further commands result in `current transaction is aborted, commands ignored until end of transaction block` until the outermost transaction is also rolled back. It appears that the SAVEPOINT for the inner transaction is not actually rolled back, as the equivalent series of SQL commands (including a `ROLLBACK TO SAVEPOINT ...`) does not result in such an error in `psql`.\r\n\r\n### What are you trying to accomplish?\r\n\r\nI am trying to port crates.io to diesel 2.0. Our tests are run within an outer transaction that rolls back when the test completes. In production the code will continue to work as expected as this code path has just the one transaction, but the additional transaction wrapping the entire test causes this test to fail.\r\n\r\n### What is the expected output?\r\n\r\nIt is expected that if a nested transaction encounters a `ReadOnlyTransaction` error then it should still rollback to the appropriate SAVEPOINT so that future read-only commands (such as SELECT) can be executed.\r\n\r\n### What is the actual output?\r\n\r\nThe observed output is an error stating `current transaction is aborted, commands ignored until end of transaction block`.\r\n\r\n### Are you seeing any additional errors?\r\n\r\nNo additional errors are seen.\r\n\r\n### Steps to reproduce\r\n\r\nCreate a simple test table with `cargo run` and then run `cargo test`. In diesel releases starting with `2.0.0-rc.1` the 2nd test fails with `Error: DatabaseError(Unknown, \"current transaction is aborted, commands ignored until end of transaction block\")`.\r\n\r\n```rust\r\nuse diesel::{prelude::*, sql_query};\r\n\r\nconst DATABASE_URL: &str = \"postgres:///\";\r\n\r\nfn connect() -> PgConnection {\r\n    PgConnection::establish(DATABASE_URL).unwrap()\r\n}\r\n\r\nfn main() {\r\n    sql_query(\"CREATE TABLE rollback_test (id INT PRIMARY KEY, value INT NOT NULL)\")\r\n        .execute(&mut connect())\r\n        .unwrap();\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use diesel::update;\r\n\r\n    diesel::table! {\r\n        rollback_test (id) {\r\n            id -> Int4,\r\n            value -> Int4,\r\n        }\r\n    }\r\n\r\n    fn update_with_fallback_query(conn: &mut PgConnection) -> QueryResult<()> {\r\n        conn.transaction(|conn| {\r\n            sql_query(\"SET TRANSACTION READ ONLY\").execute(conn)?;\r\n            dbg!(update(rollback_test::table)\r\n                .set(rollback_test::value.eq(0))\r\n                .execute(conn))\r\n        })\r\n        .or_else(|_| sql_query(\"SELECT 1\").execute(conn))\r\n        .map(|_| ())\r\n    }\r\n\r\n    #[test]\r\n    fn test_rollback_of_readonly() -> QueryResult<()> {\r\n        update_with_fallback_query(&mut connect())\r\n    }\r\n\r\n    /// Test that start failing at rev=\"53bad857f30f2f32c14ae295487a88da278fb2fc\"\r\n    #[test]\r\n    fn test_rollback_of_readonly_within_outer_transaction() -> QueryResult<()> {\r\n        connect().transaction(|conn| update_with_fallback_query(conn))\r\n    }\r\n}\r\n```\r\n\r\nFor comparison, here are similar SQL commands run via `psql`:\r\n\r\n```sql\r\nBEGIN;\r\nSAVEPOINT rollback_test;\r\nSET TRANSACTION READ ONLY;\r\nUPDATE rollback_test SET value=1;\r\n-- ERROR:  cannot execute UPDATE in a read-only transaction\r\nSELECT 1;\r\n-- ERROR:  current transaction is aborted, commands ignored until end of transaction block\r\nROLLBACK TO SAVEPOINT rollback_test;\r\nSELECT 1;\r\n-- No longer an error, as we've left the inner transaction.\r\n-- So diesel must not be issuing the expected savepoint rollback.\r\nCOMMIT;\r\n```\r\n\r\n## Checklist\r\n\r\n- [x] I have already looked over the [issue tracker](https://github.com/diesel-rs/diesel/issues)  and the [disussion forum](https://github.com/diesel-rs/diesel/discussions)  for similar possible closed issues.\r\n- [x] This issue can be reproduced on Rust's stable channel. (Your issue will be\r\n  closed if this is not the case)\r\n- [x] This issue can be reproduced without requiring a third party crate","closed_by":{"login":"weiznich","id":1674512,"node_id":"MDQ6VXNlcjE2NzQ1MTI=","avatar_url":"https://avatars.githubusercontent.com/u/1674512?v=4","gravatar_id":"","url":"https://api.github.com/users/weiznich","html_url":"https://github.com/weiznich","followers_url":"https://api.github.com/users/weiznich/followers","following_url":"https://api.github.com/users/weiznich/following{/other_user}","gists_url":"https://api.github.com/users/weiznich/gists{/gist_id}","starred_url":"https://api.github.com/users/weiznich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weiznich/subscriptions","organizations_url":"https://api.github.com/users/weiznich/orgs","repos_url":"https://api.github.com/users/weiznich/repos","events_url":"https://api.github.com/users/weiznich/events{/privacy}","received_events_url":"https://api.github.com/users/weiznich/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/diesel-rs/diesel/issues/3470/timeline","performed_via_github_app":null,"state_reason":"completed"}