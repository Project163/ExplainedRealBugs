{"url":"https://api.github.com/repos/akka/akka-core/issues/29730","repository_url":"https://api.github.com/repos/akka/akka-core","labels_url":"https://api.github.com/repos/akka/akka-core/issues/29730/labels{/name}","comments_url":"https://api.github.com/repos/akka/akka-core/issues/29730/comments","events_url":"https://api.github.com/repos/akka/akka-core/issues/29730/events","html_url":"https://github.com/akka/akka-core/issues/29730","id":719154987,"node_id":"MDU6SXNzdWU3MTkxNTQ5ODc=","number":29730,"title":"ActorGraphInterpreter enter limbo state when interpreter completes but a new shell registration is pending","user":{"login":"eyalfa","id":1131833,"node_id":"MDQ6VXNlcjExMzE4MzM=","avatar_url":"https://avatars.githubusercontent.com/u/1131833?v=4","gravatar_id":"","url":"https://api.github.com/users/eyalfa","html_url":"https://github.com/eyalfa","followers_url":"https://api.github.com/users/eyalfa/followers","following_url":"https://api.github.com/users/eyalfa/following{/other_user}","gists_url":"https://api.github.com/users/eyalfa/gists{/gist_id}","starred_url":"https://api.github.com/users/eyalfa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eyalfa/subscriptions","organizations_url":"https://api.github.com/users/eyalfa/orgs","repos_url":"https://api.github.com/users/eyalfa/repos","events_url":"https://api.github.com/users/eyalfa/events{/privacy}","received_events_url":"https://api.github.com/users/eyalfa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":92356850,"node_id":"MDU6TGFiZWw5MjM1Njg1MA==","url":"https://api.github.com/repos/akka/akka-core/labels/3%20-%20in%20progress","name":"3 - in progress","color":"eb6420","default":false,"description":"Someone is working on this ticket"},{"id":92619677,"node_id":"MDU6TGFiZWw5MjYxOTY3Nw==","url":"https://api.github.com/repos/akka/akka-core/labels/bug","name":"bug","color":"e11d21","default":true,"description":null},{"id":93144690,"node_id":"MDU6TGFiZWw5MzE0NDY5MA==","url":"https://api.github.com/repos/akka/akka-core/labels/t:stream","name":"t:stream","color":"cccccc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/akka/akka-core/milestones/171","html_url":"https://github.com/akka/akka-core/milestone/171","labels_url":"https://api.github.com/repos/akka/akka-core/milestones/171/labels","id":5973116,"node_id":"MDk6TWlsZXN0b25lNTk3MzExNg==","number":171,"title":"2.6.11","description":"","creator":{"login":"patriknw","id":336161,"node_id":"MDQ6VXNlcjMzNjE2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/336161?v=4","gravatar_id":"","url":"https://api.github.com/users/patriknw","html_url":"https://github.com/patriknw","followers_url":"https://api.github.com/users/patriknw/followers","following_url":"https://api.github.com/users/patriknw/following{/other_user}","gists_url":"https://api.github.com/users/patriknw/gists{/gist_id}","starred_url":"https://api.github.com/users/patriknw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/patriknw/subscriptions","organizations_url":"https://api.github.com/users/patriknw/orgs","repos_url":"https://api.github.com/users/patriknw/repos","events_url":"https://api.github.com/users/patriknw/events{/privacy}","received_events_url":"https://api.github.com/users/patriknw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":85,"state":"closed","created_at":"2020-10-09T10:26:01Z","updated_at":"2021-01-15T10:28:26Z","due_on":null,"closed_at":"2021-01-15T10:28:26Z"},"comments":9,"created_at":"2020-10-12T07:53:58Z","updated_at":"2020-11-25T10:03:32Z","closed_at":"2020-10-27T12:11:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"we've recently deployed a new version of our service, after half a day we've observed unusual heap size and gc activity.\r\n\r\nwhile analyzing a heap dump from our production environment we saw a lot of ActorCell instances, closer look shows that great portion of them were `ActorGraphInterpreter`s.\r\n\r\nExamining these actors internal state (as visible in the heap dump) revealed that all of them were in a limbo state where `activeInterpreters` was empty and `newShells` was not and contained a single shell with three logics: SubSource, identity flow and SubSink.\r\nfurthermore, the SubSink's internal state was `CancelScheduledBeforeMaterialization` and SubSource's internal state was `ActorSubscriberMessage.OnComplete`.\r\n\r\nsince the SubSource object's name was referring to `flamMapPrefix` it was obvious this new shell was materialized by `FlatMapPrefix`.\r\ngoing over our change log between the two deployments we were able to track a new indirect usage of `flatMapPrefix` via `Flow.lazyFutureFlow` which uses the identity flow when upstream completes without producing any elements.\r\n\r\nThe SubSource's internal state (onComplete message) suggests that `flatMapPrefix`'s upstream actually completed without producing any elements, the internal state of the SubSink also suggest that it was closed prior to being registered (right after materialization).\r\n\r\nit seems that `flatMapPrefix` handled both upstreamFinished and downstream cancellation before the materialized internal flow was registered, then when the actor graph interpreter regained control it saw that the current interpreter completed but somehow missed the newShell (speculating here) which put it in a limbo state where it await messages that will never come but not stopped either.\r\n\r\nlooking at the code I can see two potential issues in the source code:\r\n1. `flatMapPrefix` doesn't set `keepGoing' to true, so once both its ports are closed, the interpreter considers it closed as well.\r\n2. there seems to be a bug in the condition in `akka.stream.impl.fusing.ActorGraphInterpreter#shortCircuitBatch` which doesn't consider `newShells`:\r\n```\r\nwhile (!shortCircuitBuffer.isEmpty && currentLimit > 0 && activeInterpreters.nonEmpty)\r\n```\r\nnotice that in case all current interpreters are complete but there is one pending newShell, this condition will prevent the actor from seeing the `Resume` message in the `shortCircuitBuffer` which puts the actor int the limbo state described above.\r\n","closed_by":{"login":"jrudolph","id":9868,"node_id":"MDQ6VXNlcjk4Njg=","avatar_url":"https://avatars.githubusercontent.com/u/9868?v=4","gravatar_id":"","url":"https://api.github.com/users/jrudolph","html_url":"https://github.com/jrudolph","followers_url":"https://api.github.com/users/jrudolph/followers","following_url":"https://api.github.com/users/jrudolph/following{/other_user}","gists_url":"https://api.github.com/users/jrudolph/gists{/gist_id}","starred_url":"https://api.github.com/users/jrudolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrudolph/subscriptions","organizations_url":"https://api.github.com/users/jrudolph/orgs","repos_url":"https://api.github.com/users/jrudolph/repos","events_url":"https://api.github.com/users/jrudolph/events{/privacy}","received_events_url":"https://api.github.com/users/jrudolph/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/akka/akka-core/issues/29730/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/akka/akka-core/issues/29730/timeline","performed_via_github_app":null,"state_reason":"completed"}