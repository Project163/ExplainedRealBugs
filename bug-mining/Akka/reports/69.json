{"url":"https://api.github.com/repos/akka/akka-core/issues/27381","repository_url":"https://api.github.com/repos/akka/akka-core","labels_url":"https://api.github.com/repos/akka/akka-core/issues/27381/labels{/name}","comments_url":"https://api.github.com/repos/akka/akka-core/issues/27381/comments","events_url":"https://api.github.com/repos/akka/akka-core/issues/27381/events","html_url":"https://github.com/akka/akka-core/issues/27381","id":470042239,"node_id":"MDU6SXNzdWU0NzAwNDIyMzk=","number":27381,"title":"akka-persistence-typed is loosing commands received while snapshots are created","user":{"login":"IainHull","id":1557773,"node_id":"MDQ6VXNlcjE1NTc3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/1557773?v=4","gravatar_id":"","url":"https://api.github.com/users/IainHull","html_url":"https://github.com/IainHull","followers_url":"https://api.github.com/users/IainHull/followers","following_url":"https://api.github.com/users/IainHull/following{/other_user}","gists_url":"https://api.github.com/users/IainHull/gists{/gist_id}","starred_url":"https://api.github.com/users/IainHull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/IainHull/subscriptions","organizations_url":"https://api.github.com/users/IainHull/orgs","repos_url":"https://api.github.com/users/IainHull/repos","events_url":"https://api.github.com/users/IainHull/events{/privacy}","received_events_url":"https://api.github.com/users/IainHull/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":92356828,"node_id":"MDU6TGFiZWw5MjM1NjgyOA==","url":"https://api.github.com/repos/akka/akka-core/labels/1%20-%20triaged","name":"1 - triaged","color":"5319e7","default":false,"description":"Tickets that are safe to pick up for contributing in terms of likeliness of being accepted"},{"id":92619677,"node_id":"MDU6TGFiZWw5MjYxOTY3Nw==","url":"https://api.github.com/repos/akka/akka-core/labels/bug","name":"bug","color":"e11d21","default":true,"description":null}],"state":"closed","locked":false,"assignee":{"login":"chbatey","id":1866779,"node_id":"MDQ6VXNlcjE4NjY3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/1866779?v=4","gravatar_id":"","url":"https://api.github.com/users/chbatey","html_url":"https://github.com/chbatey","followers_url":"https://api.github.com/users/chbatey/followers","following_url":"https://api.github.com/users/chbatey/following{/other_user}","gists_url":"https://api.github.com/users/chbatey/gists{/gist_id}","starred_url":"https://api.github.com/users/chbatey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chbatey/subscriptions","organizations_url":"https://api.github.com/users/chbatey/orgs","repos_url":"https://api.github.com/users/chbatey/repos","events_url":"https://api.github.com/users/chbatey/events{/privacy}","received_events_url":"https://api.github.com/users/chbatey/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"chbatey","id":1866779,"node_id":"MDQ6VXNlcjE4NjY3Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/1866779?v=4","gravatar_id":"","url":"https://api.github.com/users/chbatey","html_url":"https://github.com/chbatey","followers_url":"https://api.github.com/users/chbatey/followers","following_url":"https://api.github.com/users/chbatey/following{/other_user}","gists_url":"https://api.github.com/users/chbatey/gists{/gist_id}","starred_url":"https://api.github.com/users/chbatey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chbatey/subscriptions","organizations_url":"https://api.github.com/users/chbatey/orgs","repos_url":"https://api.github.com/users/chbatey/repos","events_url":"https://api.github.com/users/chbatey/events{/privacy}","received_events_url":"https://api.github.com/users/chbatey/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/akka/akka-core/milestones/142","html_url":"https://github.com/akka/akka-core/milestone/142","labels_url":"https://api.github.com/repos/akka/akka-core/milestones/142/labels","id":4334600,"node_id":"MDk6TWlsZXN0b25lNDMzNDYwMA==","number":142,"title":"2.5.24","description":"","creator":{"login":"patriknw","id":336161,"node_id":"MDQ6VXNlcjMzNjE2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/336161?v=4","gravatar_id":"","url":"https://api.github.com/users/patriknw","html_url":"https://github.com/patriknw","followers_url":"https://api.github.com/users/patriknw/followers","following_url":"https://api.github.com/users/patriknw/following{/other_user}","gists_url":"https://api.github.com/users/patriknw/gists{/gist_id}","starred_url":"https://api.github.com/users/patriknw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/patriknw/subscriptions","organizations_url":"https://api.github.com/users/patriknw/orgs","repos_url":"https://api.github.com/users/patriknw/repos","events_url":"https://api.github.com/users/patriknw/events{/privacy}","received_events_url":"https://api.github.com/users/patriknw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":19,"state":"closed","created_at":"2019-05-21T11:29:50Z","updated_at":"2019-08-09T14:47:29Z","due_on":null,"closed_at":"2019-08-09T14:47:29Z"},"comments":4,"created_at":"2019-07-18T23:27:04Z","updated_at":"2019-07-26T08:28:57Z","closed_at":"2019-07-25T14:32:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When simulating large amounts of traffic in an application built on top of akka-persistence-typed it seems to loose commands sent to persistent actors when they are storing snapshots. \r\n\r\nI have created a small repository to reproduce this bug https://github.com/IainHull/akka-persistence-message-bug\r\n\r\nUsing a logging interceptor around the persistent actor all messages entering the behavior are logged. The persistent actor also logs all commands processed by the `commandHandler` and each time the function sent to `snapshotWhen` returns true. With these we can see some messages sent to the persistent actor and logged by the interceptor while the snapshot is being written never make it to the `commandHandler`.\r\n\r\n* The mainline of this sample application is `io.github.iainhull.bug.Application`, run this it will stop once it has reproduced the bug.\r\n* I have only seen it fail on an ask not a direct send.\r\n* This sample application uses a `TestActor` to sends 100s of `RegisterValue` commands to the `PersistentActor`.\r\n* After each batch of 100 it polls the `PersistentActor` with `GetState` requests to verified that all values have been received.\r\n* It stops if any of the values sent in `RegisterValue` are missing or the `GetState` ask times out.\r\n\r\nHere is a sample from logs on my machine where an ask command `GetState` times out:\r\n\r\n```text\r\n019-07-18 22:50:03.931Z DEBUG [io.github.iainhull.bug.TestActor$] Intercepted message: Storm(0)\r\n2019-07-18 22:50:03.931Z INFO [io.github.iainhull.bug.TestActor$] Starting Storm 0\r\n2019-07-18 22:50:03.933Z INFO [io.github.iainhull.bug.TestActor$] Stopping Storm 0\r\n2019-07-18 22:50:03.933Z DEBUG [io.github.iainhull.bug.TestActor$] Intercepted message: TriggerVerify(0,0)\r\n2019-07-18 22:50:03.934Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(0)\r\n2019-07-18 22:50:03.935Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(0)\r\n2019-07-18 22:50:03.939Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(1)\r\n2019-07-18 22:50:03.939Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(2)\r\n2019-07-18 22:50:03.939Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(3)\r\n2019-07-18 22:50:03.940Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(4)\r\n2019-07-18 22:50:03.940Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(5)\r\n2019-07-18 22:50:03.940Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(6)\r\n2019-07-18 22:50:03.940Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(7)\r\n2019-07-18 22:50:03.940Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(8)\r\n2019-07-18 22:50:03.940Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(9)\r\n2019-07-18 22:50:03.941Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: RegisterValue(10)\r\n\r\n...\r\n\r\n2019-07-18 22:50:04.136Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(8)\r\n2019-07-18 22:50:04.139Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.139Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(8),9,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n2019-07-18 22:50:04.139Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(9)\r\n\r\n2019-07-18 22:50:04.139Z INFO [i.g.iainhull.bug.PersistentActor$] Lets snapshot 10 ValueRegistered(9) 10\r\n\r\n2019-07-18 22:50:04.143Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.144Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(9),10,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n[WARN] [SECURITY][07/18/2019 23:50:04.149] [app-akka.persistence.dispatchers.default-plugin-dispatcher-7] [akka.serialization.Serialization(akka://app)] Using the default Java serializer for class [io.github.iainhull.bug.PersistentActor$State] which is not recommended because of performance implications. Use another serializer or disable this warning using the setting 'akka.actor.warn-about-java-serializer-usage'\r\n2019-07-18 22:50:04.203Z DEBUG [io.github.iainhull.bug.TestActor$] Intercepted message: DoVerify(0,0)\r\n2019-07-18 22:50:04.203Z INFO [io.github.iainhull.bug.TestActor$] Starting verify 0, 0\r\n\r\n2019-07-18 22:50:04.209Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: GetState(Actor[akka://app/temp/$b#0])\r\n\r\n2019-07-18 22:50:04.241Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: SaveSnapshotSuccess(SnapshotMetadata(persistence,10,1563490204147))\r\n\r\n2019-07-18 22:50:04.245Z INFO [i.g.iainhull.bug.PersistentActor$] Received signal SnapshotCompleted(SnapshotMetadata(persistence,10,1563490204147))\r\n\r\n2019-07-18 22:50:04.245Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(10)\r\n2019-07-18 22:50:04.254Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.255Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(10),11,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n\r\n...\r\n\r\n2019-07-18 22:50:04.605Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(97)\r\n2019-07-18 22:50:04.610Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.610Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(97),98,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n2019-07-18 22:50:04.610Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(98)\r\n2019-07-18 22:50:04.614Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.614Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(98),99,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n2019-07-18 22:50:04.614Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(99)\r\n2019-07-18 22:50:04.614Z INFO [i.g.iainhull.bug.PersistentActor$] Lets snapshot 100 ValueRegistered(99) 100\r\n2019-07-18 22:50:04.619Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.620Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(99),100,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n2019-07-18 22:50:04.622Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: SaveSnapshotSuccess(SnapshotMetadata(persistence,100,1563490204620))\r\n2019-07-18 22:50:04.622Z INFO [i.g.iainhull.bug.PersistentActor$] Received signal SnapshotCompleted(SnapshotMetadata(persistence,100,1563490204620))\r\n2019-07-18 22:50:04.622Z INFO [i.g.iainhull.bug.PersistentActor$] Received command RegisterValue(100)\r\n2019-07-18 22:50:04.625Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessagesSuccessful\r\n2019-07-18 22:50:04.625Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted message: WriteMessageSuccess(PersistentImpl(ValueRegistered(100),101,persistence,,false,null,e03f4ccb-81eb-4f5f-9510-842a4817935a),1)\r\n\r\n2019-07-18 22:50:19.225Z INFO [io.github.iainhull.bug.TestActor$] Ask failure java.util.concurrent.TimeoutException: Ask timed out on [Actor[akka://app/user/persistence#-163712343]] after [15000 ms]. Message of type [io.github.iainhull.bug.PersistentActor$GetState]. A typical reason for `AskTimeoutException` is that the recipient actor didn't send a reply.\r\n\r\n2019-07-18 22:50:19.225Z DEBUG [io.github.iainhull.bug.TestActor$] Intercepted message: Stop\r\n2019-07-18 22:50:19.226Z INFO [io.github.iainhull.bug.TestActor$] Stop\r\n2019-07-18 22:50:19.228Z DEBUG [io.github.iainhull.bug.TestActor$] Intercepted signal: PostStop\r\n2019-07-18 22:50:19.231Z DEBUG [io.github.iainhull.bug.Application$] Intercepted signal: Terminated(Actor[akka://app/user/test#391377391])\r\n2019-07-18 22:50:19.235Z DEBUG [i.g.iainhull.bug.PersistentActor$] Intercepted signal: PostStop\r\n2019-07-18 22:50:19.236Z INFO [i.g.iainhull.bug.PersistentActor$] Received signal PostStop\r\n2019-07-18 22:50:19.237Z DEBUG [io.github.iainhull.bug.Application$] Intercepted signal: PostStop\r\n```\r\n\r\n* 100 `ValueRegistered` events are processed in less than one second.\r\n* At 22:50:04.139Z `PersistentActor` decides to write a snapshot `Lets snapshot 10 ValueRegistered(9) 10`\r\n* At 22:50:04.209Z `PersistentActor` logging interceptor receives the next message `Intercepted message: GetState`. This is a request\r\n  using the ask pattern.\r\n* At 22:50:04.245Z `PersistentActor` completes snapshot `Received signal SnapshotCompleted(SnapshotMetadata(persistence,10,1563490204147))`\r\n* At 22:50:19.225Z 15 seconds later the `TestActor` gets ``Ask failure java.util.concurrent.TimeoutException: Ask timed out on [Actor[akka://app/user/persistence#-163712343]] after [15000 ms]. Message of type [io.github.iainhull.bug.PersistentActor$GetState]. A typical reason for `AskTimeoutException` is that the recipient actor didn't send a reply.`\r\n* Every other `Intercepted message` log in the `PersistentActor` has a matching `Received command` log except this one\r\n\r\nThe command handler never got this message.","closed_by":{"login":"raboof","id":131856,"node_id":"MDQ6VXNlcjEzMTg1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/131856?v=4","gravatar_id":"","url":"https://api.github.com/users/raboof","html_url":"https://github.com/raboof","followers_url":"https://api.github.com/users/raboof/followers","following_url":"https://api.github.com/users/raboof/following{/other_user}","gists_url":"https://api.github.com/users/raboof/gists{/gist_id}","starred_url":"https://api.github.com/users/raboof/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raboof/subscriptions","organizations_url":"https://api.github.com/users/raboof/orgs","repos_url":"https://api.github.com/users/raboof/repos","events_url":"https://api.github.com/users/raboof/events{/privacy}","received_events_url":"https://api.github.com/users/raboof/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/akka/akka-core/issues/27381/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/akka/akka-core/issues/27381/timeline","performed_via_github_app":null,"state_reason":"completed"}