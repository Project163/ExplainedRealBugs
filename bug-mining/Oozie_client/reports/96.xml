<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:48:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OOZIE-2485] Oozie client keeps trying to use expired auth token</title>
                <link>https://issues.apache.org/jira/browse/OOZIE-2485</link>
                <project id="12311620" key="OOZIE">Oozie (Retired)</project>
                    <description>&lt;p&gt;When using Hadoop 2.4.0 or later, the Oozie client doesn&apos;t update the auth token when it expires.  The client doesn&apos;t typically give you an error because it will still fallback and authenticate via Kerberos or Pseudo.  However, this is inefficient.&lt;/p&gt;

&lt;p&gt;This appears to be due to &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt;, which made an incompatible change with how the AuthHandler tells the Authenticator when a token has expired.  It used to give a 401 when the token expired, but now it will do SPNEGO (if you have Kerberos credentials) and return a new token, all in the same call.  Oozie client&apos;s code doesn&apos;t handle that case.&lt;/p&gt;

&lt;p&gt;With Pseudo Auth, it behaves a little differently and you now get a 403 on that first call, but it doesn&apos;t give you a new token.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12948546">OOZIE-2485</key>
            <summary>Oozie client keeps trying to use expired auth token</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rkanter">Robert Kanter</assignee>
                                    <reporter username="rkanter">Robert Kanter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2016 21:23:46 +0000</created>
                <updated>Fri, 2 Dec 2016 21:02:19 +0000</updated>
                            <resolved>Fri, 8 Apr 2016 01:12:21 +0000</resolved>
                                    <version>trunk</version>
                                    <fixVersion>4.3.0</fixVersion>
                                    <component>client</component>
                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15188075" author="rkanter" created="Wed, 9 Mar 2016 21:31:26 +0000"  >&lt;p&gt;I spent a ton of time looking into this.  Unfortunately, it&apos;s very tricky because different versions of hadoop-auth do slightly different things.  I have a fix that I believe works for everything.  I&apos;m currently trying to get MiniKDC working so I can have unit tests that use Kerberos for this.  I&apos;ll try to post a patch by the end of the week; if I can&apos;t get MiniKDC working by then, I&apos;ll give up on it.&lt;/p&gt;</comment>
                            <comment id="15195707" author="rkanter" created="Tue, 15 Mar 2016 17:22:21 +0000"  >&lt;p&gt;Before I explain what the patch does, here&#8217;s what the code is currently doing (which was&#8217;t super-obvious to me at first):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Read in the cached token, if enabled&lt;/li&gt;
	&lt;li&gt;If we have a token, make a connection to the server to test if the token is still valid (i.e. hasn&#8217;t expired or been tampered with)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;If it&#8217;s not valid, then let&#8217;s delete it&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;If we don&#8217;t have a token (or it was deleted in the previous step), get a new one from the Server using Kerberos or Pseudo auth (which uses a new connection under the covers)&lt;/li&gt;
	&lt;li&gt;If we now have a new token, write it to the cache file (if enabled)&lt;/li&gt;
	&lt;li&gt;Create a new connection using the token and return it up to the caller, which may further modify it and then use it&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As you can see, we may make 2-3 connections per REST call.  This is partly due to how the code is setup where the auth client code passes the connection to other code, which doesn&#8217;t know about auth.  While that could be changed, it would require a lot of refactoring and changing how the OozieClient and AuthOozieClient are setup.&lt;/p&gt;

&lt;p&gt;The main new thing is the else statement with the big comment.  Most of the other stuff is some minor refactoring, some helpful comments, and an optimization that also prevents a rare race condition.  Here&#8217;s a summary of what I changed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We can save a call to the server by parsing and checking the expiration time of the token locally.  If it&#8217;s expired, we can just delete it.  I also have it consider -5 minutes as expired to prevent a race condition (though I haven&#8217;t seen this ever occur) where an almost expiring token would pass the server check but fail by the time the actual command is made.  Given that this should happen quickly, I haven&#8217;t seen this problem before, but 5 min seems like more than a safe buffer.&lt;/li&gt;
	&lt;li&gt;One of the changes made by &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt; is that PseudoAuthenticationHandler will now return a 403 instead of a 401 when the token is invalid.  The patch now checks for both 401 and 403 to handle either code&lt;/li&gt;
	&lt;li&gt;The other change made by &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt; is that KerberosAuthenticationHandler will now return a 200 instead of a 401 when the token is invalid, plus, it will give you a new token.  The patch now tries to extract the token, if it&#8217;s there, in this case.  I added a big comment explaining this.&lt;/li&gt;
	&lt;li&gt;I replaced
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AuthenticatedURL(authenticator).openConnection(url, currentToken);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;authenticator.authenticate(url, currentToken);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;because it&#8217;s more clear and saves creating an unused connection.  If you look at the AuthenticatedURL code, it just calls authenticate and then creates a new connection that we&#8217;re not using here.  &lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think checking the expiration time locally should only be a problem if the local clock is way off (in which case other things like Kerberos won&#8217;t work anyway).  If the clock is wrong, either it won&#8217;t delete the token in which case the check to the server will take care of it, or it will delete the token early in which case we&#8217;ll just get a new one.  So I think this should be fine, but if others don&#8217;t think we should do this, I&#8217;m fine with removing it.&lt;/p&gt;

&lt;p&gt;I wasn&apos;t able to get MiniKDC working.  Having the test working with Kerberos would be good though, but I don&apos;t think it should block getting this fix in.  Once this is in, I&apos;ll create another JIRA and upload what I have so far there.  Maybe someone else can figure it out.&lt;/p&gt;</comment>
                            <comment id="15215146" author="hadoopqa" created="Tue, 29 Mar 2016 00:25:13 +0000"  >&lt;p&gt;Testing JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/OOZIE-2485&quot; title=&quot;Oozie client keeps trying to use expired auth token&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OOZIE-2485&quot;&gt;&lt;del&gt;OOZIE-2485&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Cleaning local git workspace&lt;/p&gt;

&lt;p&gt;----------------------------&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 PATCH_APPLIES&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 CLEAN&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAW_PATCH_ANALYSIS&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any @author tags&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any tabs&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any trailing spaces&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not introduce any line longer than 132&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does adds/modifies 1 testcase(s)&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 RAT&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new RAT warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 JAVADOC&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new Javadoc warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 COMPILE&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; HEAD compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; patch compiles&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not seem to introduce new javac warnings&lt;br/&gt;
&lt;font color=&quot;green&quot;&gt;+1 BACKWARDS_COMPATIBILITY&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not change any JPA Entity/Colum/Basic/Lob/Transient annotations&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; the patch does not modify JPA files&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;-1 TESTS&lt;/font&gt;&lt;br/&gt;
.    Tests run: 1768&lt;br/&gt;
.    Tests failed: 6&lt;br/&gt;
.    Tests errors: 2&lt;/p&gt;

&lt;p&gt;.    The patch failed the following testcases:&lt;/p&gt;

&lt;p&gt;.      testActionCheckTransientDuringLauncher(org.apache.oozie.command.wf.TestActionCheckXCommand)&lt;br/&gt;
.      testMain(org.apache.oozie.action.hadoop.TestHiveMain)&lt;br/&gt;
.      testPigScript(org.apache.oozie.action.hadoop.TestPigMain)&lt;br/&gt;
.      testPig_withNullExternalID(org.apache.oozie.action.hadoop.TestPigMain)&lt;br/&gt;
.      testEmbeddedPigWithinPython(org.apache.oozie.action.hadoop.TestPigMain)&lt;br/&gt;
.      testPigScript(org.apache.oozie.action.hadoop.TestPigMainWithOldAPI)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 DISTRO&lt;/font&gt;&lt;br/&gt;
.    &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; distro tarball builds with the patch &lt;/p&gt;

&lt;p&gt;----------------------------&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;&lt;b&gt;-1 Overall result, please check the reported -1(s)&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;The full output of the test-patch run is available at&lt;/p&gt;

&lt;p&gt;.   &lt;a href=&quot;https://builds.apache.org/job/oozie-trunk-precommit-build/2793/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/oozie-trunk-precommit-build/2793/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15229336" author="rkanter" created="Wed, 6 Apr 2016 23:30:14 +0000"  >&lt;p&gt;Test failures unrelated&lt;/p&gt;</comment>
                            <comment id="15231204" author="rohini" created="Thu, 7 Apr 2016 22:10:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15231459" author="rkanter" created="Fri, 8 Apr 2016 01:12:21 +0000"  >&lt;p&gt;Thanks for the review Rohini.  Committed to master!&lt;/p&gt;</comment>
                            <comment id="15716307" author="rkanter" created="Fri, 2 Dec 2016 21:02:19 +0000"  >&lt;p&gt;Closing issue; Oozie 4.3.0 is released.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12691838">HADOOP-10301</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12793595" name="OOZIE-2485.001.patch" size="11435" author="rkanter" created="Tue, 15 Mar 2016 17:22:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ufcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>