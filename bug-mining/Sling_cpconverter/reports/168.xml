<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:37:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-12469] Index definitions are not extracted when individual definitions are defined in the filter.xml as roots</title>
                <link>https://issues.apache.org/jira/browse/SLING-12469</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;Assuming that we have a content package with index definitions stored as single files&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;.
&#9500;&#9472;&#9472; jcr_root
&#9474;&#160;&#160; &#9492;&#9472;&#9472; _oak_index
&#9474;&#160;&#160;     &#9500;&#9472;&#9472; .content.xml
&#9474;&#160;&#160;     &#9492;&#9472;&#9472; foo.xml
&#9492;&#9472;&#9472; META-INF
    &#9492;&#9472;&#9472; vault
        &#9492;&#9472;&#9472; filter.xml
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;WIth the filter listing the individual index definitions&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&amp;gt;
&amp;lt;workspaceFilter version=&quot;1.0&quot;&amp;gt;
    &amp;lt;filter root=&quot;/oak:index/foo&quot; /&amp;gt;
&amp;lt;/workspaceFilter&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then the index definitions will not be extracted properly. The root cause is that the repository path for the filter is inferred as &lt;tt&gt;/oak:index/foo.xml&lt;/tt&gt;  - file extension included. This will cause it to not match the filters.&lt;/p&gt;

&lt;p&gt;Looks like we need to better set the repository paths by following the aggregation logic better. IIUC, according to &lt;a href=&quot;https://jackrabbit.apache.org/filevault/config.html#aggregates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jackrabbit.apache.org/filevault/config.html#aggregates&lt;/a&gt; , foo.xml is handled by a FullCoverageAggregator and should have the extension removed.&lt;/p&gt;

&lt;p&gt;Care must be taken to not apply the same logic to the entries handled by FileAggregator, whose extension must be kept. This is the case for Tika configurations, for instance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13597649">SLING-12469</key>
            <summary>Index definitions are not extracted when individual definitions are defined in the filter.xml as roots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rombert">Robert Munteanu</assignee>
                                    <reporter username="rombert">Robert Munteanu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Nov 2024 16:50:07 +0000</created>
                <updated>Tue, 19 Nov 2024 15:03:23 +0000</updated>
                            <resolved>Wed, 6 Nov 2024 10:05:34 +0000</resolved>
                                                    <fixVersion>Content-Package to Feature Model Converter 1.3.8</fixVersion>
                                    <component>Content-Package to Feature Model Converter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17895431" author="kwin" created="Mon, 4 Nov 2024 21:18:02 +0000"  >&lt;p&gt;There are some helper methods in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/master/vault-core/src/main/java/org/apache/jackrabbit/vault/util/PlatformNameFormat.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/master/vault-core/src/main/java/org/apache/jackrabbit/vault/util/PlatformNameFormat.java&lt;/a&gt; to transform from one format to the other. However it doesn&apos;t consider differences of the used aggregator.&lt;/p&gt;</comment>
                            <comment id="17895548" author="rombert" created="Tue, 5 Nov 2024 09:24:43 +0000"  >&lt;p&gt;Right, thanks for the hint &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt;. I tried to figure out whether I can identify the aggregator programatically but the API requires a `javax.jcr.Node` and that&apos;s not going to be easy to provide&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/72adfdd907a1056381aa29695f57505293b39f46/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/api/Aggregator.java#L80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/72adfdd907a1056381aa29695f57505293b39f46/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/api/Aggregator.java#L80&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/72adfdd907a1056381aa29695f57505293b39f46/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/api/Aggregator.java#L53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/72adfdd907a1056381aa29695f57505293b39f46/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/api/Aggregator.java#L53&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I still need to understand this better, I suspect that this happens because the index definitions are filter roots, not because of aggregator configurations. &lt;/p&gt;</comment>
                            <comment id="17895551" author="kwin" created="Tue, 5 Nov 2024 09:28:10 +0000"  >&lt;p&gt;The filter xml always uses JCR node paths, not FS serialization paths. Not only for the root attribute but also for includes/excludes (compare with &lt;a href=&quot;https://jackrabbit.apache.org/filevault/filter.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jackrabbit.apache.org/filevault/filter.html&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17895576" author="rombert" created="Tue, 5 Nov 2024 12:04:49 +0000"  >&lt;p&gt;Right, we already make the distinction between FS and repository paths, see &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-feature-cpconverter/blob/a0914fb9050a9c3aecd5e69f0adb648b91796ce8/src/main/java/org/apache/sling/feature/cpconverter/handlers/IndexDefinitionsEntryHandler.java#L110-L113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling-org-apache-sling-feature-cpconverter/blob/a0914fb9050a9c3aecd5e69f0adb648b91796ce8/src/main/java/org/apache/sling/feature/cpconverter/handlers/IndexDefinitionsEntryHandler.java#L110-L113&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;What still puzzles me is the format of the index definitions - I stumbled upon this &quot;in the wild&quot; but I don&apos;t think this is generated by FileVault, but rather crafted by the user. My test was the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;start the Sling Starter&lt;/li&gt;
	&lt;li&gt;create a filter.xml that includes two index definitionss&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;workspaceFilter vesion=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter root=&lt;span class=&quot;code-quote&quot;&gt;&quot;/oak:index/jcrLanguage&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter root=&lt;span class=&quot;code-quote&quot;&gt;&quot;/oak:index/counter&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/workspaceFilter&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and ran &lt;tt&gt;vlt --credentials admin:admin co &lt;a href=&quot;http://localhost:8080/server/default/jcr:root/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/server/default/jcr:root/&lt;/a&gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I ended up with a generic aggregate for oak:index ( &lt;a href=&quot;https://jackrabbit.apache.org/filevault/vaultfs.html#generic-aggregates&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jackrabbit.apache.org/filevault/vaultfs.html#generic-aggregates&lt;/a&gt; )&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ tree -a jcr_root/
jcr_root/
&#9500;&#9472;&#9472; .content.xml
&#9500;&#9472;&#9472; _oak_index
&#9474;&#160;&#160; &#9500;&#9472;&#9472; .content.xml
&#9474;&#160;&#160; &#9492;&#9472;&#9472; .vlt
&#9492;&#9472;&#9472; .vlt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and not with individual full aggregates for each index definition. My current thinking is the files were hand-crafted and accepted by FileVault for import, but not representative of the canonical format used when exported.&lt;/p&gt;</comment>
                            <comment id="17895599" author="rombert" created="Tue, 5 Nov 2024 13:14:17 +0000"  >&lt;p&gt;Added a package to demonstrate that this actually works - &lt;a href=&quot;https://github.com/rombert/SLING12469&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rombert/SLING12469&lt;/a&gt; . The index definition from &lt;a href=&quot;https://github.com/rombert/SLING12469/blob/master/src/main/content/jcr_root/_oak_index/jcrCreated.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rombert/SLING12469/blob/master/src/main/content/jcr_root/_oak_index/jcrCreated.xml&lt;/a&gt; creates an index definition when the package is installed.&lt;/p&gt;

&lt;p&gt;I think digging down in the Package Manager/FileVault code to figure out why this works in order to reuse the code is not tenable. I&apos;d rather make a minimal adaption to the code and add a regression test to ensure this works and does not break anything.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1sd74:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>