[{"id":667522364,"node_id":"MDExOkNsb3NlZEV2ZW50NjY3NTIyMzY0","url":"https://api.github.com/repos/Seldaek/monolog/issues/events/667522364","actor":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"5ecfbc25deed6bb7eaa408c46453356d799edd4b","commit_url":"https://api.github.com/repos/Seldaek/monolog/commits/5ecfbc25deed6bb7eaa408c46453356d799edd4b","created_at":"2016-05-20T18:43:15Z","state_reason":null,"performed_via_github_app":null},{"actor":{"login":"andrei-e-random","id":24353101,"node_id":"MDQ6VXNlcjI0MzUzMTAx","avatar_url":"https://avatars.githubusercontent.com/u/24353101?v=4","gravatar_id":"","url":"https://api.github.com/users/andrei-e-random","html_url":"https://github.com/andrei-e-random","followers_url":"https://api.github.com/users/andrei-e-random/followers","following_url":"https://api.github.com/users/andrei-e-random/following{/other_user}","gists_url":"https://api.github.com/users/andrei-e-random/gists{/gist_id}","starred_url":"https://api.github.com/users/andrei-e-random/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrei-e-random/subscriptions","organizations_url":"https://api.github.com/users/andrei-e-random/orgs","repos_url":"https://api.github.com/users/andrei-e-random/repos","events_url":"https://api.github.com/users/andrei-e-random/events{/privacy}","received_events_url":"https://api.github.com/users/andrei-e-random/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-10T14:42:24Z","updated_at":"2019-07-10T14:42:24Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/1346","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/1346/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/1346/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/1346/events","html_url":"https://github.com/Seldaek/monolog/issues/1346","id":466350753,"node_id":"MDU6SXNzdWU0NjYzNTA3NTM=","number":1346,"title":"JsonFormatter with stacktaces may cause fatal errors and reveal sensitive data","user":{"login":"andrei-e-random","id":24353101,"node_id":"MDQ6VXNlcjI0MzUzMTAx","avatar_url":"https://avatars.githubusercontent.com/u/24353101?v=4","gravatar_id":"","url":"https://api.github.com/users/andrei-e-random","html_url":"https://github.com/andrei-e-random","followers_url":"https://api.github.com/users/andrei-e-random/followers","following_url":"https://api.github.com/users/andrei-e-random/following{/other_user}","gists_url":"https://api.github.com/users/andrei-e-random/gists{/gist_id}","starred_url":"https://api.github.com/users/andrei-e-random/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrei-e-random/subscriptions","organizations_url":"https://api.github.com/users/andrei-e-random/orgs","repos_url":"https://api.github.com/users/andrei-e-random/repos","events_url":"https://api.github.com/users/andrei-e-random/events{/privacy}","received_events_url":"https://api.github.com/users/andrei-e-random/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":87833823,"node_id":"MDU6TGFiZWw4NzgzMzgyMw==","url":"https://api.github.com/repos/Seldaek/monolog/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/Seldaek/monolog/milestones/5","html_url":"https://github.com/Seldaek/monolog/milestone/5","labels_url":"https://api.github.com/repos/Seldaek/monolog/milestones/5/labels","id":1854876,"node_id":"MDk6TWlsZXN0b25lMTg1NDg3Ng==","number":5,"title":"1.x","description":"","creator":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":2,"closed_issues":64,"state":"open","created_at":"2016-06-29T11:29:05Z","updated_at":"2022-07-22T11:21:04Z","due_on":null,"closed_at":null},"comments":3,"created_at":"2019-07-10T14:42:24Z","updated_at":"2019-08-30T08:32:27Z","closed_at":"2019-08-30T08:32:27Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":1376664,"node_id":"MDEwOlJlcG9zaXRvcnkxMzc2NjY0","name":"monolog","full_name":"Seldaek/monolog","private":false,"owner":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"html_url":"https://github.com/Seldaek/monolog","description":"Sends your logs to files, sockets, inboxes, databases and various web services","fork":false,"url":"https://api.github.com/repos/Seldaek/monolog","forks_url":"https://api.github.com/repos/Seldaek/monolog/forks","keys_url":"https://api.github.com/repos/Seldaek/monolog/keys{/key_id}","collaborators_url":"https://api.github.com/repos/Seldaek/monolog/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/Seldaek/monolog/teams","hooks_url":"https://api.github.com/repos/Seldaek/monolog/hooks","issue_events_url":"https://api.github.com/repos/Seldaek/monolog/issues/events{/number}","events_url":"https://api.github.com/repos/Seldaek/monolog/events","assignees_url":"https://api.github.com/repos/Seldaek/monolog/assignees{/user}","branches_url":"https://api.github.com/repos/Seldaek/monolog/branches{/branch}","tags_url":"https://api.github.com/repos/Seldaek/monolog/tags","blobs_url":"https://api.github.com/repos/Seldaek/monolog/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/Seldaek/monolog/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/Seldaek/monolog/git/refs{/sha}","trees_url":"https://api.github.com/repos/Seldaek/monolog/git/trees{/sha}","statuses_url":"https://api.github.com/repos/Seldaek/monolog/statuses/{sha}","languages_url":"https://api.github.com/repos/Seldaek/monolog/languages","stargazers_url":"https://api.github.com/repos/Seldaek/monolog/stargazers","contributors_url":"https://api.github.com/repos/Seldaek/monolog/contributors","subscribers_url":"https://api.github.com/repos/Seldaek/monolog/subscribers","subscription_url":"https://api.github.com/repos/Seldaek/monolog/subscription","commits_url":"https://api.github.com/repos/Seldaek/monolog/commits{/sha}","git_commits_url":"https://api.github.com/repos/Seldaek/monolog/git/commits{/sha}","comments_url":"https://api.github.com/repos/Seldaek/monolog/comments{/number}","issue_comment_url":"https://api.github.com/repos/Seldaek/monolog/issues/comments{/number}","contents_url":"https://api.github.com/repos/Seldaek/monolog/contents/{+path}","compare_url":"https://api.github.com/repos/Seldaek/monolog/compare/{base}...{head}","merges_url":"https://api.github.com/repos/Seldaek/monolog/merges","archive_url":"https://api.github.com/repos/Seldaek/monolog/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/Seldaek/monolog/downloads","issues_url":"https://api.github.com/repos/Seldaek/monolog/issues{/number}","pulls_url":"https://api.github.com/repos/Seldaek/monolog/pulls{/number}","milestones_url":"https://api.github.com/repos/Seldaek/monolog/milestones{/number}","notifications_url":"https://api.github.com/repos/Seldaek/monolog/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/Seldaek/monolog/labels{/name}","releases_url":"https://api.github.com/repos/Seldaek/monolog/releases{/id}","deployments_url":"https://api.github.com/repos/Seldaek/monolog/deployments","created_at":"2011-02-17T02:07:15Z","updated_at":"2025-11-09T16:20:07Z","pushed_at":"2025-10-27T13:40:53Z","git_url":"git://github.com/Seldaek/monolog.git","ssh_url":"git@github.com:Seldaek/monolog.git","clone_url":"https://github.com/Seldaek/monolog.git","svn_url":"https://github.com/Seldaek/monolog","homepage":"https://seldaek.github.io/monolog/","size":4917,"stargazers_count":21350,"watchers_count":21350,"language":"PHP","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":false,"forks_count":1904,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":33,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["hacktoberfest","logger","logging","php","psr-3"],"visibility":"public","forks":1904,"open_issues":33,"watchers":21350,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"I'd propose a PR, but I'm not very familiar with the code. Plus some of the stuff in the second part is rather debatable and it is probably better to discuss it first. \r\n\r\nPHP:  7.2.15\r\nMonolog: 1.24.0 ( I realize this is a slightly older version but the code in master which is causing the issue looks the same). \r\n\r\nTo verify the crash, one can use almost exactly the code from #772, but:\r\n\r\n1. Put the closure into method of a class which has a namespace. \r\n2. Use JsonFormatter instead of NormalizerFormatter  because the latter has been actually fixed (see at the end) by 3e92b08956da82867774ca8a8edef2472ab743f9 (which  fixes #1138)\r\n\r\n```php\r\n<?php\r\n\r\nnamespace MyIterators;\r\n\r\nuse ArrayIterator;\r\n\r\nclass SomeIter extends ArrayIterator\r\n{\r\n    public function next()\r\n    {\r\n        // Imagine some logic attempted to evaluate\r\n        // current element but failed and throws exception\r\n        throw new \\Exception('Something bad');\r\n    }\r\n}\r\n\r\nnamespace MyNamespace;\r\n\r\nuse Monolog\\Formatter\\JsonFormatter;\r\nuse Monolog\\Handler\\ErrorLogHandler;\r\nuse Monolog\\Logger;\r\nuse MyIterators\\SomeIter;\r\n\r\nclass MyClass {\r\n\r\n    public function process() {\r\n        $handler = new ErrorLogHandler();\r\n        $formatter = new JsonFormatter();\r\n        $formatter->includeStacktraces();\r\n        $handler->setFormatter($formatter);\r\n\r\n        $logger = new Logger('name');\r\n        $logger->pushHandler($handler);\r\n\r\n        $array = [\r\n            new SomeIter([1]),\r\n            new SomeIter([2]),\r\n        ];\r\n\r\n        $result = \\array_filter($array, function ($iter) use ($logger) {\r\n            try {\r\n                foreach ($iter as $elem) {\r\n                    // don't care\r\n                }\r\n            } catch (\\Exception $e) {\r\n                $logger->error('Failed iterating.', ['exception' => $e]);\r\n            }\r\n        });\r\n\r\n    }\r\n}\r\n\r\n$myObject = new MyClass();\r\n$myObject->process();\r\n\r\n```\r\n\r\nThe above code will cause a fatal uncaught exception, instead of just logging an error.\r\n\r\nThe problem lies in the `JsonFormatter` class:\r\n\r\n```php\r\n          foreach ($trace as $frame) {\r\n                if (isset($frame['file'])) {\r\n                    $data['trace'][] = $frame['file'].':'.$frame['line'];\r\n                } elseif (isset($frame['function']) && $frame['function'] === '{closure}') {\r\n                    // We should again normalize the frames, because it might contain invalid items\r\n                    $data['trace'][] = $frame['function'];\r\n                } else {\r\n                    // We should again normalize the frames, because it might contain invalid items\r\n                    $data['trace'][] = $this->normalize($frame);\r\n                }\r\n            }\r\n```\r\n\r\nHere `$frame['function']` is not `{closure}` but `MyNamespace\\{closure}`. This causes the final else path to be evaluated.\r\n\r\n_Suggested Fix_\r\n\r\nI think the initial approach checking for closure and just putting in `$frame['function']` when a closure is detected is fine, except for the fact that ` $frame['function'] === '{closure}'` is not the complete way to do it. (maybe using some sort of `endsWith` function could do it). \r\n\r\n\r\n**Revealing sensitive data**\r\n\r\nHowever, once the closure detection is fine we're still left with the fact the stacktrace may contain functions which will also contain args. That is somewhat mitigated for NormalizerFormatter  in 3e92b08956da82867774ca8a8edef2472ab743f9 - but there are some problems I see with that commit, the most important beeing that it does not touch the JsonFormatter - so the problem still exists for this one (not sure if there are other formatters which should be touched.\r\n\r\nAnother potential problem is that it still leaks the class name or the arguments. I'm not sure how can that be relevant at any point, but the class name themselves could be seen as data in certain (exotic?) circumstances.\r\n\r\nAnother potential problem is that the `$frame['file'].':'.$frame['line']` structure of the stacktrace is being not being respected for functions. This means that whoever is parsing the stacktraces from log files (I know, not many people do), will have to account for different possible formats for elements on the same array, which is, in my opinion, not ideal. \r\n\r\n_Suggested Fix_\r\n\r\nI believe functions should be handled exactly the same way as closures when it comes to stacktraces: no information about args should be logged. \r\n\r\nIf one decides to display some information about args for functions, then it should probably display the same information for closures as well. Ideally though whether those args are displayed should be controlled by a flag.\r\n\r\nEither way, the 2 formatters should have the same behavior.\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/1346/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/1346/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":12274128663,"node_id":"REFE_lADOABUBmM4I3jA2zwAAAALbmFcX","url":"https://api.github.com/repos/Seldaek/monolog/issues/events/12274128663","actor":{"login":"xabbuh","id":1957048,"node_id":"MDQ6VXNlcjE5NTcwNDg=","avatar_url":"https://avatars.githubusercontent.com/u/1957048?v=4","gravatar_id":"","url":"https://api.github.com/users/xabbuh","html_url":"https://github.com/xabbuh","followers_url":"https://api.github.com/users/xabbuh/followers","following_url":"https://api.github.com/users/xabbuh/following{/other_user}","gists_url":"https://api.github.com/users/xabbuh/gists{/gist_id}","starred_url":"https://api.github.com/users/xabbuh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xabbuh/subscriptions","organizations_url":"https://api.github.com/users/xabbuh/orgs","repos_url":"https://api.github.com/users/xabbuh/repos","events_url":"https://api.github.com/users/xabbuh/events{/privacy}","received_events_url":"https://api.github.com/users/xabbuh/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5ecfbc25deed6bb7eaa408c46453356d799edd4b","commit_url":"https://api.github.com/repos/xabbuh/monolog/commits/5ecfbc25deed6bb7eaa408c46453356d799edd4b","created_at":"2024-03-27T23:12:37Z","performed_via_github_app":null}]