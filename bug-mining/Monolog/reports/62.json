{"url":"https://api.github.com/repos/Seldaek/monolog/issues/772","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/772/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/772/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/772/events","html_url":"https://github.com/Seldaek/monolog/issues/772","id":148779062,"node_id":"MDU6SXNzdWUxNDg3NzkwNjI=","number":772,"title":"Anonymous functions in stack trace can cause fatal errors","user":{"login":"dstevenson","id":513554,"node_id":"MDQ6VXNlcjUxMzU1NA==","avatar_url":"https://avatars.githubusercontent.com/u/513554?v=4","gravatar_id":"","url":"https://api.github.com/users/dstevenson","html_url":"https://github.com/dstevenson","followers_url":"https://api.github.com/users/dstevenson/followers","following_url":"https://api.github.com/users/dstevenson/following{/other_user}","gists_url":"https://api.github.com/users/dstevenson/gists{/gist_id}","starred_url":"https://api.github.com/users/dstevenson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dstevenson/subscriptions","organizations_url":"https://api.github.com/users/dstevenson/orgs","repos_url":"https://api.github.com/users/dstevenson/repos","events_url":"https://api.github.com/users/dstevenson/events{/privacy}","received_events_url":"https://api.github.com/users/dstevenson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-04-15T21:56:11Z","updated_at":"2016-05-20T18:43:15Z","closed_at":"2016-05-20T18:43:15Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a little complicated, so I'll do my best to lay out the exact issue here. I've boiled down the problem to a simple situation just for purposes of illustrating how to do this. The code itself doesn't make sense, but I promise you I also have real code doing useful things that can trigger the same case here.\n\n```\n<?php\n\nuse Monolog\\Logger;\nuse Monolog\\Formatter\\NormalizerFormatter;\nuse Monolog\\Handler\\ErrorLogHandler;\n\n$handler = new ErrorLogHandler();\n$handler->setFormatter(new NormalizerFormatter());\n\n$logger = new Logger(\"name\");\n$logger->pushHandler($handler);\n\nclass SomeIter extends ArrayIterator {\n    public\n    function next() {\n        // Imagine some logic attempted to evaluate\n        // current element but failed and throws exception\n        throw new Exception(\"Something bad\");\n    }\n}\n\n$array = [\n    new SomeIter([1]),\n    new SomeIter([2])\n];\n\n$result = array_filter($array, function($iter) use ($logger) {\n    try {\n        foreach ($iter as $elem) {\n            // don't care\n        }\n    } catch (Exception $e) {\n        $logger->error(\"Failed iterating.\", [\"exception\" => $e]);\n    }\n});\n```\n\nThe above code will cause a fatal uncaught exception, instead of just logging an error.\n\nThe problem lies in the `NormalizerFormatter` class, when it tries to normalize the exception in the context:\n\n```\n    protected function normalizeException(Exception $e)\n    {\n        $data = array(\n            'class' => get_class($e),\n            'message' => $e->getMessage(),\n            'code' => $e->getCode(),\n            'file' => $e->getFile().':'.$e->getLine(),\n        );\n\n        $trace = $e->getTrace();\n        foreach ($trace as $frame) {\n            if (isset($frame['file'])) {\n                $data['trace'][] = $frame['file'].':'.$frame['line'];\n            } else {\n                // We should again normalize the frames, because it might contain invalid items\n                $data['trace'][] = $this->toJson($this->normalize($frame), true);\n            }\n        }\n\n        if ($previous = $e->getPrevious()) {\n            $data['previous'] = $this->normalizeException($previous);\n        }\n\n        return $data;\n    }\n```\n\nThe closure in the original code is unbound so the `isset($frame['file'])` will return `false` and we move into attempting to normalize the entire frame. The frame ends up looking something like:\n\n```\nArray\n(\n    [function] => {closure}\n    [args] => Array\n        (\n            [0] => SomeIter Object\n                (\n                    [storage:ArrayIterator:private] => Array\n                        (\n                            [0] => 1\n                        )\n\n                )\n\n        )\n\n)\n```\n\nEventually we'll being normalizing on the original iterator, because `SomeIter instanceof \\Traversable`. Foreach-ing on this will again trigger the original exception, but now, uncaught, and a fatal.\n\nPHP 5.6.19\nMonolog 1.12.0\n\nI realize this is an older version of monolog, but I just took a peak into the class in `master` and I don't see a different code path in this case.\n","closed_by":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/772/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/772/timeline","performed_via_github_app":null,"state_reason":"completed"}