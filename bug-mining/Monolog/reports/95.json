{"url":"https://api.github.com/repos/Seldaek/monolog/issues/1028","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/1028/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/1028/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/1028/events","html_url":"https://github.com/Seldaek/monolog/issues/1028","id":244221186,"node_id":"MDU6SXNzdWUyNDQyMjExODY=","number":1028,"title":"LogglyFormatter doesn't normalize empty context/extra array to object, causes MappingConflict","user":{"login":"dominics","id":97427,"node_id":"MDQ6VXNlcjk3NDI3","avatar_url":"https://avatars.githubusercontent.com/u/97427?v=4","gravatar_id":"","url":"https://api.github.com/users/dominics","html_url":"https://github.com/dominics","followers_url":"https://api.github.com/users/dominics/followers","following_url":"https://api.github.com/users/dominics/following{/other_user}","gists_url":"https://api.github.com/users/dominics/gists{/gist_id}","starred_url":"https://api.github.com/users/dominics/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dominics/subscriptions","organizations_url":"https://api.github.com/users/dominics/orgs","repos_url":"https://api.github.com/users/dominics/repos","events_url":"https://api.github.com/users/dominics/events{/privacy}","received_events_url":"https://api.github.com/users/dominics/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":87833823,"node_id":"MDU6TGFiZWw4NzgzMzgyMw==","url":"https://api.github.com/repos/Seldaek/monolog/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/Seldaek/monolog/milestones/1","html_url":"https://github.com/Seldaek/monolog/milestone/1","labels_url":"https://api.github.com/repos/Seldaek/monolog/milestones/1/labels","id":338543,"node_id":"MDk6TWlsZXN0b25lMzM4NTQz","number":1,"title":"2.0","description":"BC breaks for 2.0","creator":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":78,"state":"closed","created_at":"2013-05-21T17:53:00Z","updated_at":"2019-09-05T11:31:55Z","due_on":null,"closed_at":"2019-09-05T11:31:55Z"},"comments":1,"created_at":"2017-07-20T01:38:52Z","updated_at":"2018-06-09T15:23:56Z","closed_at":"2018-06-09T15:23:56Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Loggly parses JSON messages thrown at it, and the `\\Monolog\\Formatter\\LogglyFormatter` does a pretty good job of formatting messages that it can cope with. However, if a field value is sent as an object, Loggly expects that value to always be sent as an object. If you later send it as an array or scalar, you get a \"MappingConflict\":\r\n\r\n> Field originally sent as an object and later as a concrete value or an array. Removed all json fields.\r\n\r\nThe \"removed all JSON fields\" part means even the message field is dropped - quite annoying behaviour, but understandable (I think) if you imagine what they're probably indexing with (Elastic I'm guessing).\r\n\r\nI think I've tracked down the MappingConflict in question to be occurring on both the `context` and `extra` fields sent from Monolog. For example, if you're using a Handler set up to use the LogglyFormatter, and you send these two log messages:\r\n\r\n```\r\n$logger->notice('Some message', ['foo' => 'bar']);\r\n$logger->notice('Some message');\r\n```\r\n\r\nThe first will send the context as an object, and the second will send the context as an empty _array_, causing the MappingConflict:\r\n\r\n```\r\n{\"message\":\"Some message\",\"context\":{\"foo\":\"bar\"},\"level\":250,\"level_name\":\"NOTICE\",\"channel\":\"foo\",\"datetime\":{\"date\":\"2017-07-20 01:24:36.190486\",\"timezone_type\":3,\"timezone\":\"UTC\"},\"extra\":[],\"timestamp\":\"2017-07-20T01:24:36.190486+0000\"}\r\n{\"message\":\"Some message\",\"context\":[],\"level\":250,\"level_name\":\"NOTICE\",\"channel\":\"foo\",\"datetime\":{\"date\":\"2017-07-20 01:24:36.190257\",\"timezone_type\":3,\"timezone\":\"UTC\"},\"extra\":[],\"timestamp\":\"2017-07-20T01:24:36.190257+0000\"}\r\n```\r\n\r\nIn order to avoid all JSON fields being stripped once Loggly tries to index the messages, the LogglyFormatter should ensure that the context and extra fields are always sent as an object, even when empty (i.e. `{}` instead of `[]`)","closed_by":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/1028/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/1028/timeline","performed_via_github_app":null,"state_reason":"completed"}