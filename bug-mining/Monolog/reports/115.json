{"url":"https://api.github.com/repos/Seldaek/monolog/issues/1203","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/1203/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/1203/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/1203/events","html_url":"https://github.com/Seldaek/monolog/issues/1203","id":369095622,"node_id":"MDU6SXNzdWUzNjkwOTU2MjI=","number":1203,"title":"NormalizerFormatter treatment of broken encodings","user":{"login":"UlrichEckhardt","id":8566055,"node_id":"MDQ6VXNlcjg1NjYwNTU=","avatar_url":"https://avatars.githubusercontent.com/u/8566055?v=4","gravatar_id":"","url":"https://api.github.com/users/UlrichEckhardt","html_url":"https://github.com/UlrichEckhardt","followers_url":"https://api.github.com/users/UlrichEckhardt/followers","following_url":"https://api.github.com/users/UlrichEckhardt/following{/other_user}","gists_url":"https://api.github.com/users/UlrichEckhardt/gists{/gist_id}","starred_url":"https://api.github.com/users/UlrichEckhardt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UlrichEckhardt/subscriptions","organizations_url":"https://api.github.com/users/UlrichEckhardt/orgs","repos_url":"https://api.github.com/users/UlrichEckhardt/repos","events_url":"https://api.github.com/users/UlrichEckhardt/events{/privacy}","received_events_url":"https://api.github.com/users/UlrichEckhardt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":87833823,"node_id":"MDU6TGFiZWw4NzgzMzgyMw==","url":"https://api.github.com/repos/Seldaek/monolog/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/Seldaek/monolog/milestones/6","html_url":"https://github.com/Seldaek/monolog/milestone/6","labels_url":"https://api.github.com/repos/Seldaek/monolog/milestones/6/labels","id":3833113,"node_id":"MDk6TWlsZXN0b25lMzgzMzExMw==","number":6,"title":"2.x","description":"","creator":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":5,"closed_issues":126,"state":"open","created_at":"2018-11-19T22:36:56Z","updated_at":"2025-03-20T09:28:01Z","due_on":null,"closed_at":null},"comments":3,"created_at":"2018-10-11T12:23:30Z","updated_at":"2020-05-11T19:54:10Z","closed_at":"2020-05-11T19:31:21Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Just as a the background for this: We had issues writing to a database which caused an exception with \"Incorrect string value: '\\xFCnde' for column...\" as message, i.e. a string with a byte value 0xFC in a UTF-8 environment. This message was successfully logged to file, but it didn't end up in our JSON logs that are aggregated centrally, so we almost missed that error.\r\n\r\nNow, what did I find out:\r\n\r\n- The data loss occurs in JsonFormatter. It simply invokes `json_encode()` on the record containing that string, which fails. To me, that's perfectly correct, because JSON is required to use UTF-8.\r\n- In JsonFormatter is also a small bug: The documentation for `toJson()` is pretty explicit that it returns a string, which it doesn't in this case. That non-string gets appended a newline, which then causes an empty line in the logfiles which we also observed. Basically, the error handling here doesn't handle this case fully.\r\n - A possible fix needs to be applied before that though, in order to make the record JSON-encodable. I would have expected this to happen in `normalize()`, but here the code becomes really non-obvious to me. Firstly, it doesn't use `normalize()` from the NormalizerFormatter baseclass. Then, the differences between the two implementations are not clear either, e.g. that the baseclass specially handles SoapFaults (related to https://github.com/Seldaek/monolog/issues/1183?). That may be a completely separate issue though.\r\n - As a suggestion, I would check whether a string passed to normalize is encoded as UTF-8. If it isn't, just escape the invalid bytes within using the \"\\xFC\" syntax.\r\n\r\n\r\nWorkaround:\r\n```\r\nuse Monolog\\Formatter\\JsonFormatter as MonologJsonFormatter;\r\n\r\n/**\r\n * Workaround for a bug in the JSON encoder when it encounters invalid encodings.\r\n * \r\n * The problem is that JSON requires UTF-8, so when it encounters non-UTF-8,\r\n * it just returns false which results in an empty line in our JSON log. This\r\n * workaround replaces the faulty bytes with a question mark, which is still\r\n * better than nothing.\r\n */\r\nclass JsonFormatter extends MonologJsonFormatter\r\n{\r\n    /**\r\n     * Normalizes given $data.\r\n     *\r\n     * @param mixed $data\r\n     *\r\n     * @return mixed\r\n     */\r\n    protected function normalize($data)\r\n    {\r\n        $res = parent::normalize($data);\r\n        if (is_string($res)) {\r\n            $res = mb_convert_encoding($res, null, 'UTF-8');\r\n        }\r\n        return $res;\r\n    }\r\n}\r\n```","closed_by":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/1203/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/1203/timeline","performed_via_github_app":null,"state_reason":"completed"}