{"url":"https://api.github.com/repos/Seldaek/monolog/issues/751","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/751/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/751/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/751/events","html_url":"https://github.com/Seldaek/monolog/issues/751","id":142996276,"node_id":"MDU6SXNzdWUxNDI5OTYyNzY=","number":751,"title":"GelfMessageFormatter doesnt truncate large data ","user":{"login":"rubao","id":741117,"node_id":"MDQ6VXNlcjc0MTExNw==","avatar_url":"https://avatars.githubusercontent.com/u/741117?v=4","gravatar_id":"","url":"https://api.github.com/users/rubao","html_url":"https://github.com/rubao","followers_url":"https://api.github.com/users/rubao/followers","following_url":"https://api.github.com/users/rubao/following{/other_user}","gists_url":"https://api.github.com/users/rubao/gists{/gist_id}","starred_url":"https://api.github.com/users/rubao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rubao/subscriptions","organizations_url":"https://api.github.com/users/rubao/orgs","repos_url":"https://api.github.com/users/rubao/repos","events_url":"https://api.github.com/users/rubao/events{/privacy}","received_events_url":"https://api.github.com/users/rubao/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-03-23T15:41:59Z","updated_at":"2017-04-07T09:51:47Z","closed_at":"2016-04-02T13:13:24Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"monolog/monolog/src/Monolog/Formatter/GelfMessageFormatter.php only convert toJson() when is not a scalar value.\n\nbut in case of big exceptions with many previous exception, we have a problem in graylog, because it's uses elasticsearch to store the data and elasticsearch accept max 32766 bytes.\nsee https://issues.apache.org/jira/browse/LUCENE-5472\n\nin graylog we got some indexer failures:\n`\nIllegalArgumentException[Document contains at least one immense term in field=\"ctxt_exception\" (whose UTF8 encoding is longer than the max length 32766), all of which were skipped. Please correct the analyzer to not produce such terms. The prefix of the first immense term is: '[123, 34, 99, 108, 97, 115, 115, 34, 58, 34, 69, 120, 99, 101, 112, 116, 105, 111, 110, 34, 44, 34, 109, 101, 115, 115, 97, 103, 101, 34]...', original message: bytes can be at most 32766 in length; got 33656]; nested: MaxBytesLengthExceededException[bytes can be at most 32766 in length; got 33656];\n`\n\nand the message is not logged in graylog.\n\nfailing test:\n\n``` php\npublic function testFormatWithLargeData() {\n    $formatter = new GelfMessageFormatter();\n    $record = array(\n        'level' => Logger::ERROR,\n        'level_name' => 'ERROR',\n        'channel' => 'meh',\n        'context' => array('exception' => str_repeat(' ', 32767)),\n        'datetime' => new \\DateTime(\"@0\"),\n        'extra' => array('key' => str_repeat(' ', 32767)),\n        'message' => 'log'\n    );\n    $message = $formatter->format($record);\n    $messageArray = $message->toArray();\n    $this->assertLessThanOrEqual(32766, strlen($messageArray['_key']));\n    $this->assertLessThanOrEqual(32766, strlen($messageArray['_ctxt_exception']));\n}\n```\n","closed_by":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/751/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/751/timeline","performed_via_github_app":null,"state_reason":"completed"}