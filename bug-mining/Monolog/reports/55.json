{"url":"https://api.github.com/repos/Seldaek/monolog/issues/709","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/709/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/709/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/709/events","html_url":"https://github.com/Seldaek/monolog/issues/709","id":123652000,"node_id":"MDU6SXNzdWUxMjM2NTIwMDA=","number":709,"title":"File rotate failed due to error 'No such file or directory'","user":{"login":"atulatri","id":1751860,"node_id":"MDQ6VXNlcjE3NTE4NjA=","avatar_url":"https://avatars.githubusercontent.com/u/1751860?v=4","gravatar_id":"","url":"https://api.github.com/users/atulatri","html_url":"https://github.com/atulatri","followers_url":"https://api.github.com/users/atulatri/followers","following_url":"https://api.github.com/users/atulatri/following{/other_user}","gists_url":"https://api.github.com/users/atulatri/gists{/gist_id}","starred_url":"https://api.github.com/users/atulatri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/atulatri/subscriptions","organizations_url":"https://api.github.com/users/atulatri/orgs","repos_url":"https://api.github.com/users/atulatri/repos","events_url":"https://api.github.com/users/atulatri/events{/privacy}","received_events_url":"https://api.github.com/users/atulatri/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":87833823,"node_id":"MDU6TGFiZWw4NzgzMzgyMw==","url":"https://api.github.com/repos/Seldaek/monolog/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-12-23T12:32:54Z","updated_at":"2016-03-01T15:44:59Z","closed_at":"2016-03-01T15:44:59Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We experienced following exception while using RotatingFileHandler\n\n```\nunlink(/opt/__data/logs/queue-2015-12-13.log): No such file or directory in /__src/thirdparty/Monolog/Handler/RotatingFileHandler.php on line 118\n#0 [internal function]: Whoops\\Run->handleError(2, 'unlink(/opt/...', '/opt/releases/...', 118, Array)\n#1 /__src/thirdparty/Monolog/Handler/RotatingFileHandler.php(118): unlink('/opt/__...')\n#2 /__src/thirdparty/Monolog/Handler/RotatingFileHandler.php(61): Monolog\\Handler\\RotatingFileHandler->rotate()\n#3 /__src/thirdparty/Monolog/Handler/RotatingFileHandler.php(85): Monolog\\Handler\\RotatingFileHandler->close()\n#4 /__src/thirdparty/Monolog/Handler/AbstractProcessingHandler.php(37): Monolog\\Handler\\RotatingFileHandler->write(Array)\n#5 /__src/thirdparty/Monolog/Logger.php(263): Monolog\\Handler\\AbstractProcessingHandler->handle(Array)\n```\n\nI am not exactly sure why this error occurred.  However upon looking method RotatingFileHandler::rotate(). I think there is a possibility of such exceptions. \n\n```\n/**\n * Rotates the files.\n */\nprotected function rotate()\n{\n    // update filename\n    $this->url = $this->getTimedFilename();\n    $this->nextRotation = new \\DateTime('tomorrow');\n\n    // skip GC of old logs if files are unlimited\n    if (0 === $this->maxFiles) {\n        return;\n    }\n\n    $logFiles = glob($this->getGlobPattern());\n    if ($this->maxFiles >= count($logFiles)) {\n        // no files to remove\n        return;\n    }\n\n    // Sorting the files by name to remove the older ones\n    usort($logFiles, function ($a, $b) {\n        return strcmp($b, $a);\n    });\n\n    foreach (array_slice($logFiles, $this->maxFiles) as $file) {\n        if (is_writable($file)) {\n            unlink($file);\n        }\n    }\n}\n```\n\nHere unlink is protected by is_writable check. But is_writable result is cached (http://php.net/manual/en/function.clearstatcache.php). So if log file is removed by another process (may be log rotate event in another process), unlink may fail. To solve this issue we should clearstatcache for log file before using check is_writable. Happening of this case is rare but I think is a real possibility.\n\nI am also looking for other explanations for such exception.  Your help is much appreciated.\n","closed_by":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/709/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/709/timeline","performed_via_github_app":null,"state_reason":"completed"}