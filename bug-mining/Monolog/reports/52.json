{"url":"https://api.github.com/repos/Seldaek/monolog/issues/657","repository_url":"https://api.github.com/repos/Seldaek/monolog","labels_url":"https://api.github.com/repos/Seldaek/monolog/issues/657/labels{/name}","comments_url":"https://api.github.com/repos/Seldaek/monolog/issues/657/comments","events_url":"https://api.github.com/repos/Seldaek/monolog/issues/657/events","html_url":"https://github.com/Seldaek/monolog/issues/657","id":108561250,"node_id":"MDU6SXNzdWUxMDg1NjEyNTA=","number":657,"title":"Microsecond timestamps cost milliseconds of runtime with heavy log usage","user":{"login":"bd808","id":6469,"node_id":"MDQ6VXNlcjY0Njk=","avatar_url":"https://avatars.githubusercontent.com/u/6469?v=4","gravatar_id":"","url":"https://api.github.com/users/bd808","html_url":"https://github.com/bd808","followers_url":"https://api.github.com/users/bd808/followers","following_url":"https://api.github.com/users/bd808/following{/other_user}","gists_url":"https://api.github.com/users/bd808/gists{/gist_id}","starred_url":"https://api.github.com/users/bd808/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bd808/subscriptions","organizations_url":"https://api.github.com/users/bd808/orgs","repos_url":"https://api.github.com/users/bd808/repos","events_url":"https://api.github.com/users/bd808/events{/privacy}","received_events_url":"https://api.github.com/users/bd808/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":87833791,"node_id":"MDU6TGFiZWw4NzgzMzc5MQ==","url":"https://api.github.com/repos/Seldaek/monolog/labels/Feature","name":"Feature","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/Seldaek/monolog/milestones/1","html_url":"https://github.com/Seldaek/monolog/milestone/1","labels_url":"https://api.github.com/repos/Seldaek/monolog/milestones/1/labels","id":338543,"node_id":"MDk6TWlsZXN0b25lMzM4NTQz","number":1,"title":"2.0","description":"BC breaks for 2.0","creator":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":78,"state":"closed","created_at":"2013-05-21T17:53:00Z","updated_at":"2019-09-05T11:31:55Z","due_on":null,"closed_at":"2019-09-05T11:31:55Z"},"comments":1,"created_at":"2015-09-27T21:11:41Z","updated_at":"2015-10-26T09:46:15Z","closed_at":"2015-10-26T09:46:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The use of `DateTime::createFromFormat` to create timestamps with microsecond resolution can incur milliseconds of runtime overhead when handling a request which generates a significant number of logging events. This cost is paid even if the events are eventually discarded as the `$record['datetime']` member for each event is populated even if no handlers are interested in recording the event durably.\n\nThis simplistic benchmark shows the relative costs of collecting microsecond level timing data:\n\n``` php\n<?php\n$limit = 1000;\n$tz = new DateTimeZone('UTC');\n\n$start = microtime(true);\nfor ($i = 0; $i < $limit; $i++) {\n        $dt = DateTime::createFromFormat('U.u', sprintf('%.6F', microtime(true)), $tz)->\n                setTimezone($tz);\n}\necho 'createFromFormat: ', microtime(true) - $start, \"\\n\";\n\n$start = microtime(true);\nfor ($i = 0; $i < $limit; $i++) {\n        $dt = new DateTime(null, $tz);\n}\necho 'DateTime:         ', microtime(true) - $start, \"\\n\";\n```\n\n``` sh\n$ php benchmark.php\ncreateFromFormat: 0.010702133178711\nDateTime:         0.0037209987640381\n```\n\nUse of `DateTime::createFromFormat` was introduced in 61a4945 replacing a simple usage of `new DateTime`. In a application that generates a few dozens or even hundreds of log events per request the runtime cost difference of `DateTime::createFromFormat` is probably not noticeable. The costs add up however on a heavily loaded system handling hundreds of requests per second with hundreds or even thousands of log events generated per request. Under any conditions the benefit of having microsecond resolution for timestamps verses millisecond level resolution is debatable. When having this level of granularity requires milliseconds of wall clock time to compute, the benefit is even more tenuous.\n\nThe easy fix for this issue would be to simply replace `\\DateTime::createFromFormat('U.u', sprintf('%.6F', microtime(true)), static::$timezone)->setTimezone(static::$timezone)` with `'datetime' => new \\DateTime(null, static::$timezone)` in `Monolog\\Logger`. A more complicated approach would be to introduce a feature flag that allows control of millisecond/microsecond timestamp resolution. If I was the benevolent dictator for this project I would chose the simple solution under the basic assumption that logging should seek to be as low impact as possible, especially for `debug` events that are likely to be discarded anyway.\n","closed_by":{"login":"Seldaek","id":183678,"node_id":"MDQ6VXNlcjE4MzY3OA==","avatar_url":"https://avatars.githubusercontent.com/u/183678?v=4","gravatar_id":"","url":"https://api.github.com/users/Seldaek","html_url":"https://github.com/Seldaek","followers_url":"https://api.github.com/users/Seldaek/followers","following_url":"https://api.github.com/users/Seldaek/following{/other_user}","gists_url":"https://api.github.com/users/Seldaek/gists{/gist_id}","starred_url":"https://api.github.com/users/Seldaek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Seldaek/subscriptions","organizations_url":"https://api.github.com/users/Seldaek/orgs","repos_url":"https://api.github.com/users/Seldaek/repos","events_url":"https://api.github.com/users/Seldaek/events{/privacy}","received_events_url":"https://api.github.com/users/Seldaek/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Seldaek/monolog/issues/657/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Seldaek/monolog/issues/657/timeline","performed_via_github_app":null,"state_reason":"completed"}