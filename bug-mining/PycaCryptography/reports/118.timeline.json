[{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1431633836","html_url":"https://github.com/pyca/cryptography/issues/8298#issuecomment-1431633836","issue_url":"https://api.github.com/repos/pyca/cryptography/issues/8298","id":1431633836,"node_id":"IC_kwDOALYunM5VVP-s","user":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-15T16:22:10Z","updated_at":"2023-02-15T16:22:10Z","body":"Thanks for the report. This is our bug. In 39 we rewrote part of the S/MIME code and introduced this issue. We canonicalize the input in text mode (which consists of converting line endings to `\\r\\n`) and we add the text/plain value in the same function. This is useful since we need to sign over the content-type as well as the payload, but then we call another smime_encode function if you pass `serialization.Encoding.SMIME`, which duplicates it. The tests failed to catch it because they looked for the presence of text/plain and did not assert the number of them and our verification test passed too because we don't extract the signature test value from the output.\r\n\r\nWe'll get a fix up soon.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1431633836/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8531669116,"node_id":"MIE_lADOALYunM5eiUELzwAAAAH8hvB8","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8531669116","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2023-02-16T00:00:27Z","milestone":{"title":"Fortieth release"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432253474","html_url":"https://github.com/pyca/cryptography/issues/8298#issuecomment-1432253474","issue_url":"https://api.github.com/repos/pyca/cryptography/issues/8298","id":1432253474,"node_id":"IC_kwDOALYunM5VXnQi","user":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-16T00:01:58Z","updated_at":"2023-02-16T00:01:58Z","body":"I'm not sure I understand why our verification tests still pass here.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432253474/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432274003","html_url":"https://github.com/pyca/cryptography/issues/8298#issuecomment-1432274003","issue_url":"https://api.github.com/repos/pyca/cryptography/issues/8298","id":1432274003,"node_id":"IC_kwDOALYunM5VXsRT","user":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-16T00:15:47Z","updated_at":"2023-02-16T00:15:47Z","body":"They pass because we sign the right thing but embed the wrong thing into the larger smime payload and then the verify call doesn't use what's in the smime payload. The test is https://github.com/pyca/cryptography/blob/d90ed2b2bc6d02720191d6449be098451677b3fd/tests/hazmat/primitives/test_pkcs7.py#L495-L506\r\n\r\nbut it should be:\r\n\r\n```python\r\n        assert sig_pem.count(b\"text/plain\") == 1\r\n        # Parse the message to get the signed data, which is the\r\n        # first payload in the message\r\n        message = email.parser.BytesParser().parsebytes(sig_pem)\r\n        signed_data = message.get_payload()[0].as_bytes()\r\n        _pkcs7_verify(...)\r\n```\r\n\r\nEither of the changes to the test above would have caught this bug.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432274003/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432274856","html_url":"https://github.com/pyca/cryptography/issues/8298#issuecomment-1432274856","issue_url":"https://api.github.com/repos/pyca/cryptography/issues/8298","id":1432274856,"node_id":"IC_kwDOALYunM5VXseo","user":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-16T00:16:58Z","updated_at":"2023-02-16T00:16:58Z","body":"Gotcha,thanks.\n\nOn Wed, Feb 15, 2023 at 7:15 PM Paul Kehrer ***@***.***>\nwrote:\n\n> They pass because we sign the right thing but embed the wrong thing into\n> the larger smime payload and then the verify call doesn't use what's in the\n> smime payload. The test is\n> https://github.com/pyca/cryptography/blob/d90ed2b2bc6d02720191d6449be098451677b3fd/tests/hazmat/primitives/test_pkcs7.py#L495-L506\n>\n> but it should be:\n>\n>         assert sig_pem.count(b\"text/plain\") == 1\n>         # Parse the message to get the signed data, which is the\n>         # first payload in the message\n>         message = email.parser.BytesParser().parsebytes(sig_pem)\n>         signed_data = message.get_payload()[0].as_bytes()\n>         _pkcs7_verify(...)\n>\n> Either of the changes to the test above would have caught this bug.\n>\n> â€”\n> Reply to this email directly, view it on GitHub\n> <https://github.com/pyca/cryptography/issues/8298#issuecomment-1432274003>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AAAAGBCYZE3NAQRXF4AFSVDWXVWT3ANCNFSM6AAAAAAU47XZFU>\n> .\n> You are receiving this because you commented.Message ID:\n> ***@***.***>\n>\n\n\n-- \nAll that is necessary for evil to succeed is for good people to do nothing.\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432274856/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432727470","html_url":"https://github.com/pyca/cryptography/issues/8298#issuecomment-1432727470","issue_url":"https://api.github.com/repos/pyca/cryptography/issues/8298","id":1432727470,"node_id":"IC_kwDOALYunM5VZa-u","user":{"login":"dirksammel","id":56543654,"node_id":"MDQ6VXNlcjU2NTQzNjU0","avatar_url":"https://avatars.githubusercontent.com/u/56543654?v=4","gravatar_id":"","url":"https://api.github.com/users/dirksammel","html_url":"https://github.com/dirksammel","followers_url":"https://api.github.com/users/dirksammel/followers","following_url":"https://api.github.com/users/dirksammel/following{/other_user}","gists_url":"https://api.github.com/users/dirksammel/gists{/gist_id}","starred_url":"https://api.github.com/users/dirksammel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dirksammel/subscriptions","organizations_url":"https://api.github.com/users/dirksammel/orgs","repos_url":"https://api.github.com/users/dirksammel/repos","events_url":"https://api.github.com/users/dirksammel/events{/privacy}","received_events_url":"https://api.github.com/users/dirksammel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-16T08:52:19Z","updated_at":"2023-02-16T08:52:19Z","body":"@reaperhulk Thanks for the answer and explanation!","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/comments/1432727470/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dirksammel","id":56543654,"node_id":"MDQ6VXNlcjU2NTQzNjU0","avatar_url":"https://avatars.githubusercontent.com/u/56543654?v=4","gravatar_id":"","url":"https://api.github.com/users/dirksammel","html_url":"https://github.com/dirksammel","followers_url":"https://api.github.com/users/dirksammel/followers","following_url":"https://api.github.com/users/dirksammel/following{/other_user}","gists_url":"https://api.github.com/users/dirksammel/gists{/gist_id}","starred_url":"https://api.github.com/users/dirksammel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dirksammel/subscriptions","organizations_url":"https://api.github.com/users/dirksammel/orgs","repos_url":"https://api.github.com/users/dirksammel/repos","events_url":"https://api.github.com/users/dirksammel/events{/privacy}","received_events_url":"https://api.github.com/users/dirksammel/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8534472369,"node_id":"MEE_lADOALYunM5eiUELzwAAAAH8sbax","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8534472369","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-02-16T08:52:19Z","performed_via_github_app":null},{"id":8534472383,"node_id":"SE_lADOALYunM5eiUELzwAAAAH8sba_","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8534472383","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-02-16T08:52:20Z","performed_via_github_app":null},{"id":8608733118,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBHte-","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608733118","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4486f836f79fa9bea6c78cae33c5ae074a24bbc4","commit_url":"https://api.github.com/repos/alex/cryptography/commits/4486f836f79fa9bea6c78cae33c5ae074a24bbc4","created_at":"2023-02-26T00:53:13Z","performed_via_github_app":null},{"id":8608736834,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBHuZC","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608736834","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a77fb4c2b9855d6230ff939d7246fed28025ec58","commit_url":"https://api.github.com/repos/alex/cryptography/commits/a77fb4c2b9855d6230ff939d7246fed28025ec58","created_at":"2023-02-26T00:58:12Z","performed_via_github_app":null},{"id":8608757476,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBHzbk","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608757476","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"06fbca4319b96c242bab27fcaf9b431196ae4d9a","commit_url":"https://api.github.com/repos/alex/cryptography/commits/06fbca4319b96c242bab27fcaf9b431196ae4d9a","created_at":"2023-02-26T01:22:13Z","performed_via_github_app":null},{"id":8608760075,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBH0EL","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608760075","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"1a1e95bf0cf1723858998d9f779874f61e8b6cae","commit_url":"https://api.github.com/repos/alex/cryptography/commits/1a1e95bf0cf1723858998d9f779874f61e8b6cae","created_at":"2023-02-26T01:25:53Z","performed_via_github_app":null},{"actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-26T01:34:19Z","updated_at":"2023-02-26T01:34:19Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/pyca/cryptography/issues/8127","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/8127/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/8127/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/8127/events","html_url":"https://github.com/pyca/cryptography/issues/8127","id":1553333310,"node_id":"I_kwDOALYunM5clfw-","number":8127,"title":"S/MIME signature broken with CA chain in v39.0.0","user":{"login":"dlouzan","id":223870,"node_id":"MDQ6VXNlcjIyMzg3MA==","avatar_url":"https://avatars.githubusercontent.com/u/223870?v=4","gravatar_id":"","url":"https://api.github.com/users/dlouzan","html_url":"https://github.com/dlouzan","followers_url":"https://api.github.com/users/dlouzan/followers","following_url":"https://api.github.com/users/dlouzan/following{/other_user}","gists_url":"https://api.github.com/users/dlouzan/gists{/gist_id}","starred_url":"https://api.github.com/users/dlouzan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dlouzan/subscriptions","organizations_url":"https://api.github.com/users/dlouzan/orgs","repos_url":"https://api.github.com/users/dlouzan/repos","events_url":"https://api.github.com/users/dlouzan/events{/privacy}","received_events_url":"https://api.github.com/users/dlouzan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/pyca/cryptography/milestones/42","html_url":"https://github.com/pyca/cryptography/milestone/42","labels_url":"https://api.github.com/repos/pyca/cryptography/milestones/42/labels","id":8693501,"node_id":"MI_kwDOALYunM4AhKb9","number":42,"title":"Fortieth release","description":"","creator":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":20,"state":"closed","created_at":"2022-11-26T17:30:50Z","updated_at":"2023-03-24T04:22:42Z","due_on":null,"closed_at":"2023-03-24T04:22:42Z"},"comments":15,"created_at":"2023-01-23T15:48:49Z","updated_at":"2023-05-30T00:01:14Z","closed_at":"2023-02-26T02:09:37Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":11939484,"node_id":"MDEwOlJlcG9zaXRvcnkxMTkzOTQ4NA==","name":"cryptography","full_name":"pyca/cryptography","private":false,"owner":{"login":"pyca","id":5615737,"node_id":"MDEyOk9yZ2FuaXphdGlvbjU2MTU3Mzc=","avatar_url":"https://avatars.githubusercontent.com/u/5615737?v=4","gravatar_id":"","url":"https://api.github.com/users/pyca","html_url":"https://github.com/pyca","followers_url":"https://api.github.com/users/pyca/followers","following_url":"https://api.github.com/users/pyca/following{/other_user}","gists_url":"https://api.github.com/users/pyca/gists{/gist_id}","starred_url":"https://api.github.com/users/pyca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyca/subscriptions","organizations_url":"https://api.github.com/users/pyca/orgs","repos_url":"https://api.github.com/users/pyca/repos","events_url":"https://api.github.com/users/pyca/events{/privacy}","received_events_url":"https://api.github.com/users/pyca/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/pyca/cryptography","description":"cryptography is a package designed to expose cryptographic primitives and recipes to Python developers.","fork":false,"url":"https://api.github.com/repos/pyca/cryptography","forks_url":"https://api.github.com/repos/pyca/cryptography/forks","keys_url":"https://api.github.com/repos/pyca/cryptography/keys{/key_id}","collaborators_url":"https://api.github.com/repos/pyca/cryptography/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/pyca/cryptography/teams","hooks_url":"https://api.github.com/repos/pyca/cryptography/hooks","issue_events_url":"https://api.github.com/repos/pyca/cryptography/issues/events{/number}","events_url":"https://api.github.com/repos/pyca/cryptography/events","assignees_url":"https://api.github.com/repos/pyca/cryptography/assignees{/user}","branches_url":"https://api.github.com/repos/pyca/cryptography/branches{/branch}","tags_url":"https://api.github.com/repos/pyca/cryptography/tags","blobs_url":"https://api.github.com/repos/pyca/cryptography/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/pyca/cryptography/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/pyca/cryptography/git/refs{/sha}","trees_url":"https://api.github.com/repos/pyca/cryptography/git/trees{/sha}","statuses_url":"https://api.github.com/repos/pyca/cryptography/statuses/{sha}","languages_url":"https://api.github.com/repos/pyca/cryptography/languages","stargazers_url":"https://api.github.com/repos/pyca/cryptography/stargazers","contributors_url":"https://api.github.com/repos/pyca/cryptography/contributors","subscribers_url":"https://api.github.com/repos/pyca/cryptography/subscribers","subscription_url":"https://api.github.com/repos/pyca/cryptography/subscription","commits_url":"https://api.github.com/repos/pyca/cryptography/commits{/sha}","git_commits_url":"https://api.github.com/repos/pyca/cryptography/git/commits{/sha}","comments_url":"https://api.github.com/repos/pyca/cryptography/comments{/number}","issue_comment_url":"https://api.github.com/repos/pyca/cryptography/issues/comments{/number}","contents_url":"https://api.github.com/repos/pyca/cryptography/contents/{+path}","compare_url":"https://api.github.com/repos/pyca/cryptography/compare/{base}...{head}","merges_url":"https://api.github.com/repos/pyca/cryptography/merges","archive_url":"https://api.github.com/repos/pyca/cryptography/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/pyca/cryptography/downloads","issues_url":"https://api.github.com/repos/pyca/cryptography/issues{/number}","pulls_url":"https://api.github.com/repos/pyca/cryptography/pulls{/number}","milestones_url":"https://api.github.com/repos/pyca/cryptography/milestones{/number}","notifications_url":"https://api.github.com/repos/pyca/cryptography/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/pyca/cryptography/labels{/name}","releases_url":"https://api.github.com/repos/pyca/cryptography/releases{/id}","deployments_url":"https://api.github.com/repos/pyca/cryptography/deployments","created_at":"2013-08-07T02:23:38Z","updated_at":"2025-11-10T02:24:11Z","pushed_at":"2025-11-10T10:09:01Z","git_url":"git://github.com/pyca/cryptography.git","ssh_url":"git@github.com:pyca/cryptography.git","clone_url":"https://github.com/pyca/cryptography.git","svn_url":"https://github.com/pyca/cryptography","homepage":"https://cryptography.io","size":64122,"stargazers_count":7307,"watchers_count":7307,"language":"Python","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":1673,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":45,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["cryptography","python"],"visibility":"public","forks":1673,"open_issues":45,"watchers":7307,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Hello dear maintainers,\r\n\r\nWe have just experienced a regression when updating from v38.0.4 to v39.0.0 when generating S/MIME signatures. We have a setup with multiple intermediate CAs, and the generated signatures are broken, they do not pass smime validation.\r\n\r\nWe have tracked this to a chain sorting issue, in the generated signature the root CA ends up as the first entry in the signature chain, instead of the expected `leaf > intermediate1 > intermediate2 > root` order.\r\n\r\nWe are wondering if this could have to do with the recent bump of the pem library at https://github.com/pyca/cryptography/pull/8043.\r\n\r\nA sample of the code:\r\n\r\n```python\r\ndef load_certificates(cert_path: str) -> list[Certificate]:\r\n    with open(cert_path, \"r\") as f:\r\n        ...\r\n        return [\r\n            cryptography.x509.load_pem_x509_certificate(\r\n                bytes(cert + delimiter, \"utf-8\")\r\n            )\r\n            for cert in all_certs\r\n        ]\r\n\r\n\r\ndef load_key(key_path: str) -> CERTIFICATE_PRIVATE_KEY_TYPES:\r\n    with open(key_path, \"rb\") as f:\r\n        return cryptography.hazmat.primitives.serialization.load_pem_private_key(\r\n            f.read(),\r\n            None,\r\n        )\r\n\r\n\r\ndef get_smime_attachment_content(\r\n    data: bytes,\r\n    key: CERTIFICATE_PRIVATE_KEY_TYPES,\r\n    cert: Certificate,\r\n    ca: list[Certificate],\r\n) -> bytes:\r\n    return PKCS7SignatureBuilder(\r\n        data=data,\r\n        signers=[\r\n            (cert, key, cryptography.hazmat.primitives.hashes.SHA512()),\r\n        ],\r\n        additional_certs=ca,\r\n    ).sign(\r\n        Encoding.SMIME,\r\n        options=[PKCS7Options.DetachedSignature],\r\n    )\r\n```\r\n\r\nWe have debugged and the `ca: list[Certificate]` param is pased in the right order, but the generated signature messes this up (and also breaks the signature itself). After generating the message and analyzing it with openssl, we see:\r\n\r\n```sh\r\ncat smime.msg | openssl smime -pk7out | openssl pkcs7 -print_certs\r\n\r\n<root CA>\r\n<leaf>\r\n<intermediate1>\r\n<intermediate2>\r\n```\r\n\r\nin a proper email we should see:\r\n\r\n```sh\r\n<leaf>\r\n<intermediate1>\r\n<intermediate2>\r\n<root CA>\r\n```\r\n\r\nReverting to v38.0.4 fixes the problem.\r\n\r\n/cc @max-wittig","reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/8127/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/8127/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":8608767663,"node_id":"COE_lADOALYunM5eiUELzwAAAAIBH16v","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608767663","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"connected","commit_id":null,"commit_url":null,"created_at":"2023-02-26T01:34:31Z","performed_via_github_app":null},{"id":8608780740,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBH5HE","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608780740","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"bb1ac6877baa4862bc03394dfabe1c4c42dd08fe","commit_url":"https://api.github.com/repos/alex/cryptography/commits/bb1ac6877baa4862bc03394dfabe1c4c42dd08fe","created_at":"2023-02-26T01:51:24Z","performed_via_github_app":null},{"id":8608798059,"node_id":"CE_lADOALYunM5eiUELzwAAAAIBH9Vr","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608798059","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2023-02-26T02:09:38Z","state_reason":null,"performed_via_github_app":null},{"id":8608798064,"node_id":"CE_lADOALYunM5eiUELzwAAAAIBH9Vw","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608798064","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"bc61b605c75e3e6d271b1b597e778fc335ba2e98","commit_url":"https://api.github.com/repos/pyca/cryptography/commits/bc61b605c75e3e6d271b1b597e778fc335ba2e98","created_at":"2023-02-26T02:09:38Z","state_reason":null,"performed_via_github_app":null},{"id":8608934839,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBIeu3","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8608934839","actor":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2a5e7b5ab588322fd99868e0203f757e2601e0fd","commit_url":"https://api.github.com/repos/reaperhulk/cryptography/commits/2a5e7b5ab588322fd99868e0203f757e2601e0fd","created_at":"2023-02-26T05:06:35Z","performed_via_github_app":null},{"id":8610207909,"node_id":"REFE_lADOALYunM5eiUELzwAAAAIBNVil","url":"https://api.github.com/repos/pyca/cryptography/issues/events/8610207909","actor":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a69fe983b150b25c68a86d0c4f7fe11711ddc5bd","commit_url":"https://api.github.com/repos/pyca/cryptography/commits/a69fe983b150b25c68a86d0c4f7fe11711ddc5bd","created_at":"2023-02-26T21:23:54Z","performed_via_github_app":null},{"id":9359242365,"node_id":"LOE_lADOALYunM5eiUELzwAAAAIt2rR9","url":"https://api.github.com/repos/pyca/cryptography/issues/events/9359242365","actor":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"locked","commit_id":null,"commit_url":null,"created_at":"2023-05-28T00:01:23Z","lock_reason":"resolved","performed_via_github_app":null}]