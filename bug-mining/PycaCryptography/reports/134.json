{"url":"https://api.github.com/repos/pyca/cryptography/issues/10422","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/10422/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/10422/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/10422/events","html_url":"https://github.com/pyca/cryptography/issues/10422","id":2142684311,"node_id":"I_kwDOALYunM5_tsSX","number":10422,"title":"\"Access Violation Error\" on creating legacy pkcs12 file with wrong private key","user":{"login":"Alexander-Programming","id":156447091,"node_id":"U_kgDOCVMxcw","avatar_url":"https://avatars.githubusercontent.com/u/156447091?v=4","gravatar_id":"","url":"https://api.github.com/users/Alexander-Programming","html_url":"https://github.com/Alexander-Programming","followers_url":"https://api.github.com/users/Alexander-Programming/followers","following_url":"https://api.github.com/users/Alexander-Programming/following{/other_user}","gists_url":"https://api.github.com/users/Alexander-Programming/gists{/gist_id}","starred_url":"https://api.github.com/users/Alexander-Programming/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alexander-Programming/subscriptions","organizations_url":"https://api.github.com/users/Alexander-Programming/orgs","repos_url":"https://api.github.com/users/Alexander-Programming/repos","events_url":"https://api.github.com/users/Alexander-Programming/events{/privacy}","received_events_url":"https://api.github.com/users/Alexander-Programming/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-02-19T15:52:29Z","updated_at":"2024-05-20T03:04:19Z","closed_at":"2024-02-19T16:50:31Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"`serialize_key_and_certificates` exits the main thread with `-1073741819 (0xC0000005)` when called with a private key not belonging to the certificate.\r\n\r\nVersions:\r\n* Python: `3.10.11` \r\n* Pip: `24.0`\r\n* cryptography: `42.0.3`\r\n* OS: `Windows 11`\r\n\r\ncryptography was installed via pip `pip install cryptography `\r\n\r\nmin steps to reproduce:\r\n\r\n```python\r\ndef min_example():\r\n    from cryptography import x509\r\n    from cryptography.x509.oid import NameOID\r\n    from cryptography.hazmat.primitives import hashes\r\n    from cryptography.hazmat.backends import default_backend\r\n    from cryptography.hazmat.primitives.asymmetric import rsa\r\n    from cryptography.hazmat.primitives._serialization import PrivateFormat\r\n    from cryptography.hazmat.primitives.serialization import pkcs12\r\n    from datetime import datetime, timedelta\r\n\r\n    private_key = rsa.generate_private_key(\r\n        public_exponent=65537,\r\n        key_size=2048\r\n    )\r\n    name = x509.Name([\r\n        x509.NameAttribute(NameOID.COMMON_NAME, \"COMMON_NAME\")\r\n    ])\r\n    \r\n    basic_contraints = x509.BasicConstraints(ca=True, path_length=0)\r\n    now = datetime.utcnow()\r\n    cert = (\r\n        x509.CertificateBuilder()\r\n        .subject_name(name)\r\n        .issuer_name(name)\r\n        .public_key(private_key.public_key())\r\n        .serial_number(1000)\r\n        .not_valid_before(now)\r\n        .not_valid_after(now + timedelta(days=10*365))\r\n        .add_extension(basic_contraints, False)\r\n        .sign(private_key, hashes.SHA256(), default_backend())\r\n    )\r\n    false_private_key = rsa.generate_private_key(\r\n        public_exponent=65537,\r\n        key_size=2048\r\n    )\r\n    encryption = (\r\n        PrivateFormat.PKCS12.encryption_builder().\r\n        kdf_rounds(50000).\r\n        key_cert_algorithm(pkcs12.PBES.PBESv1SHA1And3KeyTripleDESCBC).\r\n        hmac_hash(hashes.SHA1()).\r\n        build(\"test12345678\".encode())\r\n    )\r\n    \r\n    ### program exits with: -1073741819 (0xC0000005). This \"Access Violation Error\" uncatchable with try except\r\n    p12 = pkcs12.serialize_key_and_certificates(\r\n        name=\"common_name\".encode(), key=false_private_key, cert=cert, cas=None, encryption_algorithm=encryption\r\n    )\r\n```\r\nI am working with a user maintained database of certs and cannot know if the certs and private keys have been stored correctly. I would like to have a descriptive exception that is catchable by python.\r\n\r\nFor now I'm building the cert first with the python `OpenSSL` lib which returns me the wrong kind of `.pfx` but throws catchable errors and if no error occurs I build the `.pfx` file with the `cryptography` lib. A sub optimal process but it works for now. \r\n","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/10422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/10422/timeline","performed_via_github_app":null,"state_reason":"completed"}