{"url":"https://api.github.com/repos/pyca/cryptography/issues/9845","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/9845/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/9845/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/9845/events","html_url":"https://github.com/pyca/cryptography/issues/9845","id":1986430412,"node_id":"I_kwDOALYunM52ZoXM","number":9845,"title":"HKDF with SHAKE256 gives InternalError: Unknown OpenSSL error.","user":{"login":"clonejo","id":261803,"node_id":"MDQ6VXNlcjI2MTgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/261803?v=4","gravatar_id":"","url":"https://api.github.com/users/clonejo","html_url":"https://github.com/clonejo","followers_url":"https://api.github.com/users/clonejo/followers","following_url":"https://api.github.com/users/clonejo/following{/other_user}","gists_url":"https://api.github.com/users/clonejo/gists{/gist_id}","starred_url":"https://api.github.com/users/clonejo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clonejo/subscriptions","organizations_url":"https://api.github.com/users/clonejo/orgs","repos_url":"https://api.github.com/users/clonejo/repos","events_url":"https://api.github.com/users/clonejo/events{/privacy}","received_events_url":"https://api.github.com/users/clonejo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/pyca/cryptography/milestones/44","html_url":"https://github.com/pyca/cryptography/milestone/44","labels_url":"https://api.github.com/repos/pyca/cryptography/milestones/44/labels","id":9461199,"node_id":"MI_kwDOALYunM4AkF3P","number":44,"title":"Forty Second Release","description":"","creator":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":22,"state":"closed","created_at":"2023-05-30T02:33:21Z","updated_at":"2024-01-23T01:22:17Z","due_on":null,"closed_at":"2024-01-23T01:22:17Z"},"comments":3,"created_at":"2023-11-09T21:28:46Z","updated_at":"2024-02-09T00:01:15Z","closed_at":"2023-11-10T15:12:01Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I run into \"cryptography.exceptions.InternalError: Unknown OpenSSL error.\" when i try to perform a HKDF key derivation with SHAKE256. HKDF with SHA256 works fine.\r\n\r\n## Error Message\r\n```\r\nTraceback (most recent call last):\r\n  File \"[因/cryptography-openssl-crash/./crypto.py\", line 23, in <module>\r\n    enc_key = derive_key(root)\r\n              ^^^^^^^^^^^^^^^^\r\n  File \"[因/./crypto.py\", line 19, in derive_key\r\n    return hkdf.derive(root)\r\n           ^^^^^^^^^^^^^^^^^\r\n  File \"[因/.cache/pypoetry/virtualenvs/cryptography-openssl-crash-X_c1qFin-py3.11/lib/python3.11/site-packages/cryptography/hazmat/primitives/kdf/hkdf.py\", line 42, in derive\r\n    return self._hkdf_expand.derive(self._extract(key_material))\r\n                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"[因/.cache/pypoetry/virtualenvs/cryptography-openssl-crash-X_c1qFin-py3.11/lib/python3.11/site-packages/cryptography/hazmat/primitives/kdf/hkdf.py\", line 36, in _extract\r\n    h = hmac.HMAC(self._salt, self._algorithm)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\ncryptography.exceptions.InternalError: Unknown OpenSSL error. This error is commonly encountered\r\n                        when another library is not cleaning up the OpenSSL error\r\n                        stack. If you are using cryptography with another library\r\n                        that uses OpenSSL try disabling it before reporting a bug.\r\n                        Otherwise please file an issue at\r\n                        https://github.com/pyca/cryptography/issues with\r\n                        information on how to reproduce this. ([])\r\n```\r\n\r\n## How to reproduce\r\ncrypto.py:\r\n```python\r\n#!/usr/bin/env python3\r\n\r\nfrom cryptography.hazmat.primitives import hashes\r\nfrom cryptography.hazmat.primitives.kdf.hkdf import HKDF\r\n\r\n\r\ndef derive_key(root):\r\n    hkdf = HKDF(\r\n        algorithm=hashes.SHAKE256(\r\n            256\r\n        ),  # cryptography.exceptions.InternalError: Unknown OpenSSL error.\r\n        # algorithm=hashes.SHA256(),  # this works\r\n        length=256 // 8,\r\n        salt=None,\r\n        info=None,\r\n    )\r\n\r\n    return hkdf.derive(root)\r\n\r\n\r\nroot = b\"\\x17\" * 32\r\nenc_key = derive_key(root)\r\nprint(enc_key)\r\n```\r\n\r\n```sh\r\npipx install poetry\r\npoetry init\r\npoetry add cryptography\r\npoetry run ./crypto.py\r\n```\r\n\r\n~~The same happens when i try to use Hash() with SHAKE256(). SHAKE128() and SHA3_256() also seem to be affected.~~\r\n\r\n## Versions\r\nPython = 3.11.5\r\ncryptography = 41.0.5\r\ncffi = 1.16.0\r\npip = 23.3.1\r\nsetuptools = 68.2.2\r\n```\r\n>>> cryptography.hazmat.backends.openssl.backend.openssl_version_text()\r\n'OpenSSL 3.1.4 24 Oct 2023'\r\n```\r\n\r\nReproduces on both Fedora and Arch.\r\n\r\n\r\nThanks for having a look!\r\n","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/9845/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/9845/timeline","performed_via_github_app":null,"state_reason":"completed"}