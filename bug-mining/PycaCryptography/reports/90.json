{"url":"https://api.github.com/repos/pyca/cryptography/issues/6973","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/6973/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/6973/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/6973/events","html_url":"https://github.com/pyca/cryptography/issues/6973","id":1172830848,"node_id":"I_kwDOALYunM5F5_qA","number":6973,"title":"CertificateSigningRequestBuilder.add_attribute doesn't derive attribute ASN.1 type from value bytes","user":{"login":"phughesion","id":36139669,"node_id":"MDQ6VXNlcjM2MTM5NjY5","avatar_url":"https://avatars.githubusercontent.com/u/36139669?v=4","gravatar_id":"","url":"https://api.github.com/users/phughesion","html_url":"https://github.com/phughesion","followers_url":"https://api.github.com/users/phughesion/followers","following_url":"https://api.github.com/users/phughesion/following{/other_user}","gists_url":"https://api.github.com/users/phughesion/gists{/gist_id}","starred_url":"https://api.github.com/users/phughesion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/phughesion/subscriptions","organizations_url":"https://api.github.com/users/phughesion/orgs","repos_url":"https://api.github.com/users/phughesion/repos","events_url":"https://api.github.com/users/phughesion/events{/privacy}","received_events_url":"https://api.github.com/users/phughesion/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-17T19:34:13Z","updated_at":"2022-07-05T00:01:31Z","closed_at":"2022-04-05T11:20:59Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"cryptography 37.0.0.dev1\r\npyOpenSSL 22.0.0\r\n\r\nI am trying to make a CSR with a EnrollmentNameValuePair value.\r\n(See https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/92f07a54-2889-45e3-afd0-94b60daa80ec)\r\n\r\nReproducer:\r\n```\r\nfrom cryptography import x509\r\nfrom cryptography.x509.oid import NameOID\r\nfrom cryptography.hazmat.primitives import hashes\r\nfrom cryptography.hazmat.primitives.serialization import Encoding\r\nfrom cryptography.hazmat.primitives.asymmetric import rsa\r\nfrom cryptography.x509.oid import NameOID\r\n\r\ncsr = x509.CertificateSigningRequestBuilder().subject_name(x509.Name([\r\n    x509.NameAttribute(NameOID.COMMON_NAME, \"test\")\r\n]))\r\n\r\nszOID_ENROLLMENT_NAME_VALUE_PAIR = x509.ObjectIdentifier(\"1.3.6.1.4.1.311.13.2.1\")\r\n\r\ncsr = csr.add_attribute(\r\n    szOID_ENROLLMENT_NAME_VALUE_PAIR,\r\n    bytes.fromhex(\"302C1E0600530041004E1E2200750070006E003D00410064006D0069006E006900730074007200610074006F0072\")\r\n)\r\n\r\nkey = rsa.generate_private_key(public_exponent=65537, key_size=4096)\r\ncert = csr.sign(key, hashes.SHA256())\r\nbytes = cert.public_bytes(Encoding.PEM)\r\nc = x509.load_pem_x509_csr(bytes)\r\n\r\nattribute = c.attributes.get_attribute_for_oid(szOID_ENROLLMENT_NAME_VALUE_PAIR)\r\nprint(attribute._type)\r\n```\r\n\r\nThis prints '12' (decimal), for type UTF8String. However, the first byte 0x30 is for SEQUENCE.\r\n\r\nThe attribute value bytes are an object with the following structure:\r\n```\r\nEnrollmentNameValuePair ::= SEQUENCE {\r\n         name                BMPSTRING,\r\n         value               BMPSTRING\r\n }  --#public\r\n```\r\n\r\nWhere 'name' is 'SAN' and 'value' is 'upn=Administrator'\r\n\r\nIt looks like the type is instantiated here and not changed afterwards:\r\nhttps://github.com/pyca/cryptography/blob/b0df70cd2deb8ae8d893a4701f3cb27bda04d5de/src/cryptography/x509/base.py#L81-L87\r\n\r\nIn the CSR, the bytes I provided in the attribute get wrapped in \"0C XX\", so the bytes are 0C 2E 30 2C 1E..... instead of just 30 2C 1E.....\r\nwhere \"30\" is the start of the SEQUENCE.\r\n\r\nI would think that the type should be derived from the first byte of the value provided. Please let me know if I'm wrong.\r\n\r\n","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/6973/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/6973/timeline","performed_via_github_app":null,"state_reason":"completed"}