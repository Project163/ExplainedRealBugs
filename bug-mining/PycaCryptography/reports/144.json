{"url":"https://api.github.com/repos/pyca/cryptography/issues/11461","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/11461/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/11461/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/11461/events","html_url":"https://github.com/pyca/cryptography/issues/11461","id":2475510515,"node_id":"I_kwDOALYunM6TjUrz","number":11461,"title":"Verification may be falsely rejected when root cert has authorityCertIssuer field","user":{"login":"mxsasha","id":98594,"node_id":"MDQ6VXNlcjk4NTk0","avatar_url":"https://avatars.githubusercontent.com/u/98594?v=4","gravatar_id":"","url":"https://api.github.com/users/mxsasha","html_url":"https://github.com/mxsasha","followers_url":"https://api.github.com/users/mxsasha/followers","following_url":"https://api.github.com/users/mxsasha/following{/other_user}","gists_url":"https://api.github.com/users/mxsasha/gists{/gist_id}","starred_url":"https://api.github.com/users/mxsasha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mxsasha/subscriptions","organizations_url":"https://api.github.com/users/mxsasha/orgs","repos_url":"https://api.github.com/users/mxsasha/repos","events_url":"https://api.github.com/users/mxsasha/events{/privacy}","received_events_url":"https://api.github.com/users/mxsasha/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-08-20T12:21:46Z","updated_at":"2024-11-19T03:13:18Z","closed_at":"2024-08-20T15:42:57Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Cryptography's x509 verification appears to reject verification on a certificate when the authorityCertIssuer field is present in the authority key identifier extension of the root certificate. This may be correct per CABF baseline, but is suspiciously different from all other implementations I tested.\r\n\r\nI have [written a small script that isolates the issue](https://gist.github.com/mxsasha/9ca38da42c08f7ec9d1a120f6c82f9d8). This fails on `cryptography.hazmat.bindings._rust.x509.VerificationError: validation failed: CandidatesExhausted(Other(\"authorityKeyIdentifier must not contain authorityCertIssuer\"))`. The leaf and intermediate do not contain authorityCertIssuer - the root does. \r\n\r\nThe error message [originates in the code here](https://github.com/pyca/cryptography/blob/7fda121e69f40b16cc8bf46f9f7ea8cf217e88cb/src/rust/cryptography-x509-verification/src/policy/extension.rs#L418). This code seems to have an exception that allows the authority key identifier extension to be absent, but if it is found, the presence of authorityCertIssuer will lead to an error.\r\n\r\nThis is a widely trusted root certificate, and no browsers and other testing tools don't seem to have an issue with it. I do see the [CABF baseline](https://cabforum.org/working-groups/server/baseline-requirements/requirements/#71213-root-ca-authority-key-identifier) does not allow authorityCertIssuer. But this was [introduced in 2020](https://github.com/cabforum/servercert/pull/195), the root certificate is from 2006. Perhaps there are other details I don't know - I'm not too familiar with these policies and their implementations. It definitely seems strange and undesirable that cryptography rejects a certificate where other implementations find it valid.\r\n\r\nIt would be great if someone with more experience in this area could look at this and determine if cryptography is too strict in this case, and what the correct behavior would be.\r\n\r\nFor completeness, my versions, with cryptography installed in a venv through pip install:\r\n```\r\ncffi==1.15.1\r\ncryptography==43.0.0\r\npip-tools==6.14.0\r\nsetuptools==73.0.0\r\n\r\nPython 3.9.6 (default, Nov 10 2023, 13:38:27) \r\n[Clang 15.0.0 (clang-1500.1.0.2.5)] on darwin\r\n```","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/11461/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/11461/timeline","performed_via_github_app":null,"state_reason":"completed"}