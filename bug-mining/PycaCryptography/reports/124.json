{"url":"https://api.github.com/repos/pyca/cryptography/issues/8867","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/8867/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/8867/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/8867/events","html_url":"https://github.com/pyca/cryptography/issues/8867","id":1697300206,"node_id":"I_kwDOALYunM5lKr7u","number":8867,"title":"Python.h not found during cross-compilation","user":{"login":"pberginkonsult","id":25203405,"node_id":"MDQ6VXNlcjI1MjAzNDA1","avatar_url":"https://avatars.githubusercontent.com/u/25203405?v=4","gravatar_id":"","url":"https://api.github.com/users/pberginkonsult","html_url":"https://github.com/pberginkonsult","followers_url":"https://api.github.com/users/pberginkonsult/followers","following_url":"https://api.github.com/users/pberginkonsult/following{/other_user}","gists_url":"https://api.github.com/users/pberginkonsult/gists{/gist_id}","starred_url":"https://api.github.com/users/pberginkonsult/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pberginkonsult/subscriptions","organizations_url":"https://api.github.com/users/pberginkonsult/orgs","repos_url":"https://api.github.com/users/pberginkonsult/repos","events_url":"https://api.github.com/users/pberginkonsult/events{/privacy}","received_events_url":"https://api.github.com/users/pberginkonsult/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2023-05-05T09:30:56Z","updated_at":"2023-09-20T00:01:20Z","closed_at":"2023-06-21T12:10:57Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When cross-compiling python3-cryptography v40.0.2 with Yocto it fails if you have different version of Python on your host and in the Yocto build. This is caused by `src/rust/build.rs` that is executing a python script to find the location of Python.h.\r\n\r\nReference: https://lists.openembedded.org/g/openembedded-core/topic/98667212 \r\n\r\n```\r\n|   running: \"x86_64-poky-linux-gcc\" \"-m64\" \"-march=core2\" \"-mtune=core2\" \"-msse3\" \"-mfpmath=sse\" \"-fstack-protector-strong\" \"-O2\" \"-D_FORTIFY_SOURCE=2\" \"-Wformat\" \"-Wformat-security\" \"-Werror=format-security\" \"--sysroot=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/recipe-sysroot\" \"-O2\" \"-pipe\" \"-g\" \"-feliminate-unused-debug-types\" \"-fmacro-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/cryptography-40.0.2=/usr/src/debug/python3-cryptography/40.0.2-r0\" \"-fdebug-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/cryptography-40.0.2=/usr/src/debug/python3-cryptography/40.0.2-r0\" \"-fmacro-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/build=/usr/src/debug/python3-cryptography/40.0.2-r0\" \"-fdebug-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/build=/usr/src/debug/python3-cryptography/40.0.2-r0\" \"-fdebug-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/recipe-sysroot=\" \"-fmacro-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/recipe-sysroot=\" \"-fdebug-prefix-map=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/recipe-sysroot-native=\" \"-I\" \"/usr/include/python3.11\" \"-I\" \"/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/recipe-sysroot/usr/include\" \"-Wconversion\" \"-Wno-error=sign-conversion\" \"-Wno-unused-parameter\" \"-DPy_LIMITED_API=0x030600f0\" \"-o\" \"/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/build/target/x86_64-poky-linux-gnu/release/build/cryptography-rust-aa00e39a952c07ee/out/9f543b84f9f4dceb-_openssl.o\" \"-c\" \"/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/build/target/x86_64-poky-linux-gnu/release/build/cryptography-rust-aa00e39a952c07ee/out/_openssl.c\"\r\n|   cargo:warning=/srv/build/ttorling/build-upgrades/tmp/work/core2-64-poky-linux/python3-cryptography/40.0.2-r0/build/target/x86_64-poky-linux-gnu/release/build/cryptography-rust-aa00e39a952c07ee/out/_openssl.c:57:10: fatal error: Python.h: No such file or directory\r\n|   cargo:warning=   57 | #include <Python.h>\r\n|   cargo:warning=      |          ^~~~~~~~~~\r\n|   cargo:warning=compilation terminated.\r\n|   exit status: 1\r\n```\r\n\r\nThe setup in Yocto is that you have one sysroot for the native tools used to build things for the target system and one sysroot for target with target files. In my particular setup with Ubuntu 22.04 I have python3.10 on my machine. Yocto's native tools have python3.11. When running https://github.com/pyca/cryptography/blob/f816b457494e010b655cd7fdcd30e3446f86a703/src/rust/build.rs#L46 the answer from Yocto will be `/usr/include/python3.11` that is then passed to the crooss-compilaton build and it fails to find Python.h. The weak part here is that the code is running python on in a native environment to figure out the include path for the cross-compilation.\r\n\r\nIn Yocto this can be solved and handled by using internal variable instead but raising this here if we could find a better upstream solution to avoid local patching in Yocto. Hopefully this can also be good for others that will cross-compile this project. Is it possible to use `pkg-config` or other way instead to find location of header files?\r\n","closed_by":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/8867/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/8867/timeline","performed_via_github_app":null,"state_reason":"completed"}