{"url":"https://api.github.com/repos/pyca/cryptography/issues/6404","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/6404/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/6404/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/6404/events","html_url":"https://github.com/pyca/cryptography/issues/6404","id":1022883334,"node_id":"I_kwDOALYunM489_YG","number":6404,"title":"OCSP: Value of Nonce extension should be encapsulated in OCTET STRING","user":{"login":"F30","id":2017238,"node_id":"MDQ6VXNlcjIwMTcyMzg=","avatar_url":"https://avatars.githubusercontent.com/u/2017238?v=4","gravatar_id":"","url":"https://api.github.com/users/F30","html_url":"https://github.com/F30","followers_url":"https://api.github.com/users/F30/followers","following_url":"https://api.github.com/users/F30/following{/other_user}","gists_url":"https://api.github.com/users/F30/gists{/gist_id}","starred_url":"https://api.github.com/users/F30/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/F30/subscriptions","organizations_url":"https://api.github.com/users/F30/orgs","repos_url":"https://api.github.com/users/F30/repos","events_url":"https://api.github.com/users/F30/events{/privacy}","received_events_url":"https://api.github.com/users/F30/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":78441570,"node_id":"MDU6TGFiZWw3ODQ0MTU3MA==","url":"https://api.github.com/repos/pyca/cryptography/labels/api%20design","name":"api design","color":"fad8c7","default":false,"description":null},{"id":198687536,"node_id":"MDU6TGFiZWwxOTg2ODc1MzY=","url":"https://api.github.com/repos/pyca/cryptography/labels/x509","name":"x509","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/pyca/cryptography/milestones/38","html_url":"https://github.com/pyca/cryptography/milestone/38","labels_url":"https://api.github.com/repos/pyca/cryptography/milestones/38/labels","id":7167569,"node_id":"MI_kwDOALYunM4AbV5R","number":38,"title":"Thirty Sixth Release","description":"","creator":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":24,"state":"closed","created_at":"2021-09-20T00:28:27Z","updated_at":"2021-12-23T04:20:31Z","due_on":null,"closed_at":"2021-11-21T21:43:02Z"},"comments":3,"created_at":"2021-10-11T16:03:13Z","updated_at":"2022-02-18T00:00:56Z","closed_at":"2021-11-19T22:32:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When using the Nonce extension for OCSP, the extension's value should be encapsulated in an additional `OCTET STRING`. That is not the case for OCSP requests generated using Cryptography with `OCSPNonce`. Presumably, the same applies for OCSP *responses* using the `OCSPNonce` extension.\r\n\r\nConsider code like the following:\r\n\r\n```\r\nbuilder = ocsp.OCSPRequestBuilder()\r\nbuilder = builder.add_certificate(cert, issuer, SHA256())\r\nnonce = x509.OCSPNonce(secrets.token_bytes(16))\r\nbuilder = builder.add_extension(nonce, False)\r\nreq = builder.build()\r\n```\r\n\r\nThe generated ASN.1 structure for the extension looks like this:\r\n\r\n```\r\n  0  29: SEQUENCE {\r\n  2   9:   OBJECT IDENTIFIER ocspNonce (1 3 6 1 5 5 7 48 1 2)\r\n 13  16:   OCTET STRING <16 random bytes>\r\n       :   }\r\n```\r\n\r\nWhereas when generating OCSP requests using the OpenSSL command line (`openssl ocsp -nonce`), the respective structure looks like this:\r\n\r\n```\r\n  0  31: SEQUENCE {\r\n  2   9:   OBJECT IDENTIFIER ocspNonce (1 3 6 1 5 5 7 48 1 2)\r\n 13  18:   OCTET STRING, encapsulates {\r\n 15  16:     OCTET STRING <16 random bytes>\r\n       :     }\r\n       :   }\r\n```\r\n\r\nThis at least leads to errors when dissecting the request using Wireshark (\"Malformed Packet\" or \"BER Error: OctetString expected but class:CONTEXT(2) Constructed tag:6 was unexpected\"). The OCSP server implementation I tested (EJBCA) appears to handle both variants fine, on the other hand.\r\n\r\n[Section 2.2 of RFC 6961](https://datatracker.ietf.org/doc/html/rfc6961#section-2.2) states that:\r\n\r\n> In the case of the \"id-pkix-ocsp-nonce\" OCSP extension, [RFC2560] is unclear about its encoding; for clarification, the nonce MUST be a DER-encoded OCTET STRING, which is encapsulated as another OCTET STRING (note that implementations based on an existing OCSP client will need to be checked for conformance to this requirement).  This has been clarified in [RFC6960].\r\n\r\nBut, for what it's worth, I cannot find such definite clarification in [RFC 6960](https://datatracker.ietf.org/doc/html/rfc6960).\r\n\r\nOther people [provide](http://webcache.googleusercontent.com/search?q=cache:https://ec.europa.eu/cefdigital/tracker/si/jira.issueviews:issue-html/DSS-1114/DSS-1114.html) the following reasoning for the same conclusion:\r\n\r\n> In an OCSP request, the nonce value must be doubly encoded as an OCTET STRING. Note the description of `Extension.extnValue` in [RFC 5280 section 4.1](https://tools.ietf.org/html/rfc5280#section-4.1): \"*contains the DER encoding of an ASN.1 value corresponding to the extension type identified by extnID*\". In the case of the Nonce extension, whose value also is of type OCTET STRING ([RFC 6960 section 4.4.1](https://tools.ietf.org/html/rfc6960#section-4.4.1)), this means that `extnValue` must be an OCTET STRING whose value is itself the DER encoding of an OCTET STRING.\r\n\r\nSo, I'm not certain if Cryptography's implementation is indisputably wrong, but the encapsulated variant seems far more common and better supported overall.\r\n\r\nFor the record, this was identified using Python 3.9.7 and Cryptography 35.0.0 on macOS.","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/6404/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/6404/timeline","performed_via_github_app":null,"state_reason":"completed"}