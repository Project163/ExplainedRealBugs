{"url":"https://api.github.com/repos/pyca/cryptography/issues/11878","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/11878/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/11878/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/11878/events","html_url":"https://github.com/pyca/cryptography/issues/11878","id":2630537120,"node_id":"I_kwDOALYunM6cys-g","number":11878,"title":"Serializing ECDSA key with too large private value causes to \"Unknown OpenSSL error\" (cryptography.exceptions.InternalError)","user":{"login":"hannob","id":990588,"node_id":"MDQ6VXNlcjk5MDU4OA==","avatar_url":"https://avatars.githubusercontent.com/u/990588?v=4","gravatar_id":"","url":"https://api.github.com/users/hannob","html_url":"https://github.com/hannob","followers_url":"https://api.github.com/users/hannob/followers","following_url":"https://api.github.com/users/hannob/following{/other_user}","gists_url":"https://api.github.com/users/hannob/gists{/gist_id}","starred_url":"https://api.github.com/users/hannob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hannob/subscriptions","organizations_url":"https://api.github.com/users/hannob/orgs","repos_url":"https://api.github.com/users/hannob/repos","events_url":"https://api.github.com/users/hannob/events{/privacy}","received_events_url":"https://api.github.com/users/hannob/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-11-02T15:40:54Z","updated_at":"2025-02-02T03:05:52Z","closed_at":"2024-11-03T14:33:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I noticed an odd behavior when accidentally creating an ECDSA key with a too large private key value.\r\n\r\nExample code:\r\n```\r\n#!/usr/bin/python3\r\nfrom cryptography.hazmat.primitives.asymmetric import ec\r\nfrom cryptography.hazmat.primitives import serialization\r\necval = 0xE2563328DFABF68188606B91324281C1D58A4456431B09D510B35FECC9F307CA1822846FA2671371A9A81BAC0E35749D\r\nkey = ec.derive_private_key(ecval, ec.SECP256R1())\r\npem = key.private_bytes(encoding=serialization.Encoding.PEM, format=serialization.PrivateFormat.TraditionalOpenSSL, encryption_algorithm=serialization.NoEncryption())\r\nprint(pem)\r\n```\r\n\r\nThis creates an ECDSA key with curve secp256r1, but the private key value is not 32 byte (as secp256r1 would expect), but 48 bytes (it comes from a secp384r1 key). It is expected that this code will fail, but there are 2 things unusual:\r\n* It does not fail on derive_private_key() (maybe it should), but only after trying to export the key\r\n* It fails with an error message indicating an internal OpenSSL error, indicating I should report a bug (which I hereby do). It should probably fail with a more helpful error message and a different exception type.\r\n\r\nThe error I get is:\r\n```\r\ncryptography.exceptions.InternalError: Unknown OpenSSL error. This error is commonly encountered\r\n                        when another library is not cleaning up the OpenSSL error\r\n                        stack. If you are using cryptography with another library\r\n                        that uses OpenSSL try disabling it before reporting a bug.\r\n                        Otherwise please file an issue at\r\n                        https://github.com/pyca/cryptography/issues with\r\n                        information on how to reproduce this. ([<OpenSSLError(code=134217828, lib=16, reason=100, reason_text=buffer too small)>, <OpenSSLError(code=134742032, lib=16, reason=524304, reason_text=EC lib)>, <OpenSSLError(code=76021773, lib=9, reason=524301, reason_text=ASN1 lib)>])\r\n```","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/11878/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/11878/timeline","performed_via_github_app":null,"state_reason":"completed"}