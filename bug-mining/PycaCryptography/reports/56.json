{"url":"https://api.github.com/repos/pyca/cryptography/issues/5998","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/5998/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/5998/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/5998/events","html_url":"https://github.com/pyca/cryptography/issues/5998","id":865644598,"node_id":"MDU6SXNzdWU4NjU2NDQ1OTg=","number":5998,"title":"openssl aes \"xts duplicated keys\" error is reported as \"Unknown OpenSSL Error\"","user":{"login":"projectgus","id":205573,"node_id":"MDQ6VXNlcjIwNTU3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/205573?v=4","gravatar_id":"","url":"https://api.github.com/users/projectgus","html_url":"https://github.com/projectgus","followers_url":"https://api.github.com/users/projectgus/followers","following_url":"https://api.github.com/users/projectgus/following{/other_user}","gists_url":"https://api.github.com/users/projectgus/gists{/gist_id}","starred_url":"https://api.github.com/users/projectgus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/projectgus/subscriptions","organizations_url":"https://api.github.com/users/projectgus/orgs","repos_url":"https://api.github.com/users/projectgus/repos","events_url":"https://api.github.com/users/projectgus/events{/privacy}","received_events_url":"https://api.github.com/users/projectgus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-04-23T01:06:03Z","updated_at":"2021-09-08T00:00:52Z","closed_at":"2021-06-09T11:41:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Recent versions of openssl [explicitly reject duplicated AES-XTS keys](https://github.com/openssl/openssl/blob/c39352/crypto/evp/e_aes.c#L3119). Cryptography openssl backend reports this as an Unknown OpenSSL Error.\r\n\r\n* Versions of Python, ``cryptography``, ``cffi``, ``pip``, and ``setuptools``\r\n  you're using\r\n  * Python 3.8.5\r\n  * cryptopraphy main branch (f08a7de65)\r\n  * cffi==1.14.5\r\n  * pip 21.0.1\r\n* How you installed ``cryptography``\r\n  * pip install -e .\r\n* Clear steps for reproducing your bug\r\n\r\n```\r\n>>> from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes\r\n>>> from cryptography.hazmat.backends import default_backend\r\n>>> badkey = b'\\xEE'*32\r\n>>> cipher = Cipher(algorithms.AES(badkey), modes.XTS(b'\\x00'*16), backend=default_backend())\r\n>>> cipher.encryptor().update(b'\\x00'*16)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/angus/tmp/cryptography/src/cryptography/hazmat/primitives/ciphers/base.py\", line 109, in encryptor\r\n    ctx = self._backend.create_symmetric_encryption_ctx(\r\n  File \"/home/angus/tmp/cryptography/src/cryptography/hazmat/backends/openssl/backend.py\", line 460, in create_symmetric_encryption_ctx\r\n    return _CipherContext(self, cipher, mode, _CipherContext._ENCRYPT)\r\n  File \"/home/angus/tmp/cryptography/src/cryptography/hazmat/backends/openssl/ciphers.py\", line 115, in __init__\r\n    self._backend.openssl_assert(res != 0)\r\n  File \"/home/angus/tmp/cryptography/src/cryptography/hazmat/backends/openssl/backend.py\", line 210, in openssl_assert\r\n    return binding._openssl_assert(self._lib, ok, errors=errors)\r\n  File \"/home/angus/tmp/cryptography/src/cryptography/hazmat/bindings/openssl/binding.py\", line 80, in _openssl_assert\r\n    raise InternalError(\r\ncryptography.exceptions.InternalError: Unknown OpenSSL error. This error is commonly encountered when another library is not cleaning up the OpenSSL error stack. If you are using cryptography with another library that uses OpenSSL try disabling it before reporting a bug. Otherwise please file an issue at https://github.com/pyca/cryptography/issues with information on how to reproduce this. ([_OpenSSLErrorWithText(code=101511351, lib=6, func=207, reason=183, reason_text=b'error:060CF0B7:digital envelope routines:aesni_xts_init_key:xts duplicated keys')])\r\n```\r\n\r\nWe can probably submit a patch to convert this into a more user-friendly error. If that sounds good, I was wondering how you prefer to do this. For example a couple of ideas:\r\n\r\n1. Python-side check that throws something like a ValueError when parsing the key+mode. (This makes the assumption that cryptography is OK to always reject vulnerable duplicate keys regardless of what the backend does, so I wanted to check that's OK and not going to break anything.)\r\n2. Check the openssl error in hazmat/backends/openssl/ciphers.py and raise something specific there based on `EVP_R_XTS_DUPLICATED_KEYS` error.\r\n\r\nContext: This was submitted by one of our users https://github.com/espressif/esptool/issues/621\r\n\r\nThanks very much for all the great work on this library, we really appreciate being able to rely on it!","closed_by":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/5998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/5998/timeline","performed_via_github_app":null,"state_reason":"completed"}