{"url":"https://api.github.com/repos/pyca/cryptography/issues/5872","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/5872/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/5872/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/5872/events","html_url":"https://github.com/pyca/cryptography/issues/5872","id":817991268,"node_id":"MDU6SXNzdWU4MTc5OTEyNjg=","number":5872,"title":"PKCS#12 ordering is reversed","user":{"login":"davidben","id":109690,"node_id":"MDQ6VXNlcjEwOTY5MA==","avatar_url":"https://avatars.githubusercontent.com/u/109690?v=4","gravatar_id":"","url":"https://api.github.com/users/davidben","html_url":"https://github.com/davidben","followers_url":"https://api.github.com/users/davidben/followers","following_url":"https://api.github.com/users/davidben/following{/other_user}","gists_url":"https://api.github.com/users/davidben/gists{/gist_id}","starred_url":"https://api.github.com/users/davidben/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidben/subscriptions","organizations_url":"https://api.github.com/users/davidben/orgs","repos_url":"https://api.github.com/users/davidben/repos","events_url":"https://api.github.com/users/davidben/events{/privacy}","received_events_url":"https://api.github.com/users/davidben/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":83603179,"node_id":"MDU6TGFiZWw4MzYwMzE3OQ==","url":"https://api.github.com/repos/pyca/cryptography/labels/bugs","name":"bugs","color":"e11d21","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/pyca/cryptography/milestones/37","html_url":"https://github.com/pyca/cryptography/milestone/37","labels_url":"https://api.github.com/repos/pyca/cryptography/milestones/37/labels","id":6240794,"node_id":"MDk6TWlsZXN0b25lNjI0MDc5NA==","number":37,"title":"Thirty Fifth Release","description":"","creator":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":26,"state":"closed","created_at":"2020-12-23T14:42:59Z","updated_at":"2021-09-30T02:44:54Z","due_on":null,"closed_at":"2021-09-30T02:44:54Z"},"comments":0,"created_at":"2021-02-27T18:39:37Z","updated_at":"2021-05-30T00:12:44Z","closed_at":"2021-02-28T22:06:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Although the PKCS#12 APIs in cryptography.io are consistent with each other, they're reversed from what's actually in the file. This logic reverses the order into `PKCS12_create`.\r\nhttps://github.com/pyca/cryptography/blob/5511445e95a16fa12b464d57ace4bb17855fe844/src/cryptography/hazmat/backends/openssl/backend.py#L2565-L2569\r\n\r\nI imagine this was done because you all noticed that `PKCS12_create` and `PKCS12_parse` are reversed from each other. But the bug was actually in `PKCS12_parse`, so the workaround was applied to the wrong one. As a result they're now both reversed in the bindings. See https://github.com/openssl/openssl/issues/6698.\r\n\r\n* Versions of Python, ``cryptography``, ``cffi``, ``pip``, and ``setuptools``\r\n  you're using: Python 3.7.3; cryptography 3.4.6; cffi 1.14.5; pip 18.1; setuptools 40.8.0\r\n* How you installed ``cryptography``: `pip install cryptography` in a `python3 -m venv`.\r\n* Clear steps for reproducing your bug: run this script.\r\n\r\n```\r\nfrom cryptography import x509\r\nfrom cryptography.hazmat.primitives import hashes, serialization\r\nfrom cryptography.hazmat.primitives.asymmetric import ec\r\nfrom cryptography.hazmat.primitives.serialization import pkcs12\r\nfrom cryptography.x509.oid import NameOID\r\nfrom datetime import datetime\r\n\r\ndef make_cert(name):\r\n    key = ec.generate_private_key(ec.SECP256R1)\r\n    subject = x509.Name([\r\n        x509.NameAttribute(NameOID.COMMON_NAME, name),\r\n    ])\r\n    now = datetime.utcnow()\r\n    cert = x509.CertificateBuilder().subject_name(\r\n        subject\r\n    ).issuer_name(\r\n        subject\r\n    ).public_key(\r\n        key.public_key()\r\n    ).serial_number(\r\n        x509.random_serial_number()\r\n    ).not_valid_before(\r\n        now\r\n    ).not_valid_after(\r\n        now\r\n    ).sign(key, hashes.SHA256())\r\n    return (key, cert)\r\n\r\n# Make some certificates with distinct names.\r\na_name = \"A\" * 20\r\nb_name = \"B\" * 20\r\nc_name = \"C\" * 20\r\na_key, a_cert = make_cert(a_name)\r\n_, b_cert = make_cert(b_name)\r\n_, c_cert = make_cert(c_name)\r\n\r\n# Bundle them in a PKCS#12 file in order A, B, C.\r\np12 = pkcs12.serialize_key_and_certificates(\r\n    b\"p12\", a_key, a_cert, [b_cert, c_cert], \r\n    serialization.NoEncryption())\r\n\r\n# Parse them out. The API should report them in the same order.\r\n(key, cert, certs) = pkcs12.load_key_and_certificates(p12, None)\r\nassert cert == a_cert\r\nassert certs == [b_cert, c_cert]\r\n\r\n# The ordering in the PKCS#12 file itself should also match.\r\na_idx = p12.find(a_name.encode(\"utf-8\"))\r\nb_idx = p12.find(b_name.encode(\"utf-8\"))\r\nc_idx = p12.find(c_name.encode(\"utf-8\"))\r\nassert a_idx >= 0\r\nassert b_idx >= 0\r\nassert c_idx >= 0\r\n\r\nprint(f\"{a_idx} {b_idx} {c_idx}\")\r\nassert a_idx < b_idx < c_idx  # This assertion trips.\r\n```","closed_by":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/5872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/5872/timeline","performed_via_github_app":null,"state_reason":"completed"}