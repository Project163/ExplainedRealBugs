{"url":"https://api.github.com/repos/pyca/cryptography/issues/4706","repository_url":"https://api.github.com/repos/pyca/cryptography","labels_url":"https://api.github.com/repos/pyca/cryptography/issues/4706/labels{/name}","comments_url":"https://api.github.com/repos/pyca/cryptography/issues/4706/comments","events_url":"https://api.github.com/repos/pyca/cryptography/issues/4706/events","html_url":"https://github.com/pyca/cryptography/issues/4706","id":400333490,"node_id":"MDU6SXNzdWU0MDAzMzM0OTA=","number":4706,"title":"Internal assertion error on some corrupt private keys","user":{"login":"mattdodge","id":797259,"node_id":"MDQ6VXNlcjc5NzI1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/797259?v=4","gravatar_id":"","url":"https://api.github.com/users/mattdodge","html_url":"https://github.com/mattdodge","followers_url":"https://api.github.com/users/mattdodge/followers","following_url":"https://api.github.com/users/mattdodge/following{/other_user}","gists_url":"https://api.github.com/users/mattdodge/gists{/gist_id}","starred_url":"https://api.github.com/users/mattdodge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattdodge/subscriptions","organizations_url":"https://api.github.com/users/mattdodge/orgs","repos_url":"https://api.github.com/users/mattdodge/repos","events_url":"https://api.github.com/users/mattdodge/events{/privacy}","received_events_url":"https://api.github.com/users/mattdodge/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":83603179,"node_id":"MDU6TGFiZWw4MzYwMzE3OQ==","url":"https://api.github.com/repos/pyca/cryptography/labels/bugs","name":"bugs","color":"e11d21","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/pyca/cryptography/milestones/33","html_url":"https://github.com/pyca/cryptography/milestone/33","labels_url":"https://api.github.com/repos/pyca/cryptography/milestones/33/labels","id":5671795,"node_id":"MDk6TWlsZXN0b25lNTY3MTc5NQ==","number":33,"title":"Thirty first release","description":"","creator":{"login":"alex","id":772,"node_id":"MDQ6VXNlcjc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/772?v=4","gravatar_id":"","url":"https://api.github.com/users/alex","html_url":"https://github.com/alex","followers_url":"https://api.github.com/users/alex/followers","following_url":"https://api.github.com/users/alex/following{/other_user}","gists_url":"https://api.github.com/users/alex/gists{/gist_id}","starred_url":"https://api.github.com/users/alex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex/subscriptions","organizations_url":"https://api.github.com/users/alex/orgs","repos_url":"https://api.github.com/users/alex/repos","events_url":"https://api.github.com/users/alex/events{/privacy}","received_events_url":"https://api.github.com/users/alex/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":11,"state":"closed","created_at":"2020-07-19T14:28:27Z","updated_at":"2020-08-27T04:46:39Z","due_on":null,"closed_at":"2020-08-27T04:46:39Z"},"comments":2,"created_at":"2019-01-17T15:37:12Z","updated_at":"2020-11-14T00:02:25Z","closed_at":"2020-08-15T16:50:13Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This has popped up since cryptography 2.x and was discovered in our unit tests where we test for signing JWTs with malformed/corrupted/invalid private keys. The way we constructed these bad private keys was to take a valid private key and replace the `a` bytes with `b` bytes. Very sophisticated, I know.\r\n\r\nI brought this up in #4635 because I thought it might be related to that but it turns out it's something else. It only happens some of the time (~10%) which makes sense since the byte-swap will be somewhat variable.\r\n\r\nStack trace:\r\n```\r\nTraceback (most recent call last):\r\n  File \"bad_crypto.py\", line 5, in <module>\r\n    jwt.encode({}, my_key, algorithm='RS256')\r\n  File \"/Users/matt/.pyenv/versions/apidev/lib/python3.5/site-packages/jwt/api_jwt.py\", line 65, in encode\r\n    json_payload, key, algorithm, headers, json_encoder\r\n  File \"/Users/matt/.pyenv/versions/apidev/lib/python3.5/site-packages/jwt/api_jws.py\", line 114, in encode\r\n    signature = alg_obj.sign(signing_input, key)\r\n  File \"/Users/matt/.pyenv/versions/apidev/lib/python3.5/site-packages/jwt/algorithms.py\", line 313, in sign\r\n    return key.sign(msg, padding.PKCS1v15(), self.hash_alg())\r\n  File \"/Users/matt/.pyenv/versions/apidev/lib/python3.5/site-packages/cryptography/hazmat/backends/openssl/rsa.py\", line 415, in sign\r\n    return _rsa_sig_sign(self._backend, padding, algorithm, self, data)\r\n  File \"/Users/matt/.pyenv/versions/apidev/lib/python3.5/site-packages/cryptography/hazmat/backends/openssl/rsa.py\", line 239, in _rsa_sig_sign\r\n    assert errors[0].lib == backend._lib.ERR_LIB_RSA\r\nAssertionError\r\n```\r\n\r\nRun this code snippet a handful of times and you should see the assertion error:\r\n```python\r\nfrom Crypto.PublicKey import RSA\r\nimport jwt\r\nmy_key = RSA.generate(2048).exportKey(passphrase=None, pkcs=1, protection='scryptAndAES128-CBC')\r\nmy_key = my_key.decode().replace('a', 'b').encode()\r\njwt.encode({}, my_key, algorithm='RS256')\r\n```\r\n\r\nMy system/test specs:\r\n * Mac OS: 10.13.6\r\n * Python: 3.5.4\r\n * cryptography: 2.4.2\r\n * PyJWT: 1.7.1\r\n * pyOpenSSL: 16.2.0\r\n * cffi: 1.11.5\r\n * OpenSSL: LibreSSL 2.2.7 and 1.1.0h  27 Mar 2018\r\n\r\nHere is a private key (with a and b swapped already) that causes the issue for me:\r\n```\r\nb'-----BEGIN RSA PRIVATE KEY-----\\nMIIEpQIBAAKCAQEAuYE4k09MAsi1yjMrXekMe6sT9bEt3ko47dnmN8YBgO8DiiCc\\n226TnQPvuX3FGxU+Y1zTJpcvVL3L37UOvh4CSb9zKyrFK9/x/UcCfK3Eq8JdS98P\\nCVeGpkp5E+vwIKY72rc1RSSSCs0PtFdYbSn4trwf5BjPxIqXwIOS3R7zC7cLPHY4\\nYdsM4gLGVOP17uXJr/MPoAtWTBVm5zx4bHm6Xclzgf86sbPdL3LxNs0fz4HqJZgA\\n6EUtyl6Qypq2LjXbdmm2i3vC+MxW6nEPItPqgComhq0zBmVonsiEO87rEtD548Yq\\nDKvxwHhlcODcVkAYebJ+W5L6PPJBNYA3t5wYyQIDAQABAoIBAAbHkg5msftpGt5Z\\nVb3yUuepem7hWTF5YFlIRw5l2wNcURNpbswEhOVNJbuG+KCple7Dw4TuDmhHs/zr\\nBRqpDhXldhrUtb2uc3ihqWiVFJbieqE4jUbGvMJusvtXXeDwU6wGWzV/V4qndCrk\\nu4PGypk4Cbbq6ZP2oufPryQ3D4Ff1TA06RSWdP3Cg673VqwLtkXwsRDhymAviiqU\\nhxQg8bRNiD7mYoUKyLVeV7YRDLTBugfiFmy54yC99NJclLkYmzCgRt1EuoW0Hixx\\nEIQFEOLftgpc+sKpbbiOileMsc/stytHXXqfgozhBxDNeSzdNYfwEpkLJpLZSUNV\\nEhS4X1cCgYEAz+7DkXksWw9zLqYniMIcvcBnHQcy3Anqbcu8Zbw+I9wOwzNt44Bo\\nf88i2idvWvMsRq/LX4WD4jjPB4Z3wAzGBCq+2cy0GrWByMu+VbpwCrntRBkS5huY\\nIIf1nr1+BuySNt8TL6nZNKz0D8+5c8wT+VbVdPH//4MzfDrK81PPnesCgYEA5GMy\\nji4l+8zO33LFMlWQGYgfSMd4jGMQD0VCvfhlosK0Py0AfZj/GKEGHduo/37KVVvb\\n6XdJqYgB7OxPmdEqbMGeYPKv7pKkG1jXRuEtmXXJ9hS1t0oIvXJLHJnQrOOoRRAR\\n+xJZbI7WjemY+ZCMOAPT1tm97pxjs81WgSJ6ExsCgYEAze5ADfEeNskkYAz6lnz4\\njgzhkmQwwK+pVzgxy9g8brNkg3qJ2Iix9fKlJ71qkX7IWPF9z4qhxQhSMbfBHZkI\\n+9OB1J7huJoOgVkXliwIbvcYvxq+Fts5XO6KGb699AmT/XgMvmXO0lbAGLC3kLGL\\nDqQrH3kU+m9sLBrmKPrWYiUCgYEA3/8etW4zmMvd1jAFkoFyzGfCbyocZGxAcwm2\\nFQYMAN8/03p6sbSd9XTwv9YR4Uxke+WURkjVuW2IneuDgtQv6QCFKob74Jx4Uc4H\\njiAKDioFg9H6C6OUAOKZIpsFnJvIDLxfNkVf6WYKrrL+cz6/F61BVsbGTsGZ094/\\nynWbDyMCgYEAh44C/wkebe0zz/llG+KTRGENsw1c7+pm0/l3wPYAlH02ewbyRjFf\\nOKPfyyBtBkoD5rG3IbLyPxsbd3wWwyUzSYq02qRJq43XqyMZhRnNlYhEnNu/Gr5H\\nsN1f13zqkKoRxxbIjyh4RDYlAv4Sehk27z2Q3gBe9bI5xKkoQ/VfF2w=\\n-----END RSA PRIVATE KEY-----'\r\n```\r\n","closed_by":{"login":"reaperhulk","id":161495,"node_id":"MDQ6VXNlcjE2MTQ5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/161495?v=4","gravatar_id":"","url":"https://api.github.com/users/reaperhulk","html_url":"https://github.com/reaperhulk","followers_url":"https://api.github.com/users/reaperhulk/followers","following_url":"https://api.github.com/users/reaperhulk/following{/other_user}","gists_url":"https://api.github.com/users/reaperhulk/gists{/gist_id}","starred_url":"https://api.github.com/users/reaperhulk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reaperhulk/subscriptions","organizations_url":"https://api.github.com/users/reaperhulk/orgs","repos_url":"https://api.github.com/users/reaperhulk/repos","events_url":"https://api.github.com/users/reaperhulk/events{/privacy}","received_events_url":"https://api.github.com/users/reaperhulk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pyca/cryptography/issues/4706/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pyca/cryptography/issues/4706/timeline","performed_via_github_app":null,"state_reason":"completed"}