<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:15:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OWB-523] @SessionScoped bean failover does not work</title>
                <link>https://issues.apache.org/jira/browse/OWB-523</link>
                <project id="12310844" key="OWB">OpenWebBeans</project>
                    <description>&lt;p&gt;OWB failover for @SessionScoped beans does not work.&lt;/p&gt;

&lt;p&gt;A detailed description and a sample project can be found here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/magro/msm-sample-webapp/tree/openwebbeans&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/magro/msm-sample-webapp/tree/openwebbeans&lt;/a&gt;&lt;/p&gt;</description>
                <environment>MyFaces 2.0.3, OWB 1.0.0, Tomcat 7.0.8, memcached-session-manager</environment>
        <key id="12499200">OWB-523</key>
            <summary>@SessionScoped bean failover does not work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bergmark">Joseph E Bergmark</assignee>
                                    <reporter username="tandraschko">Thomas Andraschko</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Feb 2011 08:56:48 +0000</created>
                <updated>Sun, 15 May 2011 16:35:01 +0000</updated>
                            <resolved>Mon, 21 Mar 2011 19:21:35 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12997413" author="gerdogdu" created="Mon, 21 Feb 2011 14:08:40 +0000"  >&lt;p&gt;Ying has more experience on this from me because he wrote the failover logic &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12997453" author="martin.grotzke" created="Mon, 21 Feb 2011 15:49:31 +0000"  >&lt;p&gt;One additional hint: this sample works with Weld, which indicates that it&apos;s not an issue with memcached-session-manager.&lt;/p&gt;

&lt;p&gt;When inspecting the serialized/deserialized session during passivation/activation I can see there&apos;s the session attribute &quot;org.apache.webbeans.web.failover&quot; with the FailOverBagWrapper.&lt;/p&gt;

&lt;p&gt;AFAICS this session attribute is only accessed from DefaultOwbFailOverService.sessionIsIdle, but there&apos;s no invocation of DefaultOwbFailOverService.sessionWillPassivate, as StandardSession.passivate does not find a session attribute that implements HttpSessionActivationListener. Perhaps this helps.&lt;/p&gt;</comment>
                            <comment id="12997575" author="bergmark" created="Mon, 21 Feb 2011 21:25:19 +0000"  >&lt;p&gt;I think I see why this is not working.  WebBeansConfigurationListener implements HttpSessionActivationListener, but it is never set as an attribute into the session to receive those callbacks.&lt;/p&gt;

&lt;p&gt;I wonder if it might make sense to remove that interface from WebBeansConfigurationListener, add it to the FailOverBagWrapper and let the FailOverBagWrapper take care of calling into the FailOverService.  I may take a shot at this if Ying doesn&apos;t have a chance.&lt;/p&gt;</comment>
                            <comment id="12997597" author="bergmark" created="Mon, 21 Feb 2011 23:08:09 +0000"  >&lt;p&gt;I get the following exception when I try and start the server as described in the README.markdown:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.ClassNotFoundException: java.util.SubList&lt;br/&gt;
	at java.lang.Class.forName(Class.java:136)&lt;br/&gt;
	at de.javakaffee.kryoserializers.SubListSerializer.getClass(SubListSerializer.java:59&lt;/p&gt;

&lt;p&gt;Not sure what I am missing here.  I don&apos;t see this class in the javadoc.&lt;/p&gt;</comment>
                            <comment id="12997601" author="martin.grotzke" created="Mon, 21 Feb 2011 23:18:00 +0000"  >&lt;p&gt;Do you use the branch openwebbeans?&lt;/p&gt;</comment>
                            <comment id="12997603" author="martin.grotzke" created="Mon, 21 Feb 2011 23:23:22 +0000"  >&lt;p&gt;Regarding WebBeansConfigurationListener and FailOverBagWrapper: sounds reasonable what you propose. But I still wonder, why it&apos;s only failing when tomcat is restarted and not with the running tomcat. When msm is configured using non-sticky sessions sessions are swapped out at the end of each request, so from the container/session point of view there&apos;s no difference. So it seems as if anything else would keep state.&lt;/p&gt;</comment>
                            <comment id="12998302" author="struberg" created="Wed, 23 Feb 2011 10:45:07 +0000"  >&lt;p&gt;looking at the code it seems that it needs cleanup anyway.&lt;br/&gt;
Currently removing a few suspect catch(Throwable)...&lt;/p&gt;</comment>
                            <comment id="13002267" author="bergmark" created="Thu, 3 Mar 2011 21:59:49 +0000"  >&lt;p&gt;I made the changes I mentioned previously, but I&apos;m not sure how to repackage your war module to pick them up and test them.  I tried changing the pom.xml to use &lt;/p&gt;

&lt;p&gt;&amp;lt;version&amp;gt;1.1.0-SNAPSHOT&amp;lt;/version&lt;/p&gt;

&lt;p&gt;for the open web beans files, but when I re-run &quot;mvn package&quot;, I can navigate into the tomcat directory and see the 1.0.0 version of those jars still there.  Am I missing a step in how the war gets built and deployed?&lt;/p&gt;</comment>
                            <comment id="13002279" author="bergmark" created="Thu, 3 Mar 2011 22:20:52 +0000"  >&lt;p&gt;I worked around the above issue by manually copying the war file into runtime/apache-tomcat-7.0.8/webapps/ROOT.war from the target directory.&lt;/p&gt;

&lt;p&gt;Still appears to be failing. I don&apos;t see the first field saved when I go from 8081 to 8082.  Is there any debug I can turn on in tomcat or memcached to see what attributes it thinks are HttpSessionActivationListeners?&lt;/p&gt;</comment>
                            <comment id="13002288" author="martin.grotzke" created="Thu, 3 Mar 2011 22:39:00 +0000"  >&lt;p&gt;Regarding the relationship of the package and the deployed war file in tomcat: runtime/tomcat/webapps/ROOT.war is a symbolic link to target/msm-sample-webapp-1.0-SNAPSHOT.war (runtime/tomcat is a link to runtime/apache-tomcat-7.0.8). If you want to get a fresh war file deployed just `rm -rf runtime/tomcat/webapps/ROOT/` so that the war file is unpacked/deployed when tomcat is restarted.&lt;/p&gt;

&lt;p&gt;Concerning the debugging: you can start tomcat with the jpda option like this:&lt;br/&gt;
./runtime/tomcat1/bin/catalina.sh jpda run&lt;/p&gt;

&lt;p&gt;This opens a debugging socket on port 8000 so that you can attach and debug using your IDE (i.e. in eclipse it&apos;s under Debug &amp;gt; &quot;Remote Java Application&quot;). With this and the memcached-session-manager sources at hand (git clone git://github.com/magro/memcached-session-manager.git; cd memcached-session-manager; buildr eclipse) you can set a breakpoint in JavaSerializationTranscoder.writeAttributes to inspect serialized attributes (to see deserialized attributes you can check MemcachedBackupSessionManager.loadFromMemcached).&lt;/p&gt;</comment>
                            <comment id="13003706" author="martin.grotzke" created="Mon, 7 Mar 2011 23:57:16 +0000"  >&lt;p&gt;I also just updated owb version in pom.xml to 1.1.0-SNAPSHOT (SNAPSHOT just installed from trunk at r1079022). After&lt;br/&gt;
$ mvn clean package&lt;br/&gt;
$ rm -rf runtime/tomcat1/webapps/ROOT&lt;br/&gt;
$ runtime/tomcat1/bin/catalina.sh run&lt;br/&gt;
I&apos;m getting the following exception when submitting /test.xhtml in the browser:&lt;/p&gt;

&lt;p&gt;Mar 8, 2011 12:56:34 AM de.javakaffee.web.msm.JavaSerializationTranscoder writeAttributes&lt;br/&gt;
WARNING: Cannot serialize session attribute org.apache.webbeans.web.failover for session 4442ACE9E9BBA6A1A80D718CC599C58E-n2&lt;br/&gt;
java.io.NotSerializableException: org.apache.webbeans.config.WebBeansContext&lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1164)&lt;br/&gt;
        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1518)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1483)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1400)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1158)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:330)&lt;br/&gt;
        at org.apache.webbeans.web.failover.FailOverBagWrapper.writeExternal(FailOverBagWrapper.java:139)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeExternalData(ObjectOutputStream.java:1429)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1398)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1158)&lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:330)&lt;br/&gt;
        at de.javakaffee.web.msm.JavaSerializationTranscoder.writeAttributes(JavaSerializationTranscoder.java:143)&lt;/p&gt;</comment>
                            <comment id="13003790" author="bergmark" created="Tue, 8 Mar 2011 02:42:16 +0000"  >&lt;p&gt;I didn&apos;t committ in any of my changes, as they did not appear to resolve the problem.  I did however fix the serialization error you posted above in my workspace along with those changes.&lt;/p&gt;

&lt;p&gt;I still need to do more debugging, but it appears that the sessionWillActivation and sessionDidPassivate (which I moved into FailOverBagWrapper) are not being called, even though it is now a HttpSessionActivationListener, and as your exception shows it is being set as a session attribute.&lt;/p&gt;</comment>
                            <comment id="13003856" author="martin.grotzke" created="Tue, 8 Mar 2011 08:29:25 +0000"  >&lt;p&gt;I just let FailOverBagWrapper implement HSAL and after a clean install/package for both owb and the sample (and `rm -rf runtime/tomcat1/webapps/ROOT/`) I see that in session.passivate the FailOverBagWrapper.sessionWillPassivate is invoked.&lt;br/&gt;
It sounds as if your environment/setup is somehow broken. Did you also an runtime/tomcat1/webapps/ROOT/ after rebuilding the msm-sample-webapp? Alternatively you can copy the relevant jars to runtime/tomcat1/webapps/ROOT/WEB-INF/lib...&lt;/p&gt;</comment>
                            <comment id="13004171" author="bergmark" created="Tue, 8 Mar 2011 20:00:36 +0000"  >&lt;p&gt;I&apos;m making it a bit further now.  I&apos;ve added some additional debug and I do see sessionWillActivate and sessionDidPassivate being called.  I also see the code make it ways down into FailOverBag.restore(), so the SessionContext in the SessionManager should be getting updated.  However I still don&apos;t see the test application&apos;s @SessionScoped bean getting propagated.&lt;/p&gt;

&lt;p&gt;I&apos;m going to try connecting with a remote debugger to try and identify what might be going wrong in the SessionContext.  I&apos;m guessing the entries in it either aren&apos;t being serialized properly, or somehow the Contextuals don&apos;t match so we don&apos;t match the existing bean in the map.&lt;/p&gt;</comment>
                            <comment id="13004186" author="bergmark" created="Tue, 8 Mar 2011 20:28:47 +0000"  >&lt;p&gt;Ok, I believe this is working now.  I was hitting an exception in the FailOverBag&apos;s restore method that was getting silently eaten by an empty catch block.  I&apos;ve modified the restore method to look up the WebBeansContext again as that field needs to be trasient.&lt;/p&gt;

&lt;p&gt;If you have a chance, please rebuild webbeans-web from trunk and see if it works for you as well.&lt;/p&gt;</comment>
                            <comment id="13004513" author="martin.grotzke" created="Wed, 9 Mar 2011 12:34:26 +0000"  >&lt;p&gt;Looks good, now the form is populated with the data from the session user.&lt;/p&gt;

&lt;p&gt;The only thing that makes me wonder is that during &quot;normal&quot; operation (tomcat is running, session is swapped out at end of request and swapped in at the start of the request), the same instance of the SessionUser is used, so there&apos;s no &quot;????? create SessionUser&quot; logged.&lt;br/&gt;
When I restart tomcat, &quot;????? create SessionUser&quot; is printed to stdout, so this indicates that a new instance of the @SessionScoped bean is created. Without knowing more about this I&apos;d assume that this should not happen.&lt;/p&gt;

&lt;p&gt;A minor thing I saw in FailOverBagWrapper is that you probably want to change one line:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (failoverService != null &amp;amp;&amp;amp; failoverService.isSupportFailOver() || failoverService.isSupportPassivation())&lt;br/&gt;
+        if (failoverService != null &amp;amp;&amp;amp; (failoverService.isSupportFailOver() || failoverService.isSupportPassivation()))&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13004516" author="struberg" created="Wed, 9 Mar 2011 12:47:40 +0000"  >&lt;p&gt;This depends on how you use memcached. &lt;br/&gt;
If you swap/read back on each request, then it should create a new User. But if it only serializes for safety, and on deserialisation first just checks the hash code (in case something got changed on another node) then the existing instance will get used again (basically the session activation will not be performed).&lt;/p&gt;</comment>
                            <comment id="13004536" author="bergmark" created="Wed, 9 Mar 2011 13:21:01 +0000"  >&lt;p&gt;Thanks for catching my typo with the null check, I&quot;ll fix that today.&lt;/p&gt;

&lt;p&gt;As far as the same instance of SessionUser being used during &quot;normal&quot; operation.  This might be due to the internal map that OWB has of SessionContexts.  We are going to find the SessionContext in that map in the SessionManager if the server hasn&apos;t been stopped or that Session hasn&apos;t been destroyed. (callback to HttpSessionListener sessionDestroyed).  &lt;/p&gt;

&lt;p&gt;In the case of restarting tomcat, the map is going to be empty, so presumably we are deserializing the @SessionScoped bean to restore the data.&lt;/p&gt;

&lt;p&gt;Do you see the value restored after tomcat is restarted?&lt;/p&gt;</comment>
                            <comment id="13004570" author="martin.grotzke" created="Wed, 9 Mar 2011 14:31:18 +0000"  >&lt;p&gt;The msm-sample-webapp in openwebbeans branch is defaultet to non-sticky sessions - so sessions are swapped out / in for each request. This can be changed in runtime/tomcat1/conf/context.xml (sticky=&quot;true|false&quot;) or by just using `./switch-stickyness.sh sticky|nonsticky`.&lt;/p&gt;

&lt;p&gt;Regarding the map of SessionContexts: when (nonsticky) sessions are only &quot;deregistered&quot; via &quot;sessionWillPassivate&quot; OWB will never get some sessionDestroyed event. This sounds as this would be a session/memory leak with nonsticky sessions.&lt;/p&gt;

&lt;p&gt;The following two paragraphs from the servlet spec 2.4 IMHO say that you can&apos;t rely on session lifecycle events but the HttpSessionActivationListener in a distributed environment:&lt;/p&gt;


&lt;p&gt;SRV.7.7.2 Distributed Environments&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;..&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Containers must notify any session attributes implementing the HttpSessionActivationListener during migration of a session. They must notify listeners of passivation prior to serialization of a session, and of activation after deserialization of a session.&lt;/p&gt;

&lt;p&gt;SRV.10.7 Distributed Containers&lt;/p&gt;

&lt;p&gt;In distributed Web containers, HttpSession instances are scoped to the particular JVM servicing session requests, and the ServletContext object is scoped to the Web container&#8217;s JVM. Distributed containers are not required to propagate either servlet context events or HttpSession events to other JVMs. Listener class instances are scoped to one per deployment descriptor declaration per Java Virtual Machine.&lt;/p&gt;</comment>
                            <comment id="13009317" author="bergmark" created="Mon, 21 Mar 2011 19:21:35 +0000"  >&lt;p&gt;Basic failover is working now.&lt;/p&gt;</comment>
                            <comment id="13033732" author="struberg" created="Sun, 15 May 2011 16:35:01 +0000"  >&lt;p&gt;closed, shipped in openwebbeans-1.1.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162881</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08827:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45905</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>