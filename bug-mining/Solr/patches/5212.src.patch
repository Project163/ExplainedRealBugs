diff --git a/solr/CHANGES.txt b/solr/CHANGES.txt
index 57138f080b9..7d28a9900e5 100644
--- a/solr/CHANGES.txt
+++ b/solr/CHANGES.txt
@@ -206,6 +206,8 @@ Bug Fixes
 
 * SOLR-17367: Restore the use of -params option to PostTool. (Bostoi via Eric Pugh)
 
+* SOLR-17369: Fix "flags" usage in FunctionQParser that caused some issues in vectorSimilarity() with BYTE vector constants (hossman)
+
 Dependency Upgrades
 ---------------------
 (No changes)
diff --git a/solr/core/src/java/org/apache/solr/search/FunctionQParser.java b/solr/core/src/java/org/apache/solr/search/FunctionQParser.java
index 41d86f6eae6..2a3dcd9dc68 100644
--- a/solr/core/src/java/org/apache/solr/search/FunctionQParser.java
+++ b/solr/core/src/java/org/apache/solr/search/FunctionQParser.java
@@ -59,6 +59,7 @@ public class FunctionQParser extends QParser {
   public FunctionQParser(
       String qstr, SolrParams localParams, SolrParams params, SolrQueryRequest req) {
     super(qstr, localParams, params, req);
+    setFlags(FLAG_DEFAULT);
     setString(qstr);
   }
 
@@ -89,15 +90,12 @@ public class FunctionQParser extends QParser {
   }
 
   @Override
-  @SuppressWarnings("ErroneousBitwiseExpression")
   public Query parse() throws SyntaxError {
     ValueSource vs = null;
     List<ValueSource> lst = null;
 
     for (; ; ) {
-      // @SuppressWarnings("ErroneousBitwiseExpression") is needed since
-      // FLAG_DEFAULT & ~FLAG_CONSUME_DELIMITER == 0
-      ValueSource valsource = parseValueSource(FLAG_DEFAULT & ~FLAG_CONSUME_DELIMITER);
+      ValueSource valsource = parseValueSource(getFlags() & ~FLAG_CONSUME_DELIMITER);
       sp.eatws();
       if (!parseMultipleSources) {
         vs = valsource;
@@ -298,7 +296,7 @@ public class FunctionQParser extends QParser {
    * @return List&lt;ValueSource&gt;
    */
   public List<ValueSource> parseValueSourceList() throws SyntaxError {
-    return parseValueSourceList(FLAG_DEFAULT | FLAG_CONSUME_DELIMITER);
+    return parseValueSourceList(getFlags() | FLAG_CONSUME_DELIMITER);
   }
 
   /**
@@ -318,7 +316,7 @@ public class FunctionQParser extends QParser {
   /** Parse an individual ValueSource. */
   public ValueSource parseValueSource() throws SyntaxError {
     /* consume the delimiter afterward for an external call to parseValueSource */
-    return parseValueSource(FLAG_DEFAULT | FLAG_CONSUME_DELIMITER);
+    return parseValueSource(getFlags() | FLAG_CONSUME_DELIMITER);
   }
 
   /*
@@ -386,14 +384,11 @@ public class FunctionQParser extends QParser {
    *
    * @param doConsumeDelimiter whether to consume a delimiter following the ValueSource
    */
-  @SuppressWarnings("ErroneousBitwiseExpression")
   protected ValueSource parseValueSource(boolean doConsumeDelimiter) throws SyntaxError {
-    // @SuppressWarnings("ErroneousBitwiseExpression") is needed since
-    // FLAG_DEFAULT & ~FLAG_CONSUME_DELIMITER == 0
     return parseValueSource(
         doConsumeDelimiter
-            ? (FLAG_DEFAULT | FLAG_CONSUME_DELIMITER)
-            : (FLAG_DEFAULT & ~FLAG_CONSUME_DELIMITER));
+            ? (getFlags() | FLAG_CONSUME_DELIMITER)
+            : (getFlags() & ~FLAG_CONSUME_DELIMITER));
   }
 
   protected ValueSource parseValueSource(int flags) throws SyntaxError {
@@ -430,7 +425,9 @@ public class FunctionQParser extends QParser {
       } else {
         QParser subParser = subQuery(val, "func");
         if (subParser instanceof FunctionQParser) {
-          ((FunctionQParser) subParser).setParseMultipleSources(true);
+          FunctionQParser subFunc = (FunctionQParser) subParser;
+          subFunc.setParseMultipleSources(true);
+          subFunc.setFlags(flags);
         }
         Query subQuery = subParser.getQuery();
         if (subQuery == null) {
diff --git a/solr/core/src/test-files/solr/collection1/conf/schema15.xml b/solr/core/src/test-files/solr/collection1/conf/schema15.xml
index 7f7c8260ccc..1efddf09d85 100644
--- a/solr/core/src/test-files/solr/collection1/conf/schema15.xml
+++ b/solr/core/src/test-files/solr/collection1/conf/schema15.xml
@@ -45,6 +45,7 @@
 
   <!-- Dense Vector Fields -->
   <fieldType name="knn_vector" class="solr.DenseVectorField" vectorDimension="4" similarityFunction="cosine"/>
+  <fieldType name="knn_vector_byte" class="solr.DenseVectorField" vectorDimension="4" similarityFunction="cosine" vectorEncoding="BYTE" />
 
   <!-- Field type demonstrating an Analyzer failure -->
   <fieldType name="failtype1" class="solr.TextField">
@@ -564,6 +565,7 @@
 
   <!-- Dense Vector-->
   <field name="vector" type="knn_vector" indexed="true" stored="true"/>
+  <field name="vector_byte" type="knn_vector_byte" indexed="true" stored="true"/>
 
   <dynamicField name="*_sI" type="string" indexed="true" stored="false"/>
   <dynamicField name="*_sS" type="string" indexed="false" stored="true"/>
diff --git a/solr/core/src/test/org/apache/solr/search/QueryEqualityTest.java b/solr/core/src/test/org/apache/solr/search/QueryEqualityTest.java
index 6e675771560..130cf3f9469 100644
--- a/solr/core/src/test/org/apache/solr/search/QueryEqualityTest.java
+++ b/solr/core/src/test/org/apache/solr/search/QueryEqualityTest.java
@@ -915,7 +915,7 @@ public class QueryEqualityTest extends SolrTestCaseJ4 {
         req(
             "v1", "[1,2,3]",
             "v2", " [1,2,3] ",
-            "v3", " [1, 2, 3] ")) {
+            "v3", " [1, 2, 3.0] ")) {
       assertFuncEquals(
           req,
           "vectorSimilarity(FLOAT32,COSINE,[1,2,3],[4,5,6])",
@@ -962,6 +962,28 @@ public class QueryEqualityTest extends SolrTestCaseJ4 {
           "vectorSimilarity(vector, $v2)");
     }
 
+    try (SolrQueryRequest req =
+        req(
+            "f", "vector_byte",
+            "v1", "[1,2,3,4]",
+            "v2", " [1, 2, 3, 4]")) {
+      assertFuncEquals(
+          req,
+          "vectorSimilarity(BYTE,COSINE,vector_byte,[1,2,3,4])",
+          "vectorSimilarity(BYTE,COSINE,vector_byte,$v1)",
+          "vectorSimilarity(BYTE,COSINE,vector_byte, $v1)",
+          "vectorSimilarity(BYTE,COSINE,vector_byte,$v2)",
+          "vectorSimilarity(BYTE,COSINE,vector_byte, $v2)",
+          "vectorSimilarity(vector_byte,[1,2,3,4])",
+          "vectorSimilarity( vector_byte,[1,2,3,4])",
+          "vectorSimilarity( $f,[1,2,3,4])",
+          "vectorSimilarity(vector_byte,$v1)",
+          "vectorSimilarity(vector_byte, $v1)",
+          "vectorSimilarity( $f, $v1)",
+          "vectorSimilarity(vector_byte,$v2)",
+          "vectorSimilarity(vector_byte, $v2)");
+    }
+
     // contrived, but helps us test the param resolution
     // for both field names in the 2arg usecase
     try (SolrQueryRequest req = req("f", "vector")) {
diff --git a/solr/core/src/test/org/apache/solr/search/function/TestDenseVectorFunctionQuery.java b/solr/core/src/test/org/apache/solr/search/function/TestDenseVectorFunctionQuery.java
index 503edd739db..8335f4cc034 100644
--- a/solr/core/src/test/org/apache/solr/search/function/TestDenseVectorFunctionQuery.java
+++ b/solr/core/src/test/org/apache/solr/search/function/TestDenseVectorFunctionQuery.java
@@ -23,6 +23,7 @@ import org.apache.solr.SolrTestCaseJ4;
 import org.apache.solr.common.SolrException;
 import org.apache.solr.common.SolrInputDocument;
 import org.apache.solr.common.params.CommonParams;
+import org.apache.solr.common.params.SolrParams;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
@@ -285,46 +286,48 @@ public class TestDenseVectorFunctionQuery extends SolrTestCaseJ4 {
 
   @Test
   public void test2ArgsByteFieldAndConstVector() throws Exception {
-    assertQ(
-        req(
-            CommonParams.Q,
-            "{!func} vectorSimilarity(vector_byte_encoding, [1,2,3,3])",
-            "fq",
-            "id:(1 2)",
-            "fl",
-            "id, score",
-            "rows",
-            "1"),
-        "//result[@numFound='" + 2 + "']",
-        "//result/doc[1]/str[@name='id'][.=1]");
-    assertQ(
-        req(
-            CommonParams.Q,
-            "{!func} vectorSimilarity(vector_byte_encoding, [3,3,2,1])",
-            "fq",
-            "id:(1 2)",
-            "fl",
-            "id, score",
-            "rows",
-            "1"),
-        "//result[@numFound='" + 2 + "']",
-        "//result/doc[1]/str[@name='id'][.=2]");
+    for (SolrParams main :
+        Arrays.asList(
+            params(CommonParams.Q, "{!func} vectorSimilarity(vector_byte_encoding, [1,2,3,3])"),
+            params(
+                CommonParams.Q,
+                "{!func} vectorSimilarity(vector_byte_encoding, $vec)",
+                "vec",
+                "[1,2,3,3]"))) {
+      assertQ(
+          req(main, "fq", "id:(1 2)", "fl", "id, score", "rows", "1"),
+          "//result[@numFound='" + 2 + "']",
+          "//result/doc[1]/str[@name='id'][.=1]");
+    }
+    for (SolrParams main :
+        Arrays.asList(
+            params(CommonParams.Q, "{!func} vectorSimilarity(vector_byte_encoding, [3,3,2,1])"),
+            params(
+                CommonParams.Q,
+                "{!func} vectorSimilarity(vector_byte_encoding, $vec)",
+                "vec",
+                "[3,3,2,1]"))) {
+
+      assertQ(
+          req(main, "fq", "id:(1 2)", "fl", "id, score", "rows", "1"),
+          "//result[@numFound='" + 2 + "']",
+          "//result/doc[1]/str[@name='id'][.=2]");
+    }
   }
 
   @Test
   public void test2ArgsFloatFieldAndConstVector() throws Exception {
-    assertQ(
-        req(
-            CommonParams.Q,
-            "{!func} vectorSimilarity(vector, [1,2,3,3])",
-            "fq",
-            "id:(1 2 3)",
-            "fl",
-            "id, score"),
-        "//result[@numFound='" + 3 + "']",
-        "//result/doc[1]/str[@name='id'][.=2]",
-        "//result/doc[2]/str[@name='id'][.=3]",
-        "//result/doc[3]/str[@name='id'][.=1]");
+    for (SolrParams main :
+        Arrays.asList(
+            params(CommonParams.Q, "{!func} vectorSimilarity(vector, [1,2,3,3])"),
+            params(CommonParams.Q, "{!func} vectorSimilarity(vector, $vec)", "vec", "[1,2,3,3]"))) {
+      assertQ(
+          req(main, "fq", "id:(1 2 3)", "fl", "id, score"),
+          "//result[@numFound='" + 3 + "']",
+          "//result/doc[1]/str[@name='id'][.=2]",
+          "//result/doc[2]/str[@name='id'][.=3]",
+          "//result/doc[3]/str[@name='id'][.=1]");
+    }
   }
 
   @Test
