diff --git a/gradle/hacks/findbugs.gradle b/gradle/hacks/findbugs.gradle
index bdbdb7e00b4..06a6c76f694 100644
--- a/gradle/hacks/findbugs.gradle
+++ b/gradle/hacks/findbugs.gradle
@@ -21,7 +21,8 @@
 
 configure([project(":solr:core"),
            project(":solr:solrj"),
-           project(":solr:contrib:prometheus-exporter")]) {
+           project(":solr:contrib:prometheus-exporter"),
+           project(":solr:test-framework")]) {
   plugins.withType(JavaPlugin) {
     dependencies {
       // Use versionless variants because these libraries are in versions.lock.
diff --git a/lucene/ivy-versions.properties b/lucene/ivy-versions.properties
index 761cb72a1e5..da3e827db52 100644
--- a/lucene/ivy-versions.properties
+++ b/lucene/ivy-versions.properties
@@ -56,6 +56,9 @@ com.sun.jersey.version = 1.19
 /commons-codec/commons-codec = 1.13
 /commons-collections/commons-collections = 3.2.2
 /commons-io/commons-io = 2.6
+# necessary to run test or embedded Zookeeper as of 3.6.1
+commons.lang.version = 2.6
+/commons-lang/commons-lang = ${commons.lang.version}
 /commons-logging/commons-logging = 1.1.3
 /de.l3s.boilerpipe/boilerpipe = 1.1.0
 
@@ -70,7 +73,7 @@ io.jaegertracing.version = 1.1.0
 /io.jaegertracing/jaeger-core = ${io.jaegertracing.version}
 /io.jaegertracing/jaeger-thrift = ${io.jaegertracing.version}
 
-io.netty.netty.version = 4.1.47.Final
+io.netty.netty.version = 4.1.50.Final
 /io.netty/netty-buffer = ${io.netty.netty.version}
 /io.netty/netty-codec = ${io.netty.netty.version}
 /io.netty/netty-common = ${io.netty.netty.version}
@@ -217,7 +220,7 @@ org.apache.velocity.tools.version = 3.0
 
 /org.apache.xmlbeans/xmlbeans = 3.1.0
 
-org.apache.zookeeper.version = 3.5.7
+org.apache.zookeeper.version = 3.6.1
 /org.apache.zookeeper/zookeeper = ${org.apache.zookeeper.version}
 /org.apache.zookeeper/zookeeper-jute = ${org.apache.zookeeper.version}
 
@@ -319,6 +322,11 @@ org.slf4j.version = 1.7.24
 /org.tallison/jmatio = 1.5
 /org.tukaani/xz = 1.8
 
+# required for instantiating a Zookeeper server in tests or embedded
+org.xerial.snappy.version = 1.1.7.6
+/org.xerial.snappy/snappy-java = ${org.xerial.snappy.version}
+
+
 ua.net.nlp.morfologik-ukrainian-search.version = 4.9.1
 /ua.net.nlp/morfologik-ukrainian-search = ${ua.net.nlp.morfologik-ukrainian-search.version}
 
diff --git a/solr/CHANGES.txt b/solr/CHANGES.txt
index ec67ed9f47e..1eef58e0b65 100644
--- a/solr/CHANGES.txt
+++ b/solr/CHANGES.txt
@@ -87,6 +87,13 @@ Bug Fixes
 * SOLR-14546: Fix for a relatively hard to hit issue in OverseerTaskProcessor that could lead to out of order execution
   of Collection API tasks competing for a lock (Ilan Ginzburg).
 
+==================  8.7.0 ==================
+
+Other Changes
+---------------------
+
+* SOLR-14592: Upgrade Zookeeper to 3.6.1. NOTE: this required upgrading netty to 4.1.50 (Erick Erickson)
+
 ==================  8.6.0 ==================
 
 Consult the LUCENE_CHANGES.txt file for additional, low level, changes in this release.
diff --git a/solr/core/build.gradle b/solr/core/build.gradle
index 71002c2c06b..6550935d26c 100644
--- a/solr/core/build.gradle
+++ b/solr/core/build.gradle
@@ -138,6 +138,9 @@ dependencies {
 
   testImplementation ('com.sun.jersey:jersey-servlet') { transitive = false }
 
+  // required for instantiating a Zookeeper server in tests or embedded
+  runtimeOnly ('org.xerial.snappy:snappy-java')
+  
   testImplementation 'com.google.protobuf:protobuf-java'
   testImplementation 'commons-logging:commons-logging'
   testImplementation('org.mockito:mockito-core', {
diff --git a/solr/core/src/java/org/apache/solr/cloud/SolrZkServer.java b/solr/core/src/java/org/apache/solr/cloud/SolrZkServer.java
index ca75183d8a0..8ee9c0ef4ec 100644
--- a/solr/core/src/java/org/apache/solr/cloud/SolrZkServer.java
+++ b/solr/core/src/java/org/apache/solr/cloud/SolrZkServer.java
@@ -246,64 +246,6 @@ class SolrZkServerProps extends QuorumPeerConfig {
     return false;
   }
 
-  // called by the modified version of parseProperties
-  // when the myid file is missing.
-  public Long getMyServerId() {
-    if (zkRun == null && solrPort == null) return null;
-
-    Map<Long, QuorumPeer.QuorumServer> slist = getServers();
-
-    String myHost = "localhost";
-    InetSocketAddress thisAddr = null;
-
-    if (zkRun != null && zkRun.length()>0) {
-      String parts[] = zkRun.split(":");
-      myHost = parts[0];
-      thisAddr = new InetSocketAddress(myHost, Integer.parseInt(parts[1]) + 1);
-    } else {
-      // default to localhost:<solrPort+1001>
-      thisAddr = new InetSocketAddress(myHost, Integer.parseInt(solrPort)+1001);
-    }
-
-
-    // first try a straight match by host
-    Long me = null;
-    boolean multiple = false;
-    int port = 0;
-    for (QuorumPeer.QuorumServer server : slist.values()) {
-      if (server.addr.getHostName().equals(myHost)) {
-        multiple = me!=null;
-        me = server.id;
-        port = server.addr.getPort();
-      }
-    }
-
-    if (!multiple) {
-      // only one host matched... assume it's me.
-      setClientPort(port - 1);
-      return me;
-    }
-
-    if (me == null) {
-      // no hosts matched.
-      return null;
-    }
-
-
-    // multiple matches... try to figure out by port.
-    for (QuorumPeer.QuorumServer server : slist.values()) {
-      if (server.addr.equals(thisAddr)) {
-        if (clientPortAddress == null || clientPortAddress.getPort() <= 0)
-          setClientPort(server.addr.getPort() - 1);
-        return server.id;
-      }
-    }
-
-    return null;
-  }
-
-
-
   public void setDataDir(File dataDir) {
     this.dataDir = dataDir;
   }
@@ -328,18 +270,6 @@ class SolrZkServerProps extends QuorumPeerConfig {
   @Override
   public void parseProperties(Properties zkProp)
       throws IOException, ConfigException {
-    try {
       super.parseProperties(zkProp);
-    } catch (IllegalArgumentException e) {
-      if (MISSING_MYID_FILE_PATTERN.matcher(e.getMessage()).matches()) {
-        Long myid = getMyServerId();
-        if (myid != null) {
-          serverId = myid;
-          return;
-        }
-        if (zkRun == null) return;
-      }
-      throw e;
-    }
   }
 }
diff --git a/solr/core/src/test/org/apache/solr/cloud/TestConfigSetsAPIZkFailure.java b/solr/core/src/test/org/apache/solr/cloud/TestConfigSetsAPIZkFailure.java
index 1a0d31aa23a..692c82a4290 100644
--- a/solr/core/src/test/org/apache/solr/cloud/TestConfigSetsAPIZkFailure.java
+++ b/solr/core/src/test/org/apache/solr/cloud/TestConfigSetsAPIZkFailure.java
@@ -54,6 +54,7 @@ import org.apache.zookeeper.server.Request;
 import org.apache.zookeeper.server.ServerCnxn;
 import org.apache.zookeeper.server.ZKDatabase;
 import org.apache.zookeeper.server.quorum.Leader.Proposal;
+import org.apache.zookeeper.txn.TxnDigest;
 import org.apache.zookeeper.txn.TxnHeader;
 import org.junit.After;
 import org.junit.Before;
@@ -209,7 +210,7 @@ public class TestConfigSetsAPIZkFailure extends SolrTestCaseJ4 {
     }
 
     @Override
-    public synchronized List<Proposal> getCommittedLog() {
+    public synchronized Collection<Proposal> getCommittedLog() {
       return zkdb.getCommittedLog();
     }
 
@@ -269,8 +270,8 @@ public class TestConfigSetsAPIZkFailure extends SolrTestCaseJ4 {
     }
 
     @Override
-    public ProcessTxnResult processTxn(TxnHeader hdr, Record txn) {
-      return zkdb.processTxn(hdr, txn);
+    public ProcessTxnResult processTxn(TxnHeader hdr, Record txn, TxnDigest digest) {
+      return zkdb.processTxn(hdr, txn, digest);
     }
 
     @Override
@@ -296,9 +297,14 @@ public class TestConfigSetsAPIZkFailure extends SolrTestCaseJ4 {
 
     @Override
     public void setWatches(long relativeZxid, List<String> dataWatches,
-            List<String> existWatches, List<String> childWatches, Watcher watcher) {
-      zkdb.setWatches(relativeZxid, dataWatches, existWatches, childWatches, watcher);
-    }
+                           List<String> existWatches, List<String> childWatches,
+                           List<String> persistentWatches,
+                           List<String> persistentRecursiveWatches,
+                           Watcher watcher) {
+      zkdb.setWatches(relativeZxid, dataWatches, existWatches, childWatches,
+              persistentWatches, persistentRecursiveWatches, watcher);
+
+      }
 
     @Override
     public List<ACL> getACL(String path, Stat stat) throws NoNodeException {
@@ -356,5 +362,15 @@ public class TestConfigSetsAPIZkFailure extends SolrTestCaseJ4 {
     public void close() throws IOException {
       zkdb.close();
     }
+    @Override
+    public int getTxnCount() {
+      return zkdb.getTxnCount();
+    }
+
+    @Override
+    public long getTxnSize() {
+      return zkdb.getTxnSize();
+    }
+
   }
 }
diff --git a/solr/licenses/commons-lang-2.6.jar.sha1 b/solr/licenses/commons-lang-2.6.jar.sha1
new file mode 100644
index 00000000000..4d7b0bf1d9d
--- /dev/null
+++ b/solr/licenses/commons-lang-2.6.jar.sha1
@@ -0,0 +1 @@
+0ce1edb914c94ebc388f086c6827e8bdeec71ac2
diff --git a/solr/licenses/commons-lang-LICENSE-ASL.txt b/solr/licenses/commons-lang-LICENSE-ASL.txt
new file mode 100644
index 00000000000..d6456956733
--- /dev/null
+++ b/solr/licenses/commons-lang-LICENSE-ASL.txt
@@ -0,0 +1,202 @@
+
+                                 Apache License
+                           Version 2.0, January 2004
+                        http://www.apache.org/licenses/
+
+   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
+
+   1. Definitions.
+
+      "License" shall mean the terms and conditions for use, reproduction,
+      and distribution as defined by Sections 1 through 9 of this document.
+
+      "Licensor" shall mean the copyright owner or entity authorized by
+      the copyright owner that is granting the License.
+
+      "Legal Entity" shall mean the union of the acting entity and all
+      other entities that control, are controlled by, or are under common
+      control with that entity. For the purposes of this definition,
+      "control" means (i) the power, direct or indirect, to cause the
+      direction or management of such entity, whether by contract or
+      otherwise, or (ii) ownership of fifty percent (50%) or more of the
+      outstanding shares, or (iii) beneficial ownership of such entity.
+
+      "You" (or "Your") shall mean an individual or Legal Entity
+      exercising permissions granted by this License.
+
+      "Source" form shall mean the preferred form for making modifications,
+      including but not limited to software source code, documentation
+      source, and configuration files.
+
+      "Object" form shall mean any form resulting from mechanical
+      transformation or translation of a Source form, including but
+      not limited to compiled object code, generated documentation,
+      and conversions to other media types.
+
+      "Work" shall mean the work of authorship, whether in Source or
+      Object form, made available under the License, as indicated by a
+      copyright notice that is included in or attached to the work
+      (an example is provided in the Appendix below).
+
+      "Derivative Works" shall mean any work, whether in Source or Object
+      form, that is based on (or derived from) the Work and for which the
+      editorial revisions, annotations, elaborations, or other modifications
+      represent, as a whole, an original work of authorship. For the purposes
+      of this License, Derivative Works shall not include works that remain
+      separable from, or merely link (or bind by name) to the interfaces of,
+      the Work and Derivative Works thereof.
+
+      "Contribution" shall mean any work of authorship, including
+      the original version of the Work and any modifications or additions
+      to that Work or Derivative Works thereof, that is intentionally
+      submitted to Licensor for inclusion in the Work by the copyright owner
+      or by an individual or Legal Entity authorized to submit on behalf of
+      the copyright owner. For the purposes of this definition, "submitted"
+      means any form of electronic, verbal, or written communication sent
+      to the Licensor or its representatives, including but not limited to
+      communication on electronic mailing lists, source code control systems,
+      and issue tracking systems that are managed by, or on behalf of, the
+      Licensor for the purpose of discussing and improving the Work, but
+      excluding communication that is conspicuously marked or otherwise
+      designated in writing by the copyright owner as "Not a Contribution."
+
+      "Contributor" shall mean Licensor and any individual or Legal Entity
+      on behalf of whom a Contribution has been received by Licensor and
+      subsequently incorporated within the Work.
+
+   2. Grant of Copyright License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      copyright license to reproduce, prepare Derivative Works of,
+      publicly display, publicly perform, sublicense, and distribute the
+      Work and such Derivative Works in Source or Object form.
+
+   3. Grant of Patent License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      (except as stated in this section) patent license to make, have made,
+      use, offer to sell, sell, import, and otherwise transfer the Work,
+      where such license applies only to those patent claims licensable
+      by such Contributor that are necessarily infringed by their
+      Contribution(s) alone or by combination of their Contribution(s)
+      with the Work to which such Contribution(s) was submitted. If You
+      institute patent litigation against any entity (including a
+      cross-claim or counterclaim in a lawsuit) alleging that the Work
+      or a Contribution incorporated within the Work constitutes direct
+      or contributory patent infringement, then any patent licenses
+      granted to You under this License for that Work shall terminate
+      as of the date such litigation is filed.
+
+   4. Redistribution. You may reproduce and distribute copies of the
+      Work or Derivative Works thereof in any medium, with or without
+      modifications, and in Source or Object form, provided that You
+      meet the following conditions:
+
+      (a) You must give any other recipients of the Work or
+          Derivative Works a copy of this License; and
+
+      (b) You must cause any modified files to carry prominent notices
+          stating that You changed the files; and
+
+      (c) You must retain, in the Source form of any Derivative Works
+          that You distribute, all copyright, patent, trademark, and
+          attribution notices from the Source form of the Work,
+          excluding those notices that do not pertain to any part of
+          the Derivative Works; and
+
+      (d) If the Work includes a "NOTICE" text file as part of its
+          distribution, then any Derivative Works that You distribute must
+          include a readable copy of the attribution notices contained
+          within such NOTICE file, excluding those notices that do not
+          pertain to any part of the Derivative Works, in at least one
+          of the following places: within a NOTICE text file distributed
+          as part of the Derivative Works; within the Source form or
+          documentation, if provided along with the Derivative Works; or,
+          within a display generated by the Derivative Works, if and
+          wherever such third-party notices normally appear. The contents
+          of the NOTICE file are for informational purposes only and
+          do not modify the License. You may add Your own attribution
+          notices within Derivative Works that You distribute, alongside
+          or as an addendum to the NOTICE text from the Work, provided
+          that such additional attribution notices cannot be construed
+          as modifying the License.
+
+      You may add Your own copyright statement to Your modifications and
+      may provide additional or different license terms and conditions
+      for use, reproduction, or distribution of Your modifications, or
+      for any such Derivative Works as a whole, provided Your use,
+      reproduction, and distribution of the Work otherwise complies with
+      the conditions stated in this License.
+
+   5. Submission of Contributions. Unless You explicitly state otherwise,
+      any Contribution intentionally submitted for inclusion in the Work
+      by You to the Licensor shall be under the terms and conditions of
+      this License, without any additional terms or conditions.
+      Notwithstanding the above, nothing herein shall supersede or modify
+      the terms of any separate license agreement you may have executed
+      with Licensor regarding such Contributions.
+
+   6. Trademarks. This License does not grant permission to use the trade
+      names, trademarks, service marks, or product names of the Licensor,
+      except as required for reasonable and customary use in describing the
+      origin of the Work and reproducing the content of the NOTICE file.
+
+   7. Disclaimer of Warranty. Unless required by applicable law or
+      agreed to in writing, Licensor provides the Work (and each
+      Contributor provides its Contributions) on an "AS IS" BASIS,
+      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
+      implied, including, without limitation, any warranties or conditions
+      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
+      PARTICULAR PURPOSE. You are solely responsible for determining the
+      appropriateness of using or redistributing the Work and assume any
+      risks associated with Your exercise of permissions under this License.
+
+   8. Limitation of Liability. In no event and under no legal theory,
+      whether in tort (including negligence), contract, or otherwise,
+      unless required by applicable law (such as deliberate and grossly
+      negligent acts) or agreed to in writing, shall any Contributor be
+      liable to You for damages, including any direct, indirect, special,
+      incidental, or consequential damages of any character arising as a
+      result of this License or out of the use or inability to use the
+      Work (including but not limited to damages for loss of goodwill,
+      work stoppage, computer failure or malfunction, or any and all
+      other commercial damages or losses), even if such Contributor
+      has been advised of the possibility of such damages.
+
+   9. Accepting Warranty or Additional Liability. While redistributing
+      the Work or Derivative Works thereof, You may choose to offer,
+      and charge a fee for, acceptance of support, warranty, indemnity,
+      or other liability obligations and/or rights consistent with this
+      License. However, in accepting such obligations, You may act only
+      on Your own behalf and on Your sole responsibility, not on behalf
+      of any other Contributor, and only if You agree to indemnify,
+      defend, and hold each Contributor harmless for any liability
+      incurred by, or claims asserted against, such Contributor by reason
+      of your accepting any such warranty or additional liability.
+
+   END OF TERMS AND CONDITIONS
+
+   APPENDIX: How to apply the Apache License to your work.
+
+      To apply the Apache License to your work, attach the following
+      boilerplate notice, with the fields enclosed by brackets "[]"
+      replaced with your own identifying information. (Don't include
+      the brackets!)  The text should be enclosed in the appropriate
+      comment syntax for the file format. We also recommend that a
+      file or class name and description of purpose be included on the
+      same "printed page" as the copyright notice for easier
+      identification within third-party archives.
+
+   Copyright [yyyy] [name of copyright owner]
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+   you may not use this file except in compliance with the License.
+   You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
diff --git a/solr/licenses/commons-lang-NOTICE.txt b/solr/licenses/commons-lang-NOTICE.txt
new file mode 100644
index 00000000000..d3b2d580327
--- /dev/null
+++ b/solr/licenses/commons-lang-NOTICE.txt
@@ -0,0 +1,5 @@
+Apache Commons Lang
+Copyright 2001-2011 The Apache Software Foundation
+
+This product includes software developed by
+The Apache Software Foundation (http://www.apache.org/).
diff --git a/solr/licenses/netty-buffer-4.1.47.Final.jar.sha1 b/solr/licenses/netty-buffer-4.1.47.Final.jar.sha1
deleted file mode 100644
index d6a89c08985..00000000000
--- a/solr/licenses/netty-buffer-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-4aa485d17af675649f8f43aee3b0d1719b00e4ec
diff --git a/solr/licenses/netty-buffer-4.1.50.Final.jar.sha1 b/solr/licenses/netty-buffer-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..8e8923e0e24
--- /dev/null
+++ b/solr/licenses/netty-buffer-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+42b556977c572a376172a3270537ee22203c1a35
diff --git a/solr/licenses/netty-codec-4.1.47.Final.jar.sha1 b/solr/licenses/netty-codec-4.1.47.Final.jar.sha1
deleted file mode 100644
index 2a6d3e78c93..00000000000
--- a/solr/licenses/netty-codec-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-405cee25864c723a0c0245cce0b8c7c13fd985cf
diff --git a/solr/licenses/netty-codec-4.1.50.Final.jar.sha1 b/solr/licenses/netty-codec-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..791103107b9
--- /dev/null
+++ b/solr/licenses/netty-codec-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+cbcb646c9380c6cdc3f56603ae6418a11418ce0f
diff --git a/solr/licenses/netty-common-4.1.47.Final.jar.sha1 b/solr/licenses/netty-common-4.1.47.Final.jar.sha1
deleted file mode 100644
index 8bb259ee909..00000000000
--- a/solr/licenses/netty-common-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-dfb32c59232f5709381474ff1dd028b7eb17270a
diff --git a/solr/licenses/netty-common-4.1.50.Final.jar.sha1 b/solr/licenses/netty-common-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..3f9682dabeb
--- /dev/null
+++ b/solr/licenses/netty-common-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+d2059030b86733c52fd999e63db7300414b487fa
diff --git a/solr/licenses/netty-handler-4.1.47.Final.jar.sha1 b/solr/licenses/netty-handler-4.1.47.Final.jar.sha1
deleted file mode 100644
index 9c7c83931a1..00000000000
--- a/solr/licenses/netty-handler-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-21db930f1964dabb103b2553fe4cfb79a56a36d8
diff --git a/solr/licenses/netty-handler-4.1.50.Final.jar.sha1 b/solr/licenses/netty-handler-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..8e80024a1d6
--- /dev/null
+++ b/solr/licenses/netty-handler-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+dc0110fc4d22fb22f1038cd73a6f8a034928a2d7
diff --git a/solr/licenses/netty-resolver-4.1.47.Final.jar.sha1 b/solr/licenses/netty-resolver-4.1.47.Final.jar.sha1
deleted file mode 100644
index fa78f186fa3..00000000000
--- a/solr/licenses/netty-resolver-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-b625d412d1dcd19972475db2690ab4c1f4aebcc5
diff --git a/solr/licenses/netty-resolver-4.1.50.Final.jar.sha1 b/solr/licenses/netty-resolver-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..114714bf69f
--- /dev/null
+++ b/solr/licenses/netty-resolver-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+deb87b3c901142d73279a58e16867cf6f2b1c2e5
diff --git a/solr/licenses/netty-transport-4.1.47.Final.jar.sha1 b/solr/licenses/netty-transport-4.1.47.Final.jar.sha1
deleted file mode 100644
index d50189021f1..00000000000
--- a/solr/licenses/netty-transport-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-8c2a50ad0b025bd735b865e678b8c4b12121d941
diff --git a/solr/licenses/netty-transport-4.1.50.Final.jar.sha1 b/solr/licenses/netty-transport-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..aab40bea41d
--- /dev/null
+++ b/solr/licenses/netty-transport-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+2e4f6b655933faca0deef8d234ac6725b598109a
diff --git a/solr/licenses/netty-transport-native-epoll-4.1.47.Final.jar.sha1 b/solr/licenses/netty-transport-native-epoll-4.1.47.Final.jar.sha1
deleted file mode 100644
index 0654622bd49..00000000000
--- a/solr/licenses/netty-transport-native-epoll-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-e6962548e57ca315bc66749bb4964571ee1d605c
diff --git a/solr/licenses/netty-transport-native-epoll-4.1.50.Final.jar.sha1 b/solr/licenses/netty-transport-native-epoll-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..2d841801ede
--- /dev/null
+++ b/solr/licenses/netty-transport-native-epoll-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+480ab17c1ebfb32fcd493577d3e3241dc56e62f4
diff --git a/solr/licenses/netty-transport-native-unix-common-4.1.47.Final.jar.sha1 b/solr/licenses/netty-transport-native-unix-common-4.1.47.Final.jar.sha1
deleted file mode 100644
index abe082389fb..00000000000
--- a/solr/licenses/netty-transport-native-unix-common-4.1.47.Final.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-711ba6202031d2296907bb82b15b42d5034ed029
diff --git a/solr/licenses/netty-transport-native-unix-common-4.1.50.Final.jar.sha1 b/solr/licenses/netty-transport-native-unix-common-4.1.50.Final.jar.sha1
new file mode 100644
index 00000000000..63b68ff929e
--- /dev/null
+++ b/solr/licenses/netty-transport-native-unix-common-4.1.50.Final.jar.sha1
@@ -0,0 +1 @@
+87b98225422fccf2bf113e169c45e683de200a3e
diff --git a/solr/licenses/snappy-java-1.1.7.6.jar.sha1 b/solr/licenses/snappy-java-1.1.7.6.jar.sha1
new file mode 100644
index 00000000000..1766919f3db
--- /dev/null
+++ b/solr/licenses/snappy-java-1.1.7.6.jar.sha1
@@ -0,0 +1 @@
+2900879ed8049a19b0f0f30ecd00a84e5a2b80c0
diff --git a/solr/licenses/snappy-java-LICENSE-ASL.txt b/solr/licenses/snappy-java-LICENSE-ASL.txt
new file mode 100644
index 00000000000..d6456956733
--- /dev/null
+++ b/solr/licenses/snappy-java-LICENSE-ASL.txt
@@ -0,0 +1,202 @@
+
+                                 Apache License
+                           Version 2.0, January 2004
+                        http://www.apache.org/licenses/
+
+   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
+
+   1. Definitions.
+
+      "License" shall mean the terms and conditions for use, reproduction,
+      and distribution as defined by Sections 1 through 9 of this document.
+
+      "Licensor" shall mean the copyright owner or entity authorized by
+      the copyright owner that is granting the License.
+
+      "Legal Entity" shall mean the union of the acting entity and all
+      other entities that control, are controlled by, or are under common
+      control with that entity. For the purposes of this definition,
+      "control" means (i) the power, direct or indirect, to cause the
+      direction or management of such entity, whether by contract or
+      otherwise, or (ii) ownership of fifty percent (50%) or more of the
+      outstanding shares, or (iii) beneficial ownership of such entity.
+
+      "You" (or "Your") shall mean an individual or Legal Entity
+      exercising permissions granted by this License.
+
+      "Source" form shall mean the preferred form for making modifications,
+      including but not limited to software source code, documentation
+      source, and configuration files.
+
+      "Object" form shall mean any form resulting from mechanical
+      transformation or translation of a Source form, including but
+      not limited to compiled object code, generated documentation,
+      and conversions to other media types.
+
+      "Work" shall mean the work of authorship, whether in Source or
+      Object form, made available under the License, as indicated by a
+      copyright notice that is included in or attached to the work
+      (an example is provided in the Appendix below).
+
+      "Derivative Works" shall mean any work, whether in Source or Object
+      form, that is based on (or derived from) the Work and for which the
+      editorial revisions, annotations, elaborations, or other modifications
+      represent, as a whole, an original work of authorship. For the purposes
+      of this License, Derivative Works shall not include works that remain
+      separable from, or merely link (or bind by name) to the interfaces of,
+      the Work and Derivative Works thereof.
+
+      "Contribution" shall mean any work of authorship, including
+      the original version of the Work and any modifications or additions
+      to that Work or Derivative Works thereof, that is intentionally
+      submitted to Licensor for inclusion in the Work by the copyright owner
+      or by an individual or Legal Entity authorized to submit on behalf of
+      the copyright owner. For the purposes of this definition, "submitted"
+      means any form of electronic, verbal, or written communication sent
+      to the Licensor or its representatives, including but not limited to
+      communication on electronic mailing lists, source code control systems,
+      and issue tracking systems that are managed by, or on behalf of, the
+      Licensor for the purpose of discussing and improving the Work, but
+      excluding communication that is conspicuously marked or otherwise
+      designated in writing by the copyright owner as "Not a Contribution."
+
+      "Contributor" shall mean Licensor and any individual or Legal Entity
+      on behalf of whom a Contribution has been received by Licensor and
+      subsequently incorporated within the Work.
+
+   2. Grant of Copyright License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      copyright license to reproduce, prepare Derivative Works of,
+      publicly display, publicly perform, sublicense, and distribute the
+      Work and such Derivative Works in Source or Object form.
+
+   3. Grant of Patent License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      (except as stated in this section) patent license to make, have made,
+      use, offer to sell, sell, import, and otherwise transfer the Work,
+      where such license applies only to those patent claims licensable
+      by such Contributor that are necessarily infringed by their
+      Contribution(s) alone or by combination of their Contribution(s)
+      with the Work to which such Contribution(s) was submitted. If You
+      institute patent litigation against any entity (including a
+      cross-claim or counterclaim in a lawsuit) alleging that the Work
+      or a Contribution incorporated within the Work constitutes direct
+      or contributory patent infringement, then any patent licenses
+      granted to You under this License for that Work shall terminate
+      as of the date such litigation is filed.
+
+   4. Redistribution. You may reproduce and distribute copies of the
+      Work or Derivative Works thereof in any medium, with or without
+      modifications, and in Source or Object form, provided that You
+      meet the following conditions:
+
+      (a) You must give any other recipients of the Work or
+          Derivative Works a copy of this License; and
+
+      (b) You must cause any modified files to carry prominent notices
+          stating that You changed the files; and
+
+      (c) You must retain, in the Source form of any Derivative Works
+          that You distribute, all copyright, patent, trademark, and
+          attribution notices from the Source form of the Work,
+          excluding those notices that do not pertain to any part of
+          the Derivative Works; and
+
+      (d) If the Work includes a "NOTICE" text file as part of its
+          distribution, then any Derivative Works that You distribute must
+          include a readable copy of the attribution notices contained
+          within such NOTICE file, excluding those notices that do not
+          pertain to any part of the Derivative Works, in at least one
+          of the following places: within a NOTICE text file distributed
+          as part of the Derivative Works; within the Source form or
+          documentation, if provided along with the Derivative Works; or,
+          within a display generated by the Derivative Works, if and
+          wherever such third-party notices normally appear. The contents
+          of the NOTICE file are for informational purposes only and
+          do not modify the License. You may add Your own attribution
+          notices within Derivative Works that You distribute, alongside
+          or as an addendum to the NOTICE text from the Work, provided
+          that such additional attribution notices cannot be construed
+          as modifying the License.
+
+      You may add Your own copyright statement to Your modifications and
+      may provide additional or different license terms and conditions
+      for use, reproduction, or distribution of Your modifications, or
+      for any such Derivative Works as a whole, provided Your use,
+      reproduction, and distribution of the Work otherwise complies with
+      the conditions stated in this License.
+
+   5. Submission of Contributions. Unless You explicitly state otherwise,
+      any Contribution intentionally submitted for inclusion in the Work
+      by You to the Licensor shall be under the terms and conditions of
+      this License, without any additional terms or conditions.
+      Notwithstanding the above, nothing herein shall supersede or modify
+      the terms of any separate license agreement you may have executed
+      with Licensor regarding such Contributions.
+
+   6. Trademarks. This License does not grant permission to use the trade
+      names, trademarks, service marks, or product names of the Licensor,
+      except as required for reasonable and customary use in describing the
+      origin of the Work and reproducing the content of the NOTICE file.
+
+   7. Disclaimer of Warranty. Unless required by applicable law or
+      agreed to in writing, Licensor provides the Work (and each
+      Contributor provides its Contributions) on an "AS IS" BASIS,
+      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
+      implied, including, without limitation, any warranties or conditions
+      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
+      PARTICULAR PURPOSE. You are solely responsible for determining the
+      appropriateness of using or redistributing the Work and assume any
+      risks associated with Your exercise of permissions under this License.
+
+   8. Limitation of Liability. In no event and under no legal theory,
+      whether in tort (including negligence), contract, or otherwise,
+      unless required by applicable law (such as deliberate and grossly
+      negligent acts) or agreed to in writing, shall any Contributor be
+      liable to You for damages, including any direct, indirect, special,
+      incidental, or consequential damages of any character arising as a
+      result of this License or out of the use or inability to use the
+      Work (including but not limited to damages for loss of goodwill,
+      work stoppage, computer failure or malfunction, or any and all
+      other commercial damages or losses), even if such Contributor
+      has been advised of the possibility of such damages.
+
+   9. Accepting Warranty or Additional Liability. While redistributing
+      the Work or Derivative Works thereof, You may choose to offer,
+      and charge a fee for, acceptance of support, warranty, indemnity,
+      or other liability obligations and/or rights consistent with this
+      License. However, in accepting such obligations, You may act only
+      on Your own behalf and on Your sole responsibility, not on behalf
+      of any other Contributor, and only if You agree to indemnify,
+      defend, and hold each Contributor harmless for any liability
+      incurred by, or claims asserted against, such Contributor by reason
+      of your accepting any such warranty or additional liability.
+
+   END OF TERMS AND CONDITIONS
+
+   APPENDIX: How to apply the Apache License to your work.
+
+      To apply the Apache License to your work, attach the following
+      boilerplate notice, with the fields enclosed by brackets "[]"
+      replaced with your own identifying information. (Don't include
+      the brackets!)  The text should be enclosed in the appropriate
+      comment syntax for the file format. We also recommend that a
+      file or class name and description of purpose be included on the
+      same "printed page" as the copyright notice for easier
+      identification within third-party archives.
+
+   Copyright [yyyy] [name of copyright owner]
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+   you may not use this file except in compliance with the License.
+   You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
diff --git a/solr/licenses/snappy-java-NOTICE.txt b/solr/licenses/snappy-java-NOTICE.txt
new file mode 100644
index 00000000000..43d4f793fb1
--- /dev/null
+++ b/solr/licenses/snappy-java-NOTICE.txt
@@ -0,0 +1,17 @@
+This product includes software developed by Google
+ Snappy: http://code.google.com/p/snappy/ (New BSD License)
+
+This product includes software developed by Apache
+ PureJavaCrc32C from apache-hadoop-common http://hadoop.apache.org/
+ (Apache 2.0 license)
+
+This library containd statically linked libstdc++. This inclusion is allowed by 
+"GCC RUntime Library Exception" 
+http://gcc.gnu.org/onlinedocs/libstdc++/manual/license.html
+
+== Contributors ==
+  * Tatu Saloranta  
+    * Providing benchmark suite
+  * Alec Wysoker
+    * Performance and memory usage improvement
+
diff --git a/solr/licenses/zookeeper-3.5.7.jar.sha1 b/solr/licenses/zookeeper-3.5.7.jar.sha1
deleted file mode 100644
index 6605955ebe9..00000000000
--- a/solr/licenses/zookeeper-3.5.7.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-12bdf55ba8be7fc891996319d37f35eaad7e63ea
diff --git a/solr/licenses/zookeeper-3.6.1.jar.sha1 b/solr/licenses/zookeeper-3.6.1.jar.sha1
new file mode 100644
index 00000000000..a08353a60c4
--- /dev/null
+++ b/solr/licenses/zookeeper-3.6.1.jar.sha1
@@ -0,0 +1 @@
+19757b416e2d73709cc14d799e8c9c32f48843e6
diff --git a/solr/licenses/zookeeper-jute-3.5.7.jar.sha1 b/solr/licenses/zookeeper-jute-3.5.7.jar.sha1
deleted file mode 100644
index 28b5fe2398e..00000000000
--- a/solr/licenses/zookeeper-jute-3.5.7.jar.sha1
+++ /dev/null
@@ -1 +0,0 @@
-1270f80b08904499a6839a2ee1800da687ad96b4
diff --git a/solr/licenses/zookeeper-jute-3.6.1.jar.sha1 b/solr/licenses/zookeeper-jute-3.6.1.jar.sha1
new file mode 100644
index 00000000000..d269b474d88
--- /dev/null
+++ b/solr/licenses/zookeeper-jute-3.6.1.jar.sha1
@@ -0,0 +1 @@
+6421c6284d07abe78762fd30447c4fb15440b6c2
diff --git a/solr/solrj/ivy.xml b/solr/solrj/ivy.xml
index 5312c4207a7..5ce77aa9bb5 100644
--- a/solr/solrj/ivy.xml
+++ b/solr/solrj/ivy.xml
@@ -30,6 +30,10 @@
   <dependencies>
     <dependency org="org.apache.zookeeper" name="zookeeper" rev="${/org.apache.zookeeper/zookeeper}" conf="compile"/>
     <dependency org="org.apache.zookeeper" name="zookeeper-jute" rev="${/org.apache.zookeeper/zookeeper-jute}" conf="compile"/>
+    <!-- needed to instantiate an embedded Zookeeper server as of 3.6.1-->
+    <dependency org="org.xerial.snappy" name="snappy-java" rev="${/org.xerial.snappy/snappy-java}" conf="compile" />
+    <dependency org="commons-lang" name="commons-lang" rev="${/commons-lang/commons-lang}" conf="compile" />
+
     <dependency org="org.apache.httpcomponents" name="httpclient" rev="${/org.apache.httpcomponents/httpclient}" conf="compile"/>
     <dependency org="org.apache.httpcomponents" name="httpmime" rev="${/org.apache.httpcomponents/httpmime}" conf="compile"/>
     <dependency org="org.apache.httpcomponents" name="httpcore" rev="${/org.apache.httpcomponents/httpcore}" conf="compile"/>
diff --git a/solr/test-framework/src/java/org/apache/solr/cloud/ZkTestServer.java b/solr/test-framework/src/java/org/apache/solr/cloud/ZkTestServer.java
index 6f684998d26..dbb39164a32 100644
--- a/solr/test-framework/src/java/org/apache/solr/cloud/ZkTestServer.java
+++ b/solr/test-framework/src/java/org/apache/solr/cloud/ZkTestServer.java
@@ -255,6 +255,8 @@ public class ZkTestServer {
             break;
           case DataWatchRemoved:
             break;
+          case PersistentWatchRemoved:
+            break;
         }
       }
     }
@@ -336,7 +338,8 @@ public class ZkTestServer {
 
         zooKeeperServer = new ZooKeeperServer(ftxn, config.getTickTime(),
             config.getMinSessionTimeout(), config.getMaxSessionTimeout(),
-            new TestZKDatabase(ftxn, limiter));
+            config.getClientPortListenBacklog(),
+            new TestZKDatabase(ftxn, limiter), "");
         cnxnFactory = new TestServerCnxnFactory(limiter);
         cnxnFactory.configure(config.getClientPortAddress(),
             config.getMaxClientCnxns());
diff --git a/versions.lock b/versions.lock
index 3a7296544a7..78282b23ec8 100644
--- a/versions.lock
+++ b/versions.lock
@@ -51,6 +51,7 @@ commons-cli:commons-cli:1.4 (1 constraints: a9041e2c)
 commons-codec:commons-codec:1.13 (1 constraints: d904f430)
 commons-collections:commons-collections:3.2.2 (1 constraints: 09050236)
 commons-io:commons-io:2.6 (1 constraints: ac04232c)
+commons-lang:commons-lang:2.6 (1 constraints: 2a0d520d)
 commons-logging:commons-logging:1.1.3 (2 constraints: c8149e7f)
 de.l3s.boilerpipe:boilerpipe:1.1.0 (1 constraints: 0405f335)
 io.dropwizard.metrics:metrics-core:4.1.5 (5 constraints: 2543e4c0)
@@ -60,14 +61,14 @@ io.dropwizard.metrics:metrics-jmx:4.1.5 (1 constraints: 0c050736)
 io.dropwizard.metrics:metrics-jvm:4.1.5 (1 constraints: 0c050736)
 io.jaegertracing:jaeger-core:1.1.0 (1 constraints: 5c0d6c26)
 io.jaegertracing:jaeger-thrift:1.1.0 (1 constraints: 0405f335)
-io.netty:netty-buffer:4.1.47.Final (6 constraints: 29558e4c)
-io.netty:netty-codec:4.1.47.Final (2 constraints: fc135b82)
-io.netty:netty-common:4.1.47.Final (8 constraints: 9d6ed3cf)
-io.netty:netty-handler:4.1.47.Final (2 constraints: 2f176f42)
-io.netty:netty-resolver:4.1.47.Final (3 constraints: ad213fd0)
-io.netty:netty-transport:4.1.47.Final (5 constraints: 7847722a)
-io.netty:netty-transport-native-epoll:4.1.47.Final (2 constraints: 2f176f42)
-io.netty:netty-transport-native-unix-common:4.1.47.Final (2 constraints: 081ad205)
+io.netty:netty-buffer:4.1.50.Final (6 constraints: 0555463a)
+io.netty:netty-codec:4.1.50.Final (2 constraints: f0132581)
+io.netty:netty-common:4.1.50.Final (8 constraints: 6d6ed7af)
+io.netty:netty-handler:4.1.50.Final (2 constraints: 2c174741)
+io.netty:netty-resolver:4.1.50.Final (3 constraints: 9b2100cd)
+io.netty:netty-transport:4.1.50.Final (5 constraints: 5a47c31d)
+io.netty:netty-transport-native-epoll:4.1.50.Final (2 constraints: 2c174741)
+io.netty:netty-transport-native-unix-common:4.1.50.Final (2 constraints: fc194204)
 io.opentracing:opentracing-api:0.33.0 (5 constraints: 4d3cfe52)
 io.opentracing:opentracing-mock:0.33.0 (1 constraints: 3805343b)
 io.opentracing:opentracing-noop:0.33.0 (3 constraints: 7c2142bd)
@@ -140,8 +141,8 @@ org.apache.velocity.tools:velocity-tools-generic:3.0 (1 constraints: 00136415)
 org.apache.velocity.tools:velocity-tools-view:3.0 (1 constraints: 7a14126a)
 org.apache.velocity.tools:velocity-tools-view-jsp:3.0 (1 constraints: a704202c)
 org.apache.xmlbeans:xmlbeans:3.1.0 (1 constraints: 0605fd35)
-org.apache.zookeeper:zookeeper:3.5.7 (1 constraints: 11051036)
-org.apache.zookeeper:zookeeper-jute:3.5.7 (1 constraints: 8f0d3b28)
+org.apache.zookeeper:zookeeper:3.6.1 (1 constraints: 0c050d36)
+org.apache.zookeeper:zookeeper-jute:3.6.1 (1 constraints: 8a0d3828)
 org.asciidoctor:asciidoctorj:1.6.2 (1 constraints: 0b050436)
 org.asciidoctor:asciidoctorj-api:1.6.2 (1 constraints: e30cfb0d)
 org.aspectj:aspectjrt:1.8.0 (1 constraints: 0b050836)
@@ -208,6 +209,7 @@ org.slf4j:slf4j-api:1.7.24 (18 constraints: 64f415d2)
 org.slf4j:slf4j-simple:1.7.24 (1 constraints: 4005473b)
 org.tallison:jmatio:1.5 (1 constraints: aa041f2c)
 org.tukaani:xz:1.8 (1 constraints: ad04222c)
+org.xerial.snappy:snappy-java:1.1.7.6 (1 constraints: 6f05a240)
 ua.net.nlp:morfologik-ukrainian-search:4.9.1 (1 constraints: 10051b36)
 xerces:xercesImpl:2.12.0 (2 constraints: 1f14b675)
 
diff --git a/versions.props b/versions.props
index 1b696c9a1ef..7a3511a9682 100644
--- a/versions.props
+++ b/versions.props
@@ -33,7 +33,7 @@ commons-logging:commons-logging=1.1.3
 de.l3s.boilerpipe:boilerpipe=1.1.0
 io.dropwizard.metrics:*=4.1.5
 io.jaegertracing:*=1.1.0
-io.netty:*=4.1.47.Final
+io.netty:*=4.1.50.Final
 io.opentracing:*=0.33.0
 io.prometheus:*=0.2.0
 io.sgr:s2-geometry-library-java=1.0.0
@@ -74,7 +74,7 @@ org.apache.poi:*=4.1.1
 org.apache.tika:*=1.24
 org.apache.velocity.tools:*=3.0
 org.apache.xmlbeans:xmlbeans=3.1.0
-org.apache.zookeeper:*=3.5.7
+org.apache.zookeeper:*=3.6.1
 org.asciidoctor:asciidoctorj=1.6.2
 org.aspectj:aspectjrt=1.8.0
 org.bitbucket.b_c:jose4j=0.6.5
@@ -103,5 +103,6 @@ org.rrd4j:rrd4j=3.5
 org.slf4j:*=1.7.24
 org.tallison:jmatio=1.5
 org.tukaani:xz=1.8
+org.xerial.snappy:snappy-java=1.1.7.6
 ua.net.nlp:morfologik-ukrainian-search=4.9.1
-xerces:xercesImpl=2.12.0
\ No newline at end of file
+xerces:xercesImpl=2.12.0
