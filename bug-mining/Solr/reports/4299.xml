<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13709] Race condition on core reload while core is still loading?</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13709</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>
&lt;p&gt;A recent jenkins failure from &lt;tt&gt;TestSolrCLIRunExample&lt;/tt&gt; seems to suggest that there may be a race condition when attempting to re-load a SolrCore while the core is currently in the process of (re)loading that can leave the SolrCore in an unusable state.&lt;/p&gt;

&lt;p&gt;Details to follow...&lt;/p&gt;</description>
                <environment></environment>
        <key id="13252245">SOLR-13709</key>
            <summary>Race condition on core reload while core is still loading?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Aug 2019 01:33:09 +0000</created>
                <updated>Thu, 31 Dec 2020 13:25:26 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16912845" author="hossman" created="Thu, 22 Aug 2019 01:34:56 +0000"  >&lt;p&gt;I&apos;ve attached the logs from the jenkins run in question...&lt;/p&gt;

&lt;p&gt;Interestingly: Even though the logs indicate several problems in trying to reload/unload the SolrCore, the test itself didn&apos;t seem to care enough about the state of the collection to notice the problems &#8211; the only junit failure recorded was a suite level failure from the ObjectTracker due to unreleased threads/objects.&lt;/p&gt;

&lt;p&gt;The first sign of trouble in the logs is this WARN from a ZK watcher registered to monitor the schema for changes (in schemaless mode) in order to re-load the SolrCore &#8211; it fails with an NullPointerException...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 4309877 WARN  (Thread-7591) [n:localhost:38920_solr c:testCloudExamplePrompt s:shard2 r:core_node7 x:testCloudExamplePrompt_shard2_replica_n4 ] o.a.s.c.ZkController liste
ner throws error
   [junit4]   2&amp;gt;           =&amp;gt; org.apache.solr.common.SolrException: Unable to reload core [testCloudExamplePrompt_shard2_replica_n6]
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1557)
   [junit4]   2&amp;gt; org.apache.solr.common.SolrException: Unable to reload core [testCloudExamplePrompt_shard2_replica_n6]
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1557) ~[java/:?]
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.lambda$getConfListener$21(SolrCore.java:3099) ~[java/:?]
   [junit4]   2&amp;gt;        at org.apache.solr.cloud.ZkController.lambda$fireEventListeners$14(ZkController.java:2514) ~[java/:?]
   [junit4]   2&amp;gt;        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_191]
   [junit4]   2&amp;gt; Caused by: java.lang.NullPointerException
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreDescriptor.&amp;lt;init&amp;gt;(CoreDescriptor.java:172) ~[java/:?]
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.reload(SolrCore.java:683) ~[java/:?]
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1507) ~[java/:?]
   [junit4]   2&amp;gt;        ... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...AFAICT the only way this NPE is possily is if the CoreDescriptor for the &lt;em&gt;original&lt;/em&gt; SolrCore is NULL at the time the watcher fires, and the only concievable way that seems to be possible is if the original SolrCore hadn&apos;t completley finished loading.&lt;/p&gt;

&lt;p&gt;Aparently as a result of this failure to reload, a SolrCoreInitializationException is recorded for the core name, and that ultimately causes a fast-failure response when trying to unload the core...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 4310314 ERROR (qtp373709619-50629) [n:localhost:38920_solr    x:testCloudExamplePrompt_shard2_replica_n6 ] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException
: Error unregistering core [testCloudExamplePrompt_shard2_replica_n6] from cloud state
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.unload(CoreContainer.java:1672)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$1(CoreAdminOperation.java:105)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.admin.CoreAdminOperation.execute(CoreAdminOperation.java:360)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.admin.CoreAdminHandler$CallInfo.call(CoreAdminHandler.java:397)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:181)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:200)
   [junit4]   2&amp;gt;        at org.apache.solr.servlet.HttpSolrCall.handleAdmin(HttpSolrCall.java:820)
   [junit4]   2&amp;gt;        at org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:786)
   [junit4]   2&amp;gt;        at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:546)
   [junit4]   2&amp;gt;        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:423)
   [junit4]   2&amp;gt;        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:350)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)
   [junit4]   2&amp;gt;        at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:165)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1711)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1347)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1678)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1249)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.Server.handle(Server.java:505)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:370)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:267)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:117)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:781)
   [junit4]   2&amp;gt;        at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:917)
   [junit4]   2&amp;gt;        at java.lang.Thread.run(Thread.java:748)
   [junit4]   2&amp;gt; Caused by: org.apache.solr.core.SolrCoreInitializationException: SolrCore &apos;testCloudExamplePrompt_shard2_replica_n6&apos; is not available due to init failure: null
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.getCore(CoreContainer.java:1740)
   [junit4]   2&amp;gt;        at org.apache.solr.cloud.ShardLeaderElectionContext.cancelElection(ElectionContext.java:294)
   [junit4]   2&amp;gt;        at org.apache.solr.cloud.ZkController.unregister(ZkController.java:1658)
   [junit4]   2&amp;gt;        at org.apache.solr.cloud.ZkController.unregister(ZkController.java:1637)
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.unload(CoreContainer.java:1665)
   [junit4]   2&amp;gt;        ... 35 more
   [junit4]   2&amp;gt; Caused by: java.lang.NullPointerException
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreDescriptor.&amp;lt;init&amp;gt;(CoreDescriptor.java:172)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.reload(SolrCore.java:683)
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1507)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore.lambda$getConfListener$21(SolrCore.java:3099)
   [junit4]   2&amp;gt;        at org.apache.solr.cloud.ZkController.lambda$fireEventListeners$14(ZkController.java:2514)
   [junit4]   2&amp;gt;        ... 1 more
   [junit4]   2&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As i mentioned before, none of this caused any failures directly from &lt;tt&gt;TestSolrCLIRunExample.testInteractiveSolrCloudExample&lt;/tt&gt; (the minimal checks it does that the collection was created and the one doc indexed can be found succeeded, likeley because they were handled by other cores) but the main point i want to draw attention to is that this situation even seems to be possible.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;FWIW: I briefly looked into the code to try and understand where/why a SolrCore could be allowed to &quot;reload&quot; itself if it hadn&apos;t finished loading (regardless of wether SolrCloud was in use) and the first thing thta jumped out at me was the javadocs for &lt;tt&gt;SolrCores.getCoreDescriptor(String)&lt;/tt&gt; (which is what &lt;tt&gt;SolrCore.getCoreDescriptor()&lt;/tt&gt; ultimately delegates too, and would be the source of the &apos;null&apos; that causes the NPE: &lt;tt&gt;SolrCore.reload(...)&lt;/tt&gt; calls &lt;tt&gt;getCoreDescriptor()&lt;/tt&gt; and passes the &#8211; evidently null &#8211; result to the copy constructor of &lt;tt&gt;new CoreDescriptor(...)&lt;/tt&gt;) ...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Return the CoreDescriptor corresponding to a given core name.
   * Blocks &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the SolrCore is still loading until it is ready.
   * @param coreName the name of the core
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the CoreDescriptor
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CoreDescriptor getCoreDescriptor(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; coreName) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (modifyLock) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (residentDesciptors.containsKey(coreName))
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; residentDesciptors.get(coreName);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getTransientCacheHandler().getTransientDescriptor(coreName);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note the javadocs say this method will &quot;Blocks if the SolrCore is still loading until it is ready.&quot; &#8211; but there doesn&apos;t seem to be any (obvious) evidence of that, unless the expecation is that &lt;tt&gt;modifyLock&lt;/tt&gt; will be held for the durration of a SolrCore initialization (but i don&apos;t see any sign/intent of that either).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; : you added that comment to the javadocs as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7361&quot; title=&quot;Main Jetty thread blocked by core loading delays HTTP listener from binding if core loading is slow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7361&quot;&gt;&lt;del&gt;SOLR-7361&lt;/del&gt;&lt;/a&gt;, but made no other changes to the method so i&apos;m not clear what/where it was being enforced at the time you wrote it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; : pinging you as well since you&apos;ve done a lot of work on (transient) SolrCore loading in the past few years, and wondering if you have any insight into where/how this could happen.&lt;/p&gt;</comment>
                            <comment id="16913221" author="markrmiller@gmail.com" created="Thu, 22 Aug 2019 10:54:02 +0000"  >&lt;p&gt;I don&#8217;t recall adding a comment off the top of my head but I know I ran into a bunch of ugly little issues after this change where the descriptor can now be null when it couldn&#8217;t in the past. I had to change a bunch of plugin code to grab the descriptor right away and save it vs count on being able to get it from the core always. &lt;/p&gt;</comment>
                            <comment id="16914633" author="erickerickson" created="Fri, 23 Aug 2019 20:59:33 +0000"  >&lt;p&gt;Deleted comment because it&apos;s bogus. I&apos;ll try again....&lt;/p&gt;</comment>
                            <comment id="16914659" author="erickerickson" created="Fri, 23 Aug 2019 21:46:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; Take two, my investigations.&lt;/p&gt;

&lt;p&gt;I don&apos;t see how core descriptors can be null. The modifyLock is all about list keeping, &lt;em&gt;not&lt;/em&gt; successfully loading the cores. And it should be fully populated by the time CoreContainer.load() is finished.&lt;/p&gt;

&lt;p&gt;Is there a possibility that this is happening before CoreContainer.load() is finished?&lt;/p&gt;

&lt;p&gt;Except... core descriptors are removed from the underlying list when the core is unloaded. I wonder if that&apos;s somehow in the mix.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll put some logging in and beast it to see what I can see.&lt;/p&gt;

&lt;p&gt;Thanks for sleuthing!&lt;/p&gt;</comment>
                            <comment id="16914665" author="hossman" created="Fri, 23 Aug 2019 21:52:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there a possibility that this is happening before CoreContainer.load() is finished?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;it&apos;s absolutely possible &#8211; that&apos;s the point i made when i created this issue:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;...AFAICT the only way this NPE is possily is if the CoreDescriptor for the original SolrCore is NULL at the time the watcher fires, and the only concievable way that seems to be possible is if the original SolrCore hadn&apos;t completley finished loading.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Acording to the docs of that method it &lt;em&gt;should&lt;/em&gt; block until the core is loaded,&#160; but the ZkWatcher thread  in question &amp;#8211; set by the SolrCore durring it&apos;s own init in order to reload the core if the schema changes &amp;#8211; is calling &lt;tt&gt;getCoreDescriptor()&lt;/tt&gt; in order to reload the core and getting null.&lt;/p&gt;
</comment>
                            <comment id="16914948" author="erickerickson" created="Sat, 24 Aug 2019 13:21:14 +0000"  >&lt;p&gt;That doc hasn&apos;t been accurate since 2015 on a quick glance, so I don&apos;t trust it in the least. Also, in some testing I was doing last night there are many legitimate (apparently) times that getCoreDescriptor is called and returns null, so blocking forever would stop at least the tests cold. Particularly looking for things like &quot;.system&quot; collection. The comment is totally bogus, I&apos;ll change it if I can figure out a fix.&lt;/p&gt;

&lt;p&gt;Your hypothesis is that CoreContainer.load() is on one thread and the watcher is on another, right? And loading, which could easily take a long time if there are a lot of cores especially if there are a limited number of threads loading them, isn&apos;t done, thus the race.&lt;/p&gt;

&lt;p&gt;Off the top of my head, it&apos;d be OK to block until CoreContainer.load is finished. The &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;status&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is there specifically so a transient plugin can detect this state, there&apos;s no reason we can&apos;t use it other places. At that point, all core &lt;em&gt;descriptors&lt;/em&gt; will be available to getCoreDescriptor, whether or not the core is actually loaded or not (i.e. transient or lazy). In that case null should not be returned from getCoreDescriptor. I&apos;ll give that a whirl.&lt;/p&gt;

&lt;p&gt;But there&apos;s one other thing that occurred to me. When a core is created there&apos;s a period during which the core descriptor is not available to getCoreDescriptor for an indeterminate amount of time. Do you think that&apos;d also be a problem?&lt;/p&gt;

&lt;p&gt;I&apos;ll try blocking until CoreContainer.load is finished and add some logging in both cases to see if we actually hit the state where CoreContainer.load() isn&apos;t finished and we can&apos;t find the descriptor and it isn&apos;t the .system collection, which seems to be called for a lot.&lt;/p&gt;

&lt;p&gt;It&apos;d actually be easier to debug if we can fail in this case. Is there an easy way for Solr code to know whether it&apos;s being run from a test? I&apos;d like getCoreDescriptor to throw an error &lt;em&gt;only when testing&lt;/em&gt; for a while if it gets into this situation. I&apos;d make this JIRA a blocker in that case so we&apos;d be sure to clean that up before release.&lt;/p&gt;</comment>
                            <comment id="16920556" author="erickerickson" created="Mon, 2 Sep 2019 01:36:15 +0000"  >&lt;p&gt;Blocking getCoreDescriptor until CoreContainer.load() is finished isn&apos;t going to work. I have 4 test failures, and it starts getting untenable to say &quot;if it&apos;s the .system collection, you don&apos;t have to wait&quot;. I did  that and another one popped out. Too fragile to consider a permanent fix even if it can be made to work.&lt;/p&gt;

&lt;p&gt;Hmmm, if it&apos;s really just a reload question, I &lt;em&gt;think&lt;/em&gt; that a much safer alternative would be to have the &lt;em&gt;reload&lt;/em&gt; operation wait until core loading was complete. I&apos;ll give that a try with some debugging code in place just to prove the hypothesis.&lt;/p&gt;

&lt;p&gt;Thinking more, it seems like swap, unload, and create should all block until the coreContainer has completed loading as well. Actually, it seems like &lt;em&gt;all&lt;/em&gt; core API commands should wait until after CoreContainer.load() is done.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; So I put some code in to wait on CoreContainer.load to complete before any core admin operation is allowed. WDYT about failing hard whenever this occurs as a &lt;em&gt;temporary&lt;/em&gt; way to see if this is actually happening? I&apos;m thinking on master only but could easily be persuaded to put it on 8x as well. If we see test failures that contain &quot;EOE&quot; we&apos;ll have hit this condition and I&apos;ll have more confidence that this is a reasonable fix.&lt;/p&gt;

&lt;p&gt;running precommit and a full test suite tonight.&lt;/p&gt;

&lt;p&gt;I&apos;d make this JIRA a blocker while the temporary code was in place.....&lt;/p&gt;</comment>
                            <comment id="16921141" author="dsmiley" created="Tue, 3 Sep 2019 03:35:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;have the reload operation wait until core loading was complete. I&apos;ll give that a try with some debugging code in place just to prove the hypothesis. Thinking more, it seems like swap, unload, and create should all block until the coreContainer has completed loading as well. Actually, it seems like all core API commands should wait until after CoreContainer.load() is done.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to all that&lt;/p&gt;</comment>
                            <comment id="16921469" author="erickerickson" created="Tue, 3 Sep 2019 14:36:35 +0000"  >&lt;p&gt;Making some progress on this, at least I&apos;m getting local beasting to fail. 2 out of 1,000 runs, so it takes 8-10 hours to try something. So far, CoreContainer.load() is completing properly and there are still failures. I still think blocking until it&apos;s CoreContainerl.load() is complete is a good idea.&lt;/p&gt;

&lt;p&gt;What I &lt;em&gt;think&lt;/em&gt; I&apos;m seeing now is the following sequence:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CoreContainer.load() completes successfully&lt;/li&gt;
	&lt;li&gt;a core create operation is initiated (this happens relatively frequently in tests of course)&lt;/li&gt;
	&lt;li&gt;SolrCores.getCoreDescriptor is called before the core creation is complete, the coreDescriptor list gets updated fairly late in the core creation process.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Relatively early in the core creation process though, the core is added to pendingCoreOps, a list of cores that are in transition. My latest hypothesis is that it&apos;s during this interval that SolrCores.getCoreDescriptor is called and returns null. I have some debugging logging in place to test, and a loop in place to wait until a core moves out of pendingCoreOps before returning from SolrCores.getCoreDescriptor.&lt;/p&gt;

&lt;p&gt;There&apos;s still a small window I think between the time CoreContainer.create(core) is called from some client and the entry gets &lt;em&gt;in&lt;/em&gt; the pendingCoreOps list. First I&apos;ll see if checking pendingCoreOps has an entry upon occasion for a core whose descriptor is being asked for, then see if I can close that window.&lt;/p&gt;

&lt;p&gt;The other thing I&apos;m seeing is that failures happen in several places and have several different stack traces. I think one that I saw was from metrics, another from update, etc. All are fairly consistent with my proposed steps, but then my other three hypotheses have been too.&lt;/p&gt;

&lt;p&gt;I&apos;ll be traveling Thursday and Friday, then the week after is Activate so this may languish if I can&apos;t get some closure by Sunday.&lt;/p&gt;

&lt;p&gt;I still have a problem with the fact that the &quot;.system&quot; collection is regularly asked for in SolrCores.getDescriptor, even when it&apos;s never going to be there. Anything I do in getCoreDescriptor that waits is susceptible to waiting on an event that&apos;ll never occur. Of course I can time-limit the wait, but the example of asking for the &quot;.system&quot; core just means that there may be another case. Waiting while any asked-for core is in pendingCoreOps is fine since that condition will end as soon as the core is loaded (or fails).&lt;/p&gt;</comment>
                            <comment id="16921597" author="hossman" created="Tue, 3 Sep 2019 17:39:16 +0000"  >&lt;p&gt;just to be clear, my primary concern when i created this issue was that it was evident from the test failure logs that core reloading (and as erick points out: potentially other core level ops) could occur in a race condition with the core itself loading.&lt;/p&gt;

&lt;p&gt;my comments about &lt;tt&gt;SolrCores.getCoreDescriptor(String)&lt;/tt&gt; and if/when/why/how  it should block on attempts to ccess a core by name if/while that core was loading were based &lt;b&gt;solely&lt;/b&gt; on the exsting javadocs for that method.&lt;/p&gt;

&lt;p&gt;if those javadocs are and have always been wrong, then trying to &quot;fix&quot; that method to match the javadocs isn&apos;t necessarily the best solution &amp;#8211; especially if doing so causes lots of other problems.  we can always just update the javadocs, making a note of when/why/how the value may be null, and audit the callers to ensure they are accounting for the possibility of null and handling that value in whatever way makes the most sense for the situation (throw NPE, throw a diff exception, fail a command, etc...)&lt;/p&gt;

&lt;p&gt;i should point out, i have no idea if a &quot;user level&quot; Core RELOAD (or SWAP or UNLOAD) op (ie: something triggered externally via /admin/cores, or via overseer) also has this problem, or already accounts for the possibility that a core may not yet be loaded &amp;#8211; it may simply be that this particular ZkWatcher that registered by the core to watch the schema is itself broken, and should be checking some more explicit state to block and take no action until the core is fully loaded.&lt;/p&gt;

&lt;p&gt;As far as testing...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; - it&apos;s not really clear to me what/where/how you&apos;re currently trying to test this? ... as i mentioned, it&apos;s kind of a fluke that TestSolrCLIRunExample triggered this failure at all, and even when it did it didn&apos;t really &quot;fail&quot; in a reliable way that was oviously related to this specifit bug.  &lt;/p&gt;

&lt;p&gt;I would suggest that a more robust way to test this would be with a more targeted non-cloud test, using a custom plugin (searcher handler, component, whatever...) that spins up a background thread to trigger schema updates in ZK (so that the problematic watcher which does a core reload on schema changes will then fire) and then the custom component should &quot;stall&quot; for some amount of time (ideally &lt;tt&gt;await&lt;/tt&gt;-ing on something instead of an arbitrary sleep, but i haven&apos;t thought it through enough to know what exact condition it could await on) to force a delay in the completeion of the SolrCore loading.  Then your test just tries to initialize a SolrCore with a config that uses this custom plugin, and asserts that the SolrCore initializes fine &lt;b&gt;AND&lt;/b&gt; that it (eventually) picks up the updated schema (via polling on the schema API?)&lt;/p&gt;

&lt;p&gt;make sense?&lt;/p&gt;</comment>
                            <comment id="16921619" author="jira-bot" created="Tue, 3 Sep 2019 18:02:08 +0000"  >&lt;p&gt;&lt;del&gt;Commit 83cd54f80157916b364bb5ebde20a66cbd5d3d93 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;/del&gt;&lt;br/&gt;
 &lt;del&gt;[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=83cd54f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=83cd54f&lt;/a&gt; ]&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13709&quot; title=&quot;Race condition on core reload while core is still loading?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13709&quot;&gt;SOLR-13709&lt;/a&gt;: Fixed distributed grouping when multiple &apos;fl&apos; params are specified&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;EDIT: not actually relevant to this issue, sorry.&lt;/p&gt;</comment>
                            <comment id="16921632" author="jira-bot" created="Tue, 3 Sep 2019 18:18:26 +0000"  >&lt;p&gt;&lt;del&gt;Commit 86e8c44be472556c8a905deb338cafa803ee6ee0 in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;/del&gt;&lt;br/&gt;
 &lt;del&gt;[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=86e8c44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=86e8c44&lt;/a&gt; ]&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13709&quot; title=&quot;Race condition on core reload while core is still loading?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13709&quot;&gt;SOLR-13709&lt;/a&gt;: Fixed distributed grouping when multiple &apos;fl&apos; params are specified&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;(cherry picked from commit 83cd54f80157916b364bb5ebde20a66cbd5d3d93)&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;EDIT: not actually relevant to this issue, sorry.&lt;/p&gt;</comment>
                            <comment id="16921640" author="jira-bot" created="Tue, 3 Sep 2019 18:23:41 +0000"  >&lt;p&gt;Commit 96c9207f905ebfafdbe81a748a978c7e83d683df in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=96c9207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=96c9207&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;CHANGES fixup: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13709&quot; title=&quot;Race condition on core reload while core is still loading?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13709&quot;&gt;SOLR-13709&lt;/a&gt; -&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13717&quot; title=&quot;Distributed Grouping breaks multi valued &amp;#39;fl&amp;#39; param&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13717&quot;&gt;&lt;del&gt;SOLR-13717&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d1a4d1352538a0d967a12686ca903453d10c48c9)&lt;/p&gt;</comment>
                            <comment id="16921642" author="jira-bot" created="Tue, 3 Sep 2019 18:23:48 +0000"  >&lt;p&gt;Commit d1a4d1352538a0d967a12686ca903453d10c48c9 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d1a4d13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d1a4d13&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;CHANGES fixup: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13709&quot; title=&quot;Race condition on core reload while core is still loading?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13709&quot;&gt;SOLR-13709&lt;/a&gt; -&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13717&quot; title=&quot;Distributed Grouping breaks multi valued &amp;#39;fl&amp;#39; param&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13717&quot;&gt;&lt;del&gt;SOLR-13717&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16921707" author="erickerickson" created="Tue, 3 Sep 2019 20:22:42 +0000"  >&lt;p&gt;Problem is that from what I&apos;ve seen so far schema changes seem to be only one of the conditions that have NULL returned from getCoreDescriptor when it shouldn&apos;t be.&lt;/p&gt;

&lt;p&gt;&quot;load&quot; may or may not have anything to do with CoreContainer.load(). A core can be created for instance by collection creation. There&apos;s a period between&#160; when a core is created by something other than start-up but the coreDescriptor is not yet available, even though CoreContainer.load() has finished and presumably all the coreDescriptors are available that I believe affects more than just a schemaless update.&lt;/p&gt;

&lt;p&gt;&quot;fail&quot; in this case is I beast the hell out of the test and have a program I wrote examine all the stdout files looking for various things. NPE in this case, then try to see what the root cause is. 998/1000 times there&apos;s no NPE, but when there is it always looks like getCoreDescriptor returns null.&lt;/p&gt;

&lt;p&gt;Hmmm, with my proposed sequence of events, I&apos;m starting to wonder if it could be something as stupid-simple as registering the watcher before the call to create core returns....&lt;/p&gt;

&lt;p&gt;And I totally realize you&apos;re comments are what you had time for.&lt;/p&gt;</comment>
                            <comment id="16940489" author="erickerickson" created="Sun, 29 Sep 2019 17:03:54 +0000"  >&lt;p&gt;Finally back looking at this, the progress will be slow. I can add a few findings.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I&apos;m 99% certain this has nothing to do with loading the core container.&lt;/li&gt;
	&lt;li&gt;The failures I&apos;m seeing (NOTE: there may be more than one, but one thing at a time) are the Metrics-related NPE happening as the test finishes and the collection is being deleted.&lt;/li&gt;
	&lt;li&gt;What I see is a bunch of reloads (expected), then a &lt;em&gt;CoreContainer.unload()&lt;/em&gt;, &lt;em&gt;then&lt;/em&gt; the NPE and the &quot;unable to reload core&quot; message.&lt;/li&gt;
	&lt;li&gt;I verified that the &lt;em&gt;unload&lt;/em&gt; is only happening when the collection is deleted at the end of the test.&lt;/li&gt;
	&lt;li&gt;So it seems like there is, indeed, a race condition, but it has to do with higher-level operations. Somehow the reloads are still going on when the collection is being deleted. I did note that the reload calls are async (IIRC).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is looking more and more like a test artifact, were programmatically deleting the collection too quickly and it&apos;s not worth warping the Solr code to guard against. For test purposes, something that told us all of the pending collection operations were completed before we go ahead and delete the collection would do the trick, my theory so far is that the reload isn&apos;t complete yet.&lt;/p&gt;

&lt;p&gt;I&apos;m running some more tests that&apos;ll dump the stack of all the threads if I can get it to fail again, although I&apos;m not sure that&apos;ll be conclusive.&lt;/p&gt;

&lt;p&gt;I suppose the other approach would be to try to hand around in the delete collection code while anything was pending.&lt;/p&gt;

&lt;p&gt;Thoughts? Expecially &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;&#160; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat2&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat2&quot;&gt;caomanhdat2&lt;/a&gt;. Assuming we&apos;re in the Overseer when we delete the collection, waiting in the delete process would likely be a bad idea given how many messages we have to deal with. Is there a way to skip performing an operation right now and put it back on the queue? I&apos;m thinking something like&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conflicting operations detected) {
    skip &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; command and put it back in the queue &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the next go-round
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I frankly don&apos;t know if that&apos;s desirable even if possible. If it&apos;s just to fix some tests, it seems too intrusive. If it&apos;d avoid real problems in non-test situations, then I&apos;m all for it.&lt;/p&gt;

&lt;p&gt;I&apos;ll add more when I have more clues.&lt;/p&gt;</comment>
                            <comment id="16945143" author="erickerickson" created="Sat, 5 Oct 2019 19:52:30 +0000"  >&lt;p&gt;I think I&apos;ve finally nailed down what&apos;s happening here.&lt;br/&gt;
The test I&apos;m concentrating on (TestSolrCLIRunExample.testInteractiveSolrCloudExample:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Is testing the example code with the &quot;1 50984 testCloudExamplePrompt 2 2 _default
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;I think the important part is it&apos;s using the _default (schemaless) configset.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;After that, it indexes a bunch of documents, which modify the schema&lt;/li&gt;
	&lt;li&gt;the schema modifications cause the cores to reload&lt;/li&gt;
	&lt;li&gt;the test deletes the collection &lt;em&gt;before&lt;/em&gt; the cores are fully reloaded and the coreDescriptor is removed&lt;/li&gt;
	&lt;li&gt;the metrics manager then relies on the coreDescriptor being there and then gets the NPE &apos;cause it&apos;s gone&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If I put a short delay in the test before deleting the collection, I can&apos;t get it to fail. Not a robust solution.&lt;/p&gt;

&lt;p&gt;I&apos;m trying a bunch of runs with a check that the overseer queues are empty, we&apos;ll see how that works.&lt;/p&gt;

&lt;p&gt;Any better suggestions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat2&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat2&quot;&gt;caomanhdat2&lt;/a&gt; Anybody? &lt;/p&gt;

&lt;p&gt;If I get a few thousand runs of this test without errors, I&apos;ll check it in. Again note that I&apos;m only concentration on one of the tests at present, so this suite may have other failures.&lt;/p&gt;
</comment>
                            <comment id="16946032" author="hossman" created="Mon, 7 Oct 2019 16:50:09 +0000"  >&lt;p&gt;it sounds like you&apos;ve identified a legitimate bug &lt;em&gt;in the code&lt;/em&gt;: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&quot;deleting a collection while core reloads are in progress causes errors&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...but your suggested change is &lt;em&gt;solely for the test&lt;/em&gt;: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&quot;wait an artificial amount of time after indexing documents just in case it&apos;s still reloading coes&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If the bug is in the code, then the code should be fixed to account for this possibility and not produce an error. &amp;#8211; why not fix the schema APIs zkWatcher to deal with core reload in a better way that won&apos;t produce these kinds of errors ...my impression from your earlier comments was that if a &lt;b&gt;user&lt;/b&gt; sent a core RELOAD command there are protections to prevent that command against these kinds of concurrency errors (while the CoreDescriptor is null) at the collections API level, correct?  so why not leverage those same APIs/protections?&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;However....  I&apos;d like to be very clear about something: &lt;b&gt;What you are describing does &lt;em&gt;not&lt;/em&gt; match what i see when reviewing the log messages in the attached &lt;tt&gt;apache_Lucene-Solr-Tests-8.x_449.log.txt&lt;/tt&gt; file&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;It&apos;s very possible you have identified an &lt;em&gt;additional&lt;/em&gt; bug &amp;#8211; but it&apos;s hard to be certain if that&apos;s true, since you haven&apos;t attached any log files demonstrating what you are describing.&lt;/p&gt;

&lt;p&gt;AFAICT In the currently attached &lt;tt&gt;apache_Lucene-Solr-Tests-8.x_449.log.txt&lt;/tt&gt; log file, I don&apos;t see any evidence that the &quot;client&quot; has sent a DELETE command for the collection &amp;#8211;  from the messages that are logged it seems like the &quot;schema api zkWatcher callback&quot; triggers a reload (which fails with NPE) &lt;em&gt;while the core is still loading for the first time&lt;/em&gt;.  Do you see any evidence in that log file that i&apos;m overlooking? (which indicates a DELETE has been requested?)&lt;/p&gt;

&lt;p&gt;In the case you described the &quot;error&quot; may not be that bad (misleading error messages for a collection right before it&apos;s deleted) but if in fact it&apos;s possible for this Schema zkWatcher to fail w/NPE _while a core is (independently) re/loading that means that a schema API call could result in a a schema modification that is ignored by one or more nodes, which could continute using the old schema.&lt;/p&gt;

</comment>
                            <comment id="16946265" author="erickerickson" created="Mon, 7 Oct 2019 21:36:29 +0000"  >&lt;p&gt;No, I&apos;m not suggesting that a wait in the test is the &lt;em&gt;correct&lt;/em&gt; fix. I stuck that in the test to try to see if I was on the right track. A pause just before tests deletes the collection seems to keep the error from happening.&lt;/p&gt;

&lt;p&gt;And yeah, I&apos;m trying to focus on one thing at a time. When I beasted the full test suite, there were multiple failures and it got &lt;em&gt;really&lt;/em&gt; frustrating to try to figure out what was going wrong....&lt;/p&gt;

&lt;p&gt;And to be clearer, the reload isn&apos;t a user-level reload AFAICT. I&apos;m pretty sure it&apos;s adding docs in schemaless mode that&apos;s triggering it.&lt;/p&gt;

&lt;p&gt;And I fully expect that if I manage to fix this sometime, other tests will fail in different ways....&lt;/p&gt;</comment>
                            <comment id="16946341" author="markrmiller@gmail.com" created="Mon, 7 Oct 2019 23:56:52 +0000"  >&lt;p&gt;Pretty sure I fix all this type of crap in my test fix JIRA. &lt;/p&gt;</comment>
                            <comment id="16946342" author="markrmiller@gmail.com" created="Mon, 7 Oct 2019 23:58:34 +0000"  >&lt;p&gt;Like many many of the more subtle and pernicious and pervasive and broad issues, it&#8217;s about not properly waiting for certain events that system does not do automatically for you for the most part.&lt;/p&gt;</comment>
                            <comment id="16946346" author="markrmiller@gmail.com" created="Tue, 8 Oct 2019 00:10:29 +0000"  >&lt;p&gt;In terms of if there is an actual bug here, we should make a specific test to target that reload / delete scenario. Often we are finding g these issues because the test is poor (because of the system or test framework usually, but nonetheless), not because it&#8217;s trying to test the situation found. Often that situation is not what we think and determining that a bug is happening vs a silly test  (or why exactly the bug is) gets a little dicey.&lt;/p&gt;</comment>
                            <comment id="16946845" author="erickerickson" created="Tue, 8 Oct 2019 13:15:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&quot;Pretty sure I fix all this type of crap in my test fix JIRA. &quot;&lt;/p&gt;

&lt;p&gt;Which one, and did you push it or is it on a branch? I haven&apos;t updated in a while so it would be very cool if it did. This test fails very rarely though (like 2-3 times out of 1,000).&lt;/p&gt;</comment>
                            <comment id="16946986" author="erickerickson" created="Tue, 8 Oct 2019 15:34:27 +0000"  >&lt;p&gt;Mark:&lt;/p&gt;

&lt;p&gt;I really don&apos;t care which branch, a better question is &quot;will I get these from a pull on Master or do I need to get one of your branches?&quot;.&lt;/p&gt;

&lt;p&gt;&apos;cause it looks like this a race condition between schemaless mode reloading the collection due to an update and the test deleting the collection rather than a use adding then deleting a collection quickly. Although if that&apos;s the case I don&apos;t understand why the search for the docs just added succeed. I guess to answer that I&apos;ll have to look into the interaction between schemaless and commit....&lt;/p&gt;</comment>
                            <comment id="17001746" author="erickerickson" created="Sat, 21 Dec 2019 16:45:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; any thoughts?&lt;/p&gt;

&lt;p&gt;I&apos;ve finally gotten back to this and think I&apos;m getting close. The short form is that I think the test calls delete collection before prior operations are complete.&lt;/p&gt;

&lt;p&gt;During a successful run, I see:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a bunch of reloads&lt;/li&gt;
	&lt;li&gt;a bunch of unloads&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The reloads seem OK, they&apos;re being run from 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SolrCore.getConfListener&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The unload is coming when the collection is being deleted near the end of the test.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;AFAIK, the only way the CoreDescriptor could be disappearing form the various lists is through unload and that&apos;s only being called by deleteCollection in this test.&lt;/p&gt;

&lt;p&gt;So what my next best guess is is that the reloads aren&apos;t complete by the time the test gets to the delete collection call and that&apos;s where the race condition is coming from.&lt;/p&gt;

&lt;p&gt;I&apos;m putting some more debugging, I want to see all thread dumps when the NPE occurs. I&apos;m wondering if the sequencing in from the Overseer is part of the problem, but that&apos;s a guess.&lt;/p&gt;</comment>
                            <comment id="17256997" author="erickerickson" created="Thu, 31 Dec 2020 13:25:26 +0000"  >&lt;p&gt;I won&apos;t be working on JIRAs for the foreseeable future&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12978245" name="apache_Lucene-Solr-Tests-8.x_449.log.txt" size="8210957" author="hossman" created="Thu, 22 Aug 2019 01:34:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05wns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>