<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:13:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8933] SolrDispatchFilter::consumeInput logs &quot;Stream Closed&quot; IOException</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8933</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8453&quot; title=&quot;Jetty update from 9.2 to 9.3 causes the server to reset formerly legitimate client connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8453&quot;&gt;&lt;del&gt;SOLR-8453&lt;/del&gt;&lt;/a&gt; we started seeing some IOExceptions coming out of SolrDispatchFilter with &quot;Stream Closed&quot; messages.&lt;/p&gt;

&lt;p&gt;It looks like we are indeed closing the request stream in several places when we really need to be letting the web container handle their life cycle. I&apos;ve got a preliminary patch ready and am working on testing it to make sure there are no regressions.&lt;/p&gt;

&lt;p&gt;A very strange piece of this is that I have been entirely unable to reproduce it on a unit test, but have seen it on cluster deployment quite consistently.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12955398">SOLR-8933</key>
            <summary>SolrDispatchFilter::consumeInput logs &quot;Stream Closed&quot; IOException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="mdrob">Mike Drob</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Apr 2016 19:35:24 +0000</created>
                <updated>Wed, 3 Jan 2018 22:46:40 +0000</updated>
                            <resolved>Sat, 18 Jun 2016 00:27:41 +0000</resolved>
                                    <version>4.10.3</version>
                                    <fixVersion>5.5.2</fixVersion>
                    <fixVersion>5.6</fixVersion>
                    <fixVersion>6.0.2</fixVersion>
                    <fixVersion>6.1</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15224501" author="mdrob" created="Mon, 4 Apr 2016 16:54:52 +0000"  >&lt;p&gt;Attaching a trunk patch.&lt;/p&gt;</comment>
                            <comment id="15226691" author="markrmiller@gmail.com" created="Tue, 5 Apr 2016 17:16:23 +0000"  >&lt;p&gt;SingleThreadedJsonLoader looks like it&apos;s off?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-comment&quot;&gt;// We won&apos;t close &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; stream because it belongs to ServletContainer Request
&lt;/span&gt;        Reader reader = stream.getReader();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (log.isTraceEnabled()) {
          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; body = IOUtils.toString(reader);
          log.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;body&quot;&lt;/span&gt;, body);
          reader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(body);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.processUpdate(reader);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ParseException e) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrException(SolrException.ErrorCode.BAD_REQUEST, &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot parse provided JSON: &quot;&lt;/span&gt; + e.getMessage());
      }
      
      parser = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JSONParser(reader);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.processUpdate();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15227115" author="mdrob" created="Tue, 5 Apr 2016 20:49:08 +0000"  >&lt;p&gt;Thanks for catching that, I had started with an unclean workspace. Here&apos;s an updated patch.&lt;/p&gt;</comment>
                            <comment id="15228355" author="markrmiller@gmail.com" created="Wed, 6 Apr 2016 14:36:23 +0000"  >&lt;p&gt;Can we clear up the report a bit? I&apos;m kind of confused as it is.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;SolrDispatchFilter::consumeInput logs &quot;Stream Closed&quot; IOException&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Have we ever actually seen that happen with Jetty or on trunk, or have we still only seen it with a version of 4.10.3 and Tomcat?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A very strange piece of this is that I have been entirely unable to reproduce it on a unit test, but have seen it on cluster deployment quite consistently.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Same question - a unit test on 4.10.3 version or trunk or both? Same with the the cluster deployment? Is that older? Tomcat or Jetty?&lt;/p&gt;

&lt;p&gt;Just trying to understand when we are talking about our 4.10.3 version, latest trunk, and Tomcat vs Jetty.&lt;/p&gt;

&lt;p&gt;Last I had seen, while we don&apos;t want to close these streams early regardless, on trunk with Jetty, it doesn&apos;t actually log anything or cause us any grief.&lt;/p&gt;
</comment>
                            <comment id="15228365" author="markrmiller@gmail.com" created="Wed, 6 Apr 2016 14:39:15 +0000"  >&lt;p&gt;Also, are we sure this patch catches all the spots this can happen on trunk? How did you track down each spot the streams are closed early?&lt;/p&gt;

&lt;p&gt;Is there any chance this can be added to forbidden APIs? Not sure offhand if it can actually cover this case. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thetaphi&quot; class=&quot;user-hover&quot; rel=&quot;thetaphi&quot;&gt;thetaphi&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15228392" author="thetaphi" created="Wed, 6 Apr 2016 14:52:51 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
Unfortunately you cannot prevent closing with forbiddenApis, because it would prevent all Closeable.close calls.&lt;/p&gt;

&lt;p&gt;My tip is to wrap the stream with a wrapper that intercepts close() in the dispatch filter. Lots of webapps are doing this.&lt;/p&gt;

&lt;p&gt;In my personal opinion, the server container should take care of preventing the close.&lt;/p&gt;

&lt;p&gt;Ioutils has a wrapper for this!&lt;/p&gt;</comment>
                            <comment id="15228467" author="mdrob" created="Wed, 6 Apr 2016 15:32:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;Have we ever actually seen that happen with Jetty or on trunk, or have we still only seen it with a version of 4.10.3 and Tomcat?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ve only seen it on 4.10.3 and Tomcat. As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thetaphi&quot; class=&quot;user-hover&quot; rel=&quot;thetaphi&quot;&gt;thetaphi&lt;/a&gt; alludes to later, Jetty might be taking care of this for us.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Also, are we sure this patch catches all the spots this can happen on trunk? How did you track down each spot the streams are closed early?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I wrapped the request and intercepted requests to close() and logged them with stack traces. I had removed this for the patch because I wasn&apos;t confident in the performance impact that I would be causing, but can easily add it back.&lt;/p&gt;</comment>
                            <comment id="15229100" author="markrmiller@gmail.com" created="Wed, 6 Apr 2016 21:00:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ve only seen it on 4.10.3 and Tomcat. As Uwe Schindler alludes to later, Jetty might be taking care of this for us.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay. Just want anyone reading this issue to be able to understand whether and how it might impact them. I still had not seen this have any effect with Jetty here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I wrapped the request and intercepted requests to close() and logged them with stack traces. I had removed this for the patch because I wasn&apos;t confident in the performance impact that I would be causing, but can easily add it back.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think we need it committed, just how you went about it documented. Since we can&apos;t forbid this from coming into the code again, we at  least want to make this easy on the next person who has to tackle it by getting this info in the ticket.&lt;/p&gt;

&lt;p&gt;Trunk and 6x will always diverge some too, so probably also good to note specifically which branch(s) has been cleared.&lt;/p&gt;</comment>
                            <comment id="15229102" author="mdrob" created="Wed, 6 Apr 2016 21:03:13 +0000"  >&lt;p&gt;I could put in the wrapping and instrumentation, and then hide it behind a flag. I&apos;ll look at doing that and upload a new patch.&lt;/p&gt;</comment>
                            <comment id="15230569" author="mdrob" created="Thu, 7 Apr 2016 17:02:23 +0000"  >&lt;p&gt;Did some further research on why this error doesn&apos;t show up with Jetty. It appears that &lt;tt&gt;HttpInput::close()&lt;/tt&gt; (the jetty-server implementation of ServletInputStream) is a no-op and takes care of the clean-up by calling &lt;tt&gt;recycle&lt;/tt&gt; at some later point. Unsure if it&apos;s worth the effort to be &lt;em&gt;technically&lt;/em&gt; correct without producing any impact otherwise.&lt;/p&gt;</comment>
                            <comment id="15230626" author="markrmiller@gmail.com" created="Thu, 7 Apr 2016 17:28:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Unsure if it&apos;s worth the effort to be technically correct&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we want to be technically correct here - we don&apos;t want to have to count on one specific impl protecting us from ourselves.&lt;/p&gt;</comment>
                            <comment id="15230672" author="mdrob" created="Thu, 7 Apr 2016 17:37:17 +0000"  >&lt;p&gt;Alright, here&apos;s another patch that adds the instrumentation hidden behind a system property.&lt;/p&gt;</comment>
                            <comment id="15230752" author="thetaphi" created="Thu, 7 Apr 2016 18:18:00 +0000"  >&lt;p&gt;Why not just enable it during &quot;test mode&quot;. So when a test executes, the wrapper is added. This can be done by a sysproperty, but we have one already: jetty.testmode or like that, which is set during running tests.&lt;/p&gt;</comment>
                            <comment id="15231085" author="mdrob" created="Thu, 7 Apr 2016 21:16:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;Ioutils has a wrapper for this!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Which IOUtils? I didn&apos;t see this in &lt;tt&gt;o.a.lucene.util&lt;/tt&gt; or &lt;tt&gt;o.a.solr.common.util&lt;/tt&gt;. I&apos;m currently adding a new class &lt;tt&gt;CloseShieldServletInputStream&lt;/tt&gt; inspired by the Apache commons-io &lt;tt&gt;CloseShieldInputStream&lt;/tt&gt; which was almost good enough to use. There&apos;s maybe some clever way to handle this via generics, reflection, and proxies, but I think that suffers in terms of maintainability.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why not just enable it during &quot;test mode&quot;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done. Originally I thought there was value in fine grained control to enable the warning, but at this point I&apos;m not convinced that is true.&lt;/p&gt;</comment>
                            <comment id="15231109" author="thetaphi" created="Thu, 7 Apr 2016 21:31:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;Which IOUtils? I didn&apos;t see this in o.a.lucene.util or o.a.solr.common.util.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry I was thinking of commons-io instead of IOUtils. Was a typo!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;CloseShieldServletInputStream inspired by the Apache commons-io CloseShieldInputStream which was almost good enough to use. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would just use the CloseShieldInputStream. The additional APIs provided by ServletInputStream or ServletOutputStream are not used by Solr. Actually we put some of them to the forbidden-apis list (because of stupidity and ISO-8859-1 defaults from earlier days). See lucene/tools/forbiddenApis/servlet-api.txt&lt;/p&gt;

&lt;p&gt;I looked at this. There is no penalty by the wrapping - so you can also do it by default (with CloseShieldInputStream, no specialization). This is just optimized away... A method that just delegates to another methods is &lt;b&gt;always&lt;/b&gt; removed by the VM.&lt;/p&gt;</comment>
                            <comment id="15231146" author="mdrob" created="Thu, 7 Apr 2016 21:46:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would just use the CloseShieldInputStream. The additional APIs provided by ServletInputStream or ServletOutputStream are not used by Solr. Actually we put some of them to the forbidden-apis list (because of stupidity and ISO-8859-1 defaults from earlier days). See lucene/tools/forbiddenApis/servlet-api.txt&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Doesn&apos;t matter that we don&apos;t use the extra APIs, the type signature of &lt;tt&gt;ServletRequest::getInputStream&lt;/tt&gt; still demands a &lt;tt&gt;ServletInputStream&lt;/tt&gt; so that is what we have to return when wrapping the request object. The other option is to go even deeper down the hierarchy, cast to &lt;tt&gt;org.eclipse.jetty.server.Request&lt;/tt&gt; and then manipulate the input stream directly from there, but that feels much more invasive and brittle.&lt;/p&gt;</comment>
                            <comment id="15231700" author="thetaphi" created="Fri, 8 Apr 2016 06:16:20 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Doesn&apos;t matter that we don&apos;t use the extra APIs, the type signature of ServletRequest::getInputStream still demands a ServletInputStream so that is what we have to return when wrapping the request object. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I see you are wrapping the whole ServletRequest.&lt;/p&gt;

&lt;p&gt;In any case, I skimmed through the patch: There is one problem. You don&apos;t close ContentStream&apos;s InputStream anymore. But there are cases in Solr, where the ContentStream does not come from a Request, but from somewhere else: It could also be the &quot;virtual&quot; stream from the URL param (OK this one does not need to be closed), but it could also be a remote stream e.g,, if you pass a stream.url parameter to the servlet. In that case it is never closed.&lt;/p&gt;

&lt;p&gt;This would then be a bug!!! I&apos;d suggest to do the following: Always wrap with CloseShield in DispatchFilter and ignore the close without logging anything (for safety with non-Jetty or later Jetty versions) and revert all other changes in Solr. To me it is unnatural to not close a stream after you have consumed it. I&apos;d also change the consumers to try-with-resources.&lt;/p&gt;

&lt;p&gt;The ContentStream tests are using remote streams (actually a &lt;a href=&quot;file://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://&lt;/a&gt; URL for testing). So on Windows, tests should fail with a resource leak there.&lt;/p&gt;</comment>
                            <comment id="15232076" author="markrmiller@gmail.com" created="Fri, 8 Apr 2016 11:57:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;To me it is unnatural to not close a stream after you have consumed it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t like closing it at all. I think in java it is natural - you close the streams you create, not the open streams that are passed to you.&lt;/p&gt;</comment>
                            <comment id="15232084" author="markrmiller@gmail.com" created="Fri, 8 Apr 2016 12:00:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;You don&apos;t close ContentStream&apos;s InputStream anymore.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That sounds like perhaps ContentStream should be closed and understand more about the lifecycle of the inputstream it&apos;s using so that only streams it owns are closed.&lt;/p&gt;

&lt;p&gt;It really seems strange to count on this Jetty impl detail and close streams we don&apos;t own.&lt;/p&gt;</comment>
                            <comment id="15232215" author="mdrob" created="Fri, 8 Apr 2016 13:58:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;The ContentStream tests are using remote streams (actually a &lt;a href=&quot;file://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://&lt;/a&gt; URL for testing). So on Windows, tests should fail with a resource leak there.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The cases in &lt;tt&gt;ContentStreamTest&lt;/tt&gt; are still closing everything. I don&apos;t understand what the relation there is. I haven&apos;t tested with Windows though, so maybe there is additional nuance I am missing.&lt;/p&gt;

&lt;p&gt;I found the part where we are processing remote stream parameter to set the content stream... Maybe it makes sense to make ContentStream implement Closeable and then we can know to close the URL and File streams but not the Servlet, Byte, or String streams. They&apos;re all build from the Request in &lt;tt&gt;SolrRequestParsers::parse&lt;/tt&gt; - at which point we can make that determination.&lt;/p&gt;

&lt;p&gt;The next question becomes then, who is responsible for closing the ContentStream? It&apos;s easy to make the SolrRequest responsible for the ContentStreams it creates, but I am not sure if there are other cases. And there are too many warnings in the project for me to reliably tell what I&apos;m missing.&lt;/p&gt;

&lt;p&gt;Here&apos;s a proposed patch heading down this path, likely incomplete.&lt;/p&gt;</comment>
                            <comment id="15232670" author="mdrob" created="Fri, 8 Apr 2016 18:30:09 +0000"  >&lt;p&gt;A more thorough patch. I think I got everything in this one, but the usages I tracked down were all found via eclipse &apos;find usage.&apos; There might be more.&lt;/p&gt;</comment>
                            <comment id="15235264" author="mdrob" created="Mon, 11 Apr 2016 15:16:11 +0000"  >&lt;p&gt;So it occurred to me that we &lt;em&gt;might&lt;/em&gt; be able to get away with wrapping the &lt;tt&gt;HttpRequestContentStream&lt;/tt&gt; in a &lt;tt&gt;CloseShieldInputStream&lt;/tt&gt; for minimal changes, assuming that everything else in the code base behaves consistently by reading the content stream and not the stream from the request, and then let various handlers/parsers/etc. still try to close the stream when they are done.&lt;/p&gt;</comment>
                            <comment id="15238192" author="mdrob" created="Tue, 12 Apr 2016 23:04:05 +0000"  >&lt;p&gt;Attaching a much simpler patch that I think still addresses the underlying issue of relying on Jetty&apos;s no-op close impl.&lt;/p&gt;</comment>
                            <comment id="15239689" author="markrmiller@gmail.com" created="Wed, 13 Apr 2016 17:52:47 +0000"  >&lt;p&gt;What about the outputstream? We should give that the same treatment.&lt;/p&gt;</comment>
                            <comment id="15239738" author="markrmiller@gmail.com" created="Wed, 13 Apr 2016 18:12:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;ServletInputStreamWrapper&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s add a class comment that mentions why this exists.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;+      if (System.getProperty(&quot;jetty.testMode&quot;) != null &amp;amp;&amp;amp; !retry) {&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I really don&apos;t like introducing any memory barriers for this at such an important code path. I wonder if we could use an assert and private method somehow. &lt;/p&gt;

&lt;p&gt;It seems that even if it works, it&apos;s less than ideal to make it a static member and count on initialize vs setting the test sys prop order, but perhaps that is an option as well?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;new CloseShieldInputStream&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s worth adding a small comment when we use this that says something like: protect container owned streams from being closed by Solr, see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;log.warn(&quot;&quot;, new IOException(&quot;Attempted close of request input stream.&quot;));&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Since this is test logging, perhaps it should be ERROR so that violators feel worse about it if they see the logging. Warnings are easy to ignore.&lt;/p&gt;</comment>
                            <comment id="15240464" author="mdrob" created="Thu, 14 Apr 2016 02:19:55 +0000"  >&lt;p&gt;Patch that adds docs and provides the same treatment to (most) output streams.&lt;/p&gt;

&lt;p&gt;I decided to leave the log messages at warn since even if they appear, the problem has been largely mitigated away already.&lt;/p&gt;</comment>
                            <comment id="15240562" author="markrmiller@gmail.com" created="Thu, 14 Apr 2016 04:21:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;the problem has been largely mitigated away already.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then there should be no reason to introduce this test code path into the production code.&lt;/p&gt;

&lt;p&gt;I think there is good reason though - to make sure users of this API use it properly. If we are going to try and fix this at all, we want to maintain it rather than reverting to counting on Jetties internal impl. That is what the test mode code is all about. So I think Error is more appropriate than INFO, but actually...&lt;/p&gt;

&lt;p&gt;Which makes me think, actually, more than logging at Error level, we should probably fail an assert there and prevent tests from passing. We are looking to enforce this if we can - a logging indicator only would be worst case I think.&lt;/p&gt;

&lt;p&gt;We want the build to fail when someone adds some new code and it does not use a shield but should.&lt;/p&gt;</comment>
                            <comment id="15240576" author="mdrob" created="Thu, 14 Apr 2016 04:38:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Which makes me think, actually, more than logging at Error level, we should probably fail an assert there and prevent tests from passing. We are looking to enforce this if we can - a logging indicator only would be worst case I think.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes! This makes sense to me, now that you bring it up. I&apos;m not used to using asserts on other projects, but they make sense here.&lt;/p&gt;

&lt;p&gt;Attaching a patch that uses asserts instead of logging. (Should it do both, on the off chance that testMode is enabled but asserts are disabled?)&lt;/p&gt;

&lt;p&gt;I have not run the full test suite on this yet, I&apos;ll let it go overnight and see what shakes out, but wanted to get the patch up for more eyes first.&lt;/p&gt;</comment>
                            <comment id="15246237" author="mdrob" created="Mon, 18 Apr 2016 18:21:38 +0000"  >&lt;p&gt;Ran the tests, most of them looked fine, there were a few that failed but passed when I reran them so I didn&apos;t take too much note.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thetaphi&quot; class=&quot;user-hover&quot; rel=&quot;thetaphi&quot;&gt;thetaphi&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; - what do y&apos;all think?&lt;/p&gt;</comment>
                            <comment id="15246548" author="thetaphi" created="Mon, 18 Apr 2016 21:14:04 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
I am fine with the way how it is handles by SolrRequestParsers. This was my only complaint.&lt;/p&gt;

&lt;p&gt;I do not take care if we should rely on streams not closed or keep them open, I was just afraid of resource leaks because ContentStreams were not closed anymore in earlier patches. But this is perfectly solved by commons-io CloseShield just inside SolrRequestParsers. For everything else (preventing closing of the underlying ServletStreams) inside SolrDispatchFilter: I have no strong preference. But code looks fine. I leave that open to You and Mark how to handle this..&lt;/p&gt;</comment>
                            <comment id="15248770" author="markrmiller@gmail.com" created="Tue, 19 Apr 2016 22:05:26 +0000"  >&lt;p&gt;I see some tests now fail due to the new assert. Seems there are some closes we don&apos;t shield still.&lt;/p&gt;</comment>
                            <comment id="15249148" author="mdrob" created="Wed, 20 Apr 2016 02:35:47 +0000"  >&lt;p&gt;I thought I got all of the test failures previously, looks like I missed two usages though. Pretty confident that I got them this time, thanks for verifying as well, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15251776" author="markrmiller@gmail.com" created="Thu, 21 Apr 2016 12:13:16 +0000"  >&lt;p&gt;This switches to using an assert to enable the test code rather than the system property. We don&apos;t always necessarily use jetty.testMode and we would like to be sure this is checked for every test. I did have to add a system property to turn off the check for JettyWebappTest though (jetty code closes the stream but it trips our protection assert).&lt;/p&gt;</comment>
                            <comment id="15251859" author="markrmiller@gmail.com" created="Thu, 21 Apr 2016 12:58:17 +0000"  >&lt;p&gt;I&apos;m also going to randomly disable the test mode in SolrDispatchFilter so we are sure all tests will also run properly without this code.&lt;/p&gt;</comment>
                            <comment id="15252194" author="jira-bot" created="Thu, 21 Apr 2016 16:54:24 +0000"  >&lt;p&gt;Commit f3de22377486e88ed12427c3bbd3a89c7c051328 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f3de223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f3de223&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;: Solr should not close container streams.&lt;/p&gt;</comment>
                            <comment id="15268795" author="jira-bot" created="Tue, 3 May 2016 14:30:02 +0000"  >&lt;p&gt;Commit 95c5d92f109b4aa9cbffcfaf0802be266157c1f5 in lucene-solr&apos;s branch refs/heads/branch_6x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=95c5d92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=95c5d92&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;: Solr should not close container streams.&lt;/p&gt;</comment>
                            <comment id="15268802" author="markrmiller@gmail.com" created="Tue, 3 May 2016 14:36:12 +0000"  >&lt;p&gt;Thanks Mike!&lt;/p&gt;</comment>
                            <comment id="15277145" author="hossman" created="Mon, 9 May 2016 22:02:31 +0000"  >
&lt;p&gt;Manually correcting fixVersion per Step #S5 of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-7271&quot; title=&quot;Cleanup jira&amp;#39;s concept of &amp;#39;master&amp;#39; and &amp;#39;6.0&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-7271&quot;&gt;&lt;del&gt;LUCENE-7271&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15337291" author="steve_rowe" created="Sat, 18 Jun 2016 00:23:29 +0000"  >&lt;p&gt;Reopening to backport to 6.0.2, 5.6 and 5.5.2.&lt;/p&gt;</comment>
                            <comment id="15337311" author="jira-bot" created="Sat, 18 Jun 2016 00:27:31 +0000"  >&lt;p&gt;Commit 2049471579db8775dd3df01fd1386c7f43ed4b0e in lucene-solr&apos;s branch refs/heads/branch_5_5 from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2049471&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2049471&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;: Solr should not close container streams.&lt;/p&gt;</comment>
                            <comment id="15337312" author="jira-bot" created="Sat, 18 Jun 2016 00:27:33 +0000"  >&lt;p&gt;Commit 9c81c77baec53fd60163a3e1d2a4489e081f2eaa in lucene-solr&apos;s branch refs/heads/branch_5x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9c81c77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9c81c77&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;: Solr should not close container streams.&lt;/p&gt;</comment>
                            <comment id="15337313" author="jira-bot" created="Sat, 18 Jun 2016 00:27:34 +0000"  >&lt;p&gt;Commit f6d40e3e668a0c5cd4f11493f11afeaf1a45d267 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f6d40e3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f6d40e3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;: Remove misplaced CHANGES entry&lt;/p&gt;</comment>
                            <comment id="15337314" author="jira-bot" created="Sat, 18 Jun 2016 00:27:35 +0000"  >&lt;p&gt;Commit 6f8d306ea8ca96c4c6edfffcfed7c300d328716a in lucene-solr&apos;s branch refs/heads/branch_6_0 from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6f8d306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6f8d306&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8933&quot; title=&quot;SolrDispatchFilter::consumeInput logs &amp;quot;Stream Closed&amp;quot; IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8933&quot;&gt;&lt;del&gt;SOLR-8933&lt;/del&gt;&lt;/a&gt;: Solr should not close container streams.&lt;/p&gt;</comment>
                            <comment id="15349805" author="steve_rowe" created="Sat, 25 Jun 2016 20:33:53 +0000"  >&lt;p&gt;Bulk close issues released with 5.5.2.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13128328">SOLR-11814</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12799946" name="SOLR-8933.patch" size="23387" author="markrmiller@gmail.com" created="Thu, 21 Apr 2016 12:13:16 +0000"/>
                            <attachment id="12799650" name="SOLR-8933.patch" size="21325" author="mdrob" created="Wed, 20 Apr 2016 02:35:47 +0000"/>
                            <attachment id="12798647" name="SOLR-8933.patch" size="19055" author="mdrob" created="Thu, 14 Apr 2016 04:38:51 +0000"/>
                            <attachment id="12798632" name="SOLR-8933.patch" size="19087" author="mdrob" created="Thu, 14 Apr 2016 02:19:55 +0000"/>
                            <attachment id="12798395" name="SOLR-8933.patch" size="7844" author="mdrob" created="Tue, 12 Apr 2016 23:04:05 +0000"/>
                            <attachment id="12797771" name="SOLR-8933.patch" size="23500" author="mdrob" created="Fri, 8 Apr 2016 18:30:09 +0000"/>
                            <attachment id="12797730" name="SOLR-8933.patch" size="23500" author="mdrob" created="Fri, 8 Apr 2016 13:58:36 +0000"/>
                            <attachment id="12797613" name="SOLR-8933.patch" size="17235" author="mdrob" created="Thu, 7 Apr 2016 21:16:12 +0000"/>
                            <attachment id="12797564" name="SOLR-8933.patch" size="17352" author="mdrob" created="Thu, 7 Apr 2016 17:37:17 +0000"/>
                            <attachment id="12797166" name="SOLR-8933.patch" size="10964" author="mdrob" created="Tue, 5 Apr 2016 20:49:08 +0000"/>
                            <attachment id="12796855" name="SOLR-8933.patch" size="11044" author="mdrob" created="Mon, 4 Apr 2016 16:54:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 21 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vj7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>