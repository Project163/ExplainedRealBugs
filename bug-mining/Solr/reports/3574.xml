<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:26:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6086] Replica active during Warming</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6086</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;At least with Solr 4.6.1, replica are considered as active during the warming process.&lt;/p&gt;

&lt;p&gt;This means that if you restart a replica or create a new one, queries will  &lt;br/&gt;
be send to this replica and the query will hang until the end of the warming  &lt;br/&gt;
process (If cold searchers are not used).&lt;/p&gt;

&lt;p&gt;You cannot add or restart a node silently anymore.&lt;/p&gt;

&lt;p&gt;I think that the fact that the replica is active is not a bad thing.&lt;br/&gt;
But, the HttpShardHandler and the CloudSolrServer class should take the warming process in account.&lt;/p&gt;

&lt;p&gt;Currently, I have developped a new very simple component which check that a searcher is registered.&lt;br/&gt;
I am also developping custom HttpShardHandler and CloudSolrServer classes which will check the warming process in addition to the ACTIVE status in the cluster state.&lt;/p&gt;

&lt;p&gt;This seems to be more a workaround than a solution but that&apos;s all I can do in this version.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12714747">SOLR-6086</key>
            <summary>Replica active during Warming</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="lboutros">Ludovic Boutros</reporter>
                        <labels>
                            <label>difficulty-medium</label>
                            <label>impact-medium</label>
                    </labels>
                <created>Fri, 16 May 2014 11:08:04 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:28 +0000</updated>
                            <resolved>Mon, 31 Jul 2017 02:55:54 +0000</resolved>
                                    <version>4.6.1</version>
                    <version>4.8.1</version>
                                    <fixVersion>7.1</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="259200">72h</timeoriginalestimate>
                            <timeestimate seconds="259200">72h</timeestimate>
                                        <comments>
                            <comment id="14004856" author="lboutros" created="Wed, 21 May 2014 16:21:13 +0000"  >&lt;p&gt;I checked the differences in the logs and in the code.&lt;/p&gt;

&lt;p&gt;The problem occures when:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a node is restarted&lt;/li&gt;
	&lt;li&gt;Peer Sync failed (no &quot;/get&quot; handler for instance, should it become mandatory ?)&lt;/li&gt;
	&lt;li&gt;the node is already synced (nothing to replicate)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;or :&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a node is restarted and this is the leader (I do not know if it only appends with a lonely leader...)&lt;/li&gt;
	&lt;li&gt;the node is already synced (nothing to replicate)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the first case,&lt;/p&gt;

&lt;p&gt;I think this is a side effect of the modification in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4965&quot; title=&quot;avoid commit creating new segments file if no changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4965&quot;&gt;&lt;del&gt;SOLR-4965&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;If Peer Sync is succesfull, in the code an explicit commit is called. And there&apos;s a comment which says:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;RecoveryStrategy.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-comment&quot;&gt;// force open a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; searcher
&lt;/span&gt;            core.getUpdateHandler().commit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommitUpdateCommand(req, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is not the case if Peer Sync failed.&lt;br/&gt;
Just adding this line is enough to correct this issue.&lt;/p&gt;

&lt;p&gt;Here is a patch with a test which reproduces the problem and the correction (to be applied to the branch 4x).&lt;/p&gt;

&lt;p&gt;I am working on the second case.&lt;/p&gt;</comment>
                            <comment id="14005856" author="lboutros" created="Thu, 22 May 2014 12:09:01 +0000"  >&lt;p&gt;Second patch which also solves the second case.&lt;/p&gt;

&lt;p&gt;A second test added too.&lt;/p&gt;

&lt;p&gt;These two tests are quite slow: more than 2 minutes on my machine, is it an issue ?&lt;/p&gt;

</comment>
                            <comment id="14166830" author="martin.grotzke" created="Fri, 10 Oct 2014 13:25:51 +0000"  >&lt;p&gt;Is this really the case? Why are nodes that are not yet able to serve queries consideres being active?&lt;/p&gt;</comment>
                            <comment id="16021338" author="thelabdude" created="Tue, 23 May 2017 15:32:36 +0000"  >&lt;p&gt;Here&apos;s a patch I cooked up for this issue (against 6.3.0) ... it&apos;s not ready to commit and needs a test, but does resolve my issue.&lt;/p&gt;</comment>
                            <comment id="16101141" author="shalinmangar" created="Wed, 26 Jul 2017 04:01:28 +0000"  >&lt;p&gt;Here is patch with the fix and tests.&lt;/p&gt;

&lt;p&gt;All in all, the following are the ways which cause this issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Replica is the only one in the shard &amp;#8211; hence on startup becomes leader, skips recovery, becomes active without waiting for warming to complete&lt;/li&gt;
	&lt;li&gt;Replica goes into recovery, discovers that it is the leader, becomes active without waiting for warming to complete&lt;/li&gt;
	&lt;li&gt;When peersync fails but replication reports that there is nothing to replicate then replica becomes active without waiting for warming to complete. This can happen in the following ways:
	&lt;ol&gt;
		&lt;li&gt;peersync could be skipped if firstTime=false which can happen if recovering on startup we discover that last operation in ulog had flag gap set&lt;/li&gt;
		&lt;li&gt;peersync could be skipped if firstTime=false because the previous recovery attempt failed and we&apos;re retrying recovery&lt;/li&gt;
		&lt;li&gt;peersync could fail if the peersync request failed due to exceptions&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The fix in this patch (based on Tim&apos;s patch) ensure that there is a registered searcher before we publish any replica as active. Doing it inside RecoveryStrategy was not sufficient because that does not cover scenario 1. The tests in this patch inject failure into peer sync and simulate wrong index fingerprint computation to reproduce the problem. The scenarios that I could not reliably simulate were 2 and 3.1 but the fix should cover both of them. Tim&apos;s patch had a bug where openSearcher was called without returnSearcher=true. This can return a null future sometimes if there is an on deck searcher already and no new registration is needed. The correct fix is to send returnSearcher=true as well as waitFuture and check for both.&lt;/p&gt;</comment>
                            <comment id="16106738" author="shalinmangar" created="Mon, 31 Jul 2017 02:29:02 +0000"  >&lt;p&gt;The test in the earlier patch was flaky. This patch fixes those test problems. I beasted this test 200 times to be sure. This is ready.&lt;/p&gt;</comment>
                            <comment id="16106752" author="jira-bot" created="Mon, 31 Jul 2017 02:54:42 +0000"  >&lt;p&gt;Commit 90da5ce81cea82424dad6ba9ab1bf12d34d196e2 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=90da5ce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=90da5ce&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6086&quot; title=&quot;Replica active during Warming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6086&quot;&gt;&lt;del&gt;SOLR-6086&lt;/del&gt;&lt;/a&gt;: Replica is active during autowarming resulting in queries being sent to a replica that may not have a registered searcher. This causes spikes in response times when adding a replica in busy clusters&lt;/p&gt;</comment>
                            <comment id="16106753" author="jira-bot" created="Mon, 31 Jul 2017 02:54:44 +0000"  >&lt;p&gt;Commit b1a65c8f5572004cabc2b8d5548bf07f22fd2b3e in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b1a65c8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b1a65c8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6086&quot; title=&quot;Replica active during Warming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6086&quot;&gt;&lt;del&gt;SOLR-6086&lt;/del&gt;&lt;/a&gt;: Remove unused import&lt;/p&gt;</comment>
                            <comment id="16106754" author="shalinmangar" created="Mon, 31 Jul 2017 02:55:54 +0000"  >&lt;p&gt;Thanks Ludovic and Tim!&lt;/p&gt;</comment>
                            <comment id="16107189" author="lboutros" created="Mon, 31 Jul 2017 11:54:45 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16107332" author="jira-bot" created="Mon, 31 Jul 2017 13:52:56 +0000"  >&lt;p&gt;Commit 7aeef02bdf515b33a93e0e3a460ac461b8f70165 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7aeef02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7aeef02&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6086&quot; title=&quot;Replica active during Warming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6086&quot;&gt;&lt;del&gt;SOLR-6086&lt;/del&gt;&lt;/a&gt;: Replica is active during autowarming resulting in queries being sent to a replica that may not have a registered searcher. This causes spikes in response times when adding a replica in busy clusters&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 90da5ce)&lt;/p&gt;</comment>
                            <comment id="16107333" author="jira-bot" created="Mon, 31 Jul 2017 13:52:58 +0000"  >&lt;p&gt;Commit 98f90094305628198866a52d2bd9289002cbbe9c in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=98f9009&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=98f9009&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6086&quot; title=&quot;Replica active during Warming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6086&quot;&gt;&lt;del&gt;SOLR-6086&lt;/del&gt;&lt;/a&gt;: Remove unused import&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b1a65c8)&lt;/p&gt;</comment>
                            <comment id="16107334" author="shalinmangar" created="Mon, 31 Jul 2017 13:53:47 +0000"  >&lt;p&gt;I had forgotten to cherry pick the changes on branch_7x. I just did that now.&lt;/p&gt;</comment>
                            <comment id="16207454" author="shalinmangar" created="Tue, 17 Oct 2017 11:04:18 +0000"  >&lt;p&gt;Bulk close after 7.1.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13108362">SOLR-11463</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12869475" name="SOLR-6086-temp.patch" size="3382" author="thelabdude" created="Tue, 23 May 2017 15:32:36 +0000"/>
                            <attachment id="12879553" name="SOLR-6086.patch" size="25739" author="shalin" created="Mon, 31 Jul 2017 02:27:40 +0000"/>
                            <attachment id="12878943" name="SOLR-6086.patch" size="21440" author="shalin" created="Wed, 26 Jul 2017 03:53:30 +0000"/>
                            <attachment id="12646282" name="SOLR-6086.patch" size="30118" author="lboutros" created="Thu, 22 May 2014 12:09:01 +0000"/>
                            <attachment id="12646037" name="SOLR-6086.patch" size="21897" author="lboutros" created="Wed, 21 May 2014 16:21:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393060</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1voon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393227</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>