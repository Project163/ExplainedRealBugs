<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:00:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14630] CloudSolrClient doesn&apos;t pick correct core when server contains more shards</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14630</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Precondition: create collection with 4 shards on one server.&lt;/p&gt;

&lt;p&gt;During search and update, solr cloud client picks wrong core even &lt;em&gt;route&lt;/em&gt; exists in query param. In BaseSolrClient class, method sendRequest,&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sortedReplicas.forEach( replica -&amp;gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (seenNodes.add(replica.getNodeName())) {
    theUrlList.add(ZkCoreNodeProps.getCoreUrl(replica.getBaseUrl(), joinedInputCollections));
  }
});

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Previous part of code adds base url(localhost:8983/solr/collection_name) to theUrlList, it doesn&apos;t create core address(localhost:8983/solr/core_name). If we change previous code to:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sortedReplicas.forEach(replica -&amp;gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (seenNodes.add(replica.getNodeName())) {
        theUrlList.add(replica.getCoreUrl());
    }
});&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Solr cloud client picks core which is defined with&#160; &lt;em&gt;route&lt;/em&gt; parameter.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13315202">SOLR-14630</key>
            <summary>CloudSolrClient doesn&apos;t pick correct core when server contains more shards</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="idjurasevic">Ivan Djurasevic</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Jul 2020 17:36:19 +0000</created>
                <updated>Fri, 21 Jul 2023 20:40:37 +0000</updated>
                            <resolved>Wed, 31 May 2023 12:43:43 +0000</resolved>
                                    <version>8.5.1</version>
                    <version>8.5.2</version>
                                    <fixVersion>9.3</fixVersion>
                                    <component>SolrCloud</component>
                    <component>SolrJ</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>13</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17160863" author="dsmiley" created="Mon, 20 Jul 2020 03:26:57 +0000"  >&lt;p&gt;While I appreciate your code level diagnosis, I&apos;m less then sure I understand what the problem is in the first place. &#160;Can you please describe a series of simple steps that illustrate a problem? &#160;And without pointing to Solr code to show the problem; it should be externally observable if it&apos;s as serious as the Jira issue title here suggests. &#160;It&apos;s not clear if the problem you describe depends on use of the &amp;#95;route_ param or not; if it&apos;s not needed then don&apos;t use it in the reproduction steps. &#160;If documents are indexed in the &quot;wrong&quot; core, as I think you say, then you could simply demonstrate an inconsistency in document placement when the shards are located on the same server. &#160;&lt;tt&gt;fl=id,&lt;span class=&quot;error&quot;&gt;&amp;#91;shard&amp;#93;&lt;/span&gt;&lt;/tt&gt; on a query tells you where the doc came from. &#160;If you confirm this with a proposal numShards and docId then I&apos;ll &quot;see&quot; for myself.&lt;/p&gt;</comment>
                            <comment id="17164594" author="cpoerschke" created="Fri, 24 Jul 2020 18:57:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=idjurasevic&quot; class=&quot;user-hover&quot; rel=&quot;idjurasevic&quot;&gt;idjurasevic&lt;/a&gt;. Here&apos;s how i understood your description:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Precondition: create collection with 4 shards on one server.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There are four different URLs, all on the same port number, e.g.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;localhost:8983/solr/collection1_shard1_replica1&lt;/li&gt;
	&lt;li&gt;localhost:8983/solr/collection1_shard2_replica1&lt;/li&gt;
	&lt;li&gt;localhost:8983/solr/collection1_shard3_replica1&lt;/li&gt;
	&lt;li&gt;localhost:8983/solr/collection1_shard4_replica1&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;... route exists in query param ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Taking an example from &lt;a href=&quot;https://lucene.apache.org/solr/guide/8_5/solrcloud-query-routing-and-read-tolerance.html#_route_-parameter&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lucene.apache.org/solr/guide/8_5/solrcloud-query-routing-and-read-tolerance.html#_route_-parameter&lt;/a&gt; we have a query equivalent to &lt;tt&gt;&lt;a href=&quot;http://localhost:8983/solr/collection1/select?q=*:*&amp;amp;_route_=user1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/collection1/select?q=*:*&amp;amp;_route_=user1&lt;/a&gt;!&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The exact value of the &lt;tt&gt;&lt;em&gt;route&lt;/em&gt;&lt;/tt&gt; parameter is not important, but the presence of the &lt;tt&gt;&lt;em&gt;route&lt;/em&gt;&lt;/tt&gt; parameter is important. Via the &lt;tt&gt;&lt;em&gt;route&lt;/em&gt;&lt;/tt&gt; parameter we want to target one of the four shards. Let&apos;s target shard2.&lt;/p&gt;

&lt;p&gt;The BaseCloudSolrClient class considers the &lt;tt&gt;&lt;em&gt;route&lt;/em&gt;&lt;/tt&gt; parameter e.g. at &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1090-L1099&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1090-L1099&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1129-L1133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1129-L1133&lt;/a&gt; is reached the sortedReplicas list presumably contains only one element, the one for shard2.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;... Previous part of code adds base url(localhost:8983/solr/collection_name) to theUrlList, it doesn&apos;t create core address(localhost:8983/solr/core_name). ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;At line &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1131&lt;/a&gt; the url &lt;tt&gt;localhost:8983/solr/collection1&lt;/tt&gt; rather than &lt;tt&gt;localhost:8983/solr/collection1_shard2_replica1&lt;/tt&gt; is chosen.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Now what happens next?&lt;/b&gt; Some possibilities:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The request goes to &lt;tt&gt;localhost:8983/solr/collection1&lt;/tt&gt; and sometimes reaches shard2 and sometimes reaches another shard.&lt;/li&gt;
	&lt;li&gt;The request goes to &lt;tt&gt;localhost:8983/solr/collection1&lt;/tt&gt; and always reaches a particular shard e.g. shard1 but that is not the intended shard2.&lt;/li&gt;
	&lt;li&gt;The request goes to the wrong shard and the wrong search results are returned.&lt;/li&gt;
	&lt;li&gt;The request goes to the wrong shard who then forwards to the correct shard. The correct search results are returned but performance is inefficient because of the forwarding.&lt;/li&gt;
	&lt;li&gt;Something else.&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;... a series of simple steps that illustrate a problem? ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thinking out aloud ... indexing exactly four documents, one for each of the four shards, can make a simple collection.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;... externally observable ... &lt;tt&gt;fl=id,&lt;span class=&quot;error&quot;&gt;&amp;#91;shard&amp;#93;&lt;/span&gt;&lt;/tt&gt;} on a query tells you where the doc came from. ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If the wrong results are returned the &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;shard&amp;#93;&lt;/span&gt;&lt;/tt&gt; part of the results would tell. And if the results are correct but the routing unexpected then might this be observable via the logs?&lt;/p&gt;</comment>
                            <comment id="17172998" author="idjurasevic" created="Fri, 7 Aug 2020 08:46:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cpoerschke&quot; class=&quot;user-hover&quot; rel=&quot;cpoerschke&quot;&gt;cpoerschke&lt;/a&gt;&#160;I&apos;m sorry for late response. &lt;b&gt;First, i want to say that search and update are working, there are no problems with that operations.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Update and search are working because request is forwarded to correct shard from wrong shard.&#160; &#160;&lt;/p&gt;

&lt;p&gt;Main problems are overhead forwarding requests and loosing parameters from update parameters during forwarding requests. When we perform batch update we send some parameters(for example language code) in update request parameters, after that in update request processor chain we use that parameters(language code) and with them we create field names(SOURCE_EN_STORE, SOURCE_EN_NGRAM, SOURCE_EN_FUZZY, ...).&lt;/p&gt;

&lt;p&gt;To be more precise, client(application) creates documents with field (SOURCE=text), and set language English (en) in update request. In update request processor chain with SOURCE field and locale code from update request parameters we create new fields(SOURCE_EN_STORE, SOURCE_EN_NGRAM, SOURCE_EN_FUZZY, ...) .&lt;/p&gt;

&lt;p&gt;If you need more information, please let me know.&#160;&lt;/p&gt;</comment>
                            <comment id="17173188" author="cpoerschke" created="Fri, 7 Aug 2020 15:00:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m sorry for late response.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No problem, we all contribute here as and when time permits. Thank you for returning and continuing the investigation here!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Update and search are working because request is forwarded to correct shard from wrong shard.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s good to know and have clarified, thanks.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Main problems are overhead forwarding requests and loosing parameters from update parameters during forwarding requests. When we perform batch update ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, if a request has to be forwarded there would be some overhead.&lt;/p&gt;

&lt;p&gt;Loss of parameters during the forwarding, that is new information, interesting.&lt;/p&gt;

&lt;p&gt;When you say &quot;batch update&quot;, do you mean more than one document in the same request or perhaps something else? If the batch size was one then does the issue happen also, I wonder?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;... after that in update request processor chain ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m not very familiar with update request processor chains but the &lt;a href=&quot;https://lucene.apache.org/solr/guide/8_6/update-request-processors.html#update-processors-in-solrcloud&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lucene.apache.org/solr/guide/8_6/update-request-processors.html#update-processors-in-solrcloud&lt;/a&gt; documentation was useful and the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8030&quot; title=&quot;Transaction log does not store the update chain (or req params?) used for updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8030&quot;&gt;SOLR-8030&lt;/a&gt; ticket mentioned in it sounds interesting.&lt;/p&gt;

&lt;p&gt;Anyway, going back to the proposed change:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; joinedInputCollections = StrUtils.join(inputCollections, &lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;);
  Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; seenNodes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;();
  sortedReplicas.forEach( replica -&amp;gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (seenNodes.add(replica.getNodeName())) {
-     theUrlList.add(ZkCoreNodeProps.getCoreUrl(replica.getBaseUrl(), joinedInputCollections));
+     theUrlList.add(replica.getCoreUrl());
    }
  });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thinking out aloud ...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;What if &lt;tt&gt;inputCollections&lt;/tt&gt; contained more than one element?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;What if &lt;tt&gt;inputCollections&lt;/tt&gt; contained an alias that was resolved at &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 1080&lt;/a&gt;, does it matter that before the alias (e.g. &lt;tt&gt;collection_one&lt;/tt&gt;) was appended but now a core name (e.g. &lt;tt&gt;collection1_shard2_replica1&lt;/tt&gt;) is appended?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;A &lt;tt&gt;route&lt;/tt&gt; can designate multiple shards (right?) and in the &lt;tt&gt;seenNodes.add(replica.getNodeName())&lt;/tt&gt; check, what is node name again, it&apos;s localhost_8983_solr right? If so then that check guards against multiple &lt;tt&gt;localhost:8983/solr/*&lt;/tt&gt; i.e. if the &lt;tt&gt;route&lt;/tt&gt; designated shard2 and shard4 we would get &lt;tt&gt;localhost:8983/solr/collection1_shard2_replica1&lt;/tt&gt; or &lt;tt&gt;localhost:8983/solr/collection1_shard4_replica1&lt;/tt&gt; but not both. Would &lt;tt&gt;collection1_shard2_replica1&lt;/tt&gt; do its stuff and forward to &lt;tt&gt;collection1_shard4_replica1&lt;/tt&gt; or would there be no forwarding?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Might &lt;em&gt;&quot;If a route key was supplied and ... then do new-stuff else do existing-stuff&quot;&lt;/em&gt; specialisation work? It could complicate the already quite complicated code though, hmm.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Might there be other solutions to the problem?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17173449" author="dsmiley" created="Fri, 7 Aug 2020 20:25:57 +0000"  >&lt;p&gt;It&apos;d be great if we could make an integration test (&lt;em&gt;not&lt;/em&gt; a unit test) for this somehow.  Off-hand, I&apos;m not sure what an integration test would look for to observe when a request re-routes.&lt;/p&gt;</comment>
                            <comment id="17174072" author="jason.j.baik@gmail.com" created="Mon, 10 Aug 2020 04:44:20 +0000"  >&lt;p&gt;Attached is a test case demonstrating the problem:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13009356/13009356_0001-SOLR-14630-Test-case-demonstrating-_route_-is-broken.patch&quot; title=&quot;0001-SOLR-14630-Test-case-demonstrating-_route_-is-broken.patch attached to SOLR-14630&quot;&gt;0001-SOLR-14630-Test-case-demonstrating-&lt;em&gt;route&lt;/em&gt;-is-broken.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&#160;&lt;/p&gt;

&lt;p&gt;We&apos;re finding the same problem as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=idjurasevic&quot; class=&quot;user-hover&quot; rel=&quot;idjurasevic&quot;&gt;idjurasevic&lt;/a&gt;&#160;as we&apos;re upgrading from Solr 6 to 7. The &lt;em&gt;route&lt;/em&gt; param no longer works as expected. The regression seems to have happened around L1061 in&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/commit/e001f352895c83652c3cf31e3c724d29a46bb721#diff-c8d54eacd46180b332c86c7ae448abaeR1065&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/commit/e001f352895c83652c3cf31e3c724d29a46bb721#diff-c8d54eacd46180b332c86c7ae448abaeR1065&lt;/a&gt;. It made requests no longer be routed to a specific replica, but&#160;only to the node level.&#160;&lt;/p&gt;

&lt;p&gt;This:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ZkCoreNodeProps.getCoreUrl(nodeProps.getStr(ZkStateReader.BASE_URL_PROP), joinedInputCollections) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Shouldn&apos;t have replaced:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
url = coreNodeProps.getCoreUrl() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Although they sound like they do the same thing, they actually don&apos;t. Only the latter produces a replica specific url. I guess the name of the method&#160;getCoreUrl() is little tricky.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17174075" author="jason.j.baik@gmail.com" created="Mon, 10 Aug 2020 05:04:14 +0000"  >&lt;p&gt;Also,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=idjurasevic&quot; class=&quot;user-hover&quot; rel=&quot;idjurasevic&quot;&gt;idjurasevic&lt;/a&gt;&#160;mentioned indexing and querying still worked &quot;correctly&quot; for his system because the forwarding, although not desired, still allows the request to reach the correct replica eventually. However, in our case, we explicitly disable distributed processing bc we depend on the &lt;em&gt;route&lt;/em&gt; param being able to pin-point the replica, so our system lost correctness, too.&lt;/p&gt;

&lt;p&gt;We&apos;re hoping that the fix for this issue is also back-ported to Solr 7 if possible please.&lt;/p&gt;</comment>
                            <comment id="17175518" author="idjurasevic" created="Tue, 11 Aug 2020 12:26:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;When you say &quot;batch update&quot;, do you mean more than one document in the same request or perhaps something else? If the batch size was one then does the issue happen also, I wonder?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Batch size is not problem. Same issue is happening when batch contains 50 and when contains 1 document.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;m not very familiar with update request processor chains but the&#160;&lt;a href=&quot;https://lucene.apache.org/solr/guide/8_6/update-request-processors.html#update-processors-in-solrcloud&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lucene.apache.org/solr/guide/8_6/update-request-processors.html#update-processors-in-solrcloud&lt;/a&gt;&#160;documentation was useful and the&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8030&quot; title=&quot;Transaction log does not store the update chain (or req params?) used for updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8030&quot;&gt;SOLR-8030&lt;/a&gt;&#160;ticket mentioned in it sounds interesting.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Update processor chain is not problem(they have some other issues, i will raise bugs for that team, too), i was describing our process and why is important to hit correct shard without forwarding requests.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;What if&#160;&lt;tt&gt;inputCollections&lt;/tt&gt;&#160;contained more than one element?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, this is a problem, i was trying to search across collections and with my fix, it doesn&apos;t work. It seems that HttpSolrCall class can&apos;t parse URL when URL contain more core names.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;What if&#160;&lt;tt&gt;inputCollections&lt;/tt&gt;&#160;contained an alias that was resolved at&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.2/solr/solrj/src/java/org/apache/solr/client/solrj/impl/BaseCloudSolrClient.java#L1080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 1080&lt;/a&gt;, does it matter that before the alias (e.g.&#160;&lt;tt&gt;collection_one&lt;/tt&gt;) was appended but now a core name (e.g.&#160;&lt;tt&gt;collection1_shard2_replica1&lt;/tt&gt;) is appended?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Aliases should&apos;t be a problem, when we solve issue with multiple collections(because we found real collection names before creating URL).&lt;/p&gt;

&lt;p&gt;Unfortunately, to fix this issue we will need to refactor HttpSolrCall class, too.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17723170" author="pierre.salagnac" created="Tue, 16 May 2023 15:36:04 +0000"  >&lt;p&gt;I also hit this now pretty old bug.&lt;/p&gt;

&lt;p&gt;After an offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;, we came to the conclusion that the description of this bug and the proposed solution are mostly correct. I&apos;m working on a patch that gets back to the old behavior (using &lt;tt&gt;coreNodeProps.getCoreUrl()&lt;/tt&gt;), but only when the query scope is a single collection.&lt;/p&gt;

&lt;p&gt;When querying multiple collection, we anyway can&apos;t avoid one more forwarded request, so I plan to keeping the current behavior in this case.&lt;/p&gt;</comment>
                            <comment id="17724970" author="dsmiley" created="Mon, 22 May 2023 14:22:28 +0000"  >&lt;p&gt;FYI the solution will affect observability/logging signals somewhat because queries into Solr from SolrJ will no longer be the collection name but be the replica name (which started with the collection name, at least).&lt;/p&gt;

&lt;p&gt;We also toyed around with the idea of routing smarter Solr side, like in HttpSolrCall if certain parameters were present.  But that is more work and there is already precedent for direct routing via update requests that CloudSolrClient makes, so we chose that.  Nonetheless these aren&apos;t mutually exclusive; not everyone uses SolrJ CloudSolrClient.&lt;/p&gt;</comment>
                            <comment id="17727705" author="jira-bot" created="Tue, 30 May 2023 20:50:45 +0000"  >&lt;p&gt;Commit f3b0386f724ff69f4dcee2c6273aaf4d078d9ea3 in solr&apos;s branch refs/heads/main from Pierre Salagnac&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=f3b0386f724&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=f3b0386f724&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14630&quot; title=&quot;CloudSolrClient doesn&amp;#39;t pick correct core when server contains more shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14630&quot;&gt;&lt;del&gt;SOLR-14630&lt;/del&gt;&lt;/a&gt;: SolrJ queries: form the URL to the replica (#1646)&lt;/p&gt;

&lt;p&gt;CloudSolrClient: When querying with the `&lt;em&gt;route&lt;/em&gt;` or `shards.preference` parameter and if there are multiple replicas for a collection on the receiving node, there was sometimes an extra HTTP hop or the non-intended replica may receive the request.  SolrJ will now form the URL directly to the intended replica of the collection (and not the collection itself).&lt;/p&gt;

&lt;p&gt;Co-authored-by: Pierre Salagnac &amp;lt;psalagnac@salesforce.com&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17727720" author="jason.j.baik@gmail.com" created="Tue, 30 May 2023 22:41:48 +0000"  >&lt;p&gt;Will this be back-ported to Solr 7? Also, when I contributed the test case, I felt relying on the TRACK debug param was kinda hacky, and we would come up with a better way of detecting the forwarding that happens internally in Solr &#128517;&lt;/p&gt;</comment>
                            <comment id="17727750" author="dsmiley" created="Wed, 31 May 2023 01:33:33 +0000"  >&lt;p&gt;It occurred to me we should have mentioned you Jason in CHANGES.txt as it was your test (probably modified).  Not too late, will add; thanks again!  BTW I&apos;m just looking to see that tests are happy before back-porting to be very cautious.  As you may observe from the PR, we debated how to test it.  Personally I&apos;m a fan of distributed-tracing&apos;s MockTracer for this sort of thing.  Any way, I don&apos;t consider TRACK or tracing a hack approach at all!&lt;/p&gt;

&lt;p&gt;There will certainly be no back-ports.  main/10x + 9x is where new changes go.  If it were easier to release 8x (it was before the split), we might entertain bad bug fixes.  Some people put commits there anyway but don&apos;t expect a release.  Before 8 &amp;#8211; forget about it.  And besides, this is a perf optimization really; it functioned correctly and still does.&lt;/p&gt;
</comment>
                            <comment id="17727792" author="jira-bot" created="Wed, 31 May 2023 04:38:31 +0000"  >&lt;p&gt;Commit d7ca2c26577dcb64a3ab58ca9214d33409cf5162 in solr&apos;s branch refs/heads/branch_9x from Pierre Salagnac&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=d7ca2c26577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=d7ca2c26577&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14630&quot; title=&quot;CloudSolrClient doesn&amp;#39;t pick correct core when server contains more shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14630&quot;&gt;&lt;del&gt;SOLR-14630&lt;/del&gt;&lt;/a&gt;: SolrJ queries: form the URL to the replica (#1646)&lt;/p&gt;

&lt;p&gt;CloudSolrClient: When querying with the `&lt;em&gt;route&lt;/em&gt;` or `shards.preference` parameter and if there are multiple replicas for a collection on the receiving node, there was sometimes an extra HTTP hop or the non-intended replica may receive the request.  SolrJ will now form the URL directly to the intended replica of the collection (and not the collection itself).&lt;/p&gt;

&lt;p&gt;Co-authored-by: Pierre Salagnac &amp;lt;psalagnac@salesforce.com&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17727940" author="dsmiley" created="Wed, 31 May 2023 12:43:43 +0000"  >&lt;p&gt;Thanks Pierre, Jason, Ivan, Christine!&lt;/p&gt;</comment>
                            <comment id="17745770" author="houston" created="Fri, 21 Jul 2023 20:40:37 +0000"  >&lt;p&gt;Closing after the 9.3.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13009356" name="0001-SOLR-14630-Test-case-demonstrating-_route_-is-broken.patch" size="5923" author="jason.j.baik@gmail.com" created="Mon, 10 Aug 2020 04:42:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ghnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>