<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:18:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9503] NPE in Replica Placement Rules when using Overseer Role with other rules</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9503</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The overseer role introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9251&quot; title=&quot;Allow a tag role:!overseer in replica placement rules&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9251&quot;&gt;&lt;del&gt;SOLR-9251&lt;/del&gt;&lt;/a&gt; works well if there&apos;s only a single Rule for replica placement e.g. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;rule=role:!overseer&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; but when combined with another rule, e.g. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;rule=role:!overseer&amp;amp;rule=host:*,shard:*,replica:&amp;lt;2&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; it can result in a NullPointerException (in Rule.tryAssignNodeToShard)&lt;/p&gt;

&lt;p&gt;This happens because the code builds up a nodeVsTags map, but it only has entries for nodes that have values for &lt;b&gt;all&lt;/b&gt; tags used among the rules. This means not enough information is available to other rules when they are being checked during replica assignment. In the example rules above, if we have a cluster of 12 nodes and only 3 are given the Overseer role, the others do not have any entry in the nodeVsTags map because they only have the host tag value and not the role tag value.&lt;/p&gt;

&lt;p&gt;Looking at the code in ReplicaAssigner.getTagsForNodes, it is explicitly only keeping entries that fulfil the constraint of having values for all tags used in the rules. Possibly this constraint was suitable when rules were originally introduced, but the Role tag (used for Overseers) is unlikely to be present for all nodes in the cluster, and similarly for sysprop tags which may or not be set for a node.&lt;/p&gt;

&lt;p&gt;My patch removes this constraint, so the nodeVsTags map contains everything known about all nodes, even if they have no value for a given tag. This allows the rule combination above to work, and doesn&apos;t appear to cause any problems with the code paths that use the nodeVsTags map. They handle null values quite well, and the tests pass.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13004292">SOLR-9503</key>
            <summary>NPE in Replica Placement Rules when using Overseer Role with other rules</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="TimOwen">Tim Owen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Sep 2016 13:10:28 +0000</created>
                <updated>Sat, 8 Jun 2019 15:33:43 +0000</updated>
                            <resolved>Wed, 28 Feb 2018 12:48:38 +0000</resolved>
                                    <version>6.2</version>
                    <version>7.0</version>
                                    <fixVersion>6.4</fixVersion>
                                    <component>Rules</component>
                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15484252" author="timowen" created="Mon, 12 Sep 2016 14:19:15 +0000"  >&lt;p&gt;As an aside, I noticed that `Rule.Operand.GREATER_THAN` seems to be missing an override for `public int compare(Object n1Val, Object n2Val)` .. but compare only appears to be used when sorting the live nodes, so maybe it&apos;s not a big deal?&lt;/p&gt;</comment>
                            <comment id="15798416" author="timowen" created="Wed, 4 Jan 2017 14:43:22 +0000"  >&lt;p&gt;Is anyone able to take a look at this fix - maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;? I hope the assumptions I&apos;ve made in the diff are correct.&lt;/p&gt;

&lt;p&gt;We&apos;ve been using it in production for a few months, in our custom build of Solr. Would be nice to roll it in upstream.&lt;/p&gt;</comment>
                            <comment id="15798437" author="noble.paul" created="Wed, 4 Jan 2017 14:50:17 +0000"  >&lt;p&gt;I missed it tim. I shall take a look at it tomorrow&lt;/p&gt;</comment>
                            <comment id="15800758" author="noble.paul" created="Thu, 5 Jan 2017 08:37:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TimOwen&quot; class=&quot;user-hover&quot; rel=&quot;TimOwen&quot;&gt;TimOwen&lt;/a&gt; The fix looks fine. I could commit it if we could add a JUnit&lt;/p&gt;</comment>
                            <comment id="15801692" author="timowen" created="Thu, 5 Jan 2017 15:46:54 +0000"  >&lt;p&gt;I went through the tests and found that if I added another rule to the existing test for the overseer-role, it would fail as expected with the previous code. That test now passes with the fix, so I&apos;ve updated my patch with that test change.&lt;/p&gt;</comment>
                            <comment id="15804740" author="jira-bot" created="Fri, 6 Jan 2017 15:11:01 +0000"  >&lt;p&gt;Commit cd4f908d5ba223e615920be73285b7c5cc57704a in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cd4f908&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cd4f908&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9503&quot; title=&quot;NPE in Replica Placement Rules when using Overseer Role with other rules&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9503&quot;&gt;&lt;del&gt;SOLR-9503&lt;/del&gt;&lt;/a&gt;: NPE in Replica Placement Rules when using Overseer Role with other rules&lt;/p&gt;</comment>
                            <comment id="15804750" author="jira-bot" created="Fri, 6 Jan 2017 15:13:51 +0000"  >&lt;p&gt;Commit 2b66d0cb127b5e3e92a0f988aa7ba10690227ac3 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2b66d0c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2b66d0c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9503&quot; title=&quot;NPE in Replica Placement Rules when using Overseer Role with other rules&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9503&quot;&gt;&lt;del&gt;SOLR-9503&lt;/del&gt;&lt;/a&gt;: NPE in Replica Placement Rules when using Overseer Role with other rules&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12845816" name="SOLR-9503.patch" size="3917" author="TimOwen" created="Thu, 5 Jan 2017 15:46:54 +0000"/>
                            <attachment id="12828038" name="SOLR-9503.patch" size="3052" author="TimOwen" created="Mon, 12 Sep 2016 13:11:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33inb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>