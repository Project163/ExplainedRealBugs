<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:39:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5215] Deadlock in Solr Cloud ConnectionManager</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5215</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We are constantly seeing a deadlocks in our production application servers.&lt;/p&gt;

&lt;p&gt;The problem seems to be that a thread A:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tries to process an event and acquires the ConnectionManager lock&lt;/li&gt;
	&lt;li&gt;the update callback acquires connectionUpdateLock and invokes waitForConnected&lt;/li&gt;
	&lt;li&gt;waitForConnected tries to acquire the ConnectionManager lock (which already has)&lt;/li&gt;
	&lt;li&gt;waitForConnected calls wait and release the ConnectionManager lock (but still has the connectionUpdateLock)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The a thread B:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tries to process an event and acquires the ConnectionManager lock&lt;/li&gt;
	&lt;li&gt;the update call back tries to acquire connectionUpdateLock but gets blocked holding the ConnectionManager lock and preventing thread A from getting out of the wait state.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is part of the thread dump:&lt;/p&gt;

&lt;p&gt;&quot;http-0.0.0.0-8080-82-EventThread&quot; daemon prio=10 tid=0x0000000059965800 nid=0x3e81 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000057169000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.process(ConnectionManager.java:71)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;http-0.0.0.0-8080-82-EventThread&quot; daemon prio=10 tid=0x000000005ad40000 nid=0x3e67 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000004dbd4000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager$1.update(ConnectionManager.java:98)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00002aab1b0e0f78&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at org.apache.solr.common.cloud.DefaultConnectionStrategy.reconnect(DefaultConnectionStrategy.java:46)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.process(ConnectionManager.java:91)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;http-0.0.0.0-8080-82-EventThread&quot; daemon prio=10 tid=0x00002aac4c2f7000 nid=0x3d9a waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000042821000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.waitForConnected(ConnectionManager.java:165)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager$1.update(ConnectionManager.java:98)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0f78&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at org.apache.solr.common.cloud.DefaultConnectionStrategy.reconnect(DefaultConnectionStrategy.java:46)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.process(ConnectionManager.java:91)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;http-0.0.0.0-8080-82-EventThread&quot;:&lt;br/&gt;
  waiting to lock monitor 0x000000005c7694b0 (object 0x00002aab1b0e0ce0, a org.apache.solr.common.cloud.ConnectionManager),&lt;br/&gt;
  which is held by &quot;http-0.0.0.0-8080-82-EventThread&quot;&lt;br/&gt;
&quot;http-0.0.0.0-8080-82-EventThread&quot;:&lt;br/&gt;
  waiting to lock monitor 0x00002aac4c314978 (object 0x00002aab1b0e0f78, a java.lang.Object),&lt;br/&gt;
  which is held by &quot;http-0.0.0.0-8080-82-EventThread&quot;&lt;br/&gt;
&quot;http-0.0.0.0-8080-82-EventThread&quot;:&lt;br/&gt;
  waiting to lock monitor 0x000000005c7694b0 (object 0x00002aab1b0e0ce0, a org.apache.solr.common.cloud.ConnectionManager),&lt;br/&gt;
  which is held by &quot;http-0.0.0.0-8080-82-EventThread&quot;&lt;/p&gt;


&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;http-0.0.0.0-8080-82-EventThread&quot;:&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.process(ConnectionManager.java:71)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495)&lt;br/&gt;
&quot;http-0.0.0.0-8080-82-EventThread&quot;:&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager$1.update(ConnectionManager.java:98)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00002aab1b0e0f78&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at org.apache.solr.common.cloud.DefaultConnectionStrategy.reconnect(DefaultConnectionStrategy.java:46)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.process(ConnectionManager.java:91)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495)&lt;br/&gt;
&quot;http-0.0.0.0-8080-82-EventThread&quot;:&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;/li&gt;
	&lt;li&gt;waiting on &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.waitForConnected(ConnectionManager.java:165)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager$1.update(ConnectionManager.java:98)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0f78&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at org.apache.solr.common.cloud.DefaultConnectionStrategy.reconnect(DefaultConnectionStrategy.java:46)&lt;br/&gt;
        at org.apache.solr.common.cloud.ConnectionManager.process(ConnectionManager.java:91)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab1b0e0ce0&amp;gt; (a org.apache.solr.common.cloud.ConnectionManager)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:519)&lt;br/&gt;
        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:495) &lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Linux 2.6.18-164.el5 #1 SMP Tue Aug 18 15:51:48 EDT 2009 x86_64 x86_64 x86_64 GNU/Linux&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0_18&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_18-b07)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 16.0-b13, mixed mode)&lt;/p&gt;</environment>
        <key id="12666953">SOLR-5215</key>
            <summary>Deadlock in Solr Cloud ConnectionManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="rmerizalde">Ricardo Merizalde</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Sep 2013 19:06:21 +0000</created>
                <updated>Mon, 9 May 2016 18:52:04 +0000</updated>
                            <resolved>Mon, 14 Oct 2013 09:20:04 +0000</resolved>
                                    <version>4.2.1</version>
                                    <fixVersion>4.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>clients - java</component>
                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13760815" author="ainihong001" created="Sat, 7 Sep 2013 00:44:59 +0000"  >&lt;p&gt;Thanks to Ricard to find the reason. &lt;br/&gt;
I also encounter this issue in our production application servers.&lt;/p&gt;</comment>
                            <comment id="13762087" author="markrmiller@gmail.com" created="Mon, 9 Sep 2013 17:50:16 +0000"  >&lt;p&gt;I don&apos;t think we actually really need that separate update lock at all. This patch removes it.&lt;/p&gt;</comment>
                            <comment id="13762138" author="jira-bot" created="Mon, 9 Sep 2013 18:36:12 +0000"  >&lt;p&gt;Commit 1521236 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1521236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1521236&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5215&quot; title=&quot;Deadlock in Solr Cloud ConnectionManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5215&quot;&gt;&lt;del&gt;SOLR-5215&lt;/del&gt;&lt;/a&gt;: Fix possibility of deadlock in ZooKeeper ConnectionManager.&lt;/p&gt;</comment>
                            <comment id="13762147" author="jira-bot" created="Mon, 9 Sep 2013 18:47:36 +0000"  >&lt;p&gt;Commit 1521239 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1521239&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1521239&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5215&quot; title=&quot;Deadlock in Solr Cloud ConnectionManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5215&quot;&gt;&lt;del&gt;SOLR-5215&lt;/del&gt;&lt;/a&gt;: Fix possibility of deadlock in ZooKeeper ConnectionManager.&lt;/p&gt;</comment>
                            <comment id="13794008" author="shalinmangar" created="Mon, 14 Oct 2013 09:20:04 +0000"  >&lt;p&gt;This fix was released in 4.5&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12602172" name="SOLR-5215.patch" size="3103" author="markrmiller@gmail.com" created="Mon, 9 Sep 2013 17:50:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346890</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ntfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347190</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>