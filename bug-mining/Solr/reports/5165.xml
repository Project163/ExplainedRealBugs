<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:09:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17198] Affinity Placement Plugin can fail when getting metrics, if multiple replicas claim shard leadership </title>
                <link>https://issues.apache.org/jira/browse/SOLR-17198</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Using Solr 9.4 with 16 nodes, I observe that about 25% of our Split Shard requests are failing. The error is a RuntimeException that is raised by the AttributeFetcher as it compiles the metrics that will be used by the plugin.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The AttributeFetcher is making /admin/metrics requests to each node, and currently it expects to be able to establish a consistent&#160; view of shard leadership across the cluster from the responses.&lt;/p&gt;

&lt;p&gt;However, we see this exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.RuntimeException: two replicas claim to be the shard leader! existing=org.apache.solr.cluster.placement.impl.CollectionMetricsBuilder$ReplicaMetricsBuilder@56e219b9 and current org.apache.solr.cluster.placement.impl.CollectionMetricsBuilder$ReplicaMetricsBuilder@406bcfd8
	at org.apache.solr.cluster.placement.impl.CollectionMetricsBuilder$ShardMetricsBuilder.lambda$build$0(CollectionMetricsBuilder.java:84)
	at java.base/java.util.HashMap.forEach(HashMap.java:1429)
	at org.apache.solr.cluster.placement.impl.CollectionMetricsBuilder$ShardMetricsBuilder.build(CollectionMetricsBuilder.java:76)
	at org.apache.solr.cluster.placement.impl.CollectionMetricsBuilder.lambda$build$0(CollectionMetricsBuilder.java:39)
	at java.base/java.util.HashMap.forEach(HashMap.java:1429)
	at org.apache.solr.cluster.placement.impl.CollectionMetricsBuilder.build(CollectionMetricsBuilder.java:39)
	at org.apache.solr.cluster.placement.impl.AttributeFetcherImpl.lambda$fetchAttributes$17(AttributeFetcherImpl.java:213)
	at java.base/java.util.HashMap.forEach(HashMap.java:1429)
	at org.apache.solr.cluster.placement.impl.AttributeFetcherImpl.fetchAttributes(AttributeFetcherImpl.java:212)
	at org.apache.solr.cluster.placement.plugins.AffinityPlacementFactory$AffinityPlacementPlugin.getBaseWeightedNodes(AffinityPlacementFactory.java:284)
	at org.apache.solr.cluster.placement.plugins.OrderedNodePlacementPlugin.getWeightedNodes(OrderedNodePlacementPlugin.java:311)
	at org.apache.solr.cluster.placement.plugins.OrderedNodePlacementPlugin.computePlacements(OrderedNodePlacementPlugin.java:85)
	at org.apache.solr.cluster.placement.impl.PlacementPluginAssignStrategy.assign(PlacementPluginAssignStrategy.java:84)
	at org.apache.solr.cloud.api.collections.Assign$AssignStrategy.assign(Assign.java:446)
	at org.apache.solr.cloud.api.collections.SplitShardCmd.split(SplitShardCmd.java:689) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This indicates that more than one replica for a given Shard has responded with leader=true in the replica metrics.&lt;/p&gt;

&lt;p&gt;I think there are legitimate reasons this can occur:&lt;/p&gt;

&lt;p&gt;1. It may be fundamentally impossible to always be able to build a consistent view of shard leadership from querying a set of distributed nodes&lt;br/&gt;
2. /admin/metrics requests are sent sequentially to each node in turn. It is possible that shard leadership may change between making the request to different nodes that host replicas for a shard&lt;/p&gt;</description>
                <environment></environment>
        <key id="13571045">SOLR-17198</key>
            <summary>Affinity Placement Plugin can fail when getting metrics, if multiple replicas claim shard leadership </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="pmcarthur">Paul McArthur</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Mar 2024 19:03:52 +0000</created>
                <updated>Sun, 28 Apr 2024 19:29:09 +0000</updated>
                            <resolved>Sat, 16 Mar 2024 05:03:07 +0000</resolved>
                                    <version>9.4</version>
                                    <fixVersion>9.6</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17824141" author="JIRAUSER300242" created="Wed, 6 Mar 2024 19:10:25 +0000"  >&lt;p&gt;I think there is a somewhat trivial solution for this issue. The metric that the placement plugin is interested in is the size of the index, and I don&apos;t think it matters if the Attribute Fetcher observes multiple leaders for a Shard.&lt;/p&gt;

&lt;p&gt;It could just pick any replica that claims leadership, because all of them are able to provide the required index size metric.&lt;/p&gt;

&lt;p&gt;I am not sure if there are other cases fulfilled by the Attribute Fetcher where this would be a problem, I haven&apos;t found any yet.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will put together a PR with a proposed solution.&lt;/p&gt;</comment>
                            <comment id="17827642" author="jira-bot" created="Sat, 16 Mar 2024 03:31:27 +0000"  >&lt;p&gt;Commit a4fbad59fcf61ad1b6b5fb02fd2803e1a52379c1 in solr&apos;s branch refs/heads/main from pjmcarthur&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=a4fbad59fcf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=a4fbad59fcf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17198&quot; title=&quot;Affinity Placement Plugin can fail when getting metrics, if multiple replicas claim shard leadership &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17198&quot;&gt;&lt;del&gt;SOLR-17198&lt;/del&gt;&lt;/a&gt;: AttributeFetcher no longer fails when it observes multiple shard leaders (#2335)&lt;/p&gt;

&lt;p&gt;AffinityPlacementFactory can fail if Shard leadership changes occur while it is collecting metrics.&lt;/p&gt;


&lt;p&gt;Co-authored-by: Paul McArthur &amp;lt;pmcarthur-apache@proton.me&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17827647" author="jira-bot" created="Sat, 16 Mar 2024 05:02:08 +0000"  >&lt;p&gt;Commit 1841007b9202321c0b623072e208d94d9f0b7624 in solr&apos;s branch refs/heads/branch_9x from pjmcarthur&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=1841007b920&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=1841007b920&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17198&quot; title=&quot;Affinity Placement Plugin can fail when getting metrics, if multiple replicas claim shard leadership &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17198&quot;&gt;&lt;del&gt;SOLR-17198&lt;/del&gt;&lt;/a&gt;: AttributeFetcher no longer fails when it observes multiple shard leaders (#2335)&lt;/p&gt;

&lt;p&gt;AffinityPlacementFactory can fail if Shard leadership changes occur while it is collecting metrics.&lt;/p&gt;

&lt;p&gt;Co-authored-by: Paul McArthur &amp;lt;pmcarthur-apache@proton.me&amp;gt;&lt;/p&gt;

&lt;p&gt;(cherry picked from commit a4fbad59fcf61ad1b6b5fb02fd2803e1a52379c1)&lt;/p&gt;</comment>
                            <comment id="17827648" author="dsmiley" created="Sat, 16 Mar 2024 05:03:07 +0000"  >&lt;p&gt;Thanks for contributing!&lt;/p&gt;</comment>
                            <comment id="17841755" author="gus_heck" created="Sun, 28 Apr 2024 19:22:44 +0000"  >&lt;p&gt;Closing after the 9.6.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 28 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ntqo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>