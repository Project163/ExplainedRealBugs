<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:07:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-15056] CPU circuit breaker needs to use CPU utilization, not Unix load average</title>
                <link>https://issues.apache.org/jira/browse/SOLR-15056</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The config range, 50% to 95%, assumes that the circuit breaker is triggered by a CPU utilization metric that goes from 0% to 100%. But the code uses the metric&#160;OperatingSystemMXBean.getSystemLoadAverage(). That is an average of the count of processes waiting to run. It is effectively unbounded. I&apos;ve seen it as high as 50 to 100. It is not bound by 1.0 (100%).&lt;/p&gt;

&lt;p&gt;A good limit for load average would need to be aware of the number of CPUs available to the JVM. A load average of 8 is no problem for a 32 CPU host. It is a critical situation for a 2 CPU host.&lt;/p&gt;

&lt;p&gt;Also, load average is a Unix OS metric. I don&apos;t know if it is even available on Windows.&lt;/p&gt;

&lt;p&gt;Instead, use a CPU utilization metric that goes from 0.0 to 1.0. A good choice is&#160;OperatingSystemMXBean.getSystemCPULoad(). This name also uses &quot;load&quot;, but it is a usage metric.&lt;/p&gt;

&lt;p&gt;From the Javadoc:&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;Returns the &quot;recent cpu usage&quot; for the whole system. This value is a double in the &lt;span class=&quot;error&quot;&gt;&amp;#91;0.0,1.0&amp;#93;&lt;/span&gt; interval. A value of 0.0 means that all CPUs were idle during the recent period of time observed, while a value of 1.0 means that all CPUs were actively running 100% of the time during the recent period being observed. All values betweens 0.0 and 1.0 are possible depending of the activities going on in the system. If the system recent cpu usage is not available, the method returns a negative value.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/7/docs/jre/api/management/extension/com/sun/management/OperatingSystemMXBean.html#getSystemCpuLoad(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/jre/api/management/extension/com/sun/management/OperatingSystemMXBean.html#getSystemCpuLoad(&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Also update the documentation to explain which JMX metrics are used for the memory and CPU circuit breakers.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13346876">SOLR-15056</key>
            <summary>CPU circuit breaker needs to use CPU utilization, not Unix load average</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janhoy">Jan H&#248;ydahl</assignee>
                                    <reporter username="wunder">Walter Underwood</reporter>
                        <labels>
                            <label>Metrics</label>
                    </labels>
                <created>Fri, 18 Dec 2020 23:21:21 +0000</created>
                <updated>Sun, 15 Oct 2023 19:57:05 +0000</updated>
                            <resolved>Wed, 20 Sep 2023 23:04:33 +0000</resolved>
                                    <version>8.7</version>
                                    <fixVersion>9.4</fixVersion>
                                    <component>Circuit Breakers</component>
                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="38400">10h 40m</timespent>
                                <comments>
                            <comment id="17260883" author="wunder" created="Thu, 7 Jan 2021 23:40:55 +0000"  >&lt;p&gt;Is it OK to use com.sun.management.OperatingSystemMXBean instead of the java.lang.management version?&lt;/p&gt;

&lt;p&gt;getSystemCpuLoad() is only in the former. The current code uses java.lang.management.OperatingSystemMXBean.&lt;/p&gt;</comment>
                            <comment id="17261634" author="mdrob" created="Fri, 8 Jan 2021 22:45:59 +0000"  >&lt;p&gt;Looking at the code, it should be ok to test for it and attempt to use it if we have it, but I don&apos;t think we can have any guarantees.&lt;/p&gt;

&lt;p&gt;Also, I think precommit will complain about com.sun classes, and I&apos;m not sure how to make it ignore that, maybe a SupressForbidden annotation.&lt;/p&gt;</comment>
                            <comment id="17261656" author="wunder" created="Fri, 8 Jan 2021 23:09:22 +0000"  >&lt;p&gt;The factory will return null if that MXBean isn&apos;t available, and I added a null check.&lt;/p&gt;

&lt;p&gt;Maybe I should take the current implementation and make it a LoadAverageCircuitBreaker in addition to this. That metric is always available, oddly. That seems like it would be far more Unix-specific than CPU utilization.&lt;/p&gt;</comment>
                            <comment id="17262468" author="ab" created="Mon, 11 Jan 2021 08:11:50 +0000"  >&lt;p&gt;&lt;tt&gt;systemCpuLoad&lt;/tt&gt; is already supported and returned as one of the metrics. This comes from the (somewhat convoluted) code in &lt;tt&gt;MetricUtils.addMxBeanMetrics&lt;/tt&gt; where it tries to use all known implementations and accumulates any unique bean properties that they expose.&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/admin/metrics?group=jvm&amp;amp;prefix=os
&lt;/span&gt;
{
    &lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;: {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: 0,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;: 1
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;metrics&quot;&lt;/span&gt;: {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;solr.jvm&quot;&lt;/span&gt;: {
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.arch&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;x86_64&quot;&lt;/span&gt;,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.availableProcessors&quot;&lt;/span&gt;: 12,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.committedVirtualMemorySize&quot;&lt;/span&gt;: 8402419712,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.freePhysicalMemorySize&quot;&lt;/span&gt;: 41504768,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.freeSwapSpaceSize&quot;&lt;/span&gt;: 804519936,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.maxFileDescriptorCount&quot;&lt;/span&gt;: 8192,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Mac OS X&quot;&lt;/span&gt;,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.openFileDescriptorCount&quot;&lt;/span&gt;: 195,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.processCpuLoad&quot;&lt;/span&gt;: 0.0017402379609634876,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.processCpuTime&quot;&lt;/span&gt;: 10492010000,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.systemCpuLoad&quot;&lt;/span&gt;: 0.1268950796343933,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.systemLoadAverage&quot;&lt;/span&gt;: 4.00439453125,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.totalPhysicalMemorySize&quot;&lt;/span&gt;: 34359738368,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.totalSwapSpaceSize&quot;&lt;/span&gt;: 7516192768,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;os.version&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;10.16&quot;&lt;/span&gt;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17262521" author="ab" created="Mon, 11 Jan 2021 09:32:10 +0000"  >&lt;p&gt;The equivalent Java code would be something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
coreContainer
  .getSolrMetricManager()
  .registry(&#8220;solr.jvm&#8221;)
  .getMetrics()
  .get(&#8220;os.systemCpuLoad&#8221;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17263016" author="wunder" created="Tue, 12 Jan 2021 01:52:38 +0000"  >&lt;p&gt;Mostly passes &quot;./gradlew check -Pvalidation.git.failOnModified=false&quot; on master. Some probably unrelated cloud tests fail.&lt;/p&gt;</comment>
                            <comment id="17263017" author="wunder" created="Tue, 12 Jan 2021 01:54:59 +0000"  >&lt;p&gt;I&apos;ve added a patch.&lt;/p&gt;

&lt;p&gt;Next, I&apos;m setting up some functional testing. I&apos;ll fire up a server, configure a circuit breaker, then start using up system CPU with &quot;yes | wc &amp;amp;&quot;.  That will close to max-out two processors. At some point, searches should start returning 503.&lt;/p&gt;</comment>
                            <comment id="17263224" author="ab" created="Tue, 12 Jan 2021 10:34:52 +0000"  >&lt;p&gt;This change is not needed and it makes the API ugly and more difficult to unit test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; checkAnyTripped() {
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; checkAnyTripped(SolrCore core) {
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt&gt;CircuitBreakerManager&lt;/tt&gt; is created in &lt;tt&gt;SolrCore&lt;/tt&gt;&#160;so its life-cycle is the same as SolrCore. This API misleadingly suggests that you could use it with any arbitrary SolrCore.&lt;/p&gt;

&lt;p&gt;Instead, the manager can already hold onto a reference to SolrCore when its created, and use it to construct specific breaker implementations - in this case, you could pass SolrCore to the constructor of CPUCircuitBreaker, or make all classes that need it implement &lt;tt&gt;SolrCoreAware&lt;/tt&gt; and initialize them in the manager&apos;s ctor in a uniform fashion.&lt;/p&gt;</comment>
                            <comment id="17263245" author="atri" created="Tue, 12 Jan 2021 10:59:09 +0000"  >&lt;p&gt;Hi Walter,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for tackling this and apologies for the delay in response.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I took a look at the patch and here are my comments:&lt;/p&gt;

&lt;p&gt;1. Majority of the changes in the patch are to make CircuitBreaker aware of the SolrCore that is being used &#8211; which is a cyclic dependency since SolrCore owns CircuitBreakerManager which in turn owns CircuitBreakers. Also, the API becomes ugly, so please fix this change.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2. If you look at the original discussion around this metric, the com.sun package wasn&apos;t used due to it being a specific implementation. I agree that it is a cleaner metric to use, but we cannot be depending on something that isn&apos;t available on certain VMs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3. I am curious to understand your assertion about the 50-95% range &#8211; that is specifically for JVM heap usage based circuit breaker, not the CPU circuit breaker. Maybe the documentation needs to be clarified?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;4. OperatingSystemMXBean.getSystemLoadAverage() is a good metric because it takes the number of CPUs and the current process queue length into account, averaging it by time. I would want to keep this metric unless it does not work for a specific OS (Windows, like you said). Maybe we can use&#160;OperatingSystemMXBean.getSystemCPULoad() as the fallback mechanism if the first one returns -1?&lt;/p&gt;</comment>
                            <comment id="17263246" author="atri" created="Tue, 12 Jan 2021 11:01:04 +0000"  >&lt;p&gt;Also, I see a significant number of documentation changes which seem to be unrelated? e.g. &quot;Configuration for JVM heap usage based circuit breaker:&quot; to &quot;&#160;Configuration for JVM heap usage circuit breaker:&quot;&lt;/p&gt;</comment>
                            <comment id="17263500" author="wunder" created="Tue, 12 Jan 2021 17:09:50 +0000"  >&lt;p&gt;Thanks, I&apos;ll incorporate these changes about core. I&apos;m still learning the internals.&lt;/p&gt;

&lt;p&gt;I simplified the wording throughout the documentation. This should make it easier to read for non-native speakers of English.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=atri&quot; class=&quot;user-hover&quot; rel=&quot;atri&quot;&gt;atri&lt;/a&gt; 2. I understand the metric is not available on a few JVMs. It is available in free JVMs like Amazon Corretto. If someone is running a cluster under heavy load, it is probably worth switching to one of those JVMs. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=atri&quot; class=&quot;user-hover&quot; rel=&quot;atri&quot;&gt;atri&lt;/a&gt; 3. My comment about 50-95% in the original report was based on a misreading of the documentation, sorry.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=atri&quot; class=&quot;user-hover&quot; rel=&quot;atri&quot;&gt;atri&lt;/a&gt; 4. getSystemLoadAverage() is not normalized to the number of processors. It is an unbounded number. From the documentation: &quot;The system load average is the sum of the number of runnable entities queued to the available processors and the number of runnable entities running on the available processors averaged over a period of time.&quot; When I vertically scale an AWS instance to one with more processors, I would also need to update all of the circuit breaker configs!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/lang/management/OperatingSystemMXBean.html#getSystemLoadAverage(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/api/java/lang/management/OperatingSystemMXBean.html#getSystemLoadAverage(&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Load average has been an unbounded number for as long as I&apos;ve been using Unix, forty years.&lt;/p&gt;

&lt;p&gt;In my experience, load average only gets large after the system has hit 100% CPU. It is not very useful for predicting overload. I&apos;m glad to keep it, but it needs a more accurate name and description.&lt;/p&gt;</comment>
                            <comment id="17263548" author="ab" created="Tue, 12 Jan 2021 17:38:04 +0000"  >&lt;p&gt;...there&apos;s always this: if you don&apos;t know what to choose then make it an option &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Seriously, though - Walter is correct that the regular sysLoadAvg is unbounded, it may reach eg. 10&apos;s or even 100&apos;s, so it&apos;s difficult to properly adjust the threshold.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;getSystemCpuLoad&lt;/tt&gt; is supported on Oracle/OpenJDK, Amazon Coretto and IBM J9, I&apos;m not sure about Zulu but I would guess it&apos;s supported there too, so indeed it looks like a good default with predictable range. However, we could provide an option to use sysLoadAvg if that&apos;s what the user prefers (or if systemCpuLoad is not available) - it just needs a few if-else statements, but most of all it needs SOLID documentation.&lt;/p&gt;</comment>
                            <comment id="17263561" author="wunder" created="Tue, 12 Jan 2021 17:55:32 +0000"  >&lt;p&gt;Using load average needs a different threshold, so I&apos;d make it a different circuit breaker instead of switching it out.&lt;/p&gt;

&lt;p&gt;Copy the existing load average circuit breaker, use a more clear name, and figure out how to document that a limit of 1000 is really a limit of 10.0. Maybe even explain that load average is quite different on different OSes. Linux includes processes in iowait, other Unixes don&apos;t.&lt;/p&gt;

&lt;p&gt;I&apos;d rather use a threshold of 0.95 to mean 0.95 instead of using 95 to mean 0.95, but that is a breaking change.&lt;/p&gt;</comment>
                            <comment id="17263656" author="atri" created="Tue, 12 Jan 2021 19:57:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;getSystemCpuLoad is supported on Oracle/OpenJDK, Amazon Coretto and IBM J9, I&apos;m not sure about Zulu but I would guess it&apos;s supported there too, so indeed it looks like a good default with predictable range. However, we could provide an option to use sysLoadAvg if that&apos;s what the user prefers (or if systemCpuLoad is not available) - it just needs a few if-else statements, but most of all it needs SOLID documentation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I would agree to that &#8211; the main reason why we did not use systemCpuLoad in the first place was due to it being non standard &#8211; and I do not see that invariant changing now. A fallback mechanism is the right way IMO.&lt;/p&gt;</comment>
                            <comment id="17263659" author="atri" created="Tue, 12 Jan 2021 20:01:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;Using load average needs a different threshold, so I&apos;d make it a different circuit breaker instead of switching it out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I do not agree. Honestly, as long as the documentation is clear about what to expect, the current implementation IMHO provides a finer grained control to the user on what limits to expect and to set.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A separate circuit breaker for a different metric seems an over engineering effort and still does not solve the initial problem of the JVMs where this is not supported.&lt;/p&gt;</comment>
                            <comment id="17263671" author="wunder" created="Tue, 12 Jan 2021 20:25:38 +0000"  >&lt;p&gt;On our production clusters, we have alerts set at 65% CPU utilization. Looking at a recent alert, we had one of the 32 hosts reach 75% CPU. On that host, the load average reached a peak of 32.&lt;/p&gt;

&lt;p&gt;75% is a threshold of &quot;75&quot;. 32 is a threshold of &quot;3200&quot;. &lt;/p&gt;

&lt;p&gt;Right now, the CPU utilization is 5% and the load average is 3. So these are very different metrics. Silently replacing one with the other is a violation of the Principle of Least Surprise.&lt;/p&gt;

&lt;p&gt;We already have working code for a load average circuit breaker. Make the name more accurate and use it.&lt;/p&gt;

&lt;p&gt;There is no way to solve the problem of providing CPU utilization on a JVM that doesn&apos;t report CPU utilization. &lt;/p&gt;</comment>
                            <comment id="17263829" author="wunder" created="Wed, 13 Jan 2021 01:33:33 +0000"  >&lt;p&gt;CPU utilization and load average (run queue length) are complimentary metrics. CPU utilization measures how much work the CPUs are doing. The load average measures how much work is waiting for them (how much they are not doing).&lt;/p&gt;

&lt;p&gt;Under 100% CPU, load average doesn&apos;t tell us much, but CPU usage is very useful. Over 100% CPU, CPU utilization doesn&apos;t tell us much, but load average tells us a lot. It tells us how much work is waiting to run.&lt;/p&gt;

&lt;p&gt;Load average spikes after the CPU is very busy, something like 90%. When load average rises, Solr will already be overloaded and service will already be slowing down.&lt;/p&gt;

&lt;p&gt;If Solr is running on a system that includes iowait in the load average, then it could be useful to have circuit breakers on both the CPU usage and the load average. The latter would tell when the storage or network is overloaded.&lt;/p&gt;

&lt;p&gt;I&apos;m assuming that the hosts are configured with enough RAM so that normal searching doesn&apos;t hit disk. That makes Solr CPU-limited. All of our 100+ Solr systems are configured that way.&lt;/p&gt;</comment>
                            <comment id="17264021" author="ab" created="Wed, 13 Jan 2021 09:51:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Under 100% CPU, load average doesn&apos;t tell us much, but CPU usage is very useful. Over 100% CPU, CPU utilization doesn&apos;t tell us much, but load average tells us a lot. It tells us how much work is waiting to run.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well said! Indeed these are two very different metrics, and having two separate breaker implementations is not a bad idea (well, we could use one impl + a switch, but that could be too confusing and too easy to make mistakes).&lt;/p&gt;</comment>
                            <comment id="17264374" author="wunder" created="Wed, 13 Jan 2021 19:23:23 +0000"  >&lt;p&gt;For a load average threshold of 3.0, should the config value be 300 or 3.0?&lt;/p&gt;

&lt;p&gt;I&apos;m going with 3.0 for now.&lt;/p&gt;</comment>
                            <comment id="17265057" author="wunder" created="Thu, 14 Jan 2021 17:32:10 +0000"  >&lt;p&gt;git made two patch files, one per commit. I&apos;m glad to make a single one, but I don&apos;t know that git incantation.&lt;/p&gt;</comment>
                            <comment id="17265064" author="wunder" created="Thu, 14 Jan 2021 17:34:57 +0000"  >&lt;p&gt;Contents of latest patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Moved SolrCore reference to CircuitBreakerManager&lt;/li&gt;
	&lt;li&gt;Added back in existing CPU circuit breaker as LoadAverageCircuitBreaker&lt;/li&gt;
	&lt;li&gt;Copy-editing on docs: replace &quot;utilization&quot; with &quot;usage&quot;, make introductory paragraph more specific, document load average circuit breaker&lt;/li&gt;
	&lt;li&gt;Unit tests updated to cover all three circuit breakers&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17278256" author="wunder" created="Wed, 3 Feb 2021 17:56:07 +0000"  >&lt;p&gt;Now that 8.8 is out, can someone take a look at this?&lt;/p&gt;</comment>
                            <comment id="17284648" author="ab" created="Mon, 15 Feb 2021 10:10:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wunder&quot; class=&quot;user-hover&quot; rel=&quot;wunder&quot;&gt;wunder&lt;/a&gt;&#160;can you please create a pull request? this is a sizeable patch and it would make it easier for someone to review / discuss the changes.&lt;/p&gt;</comment>
                            <comment id="17307541" author="atri" created="Wed, 24 Mar 2021 03:56:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wunder&quot; class=&quot;user-hover&quot; rel=&quot;wunder&quot;&gt;wunder&lt;/a&gt;&#160;I am looking at this patch again and will be able to look deeper once the PR is available but had a few thoughts:&lt;/p&gt;

&lt;p&gt;1. I am not sure what is the bugfix that this patch contains (referring to your email) &#8211; can you please elaborate on that?&lt;/p&gt;

&lt;p&gt;2. Same for unit tests &#8211; did I miss the new tests that you mentioned in one of the patch versions?&lt;/p&gt;

&lt;p&gt;3. I am not sure of the documentation changes &#8211; I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctargett&quot; class=&quot;user-hover&quot; rel=&quot;ctargett&quot;&gt;ctargett&lt;/a&gt;&#160;&apos;s opinion is the best path here. Can you please split the documentation changes into a different patch so that we can review independently?&lt;/p&gt;</comment>
                            <comment id="17307552" author="wunder" created="Wed, 24 Mar 2021 04:14:22 +0000"  >&lt;p&gt;1. The bug is that the CPU utilization circuit breaker is not based on CPU utilization. It is based on load average. I&apos;ve changed that to use CPU utilization and added a new new on that is based on load average.&lt;/p&gt;

&lt;p&gt;2. There are now three circuit breakers, all have unit tests. The load average test was moved to the new load average circuit breaker and a new CPU usage test was created for the existing CPU usage breaker.&lt;/p&gt;

&lt;p&gt;3. The documentation changes can&apos;t really be separated because they match the three circuit breakers in the code. Part of the bug was that the code did not match the documentation. The underlying JMX metrics are now named and linked. Other behavior is called out, for example that the circuit breaker only stops search requests, not update or admin requests. The other changes are simplifying grammar and wording, things like using &quot;usage&quot; instead of &quot;utilization&quot; consistently.&lt;/p&gt;</comment>
                            <comment id="17307575" author="atri" created="Wed, 24 Mar 2021 05:12:39 +0000"  >&lt;p&gt;I am sorry, but I have to disagree on some aspects.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The current circuit breaker publishes what it uses and if the documentation is not appropriate, we should fix it.&lt;/li&gt;
	&lt;li&gt;I still do not see what is it that has been fixed in the existing tests &#8211; there is a new circuit breaker implementation, there are tests for that (thank you!). Beyond that, does this patch fix anything in existing tests that I am missing?&lt;/li&gt;
	&lt;li&gt;I am fine with the elaboration (JMX, search requests) but I am not sure about the grammar and wording, hence I would want Cassandra&apos;s opinion there.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In entirety, I agree that the documentation should be extended to highlight more of JMX metrics that we use. The way the framework is built, it is fairly straightforward to implement a new circuit breaker. Hence, I think this patch should be focused on two things: improving documentation and add the new circuit breaker, and the messaging around this Jira should reflect that.&lt;/p&gt;</comment>
                            <comment id="17307856" author="ctargett" created="Wed, 24 Mar 2021 14:25:05 +0000"  >&lt;p&gt;The documentation being part of the patch isn&apos;t a problem for me at all; as a project I feel we should prefer doc updates to be made with the code changes in the same patch or pull request. I can&apos;t always look at doc changes before they are committed, but whether I do it pre- or post-commit it&apos;s always helpful to have all the changes related to an issue together.&lt;/p&gt;

&lt;p&gt;These changes look fine to me &lt;em&gt;as long as they reflect the code changes&lt;/em&gt;. The grammar changes are improvements IMO, but I can only assume that they accurately reflect the code changes.&lt;/p&gt;

&lt;p&gt;Atri, from your perspective, I think you&apos;d want to verify the factual aspects of doc changes. For example, if the docs now say that the circuit breaker tracks the &lt;tt&gt;OperatingSystemMXBean.getSystemCpuLoad()&lt;/tt&gt;, you&apos;d want to check that is true based on the content of the patch. There&apos;s no way I have time to track down every doc change into the code, I expect the code reviewers to have done that (and IMO that&apos;s another reason why the doc changes being part of the patch/PR is helpful).&lt;/p&gt;

&lt;p&gt;I have other minor nits about the doc changes - mainly that I try to put values for parameters in monospace instead of quotes as they are here, but I wouldn&apos;t let that hold up committing this if or when it happens to be ready.&lt;/p&gt;</comment>
                            <comment id="17307865" author="atri" created="Wed, 24 Mar 2021 14:38:16 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctargett&quot; class=&quot;user-hover&quot; rel=&quot;ctargett&quot;&gt;ctargett&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yes, I have verified the doc changes&apos; accuracy as a part of my initial code review. The doc changes are split into two parts:&lt;/p&gt;

&lt;p&gt;1. Updates to the docs for factual information (metrics, requests blocked etc) which are fine.&lt;/p&gt;

&lt;p&gt;2. Grammatical changes aimed at simplifying the documentation (e.g. utilisation - usage).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To be clear, it is 2. that I need your help on, since I do not have an opinion on whether those kind of changes make the impact that they target to or not. I was requesting a separate doc patch &lt;b&gt;specifically&lt;/b&gt; for changes of type 2, since they are numerous and warrant an independent review IMHO.&lt;/p&gt;</comment>
                            <comment id="17332815" author="wunder" created="Tue, 27 Apr 2021 00:18:18 +0000"  >&lt;p&gt;I have made a PR. Let me know if I did it correctly. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/solr/pull/96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/96&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17332818" author="wunder" created="Tue, 27 Apr 2021 00:27:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctargett&quot; class=&quot;user-hover&quot; rel=&quot;ctargett&quot;&gt;ctargett&lt;/a&gt; I&apos;m glad to fix this to follow a standard style.&lt;/p&gt;

&lt;p&gt;The current documentation does not say which JMX metrics are used by each circuit breaker. I added that documentation.&lt;/p&gt;

&lt;p&gt;Some changes document what I found in the code, for example the current documentation says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If circuit breakers are enabled, requests may be rejected under the condition of high node duress with an appropriate HTTP error code (typically 503).&lt;/p&gt;

&lt;p&gt;It is up to the client to handle this error and potentially build a retrial logic as this should ideally be a transient situation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The updated doc says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Circuit breakers only interrupt search requests (`SearchHandler`). They are not checked for update requests, admin requests, etc. They are checked for distributed search requests, so they may result in partial failures for multi-shard requests. Circuit breakers are checked once, early in the request evaluation, before significant work is done. Long-running requests will not be interrupted.&lt;/p&gt;

&lt;p&gt;Servers rejecting traffic with a 503 code may mislead a load balancer into thinking that they are broken, when they are actually intelligently handling overload. This could cause Solr hosts to be dropped from a load balancer, causing a cascading overload on the remaining hosts. Make sure the load balancer is configured to allow the servers to shed excess load with 503 responses.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There are a number of minor changes, mostly simplifying sentence structure or vocabulary. I&apos;ve learned to do this so documents are more accessible to non-native English speakers. For example, &quot;condition of high node duress&quot; is replaced with &quot;high node load&quot;.&lt;/p&gt;

&lt;p&gt;The Wikipedia link is a broken URL, that is also fixed.&lt;/p&gt;</comment>
                            <comment id="17760285" author="janhoy" created="Wed, 30 Aug 2023 08:54:28 +0000"  >&lt;p&gt;Hi. I chatted with Atri and he&apos;s OK with me picking up this JIRA. I&apos;ll try to dive into PRs and get things based on current main.&lt;/p&gt;</comment>
                            <comment id="17767318" author="jira-bot" created="Wed, 20 Sep 2023 22:43:02 +0000"  >&lt;p&gt;Commit 51c1a785c4611d0103f7b73c8adefa028d608bcd in solr&apos;s branch refs/heads/main from wrunderwood&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=51c1a785c46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=51c1a785c46&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15056&quot; title=&quot;CPU circuit breaker needs to use CPU utilization, not Unix load average&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15056&quot;&gt;&lt;del&gt;SOLR-15056&lt;/del&gt;&lt;/a&gt;:  add circuit breaker for CPU, fix load circuit breaker (#96)&lt;/p&gt;

&lt;p&gt;Co-authored-by: Jan H&#248;ydahl &amp;lt;janhoy@users.noreply.github.com&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17767325" author="jira-bot" created="Wed, 20 Sep 2023 23:04:28 +0000"  >&lt;p&gt;Commit a1d0938bbe5ca31a1cd2906d912c0a67952de040 in solr&apos;s branch refs/heads/branch_9x from wrunderwood&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=a1d0938bbe5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=a1d0938bbe5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15056&quot; title=&quot;CPU circuit breaker needs to use CPU utilization, not Unix load average&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15056&quot;&gt;&lt;del&gt;SOLR-15056&lt;/del&gt;&lt;/a&gt;:  add circuit breaker for CPU, fix load circuit breaker (#96)&lt;/p&gt;

&lt;p&gt;Co-authored-by: Jan H&#248;ydahl &amp;lt;janhoy@users.noreply.github.com&amp;gt;&lt;br/&gt;
(cherry picked from commit 51c1a785c4611d0103f7b73c8adefa028d608bcd)&lt;/p&gt;</comment>
                            <comment id="17768004" author="wunder" created="Fri, 22 Sep 2023 13:22:33 +0000"  >&lt;p&gt;Just realized that I didn&apos;t add a line in CHANGES.txt for this. Should that be under Improvements?&lt;/p&gt;</comment>
                            <comment id="17768008" author="janhoy" created="Fri, 22 Sep 2023 13:29:29 +0000"  >&lt;p&gt;It is there &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/CHANGES.txt#L75-L77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/blob/main/solr/CHANGES.txt#L75-L77&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17768021" author="wunder" created="Fri, 22 Sep 2023 13:45:57 +0000"  >&lt;p&gt;Thanks, didn&apos;t see that when searching for &quot;15056&quot; earlier. Not sure why.&lt;/p&gt;</comment>
                            <comment id="17775462" author="alex.parvulescu" created="Sun, 15 Oct 2023 19:57:05 +0000"  >&lt;p&gt;Closing after the 9.4.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13314617">SOLR-14615</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13018781" name="0001-SOLR-15056-Circuit-Breakers-use-CPU-utilization-inst.patch" size="17818" author="wunder" created="Thu, 14 Jan 2021 17:31:21 +0000"/>
                            <attachment id="13018780" name="0002-SOLR-15056-clean-up-linkage-to-SolrCore-add-back-loa.patch" size="31596" author="wunder" created="Thu, 14 Jan 2021 17:31:21 +0000"/>
                            <attachment id="13018595" name="SOLR-15056.patch" size="17814" author="wunder" created="Tue, 12 Jan 2021 01:19:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lns8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>