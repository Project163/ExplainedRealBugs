<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:57:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6540] strdist() causes NPE if doc is missing field</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6540</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;If you try to use the strdist function on a field which is missing in some docs, you&apos;ll get a NullPointerException&lt;/p&gt;

&lt;p&gt;A workarround in some contexts can be to wrap the strdist function in an &quot;if&quot; that checks exists(fieldname) and returns some suitable default if it&apos;s not found.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;THIS:           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(exists(field_name_s),strdist(&lt;span class=&quot;code-quote&quot;&gt;&quot;literal&quot;&lt;/span&gt;,field_name_s,edit),0)
INSTEAD OF:     strdist(&lt;span class=&quot;code-quote&quot;&gt;&quot;literal&quot;&lt;/span&gt;,field_name_s,edit)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12742583">SOLR-6540</key>
            <summary>strdist() causes NPE if doc is missing field</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Sep 2014 21:43:14 +0000</created>
                <updated>Mon, 9 May 2016 18:58:55 +0000</updated>
                            <resolved>Mon, 13 Oct 2014 22:38:25 +0000</resolved>
                                                    <fixVersion>5.0</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14139573" author="hossman" created="Thu, 18 Sep 2014 21:44:19 +0000"  >&lt;p&gt;Steps to reproduce...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hossman@frisbee:~$ curl -X POST -H &apos;Content-Type: application/json&apos; &apos;http://localhost:8983/solr/collection1/update?commit=true&apos; --data-binary &apos;[{&quot;id&quot;:&quot;1&quot;,&quot;foo_s&quot;:&quot;yak&quot;},{&quot;id&quot;:&quot;2&quot;,&quot;foo_s&quot;:&quot;zak&quot;}]&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:369}}
hossman@frisbee:~$ curl &apos;http://localhost:8983/solr/collection1/select?q=*:*&amp;amp;indent=true&amp;amp;wt=json&amp;amp;fl=id,strdist(&quot;ack&quot;,foo_s,edit)&apos;{
  &quot;responseHeader&quot;:{
    &quot;status&quot;:0,
    &quot;QTime&quot;:15,
    &quot;params&quot;:{
      &quot;fl&quot;:&quot;id,strdist(\&quot;ack\&quot;,foo_s,edit)&quot;,
      &quot;indent&quot;:&quot;true&quot;,
      &quot;q&quot;:&quot;*:*&quot;,
      &quot;wt&quot;:&quot;json&quot;}},
  &quot;response&quot;:{&quot;numFound&quot;:2,&quot;start&quot;:0,&quot;docs&quot;:[
      {
        &quot;id&quot;:&quot;1&quot;,
        &quot;strdist(\&quot;ack\&quot;,foo_s,edit)&quot;:0.3333333},
      {
        &quot;id&quot;:&quot;2&quot;,
        &quot;strdist(\&quot;ack\&quot;,foo_s,edit)&quot;:0.3333333}]
  }}
hossman@frisbee:~$ curl -X POST -H &apos;Content-Type: application/json&apos; &apos;http://localhost:8983/solr/collection1/update?commit=true&apos; --data-binary &apos;[{&quot;id&quot;:&quot;3&quot;}]&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:329}}
hossman@frisbee:~$ curl &apos;http://localhost:8983/solr/collection1/select?q=*:*&amp;amp;indent=true&amp;amp;wt=json&amp;amp;fl=id,strdist(&quot;ack&quot;,foo_s,edit)&apos;

... ERROR!

java.lang.NullPointerException
	at org.apache.lucene.search.spell.LevensteinDistance.getDistance(LevensteinDistance.java:66)
	at org.apache.solr.search.function.distance.StringDistanceFunction$1.floatVal(StringDistanceFunction.java:54)
	at org.apache.lucene.queries.function.docvalues.FloatDocValues.objectVal(FloatDocValues.java:71)
	at org.apache.solr.response.transform.ValueSourceAugmenter.transform(ValueSourceAugmenter.java:99)
	at org.apache.solr.response.TextResponseWriter.writeDocuments(TextResponseWriter.java:254)
	at org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:172)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;A quick glance suggests that hte root cause is StringDistanceFunction.getValues&apos;s anonymous inner subclass of FloatDocValues (aka: StringDistanceFunction$1).  Either str1DV.strVal or str1DV.strVal can return null (in which case both of their exists() methods should have returned false, but i haven&apos;t verified that) and they do in fact return null when dealing with string fields that may not always have a value.&lt;/p&gt;

&lt;p&gt;for the particular example shown above, adding an exists() impl to StringDistanceFunction$1 should prevent ValueSourceAugmenter from ever calling floatVal().&lt;/p&gt;

&lt;p&gt;But the question remains as to what floatVal() &lt;em&gt;should&lt;/em&gt; return if/when it is called in this situation? Infinity? NaN? 0.0F?&lt;/p&gt;</comment>
                            <comment id="14139590" author="hossman" created="Thu, 18 Sep 2014 21:57:20 +0000"  >&lt;p&gt;discovered while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6354&quot; title=&quot;Support stats over functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6354&quot;&gt;&lt;del&gt;SOLR-6354&lt;/del&gt;&lt;/a&gt; &amp;#8211; that issue is adding some work arounds to StatsComponentTest (grep for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6540&quot; title=&quot;strdist() causes NPE if doc is missing field&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6540&quot;&gt;&lt;del&gt;SOLR-6540&lt;/del&gt;&lt;/a&gt;) that should be cleaned up when resolving this.&lt;/p&gt;</comment>
                            <comment id="14167451" author="hossman" created="Fri, 10 Oct 2014 20:27:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;But the question remains as to what floatVal() should return if/when it is called in this situation? Infinity? NaN? 0.0F?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;based on the existing StringDistnace contract, the choice i went with...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    // if a ValueSource is missing, it is maximally distant from every other
    // value source *except* for another missing value source 
    // ie: strdist(null,null)==1 but strdist(null,anything)==0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the &lt;tt&gt;exists()&lt;/tt&gt; method on the &lt;tt&gt;strdist()&lt;/tt&gt; value source returns false if the &lt;tt&gt;exists()&lt;/tt&gt; method on either of hte sub-valuesources returns false &amp;#8211; but in cases where a number is asked for anyway (ie: query score context) then 0, unless both are missing in which case they are identical and hte number is 1.&lt;/p&gt;

&lt;p&gt;new tests pass, previously commented out bits of StatsComponentTest passes ... still running full test sweet but i think this is good to go.&lt;/p&gt;</comment>
                            <comment id="14169999" author="jira-bot" created="Mon, 13 Oct 2014 21:19:48 +0000"  >&lt;p&gt;Commit 1631555 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631555&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6540&quot; title=&quot;strdist() causes NPE if doc is missing field&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6540&quot;&gt;&lt;del&gt;SOLR-6540&lt;/del&gt;&lt;/a&gt; Fix NPE from strdist() func when doc value source does not exist in a doc&lt;/p&gt;</comment>
                            <comment id="14170136" author="jira-bot" created="Mon, 13 Oct 2014 22:36:05 +0000"  >&lt;p&gt;Commit 1631592 from hossman@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631592&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6540&quot; title=&quot;strdist() causes NPE if doc is missing field&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6540&quot;&gt;&lt;del&gt;SOLR-6540&lt;/del&gt;&lt;/a&gt; Fix NPE from strdist() func when doc value source does not exist in a doc (merge r1631555)&lt;/p&gt;</comment>
                            <comment id="14332993" author="anshumg" created="Mon, 23 Feb 2015 05:02:59 +0000"  >&lt;p&gt;Bulk close after 5.0 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12732992">SOLR-6354</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12674243" name="SOLR-6540.patch" size="4138" author="hossman" created="Fri, 10 Oct 2014 20:27:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i208cv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>