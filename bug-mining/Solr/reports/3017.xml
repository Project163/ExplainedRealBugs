<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:14:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8858] SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8858</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;If &lt;tt&gt;enableLazyFieldLoading=false&lt;/tt&gt;, a perfectly valid fields filter will be ignored, and we&apos;ll create a &lt;tt&gt;DocumentStoredFieldVisitor&lt;/tt&gt; without it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12950912">SOLR-8858</key>
            <summary>SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="maedhroz">Caleb Rackliffe</reporter>
                        <labels>
                            <label>easyfix</label>
                    </labels>
                <created>Wed, 16 Mar 2016 17:33:21 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:48 +0000</updated>
                            <resolved>Thu, 7 Jul 2016 07:54:51 +0000</resolved>
                                    <version>4.6</version>
                    <version>4.10</version>
                    <version>5.5</version>
                                    <fixVersion>6.2</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15197866" author="githubbot" created="Wed, 16 Mar 2016 18:21:37 +0000"  >&lt;p&gt;GitHub user maedhroz opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/21&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt; SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&lt;/p&gt;

&lt;p&gt;    Instead of just discarding fields if lazy loading is not enabled, SolrIndexSearcher now passes them through to IndexReader. This means IndexReader creates a DocumentStoredFieldVisitor that we can use to later determine which fields need to be read.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-8858&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/maedhroz/lucene-solr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/maedhroz/lucene-solr&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/21.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/21.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #21&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fa8075c7861dbc331588dfb5c9e28576e2eb31f2&lt;br/&gt;
Author: Caleb Rackliffe &amp;lt;caleb.rackliffe@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-03-16T18:15:20Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt; SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&lt;/p&gt;

&lt;p&gt;    Instead of just discarding fields if lazy loading is not enabled, SolrIndexSearcher now passes them through to IndexReader. This means IndexReader creates a DocumentStoredFieldVisitor that we can use to later determine which fields need to be read.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15197870" author="maedhroz" created="Wed, 16 Mar 2016 18:23:20 +0000"  >&lt;p&gt;I&apos;ve posted a PR that fixes this in what I&apos;m hoping is a reasonable way. I imagine the impact will mostly fall on custom &lt;tt&gt;StoredFieldsReader&lt;/tt&gt; implementations.&lt;/p&gt;</comment>
                            <comment id="15279730" author="stephlag" created="Wed, 11 May 2016 07:47:57 +0000"  >&lt;p&gt;Can you remove this issue from version 5.5.1 as this version is packaged without a fix for this issue?&lt;/p&gt;</comment>
                            <comment id="15281537" author="mkhludnev" created="Thu, 12 May 2016 14:04:59 +0000"  >&lt;p&gt;I skim through the patch, didn&apos;t find a test. It&apos;s hard to understand what does it changes . &lt;/p&gt;</comment>
                            <comment id="15281538" author="mkhludnev" created="Thu, 12 May 2016 14:08:48 +0000"  >&lt;p&gt;and also, it seems like a feature to me. In my understanding the difference between two and only one field is neglectable. and it&apos;s enabled only when you really know why do you need it.  &lt;/p&gt;</comment>
                            <comment id="15282091" author="maedhroz" created="Thu, 12 May 2016 21:34:48 +0000"  >&lt;p&gt;We&apos;ve subclassed &lt;tt&gt;StoredFieldsReader&lt;/tt&gt;, and we rely on the &lt;tt&gt;StoredFieldVisitor&lt;/tt&gt; passed to &lt;tt&gt;visitDocument()&lt;/tt&gt; consistently indicating which fields have been requested, even if lazy field loading is disabled. The change to &lt;tt&gt;SolrIndexSearcher&lt;/tt&gt; just makes sure that field information, if it&apos;s available, always makes it into the &lt;tt&gt;StoredFieldVisitor&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15352910" author="shalinmangar" created="Tue, 28 Jun 2016 12:23:08 +0000"  >&lt;p&gt;There are many tests that fail after applying this patch on master. I don&apos;t have the time to dig in to this right now. Caleb, if you can fix the failures, I&apos;d be happy to commit this patch.&lt;/p&gt;</comment>
                            <comment id="15353771" author="maedhroz" created="Tue, 28 Jun 2016 21:55:57 +0000"  >&lt;p&gt;After applying myself on master, the &lt;tt&gt;doc&lt;/tt&gt; method looks like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  @Override
  public Document doc(int i, Set&amp;lt;String&amp;gt; fields) throws IOException {
    Document d;
    if (documentCache != null) {
      d = documentCache.get(i);
      if (d != null) return d;
    }

    final DirectoryReader reader = getIndexReader();
    if (fields != null) {
      if (enableLazyFieldLoading) {
        final SetNonLazyFieldSelector visitor = new SetNonLazyFieldSelector(fields, reader, i);
        reader.document(i, visitor);
        d = visitor.doc;
      } else {
        d = reader.document(i, fields);
      }
    } else {
      d = reader.document(i);
    }

    if (documentCache != null) {
      documentCache.put(i, d);
    }

    return d;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running the tests (i.e. &lt;tt&gt;ant test -Dtests.slow=false&lt;/tt&gt;), I get:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit4] Tests with failures [seed: BB0B954A8C44DF29]:
   [junit4]   - org.apache.solr.response.transform.TestSubQueryTransformer.testTwoSubQueriesAndByNumberWithTwoFields
   [junit4]   - org.apache.solr.response.transform.TestSubQueryTransformer.testJustJohnJavabin
   [junit4]   - org.apache.solr.response.transform.TestSubQueryTransformer.testJustJohnJson
   [junit4]   - org.apache.solr.response.transform.TestSubQueryTransformer.testJohnOrNancySingleField
   [junit4]   - org.apache.solr.response.transform.TestSubQueryTransformer.testThreeLevel
   [junit4]   - org.apache.solr.cloud.DistribJoinFromCollectionTest.testScore
   [junit4]   - org.apache.solr.cloud.DistribJoinFromCollectionTest.testNoScore
   [junit4]   - org.apache.solr.cloud.TestCloudDeleteByQuery (suite)
   [junit4]
   [junit4]
   [junit4] JVM J0:     0.58 ..   415.88 =   415.29s
   [junit4] JVM J1:     0.58 ..   415.81 =   415.23s
   [junit4] JVM J2:     0.58 ..   415.88 =   415.30s
   [junit4] JVM J3:     0.58 ..   415.72 =   415.13s
   [junit4] Execution time total: 6 minutes 56 seconds
   [junit4] Tests summary: 616 suites (10 ignored), 2584 tests, 1 suite-level error, 4 errors, 3 failures, 279 ignored (258 assumptions)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m going to dig into these a bit and see if using the &lt;tt&gt;fields&lt;/tt&gt; set broke some assumptions somewhere...&lt;/p&gt;</comment>
                            <comment id="15354093" author="maedhroz" created="Wed, 29 Jun 2016 01:35:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; The failures I&apos;ve seen thus far all seem to be around how &lt;tt&gt;DocumentStoredFieldVisitor&lt;/tt&gt;, &lt;tt&gt;SolrIndexSearcher&lt;/tt&gt;, and &lt;tt&gt;SubQueryAugmenter&lt;/tt&gt; work together. I&apos;m only able to get the tests in &lt;tt&gt;TestSubQueryTransformer&lt;/tt&gt; to pass if I prepend the &lt;tt&gt;fl&lt;/tt&gt; parameters with &lt;tt&gt;*&lt;/tt&gt;. If there is an actual field list, for instance...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;fl=name_s_dv,depts:[subquery]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...a &lt;tt&gt;DocumentStoredFieldVisitor&lt;/tt&gt; that will only retrieve &lt;tt&gt;name_s_dv&lt;/tt&gt; is created, and the result documents seem to be missing other necessary fields.&lt;/p&gt;</comment>
                            <comment id="15354511" author="githubbot" created="Wed, 29 Jun 2016 04:25:10 +0000"  >&lt;p&gt;Github user maedhroz closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/21&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15354692" author="maedhroz" created="Wed, 29 Jun 2016 06:59:05 +0000"  >&lt;p&gt;I&apos;ve been able to resolve all the failures in &lt;tt&gt;TestSubQueryTransformer&lt;/tt&gt; by simply making sure that all the fields referenced with the &lt;tt&gt;rows.x&lt;/tt&gt; syntax in the sub-queries are present in the &lt;tt&gt;fl&lt;/tt&gt; list. I think that&apos;s actually a reasonable resolution.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TestCloudDeleteByQuery&lt;/tt&gt; and &lt;tt&gt;DistribJoinFromCollectionTest&lt;/tt&gt; have been more elusive, but they smell like they&apos;re both being caused by shard queries that need to retrieve fields from the original &lt;tt&gt;fl&lt;/tt&gt;, but can&apos;t with my patch in place, because only &lt;tt&gt;id&lt;/tt&gt; and &lt;tt&gt;score&lt;/tt&gt; are passed explicitly to &lt;tt&gt;SolrIndexSearcher&lt;/tt&gt; (whereas they would have retrieved all fields before, given lazy loading isn&apos;t enabled).&lt;/p&gt;</comment>
                            <comment id="15354696" author="maedhroz" created="Wed, 29 Jun 2016 07:02:25 +0000"  >&lt;p&gt;Work in progress is at &lt;a href=&quot;https://github.com/maedhroz/lucene-solr/tree/SOLR-8858-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/maedhroz/lucene-solr/tree/SOLR-8858-trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15355721" author="githubbot" created="Wed, 29 Jun 2016 19:36:01 +0000"  >&lt;p&gt;GitHub user maedhroz opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt; SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-8858&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/maedhroz/lucene-solr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/maedhroz/lucene-solr&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt;-trunk&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #47&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="15355848" author="maedhroz" created="Wed, 29 Jun 2016 21:42:15 +0000"  >&lt;p&gt;I&apos;ve posted &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a new PR&lt;/a&gt; against master with some comments. I&apos;m seeing zero failures in an &lt;tt&gt;ant test -Dtests.slow=false&lt;/tt&gt; run, so I think things are in a reviewable state.&lt;/p&gt;</comment>
                            <comment id="15358618" author="githubbot" created="Fri, 1 Jul 2016 08:07:06 +0000"  >&lt;p&gt;Github user shalinmangar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69263675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69263675&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/handler/component/QueryComponent.java &amp;#8212;&lt;br/&gt;
    @@ -910,8 +910,12 @@ protected void createMainQuery(ResponseBuilder rb) &lt;/p&gt;
{
             additionalAdded = addFL(additionalFL, &quot;score&quot;, additionalAdded);
           }
&lt;p&gt;         } else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// reset so that only unique key is requested in shard requests&lt;/li&gt;
	&lt;li&gt;sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());&lt;br/&gt;
    +      if (rb.req.getSearcher().enableLazyFieldLoading) 
{
    +        // reset so that only unique key is requested in shard requests
    +        sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        sreq.params.set(CommonParams.FL, &quot;*&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I don&apos;t understand this change. Why should QueryComponent know about whether lazy loading is enabled or not?&lt;/p&gt;</comment>
                            <comment id="15359129" author="githubbot" created="Fri, 1 Jul 2016 15:30:11 +0000"  >&lt;p&gt;Github user shalinmangar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69316868&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69316868&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/handler/component/QueryComponent.java &amp;#8212;&lt;br/&gt;
    @@ -910,8 +910,12 @@ protected void createMainQuery(ResponseBuilder rb) &lt;/p&gt;
{
             additionalAdded = addFL(additionalFL, &quot;score&quot;, additionalAdded);
           }
&lt;p&gt;         } else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// reset so that only unique key is requested in shard requests&lt;/li&gt;
	&lt;li&gt;sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());&lt;br/&gt;
    +      if (rb.req.getSearcher().enableLazyFieldLoading) 
{
    +        // reset so that only unique key is requested in shard requests
    +        sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        sreq.params.set(CommonParams.FL, &quot;*&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I can see why this change was made but my point is that there is probably an assumption in the join queries or in the test (I haven&apos;t looked) which make it fail without this change.&lt;/p&gt;</comment>
                            <comment id="15359770" author="githubbot" created="Fri, 1 Jul 2016 22:39:19 +0000"  >&lt;p&gt;Github user maedhroz commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69363380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69363380&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/handler/component/QueryComponent.java &amp;#8212;&lt;br/&gt;
    @@ -910,8 +910,12 @@ protected void createMainQuery(ResponseBuilder rb) &lt;/p&gt;
{
             additionalAdded = addFL(additionalFL, &quot;score&quot;, additionalAdded);
           }
&lt;p&gt;         } else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// reset so that only unique key is requested in shard requests&lt;/li&gt;
	&lt;li&gt;sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());&lt;br/&gt;
    +      if (rb.req.getSearcher().enableLazyFieldLoading) 
{
    +        // reset so that only unique key is requested in shard requests
    +        sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        sreq.params.set(CommonParams.FL, &quot;*&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I agree that what I have here is unsatisfying. I&apos;ve been debugging through the fields retrieval phase of the join in `DistribJoinFromCollectionTest`, so hopefully that turns up something...&lt;/p&gt;</comment>
                            <comment id="15360002" author="githubbot" created="Sat, 2 Jul 2016 05:37:17 +0000"  >&lt;p&gt;Github user maedhroz commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69373171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69373171&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/handler/component/QueryComponent.java &amp;#8212;&lt;br/&gt;
    @@ -910,8 +910,12 @@ protected void createMainQuery(ResponseBuilder rb) &lt;/p&gt;
{
             additionalAdded = addFL(additionalFL, &quot;score&quot;, additionalAdded);
           }
&lt;p&gt;         } else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// reset so that only unique key is requested in shard requests&lt;/li&gt;
	&lt;li&gt;sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());&lt;br/&gt;
    +      if (rb.req.getSearcher().enableLazyFieldLoading) 
{
    +        // reset so that only unique key is requested in shard requests
    +        sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        sreq.params.set(CommonParams.FL, &quot;*&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    In the current master (without my patch), the query stage shard request for join in `DistribJoinFromCollectionTest` will pull the document from `SolrIndexSearcher#doc()&apos; with only `id` in the specified `fields`. It does not use lazy field loading, and so uses a `DocumentStoredFieldVisitor` with no `fields` specified to load the whole document, and then put it in the `documentCache`. If we used lazy field loading, the cached document would still have some representation of all the fields, albeit lazy ones.&lt;/p&gt;

&lt;p&gt;    With only the `SolrIndexSearcher` piece of my patch in place, the `TestSubQueryTransformer` failures are easy to avoidl, and I was able to fix them by simply reading the JavaDoc. (See the &lt;span class=&quot;error&quot;&gt;&amp;#91;comment&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47/files/4f9e67c63ce5130795df647ef5e86ae970601cb6#r69015716&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47/files/4f9e67c63ce5130795df647ef5e86ae970601cb6#r69015716&lt;/a&gt;) below.) `DistribJoinFromCollectionTest` (and `TestCloudDeleteByQuery`) fails, because when, as I&apos;ve laid out above, `doc()` actually respects the `fields` list during the main query phase, it caches a document that &lt;b&gt;only contains those fields&lt;/b&gt;. When the actual field retrieval stage of the query hits the shard, `doc()` spits out a document that doesn&apos;t have the all fields in `fl`. (I&apos;m not sure `DistribJoinFromCollectionTest` or `TestCloudDeleteByQuery` are doing something wrong, and they actually &lt;b&gt;pass&lt;/b&gt; if they enable lazy field loading.)&lt;/p&gt;

&lt;p&gt;    The reason I raised this issue in the first place is that I have a custom `StoredFieldsVisitor` that relies on `DocumentStoredFieldVisitor` providing the fields requested by the query. The unfortunate thing is that I think the `QueryComponent` bit of this PR isn&apos;t actually compatible with that, and I think that will need to be reverted no matter what. The only other ways I can imagine fixing this are:&lt;/p&gt;

&lt;p&gt;    a.) Always cache an entire document, regardless of what we return from `doc()`. (Seems like it adds overhead.)&lt;br/&gt;
    b.) Skip caching under certain conditions, like if the `fields` list only contains the unique key (or key and score). (Seems very reliant on `QueryComponent` still.)&lt;br/&gt;
    c.) Always use lazy loading. (Seems invasive, but most of the examples I see use it anyway.)&lt;/p&gt;

&lt;p&gt;    I don&apos;t love any of these options, but I&apos;d be interested to get more informed opinions.&lt;/p&gt;</comment>
                            <comment id="15360970" author="githubbot" created="Mon, 4 Jul 2016 07:46:30 +0000"  >&lt;p&gt;Github user shalinmangar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69419263&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69419263&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/handler/component/QueryComponent.java &amp;#8212;&lt;br/&gt;
    @@ -910,8 +910,12 @@ protected void createMainQuery(ResponseBuilder rb) &lt;/p&gt;
{
             additionalAdded = addFL(additionalFL, &quot;score&quot;, additionalAdded);
           }
&lt;p&gt;         } else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// reset so that only unique key is requested in shard requests&lt;/li&gt;
	&lt;li&gt;sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());&lt;br/&gt;
    +      if (rb.req.getSearcher().enableLazyFieldLoading) 
{
    +        // reset so that only unique key is requested in shard requests
    +        sreq.params.set(CommonParams.FL, rb.req.getSchema().getUniqueKeyField().getName());
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        sreq.params.set(CommonParams.FL, &quot;*&quot;);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Thanks for investigating and the detailed note.&lt;/p&gt;

&lt;p&gt;    I don&apos;t think DistribJoinFromCollectionTest or TestCloudDeleteByQuery are doing anything wrong. The difference, as you said, is that your patch changes `doc()` to actually respect the fields list and when lazy loading is disabled, proceeds to cache an &lt;em&gt;incomplete&lt;/em&gt; document returned by Lucene. So this patch changes Solr from always caching either complete documents (when lazy loading is disabled) or lazy documents (when lazy loading is enabled) to caching potentially incomplete documents which have no idea about the other (non-requested) fields. So if we want to go back to the old behavior then option &apos;a&apos; is the way to go when lazy loading is disabled.&lt;/p&gt;</comment>
                            <comment id="15362056" author="githubbot" created="Tue, 5 Jul 2016 05:57:27 +0000"  >&lt;p&gt;Github user maedhroz commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69510618&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69510618&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java &amp;#8212;&lt;br/&gt;
    @@ -766,16 +766,29 @@ public Document doc(int i, Set&amp;lt;String&amp;gt; fields) throws IOException {&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         final DirectoryReader reader = getIndexReader();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!enableLazyFieldLoading || fields == null) {&lt;/li&gt;
	&lt;li&gt;d = reader.document&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    +    boolean containsAllFields = true;&lt;br/&gt;
    +    &lt;br/&gt;
    +    if (fields != null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      if (enableLazyFieldLoading) {
    +        final SetNonLazyFieldSelector visitor = new SetNonLazyFieldSelector(fields, reader, i);
    +        reader.document(i, visitor);
    +        d = visitor.doc;
    +      } else {
    +        d = reader.document(i, fields);
    +        containsAllFields = false;
    +      }         }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    -      final SetNonLazyFieldSelector visitor = new SetNonLazyFieldSelector(fields, reader, i);
    -      reader.document(i, visitor);
    -      d = visitor.doc;
    +      d = reader.document(i);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         if (documentCache != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;documentCache.put(i, d);&lt;br/&gt;
    +      // Only cache the already retrieved document if it is complete... &lt;br/&gt;
    +      if (containsAllFields) 
{
    +        documentCache.put(i, d);
    +      }
&lt;p&gt; else &lt;/p&gt;
{
    +        // ...and retrieve a complete document for caching otherwise.
    +        documentCache.put(i, reader.document(i));
    +      }
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @shalinmangar I&apos;ve made a pass at restoring the previous caching behavior (with some comments around the rationale). It feels like we might have a complete solution at this point.&lt;/p&gt;</comment>
                            <comment id="15363681" author="dsmiley" created="Wed, 6 Jul 2016 03:15:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;a.) Always cache an entire document, regardless of what we return from `doc()`. (Seems like it adds overhead.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think caching the full doc is expected and what I thought it did.  There isn&apos;t necessarily overhead; maybe some other component (e.g. highlighting) wants a field even though &apos;fl&apos; doesn&apos;t refer to it.  &quot;b&quot; seems fine, too, not sure, but I think &quot;c&quot; (always lazy-load) is bad.&lt;/p&gt;</comment>
                            <comment id="15364383" author="shalinmangar" created="Wed, 6 Jul 2016 14:31:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think caching the full doc is expected and what I thought it did.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is only when lazy loading is disabled. If lazy loading is enabled then a lazy document is cached which may have only a few fields&apos; data and the rest are loaded on access.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;@shalinmangar I&apos;ve made a pass at restoring the previous caching behavior (with some comments around the rationale). It feels like we might have a complete solution at this point.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am not very happy with this solution because from a Solr user&apos;s perspective, this feature adds no benefit but causes stored fields to be read twice for an uncached read? I must also admit that I do not have a good suggestion on how to avoid that.&lt;/p&gt;</comment>
                            <comment id="15364550" author="dsmiley" created="Wed, 6 Jul 2016 16:21:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;That is only when lazy loading is disabled. If lazy loading is enabled then a lazy document is cached which may have only a few fields&apos; data and the rest are loaded on access.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I know that but wasn&apos;t clear in what I said I knew &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; the current behavior seems reasonable &amp;#8211; if no lazy load then grab everything, and if there&apos;s a doc cache stick it there.  In your app with a custom stored field codec, why did you set enableLazyFieldLoading=false?  What do you want to achieve?&lt;/p&gt;</comment>
                            <comment id="15364553" author="githubbot" created="Wed, 6 Jul 2016 16:22:50 +0000"  >&lt;p&gt;Github user dsmiley commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69763447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69763447&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java &amp;#8212;&lt;br/&gt;
    @@ -766,12 +766,16 @@ public Document doc(int i, Set&amp;lt;String&amp;gt; fields) throws IOException {&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         final DirectoryReader reader = getIndexReader();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!enableLazyFieldLoading || fields == null) {&lt;/li&gt;
	&lt;li&gt;d = reader.document&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    +    if (fields != null) {&lt;br/&gt;
    +      if (enableLazyFieldLoading) 
{
    +        final SetNonLazyFieldSelector visitor = new SetNonLazyFieldSelector(fields, reader, i);
    +        reader.document(i, visitor);
    +        d = visitor.doc;
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        d = reader.document(i, fields);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This could lead to a bug when there is a document cache, since we&apos;d cache a partial document without lazy loading.  Then imagine a subsequent doc(i,otherFields), is called and then a document is returned without those fields even if the doc on disk might actually has those fields.&lt;/p&gt;

&lt;p&gt;    On line 770 if (enableLazyFieldLoading) could become: if (enableLazyFieldLoading || documentCache != null).  In this sense, &quot;enableLazyFieldLoading&quot; would have no effect unless there is no doc cache... I&apos;m not sure what to think of that.&lt;/p&gt;</comment>
                            <comment id="15364857" author="maedhroz" created="Wed, 6 Jul 2016 18:39:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;I am not very happy with this solution because from a Solr user&apos;s perspective, this feature adds no benefit but causes stored fields to be read twice for an uncached read? I must also admit that I do not have a good suggestion on how to avoid that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; Unless there&apos;s a less invasive solution I&apos;m overlooking, I think it might be best to abandon this issue as something to handle in Solr proper.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; Our fork actually reads most stored fields from an embedded database and relies on the visitor&apos;s fields information to make decisions about when (and when not) to read stored fields from Solr itself. We don&apos;t actually use &lt;tt&gt;documentCache&lt;/tt&gt; at all, so the fixes I made around the initial patch to get the unit tests passing won&apos;t even be necessary.&lt;/p&gt;

&lt;p&gt;Let me know if there are any objections to closing this...&lt;/p&gt;</comment>
                            <comment id="15364864" author="githubbot" created="Wed, 6 Jul 2016 18:42:35 +0000"  >&lt;p&gt;Github user maedhroz commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47#discussion_r69787760&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47#discussion_r69787760&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java &amp;#8212;&lt;br/&gt;
    @@ -766,12 +766,16 @@ public Document doc(int i, Set&amp;lt;String&amp;gt; fields) throws IOException {&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         final DirectoryReader reader = getIndexReader();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!enableLazyFieldLoading || fields == null) {&lt;/li&gt;
	&lt;li&gt;d = reader.document&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    +    if (fields != null) {&lt;br/&gt;
    +      if (enableLazyFieldLoading) 
{
    +        final SetNonLazyFieldSelector visitor = new SetNonLazyFieldSelector(fields, reader, i);
    +        reader.document(i, visitor);
    +        d = visitor.doc;
    +      }
&lt;p&gt; else {&lt;br/&gt;
    +        d = reader.document(i, fields);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Right. I &lt;b&gt;think&lt;/b&gt; I addressed that in the last commit, since only full documents are cached now. The problem is that the overhead of doing this might be unacceptable.&lt;/p&gt;</comment>
                            <comment id="15364908" author="dsmiley" created="Wed, 6 Jul 2016 19:04:32 +0000"  >&lt;p&gt;If there is no document cache and lazy field loading is disabled, then we can pass through the fields requested to the codec instead of getting them all right?  That wouldn&apos;t break anything nor add inefficiencies that aren&apos;t inherent with a user opting out of these 2 optimizations.&lt;/p&gt;</comment>
                            <comment id="15364916" author="shalinmangar" created="Wed, 6 Jul 2016 19:07:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;If there is no document cache and lazy field loading is disabled, then we can pass through the fields requested to the codec instead of getting them all right? That wouldn&apos;t break anything nor add inefficiencies that aren&apos;t inherent with a user opting out of these 2 optimizations.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to that. That should work for Caleb&apos;s use-case as well.&lt;/p&gt;</comment>
                            <comment id="15365149" author="maedhroz" created="Wed, 6 Jul 2016 21:28:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;If there is no document cache and lazy field loading is disabled, then we can pass through the fields requested to the codec instead of getting them all right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That works for me.&lt;/p&gt;</comment>
                            <comment id="15365765" author="shalinmangar" created="Thu, 7 Jul 2016 07:51:50 +0000"  >&lt;p&gt;Condensed patch which applies to master. I added the following comment for the case where document cache is enabled:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;        // we do not pass the fields in this case because that would return an incomplete document which would&lt;br/&gt;
        // be eventually cached. The alternative would be to read the stored fields twice; once with the fields&lt;br/&gt;
        // and then without for caching leading to a performance hit&lt;br/&gt;
        // see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt; for related discussion&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;All tests and precommit passes. I&apos;ll commit this now.&lt;/p&gt;</comment>
                            <comment id="15365768" author="jira-bot" created="Thu, 7 Jul 2016 07:52:30 +0000"  >&lt;p&gt;Commit 24d6b7846995542c5ccbb4ddcdaa844f78555205 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=24d6b78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=24d6b78&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt;: SolrIndexSearcher#doc() completely ignores field filters unless lazy field loading is enabled.&lt;/p&gt;

&lt;p&gt;This closes #47.&lt;/p&gt;</comment>
                            <comment id="15365771" author="githubbot" created="Thu, 7 Jul 2016 07:53:12 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/47&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15365772" author="jira-bot" created="Thu, 7 Jul 2016 07:53:49 +0000"  >&lt;p&gt;Commit 4921dcd80cb7b8adbb35b62d753b2c965ec92f28 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4921dcd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4921dcd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8858&quot; title=&quot;SolrIndexSearcher#doc() Completely Ignores Field Filters Unless Lazy Field Loading is Enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8858&quot;&gt;&lt;del&gt;SOLR-8858&lt;/del&gt;&lt;/a&gt;: SolrIndexSearcher#doc() completely ignores field filters unless lazy field loading is enabled.&lt;/p&gt;

&lt;p&gt;This closes #47.&lt;br/&gt;
(cherry picked from commit 24d6b78)&lt;/p&gt;</comment>
                            <comment id="15365774" author="shalinmangar" created="Thu, 7 Jul 2016 07:54:52 +0000"  >&lt;p&gt;Thanks Caleb and David!&lt;/p&gt;</comment>
                            <comment id="15439022" author="mikemccand" created="Fri, 26 Aug 2016 14:00:08 +0000"  >&lt;p&gt;Bulk close resolved issues after 6.2.0 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12816587" name="SOLR-8858.patch" size="5280" author="shalin" created="Thu, 7 Jul 2016 07:51:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://github.com/apache/lucene-solr/pull/47]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2urzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>