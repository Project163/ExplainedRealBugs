<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:48:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-15702] Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract</title>
                <link>https://issues.apache.org/jira/browse/SOLR-15702</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Currently all 3 tests in the &lt;tt&gt;S3IncrementalBackupTest&lt;/tt&gt; fail sporadically (between 1-5% of the time on the jenkins instances).&lt;/p&gt;

&lt;p&gt;From my investigations, these failures mainly happen because S3Repository will create a directory node, and then assume it exists later on. However, the S3Mock may be too slow and later on when the assumption is made that this directory node exists, S3Mock is returning that the directory node does not exist.&lt;/p&gt;

&lt;p&gt;The first fix for this was to just always check twice to see if a node is there, kind of hacky but it gives the S3Repository one more chance to find the right information.&lt;/p&gt;

&lt;p&gt;However in the v2 S3 API, there is a concept of &lt;a href=&quot;https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/using.html#using-use-waiters&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;waiters&lt;/a&gt;, which will allow us to wait until S3 verifies the state we are looking for (i.e. that the directory node exists). We can either put this waiter in after creating the node, and not return until the waiter says the node is created. Or we can put it in when checking whether the node exists. I think the former is preferable, but we can do testing to see which actually preforms better.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13407324">SOLR-15702</key>
            <summary>Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houston">Houston Putman</assignee>
                                    <reporter username="houston">Houston Putman</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Oct 2021 15:32:25 +0000</created>
                <updated>Wed, 17 Nov 2021 14:22:46 +0000</updated>
                            <resolved>Mon, 25 Oct 2021 15:17:54 +0000</resolved>
                                    <version>8.10</version>
                                    <fixVersion>8.11</fixVersion>
                                    <component>contrib - S3 Repository</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17431315" author="jira-bot" created="Wed, 20 Oct 2021 15:29:25 +0000"  >&lt;p&gt;Commit 97b0df77a5c0140ce4a907b75def47ffd0152fa2 in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=97b0df7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=97b0df7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15702&quot; title=&quot;Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15702&quot;&gt;&lt;del&gt;SOLR-15702&lt;/del&gt;&lt;/a&gt;: Stabilize S3 tests by using waiters (#356)&lt;/p&gt;
</comment>
                            <comment id="17431316" author="jira-bot" created="Wed, 20 Oct 2021 15:29:29 +0000"  >&lt;p&gt;Commit fd4b3c35d9d4366a62c28fbb620e987efdac70e5 in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=fd4b3c3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=fd4b3c3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15702&quot; title=&quot;Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15702&quot;&gt;&lt;del&gt;SOLR-15702&lt;/del&gt;&lt;/a&gt;: Changelog entry&lt;/p&gt;</comment>
                            <comment id="17431359" author="jira-bot" created="Wed, 20 Oct 2021 16:45:38 +0000"  >&lt;p&gt;Commit 1cc9f4d4dcdfb5733baeb0a237e73a41becfe4d9 in lucene-solr&apos;s branch refs/heads/branch_8x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=1cc9f4d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=1cc9f4d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15702&quot; title=&quot;Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15702&quot;&gt;&lt;del&gt;SOLR-15702&lt;/del&gt;&lt;/a&gt;: Stabilize S3 tests by using waiters (#356)&lt;/p&gt;</comment>
                            <comment id="17431386" author="houston" created="Wed, 20 Oct 2021 17:28:01 +0000"  >&lt;p&gt;Gonna leave this open for a week to see if the tests disappear from &lt;a href=&quot;http://fucit.org/solr-jenkins-reports/failure-report.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://fucit.org/solr-jenkins-reports/failure-report.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17432598" author="houston" created="Thu, 21 Oct 2021 16:45:20 +0000"  >&lt;p&gt;Ok so that previous solution did not fix the tests, in fact it made them worse (by removing the hack fix used previously).&lt;/p&gt;

&lt;p&gt;After deeper investigation, I believe the issue is not around S3Mock having delayed state (and thus not properly showing files existing). Instead the S3Repository does not adhere to the API Guidelines for &lt;tt&gt;createDirectory(URI)&lt;/tt&gt;, namely that it should not recreate directories that already exist.&lt;/p&gt;

&lt;p&gt;The Solr backup commands call a &lt;tt&gt;createDirectory&lt;/tt&gt; at various times, while also checking that the same directory exists (via &lt;tt&gt;pathExists&lt;/tt&gt;) at different times. The issue here is that during the distributed Backup commands, (sent to different nodes for each shard), one node might be at the part of the backup where it is calling &lt;tt&gt;createDirectory&lt;/tt&gt; when another node is calling &lt;tt&gt;pathExists&lt;/tt&gt; for the same directory. In this instance, the S3Mock code fails because it does not properly lock files for concurrent read/write.&lt;/p&gt;

&lt;p&gt;We can easily fix this by making &lt;tt&gt;S3Repository.createDirectory(URI)&lt;/tt&gt; respect the API guidelines, and check that the directory does not exist before trying to create it.&lt;/p&gt;

&lt;p&gt;Sidenote, I notice that the GCSRepository also has this problem. Will raise a separate issue for it.&lt;/p&gt;</comment>
                            <comment id="17432690" author="jira-bot" created="Thu, 21 Oct 2021 19:42:01 +0000"  >&lt;p&gt;Commit 174f7c17e978c9b334099cc47beccbca6ca09149 in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=174f7c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=174f7c1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15702&quot; title=&quot;Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15702&quot;&gt;&lt;del&gt;SOLR-15702&lt;/del&gt;&lt;/a&gt;: Fix S3Repository to follow BackupRepository.createDirectory() API contract&lt;/p&gt;</comment>
                            <comment id="17432732" author="jira-bot" created="Thu, 21 Oct 2021 21:54:42 +0000"  >&lt;p&gt;Commit 033bc9dc5d425a0a774d93712cac190329061a31 in lucene-solr&apos;s branch refs/heads/branch_8x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=033bc9d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=033bc9d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15702&quot; title=&quot;Stabilize S3 Tests - Fix S3Repository to follow BackupRepository.createDirectory API contract&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15702&quot;&gt;&lt;del&gt;SOLR-15702&lt;/del&gt;&lt;/a&gt;: Fix S3Repository to follow BackupRepository.createDirectory() API contract&lt;/p&gt;</comment>
                            <comment id="17445225" author="jpountz" created="Wed, 17 Nov 2021 14:22:46 +0000"  >&lt;p&gt;Closing after the 8.11 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13407829">SOLR-15711</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 51 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vz5c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>