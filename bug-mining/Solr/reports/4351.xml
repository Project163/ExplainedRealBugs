<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:41:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13872]  Backup can fail to read index files w/NoSuchFileException during merges (SOLR-11616 regression)</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13872</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11616&quot; title=&quot;Backup failing on a constantly changing index with NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11616&quot;&gt;&lt;del&gt;SOLR-11616&lt;/del&gt;&lt;/a&gt; purports to fix a bug in Solr&apos;s backup functionality that causes &apos;NoSuchFileException&apos; errors when attempting to backup an index while it is undergoing indexing (and segment merging)&lt;/p&gt;

&lt;p&gt;Although &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11616&quot; title=&quot;Backup failing on a constantly changing index with NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11616&quot;&gt;&lt;del&gt;SOLR-11616&lt;/del&gt;&lt;/a&gt; is marked with &quot;Fix Version: 7.2&quot; it&apos;s pretty easy to demonstrate that this bug still exists on master, branch_8x, and even in 7.2 - so it seems less like the current problem is a &quot;regression&quot; and more that the original fix didn&apos;t work.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;The crux of the problem seems to be concurrency bugs in if/how a commit is &quot;reserved&quot; before attempting to copy the files in that commit to the backup location.  &lt;/p&gt;

&lt;p&gt;A possible work around discussed in more depth in the comments below is to update &lt;tt&gt;solrconfig.xml&lt;/tt&gt; to explicitly configure the &lt;tt&gt;SolrDeletionPolicy&lt;/tt&gt; with either the &lt;tt&gt;maxCommitsToKeep&lt;/tt&gt; or &lt;tt&gt;maxCommitAge&lt;/tt&gt; options to ensure the commits are kept around long enough for the backup to be created.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="13264384">SOLR-13872</key>
            <summary> Backup can fail to read index files w/NoSuchFileException during merges (SOLR-11616 regression)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Oct 2019 00:56:52 +0000</created>
                <updated>Tue, 21 Jan 2020 17:00:15 +0000</updated>
                            <resolved>Wed, 13 Nov 2019 16:58:04 +0000</resolved>
                                                    <fixVersion>8.4</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16959336" author="hossman" created="Fri, 25 Oct 2019 00:58:50 +0000"  >&lt;p&gt;This bug is fairly easy to reproduce using the &quot;techproducts&quot; example &#8211; I&apos;m attaching an &lt;tt&gt;index_churn.pl&lt;/tt&gt; script that I used to continuously add/delete documents with randomized commits &amp;amp; optimizes.&lt;/p&gt;

&lt;p&gt;With this script and the commands below, it never takes more then a few minutes to trigger a failure &#8211; but any sort of heavy indexing/merging should be able to trigger it as well.&lt;/p&gt;

&lt;p&gt;(Run the following commands in diff terminals)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;(ant clean &amp;amp;&amp;amp; cd solr/ &amp;amp;&amp;amp; ant server &amp;amp;&amp;amp; bin/solr -e techproducts -noprompt) &amp;amp;&amp;amp; perl ~/tmp/index_churn.pl&lt;/li&gt;
	&lt;li&gt;watch -n1 -e &quot;curl -D - -sS &apos;http://localhost:8983/solr/techproducts/replication?command=backup&amp;amp;location=/tmp&apos;&quot;&lt;/li&gt;
	&lt;li&gt;(tail -F solr/example/techproducts/logs/solr.log | grep -m1 ERROR) ; echo &quot;Found an error in logs&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;...and wait for 3rd command to exit, Check the solr.log for details&lt;/p&gt;

&lt;p&gt;I&apos;ve confirmed this fails in:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;7.6 (where I first noticed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11616&quot; title=&quot;Backup failing on a constantly changing index with NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11616&quot;&gt;&lt;del&gt;SOLR-11616&lt;/del&gt;&lt;/a&gt; wasn&apos;t actual fixed)&lt;/li&gt;
	&lt;li&gt;7.2 (fix version for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11616&quot; title=&quot;Backup failing on a constantly changing index with NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11616&quot;&gt;&lt;del&gt;SOLR-11616&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;branch_8x (fb37f89af27d881efb0f7b40eff2dc76ef5bc2c4)&lt;/li&gt;
	&lt;li&gt;master (5289fce4bf857861af3644f6240a8369aa9f5407)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Sample error from master...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2019-10-25 00:21:49.170 ERROR (Thread-83) [   ] o.a.s.h.SnapShooter Exception while creating snapshot =&amp;gt; java.nio.file.NoSuchFileException: /home/hossman/lucene/alt_dev/solr/example/techproducts/solr/techproducts/data/index/segments_10l
        at java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:92)
java.nio.file.NoSuchFileException: /home/hossman/lucene/alt_dev/solr/example/techproducts/solr/techproducts/data/index/segments_10l
        at sun.nio.fs.UnixException.translateToIOException(UnixException.java:92) ~[?:?]
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111) ~[?:?]
        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116) ~[?:?]
        at sun.nio.fs.UnixFileSystemProvider.newFileChannel(UnixFileSystemProvider.java:178) ~[?:?]
        at java.nio.channels.FileChannel.open(FileChannel.java:292) ~[?:?]
        at java.nio.channels.FileChannel.open(FileChannel.java:345) ~[?:?]
        at org.apache.lucene.store.MMapDirectory.openInput(MMapDirectory.java:237) ~[?:?]
        at org.apache.lucene.store.NRTCachingDirectory.openInput(NRTCachingDirectory.java:200) ~[?:?]
        at org.apache.lucene.store.Directory.copyFrom(Directory.java:182) ~[?:?]
        at org.apache.solr.core.backup.repository.LocalFileSystemRepository.copyFileFrom(LocalFileSystemRepository.java:145) ~[?:?]
        at org.apache.solr.handler.SnapShooter.createSnapshot(SnapShooter.java:238) ~[?:?]
        at org.apache.solr.handler.SnapShooter.lambda$createSnapAsync$2(SnapShooter.java:205) ~[?:?]
        at java.lang.Thread.run(Thread.java:834) [?:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have not yet dug very deep into the changes made in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11616&quot; title=&quot;Backup failing on a constantly changing index with NoSuchFileException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11616&quot;&gt;&lt;del&gt;SOLR-11616&lt;/del&gt;&lt;/a&gt; to try and understand wy they didn&apos;t fix the problem.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt; to see if he has any ideas what the problem may be.&lt;/p&gt;</comment>
                            <comment id="16960107" author="hossman" created="Fri, 25 Oct 2019 21:21:38 +0000"  >&lt;p&gt;So, based on my naive first glance reading of the SnapShooter &amp;amp; IndexDeletionPolicy code, there &lt;em&gt;seems&lt;/em&gt; to be several bugs at play here &#8211; for the purposes of a reference point for discussion, note these impls of the Async snapshooting in &lt;tt&gt;SnapShooter&lt;/tt&gt;...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void createSnapAsync(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numberToKeep, Consumer&amp;lt;NamedList&amp;gt; result) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    IndexCommit indexCommit;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commitName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      indexCommit = getIndexCommitFromName();
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      indexCommit = getIndexCommit();
    }
    createSnapAsync(indexCommit, numberToKeep, result);
  }

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void createSnapAsync(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; IndexCommit indexCommit, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numberToKeep, Consumer&amp;lt;NamedList&amp;gt; result) {
    &lt;span class=&quot;code-comment&quot;&gt;//TODO should use Solr&apos;s ExecutorUtil
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(() -&amp;gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        result.accept(createSnapshot(indexCommit));
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
        log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; creating snapshot&quot;&lt;/span&gt;, e);
        NamedList snapShootDetails = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NamedList&amp;lt;&amp;gt;();
        snapShootDetails.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;exception&quot;&lt;/span&gt;, e.getMessage());
        result.accept(snapShootDetails);
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        solrCore.getDeletionPolicy().releaseCommitPoint(indexCommit.getGeneration());
      }
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
	&lt;li&gt;Regardless of wether we were asked to snapshot a &lt;tt&gt;commitName&lt;/tt&gt; or just the latest commit (from &lt;tt&gt;getIndexCommit()&lt;/tt&gt;)nothing anywhere in this code path will &quot;reserve&quot; the commit, via &lt;tt&gt;IndexDeletionPolicyWrapper.saveCommitPoint(...)&lt;/tt&gt; before calling &lt;tt&gt;createSnapshot(IndexCommit)&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;Ironically, &lt;tt&gt;createSnapshot(IndexCommit)&lt;/tt&gt; has a psuedo-javadoc reminding callers to do this&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Even if &lt;tt&gt;IndexDeletionPolicyWrapper.saveCommitPoint(...)&lt;/tt&gt; &lt;em&gt;was&lt;/em&gt; called immediately after populating the &lt;tt&gt;IndexCommit indexCommit&lt;/tt&gt; variable, the overall design of this API seems to have some inherent flaws:
	&lt;ul&gt;
		&lt;li&gt;I see no garuntee that an (valid) &lt;tt&gt;IndexCommit&lt;/tt&gt; returned by either &lt;tt&gt;getIndexCommit()&lt;/tt&gt; or &lt;tt&gt;getIndexCommitFromName()&lt;/tt&gt; will still exist at the moment of a subsequent &lt;tt&gt;saveCommitPoint(...)&lt;/tt&gt; call
		&lt;ul&gt;
			&lt;li&gt;meaning that in between those calls, the commit may be deleted by the &lt;tt&gt;IndexDeletionPolicy&lt;/tt&gt; if it is &quot;run&quot; as part of a commit/merge&lt;/li&gt;
			&lt;li&gt;ie: a race condition.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;&lt;tt&gt;IndexDeletionPolicyWrapper.saveCommitPoint(...)&lt;/tt&gt; does not validate that a request to save a commit refers to an &lt;em&gt;existing&lt;/em&gt; commit
		&lt;ul&gt;
			&lt;li&gt;so if/when the race condition mentioned above happens, the &lt;tt&gt;saveCommitPoint(...)&lt;/tt&gt; call will still &quot;succeed&quot; w/o error even if the commit has already been deleted.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Although I&apos;m not sure if/where it&apos;s used, I should also note that similar buggy pattern of code exists in the &quot;non async&quot; method &lt;tt&gt;createSnapshot()&lt;/tt&gt; ... allthough in this case &lt;tt&gt;saveCommitPoint(...)&lt;/tt&gt; is called, but only for the &quot;no commitName specified&quot; code path...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; NamedList createSnapshot() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    IndexCommit indexCommit;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commitName != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      indexCommit = getIndexCommitFromName();
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; createSnapshot(indexCommit);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      indexCommit = getIndexCommit();
      IndexDeletionPolicyWrapper deletionPolicy = solrCore.getDeletionPolicy();
      deletionPolicy.saveCommitPoint(indexCommit.getGeneration());
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; createSnapshot(indexCommit);
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        deletionPolicy.releaseCommitPoint(indexCommit.getGeneration());
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;With those observations in mind, and a rough idea of what the problem seems to be, I did some additional testing and I &lt;b&gt;think&lt;/b&gt;&#160; a possible work around for affected users is to ensure that the SolrDeletionPolicy is configured to keep some number of commits around.&lt;/p&gt;

&lt;p&gt;With the following addition to the techproducts sample &lt;tt&gt;solrconfig.xml&lt;/tt&gt; the steps i mentioned above were unable to reproudce this failure after several hours:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    &amp;lt;deletionPolicy class=&quot;solr.SolrDeletionPolicy&quot;&amp;gt;
      &amp;lt;str name=&quot;maxCommitsToKeep&quot;&amp;gt;10&amp;lt;/str&amp;gt;
    &amp;lt;/deletionPolicy&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;NOTE: 10 was just the first number i picked arbitrary. The minimum number needed will probably depend on the rate of indexing (or, I guess, just the rate of commits?), the overall size of the index, the speed ofthe filesystem, and the overall load on the machine &#8211; in order to ensure that once a Commit is selected by the SnapShooter, that it is preserved long enough by the SolrDeletionPolicy to ensure that no files are removed while the SnapShooter is in the process of doing the file copying to create the backup.&lt;/p&gt;

&lt;p&gt;Users may find the &lt;tt&gt;maxCommitAge&lt;/tt&gt; easier to use for these estimation purposes: Any value larger then the typical amount of &quot;wall clock&quot; time spent when doing backups of their indexes should work (But I have no done any testing of this option, it may have other bugs I&apos;m not aware of)&lt;/p&gt;

&lt;p&gt;The tradeoff of using a work around like this will be increased disk usage for hte index as more commits are preserved in general (even when backup is note used)&lt;/p&gt;

&lt;p&gt;I&apos;ve updated the description of this issue to note this possible work around.&#160; feedback from affected users on the effectiveness of this workaround would be appreciated.&lt;/p&gt;</comment>
                            <comment id="16962282" author="hossman" created="Tue, 29 Oct 2019 17:52:41 +0000"  >
&lt;p&gt;My first inclination is that we&apos;ll need to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;replace &lt;tt&gt;getLatestCommit()&lt;/tt&gt; with something that (atomicly) does a &lt;tt&gt;reserveAndGetLatestCommit()&lt;/tt&gt; type operation&lt;/li&gt;
	&lt;li&gt;make &lt;tt&gt;saveCommitPoint(gen)&lt;/tt&gt; smart enough the error if the specified generation is already deleted, or if it&apos;s less then the latest commit and &quot;unknown&quot; in the current set of commits (ie: last time &lt;tt&gt;updateCommitPoints(..)&lt;/tt&gt; was called)&lt;/li&gt;
	&lt;li&gt;add a lot of synchronization between the methods that &quot;reserve&quot; a commit and the &lt;tt&gt;IndexDeletionPolicy&lt;/tt&gt; abstraction methods that can result in a commit being deleted &amp;#8211; we need to make sure that if someone is reserving a commit there is no thread-safety/race condition if the IndexWriter is concurrently asking (us to ask) the delegate &lt;tt&gt;IndexDeletionPolicy&lt;/tt&gt; to delete that commit.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...but while all of those things are almost certianly neccessary, i&apos;m not sure they are sufficient &amp;#8211; in particular we need to be careful about the order of operations: currently IDPW doesn&apos;t invoke it&apos;s &lt;tt&gt;updateCommitPoints(...)&lt;/tt&gt; method (to modify it&apos;s internal state) until &lt;b&gt;after&lt;/b&gt; it&apos;s delegated the onInit/onCommit calls from the IndexWriter... which means depending on where/how we synchrnize, and where/how exactly we &quot;mark&quot; reservations, we mightstill wind up in a situation where we tell a caller we&apos;ve reserved a commit, right after it&apos;s deleted, but before we &lt;b&gt;KNOW&lt;/b&gt; it&apos;s deleted.&lt;/p&gt;

&lt;p&gt;Adding to my headaches is confusion about the way &quot;named snapshots&quot; and the way &lt;tt&gt;IndexDeletionPolicyWrapper&lt;/tt&gt; depends on (and consults) &lt;tt&gt;SolrSnapshotMetaDataManager&lt;/tt&gt; to know if some commits should be saved (even if not reserved) and if/how the thread safety of &quot;naming&quot; these snapshoots works (or should work).&lt;/p&gt;

&lt;p&gt;It&apos;s weird to me that the relationship isn&apos;t reversed ... that &lt;tt&gt;SolrSnapshotMetaDataManager&lt;/tt&gt; should call &lt;tt&gt;IDPW.saveCommitPoint(gen)&lt;/tt&gt; / &lt;tt&gt;IDPW.releaseCommitPoint(gen)&lt;/tt&gt; instead of eacy &lt;tt&gt;IndexCommitWrapper&lt;/tt&gt; asking the &lt;tt&gt;SolrSnapshotMetaDataManager&lt;/tt&gt; if it can be deleted ... i keep second guessing why it works that way and what i might be missunderstanding and what thread safety issues i might not be thinking about as a result. ... i need to spend more time wrapping my head around these &quot;named snapshots&quot; and their lifecycles and all ofthe code paths that touch that.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Also, a quick followup to the previously suggested workaround...&lt;/p&gt;

&lt;p&gt;In reading up on the code, i realized that even though all of the underlying code paths using IndexDeletionPolicyWrapper have these thread safety issues, the SolrDeletionPolicy configured workaround should work &quot;better&quot; when using the SolrCloud collection API &quot;BACKUP&quot; action, or the (undocumented) CoreAdmin &quot;BACKUP&quot; action instead of using the &lt;tt&gt;/replication&lt;/tt&gt; handler as i was in my testing for a single core.&lt;/p&gt;

&lt;p&gt;The Core/Collection BACKUP actions &lt;b&gt;attempt&lt;/b&gt; to reserve the current commit before the start of the file copying &#8211; meaning that instead of needing to configure large enough values of &lt;tt&gt;maxCommitsToKeep&lt;/tt&gt; or &lt;tt&gt;maxCommitAge&lt;/tt&gt; to ensure that the commit is reserved for the entire duration of the backup process (and all of the underlying disk IO), you can (in theory) use smaller values because you only need to configure them to reserve a commit long enough for the SnapShooter code to have a chance to start and do it&apos;s own reservation.&lt;/p&gt;</comment>
                            <comment id="16966907" author="hossman" created="Mon, 4 Nov 2019 18:51:06 +0000"  >
&lt;p&gt;Ok, I think i have enough of a handle on what&apos;s going on, and what &lt;b&gt;needs&lt;/b&gt; to be going on to move forward...&lt;/p&gt;

&lt;p&gt;First off &amp;#8211; I&apos;m attaching a patch with some new/additional tests logic:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TestStressThreadBackup in particular is a starting point for a robust test similar to the manual steps to reproduce that i posted above.
	&lt;ul&gt;
		&lt;li&gt;It tests using both the REplicationHandler and the CoreAdmin API for doing core backups.&lt;/li&gt;
		&lt;li&gt;it fails easily for me using replication handler, but iv&apos;e never actual seen it fail using the CoreApi (which jives with my previous comment about the window of time for the race condition being shorter in thta code path)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;The changes to TestCoreBackup and TestReplicationHandler are largely just to prove to myself that most of the complexity in the IndexDeletionPolicyWrapper as far as allowing callers to pass in an arbitrary commit (instead of the &quot;latest&quot; commit that IndexDeletionPolicyWrapper knows about) is really not needed (AFAICT ... i may have missed a use case).
	&lt;ul&gt;
		&lt;li&gt;So most of the &quot;If no latest commit in IDWP, then use &amp;amp; reserve latest commit from searcher&quot; is not needed&lt;/li&gt;
		&lt;li&gt;In fact, because of how the &quot;NRT&quot; readers in use by the SolrIndexSearcher work, it&apos;s a really bad idea to do this
		&lt;ul&gt;
			&lt;li&gt;see additions to TestIndexWriterReader and TestCoreBackup.testDemoWhyBackupCodeShouldNeverUseIndexCommitFromSearcher&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So with all this in mind, i&apos;m going to move forward with the basic API changes i proposed before, and &amp;#8211; i think &amp;#8211; make hte delete() method in the Delegate IndexCommit wrappers synchronize on the outer IndexDeletionPolicyWrapper to address the main synchronization concerns i had before.  from what i can see so far that, combined with a new (synchronized) method to atomically &quot;getAndReserveLatestCommit()&quot;, should fix the API flaws (when used properly in the caller code, which i&apos;ll also work on).&lt;/p&gt;

&lt;p&gt;I&apos;m also going to try and remove some of the duplicate code paths in SnapShooter &amp;#8211; there&apos;s no reason why createSnapshot and createSnapAsync should look so similar and still be so different &amp;#8211; the async code paths should just call the same methods as the sync code path, but in a thread.&lt;/p&gt;</comment>
                            <comment id="16970446" author="hossman" created="Fri, 8 Nov 2019 17:36:49 +0000"  >&lt;p&gt;Ok, here&apos;s a patch with the API/Usage changes I think we should make.&lt;/p&gt;

&lt;p&gt;There are still a lot of nocommits, but mostly just related to additional test coverage I want to add (and most of that is around named snapshots since i didn&apos;t dig into that very deep and i want to make sure taking backups that way is as solid as the &quot;simple&quot; path) but I think the new API &amp;amp; synchornization logic is pretty solid.&lt;/p&gt;

&lt;p&gt;There&apos;s also a few places were I have nocommits related to needing to spin out loosly related jiras.  Once I&apos;ve done that i&apos;ll slim down this patch a bit and link those jiras and then finish up the tests.&lt;/p&gt;</comment>
                            <comment id="16970648" author="hossman" created="Fri, 8 Nov 2019 23:39:33 +0000"  >&lt;p&gt;updated patch working away at some of the remaining nocommit...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;removed nocommits related to things spun off into new (linked) jiras&lt;/li&gt;
	&lt;li&gt;test additions&lt;/li&gt;
	&lt;li&gt;ref-guide note about backups when using softCommit&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16972070" author="hossman" created="Tue, 12 Nov 2019 05:13:35 +0000"  >&lt;p&gt;updated patch with finished tests and all nocommits resolved.&lt;/p&gt;

&lt;p&gt;i think this is ready&lt;/p&gt;</comment>
                            <comment id="16972973" author="lucenesolrqa" created="Wed, 13 Nov 2019 03:13:28 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 3 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  8s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  2s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  2s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  5s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  2s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  2s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate ref guide &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  2s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 46m 17s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; core in the patch passed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; 51m  4s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13872&quot; title=&quot; Backup can fail to read index files w/NoSuchFileException during merges (SOLR-11616 regression)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13872&quot;&gt;&lt;del&gt;SOLR-13872&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12985582/SOLR-13872.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12985582/SOLR-13872.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  validaterefguide  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene1-us-west 4.15.0-54-generic #58-Ubuntu SMP Mon Jun 24 10:55:24 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / 5df9a51cbfb &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.10.5 compiled on March 28 2019 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; LTS &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/595/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/595/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core solr/solr-ref-guide U: solr &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/595/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/595/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16973470" author="jira-bot" created="Wed, 13 Nov 2019 15:59:07 +0000"  >&lt;p&gt;Commit 30e55e2b6efc55c04761b80c22a106f4a1115722 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=30e55e2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=30e55e2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13872&quot; title=&quot; Backup can fail to read index files w/NoSuchFileException during merges (SOLR-11616 regression)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13872&quot;&gt;&lt;del&gt;SOLR-13872&lt;/del&gt;&lt;/a&gt;: Fixed Backup failures due to race conditions in saving/reserving commit points&lt;/p&gt;</comment>
                            <comment id="16973517" author="jira-bot" created="Wed, 13 Nov 2019 16:57:46 +0000"  >&lt;p&gt;Commit 8c12979fddd4fe822a300d1b04d49f93b5106916 in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8c12979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8c12979&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13872&quot; title=&quot; Backup can fail to read index files w/NoSuchFileException during merges (SOLR-11616 regression)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13872&quot;&gt;&lt;del&gt;SOLR-13872&lt;/del&gt;&lt;/a&gt;: Fixed Backup failures due to race conditions in saving/reserving commit points&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 30e55e2b6efc55c04761b80c22a106f4a1115722)&lt;/p&gt;</comment>
                            <comment id="16975259" author="hossman" created="Fri, 15 Nov 2019 17:15:59 +0000"  >&lt;p&gt;FYI: the jenkins job &lt;tt&gt;thetaphi/Lucene-Solr-master-Windows/8235&lt;/tt&gt; recently failed in &lt;tt&gt;org.apache.solr.handler.TestReplicationHandler.testEmptyBackup&lt;/tt&gt; due to &lt;tt&gt;empty_backup2&lt;/tt&gt; not being on disk where/when the test expected it &amp;#8211; this is due to me (foolishly) using CheckBackupStatus in that method, which i later realized isn&apos;t suitable for dealing with using in a test with more then one backup.&lt;/p&gt;

&lt;p&gt;This is already fixed in the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13909&quot; title=&quot;Everything about CheckBackupStatus is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13909&quot;&gt;&lt;del&gt;SOLR-13909&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16989113" author="dsmiley" created="Thu, 5 Dec 2019 19:59:42 +0000"  >&lt;p&gt;This is a really impressive investigation Hoss; I am in awe!&lt;/p&gt;</comment>
                            <comment id="17004942" author="jpountz" created="Sun, 29 Dec 2019 20:50:04 +0000"  >&lt;p&gt;Closing after the 8.4.0 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13267161">LUCENE-9040</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13267162">SOLR-13908</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13116767">SOLR-11616</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13267168">SOLR-13909</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12985582" name="SOLR-13872.patch" size="85949" author="hossman" created="Tue, 12 Nov 2019 05:13:04 +0000"/>
                            <attachment id="12985410" name="SOLR-13872.patch" size="81371" author="hossman" created="Fri, 8 Nov 2019 23:37:52 +0000"/>
                            <attachment id="12985378" name="SOLR-13872.patch" size="76518" author="hossman" created="Fri, 8 Nov 2019 17:32:14 +0000"/>
                            <attachment id="12984826" name="SOLR-13872.patch" size="30529" author="hossman" created="Mon, 4 Nov 2019 18:48:08 +0000"/>
                            <attachment id="12983978" name="index_churn.pl" size="1201" author="hossman" created="Fri, 25 Oct 2019 00:57:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07xsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>