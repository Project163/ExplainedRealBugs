<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:44:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14409] Existing violations allow bypassing policy rules when adding new replicas</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14409</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;start with an empty cluster policy.&lt;/li&gt;
	&lt;li&gt;create a collection with as many replicas as there are nodes.&lt;/li&gt;
	&lt;li&gt;add one more replica to any node. Now this node has two replicas, all other nodes have one.&#160;&lt;/li&gt;
	&lt;li&gt;define the following cluster policy:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{ &lt;span class=&quot;code-quote&quot;&gt;&apos;set-cluster-policy&apos;&lt;/span&gt;: [ {&lt;span class=&quot;code-quote&quot;&gt;&apos;replica&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;2&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;shard&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;#ANY&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;node&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;#ANY&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;strict&apos;&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} ] } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This automatically creates a violation because of the existing layout.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;try adding one more replica. This should fail because no node satisfies the rules (there must be at most 1 replica per node). However, the command succeeds and adds replica to the node that already has 2 replicas, which clearly violates the policy and makes matters even worse.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13298753">SOLR-14409</key>
            <summary>Existing violations allow bypassing policy rules when adding new replicas</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Apr 2020 09:34:16 +0000</created>
                <updated>Wed, 15 Jul 2020 15:09:24 +0000</updated>
                            <resolved>Thu, 25 Jun 2020 01:21:08 +0000</resolved>
                                    <version>8.5</version>
                    <version>8.6</version>
                    <version>9.0</version>
                                    <fixVersion>8.6</fixVersion>
                                    <component>AutoScaling</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17084714" author="ab" created="Thu, 16 Apr 2020 09:44:25 +0000"  >&lt;p&gt;This patch illustrates the problem.&lt;/p&gt;

&lt;p&gt;This may be a bug in &lt;tt&gt;AddReplicaSuggester&lt;/tt&gt; or in &lt;tt&gt;Suggester.isLessSerious / containsNewErrors&lt;/tt&gt; .&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;AddReplicaSuggester&lt;/tt&gt; tries all nodes but they all produce new violations - except for the one that already has a violation. So for all other nodes the condition in &lt;tt&gt;AddReplicaSuggester:55 if (!containsNewErrors(errs))&lt;/tt&gt; is always false because they produce new errors. As a side-effect of this the variable &lt;tt&gt;leastSeriousViolation&lt;/tt&gt; is never assigned.&lt;/p&gt;

&lt;p&gt;Finally, for the node that already has a violation the change does not produce a new violation, it only increases the severity of the existing one - but the code doesn&apos;t check this because &lt;tt&gt;leastSeriousViolation&lt;/tt&gt; is null, so it treats the current error as the least serious.&lt;/p&gt;

&lt;p&gt;This may be the conceptual problem here - if there were no other errors then shouldn&apos;t the current errors be the most serious? but in this case there&apos;s already a pre-existing violation on this node so perhaps the &lt;tt&gt;leastSeriousViolation&lt;/tt&gt; should always be initialized with the existing violations? (I tried it and many unit tests started failing...)&lt;/p&gt;</comment>
                            <comment id="17085111" author="ab" created="Thu, 16 Apr 2020 17:21:18 +0000"  >&lt;p&gt;Escalating to Critical as it breaks the autoscaling placement for common scenarios.&lt;/p&gt;</comment>
                            <comment id="17094356" author="ab" created="Tue, 28 Apr 2020 10:09:05 +0000"  >&lt;p&gt;Escalating to Blocker - doesn&apos;t make sense to release 8.6 without a fix for this issue.&lt;/p&gt;</comment>
                            <comment id="17096457" author="noble.paul" created="Thu, 30 Apr 2020 11:51:35 +0000"  >&lt;p&gt;I&apos;ll fix this soon&lt;/p&gt;</comment>
                            <comment id="17144555" author="jira-bot" created="Thu, 25 Jun 2020 00:33:39 +0000"  >&lt;p&gt;Commit 419560ef2a5a04ab9d77d3428459e1aa08253764 in lucene-solr&apos;s branch refs/heads/master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=419560e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=419560e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when add&#8230; (#1598)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when adding new replicas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17144556" author="jira-bot" created="Thu, 25 Jun 2020 00:33:40 +0000"  >&lt;p&gt;Commit 419560ef2a5a04ab9d77d3428459e1aa08253764 in lucene-solr&apos;s branch refs/heads/master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=419560e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=419560e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when add&#8230; (#1598)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when adding new replicas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17144574" author="jira-bot" created="Thu, 25 Jun 2020 01:20:41 +0000"  >&lt;p&gt;Commit da2ba970de32189b4e767b79ca0b6b0496be42f1 in lucene-solr&apos;s branch refs/heads/branch_8x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=da2ba97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=da2ba97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when add&#8230; (#1598)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when adding new replicas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17144575" author="jira-bot" created="Thu, 25 Jun 2020 01:20:42 +0000"  >&lt;p&gt;Commit da2ba970de32189b4e767b79ca0b6b0496be42f1 in lucene-solr&apos;s branch refs/heads/branch_8x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=da2ba97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=da2ba97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when add&#8230; (#1598)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14409&quot; title=&quot;Existing violations allow bypassing policy rules when adding new replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14409&quot;&gt;&lt;del&gt;SOLR-14409&lt;/del&gt;&lt;/a&gt;: Existing violations allow bypassing policy rules when adding new replicas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17158284" author="broustant" created="Wed, 15 Jul 2020 15:09:24 +0000"  >&lt;p&gt;Closing after the 8.6.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13190310">SOLR-12847</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13000115" name="SOLR-14409.patch" size="2765" author="ab" created="Thu, 16 Apr 2020 09:35:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dp48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>