<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:25:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3109] group=true requests result in numerous redundant shard requests</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3109</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;During the second phase of a group query, the collator sends a query to each of the shards.  The purpose of this query is for shards to respond with the doc ids that match the set of group ids returned from the first phase.  The problem is that it sends this second query to each shard multiple times.  Specifically, in an environment with n shards, each shard will be hit with an identical query n times during the second phase of query processing, resulting in O(&lt;em&gt;n&lt;/em&gt; &lt;sup&gt;2&lt;/sup&gt;) performance where &lt;em&gt;n&lt;/em&gt; is the number of shards.&lt;/p&gt;

&lt;p&gt;I have traced this bug down to a single line in &lt;tt&gt;TopGroupsShardRequestFactory.java&lt;/tt&gt;, and I am attaching a patch. &lt;/p&gt;</description>
                <environment>&lt;p&gt;64-bit Linux, sharded environment&lt;/p&gt;</environment>
        <key id="12541750">SOLR-3109</key>
            <summary>group=true requests result in numerous redundant shard requests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="martijn.v.groningen">Martijn van Groningen</assignee>
                                    <reporter username="rblack">Russell Black</reporter>
                        <labels>
                            <label>patch</label>
                            <label>performance</label>
                    </labels>
                <created>Wed, 8 Feb 2012 05:26:20 +0000</created>
                <updated>Fri, 10 May 2013 10:39:27 +0000</updated>
                            <resolved>Mon, 13 Feb 2012 13:09:58 +0000</resolved>
                                    <version>3.5</version>
                    <version>4.0-ALPHA</version>
                                    <fixVersion>3.6</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13203303" author="rblack" created="Wed, 8 Feb 2012 05:59:32 +0000"  >&lt;p&gt;The patch changes this line of code in &lt;tt&gt;TopGroupsShardRequestFactory.java&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sreq.actualShards = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {shard};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;becomes &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sreq.shards = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {shard};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To see why this was a problem, look at &lt;tt&gt;SearchHandler.java&lt;/tt&gt; line 249:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sreq.actualShards = sreq.shards &lt;span class=&quot;code-comment&quot;&gt;// sets actualShards to &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sreq.actualShards==ShardRequest.ALL_SHARDS ) { &lt;span class=&quot;code-comment&quot;&gt;//ALL_SHARDS is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;  sreq.actualShards = rb.shards; &lt;span class=&quot;code-comment&quot;&gt;// every shard!
&lt;/span&gt;}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This sets actualShards to null, which means send the request to &lt;b&gt;every&lt;/b&gt; shard.&lt;/p&gt;</comment>
                            <comment id="13203353" author="martijn.v.groningen" created="Wed, 8 Feb 2012 08:09:54 +0000"  >&lt;p&gt;That doesn&apos;t look good... Thanks for bringing this up!&lt;/p&gt;</comment>
                            <comment id="13203990" author="martijn.v.groningen" created="Wed, 8 Feb 2012 21:14:12 +0000"  >&lt;p&gt;I noticed that the distributed test failed with this patch. After some digging I found out that the TopGroupsShardResponseProcessor can&apos;t really deal with multiple ShardRequests... I&apos;ve updated the patch so that only one ShardRequest is created by the TopGroupsShardRequestFactory. Test passes now and I don&apos;t see any redundant real http requests being generated. &lt;/p&gt;

&lt;p&gt;Russell can you confirm this as well?&lt;/p&gt;</comment>
                            <comment id="13204065" author="rblack" created="Wed, 8 Feb 2012 22:34:39 +0000"  >&lt;p&gt;Martijn, I also noticed that &lt;tt&gt;TopGroupsShardResponseProcessor&lt;/tt&gt; can&apos;t deal with multiple ShardRequests (although it looks like it wouldn&apos;t be to hard to add this ability).  At any rate, your approach of returning a single ShardRequest containing all relevant shards sounds like the right one.  I went one step further and refactored &lt;tt&gt;TopGroupsShardRequestFactory.java&lt;/tt&gt; because there was significant code duplication in the class&apos;s two primary methods.  &lt;/p&gt;

&lt;p&gt;In my testing I also discovered a closely related problem.  The bug is in the data structure used to map search groups to the shards which contain them.  &lt;tt&gt;ResponseBuilder.searchGroupToShard&lt;/tt&gt; assumes that a given search group only resides on one shard.  I could not find this assumption documented anywhere, nor can I find a reason such a restriction need be imposed.  This structure is populated by &lt;tt&gt;SearchGroupShardResponseProcessor&lt;/tt&gt;.  There is a race condition there, wherein the last shard to report a search group will be assumed to be the only shard containing the search group.  This data structure is used in &lt;tt&gt;TopGroupsShardRequestFactory.createRequestForSpecificShards()&lt;/tt&gt; to know which shards to query.  This means you can get a different set of shards to query depending on shard query order.  &lt;/p&gt;

&lt;p&gt;I have changed the structure to allow a search group to be present in multiple shards.  &lt;/p&gt;

&lt;p&gt;Patch to follow.  &lt;/p&gt;</comment>
                            <comment id="13204362" author="martijn.v.groningen" created="Thu, 9 Feb 2012 08:38:22 +0000"  >&lt;p&gt;Thanks for the refactoring!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The bug is in the data structure used to map search groups to the shards which contain them. ResponseBuilder.searchGroupToShard assumes that a given search group only resides on one shard. I could not find this assumption documented anywhere, nor can I find a reason such a restriction need be imposed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There is no such restriction. A search group can reside on more than one shard. I wonder why this issue didn&apos;t result in test failure / bugs from the beginning. I guess b/c of the redundant requests all shards were queried and this way the end result was still correct. At least the latest patch I added should have resulted in a test failure but it didn&apos;t. Can you share how you did this testing? This can then be added to the TestDistributedGrouping test class.&lt;/p&gt;</comment>
                            <comment id="13204533" author="rblack" created="Thu, 9 Feb 2012 14:01:53 +0000"  >&lt;p&gt;The current &lt;tt&gt;TestDistributedGrouping&lt;/tt&gt; test case is constructed in such a way that each record has a unique value for it&apos;s search group field (&lt;tt&gt;i1&lt;/tt&gt;), so that there is never more than one record in any given search group.  This style of indexing conforms to the restriction discussed earlier.  This is likely the reason there were no test failures.  &lt;/p&gt;</comment>
                            <comment id="13204612" author="martijn.v.groningen" created="Thu, 9 Feb 2012 16:12:08 +0000"  >&lt;p&gt;Yes, that might be the reason. The &lt;tt&gt;TestDistributedGrouping&lt;/tt&gt; needs to be changed, so that a search group contains multiple records.&lt;/p&gt;</comment>
                            <comment id="13204653" author="rblack" created="Thu, 9 Feb 2012 17:04:27 +0000"  >&lt;p&gt;In &lt;tt&gt;TestDistributedGrouping&lt;/tt&gt; you wrote the following comment:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-comment&quot;&gt;// In order to validate &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; we need to make sure that during indexing that all documents of one group only occur on the same shard&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I wanted to understand the reason for that comment before making any changes to the test case.  (Assuming you wanted me to update the test case &amp;#8211; if not, I&apos;ll leave the test case in your hands)&lt;/p&gt;</comment>
                            <comment id="13204737" author="martijn.v.groningen" created="Thu, 9 Feb 2012 18:55:20 +0000"  >&lt;p&gt;No worries &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I didn&apos;t want to move this work to anyone. Just wanted to say that the test needs to be updated.&lt;/p&gt;

&lt;p&gt;I put that comment b/c in the following three lines group.ngroups and group.truncate features are tested. These features &lt;b&gt;only&lt;/b&gt; work properly if documents belonging to a group reside in the same shard. If documents belonging to a group do occur in more than one shard then the results are very likely incorrect.&lt;/p&gt;

&lt;p&gt;Tomorrow I will update the test case and get this patch committed. If you want to update the test case and have time for that that would be great!&lt;/p&gt;</comment>
                            <comment id="13204745" author="rblack" created="Thu, 9 Feb 2012 19:09:28 +0000"  >&lt;p&gt;I&apos;ll let you do the test case, as I don&apos;t have a lot of time to spend on this.  If there is a possibility of another 3.x release, I would like to backport the patch the 3x branch as well.  Let me know, and I can create the 3x backport once you have updated the test case and have your final 4.0 patch.  I have already created a 3_5 backport that we will be using internally until the next release.  &lt;/p&gt;</comment>
                            <comment id="13204773" author="martijn.v.groningen" created="Thu, 9 Feb 2012 19:41:40 +0000"  >&lt;p&gt;You can share your 3.5 patch as you have it now. I think that applying the test changes to 3x branch isn&apos;t much effort.&lt;br/&gt;
As far as I know there will be a 3.6 release, so this bug fix will also be included in the this release. &lt;/p&gt;</comment>
                            <comment id="13204778" author="martijn.v.groningen" created="Thu, 9 Feb 2012 19:46:49 +0000"  >&lt;p&gt;Russell, when attaching a patch can you click on the option box with the label:&lt;br/&gt;
Grant license to ASF for inclusion in ASF works &lt;/p&gt;

&lt;p&gt;Assuming that you want to include your bug fixes to Solr.&lt;/p&gt;</comment>
                            <comment id="13204841" author="cyoung" created="Thu, 9 Feb 2012 20:48:09 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The bug is in the data structure used to map search groups to the shards which contain them. ResponseBuilder.searchGroupToShard assumes that a given search group only resides on one shard. I could not find this assumption documented anywhere, nor can I find a reason such a restriction need be imposed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Perhaps this could be left in as an advanced option. It would be a performance boost for anyone who can guarantee that a group will reside wholly on a single shard.&lt;/p&gt;

&lt;p&gt;group.distributeGroupCollation=true|false defaults to true&lt;/p&gt;</comment>
                            <comment id="13204862" author="rblack" created="Thu, 9 Feb 2012 20:58:32 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Perhaps this could be left in as an advanced option. It would be a performance boost for anyone who can guarantee that a group will reside wholly on a single shard.&lt;/p&gt;

&lt;p&gt;group.distributeGroupCollation=true|false defaults to true&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As the patch currently stands, someone who can guarantee that a group will reside wholly on a single shard will benefit already because it will only send the query the shard that contains the group of interest.  There would be no need to have a separate advanced option.  I simply made the data structure allow for the &lt;em&gt;possibility&lt;/em&gt; of having multiple shards per group, but there is no additional overhead for the single-shard case.  &lt;/p&gt;</comment>
                            <comment id="13204886" author="gbowyer@fastmail.co.uk" created="Thu, 9 Feb 2012 21:21:20 +0000"  >&lt;p&gt;Since I need to test this to see if it is responsible for my large profiler costs spent in scoring and grouping I also backported this&lt;/p&gt;

&lt;p&gt;Patch attached that does a backport to Solr 3.5 +&lt;/p&gt;

&lt;p&gt;If my patch is terrifying please scream at me and replace it with a better one, but I figure it will be much the one already commented on.&lt;/p&gt;</comment>
                            <comment id="13204973" author="rblack" created="Thu, 9 Feb 2012 22:40:53 +0000"  >&lt;p&gt;Greg, I had some trouble applying your patch to my code base, although visually it looks like the right changes.  Is your patch intended for the 3_5 branch or 3x branch?  I have attached my own version of the patch.  It is a patch against the 3.5 branch (&lt;a href=&quot;http://svn.apache.org/repos/asf/lucene/dev/branches/lucene_solr_3_5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/lucene/dev/branches/lucene_solr_3_5/&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13205088" author="gbowyer@fastmail.co.uk" created="Fri, 10 Feb 2012 00:14:28 +0000"  >&lt;p&gt;Its for the 3.5 branch, but like I said I was jumping the gun, if your patch applies forget mine and go with that&lt;/p&gt;</comment>
                            <comment id="13205513" author="rblack" created="Fri, 10 Feb 2012 15:48:27 +0000"  >&lt;p&gt;Re-uploaded the same 4.0 patch as before, this time with &quot;Grant license to ASF&quot; checked.&lt;/p&gt;</comment>
                            <comment id="13206571" author="martijn.v.groningen" created="Mon, 13 Feb 2012 00:14:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The current TestDistributedGrouping test case is constructed in such a way that each record has a unique value for it&apos;s search group field (i1), so that there is never more than one record in any given search group. This style of indexing conforms to the restriction discussed earlier. This is likely the reason there were no test failures.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this issue doesn&apos;t exist in the released versions of Solr / 4.0-dev. Due to the bug that all shards were queried for each ShardRequest instance and all the matching top search groups still arrived at the right shard. Only after applying the changes to TopGroupsShardRequestFactory I could let the distributed grouping test fail.&lt;/p&gt;</comment>
                            <comment id="13206575" author="martijn.v.groningen" created="Mon, 13 Feb 2012 00:15:51 +0000"  >&lt;p&gt;Committed to branch3x and trunk.&lt;br/&gt;
Thanks Russell and Greg for reporting and fixing this issue!&lt;/p&gt;</comment>
                            <comment id="13206588" author="rblack" created="Mon, 13 Feb 2012 00:35:27 +0000"  >&lt;p&gt;Thanks for the quick turnaround on this! It was fun to contribute.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12514008" name="SOLR-3109-Backport-of-grouping-performace-fix-to-3.x.patch" size="11919" author="gbowyer@fastmail.co.uk" created="Thu, 9 Feb 2012 21:21:20 +0000"/>
                            <attachment id="12514023" name="SOLR-3109-lucene_solr_3_5.patch" size="10334" author="rblack" created="Thu, 9 Feb 2012 22:40:53 +0000"/>
                            <attachment id="12514112" name="SOLR-3109.patch" size="11213" author="rblack" created="Fri, 10 Feb 2012 15:48:27 +0000"/>
                            <attachment id="12513863" name="SOLR-3109.patch" size="8111" author="martijn.v.groningen" created="Wed, 8 Feb 2012 21:14:11 +0000"/>
                            <attachment id="12513763" name="SOLR-3109.patch" size="1276" author="rblack" created="Wed, 8 Feb 2012 05:31:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 41 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03gn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18129</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>