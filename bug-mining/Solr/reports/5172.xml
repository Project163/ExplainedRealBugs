<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:09:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17200] &quot;False Positive&quot; Race conditions using &quot;/health?requireHealthyCores=true&quot; near startup</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17200</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;There seem to be at least two possible thread race conditions that can lead &lt;tt&gt;/health?requireHealthyCores=true&lt;/tt&gt; to returning false positive while &lt;tt&gt;CoreContainer&lt;/tt&gt; is in the process of starting up.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If the request comes in &lt;em&gt;after&lt;/em&gt; &lt;tt&gt;CoreContainer&lt;/tt&gt; has initialized &lt;tt&gt;healthCheckHandler&lt;/tt&gt; but &lt;em&gt;before&lt;/em&gt; initializing &amp;amp; running the &lt;tt&gt;coreLoadExecutor&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;A more complex situation where the request comes in &lt;em&gt;while&lt;/em&gt; &lt;tt&gt;coreLoadExecutor&lt;/tt&gt; is loading cores, and all of the cores that have &lt;em&gt;finished&lt;/em&gt; initialization are &quot;active&quot; in SolrCloud, but other SolrCores remain to be initialized (and may need recovery)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In both cases, the root of the issue is that &lt;tt&gt;requireHealthyCores=true&lt;/tt&gt; works by checking...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      Collection&amp;lt;CloudDescriptor&amp;gt; coreDescriptors =
          coreContainer.getCores().stream()
              .map(c -&amp;gt; c.getCoreDescriptor().getCloudDescriptor())
              .collect(Collectors.toList());
      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; unhealthyCores = findUnhealthyCores(coreDescriptors, clusterState);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;..but that means the only &lt;tt&gt;CloudDescriptor&lt;/tt&gt; s that are checked are the ones that come from &lt;em&gt;loaded&lt;/em&gt; cores (which is what &lt;tt&gt;coreContainer.getCores()&lt;/tt&gt; returns). and any &lt;tt&gt;currentlyLoadingCores&lt;/tt&gt; (registered by CoreContainer calling &lt;tt&gt;solrCores.markCoreAsLoading(cd)&lt;/tt&gt; before starting the &lt;tt&gt;coreLoadExecutor&lt;/tt&gt; ) are not considered.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13571523">SOLR-17200</key>
            <summary>&quot;False Positive&quot; Race conditions using &quot;/health?requireHealthyCores=true&quot; near startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Mar 2024 18:11:23 +0000</created>
                <updated>Fri, 17 Oct 2025 20:04:58 +0000</updated>
                            <resolved>Wed, 27 Mar 2024 20:21:00 +0000</resolved>
                                                    <fixVersion>9.6</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17825412" author="hossman" created="Mon, 11 Mar 2024 18:28:45 +0000"  >&lt;p&gt;FWIW:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I found these race conditions because i heard from a coworker anecdotally that they had seen a kube pod with 100+ PULL replicas (which will all current and didn&apos;t need recovery) report it was &quot;READY&quot; w/in a min or so of restart even though the logs showed it was still loading cores.&lt;/li&gt;
	&lt;li&gt;There may be other race conditions I haven&apos;t considered &#8211; those are just the two that jumped out at me when skimming the code&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think at a minimum one or both of the following changes should be made:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instead of using &lt;tt&gt;coreContainer.getCores().stream().map(c -&amp;gt; c.getCoreDescriptor().getCloudDescriptor())&lt;/tt&gt; to get the list of &lt;tt&gt;CloudDescriptors&lt;/tt&gt; we should stick to using the registered &lt;tt&gt;CoreDescriptors&lt;/tt&gt; directly (ignoring the question of whether the &lt;tt&gt;SolrCore&lt;/tt&gt; itself is loaded) via &lt;tt&gt;coreContainer.getCoreDescriptors().stream().map(cd -&amp;gt; cd..getCloudDescriptor())&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Before even looking at the &lt;tt&gt;CoreDescriptors&lt;/tt&gt;, &lt;tt&gt;HealthCheckHandler&lt;/tt&gt; should inspect &lt;tt&gt;CoreContainer.getStatus()&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;But since i&apos;m really not a fan of methods that require the caller to check bitmasks, we should probably just add a &lt;tt&gt;public boolean isLoadComplete()&lt;/tt&gt; to &lt;tt&gt;CoreContainer&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;/ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=broustant&quot; class=&quot;user-hover&quot; rel=&quot;broustant&quot;&gt;broustant&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17825732" author="houston" created="Tue, 12 Mar 2024 16:48:46 +0000"  >&lt;p&gt;I like your suggestions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; , if you have a patch/PR then I&apos;d be happy to review it.&lt;/p&gt;</comment>
                            <comment id="17825872" author="hossman" created="Wed, 13 Mar 2024 01:06:16 +0000"  >&lt;p&gt;Here&apos;s a trivial patch with the changes i suggested.&lt;/p&gt;

&lt;p&gt;What i&apos;m not clear on yet is if there is any decent way to test this?&lt;/p&gt;</comment>
                            <comment id="17828029" author="JIRAUSER302103" created="Mon, 18 Mar 2024 15:44:03 +0000"  >&lt;p&gt;I have encountered several issues already related to the startup sequence and accessing an uninitialised&#160; CoreContainer. I agree with the analysis of the issue and the fix!&lt;/p&gt;</comment>
                            <comment id="17831019" author="hossman" created="Tue, 26 Mar 2024 17:40:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;I like your suggestions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; , if you have a patch/PR then I&apos;d be happy to review it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
/ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt; - any thoughts on this patch? any concerns about committing w/o new tests?&lt;/p&gt;</comment>
                            <comment id="17831022" author="houston" created="Tue, 26 Mar 2024 17:47:56 +0000"  >&lt;p&gt;+1 to the patch. No concerns from me, given that I&apos;m not sure that this is entirely testable...&lt;/p&gt;</comment>
                            <comment id="17831516" author="jira-bot" created="Wed, 27 Mar 2024 19:45:04 +0000"  >&lt;p&gt;Commit 2def20abfe85d77f1fcd42a24d01c77b9ee07b82 in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=2def20abfe8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=2def20abfe8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17200&quot; title=&quot;&amp;quot;False Positive&amp;quot; Race conditions using &amp;quot;/health?requireHealthyCores=true&amp;quot; near startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17200&quot;&gt;&lt;del&gt;SOLR-17200&lt;/del&gt;&lt;/a&gt;: Fix false positive race condition in  during core loading&lt;/p&gt;</comment>
                            <comment id="17831528" author="jira-bot" created="Wed, 27 Mar 2024 20:20:22 +0000"  >&lt;p&gt;Commit 4a7b931a652a6ddc71a1975c366137ae1d0ec5f0 in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=4a7b931a652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=4a7b931a652&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17200&quot; title=&quot;&amp;quot;False Positive&amp;quot; Race conditions using &amp;quot;/health?requireHealthyCores=true&amp;quot; near startup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17200&quot;&gt;&lt;del&gt;SOLR-17200&lt;/del&gt;&lt;/a&gt;: Fix false positive race condition in  during core loading&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2def20abfe85d77f1fcd42a24d01c77b9ee07b82)&lt;/p&gt;</comment>
                            <comment id="17841713" author="gus_heck" created="Sun, 28 Apr 2024 19:22:38 +0000"  >&lt;p&gt;Closing after the 9.6.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13067405" name="SOLR-17200.patch" size="1914" author="hossman" created="Wed, 13 Mar 2024 01:05:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 28 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nwoo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>