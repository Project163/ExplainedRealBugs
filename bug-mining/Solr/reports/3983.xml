<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:33:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12343] JSON Field Facet refinement can return incorrect counts/stats for sorted buckets</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12343</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The way JSON Facet&apos;s simple refinement &quot;re-sorts&quot; buckets after refinement can cause &lt;em&gt;refined&lt;/em&gt; buckets to be &quot;bumped out&quot; of the topN based on the refined counts/stats depending on the sort - causing &lt;em&gt;unrefined&lt;/em&gt; buckets originally discounted in phase#2 to bubble up into the topN and be returned to clients &lt;b&gt;with inaccurate counts/stats&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The simplest way to demonstrate this bug (in some data sets) is with a &lt;tt&gt;sort: &apos;count asc&apos;&lt;/tt&gt; facet:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;assume shard1 returns termX &amp;amp; termY in phase#1 because they have very low shard1 counts
	&lt;ul&gt;
		&lt;li&gt;but &lt;b&gt;not&lt;/b&gt; returned at all by shard2, because these terms both have very high shard2 counts.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Assume termX has a slightly lower shard1 count then termY, such that:
	&lt;ul&gt;
		&lt;li&gt;termX &quot;makes the cut&quot; off for the limit=N topN buckets&lt;/li&gt;
		&lt;li&gt;termY does not make the cut, and is the &quot;N+1&quot; known bucket at the end of phase#1&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;termX then gets included in the phase#2 refinement request against shard2
	&lt;ul&gt;
		&lt;li&gt;termX now has a much higher &lt;em&gt;known&lt;/em&gt; total count then termY&lt;/li&gt;
		&lt;li&gt;the coordinator now sorts termX &quot;worse&quot; in the sorted list of buckets then termY&lt;/li&gt;
		&lt;li&gt;which causes termY to bubble up into the topN&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;termY is ultimately included in the final result &lt;em&gt;with incomplete count/stat/sub-facet data&lt;/em&gt; instead of termX
	&lt;ul&gt;
		&lt;li&gt;this is all indepenent of the possibility that termY may actually have a significantly higher total count then termX across the entire collection&lt;/li&gt;
		&lt;li&gt;the key problem is that all/most of the other terms returned to the client have counts/stats that are the cumulation of all shards, but termY only has the contributions from shard1&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Important Notes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This scenerio can happen regardless of the amount of overrequest used. Additional overrequest just increases the number of &quot;extra&quot; terms needed in the index with &quot;better&quot; sort values then termX &amp;amp; termY in shard2&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;sort: &apos;count asc&apos;&lt;/tt&gt; is not just an exceptional/pathelogical case:
	&lt;ul&gt;
		&lt;li&gt;any function sort where additional data provided shards during refinement can cause a bucket to &quot;sort worse&quot; can also cause this problem.&lt;/li&gt;
		&lt;li&gt;Examples: &lt;tt&gt;sum(price_i) asc&lt;/tt&gt; , &lt;tt&gt;min(price_i) desc&lt;/tt&gt; , &lt;tt&gt;avg(price_i) asc|desc&lt;/tt&gt; , etc...&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13158580">SOLR-12343</key>
            <summary>JSON Field Facet refinement can return incorrect counts/stats for sorted buckets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 May 2018 21:35:51 +0000</created>
                <updated>Sat, 8 Jun 2019 15:13:21 +0000</updated>
                            <resolved>Thu, 19 Jul 2018 17:31:47 +0000</resolved>
                                                    <fixVersion>7.5</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16471156" author="hossman" created="Thu, 10 May 2018 21:38:03 +0000"  >&lt;p&gt;Ultimately what seems to be at issue here is a discrepency between how Yonik designed the &quot;simple&quot; facet algorithm, and how it&apos;s implemented &#8211; but its only problematic in these &quot;additional information from refinement can make sort values &apos;worse&apos;&quot; type situations.&lt;/p&gt;

&lt;p&gt;As Yonik noted in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11733&quot; title=&quot;add an option make json.facet refinement more &amp;quot;optimistic&amp;quot; like facet.field/facet.pivot so that long tail have a change to bubble up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11733&quot;&gt;SOLR-11733&lt;/a&gt; regarding the design of &lt;tt&gt;refine:simple|true&lt;/tt&gt; ...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;compared to facet.field&amp;#93;&lt;/span&gt; ...the refinement algorithm being different (and for a single-level facet field, simpler).&lt;br/&gt;
 It can be explained as:&lt;br/&gt;
 1) find buckets to return as if you weren&apos;t doing refinement&lt;br/&gt;
 2) for those buckets, make sure all shards have contributed to the statistics&lt;br/&gt;
 i.e. simple refinement doesn&apos;t change the buckets you get back.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But in actuality, adding &lt;tt&gt;refine:true&lt;/tt&gt; &lt;em&gt;can&lt;/em&gt; change the buckets you get back. In my example above, if &lt;tt&gt;refine:false&lt;/tt&gt; was used, termX would have ultimately been returned (with an unrefined count) &#8211; but because of refinement it&apos;s not returned, and termY is returned in it&apos;s place.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I&apos;ve attached a simple test patch demonstrating the problem but I haven&apos;t yet dug into the code to figure out the best fix.&lt;/p&gt;

&lt;p&gt;I &lt;em&gt;suspect&lt;/em&gt; what&apos;s needed (to stick to the intent of &lt;tt&gt;refine:simple&lt;/tt&gt; ) is that after the coordinator picks buckets that need refined, it should prune down the list of &quot;all known&quot; (size &lt;tt&gt;limit=N + overrequest=R&lt;/tt&gt;) buckets to just the &quot;buckets to return&quot; (size &lt;tt&gt;limit=N&lt;/tt&gt;) so that once the refinement values come in the &lt;em&gt;set&lt;/em&gt; of buckets desn&apos;t change, even if the &lt;em&gt;order&lt;/em&gt; or the buckets does.&lt;/p&gt;</comment>
                            <comment id="16471335" author="hossman" created="Fri, 11 May 2018 00:46:04 +0000"  >&lt;p&gt;My initial thinking was that &lt;tt&gt;FacetRequestSortedMerger.sortBuckets()&lt;/tt&gt; should go ahead and truncate the list of bucket based on the &lt;tt&gt;limit+offset&lt;/tt&gt; as the very last thing it does &#8211; for the &quot;pre-refinement&quot; call to sortBuckets() this wouldn&apos;t change anything about the buckets selected for refinement, and for the &quot;post-refinement&quot; call to sortBuckets() it would only change the order of the buckets already refined &#8211; bug goes away. There&apos;s even a comment on the pre-refinement call that says &lt;tt&gt;// todo: make sure this filters buckets as well&lt;/tt&gt; which seemed to be directly on point.&lt;/p&gt;

&lt;p&gt;Except... looking at the post-refinement use of sortBuckets() in FacetFieldMerger, I realize that the &lt;tt&gt;mincount&lt;/tt&gt; type &quot;filtering&quot; (which is probably what that &apos;&lt;tt&gt;// todo&apos;&lt;/tt&gt; actually refered to) needs to be applied &lt;b&gt;after&lt;/b&gt; the buckets are sorting, but before pruning down down bsad on the offset+limit.&lt;/p&gt;

&lt;p&gt;With something like &lt;tt&gt;count desc&lt;/tt&gt; it wouldn&apos;t matter if we &quot;pre-truncate&quot; the list, because if any of the refined buckets don&apos;t have a count&amp;gt;mincount, then there&apos;s no chance any of the un-refined buckets will satisfy that mincount either ... but for things like &lt;tt&gt;index asc|desc&lt;/tt&gt; or sorting by functions: it definitely matters in order to ensure we return the full &quot;limit&quot; # of buckets.&lt;/p&gt;

&lt;p&gt;Although, I guess a key question i have is: if the user has explicitly requested refinement, then is there really any value in returning the full &quot;limit&quot; # of buckets if some of those buckets aren&apos;t refined?&lt;/p&gt;

&lt;p&gt;That really seems like the crux of this bug: to me, it seems like when refinement is requested we should &lt;b&gt;NEVER&lt;/b&gt; return an unrefined bucket (ie: a bucket that is lying about it&apos;s count/stats) ... but I can imagine other folks might feel differently.&lt;/p&gt;

&lt;p&gt;Anyone have strong opinions?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;For now, I&apos;ll assume the current behavior is considered desirable by some, and brain storm potential enhancements to make it optional...&lt;/p&gt;

&lt;p&gt;Perhaps we should add a new &lt;tt&gt;refine:required&lt;/tt&gt; variant? If the user says refinement is required, then &lt;tt&gt;sortBuckets()&lt;/tt&gt; could pre-truncate.&lt;/p&gt;

&lt;p&gt;Or maybe better still:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we add an &lt;tt&gt;int numShardsContributing = 1&lt;/tt&gt; to &lt;tt&gt;FacetBucket&lt;/tt&gt; that gets incremented every time a shard is merged in.&lt;/li&gt;
	&lt;li&gt;Add the new &lt;tt&gt;refine:required&lt;/tt&gt; option but implemented differently...
	&lt;ul&gt;
		&lt;li&gt;&lt;tt&gt;sortBuckets()&lt;/tt&gt; doesn&apos;t change &#8211; leave all the un-refined buckets in &lt;tt&gt;sortedBuckets&lt;/tt&gt; all the the time&lt;/li&gt;
		&lt;li&gt;Consumers of &lt;tt&gt;sortedBuckets&lt;/tt&gt; (like &lt;tt&gt;FacetFieldMerger.getMergedResult()&lt;/tt&gt; ) are responsible for checking the type of refinement:
		&lt;ul&gt;
			&lt;li&gt;if it was &lt;tt&gt;required&lt;/tt&gt; , then filter the buckets on &lt;tt&gt;numShardsContributing&lt;/tt&gt; just like the existing filtering on mincount in the same loop&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Additionally:&lt;/b&gt; add a new &lt;tt&gt;overrefine:N&lt;/tt&gt; option that can be use in conjunction with, or independently from &lt;tt&gt;refine:required&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;Default to &apos;0&apos; for back compat&lt;/li&gt;
		&lt;li&gt;used during refinement phase similar to how &quot;overrequest&quot; is used during the initial request
		&lt;ul&gt;
			&lt;li&gt;ie: &lt;tt&gt;FacetRequestSortedMerger&lt;/tt&gt; would add it to the limit when computing &lt;tt&gt;numBucketsToCheck&lt;/tt&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This way, clients that are willing to &quot;pay extra&quot; during refinement can request that additional terms get refined&#160;&#8211; which can be useful for non-trivial sorts to ensure that the &quot;best&quot; buckets really are returned.&#160; Independently clients can indicate if they are unwilling to accept un-refined buckets in the response because they care about accuracy, or would rather have as many buckets (up to limit) returned as possible, even if they couldn&apos;t be refined.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What do folks think?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; do you see any problems with this approach? or have alternative suggestions?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16481366" author="yseeley@gmail.com" created="Fri, 18 May 2018 23:55:56 +0000"  >&lt;p&gt;I think the most important thing here is that individual buckets should have correct stats.&#160; The behavior uncovered here was not intentional and isn&apos;t useful, so I think it should just be considered a bug.&lt;/p&gt;

&lt;p&gt;Truncating the list of buckets to N before the refinement phase would fix the bug, but it would also throw away complete buckets that could make it into the top N after refinement.&#160; One could tweak to only throw away incomplete buckets after the top N, but that still leaves the filtering&#160;complications you brought up. In the long term, perhaps a cursorMark approach would work better in conjunction with filtering? Although it does feel like paging facets is a less important feature in general.&lt;/p&gt;

&lt;p&gt;&#160;Exactly which buckets we chose to refine&#160;(and exactly how many) can remain an implementation detail. The essence of the simple refinement algorithm is:&lt;br/&gt;
 1) collect top buckets from each shard&lt;br/&gt;
 2) refine some subset of those buckets (refinement == ensure every shard that can contribute to that bucket has)&lt;br/&gt;
 3) return only refined buckets&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16487839" author="hossman" created="Wed, 23 May 2018 18:47:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;... I think it should just be considered a bug.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s pretty much my feeling, but I wasn&apos;t sure.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Truncating the list of buckets to N before the refinement phase would fix the bug, but it would also throw away complete buckets that could make it into the top N after refinement.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;oh right ... yeah, i was forgetting about buckets that got data from all shards in phase #1.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Exactly which buckets we chose to refine (and exactly how many) can remain an implementation detail. ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;right ... it can be heuristically determined, and very conservative in cases where we know it doesn&apos;t matter &#8211; but i still think there should be an explicit option...&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I worked up a patch similar to the straw man i outlined above &#8211; except that i didn&apos;t add the &lt;tt&gt;refine:required&lt;/tt&gt; variant since we&apos;re in agreement that this is a bug.&lt;/p&gt;

&lt;p&gt;In the new patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;buckets now keep track of how many shards contributed to them
	&lt;ul&gt;
		&lt;li&gt;I did this with a quick and dirty BitSet instead of an &lt;tt&gt;int numShardsContributing&lt;/tt&gt; counter since we have to handle the possibility that &lt;tt&gt;mergeBuckets()&lt;/tt&gt; will get called more then once for a single shard when we have partial refinement of sub-facets&lt;/li&gt;
		&lt;li&gt;there&apos;s a nocommit in here about the possibility of re-using the &lt;tt&gt;Context.sawShard&lt;/tt&gt; BitSet instead &#8211; but i couldn&apos;t wrap my head around an efficient way to do it so i punted&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;during the final &quot;pruning&quot; in &lt;tt&gt;FacetFieldMerger.getMergedResult()&lt;/tt&gt; buckets are excluded if a bucket doesn&apos;t have contributions from as many shards as the FacetField
	&lt;ul&gt;
		&lt;li&gt;again, i needed a new BitSet in at the FacetField level to count the shards &#8211; because &lt;tt&gt;Context.numShards&lt;/tt&gt; may include shards that never return &lt;b&gt;any&lt;/b&gt; results for the facet (ie: empty shard) so they never merge any data at all)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;there is a new &lt;tt&gt;overrefine:N&lt;/tt&gt; option which works similar to overrequest &#8211; but instead of determining how many &quot;extra&quot; terms to request in phase#1, it determines how many &quot;extra&quot; buckets should be in &lt;tt&gt;numBucketsToCheck&lt;/tt&gt; for refinement in phase #2 (but if some buckets are already fully populated in phase #2, then the actual number &quot;refined&quot; in phase#2 can be lower then limit+overrefine)
	&lt;ul&gt;
		&lt;li&gt;the default hueristic currently pays attention to the sort &#8211; since (IIUC) &lt;tt&gt;count desc&lt;/tt&gt; and &lt;tt&gt;index asc|desc&lt;/tt&gt; should never need any &quot;over refinement&quot; unless &lt;tt&gt;mincount &amp;gt; 1&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;if we have a non-trivial sort, and the user specified an explicit &lt;tt&gt;overrequest:N&lt;/tt&gt; then the default hueristic for &lt;tt&gt;overrefine&lt;/tt&gt; uses the same value &lt;tt&gt;N&lt;/tt&gt;
		&lt;ul&gt;
			&lt;li&gt;because i&apos;m assuming if people have explicitly requested &lt;tt&gt;sort:SPECIAL, refine:true, overrequest:N&lt;/tt&gt; then they care about the accuracy of the the terms to some degree N, and the bigger N is the more we should care about over-refinement as well.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;if neither &lt;tt&gt;overrequest&lt;/tt&gt; or &lt;tt&gt;overrefine&lt;/tt&gt; are explicitly set, then we use the same &lt;tt&gt;limit * 1.1 + 4&lt;/tt&gt; type hueristic as &lt;tt&gt;overrequest&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;there&apos;s another nocommit here though: if we&apos;re using a hueritic, should we be scaling the derived &lt;tt&gt;numBucketsToCheck&lt;/tt&gt; based on &lt;tt&gt;mincount&lt;/tt&gt; ? ... if &lt;tt&gt;mincount=M &amp;gt; 1&lt;/tt&gt; should we be doing something like &lt;tt&gt;numBucketsToCheck *= M&lt;/tt&gt; ??
		&lt;ul&gt;
			&lt;li&gt;although, thinking about it now &#8211; this kind of mincount based factor would probably make more sense in the &lt;tt&gt;overrequest&lt;/tt&gt; hueristic? maybe for &lt;tt&gt;overrefine&lt;/tt&gt; we should look at how many buckets were already fully populated in phase#1 &lt;em&gt;AND&lt;/em&gt; meet the mincount, and use the the difference between that number and the limit to decide a scaling factor?&lt;/li&gt;
			&lt;li&gt;either way: can probably TODO this for a future enhancement.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Testing wise...
	&lt;ul&gt;
		&lt;li&gt;These changes fix the problems in previous test patch&lt;/li&gt;
		&lt;li&gt;I&apos;ve also added some more tests, but there&apos;s nocommit&apos;s to add a lot more including verification of nested facets&lt;/li&gt;
		&lt;li&gt;I didn&apos;t want to go too deep down the testing rabbit hole until i was sure we wanted to go this route.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;what do you think?&lt;/p&gt;</comment>
                            <comment id="16490020" author="hossman" created="Fri, 25 May 2018 00:04:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;there is a new &lt;tt&gt;overrefine:N&lt;/tt&gt; option which works similar to overrequest &#8211; but instead of determining how many &quot;extra&quot; terms to request in phase#1, it determines how many &quot;extra&quot; buckets should be in &lt;tt&gt;numBucketsToCheck&lt;/tt&gt; for refinement in phase #2 ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It occurs to me now, that adding this option should also provide a &quot;solution&quot; for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11733&quot; title=&quot;add an option make json.facet refinement more &amp;quot;optimistic&amp;quot; like facet.field/facet.pivot so that long tail have a change to bubble up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11733&quot;&gt;SOLR-11733&lt;/a&gt; ... people who are concerned about refining long tail terms can set &lt;tt&gt;overrefine&lt;/tt&gt; really high.&lt;/p&gt;</comment>
                            <comment id="16516506" author="hossman" created="Tue, 19 Jun 2018 00:53:34 +0000"  >
&lt;p&gt;Updated patch with more tests and some code tweaks based on a few things the new tests caught.&lt;/p&gt;

&lt;p&gt;Still outstanding is the question of the new BitSets I added...&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;buckets now keep track of how many shards contributed to them ...
	&lt;ul&gt;
		&lt;li&gt;there&apos;s a nocommit in here about the possibility of re-using the &lt;tt&gt;Context.sawShard&lt;/tt&gt; BitSet instead &#8211; but i couldn&apos;t wrap my head around an efficient way to do it so i punted&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;...buckets are excluded if a bucket doesn&apos;t have contributions from as many shards as the FacetField...
	&lt;ul&gt;
		&lt;li&gt;again, i needed a new BitSet in at the FacetField level to count the shards &#8211; because Context.numShards may include shards that never return any results for the facet (ie: empty shard) so they never merge any data at all)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;I &lt;em&gt;think&lt;/em&gt; it should be possible to re-implement the &lt;tt&gt;FacetBucket.getNumShardsMerged()&lt;/tt&gt; method (i added) using &lt;tt&gt;Context.sawShard&lt;/tt&gt; by using &lt;tt&gt;sawShard.get(bucketNum * numShards, bucketNum * numShards + numShards)&lt;/tt&gt; to take a &quot;slice&quot; of the BitSet just for the current bucket and then look at it&apos;s cardinality.  the added cost of taking the slice only for buckets being considered in sorted order is probably a better trade off them the overhead of creating a new BitSet for every FacetBucket even if they are never considered for the response.&lt;/p&gt;

&lt;p&gt;But I still don&apos;t see anyway to efficiently figure out the &quot;shards that participated&quot; info needed at the &lt;tt&gt;FacetField&lt;/tt&gt; level using the existing &lt;tt&gt;sawShard&lt;/tt&gt; BitSet &amp;#8211; particularly with the changes I had to make to account for the case where a shard has docs participating in a facet, but not matching any buckets (see &lt;tt&gt;testSortedSubFacetRefinementWhenParentOnlyReturnedByOneShard&lt;/tt&gt; ).  Fortunately that&apos;s just one new BitSet per FacetField instance (not per bucket).&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;I&apos;ll look at refactoring &lt;tt&gt;FacetBucket.getNumShardsMerged()&lt;/tt&gt; to use &lt;tt&gt;Context.sawShard&lt;/tt&gt; soon.&lt;/p&gt;</comment>
                            <comment id="16518698" author="steve_rowe" created="Wed, 20 Jun 2018 22:56:28 +0000"  >&lt;p&gt;Not sure if it relates to this bug &amp;#8211; please move/add if not &amp;#8211; but my Jenkins found a reproducing failure for &lt;tt&gt;TestCloudJSONFacetSKG.testBespoke()&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Checking out Revision 008bc74bebef96414f19118a267dbf982aba58b9 (refs/remotes/origin/master)
[...]
ant test  -Dtestcase=TestCloudJSONFacetSKG -Dtests.method=testBespoke -Dtests.seed=5D223D88BF5BF89 -Dtests.slow=true -Dtests.locale=bg-BG -Dtests.timezone=America/Asuncion -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1
   [junit4] FAILURE 0.11s J0  | TestCloudJSONFacetSKG.testBespoke &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: Didn&apos;t check a single bucket???
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([5D223D88BF5BF89:E09A7E14375787E]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.TestCloudJSONFacetSKG.testBespoke(TestCloudJSONFacetSKG.java:219)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:748)
[...]
   [junit4]   2&amp;gt; NOTE: test params are: codec=FastCompressingStoredFields(storedFieldsFormat=CompressingStoredFieldsFormat(compressionMode=FAST, chunkSize=4, maxDocsPerChunk=1, blockSize=332), termVectorsFormat=CompressingTermVectorsFormat(compressionMode=FAST, chunkSize=4, blockSize=332)), sim=Asserting(org.apache.lucene.search.similarities.AssertingSimilarity@4052d535), locale=el, timezone=Indian/Antananarivo
   [junit4]   2&amp;gt; NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_151 (64-bit)/cpus=16,threads=1,free=213710424,total=526909440
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16519673" author="hossman" created="Thu, 21 Jun 2018 18:44:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Not sure if it relates to this bug...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, that&apos;s an unrelated stupid test mistake that i&apos;ve fixed locally and am currently hammering on &#8211; but that&apos;s for pointing it out!&lt;/p&gt;</comment>
                            <comment id="16530657" author="yseeley@gmail.com" created="Tue, 3 Jul 2018 01:19:35 +0000"  >&lt;p&gt;I think some of what I just worked on for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12326&quot; title=&quot;Unnecessary refinement requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12326&quot;&gt;&lt;del&gt;SOLR-12326&lt;/del&gt;&lt;/a&gt; is related to (or can be used by) this issue.&lt;br/&gt;
FacetRequestSortedMerger now has a &quot;BitSet shardHasMoreBuckets&quot; to help deal with the fact that complete buckets do not need participation from every shard.  That info in conjunction with Context.sawShard should be enough to tell if a bucket is already &quot;complete&quot;.&lt;br/&gt;
For every bucket that isn&apos;t complete, we can either refine it, or drop it.&lt;/p&gt;</comment>
                            <comment id="16533938" author="yseeley@gmail.com" created="Thu, 5 Jul 2018 17:35:17 +0000"  >&lt;p&gt;Here&apos;s an updated patch... I started with the last patch here and reimplemented just part of it to implement a isBucketComplete function, and then used that to screen out non-refined buckets in the same place that filters mincount.  All tests pass, and I plan on committing shortly.&lt;/p&gt;</comment>
                            <comment id="16533943" author="hossman" created="Thu, 5 Jul 2018 17:37:02 +0000"  >&lt;p&gt;yonik: hold up ... i put this on the backburner because of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12516&quot; title=&quot;JSON &amp;quot;range&amp;quot; facets can incorrectly refine subfacets for buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12516&quot;&gt;&lt;del&gt;SOLR-12516&lt;/del&gt;&lt;/a&gt; (which i&apos;m currently actively working on)&lt;/p&gt;

&lt;p&gt;Fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt; before &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12516&quot; title=&quot;JSON &amp;quot;range&amp;quot; facets can incorrectly refine subfacets for buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12516&quot;&gt;&lt;del&gt;SOLR-12516&lt;/del&gt;&lt;/a&gt; will make &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12516&quot; title=&quot;JSON &amp;quot;range&amp;quot; facets can incorrectly refine subfacets for buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12516&quot;&gt;&lt;del&gt;SOLR-12516&lt;/del&gt;&lt;/a&gt;  a lot worse in the common case (it will stop returning the facet range &quot;other&quot; buckets completely since currently no code refines them at all)&lt;/p&gt;</comment>
                            <comment id="16534377" author="yseeley@gmail.com" created="Fri, 6 Jul 2018 02:18:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;it will stop returning the facet range &quot;other&quot; buckets completely since currently no code refines them at all&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmmm, so the patch I attached seems like it would only remove incomplete buckets in field facets under &quot;other&quot; buckets (i.e. if they don&apos;t actually need refining to be complete, they won&apos;t be removed by the current patch).  But this could still be worse in some cases (missing vs incomplete when refinement is requested), so I agree this can wait until  &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12516&quot; title=&quot;JSON &amp;quot;range&amp;quot; facets can incorrectly refine subfacets for buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12516&quot;&gt;&lt;del&gt;SOLR-12516&lt;/del&gt;&lt;/a&gt; is done. &lt;/p&gt;</comment>
                            <comment id="16535244" author="hossman" created="Fri, 6 Jul 2018 19:09:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think some of what I just worked on for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12326&quot; title=&quot;Unnecessary refinement requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12326&quot;&gt;&lt;del&gt;SOLR-12326&lt;/del&gt;&lt;/a&gt; is related to (or can be used by) this issue. ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;Here&apos;s an updated patch... I started with the last patch here and reimplemented just part of it to implement a isBucketComplete function ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m still not caught up on exactly how &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12326&quot; title=&quot;Unnecessary refinement requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12326&quot;&gt;&lt;del&gt;SOLR-12326&lt;/del&gt;&lt;/a&gt; works, but i do like how nice and clean this patch is now.&lt;/p&gt;

&lt;p&gt;I&apos;ve updated it to resolve the test conflicts introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12516&quot; title=&quot;JSON &amp;quot;range&amp;quot; facets can incorrectly refine subfacets for buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12516&quot;&gt;&lt;del&gt;SOLR-12516&lt;/del&gt;&lt;/a&gt; and to update the ref guide with an explanation of overrefine vs overrequest.&lt;/p&gt;

&lt;p&gt;I&apos;m still running tests locally, but if you&apos;re confident in this feel free to commit.&lt;/p&gt;</comment>
                            <comment id="16536065" author="lucenesolrqa" created="Sun, 8 Jul 2018 10:40:15 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 1 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 59s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 49s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 49s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 55s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 49s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 49s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate ref guide &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 49s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; 65m 33s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; core in the patch failed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; 73m  9s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Reason &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Tests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Failed junit tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.IndexSizeTriggerTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.api.collections.ShardSplitTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.ForceLeaderTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.api.collections.TestCollectionsAPIViaSolrCloudCluster &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.sim.TestLargeCluster &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12930572/SOLR-12343.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12930572/SOLR-12343.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  validaterefguide  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene1-us-west 3.13.0-88-generic #135-Ubuntu SMP Wed Jun 8 21:10:42 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / b7d14c5 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.9.3 compiled on April 8 2014 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.8.0_172 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; unit &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/140/artifact/out/patch-unit-solr_core.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/140/artifact/out/patch-unit-solr_core.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/140/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/140/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core solr/solr-ref-guide U: solr &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/140/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/140/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16536095" author="yseeley@gmail.com" created="Sun, 8 Jul 2018 12:55:32 +0000"  >&lt;p&gt;I&apos;m occasionally getting a failure in testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN&lt;br/&gt;
I haven&apos;t tried digging into it yet though.&lt;/p&gt;</comment>
                            <comment id="16536481" author="hossman" created="Mon, 9 Jul 2018 01:55:43 +0000"  >&lt;p&gt;which assertion?  stacktrace? reproduce line? .. does the seed actually reproduce?&lt;/p&gt;

&lt;p&gt;There&apos;s virtually no randomization in the test at all, except for the number of fillter termss/overrequest.&lt;/p&gt;

&lt;p&gt;If you&apos;re seeing you&apos;re seeing a seed that reproduces, it makes me wonder if there is an edge case / off by one error based on the number of buckets ... if the seed doesn&apos;t reproduce (reliably) then it makes me wonder if it&apos;s an edge case that has to do with with which order the shards respond (ie: how the merger initializes the datastructs that get merged)&lt;/p&gt;</comment>
                            <comment id="16536494" author="hossman" created="Mon, 9 Jul 2018 02:27:56 +0000"  >&lt;p&gt;Found one &#8211; it seems to be specific to the situation where &lt;tt&gt;overrequest==0&lt;/tt&gt;, and the facet is nested under another facet?&lt;/p&gt;

&lt;p&gt;playing the with values of &lt;tt&gt;top_over&lt;/tt&gt; and &lt;tt&gt;top_refine&lt;/tt&gt; it doesn&apos;t seem to matter if parent facet is refined, but the key is wether the top facet also uses&#160;&lt;tt&gt;overrequest:0&lt;/tt&gt; (fails) or&#160;&lt;tt&gt;overrequest:999&lt;/tt&gt; (passes)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 9990 INFO  (qtp1276305453-48) [    x:collection1] o.a.s.c.S.Request [collection1]  webapp=/solr path=/select params={df=text&amp;amp;distrib=false&amp;amp;_facet_={}&amp;amp;fl=id&amp;amp;fl=score&amp;amp;shards.purpose=1048580&amp;amp;start=0&amp;amp;fsv=true&amp;amp;shard.url=127.0.0.1:47372/solr/collection1&amp;amp;rows=0&amp;amp;version=2&amp;amp;q=*:*&amp;amp;json.facet={+all:{+type:terms,+field:all_ss,+limit:1,+refine:true,+overrequest:0+++++++,+facet:{+++cat_count:{+type:terms,+field:cat_s,+limit:3,+overrequest:0+++++++++++++++,+refine:true,+sort:&apos;count+asc&apos;+},+++cat_price:{+type:terms,+field:cat_s,+limit:3,+overrequest:0+++++++++++++++,+refine:true,+sort:&apos;sum_p+asc&apos;++++++++++++++++,+facet:+{+sum_p:+&apos;sum(price_i)&apos;+}+}}+}+}&amp;amp;NOW=1531102182236&amp;amp;isShard=true&amp;amp;wt=javabin} hits=9 status=0 QTime=17
   [junit4]   2&amp;gt; 9994 INFO  (qtp1276305453-49) [    x:collection1] o.a.s.c.S.Request [collection1]  webapp=/solr path=/select params={df=text&amp;amp;distrib=false&amp;amp;_facet_={&quot;refine&quot;:{&quot;all&quot;:{&quot;_p&quot;:[[&quot;z_all&quot;,{&quot;cat_count&quot;:{&quot;_l&quot;:[&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]},&quot;cat_price&quot;:{&quot;_l&quot;:[&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]}}]]}}}&amp;amp;shards.purpose=2097152&amp;amp;shard.url=127.0.0.1:47372/solr/collection1&amp;amp;rows=0&amp;amp;version=2&amp;amp;q=*:*&amp;amp;json.facet={+all:{+type:terms,+field:all_ss,+limit:1,+refine:true,+overrequest:0+++++++,+facet:{+++cat_count:{+type:terms,+field:cat_s,+limit:3,+overrequest:0+++++++++++++++,+refine:true,+sort:&apos;count+asc&apos;+},+++cat_price:{+type:terms,+field:cat_s,+limit:3,+overrequest:0+++++++++++++++,+refine:true,+sort:&apos;sum_p+asc&apos;++++++++++++++++,+facet:+{+sum_p:+&apos;sum(price_i)&apos;+}+}}+}+}&amp;amp;NOW=1531102182236&amp;amp;isShard=true&amp;amp;facet=false&amp;amp;wt=javabin} hits=9 status=0 QTime=1
   [junit4]   2&amp;gt; 9996 INFO  (qtp1503674478-65) [    x:collection1] o.a.s.c.S.Request [collection1]  webapp=/solr path=/select params={shards=127.0.0.1:54950/solr/collection1,127.0.0.1:47372/solr/collection1,127.0.0.1:52833/solr/collection1&amp;amp;shards=debugQuery&amp;amp;shards=true&amp;amp;q=*:*&amp;amp;json.facet={+all:{+type:terms,+field:all_ss,+limit:1,+refine:true,+overrequest:0+++++++,+facet:{+++cat_count:{+type:terms,+field:cat_s,+limit:3,+overrequest:0+++++++++++++++,+refine:true,+sort:&apos;count+asc&apos;+},+++cat_price:{+type:terms,+field:cat_s,+limit:3,+overrequest:0+++++++++++++++,+refine:true,+sort:&apos;sum_p+asc&apos;++++++++++++++++,+facet:+{+sum_p:+&apos;sum(price_i)&apos;+}+}}+}+}&amp;amp;indent=true&amp;amp;rows=0&amp;amp;wt=json&amp;amp;version=2.2} hits=19 status=0 QTime=25
   [junit4]   2&amp;gt; 9997 ERROR (TEST-TestJsonFacetRefinement.testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN-seed#[775BF43EF8268D50]) [    ] o.a.s.SolrTestCaseHS query failed JSON validation. error=mismatch: &apos;X&apos;!=&apos;C&apos; @ facets/all/buckets/[0]/cat_count/buckets/[2]/val
   [junit4]   2&amp;gt;  expected =facets=={ count: 19,all:{ buckets:[   { val:z_all, count: 19,    cat_count:{ buckets:[                  {val:A,count:1},                 {val:B,count:1},                 {val:X,count:4},    ] },    cat_price:{ buckets:[                  {val:A,count:1,sum_p:1.0},                 {val:B,count:1,sum_p:1.0},                 {val:X,count:4,sum_p:4.0},    ] }} ] } }
   [junit4]   2&amp;gt;  response = {
   [junit4]   2&amp;gt;   &quot;responseHeader&quot;:{
   [junit4]   2&amp;gt;     &quot;status&quot;:0,
   [junit4]   2&amp;gt;     &quot;QTime&quot;:25},
   [junit4]   2&amp;gt;   &quot;response&quot;:{&quot;numFound&quot;:19,&quot;start&quot;:0,&quot;maxScore&quot;:1.0,&quot;docs&quot;:[]
   [junit4]   2&amp;gt;   },
   [junit4]   2&amp;gt;   &quot;facets&quot;:{
   [junit4]   2&amp;gt;     &quot;count&quot;:19,
   [junit4]   2&amp;gt;     &quot;all&quot;:{
   [junit4]   2&amp;gt;       &quot;buckets&quot;:[{
   [junit4]   2&amp;gt;           &quot;val&quot;:&quot;z_all&quot;,
   [junit4]   2&amp;gt;           &quot;count&quot;:19,
   [junit4]   2&amp;gt;           &quot;cat_price&quot;:{
   [junit4]   2&amp;gt;             &quot;buckets&quot;:[{
   [junit4]   2&amp;gt;                 &quot;val&quot;:&quot;A&quot;,
   [junit4]   2&amp;gt;                 &quot;count&quot;:1,
   [junit4]   2&amp;gt;                 &quot;sum_p&quot;:1.0},
   [junit4]   2&amp;gt;               {
   [junit4]   2&amp;gt;                 &quot;val&quot;:&quot;B&quot;,
   [junit4]   2&amp;gt;                 &quot;count&quot;:1,
   [junit4]   2&amp;gt;                 &quot;sum_p&quot;:1.0},
   [junit4]   2&amp;gt;               {
   [junit4]   2&amp;gt;                 &quot;val&quot;:&quot;C&quot;,
   [junit4]   2&amp;gt;                 &quot;count&quot;:6,
   [junit4]   2&amp;gt;                 &quot;sum_p&quot;:6.0}]},
   [junit4]   2&amp;gt;           &quot;cat_count&quot;:{
   [junit4]   2&amp;gt;             &quot;buckets&quot;:[{
   [junit4]   2&amp;gt;                 &quot;val&quot;:&quot;A&quot;,
   [junit4]   2&amp;gt;                 &quot;count&quot;:1},
   [junit4]   2&amp;gt;               {
   [junit4]   2&amp;gt;                 &quot;val&quot;:&quot;B&quot;,
   [junit4]   2&amp;gt;                 &quot;count&quot;:1},
   [junit4]   2&amp;gt;               {
   [junit4]   2&amp;gt;                 &quot;val&quot;:&quot;C&quot;,
   [junit4]   2&amp;gt;                 &quot;count&quot;:6}]}}]}}}
   [junit4]   2&amp;gt; 
   [junit4]   2&amp;gt; 10000 INFO  (TEST-TestJsonFacetRefinement.testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN-seed#[775BF43EF8268D50]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN
   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestJsonFacetRefinement -Dtests.method=testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN -Dtests.seed=775BF43EF8268D50 -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=pl-PL -Dtests.timezone=Africa/Bamako -Dtests.asserts=true -Dtests.file.encoding=US-ASCII
   [junit4] ERROR   4.32s | TestJsonFacetRefinement.testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.RuntimeException: mismatch: &apos;X&apos;!=&apos;C&apos; @ facets/all/buckets/[0]/cat_count/buckets/[2]/val
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([775BF43EF8268D50:DB8655EB2671818E]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseHS.matchJSON(SolrTestCaseHS.java:161)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseHS.assertJQ(SolrTestCaseHS.java:143)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseHS$Client$Tester.assertJQ(SolrTestCaseHS.java:255)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseHS$Client.testJQ(SolrTestCaseHS.java:297)
   [junit4]    &amp;gt; 	at org.apache.solr.search.facet.TestJsonFacetRefinement.testSortedFacetRefinementPushingNonRefinedBucketBackIntoTopN(TestJsonFacetRefinement.java:568)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:748)
   [junit4]   2&amp;gt; 10016 INFO  (SUITE-TestJsonFacetRefinement-seed#[775BF43EF8268D50]-worker) [    ] o.e.j.s.Abs
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;...i haven&apos;t worked through it yet to figure out the problem, but my initial impression is that i made this test too aggressive? I&apos;m not sure it&apos;s safe to assert correct results with &lt;tt&gt;top_over=1&lt;/tt&gt; ... but i&apos;m not sure why it matters what the sub-facet overrequest is in that case?&lt;/p&gt;</comment>
                            <comment id="16537306" author="hossman" created="Mon, 9 Jul 2018 17:32:05 +0000"  >&lt;p&gt;Ok ... fresh eyes and i see the problem.&lt;/p&gt;

&lt;p&gt;When &lt;tt&gt;final int overreq = 0&lt;/tt&gt; we don&apos;t add any &quot;filler&quot; docs, which means that when the nested facet test happens, shardC0 and shardC1 disagree about the &quot;top term&quot; for the parent facet on the &lt;tt&gt;all_ss&lt;/tt&gt; field &amp;#8211; shardC0 only knows about &lt;tt&gt;z_al&lt;/tt&gt; while shardC1 has a tie between &lt;tt&gt;z_all} and {{some&lt;/tt&gt; and &lt;tt&gt;some&lt;/tt&gt; wins the tie due to index order &amp;#8211; so when that parent facet uses &lt;tt&gt;overrequest:0&lt;/tt&gt; the initial merge logic doesn&apos;t have any contributions from shardC1 for the chosen &lt;tt&gt;all_ss:z_all&lt;/tt&gt; bucket ... so it only knows to ask to refine the top3 child buckets it does know about (from shardC0): &quot;A,B,C&quot;.  If the parent facet uses any overrequest larger then 0, then it would get the &lt;tt&gt;all_ss:z_all&lt;/tt&gt; bucket from shardC1 as well, and have some child buckets to consider to know that C is a bad candidate, and it should be refining X instead.&lt;/p&gt;

&lt;p&gt;On the flip side, when &lt;tt&gt;final int overreq = 1&lt;/tt&gt; (or anything higher) the addition of even a few filler docs is enough to skew the &lt;tt&gt;all_ss&lt;/tt&gt; term stats on shardC1, such that it &lt;b&gt;also&lt;/b&gt; thinkgs &lt;tt&gt;z_all&lt;/tt&gt; is the top term, so regardless of the amount of overrequest on the top facet, the phase #1 merge has buckets from both shards for the child facet to consider.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;I remember when i was writing this test, and i include the &lt;tt&gt;some&lt;/tt&gt; terms the entire point was to stress the case where the 2 shards disagree about the &quot;top&quot; term term from the parent facet &amp;#8211; but apparently when adding the filler docs/terms randomization i broke that so that it&apos;s not always true, it only happens when there are no filler docs.  But it also seems like an unfair test, because when they do disagree, there&apos;s no reason for hte merge logic to think X is a worthwhile term to refine. what mattes is that in this case, C is accurately refined&lt;/p&gt;

&lt;p&gt;I&apos;m working up a test fix...&lt;/p&gt;</comment>
                            <comment id="16537347" author="hossman" created="Mon, 9 Jul 2018 18:13:14 +0000"  >&lt;p&gt;updated patch with fixed test.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; &amp;#8211; look good?&lt;/p&gt;</comment>
                            <comment id="16537904" author="yseeley@gmail.com" created="Tue, 10 Jul 2018 02:27:27 +0000"  >&lt;p&gt;Looks good, thanks for tracking that down!&lt;/p&gt;</comment>
                            <comment id="16540330" author="hossman" created="Wed, 11 Jul 2018 16:23:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; - i&apos;ve been testing this out with the SKG (relatedness()) function &amp;#8211; where i initially discovered bug &amp;#8211; and trying to remove the workarounds for this that are currently in TestCloudJSONFacetSKG (grep for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt;) but i&apos;m seeing some failures that I think i&apos;ve traced back to a mistake in isBucketComplete() that &lt;em&gt;only&lt;/em&gt; affects facets using &lt;tt&gt;processEmpty:true&lt;/tt&gt; ...&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;in &lt;tt&gt;getRefinement()&lt;/tt&gt; you&apos;ve got &lt;tt&gt;returnedAllBuckets&lt;/tt&gt; taking into consideration &lt;tt&gt;processEmpty:true&lt;/tt&gt; &amp;#8211; so that even if a shardA doesn&apos;t say it has &lt;tt&gt;more:true&lt;/tt&gt; we will still send it candidate bucketX for refinement if we didn&apos;t explicitly &lt;tt&gt;saw&lt;/tt&gt; bucketX on shardA.  so far so good.&lt;/p&gt;

&lt;p&gt;but then, once all the refinement is done, and we have a fully refined bucketX it might now sort &quot;lower&quot; then an incomplete bucketY ... and &lt;tt&gt;isBucketComplete&lt;/tt&gt; doesn&apos;t pay any attention to &lt;tt&gt;processEmpty:true&lt;/tt&gt; ... so it sees that shardA does &lt;b&gt;not&lt;/b&gt; have &lt;tt&gt;more:true&lt;/tt&gt; and thinks (the incomplete) bucketY is ok to return.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...I&apos;ll work up an isolated test case&lt;/p&gt;</comment>
                            <comment id="16540521" author="hossman" created="Wed, 11 Jul 2018 18:52:57 +0000"  >&lt;p&gt;I&apos;ve attached an isloated &lt;tt&gt;&amp;#95;&amp;#95;incomplete_processEmpty_microfix.patch&lt;/tt&gt; which needs to be applied &lt;em&gt;on top of&lt;/em&gt; the previous patch to try and give a quick and dirty demonstration of  the problem (w/o using the &lt;tt&gt;relatedness()&lt;/tt&gt; function) by adding a new mode to the &lt;tt&gt;debug()&lt;/tt&gt; agg function that will count the shards that contribute to a bucket.&lt;/p&gt;

&lt;p&gt;I was hoping there would be a straight forward fix (also in the patch) by just checking processEmpty anytime we check shardHasMoreBuckets &amp;#8211; but when dealing with nested facets the other piece of the puzzle is &lt;tt&gt;mcontext.bucketWasMissing()&lt;/tt&gt; but that info ephemeral as the merge logic loops over the shards, so we can&apos;t look it up for an arbitrary shard after the fact ... even then i&apos;m not sure the new processEmpty test code i wrote can ever pass the way i initially thought it should given how missing (parent) buckets are refined via &lt;tt&gt;&quot;_l&quot;&lt;/tt&gt; w/o specifying any child buckets.&lt;/p&gt;

&lt;p&gt;I need to think about this some more ... and i&apos;ll also try to write a simple &lt;tt&gt;relatedness()&lt;/tt&gt; based test that more directly shows the &quot;unrefined bucket can still bubble up because of processEmpty&quot; (I set out with the &lt;tt&gt;debug()&lt;/tt&gt; approach thinking it would be simpler to understand, but i don&apos;t think it is)&lt;/p&gt;</comment>
                            <comment id="16540576" author="lucenesolrqa" created="Wed, 11 Jul 2018 19:29:10 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 1 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 13m 36s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 16m 20s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 16m 20s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 17m 13s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 16m 20s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 16m 20s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate ref guide &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 16m 20s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;153m 34s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; core in the patch failed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;213m 21s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Reason &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Tests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Failed junit tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.api.collections.TestCollectionsAPIViaSolrCloudCluster &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.cdcr.CdcrBidirectionalTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.sim.TestExecutePlanAction &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.SearchRateTriggerIntegrationTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.api.collections.ShardSplitTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.sim.TestLargeCluster &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12930878/SOLR-12343.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12930878/SOLR-12343.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  validaterefguide  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene2-us-west.apache.org 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / fe180bb &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.9.6 compiled on July 8 2015 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.8.0_172 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; unit &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/142/artifact/out/patch-unit-solr_core.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/142/artifact/out/patch-unit-solr_core.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/142/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/142/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core solr/solr-ref-guide U: solr &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/142/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/142/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16540718" author="hossman" created="Wed, 11 Jul 2018 21:44:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;...test that more directly shows the &quot;unrefined bucket can still bubble up because of processEmpty&quot; (I set out with the &lt;tt&gt;debug()&lt;/tt&gt; approach thinking it would be simpler to understand, but i don&apos;t think it is)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I realized at lunch that this is actaully very easy to do just be sorting on &quot; &lt;tt&gt;debug asc&lt;/tt&gt; &quot; ... i encourge folks to completley ignore my half-assed non-functional changes in &lt;tt&gt;__incomplete_processEmpty_microfix.patch&lt;/tt&gt; and instead just checkout the latest &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt;.patch&#160;&#8211; it has no new code changes, just new tests in TestJsonFacetRefinement:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;testProcessEmptyRefinement
	&lt;ul&gt;
		&lt;li&gt;completley new method&lt;/li&gt;
		&lt;li&gt;shows how processEmpty can cause unrefined bucket to &quot;bubble up&quot; after a refined bucket&apos;s sort value changes&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;testSortedSubFacetRefinementWhenParentOnlyReturnedByOneShard
	&lt;ul&gt;
		&lt;li&gt;updated method from previous patches&lt;/li&gt;
		&lt;li&gt;new assertions here show similar situation to testProcessEmptyRefinement but with a nested facet&lt;/li&gt;
		&lt;li&gt;see nocommits comments for details of the concerns i mentioned in my last comment about whether this test can ever be viable&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16541000" author="lucenesolrqa" created="Thu, 12 Jul 2018 01:40:52 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 2 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  4m  7s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 41s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 41s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 55s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 41s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;  2m 41s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; Validate source patterns validate-source-patterns failed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; Validate ref guide &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;  2m 41s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; Validate source patterns validate-source-patterns failed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; 94m 19s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; core in the patch failed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;104m 44s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Reason &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Tests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Failed junit tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.IndexSizeTriggerTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.api.collections.ShardSplitTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.search.facet.TestJsonFacetRefinement &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12931226/SOLR-12343.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12931226/SOLR-12343.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  validaterefguide  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene2-us-west.apache.org 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / fe180bb &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.9.6 compiled on July 8 2015 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.8.0_172 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Validate source patterns &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/143/artifact/out/patch-validate-source-patterns-root.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/143/artifact/out/patch-validate-source-patterns-root.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Validate ref guide &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/143/artifact/out/patch-validate-source-patterns-root.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/143/artifact/out/patch-validate-source-patterns-root.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; unit &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/143/artifact/out/patch-unit-solr_core.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/143/artifact/out/patch-unit-solr_core.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/143/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/143/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core solr/solr-ref-guide U: solr &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/143/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/143/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16545604" author="hossman" created="Mon, 16 Jul 2018 18:40:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;but then, once all the refinement is done, and we have a fully refined bucketX it might now sort &quot;lower&quot; then an incomplete bucketY ... and &lt;tt&gt;isBucketComplete&lt;/tt&gt; doesn&apos;t pay any attention to &lt;tt&gt;processEmpty:true&lt;/tt&gt; ... so it sees that shardA does &lt;b&gt;not&lt;/b&gt; have &lt;tt&gt;more:true&lt;/tt&gt; and thinks (the incomplete) bucketY is ok to return.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t been able to come up with a better solution for this, and since processEmpty is pretty special case, I think i&apos;m just going to break it out into it&apos;s own Jira, and revise the patch so that the current assertion failures are confined to test methods that are &amp;#64;AwaitsFix&apos;ed on that issue &amp;#8211; that way we can move forward with the existing fix that likely impacts more people.&lt;/p&gt;</comment>
                            <comment id="16545607" author="hossman" created="Mon, 16 Jul 2018 18:47:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think i&apos;m just going to break it out into it&apos;s own Jira, and revise the patch so that the current assertion failures are confined to test methods that are @AwaitsFix&apos;ed on that issue &#8211; that way we can move forward with the existing fix that likely impacts more people.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;spun off processEmpty issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12556&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets -- when using processEmpty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12556&quot;&gt;SOLR-12556&lt;/a&gt; and updated this patch with slightly tweaked tests so the effected assertions are isolated in their own (disabled) test methods.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;I think this is good to go.&lt;/p&gt;</comment>
                            <comment id="16545783" author="hossman" created="Mon, 16 Jul 2018 21:59:08 +0000"  >&lt;p&gt;Updated patch to fix a small javadoc problem and to update comments in TestCloudJSONFacetSKG to refer to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12556&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets -- when using processEmpty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12556&quot;&gt;SOLR-12556&lt;/a&gt; instead of this issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;: any concerns about the current state of this patch? can i go ahead and commit?&lt;/p&gt;</comment>
                            <comment id="16546927" author="lucenesolrqa" created="Tue, 17 Jul 2018 17:43:28 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Prechecks &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 3 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; master Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 21s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; master passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Patch Compile Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 10s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 10s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Release audit (RAT) &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 18s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Check forbidden APIs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 10s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate source patterns &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 10s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; Validate ref guide &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 10s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;font color=&quot;brown&quot;&gt; Other Tests &lt;/font&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;179m 55s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; core in the patch failed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;189m 14s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Reason &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Tests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Failed junit tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.IndexSizeTriggerTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.api.collections.ShardSplitTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.cloud.autoscaling.sim.TestGenericDistributedQueue &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; solr.handler.component.InfixSuggestersTest &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12931845/SOLR-12343.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12931845/SOLR-12343.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  validaterefguide  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux lucene1-us-west 3.13.0-88-generic #135-Ubuntu SMP Wed Jun 8 21:10:42 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; master / d730c8b &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ant &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; version: Apache Ant(TM) version 1.9.3 compiled on April 8 2014 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.8.0_172 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; unit &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/144/artifact/out/patch-unit-solr_core.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/144/artifact/out/patch-unit-solr_core.txt&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/144/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/144/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: solr/core solr/solr-ref-guide U: solr &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-SOLR-Build/144/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-SOLR-Build/144/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.7.0   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16549602" author="jira-bot" created="Thu, 19 Jul 2018 17:30:43 +0000"  >&lt;p&gt;Commit a7fe950074a834edc070c265df1394181b268683 in lucene-solr&apos;s branch refs/heads/branch_7x from Chris Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a7fe950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a7fe950&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt;: Fixed a bug in JSON Faceting that could cause incorrect counts/stats when using non default sort options&lt;/p&gt;

&lt;p&gt;This also adds a new configurable &quot;overrefine&quot; option&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 3a5d4a25df310d2021fa947ea593cc9b3c93a386)&lt;/p&gt;</comment>
                            <comment id="16549603" author="jira-bot" created="Thu, 19 Jul 2018 17:30:45 +0000"  >&lt;p&gt;Commit 3a5d4a25df310d2021fa947ea593cc9b3c93a386 in lucene-solr&apos;s branch refs/heads/master from Chris Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3a5d4a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3a5d4a2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12343&quot; title=&quot;JSON Field Facet refinement can return incorrect counts/stats for sorted buckets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12343&quot;&gt;&lt;del&gt;SOLR-12343&lt;/del&gt;&lt;/a&gt;: Fixed a bug in JSON Faceting that could cause incorrect counts/stats when using non default sort options&lt;/p&gt;

&lt;p&gt;This also adds a new configurable &quot;overrefine&quot; option&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13172459">SOLR-12556</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13168105">SOLR-12516</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13123336">SOLR-11733</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12931845" name="SOLR-12343.patch" size="51488" author="hossman" created="Mon, 16 Jul 2018 21:54:43 +0000"/>
                            <attachment id="12931830" name="SOLR-12343.patch" size="49681" author="hossman" created="Mon, 16 Jul 2018 18:45:30 +0000"/>
                            <attachment id="12931226" name="SOLR-12343.patch" size="47913" author="hossman" created="Wed, 11 Jul 2018 21:37:54 +0000"/>
                            <attachment id="12930878" name="SOLR-12343.patch" size="38009" author="hossman" created="Mon, 9 Jul 2018 18:11:49 +0000"/>
                            <attachment id="12930572" name="SOLR-12343.patch" size="33875" author="hossman" created="Fri, 6 Jul 2018 19:02:02 +0000"/>
                            <attachment id="12930414" name="SOLR-12343.patch" size="30531" author="yseeley@gmail.com" created="Thu, 5 Jul 2018 17:33:00 +0000"/>
                            <attachment id="12928282" name="SOLR-12343.patch" size="31010" author="hossman" created="Tue, 19 Jun 2018 00:53:49 +0000"/>
                            <attachment id="12924809" name="SOLR-12343.patch" size="19243" author="hossman" created="Wed, 23 May 2018 18:48:17 +0000"/>
                            <attachment id="12922918" name="SOLR-12343.patch" size="4830" author="hossman" created="Thu, 10 May 2018 21:36:45 +0000"/>
                            <attachment id="12931206" name="__incomplete_processEmpty_microfix.patch" size="14413" author="hossman" created="Wed, 11 Jul 2018 18:38:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tl4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>