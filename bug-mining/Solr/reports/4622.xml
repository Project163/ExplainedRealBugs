<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:46:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14923] Indexing performance is unacceptable when child documents are involved</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14923</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Parallel indexing does not make sense at moment when child documents are used.&lt;/p&gt;

&lt;p&gt;The org.apache.solr.update.processor.DistributedUpdateProcessor checks at the end of the method doVersionAdd if Ulog caches should be refreshed.&lt;/p&gt;

&lt;p&gt;This check will return true if any child document is included in the AddUpdateCommand.&lt;/p&gt;

&lt;p&gt;If so ulog.openRealtimeSearcher(); is called, this call is very expensive, and executed in a synchronized block of the UpdateLog instance, therefore all other operations on the UpdateLog are blocked too.&lt;/p&gt;

&lt;p&gt;Because every important UpdateLog method (add, delete, ...) is done using a synchronized block almost each operation is blocked.&lt;/p&gt;

&lt;p&gt;This reduces multi threaded index update to a single thread behavior.&lt;/p&gt;

&lt;p&gt;The described behavior is not depending on any option of the UpdateRequest, so it does not make any difference if &apos;waitFlush&apos;, &apos;waitSearcher&apos; or &apos;softCommit&apos;&#160; is true or false.&lt;/p&gt;

&lt;p&gt;The described behavior makes the usage of ChildDocuments useless, because the performance is unacceptable.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13335008">SOLR-14923</key>
            <summary>Indexing performance is unacceptable when child documents are involved</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="thomas.woeckinger">Thomas W&#246;ckinger</reporter>
                        <labels>
                            <label>performance</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 12 Oct 2020 13:16:02 +0000</created>
                <updated>Mon, 22 Aug 2022 16:57:04 +0000</updated>
                            <resolved>Fri, 8 Jan 2021 05:13:17 +0000</resolved>
                                    <version>8.3</version>
                    <version>8.4</version>
                    <version>8.5</version>
                    <version>8.6</version>
                    <version>8.7</version>
                    <version>9.0</version>
                                    <fixVersion>8.8</fixVersion>
                                    <component>update</component>
                    <component>UpdateRequestProcessors</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="17212360" author="thomas.woeckinger" created="Mon, 12 Oct 2020 13:20:45 +0000"  >&lt;p&gt;The critical lines (branch 8.6) in org.apache.solr.update.processor.DistributedUpdateProcessor are 500 to 505.&lt;/p&gt;

&lt;p&gt;So the question is, can this code be avoided if &apos;waitSearcher&apos; is specified with &apos;false&apos;.&lt;/p&gt;

&lt;p&gt;This is not my first contribution, but in this case it will be a fundamental change, so if someone can guide me in the right direction on fixing this it would be great.&lt;/p&gt;</comment>
                            <comment id="17212567" author="thomas.woeckinger" created="Mon, 12 Oct 2020 18:15:30 +0000"  >&lt;p&gt;Overall index time, for a complete reindex is reduced from 2134 mins to 83 mins when simply commenting out ulog.openRealtimeSearcher and using 12 threads.&lt;/p&gt;

&lt;p&gt;So somehow we should find a solution for this, because the difference is nearly a factor of 26!!&lt;/p&gt;</comment>
                            <comment id="17212597" author="thomas.woeckinger" created="Mon, 12 Oct 2020 18:44:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble&quot; class=&quot;user-hover&quot; rel=&quot;noble&quot;&gt;noble&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; maybe one of you can help, your are involved at the last changes on the DistributedUpdateProcessor.&lt;/p&gt;

&lt;p&gt;Thx for your help.&lt;/p&gt;</comment>
                            <comment id="17213093" author="dsmiley" created="Tue, 13 Oct 2020 12:42:21 +0000"  >&lt;p&gt;I am responsible for this bug, along with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=moshebla&quot; class=&quot;user-hover&quot; rel=&quot;moshebla&quot;&gt;moshebla&lt;/a&gt;, the contributor of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12638&quot; title=&quot;Support atomic updates of nested/child documents for nested-enabled schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12638&quot;&gt;&lt;del&gt;SOLR-12638&lt;/del&gt;&lt;/a&gt;.  Perhaps the single most bit of code I&apos;ve regretted committing on behalf of another are the few lines of code you have found Thomas.  I expressed my reservations at the time:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12638?focusedCommentId=16872898&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16872898&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-12638?focusedCommentId=16872898&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16872898&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What gnaws at me is that this &quot;UpdateLog.openRealtimeSearcher&quot; is being called optimistically on a new doc because maaaayyyybeee some future atomic update will need to see it. And not just any type of atomic update; one that is directly to a nested child doc (something I consider highly experimental). It&apos;s as if we&apos;re optimizing for making that future atomic update faster by doing work in advance that will, I think, very rarely actually be used. It&apos;s a tragedy, if I&apos;m understanding this right.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There&apos;s a bit of conversation before in the issue about it as well.  It&apos;s difficult for me to say at the moment what the fix is because that&apos;s fairly complex low-level Solr code that I think few people understand well.  Nonetheless I&apos;ll look into it further this week.&lt;/p&gt;</comment>
                            <comment id="17213094" author="thomas.woeckinger" created="Tue, 13 Oct 2020 12:43:28 +0000"  >&lt;p&gt;Nearly the same results when moving (line 688 to 694)&lt;/p&gt;

&lt;p&gt;RefCounted&amp;lt;SolrIndexSearcher&amp;gt; holder = uhandler.core.openNewSearcher(true, true);&lt;/p&gt;

&lt;p&gt;out of the synchronized block, so a performance boost of factor 26 at least!&lt;/p&gt;

&lt;p&gt;I don&apos;t know how is responsible for this part of code.&lt;/p&gt;

&lt;p&gt;The final implementation of the method would be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void openRealtimeSearcher() {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      RefCounted&amp;lt;SolrIndexSearcher&amp;gt; holder = uhandler.core.openNewSearcher(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      holder.decref();
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
      SolrException.log(log, &lt;span class=&quot;code-quote&quot;&gt;&quot;Error opening realtime searcher&quot;&lt;/span&gt;, e);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
      &lt;span class=&quot;code-comment&quot;&gt;// We must cause a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexReader to be opened before anything looks at these caches again
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// so that a cache miss will read fresh data.      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (map != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) map.clear();
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prevMap != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) prevMap.clear();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prevMap2 != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) prevMap2.clear();
    }
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Side effects are open for discussion, may &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; have some input on this change&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17222944" author="thomas.woeckinger" created="Thu, 29 Oct 2020 15:07:41 +0000"  >&lt;p&gt;Three test are failing if flowing code (line 503 to 505) is commented out in DistributedUpdateProcessor.java&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(req.getSchema().isUsableForChildDocs() &amp;amp;&amp;amp; shouldRefreshUlogCaches(cmd)) {
        ulog.openRealtimeSearcher();
      }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; - org.apache.solr.cloud.NestedShardedAtomicUpdateTest.test&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; - org.apache.solr.update.processor.NestedAtomicUpdateTest.testBlockAtomicAdd&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt; - org.apache.solr.update.processor.NestedAtomicUpdateTest.testBlockAtomicSet&lt;/p&gt;

&lt;p&gt;A closer look at these unit test show that they are using real time searcher to validate the results.&lt;/p&gt;

&lt;p&gt;So does anyone have time to take a closer look on this isssue?&lt;/p&gt;</comment>
                            <comment id="17225901" author="thomas.woeckinger" created="Wed, 4 Nov 2020 06:53:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; Last investigations on this issue showed that flagging the UpdateLog to open a new RealTimeSearcher (as you mentionend at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12638?focusedCommentId=16872898&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16872898&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-12638?focusedCommentId=16872898&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16872898&lt;/a&gt;) seems to be the best solution.&#160;&lt;/p&gt;

&lt;p&gt;So i can start working on this, a question in advance: Would it be sufficient to track the document ids which require a reload and clear them on each openRealTimeSearcher call?&lt;/p&gt;

&lt;p&gt;Another question: What should be the result of to concurrent updates on the same document?&lt;/p&gt;

&lt;p&gt;I think it is the same as with normal atomic updates, and due the the fact the there is no rollback on transactions this can only be detected by versioning.&lt;/p&gt;</comment>
                            <comment id="17226412" author="dsmiley" created="Wed, 4 Nov 2020 22:41:22 +0000"  >&lt;p&gt;I&apos;ve had trouble prioritizing this because it requires many hours to investigate through code I don&apos;t like.  I&apos;ll try to give you some answers without (yet) really digging in:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would it be sufficient to track the document ids which require a reload and clear them on each openRealTimeSearcher call?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Where would the ID tracking you refer to &lt;em&gt;go&lt;/em&gt; (whose responsibility is it)?  I don&apos;t think UpdateLog.  org.apache.solr.update.processor.DistributedUpdateProcessor is doing a lot already.  Thinking back to my suggestion back on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12638&quot; title=&quot;Support atomic updates of nested/child documents for nested-enabled schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12638&quot;&gt;&lt;del&gt;SOLR-12638&lt;/del&gt;&lt;/a&gt;, I think I was referring RTGComponent because Mosh said that this guy was the thing that was involved for this use-case.  And I was not imagining tracking an ever growing list of IDs somewhere; I think just some sort of dirty flag on RTGComponent.  See the variable &quot;mustUseRealtimeSearcher&quot; there &amp;#8211; maybe we could make it get and clear some AtomicReference&amp;lt;Boolean&amp;gt; or something.  It&apos;s worth a shot but it feels inelegant... I lack the deeper understanding as to why UpdateLog.openRealtimeSearcher must be called at all.  Mosh at the time said &quot;RTGComponent is not aware of the newly indexed yet not committed child docs.&quot;.  This is foggy to me but I don&apos;t know why RTGComponent should be aware at all; I don&apos;t recall how RTGComponent is involved in the whole thing.  Maybe between you and me, we shall figure this out &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;: AFAICT you originally added &lt;tt&gt;UpdateLog.openRealtimeSearcher&lt;/tt&gt;.  Why is it located &lt;em&gt;there&lt;/em&gt; instead of, say, UpdateHandler? I&apos;m honestly confused that UpdateLog refers to the index altogether; it should be independent according to my conceptual understanding.  When there isn&apos;t an updateLog (it&apos;s technically optional), then there may be a bug because the reader probably needs to be re-opened still.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What should be the result of two concurrent updates on the same document?  I think it is the same as with normal atomic updates, and due the the fact the there is no rollback on transactions this can only be detected by versioning.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes; that&apos;s logical to me.&lt;/p&gt;</comment>
                            <comment id="17226436" author="markrmiller" created="Thu, 5 Nov 2020 00:20:20 +0000"  >&lt;p&gt;I&#8217;ll have to look to see. It doesn&#8217;t sound like my area at the time, i would assume Yonik and maybe somehow came through me. If I recall right, I thought that open is for RTG in general and not just child docs. There are a variety of other reasons child and atomic docs are slow though. I&#8217;ve done a lot on that path On the ref branch, would be interesting to see how much better it is, but it doesn&#8217;t change the fact that those kind of docs do synchronous instead of asynchronous updates. Things will also depend how you are sending updates - streaming, batching, or singles. &lt;/p&gt;</comment>
                            <comment id="17226449" author="markrmiller" created="Thu, 5 Nov 2020 01:43:02 +0000"  >&lt;p&gt;I&#8217;ll take a look in the next few days, but FYI, my recollection is that that reopen was for all updates and is required for RTG. I&#8217;ve played around with moving it out of the sync block and I believe that broke RTG. Making those syncs &#8220;fair&#8221; helps.&lt;/p&gt;

&lt;p&gt;If you blast in updates, as they move through the dist update path, they get and release the UpdateLog lock many times. So updates will pile up on those locks, and they will get the lock in random order. So a bunch of updates that are trying to finish may get caught waiting for a bunch of new updates looking to start or do a middle part. Child and atomic updates, that do synchronous distribution or need to wait for a dependent update, clogs things up even more. Making the locks fair at helps updates that came in first to not get caught waiting for all these updates coming in later.&lt;/p&gt;

&lt;p&gt;(Also, while ive made that whole path much, much better, I&#8217;ve still been toying with the idea of making RTG an optional feature - I think it&#8217;s used more rarely and it&#8217;s a shame to pay for it if you don&#8217;t use it at all - peer sync uses RTG, but you can likely keep that working in a way that you don&#8217;t pay as you do now)&lt;/p&gt;</comment>
                            <comment id="17226632" author="thomas.woeckinger" created="Thu, 5 Nov 2020 10:29:33 +0000"  >&lt;p&gt;Some comments about:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;When there isn&apos;t an updateLog (it&apos;s technically optional), then there may be a bug because the reader probably needs to be re-opened still.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If there is no update log configured, atomic updates cannot be used, you get an exception in this case.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; ,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller&quot;&gt;markrmiller&lt;/a&gt; I will have a look at RTG and how it interacts with &apos;Atomic Update&apos;, obviously it is currently required, because when removing the refresh part from DistributedUpdateProcessor there are failing three unit tests as mentioned in the comments before.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17247865" author="thomas.woeckinger" created="Fri, 11 Dec 2020 11:49:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; I started to investigate on this issue, i introduce an AtomicBoolean in the RTG, set by the DistributedUpdateProcessor instead of calling ulog.openRealtimeSearcher()&lt;/p&gt;

&lt;p&gt;and evaluated in public static SolrInputDocument getInputDocument(...) only (line 633).&lt;/p&gt;

&lt;p&gt;This method is defined static and provides the used SolrCore as parameter, so i cannot use a static member in the RTG because the flag must be set by core and evaluated by core otherwise it does not fit together.&lt;/p&gt;

&lt;p&gt;The current solutions is tracked by the UpdateLog which is instantiated by each Updatehandler by each SolrCore, so it fits together.&lt;/p&gt;

&lt;p&gt;So the point is, where should i put this AtomicBoolean (it must be context specific)?&lt;/p&gt;

&lt;p&gt;An alternative solution would be a static Map with a key which separates the context, but i these seems to be ugly.&lt;/p&gt;

&lt;p&gt;Any suggestions&lt;/p&gt;</comment>
                            <comment id="17247908" author="thomas.woeckinger" created="Fri, 11 Dec 2020 12:53:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; A first solution, created a PR, so please review, awaiting your suggestions, stored the field in the RTG instance.&lt;/p&gt;</comment>
                            <comment id="17248237" author="thomas.woeckinger" created="Fri, 11 Dec 2020 22:58:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; I have run some performance tests, results are very promising, when indexing (only adding new documents) with 16 threads, 14 to 15 threads are fully utilized.&lt;/p&gt;

&lt;p&gt;The results are the same as without nested documents.&lt;/p&gt;

&lt;p&gt;I also have done some profiling using JMC, no contention (as expected) from DistributedUpdateProcessor.&lt;/p&gt;

&lt;p&gt;There is still heavy contention on the UpdateLog.add() method, but this will be hard work to optimize. Maybe it would be better to remove this part if RTG is not used that much, but that&apos;s another story.&lt;/p&gt;

&lt;p&gt;I hope you have time to review soon. Thx in advance.&lt;/p&gt;</comment>
                            <comment id="17248302" author="dsmiley" created="Sat, 12 Dec 2020 06:41:07 +0000"  >&lt;p&gt;Hey, nice PR!  It&apos;s not as hacky as I feared it might be &amp;#8211; just an AtomicBoolean (no potentially unbounded Map).  I really appreciate your performance benchmarks to prove this out.&lt;/p&gt;

&lt;p&gt;I&apos;m going to look a bit further this weekend to see if the openRealtimeSearcher can be avoided further.  For example, in RTG.getInputDocument, you added the potential open &lt;em&gt;before&lt;/em&gt; the check if the doc from the updateLog is null... (&lt;tt&gt;sid == null&lt;/tt&gt;) but shouldn&apos;t we not if sid isn&apos;t null?  Thus move it down right below, indented.  Also, maybe in DUP, we can sometimes further restrict when this logic happens &amp;#8211; perhaps only when the document coming in is an atomic update.  I&apos;ll investigate that.&lt;/p&gt;

&lt;p&gt;Earlier in this issue, you tried modifying UpdateLog.openRealtimeSearcher to move the searcher re-open outside of the synchronized block.  That makes sense to me; we should do that. &lt;/p&gt;</comment>
                            <comment id="17248316" author="thomas.woeckinger" created="Sat, 12 Dec 2020 08:53:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;in RTG.getInputDocument, you added the potential open &lt;em&gt;before&lt;/em&gt; the check if the doc from the updateLog is null... (&lt;tt&gt;sid == null&lt;/tt&gt;) but shouldn&apos;t we not if sid isn&apos;t null? Thus move it down right below, indented. Also, maybe in DUP, we can sometimes further restrict when this logic happens &#8211; perhaps only when the document coming in is an atomic update. I&apos;ll investigate that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was my first intention, but org.apache.solr.cloud.NestedShardedAtomicUpdateTest.test will fail if doing so, didn&apos;t find the cause yet.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Earlier in this issue, you tried modifying UpdateLog.openRealtimeSearcher to move the searcher re-open outside of the synchronized block. That makes sense to me; we should do that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This will require some test modification, because some extra commits are required or must be moved, so the behavior will definitely change.&lt;/p&gt;</comment>
                            <comment id="17249484" author="dsmiley" created="Tue, 15 Dec 2020 05:15:47 +0000"  >&lt;p&gt;I spent some time on it last weekend, exploring some ideas / curiosities, but it may be until next weekend before I have more to say due to a big hack/project. &#160;And nested documents is now aligning well with my day job, which helps in getting time.&lt;/p&gt;</comment>
                            <comment id="17250026" author="thomas.woeckinger" created="Wed, 16 Dec 2020 00:28:52 +0000"  >&lt;p&gt;That&apos;s good news, i can support you, if you want, just leave a comment.&lt;/p&gt;</comment>
                            <comment id="17252496" author="thomas.woeckinger" created="Sun, 20 Dec 2020 19:25:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; Any progress on this issue? Can i help you? Would be really great to get this into 8.8 release.&lt;/p&gt;</comment>
                            <comment id="17252647" author="dsmiley" created="Mon, 21 Dec 2020 06:52:56 +0000"  >&lt;p&gt;I found/fixed at least two bugs, probably a third that I feel 95% to catching. &#160;I found it unnecessary to add this AtomicBoolean flag after all, because it&apos;s possible to check when a new realtime searcher needs to be opened by examining when the &lt;tt&gt;&amp;#95;route&amp;#95;&lt;/tt&gt;&#160;param differs from the doc ID sent.  I&apos;ll explain this and more when I finish the 5% tomorrow (assuming all goes well).&lt;/p&gt;</comment>
                            <comment id="17253144" author="dsmiley" created="Mon, 21 Dec 2020 22:05:19 +0000"  >&lt;p&gt;Finally, here&apos;s the PR: &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/2159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/2159&lt;/a&gt;&lt;br/&gt;
It includes some refactorings that made it easier for me to follow the logic.  It was very difficult work overall!  At least it was a learning experience in the relationship between when/why realtime searchers are opened, and their relationship to the update log.  The hardest problem for me to solve was a repeatable assertion I trapped on/about the last line of &lt;tt&gt;org.apache.solr.cloud.NestedShardedAtomicUpdateTest#doRootShardRoutingTest&lt;/tt&gt; in which inplace_updatable_int had the value of &quot;5&quot; instead of &quot;1&quot; for the first iteration because &lt;em&gt;somehow&lt;/em&gt; data from doNestedInplaceUpdateTest() was lingering.  Since this test uses a control client and executes indexing to multiple places, debugging it was a nightmare (the breakpoint of &lt;b&gt;which&lt;/b&gt; core is this?) so I converted the test to a more normal SolrCloudTestCase, after which the bug didn&apos;t take me long.  Today was mostly cleanup/refactoring/commit-notes of everything.&lt;/p&gt;

&lt;p&gt;Commit notes:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14923&quot; title=&quot;Indexing performance is unacceptable when child documents are involved&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14923&quot;&gt;&lt;del&gt;SOLR-14923&lt;/del&gt;&lt;/a&gt;: Nested docs indexing performance.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;UpdateLog.openRealtimeSearcher() was being called for every incoming document when the schema had &lt;em&gt;nest_path&lt;/em&gt;.  It is now more limited to in-place-update of a child doc and in /get when a child doc is given, both of which are uncommon.&lt;/li&gt;
	&lt;li&gt;Atomic/partial updates to nested documents should be faster. In-place updates of the same might be slower (needs to call openRealtimeSearcher).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Refactoring &amp;amp; minor bugs/improvements:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Simplified AddUpdateCommand.getLuceneDoc &amp;amp; getLuceneDocsIfNested relationship, and DirectUpdateHandler2 which calls them.&lt;/li&gt;
	&lt;li&gt;AddUpdateCommand.getIndexedId needed to be updated when &lt;em&gt;route&lt;/em&gt; was specified.&lt;/li&gt;
	&lt;li&gt;NestedShardedAtomicUpdateTest no longer extends AbstractFullDistribZkTestBase because it wasn&apos;t really leveraging the &quot;control client&quot; checking, and it added too much complexity to debug failures.&lt;/li&gt;
	&lt;li&gt;AtomicUpdateDocumentMerger: simplified merge; possibly now supports updates to anonymous children&lt;/li&gt;
	&lt;li&gt;No longer need RTG.Resolution.DOC_WITH_CHILDREN&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17253164" author="thomas.woeckinger" created="Mon, 21 Dec 2020 23:19:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; I take a look at the PR, looks really good to me especially that no additional states and flags are required.&lt;/p&gt;

&lt;p&gt;Going through the call hierarchies of ulog.openRealtimeSearcher() there is no more call on the writing side (beside ulog.add() call which has to, and the calls due to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-7344&quot; title=&quot;Deletion by query of uncommitted docs not working with DV updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-7344&quot;&gt;LUCENE-7344&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;So if there is an PR for 8.x branch (or software is not ready from master yet) i can do some performance tests, if you like.&lt;/p&gt;

&lt;p&gt;Thx a lot for your time, looks very promising!&lt;/p&gt;</comment>
                            <comment id="17253756" author="dsmiley" created="Tue, 22 Dec 2020 20:37:52 +0000"  >&lt;p&gt;I pushed a branch_8x back-port to my fork which only needed a couple trivial changes in NestedShardedAtomicUpdateTest:&lt;br/&gt;
&lt;a href=&quot;https://github.com/dsmiley/lucene-solr/commit/0f08442c7af7f171ffcb36434bd07552303dd88f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dsmiley/lucene-solr/commit/0f08442c7af7f171ffcb36434bd07552303dd88f&lt;/a&gt;&lt;br/&gt;
Please do run a performance test!&lt;/p&gt;</comment>
                            <comment id="17254118" author="thomas.woeckinger" created="Wed, 23 Dec 2020 15:08:29 +0000"  >&lt;p&gt;I run the indexing tests five times, one run took about 60mins +-2mins.&lt;/p&gt;

&lt;p&gt;Compared to the the first version it is about 3-4mins better, which is about 5%&lt;/p&gt;

&lt;p&gt;Lock contention on UpdateLog is also a bit better.&lt;/p&gt;

&lt;p&gt;Another very interesting behavior emerged: In 5 minutes there are about 12000 java.io.FileNotFoundException and about 2000 java.nio.NoSuchFileException thrown. The first is thrown from RAMDirectory.fileLength the second from FSDirectory.fileLength. They are booth used from NRTCachingDirectory.&lt;/p&gt;

&lt;p&gt;The implementation is different between master and 8.x but &lt;b&gt;createTempOutput&lt;/b&gt; is still using the method &lt;b&gt;slowFileExists&lt;/b&gt; which is using exception handling to detect if a file exists, which can be avoided most of the time in the existing implementations. I&apos;m not sure if Solr uses -&lt;em&gt;XX:-StackTraceInThrowable&lt;/em&gt;, but if not these calls can be a hundred times faster. But this seems to be lucene related. May i open different issue for this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; So from my side this looks very good!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17254315" author="dsmiley" created="Wed, 23 Dec 2020 23:06:55 +0000"  >&lt;p&gt;Today I made further modifications to NestedShardedAtomicUpdateTest so that it didn&apos;t always call /get to make some assertions on the results &amp;#8211; I guarded this with a random boolean.  I&apos;m aware that /get can &lt;em&gt;sometimes&lt;/em&gt; trigger a new realtime searcher, and so I wanted to test that the side effect of this wasn&apos;t masking bugs.  It did find a bug &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. And I tracked it down; it&apos;s limited to in-place-updates of a child doc because these updates are added to the update log ID&apos;ed by the document itself, not the root ID it is a part of.  Consequently, a /get later of the root ID asking for child docs (fl=*,&lt;span class=&quot;error&quot;&gt;&amp;#91;child&amp;#93;&lt;/span&gt;) can slip past the updateLog (because the ulog has no updates of this root ID) and the &lt;em&gt;existing&lt;/em&gt; realtimeSearcher will be used, returning a stale value of the updated child document.  This is despite &lt;tt&gt;mustUseRealtimeSearcher==true&lt;/tt&gt; because that only matters if a doc is found in the updateLog.  RTG goes through some great lengths (with added complexity thereof) to avoid calling &lt;tt&gt;ulog.openRealtimeSearcher&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve tried some ideas and I&apos;ll think more on a fix for this one.&lt;/p&gt;</comment>
                            <comment id="17258050" author="dsmiley" created="Mon, 4 Jan 2021 08:05:47 +0000"  >&lt;p&gt;I&apos;ve been &lt;b&gt;obsessed&lt;/b&gt; with this issue over the whole holiday break. &#160;My PR is a bit big; I&apos;d prefer to show more isolated and thus easier to review changes. &#160;I&apos;ve actually gone further with some internal improvements but thankfully managed to shelve them off for another issue. &#160;As it stands, my PR rather insists that the user &lt;em&gt;somehow&lt;/em&gt; tell Solr what the root ID is when doing an atomic update to a child doc. &#160;It&apos;ll complain if you don&apos;t, at least. &#160;But Solr currently doesn&apos;t insist; it will figure it out at some cost in performance &#8211; a&#160;re-open of a realtime searcher and more. &#160;That&apos;s the root of the whole matter. &#160;I think Solr ought to insist, and I think it&apos;s worth it being a breaking change. &#160;To reduce my PR size, I spent some time today &lt;em&gt;trying&lt;/em&gt;&#160;to extricate the improvement in update resolution in AtomicUpdateDocumentMerger that I did a week ago, which nicely means there&apos;s no longer a use-case to set stored=true on the root field. &#160;But everything is interrelated, and it doesn&apos;t quite work / isn&apos;t safe on its own. &#160;Despite the PR being bigger than I&apos;d like, &#160;I&apos;m really happy with it. &#160;It needs a bit more to un-document the stored=true requirement for the root field, and also some important upgrade notes, but is otherwise in committable shape IMO.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; &#8211; you both did herculean work years ago on getting the in-place-update functionality in, which overlaps a lot with the code in my PR. &#160;You may want to review this PR. &#160;&lt;/p&gt;</comment>
                            <comment id="17258224" author="epugh" created="Mon, 4 Jan 2021 14:08:26 +0000"  >&lt;p&gt;I got bit recently in upgrading to newer version of Solr in how the in-place-update works.   This is a powerful feature, and I&apos;d love to see it work with less magic involved!   So I&apos;d be in favor of a breaking change to require that root ID.&lt;/p&gt;</comment>
                            <comment id="17259437" author="dsmiley" created="Wed, 6 Jan 2021 06:03:24 +0000"  >&lt;p&gt;To be clear, the PR:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Atomic/partial updates to nested docs no longer require that &amp;#95;root_ field have stored/docValues.&lt;/li&gt;
	&lt;li&gt;Atomic/partial updates to nested docs no longer require the &amp;#95;nest_path_ field&lt;/li&gt;
	&lt;li&gt;Performance improvements for nested docs, both for normal indexing (as reported by Thomas), and should as well as for atomic/partial updates (not measured). &#160;The &quot;reopen&quot; of a realtime searcher should happen much more rarely.&lt;/li&gt;
	&lt;li&gt;And some general improvements / refactorings, especially in RealTimeGetComponent.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The bad:&lt;/p&gt;

&lt;p&gt;When sending an atomic/partial update for a child doc, it is now required to specify the root doc ID, instead of letting Solr try to figure it out. &#160;Ideally you pass &amp;#95;root_ in the doc. &#160;At least you&apos;ll get an exception typically, so you can adjust. &#160;I also added a fallback that looks at the &amp;#95;route_ parameter, if specified, with the intention of putting that only in 8x. &#160;I added that because I suspect current users of this feature may be using &amp;#95;route_ as the same as the root ID, but that is of course not necessarily a valid assumption. &#160;Much of the internal tests treat them as equivalent, so this was a motivating factor for me to add this hack. &#160;The ref guide doesn&apos;t say they are the same; it mostly steers users to use routed keys instead (exclamation syntax). &#160;It&apos;s quite possible someone today is using this feature and is using a &amp;#95;route_ param that is &lt;em&gt;not&lt;/em&gt; equivalent to the root ID (perhaps an implicitly routed collection?). &#160;I also think this feature is a little exotic, so maybe it&apos;s nobody. &#160;Shrug; I have no strong opinion here &#8211; I could happily remove the hack from the PR. &#160;Either way, if you mess up, you&apos;ll typically get an exception &#8211; no surprises. &#160;I added &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15064&quot; title=&quot;Atomic/partial updates to nested docs should not assume _route_ param is the root ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15064&quot;&gt;&lt;del&gt;SOLR-15064&lt;/del&gt;&lt;/a&gt; (originally worded wrong but is now corrected).&lt;/p&gt;</comment>
                            <comment id="17260596" author="dsmiley" created="Thu, 7 Jan 2021 15:59:50 +0000"  >&lt;p&gt;I quashed the changes, rebased on top of master, added a commit of some minor things, and force pushed.&lt;/p&gt;

&lt;p&gt;I plan to commit tonight.&lt;/p&gt;</comment>
                            <comment id="17260982" author="jira-bot" created="Fri, 8 Jan 2021 04:23:42 +0000"  >&lt;p&gt;Commit 4cb3ad4a1c40b4326aec64577a7e60018f7f1a5e in lucene-solr&apos;s branch refs/heads/master from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4cb3ad4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4cb3ad4&lt;/a&gt; ]&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14923&quot; title=&quot;Indexing performance is unacceptable when child documents are involved&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14923&quot;&gt;&lt;del&gt;SOLR-14923&lt;/del&gt;&lt;/a&gt;: Nested docs indexing perf &amp;amp; robustness (#2159)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When the schema defines &lt;em&gt;root&lt;/em&gt;, and you want to do atomic/partial updates...
	&lt;ul&gt;
		&lt;li&gt;&lt;em&gt;root&lt;/em&gt; needn&apos;t be stored or have docValues any more&lt;/li&gt;
		&lt;li&gt;&lt;em&gt;nest_path&lt;/em&gt; field isn&apos;t needed for this any more&lt;/li&gt;
		&lt;li&gt;Simplified internal logic&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Allow (and recommend, eventually insist) that the &lt;em&gt;root&lt;/em&gt; field be passed for atomic/partial updates to child docs.
	&lt;ul&gt;
		&lt;li&gt;In the absence of &lt;em&gt;root&lt;/em&gt;, assume the &lt;em&gt;route&lt;/em&gt; param is equivalent to ameliorate back-compat scope.  This is a temporary hack; remove in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15064&quot; title=&quot;Atomic/partial updates to nested docs should not assume _route_ param is the root ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15064&quot;&gt;&lt;del&gt;SOLR-15064&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
		&lt;li&gt;One of the two is required; you&apos;ll get an exception if the assumption is false.  THIS IS A BACK-COMPAT CHANGE&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Ensure that the update log contains the &lt;em&gt;root&lt;/em&gt; field if it&apos;s defined in the schema; in some cases it wasn&apos;t.  It&apos;s important for robustness of atomic/partial updates to child docs.  Caveat: the buffer replay scenario is not tested with child docs.&lt;/li&gt;
	&lt;li&gt;Limited the cases when a realtime searcher is re-opened.  It was being applied to any update that included child docs but now only some narrow subset: only for atomic/partial updates, and when the update log contains an in-place update for the same nest because it&apos;s complicated to resolve those log entries.&lt;/li&gt;
	&lt;li&gt;Internal improvements to RealTimeGetComponent to aid clarity &amp;amp; robustness &amp;amp; probably performance...
	&lt;ul&gt;
		&lt;li&gt;Use SolrDocumentFetcher.solrDoc(docID, ReturnFields) instead of more manual loading.  Will do more with this in another PR.&lt;/li&gt;
		&lt;li&gt;Clarify when only root doc IDs are expected.&lt;/li&gt;
		&lt;li&gt;Use Resolution enum more, add PARTIAL, remove DOC_WITH_CHILDREN; enhance docs.&lt;/li&gt;
		&lt;li&gt;When have ReturnFields, a Set of &quot;onlyTheseFields&quot; becomes redundant.  Add a child doc resolution via a transformer when needed.&lt;/li&gt;
		&lt;li&gt;Clarified where copy-field targets are removed&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;NestPathField should default to single valued, instead of inheriting the schema default, which for ancient schemas was multi-valued.&lt;/li&gt;
	&lt;li&gt;AddUpdateCommand.getLuceneDocument(s) methods are very internal; made package visible and refactored a bit for clarity&lt;/li&gt;
	&lt;li&gt;DocumentBuilder: when in-place update, skip id and &lt;em&gt;root&lt;/em&gt; here, thus also simplifying further logic&lt;/li&gt;
	&lt;li&gt;NestedShardedAtomicUpdateTest no longer extends AbstractFullDistribZkTestBase because it wasn&apos;t really leveraging the &quot;control client&quot; checking, and it added too much complexity to debug failures.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17261002" author="jira-bot" created="Fri, 8 Jan 2021 05:09:38 +0000"  >&lt;p&gt;Commit 2417aa085f646f1c5b13ee1bc55d286460dfe826 in lucene-solr&apos;s branch refs/heads/branch_8x from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=2417aa0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=2417aa0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14923&quot; title=&quot;Indexing performance is unacceptable when child documents are involved&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14923&quot;&gt;&lt;del&gt;SOLR-14923&lt;/del&gt;&lt;/a&gt;: Nested docs indexing perf &amp;amp; robustness (#2159)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When the schema defines &lt;em&gt;root&lt;/em&gt;, and you want to do atomic/partial updates...
	&lt;ul&gt;
		&lt;li&gt;&lt;em&gt;root&lt;/em&gt; needn&apos;t be stored or have docValues any more&lt;/li&gt;
		&lt;li&gt;&lt;em&gt;nest_path&lt;/em&gt; field isn&apos;t needed for this any more&lt;/li&gt;
		&lt;li&gt;Simplified internal logic&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Allow (and recommend, eventually insist) that the &lt;em&gt;root&lt;/em&gt; field be passed for atomic/partial updates to child docs.
	&lt;ul&gt;
		&lt;li&gt;In the absence of &lt;em&gt;root&lt;/em&gt;, assume the &lt;em&gt;route&lt;/em&gt; param is equivalent to ameliorate back-compat scope.  This is a temporary hack; remove in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15064&quot; title=&quot;Atomic/partial updates to nested docs should not assume _route_ param is the root ID&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15064&quot;&gt;&lt;del&gt;SOLR-15064&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
		&lt;li&gt;One of the two is required; you&apos;ll get an exception if the assumption is false.  THIS IS A BACK-COMPAT CHANGE&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Ensure that the update log contains the &lt;em&gt;root&lt;/em&gt; field if it&apos;s defined in the schema; in some cases it wasn&apos;t.  It&apos;s important for robustness of atomic/partial updates to child docs.  Caveat: the buffer replay scenario is not tested with child docs.&lt;/li&gt;
	&lt;li&gt;Limited the cases when a realtime searcher is re-opened.  It was being applied to any update that included child docs but now only some narrow subset: only for atomic/partial updates, and when the update log contains an in-place update for the same nest because it&apos;s complicated to resolve those log entries.&lt;/li&gt;
	&lt;li&gt;Internal improvements to RealTimeGetComponent to aid clarity &amp;amp; robustness &amp;amp; probably performance...
	&lt;ul&gt;
		&lt;li&gt;Use SolrDocumentFetcher.solrDoc(docID, ReturnFields) instead of more manual loading.  Will do more with this in another PR.&lt;/li&gt;
		&lt;li&gt;Clarify when only root doc IDs are expected.&lt;/li&gt;
		&lt;li&gt;Use Resolution enum more, add PARTIAL, remove DOC_WITH_CHILDREN; enhance docs.&lt;/li&gt;
		&lt;li&gt;When have ReturnFields, a Set of &quot;onlyTheseFields&quot; becomes redundant.  Add a child doc resolution via a transformer when needed.&lt;/li&gt;
		&lt;li&gt;Clarified where copy-field targets are removed&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;NestPathField should default to single valued, instead of inheriting the schema default, which for ancient schemas was multi-valued.&lt;/li&gt;
	&lt;li&gt;AddUpdateCommand.getLuceneDocument(s) methods are very internal; made package visible and refactored a bit for clarity&lt;/li&gt;
	&lt;li&gt;DocumentBuilder: when in-place update, skip id and &lt;em&gt;root&lt;/em&gt; here, thus also simplifying further logic&lt;/li&gt;
	&lt;li&gt;NestedShardedAtomicUpdateTest no longer extends AbstractFullDistribZkTestBase because it wasn&apos;t really leveraging the &quot;control client&quot; checking, and it added too much complexity to debug failures.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cherry picked from commit 4cb3ad4a1c40b4326aec64577a7e60018f7f1a5e)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13383114">SOLR-15468</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13177593">SOLR-12638</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13348684">SOLR-15064</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13360616">SOLR-15192</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="13350518">SOLR-15069</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jmnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>