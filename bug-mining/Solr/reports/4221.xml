<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:38:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13491] SolrZkClient can register the same watch twice.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13491</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13420&quot; title=&quot;Allow Routed Aliases to use Collection Properties instead of core properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13420&quot;&gt;&lt;del&gt;SOLR-13420&lt;/del&gt;&lt;/a&gt; and related tickets I noticed that we presently use the wrapWatch() method to wrap all zookeeper watches. This allows the watch to be processed asynchronously by an executor which is good, but it subtly changes the way zookeeper behaves. Normally zookeeper keeps a Map&amp;lt;String,Set&amp;lt;Watch&amp;gt;&amp;gt; that ensures that if the same watch is registered twice it&apos;s only notified once. However, our wrapper breaks this because now, if the same watch is added twice each one gets it&apos;s own wrapper with default Object.equals() and thus the two wrapped versions of the Watch aren not .equals() and may co-exist in the Set&amp;lt;Watch&amp;gt;&lt;/p&gt;

&lt;p&gt;I do not know of any current cases for which this would cause a problem, but changes I am contemplating for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13375&quot; title=&quot;2 Dimensional Routed Aliases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13375&quot;&gt;SOLR-13375&lt;/a&gt; are likely to hit this case and at a minimum create wasted re-notifications of the same event and excess watch load in Zk.&lt;/p&gt;

&lt;p&gt;Moving the anonymous class wrapping to an explicit inner class and writing hashcode/equals carefully to act as a pass through such that any to wrappers with the same watch object are .equals() should fix this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13235608">SOLR-13491</key>
            <summary>SolrZkClient can register the same watch twice.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gus">Gus Heck</assignee>
                                    <reporter username="gus">Gus Heck</reporter>
                        <labels>
                    </labels>
                <created>Sat, 25 May 2019 15:28:04 +0000</created>
                <updated>Fri, 26 Jul 2019 08:56:19 +0000</updated>
                            <resolved>Thu, 30 May 2019 14:17:51 +0000</resolved>
                                    <version>8.0</version>
                                    <fixVersion>8.2</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16848250" author="erickerickson" created="Sat, 25 May 2019 16:38:30 +0000"  >&lt;p&gt;We&apos;re routinely seeing many hundreds of replicas, so I should think anything we can do to reduce the load on ZK would be A Good Thing.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gus_heck&quot; class=&quot;user-hover&quot; rel=&quot;gus_heck&quot;&gt;gus_heck&lt;/a&gt; Do you have any inkling of whether moving to ZK 3.5.5 would affect either the problem or the solution? I&apos;m fairly close to being able to commit &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8346&quot; title=&quot;Upgrade Zookeeper to version 3.5.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8346&quot;&gt;&lt;del&gt;SOLR-8346&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16848255" author="gus_heck" created="Sat, 25 May 2019 17:06:10 +0000"  >&lt;p&gt;Not at my desk, but the easy check is to see if watch registration in zookeeper 3.5.5 still lands in a map of sets (there&apos;s a map for data watches, one for exists watches and one other I don&apos;t recall atm.) The goal of this is to let those sets do their thing. I don&apos;t recall seeing  changes to wrapWatch() in your patch, which is all that would change on the solr side.&lt;/p&gt;</comment>
                            <comment id="16851525" author="gus_heck" created="Thu, 30 May 2019 05:05:42 +0000"  >&lt;p&gt;patch with unit test, will commit tomorrow assuming tests/precommit happy.&lt;/p&gt;</comment>
                            <comment id="16851818" author="jira-bot" created="Thu, 30 May 2019 12:45:40 +0000"  >&lt;p&gt;Commit d0c1c36c9162b557a0684c9a3cc4879c7e0cd348 in lucene-solr&apos;s branch refs/heads/master from Gus Heck&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d0c1c36c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d0c1c36c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13491&quot; title=&quot;SolrZkClient can register the same watch twice.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13491&quot;&gt;&lt;del&gt;SOLR-13491&lt;/del&gt;&lt;/a&gt; - SolrZkClient&apos;s watch wrapper no longer allows zookeeper&lt;br/&gt;
to hold the same watch object multiple times.&lt;/p&gt;</comment>
                            <comment id="16851898" author="jira-bot" created="Thu, 30 May 2019 13:59:47 +0000"  >&lt;p&gt;Commit f0d1f9cc9055a1b94344d5e7930ec698ca019809 in lucene-solr&apos;s branch refs/heads/branch_8x from Gus Heck&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f0d1f9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f0d1f9c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13491&quot; title=&quot;SolrZkClient can register the same watch twice.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13491&quot;&gt;&lt;del&gt;SOLR-13491&lt;/del&gt;&lt;/a&gt; - SolrZkClient&apos;s watch wrapper no longer allows zookeeper&lt;br/&gt;
to hold the same watch object multiple times.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d0c1c36c9162b557a0684c9a3cc4879c7e0cd348)&lt;/p&gt;</comment>
                            <comment id="16851917" author="jira-bot" created="Thu, 30 May 2019 14:15:50 +0000"  >&lt;p&gt;Commit 6ede32a0796eead46c214104d92c083aabb18f2d in lucene-solr&apos;s branch refs/heads/master from Gus Heck&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6ede32a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6ede32a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13491&quot; title=&quot;SolrZkClient can register the same watch twice.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13491&quot;&gt;&lt;del&gt;SOLR-13491&lt;/del&gt;&lt;/a&gt; - Touch-up test. Beasting failed 1/50 (5) Now passes 500/500 (20).&lt;/p&gt;</comment>
                            <comment id="16851921" author="gus_heck" created="Thu, 30 May 2019 14:17:01 +0000"  >&lt;p&gt;Got lucky and found a rare failure while committing to 8x so touched up the the test.&lt;/p&gt;</comment>
                            <comment id="16893570" author="ivera" created="Fri, 26 Jul 2019 08:56:19 +0000"  >&lt;p&gt;Closing after the 8.2.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13231279">SOLR-13439</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12970272" name="SOLR-13491.patch" size="10507" author="gus" created="Thu, 30 May 2019 05:04:57 +0000"/>
                            <attachment id="12969917" name="SOLR-13491.patch" size="3722" author="gus" created="Mon, 27 May 2019 14:38:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z032wg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>