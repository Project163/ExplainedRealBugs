<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:34:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12616] Track down performance slowdowns with ExportWriter</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12616</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Just to be clear for users glancing through this Jira : The performance slowdown is currently on an unreleased version of Solr so no versions are affected by this.&lt;/p&gt;

&lt;p&gt;While doing some benchmarking for&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12572&quot; title=&quot;Reuse fieldvalues computed while sorting at writing in ExportWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12572&quot;&gt;&lt;del&gt;SOLR-12572&lt;/del&gt;&lt;/a&gt; , I compared the export writers performance against Solr 7.4 and there seems to be some slowdowns that have been introduced. Most likely this is because of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11598&quot; title=&quot;ExportWriter should support sorting on more than 4 sort fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11598&quot;&gt;&lt;del&gt;SOLR-11598&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In an 1 shard 1 replica collection with 25M docs. We issue the following query&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/export?q=*:*&amp;amp;sort=id desc&amp;amp;fl=id&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Solr 7.4 took 8:10 , 8:20 and 8:22 in the 3 runs that I did&lt;/p&gt;

&lt;p&gt;Master took 10:46&lt;/p&gt;

&lt;p&gt;Amrit&apos;s done some more benchmarking so he can fill in with some more numbers here.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13176602">SOLR-12616</key>
            <summary>Track down performance slowdowns with ExportWriter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="varun">Varun Thacker</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Aug 2018 01:55:23 +0000</created>
                <updated>Thu, 21 Nov 2019 00:41:50 +0000</updated>
                            <resolved>Wed, 8 Aug 2018 20:30:49 +0000</resolved>
                                                    <fixVersion>7.5</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>streaming expressions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16569031" author="varunthacker" created="Sat, 4 Aug 2018 03:48:30 +0000"  >&lt;p&gt;Patch which&#160;tests &lt;tt&gt;SingleValueSortDoc&lt;/tt&gt; vs&#160;SortDoc&#160;&lt;/p&gt;

&lt;p&gt;Indexed 25M docs onto a 1 shard X 1 replica collection.&#160;&lt;/p&gt;

&lt;p&gt;query&#160;-&#160;&lt;tt&gt;/export?q=&lt;b&gt;:&lt;/b&gt;&amp;amp;fl=id&amp;amp;sort=id desc&lt;/tt&gt;&#160;&lt;/p&gt;

&lt;p&gt;With&#160; &lt;tt&gt;-Dtest.export.writer.optimized=true&lt;/tt&gt;&#160;=&#160;7m13 ,&#160;7m23&lt;/p&gt;

&lt;p&gt;Without&#160;&lt;tt&gt;-Dtest.export.writer.optimized=true&lt;/tt&gt;&#160;=&#160;10m27 ,&#160;10m31&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For both SortDoc and&#160;SingleValueSortDoc&lt;/p&gt;

&lt;p&gt;lessThan get&apos;s called 33049246584 times&lt;br/&gt;
setValues get&apos;s called 11220331053 times&lt;/p&gt;</comment>
                            <comment id="16571042" author="varunthacker" created="Tue, 7 Aug 2018 02:30:25 +0000"  >&lt;p&gt;I can&apos;t seem to track down the difference b/w&#160;SortDoc and SingleValueSortDoc and why&#160;SingleValueSortDoc is so much faster.&lt;/p&gt;

&lt;p&gt;I tried another round of experiments where I assumed SortDoc will only have one sort field and modified the following functions to mimic&#160;SingleValueSortDoc . The only difference at this point from SingleValueSortDoc&#160;is that sortValues is still an array of length one VS a variable. The speed difference still exists&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setValues(SortDoc sortDoc) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.docId = sortDoc.docId;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.ord = sortDoc.ord;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.docBase = sortDoc.docBase;
    sortValues[0].setCurrentValue((sortDoc.sortValues[0]));
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; lessThan(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(docId == -1) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; comp = sortValues[0].compareTo(sd.sortValues[0]);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(comp == -1) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 1) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; docId+docBase &amp;gt; sd.docId+sd.docBase;
    }
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To bring back the old performance the one approach we could take is still keep the specialized classes for upto 4 sort fields by doing this in the export writer&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sortValues.length == 1) {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SingleValueSortDoc(sortValues[0]);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sortValues.length == 2) {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DoubleValueSortDoc(sortValues[0]);
} ... &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 3 and 4 sort fields .. 
 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SortDoc(sortValues);
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16571751" author="sarkaramrit2@gmail.com" created="Tue, 7 Aug 2018 14:29:32 +0000"  >&lt;p&gt;Thanks Varun for such detailed analysis and feedback on the issue. I see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11598&quot; title=&quot;ExportWriter should support sorting on more than 4 sort fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11598&quot;&gt;&lt;del&gt;SOLR-11598&lt;/del&gt;&lt;/a&gt; resulted in slowness. Benchmarks done at my end also validates an approx 10-18% slowdowns in overall processing of export results.&lt;/p&gt;

&lt;p&gt;I digged deeper and found the actual function which is slow, but have no idea of reason. Let me share the analysis first:&lt;/p&gt;

&lt;p&gt;For query Q1, single sort, with &lt;tt&gt;SingleValueSortDoc&lt;/tt&gt; introduced again, taking 4 mins, while vanila master branch code taking 4:45 mins. I attached a sampler on solr server and attaching screenshots in the jira for the respective export query executions.&lt;/p&gt;

&lt;p&gt;If you see screenshots: &lt;tt&gt;SingleSortValue-2&lt;/tt&gt; and &lt;tt&gt;DefaultSortValue-2&lt;/tt&gt;, the only significant difference (around 33 secs) between the processing times of respective executions is &lt;tt&gt;setCurrentValue(docId)&lt;/tt&gt;, which we haven&apos;t touched.&lt;br/&gt;
SingleSortValue: setCurrentValue(docId): &lt;b&gt;148 secs&lt;/b&gt;&lt;br/&gt;
DefaultCode: setCurrentValue(docId): &lt;b&gt;181 secs&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I have analyzed the code properly enough to conclude we are not making extra / unnecessary calls  for &lt;tt&gt;setCurrentValue&lt;/tt&gt;, we know the exact line number which is causing the slowness: &lt;b&gt;ExportWriter:235&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="16573611" author="varunthacker" created="Wed, 8 Aug 2018 18:04:20 +0000"  >&lt;p&gt;Patch which adds back&#160;SingleValueSortDoc/ DoubleValueSortDoc/ TripleValueSortDoc/ QuadValueSortDoc classes. The speed is back to the original speed after doing some tests.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16573820" author="jira-bot" created="Wed, 8 Aug 2018 20:28:11 +0000"  >&lt;p&gt;Commit e9f3a3ce1d482bd90ba8aca6e8cb7fe6c86756eb in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e9f3a3c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e9f3a3c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12616&quot; title=&quot;Track down performance slowdowns with ExportWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12616&quot;&gt;&lt;del&gt;SOLR-12616&lt;/del&gt;&lt;/a&gt;: Optimize Export writer upto 4 sort fields to get better performance. This was removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11598&quot; title=&quot;ExportWriter should support sorting on more than 4 sort fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11598&quot;&gt;&lt;del&gt;SOLR-11598&lt;/del&gt;&lt;/a&gt; but brought back in the same version&lt;/p&gt;</comment>
                            <comment id="16573824" author="jira-bot" created="Wed, 8 Aug 2018 20:30:24 +0000"  >&lt;p&gt;Commit 13b9e28f9dbb0d117d8758c37d8df7d4c17a9edc in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=13b9e28f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=13b9e28f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12616&quot; title=&quot;Track down performance slowdowns with ExportWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12616&quot;&gt;&lt;del&gt;SOLR-12616&lt;/del&gt;&lt;/a&gt;: Optimize Export writer upto 4 sort fields to get better performance. This was removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11598&quot; title=&quot;ExportWriter should support sorting on more than 4 sort fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11598&quot;&gt;&lt;del&gt;SOLR-11598&lt;/del&gt;&lt;/a&gt; but brought back in the same version&lt;/p&gt;

&lt;p&gt;(cherry picked from commit e9f3a3c)&lt;/p&gt;</comment>
                            <comment id="16575995" author="jira-bot" created="Fri, 10 Aug 2018 09:13:47 +0000"  >&lt;p&gt;Commit e9f3a3ce1d482bd90ba8aca6e8cb7fe6c86756eb in lucene-solr&apos;s branch refs/heads/jira/http2 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e9f3a3c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e9f3a3c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12616&quot; title=&quot;Track down performance slowdowns with ExportWriter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12616&quot;&gt;&lt;del&gt;SOLR-12616&lt;/del&gt;&lt;/a&gt;: Optimize Export writer upto 4 sort fields to get better performance. This was removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11598&quot; title=&quot;ExportWriter should support sorting on more than 4 sort fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11598&quot;&gt;&lt;del&gt;SOLR-11598&lt;/del&gt;&lt;/a&gt; but brought back in the same version&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12934655" name="DefaultCode-1.png" size="578648" author="sarkaramrit2@gmail.com" created="Tue, 7 Aug 2018 14:29:49 +0000"/>
                            <attachment id="12934656" name="DefaultCode-2.png" size="261011" author="sarkaramrit2@gmail.com" created="Tue, 7 Aug 2018 14:29:49 +0000"/>
                            <attachment id="12934855" name="SOLR-12616.patch" size="17189" author="varun" created="Wed, 8 Aug 2018 18:03:38 +0000"/>
                            <attachment id="12934375" name="SOLR-12616.patch" size="4079" author="varun" created="Sat, 4 Aug 2018 03:42:13 +0000"/>
                            <attachment id="12934657" name="SingleSortValue-1.png" size="419994" author="sarkaramrit2@gmail.com" created="Tue, 7 Aug 2018 14:29:49 +0000"/>
                            <attachment id="12934658" name="SingleSortValue-2.png" size="546980" author="sarkaramrit2@gmail.com" created="Tue, 7 Aug 2018 14:29:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wn87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>