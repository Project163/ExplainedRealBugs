<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:55:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6264] Distributed commit and optimize are executed serially across all replicas.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6264</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Regardless of whether one agrees with optimizing, when you execute an optimize request using waitSearcher=true, the requests from the controller node are sent to each replica in the collection serially. &lt;/p&gt;

&lt;p&gt;You can send the optimize command to the update handler for a collection to any node in the cluster. For instance, if I had a collection named &quot;foo&quot;:&lt;/p&gt;

&lt;p&gt;curl -i -v &lt;a href=&quot;http://localhost:8984/solr/foo/update&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8984/solr/foo/update&lt;/a&gt; --data-binary &apos;&amp;lt;optimize maxSegments=&quot;1&quot; waitSearcher=&quot;true&quot;/&amp;gt;&apos; -H &apos;Content-type:application/xml&apos;&lt;/p&gt;

&lt;p&gt;The node that receives this request will collect the URL for all &quot;live&quot; replicas in the collection (not just leaders) (see DistributedUpdateProcessor#getCollectionUrls) and then forward the commit request to each of them. On the surface, the code looks like it forwards the request asynchronously to all replicas. However, this is not actually what happens; the commit requests to each replica in the collection will be processed serially when using waitSearcher=true (because ConcurrentUpdateSolrServer&apos;s background queue processing is by-passed for commits).&lt;/p&gt;

&lt;p&gt;Bottom-line, if you request the collection to be optimized, the request gets forwarded around as you&apos;d expect but is done synchronously so can take a long time. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12728737">SOLR-6264</key>
            <summary>Distributed commit and optimize are executed serially across all replicas.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="thelabdude">Timothy Potter</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Jul 2014 23:50:02 +0000</created>
                <updated>Mon, 9 May 2016 18:52:58 +0000</updated>
                            <resolved>Mon, 28 Jul 2014 18:46:52 +0000</resolved>
                                                    <fixVersion>4.10</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14069552" author="yseeley@gmail.com" created="Tue, 22 Jul 2014 00:00:42 +0000"  >&lt;p&gt;Good catch!  Is this true for commit also?&lt;/p&gt;</comment>
                            <comment id="14069570" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 00:15:52 +0000"  >&lt;blockquote&gt;&lt;p&gt; waitSearcher=true (because ConcurrentUpdateSolrServer&apos;s background queue processing is by-passed for commits).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But don&apos;t we use a different ConcurrentUpdateSolrServer for each Solr URL?&lt;/p&gt;</comment>
                            <comment id="14069574" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 00:19:32 +0000"  >&lt;p&gt;I see - it waits for each call on each ConcurrentUpdateSolrServer#request call as it loops through them. Interesting. Good find, fairly ugly, let&apos;s fix it.&lt;/p&gt;</comment>
                            <comment id="14069577" author="thelabdude" created="Tue, 22 Jul 2014 00:20:46 +0000"  >&lt;p&gt;Yes, we do, which is why this is tricky to see &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The SolrCmdDistributor.distribCommit has a for loop that calls submit:&lt;/p&gt;

&lt;p&gt;    for (Node node : nodes) &lt;/p&gt;
{
      submit(new Req(cmd.toString(), node, uReq, false));
    }

&lt;p&gt;The submit uses a different CUSS of course, but the for loop is blocked because the &quot;async&quot; submit is actually sync because ConcurrentUpdateSolrServer skips the runners part if it&apos;s a commit. I only stumbled upon this by looking at timestamp of requests and realized they were running serially and then scratched my head a bit because I know StreamingSolrServers and CUSS pretty well at this point.&lt;/p&gt;

&lt;p&gt;I think it is true for commits too.&lt;/p&gt;</comment>
                            <comment id="14069583" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 00:25:28 +0000"  >&lt;p&gt;Perhaps we have to put in a thread pool and ensure the async path of SolrCmdDistrbiutor#submit is async by putting it on another thread and making errors thread safe. I&apos;m not sure - take a bit of thought to trace it all out.&lt;/p&gt;</comment>
                            <comment id="14069584" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 00:26:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think it is true for commits too.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s certainly true for commits - it only happens for optimize because it rides commits.&lt;/p&gt;</comment>
                            <comment id="14069630" author="thelabdude" created="Tue, 22 Jul 2014 00:57:00 +0000"  >&lt;p&gt;We probably only want to use the thread poll for commits (and optimizes) ... for other update requests, we probably don&apos;t want to spawn a thread that spawns runners, right?&lt;/p&gt;</comment>
                            <comment id="14069684" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 01:45:41 +0000"  >&lt;p&gt;Here is a rough patch with what I&apos;m thinking.&lt;/p&gt;</comment>
                            <comment id="14069690" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 01:51:54 +0000"  >&lt;p&gt;I still have to finish it up and run some tests - just a quick jam out for comment.&lt;/p&gt;</comment>
                            <comment id="14069776" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 03:51:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;with waitSearcher=true&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think you will get the same thing with a pure commit and no docs or deletes.&lt;/p&gt;</comment>
                            <comment id="14070415" author="thelabdude" created="Tue, 22 Jul 2014 15:55:56 +0000"  >&lt;p&gt;Patch looks good and I ran it through my scenario (described above ^) and the optimize was definitely sent to all replicas in parallel and finished in less than half the runtime previously.&lt;/p&gt;</comment>
                            <comment id="14075412" author="markrmiller@gmail.com" created="Sat, 26 Jul 2014 15:03:55 +0000"  >&lt;p&gt;Here is a cleaned up patch. If there are no further comments, I&apos;ll commit this soon.&lt;/p&gt;</comment>
                            <comment id="14075421" author="shalinmangar" created="Sat, 26 Jul 2014 16:06:13 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;</comment>
                            <comment id="14076569" author="jira-bot" created="Mon, 28 Jul 2014 18:45:47 +0000"  >&lt;p&gt;Commit 1614118 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1614118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1614118&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6264&quot; title=&quot;Distributed commit and optimize are executed serially across all replicas.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6264&quot;&gt;&lt;del&gt;SOLR-6264&lt;/del&gt;&lt;/a&gt;: Distributed commit and optimize are executed serially across all replicas.&lt;/p&gt;</comment>
                            <comment id="14076572" author="jira-bot" created="Mon, 28 Jul 2014 18:46:37 +0000"  >&lt;p&gt;Commit 1614120 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1614120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1614120&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6264&quot; title=&quot;Distributed commit and optimize are executed serially across all replicas.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6264&quot;&gt;&lt;del&gt;SOLR-6264&lt;/del&gt;&lt;/a&gt;: Distributed commit and optimize are executed serially across all replicas.&lt;/p&gt;</comment>
                            <comment id="14076574" author="markrmiller@gmail.com" created="Mon, 28 Jul 2014 18:46:52 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12657996" name="SOLR-6264.patch" size="6675" author="markrmiller@gmail.com" created="Sat, 26 Jul 2014 15:03:55 +0000"/>
                            <attachment id="12657030" name="SOLR-6264.patch" size="6077" author="markrmiller@gmail.com" created="Tue, 22 Jul 2014 01:50:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>406811</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1y06n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>406831</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>