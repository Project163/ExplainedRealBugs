<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:32:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12290] Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12290</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Original Summary:&lt;/p&gt;

&lt;p&gt;When you fetch a file for replication we close the request output stream after writing the file which ruins the connection for reuse.&lt;/p&gt;

&lt;p&gt;We can&apos;t close response output streams, we need to reuse these connections. If we do close them, clients are hit with connection problems when they try and reuse the connection from their pool.&lt;/p&gt;

&lt;p&gt;New Summary:&lt;/p&gt;

&lt;p&gt;At some point the above was addressed during refactoring. We should remove these neutered closes and review our close shield code.&lt;/p&gt;


&lt;p&gt;If you are here to track down why this is done:&lt;/p&gt;

&lt;p&gt;Connection reuse requires that we read all streams and do not close them - instead the container itself must manage request and response streams. If we allow them to be closed, not only do we lose some connection reuse, but we can cause spurious client errors that can cause expensive recoveries for no reason. The spec allows us to count on the container to manage streams. It&apos;s our job simply to not close them and to always read them fully, from client and server. &lt;/p&gt;

&lt;p&gt;Java itself can help with always reading the streams fully up to some small default amount of unread stream slack, but that is very dangerous to count on, so we always manually eat up anything on the streams our normal logic ends up not reading for whatever reason.&lt;/p&gt;

&lt;p&gt;We also cannot call abort without ruining the connection or sendError. These should be options of very last resort (requiring a blood sacrifice) or when shutting down.&lt;/p&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13155994">SOLR-12290</key>
            <summary>Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 Apr 2018 16:46:16 +0000</created>
                <updated>Sat, 8 Jun 2019 15:13:12 +0000</updated>
                            <resolved>Thu, 7 Jun 2018 00:32:13 +0000</resolved>
                                                    <fixVersion>7.4</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16458075" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 17:04:44 +0000"  >&lt;p&gt;This is kind of ugly because it happens during recovery - so if lots of updates are coming in, it&apos;s possible that you have a legit reason to recover, you start to recover, that ruins connections, updates can fail because of that, recovery is triggered again, updates still coming in ... etc.&lt;/p&gt;</comment>
                            <comment id="16458106" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 17:55:57 +0000"  >&lt;p&gt;Looks like this may actually have been fixed during some refactoring at some point. I found this in an older code base and saw we still close these streams, but at some point we started shielding the&#160;response writer close at a higher level. I originally put in those close shields, but had missed shielding the response writing properly. I think when HttpSolrCall came about, this ended up getting shielded.&lt;/p&gt;

&lt;p&gt;So I&apos;ll remove these closes and review our shielding and testing. It seems a little error prone right now and I think we can do better.&lt;/p&gt;</comment>
                            <comment id="16458112" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 18:40:25 +0000"  >&lt;p&gt;Patch attached that cleans this up to be less error prone and remove any closes of the request / response streams whether they were neutered or not.&lt;/p&gt;</comment>
                            <comment id="16458192" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 20:53:00 +0000"  >&lt;p&gt;New patch. We only assert no closes on callers from lucene and solr packages - for 3rd parties we just shield the close.&lt;/p&gt;</comment>
                            <comment id="16458205" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 21:27:31 +0000"  >&lt;p&gt;Okay, I think this is final or close to. Gives us much less fragile protection and forces devs to understand the ramifications of the neutered close.&lt;/p&gt;</comment>
                            <comment id="16458237" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 23:28:48 +0000"  >&lt;p&gt;Last patch, precommit and tests pass.&lt;/p&gt;</comment>
                            <comment id="16458293" author="dsmiley" created="Mon, 30 Apr 2018 03:34:31 +0000"  >&lt;p&gt;Hi Mark. &#160;In &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11692&quot; title=&quot;SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11692&quot;&gt;&lt;del&gt;SOLR-11692&lt;/del&gt;&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=millerjeff0&quot; class=&quot;user-hover&quot; rel=&quot;millerjeff0&quot;&gt;millerjeff0&lt;/a&gt; and I&#160;took care not to wrap a closeShield in SolrDispatchFilter.doFilter&#160;when the request continues on thru chain.doFilter &#160;(line ~367). &#160;Admittedly there isn&apos;t a test for this and I forget precisely why it mattered.&lt;/p&gt;

&lt;p&gt;Otherwise overall the patch looks good.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;JavabinLoader: you can now inline parseAndLoadDocs&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16458295" author="markrmiller@gmail.com" created="Mon, 30 Apr 2018 03:55:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Admittedly there isn&apos;t a test for this and I forget precisely why it mattered.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s because we can&apos;t control closing the outputstream in some 3rd party code. For example Jetty incorrectly does this when you forward.&lt;/p&gt;

&lt;p&gt;We need to shield everywhere, there is no legitimate closing except by the container, so this fixes that issue correctly by only triggering an assert when it&apos;s our code and ignoring all non container closes all the time in non test code.&lt;/p&gt;</comment>
                            <comment id="16458299" author="markrmiller@gmail.com" created="Mon, 30 Apr 2018 04:25:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Jetty incorrectly&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;To clarify that, a Jetty servlet does it, not the Jetty container. I guess from that perspective it&apos;s not totally incorrect because you could say the servlet simply doesn&apos;t support connection reuse well. But connection reuse is very, very important for us and we actually plug that servlet logic into our filter. So we shield that servlet close, that just happens to be a jetty implemented servlet, and we allow only the container itself to close streams.&lt;/p&gt;</comment>
                            <comment id="16458314" author="markrmiller@gmail.com" created="Mon, 30 Apr 2018 05:10:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;JavabinLoader: you can now inline parseAndLoadDocs&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Inlined.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this in the next couple days. It extends test and safety coverage to the entire SolrDispatchFilter for the first time as well as to our Servlets. It also removes the separate test code path, and so testing and protecting no longer have different coverage and everything is tested and protected on one code path.&lt;/p&gt;

&lt;p&gt;I&apos;ve also returned this to a bug. Given &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11692&quot; title=&quot;SolrDispatchFilter.closeShield passes the shielded response object back to jetty making the stream unclose able&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11692&quot;&gt;&lt;del&gt;SOLR-11692&lt;/del&gt;&lt;/a&gt; and some places we never protected (the other servlets) and the fact that different things have been covered at different points of time, this will solve existing spurious cluster recovery issues.&lt;/p&gt;</comment>
                            <comment id="16458566" author="dsmiley" created="Mon, 30 Apr 2018 13:27:27 +0000"  >&lt;p&gt;Sounds good Mark! &#160;Thanks for the clarifications. &#160;I didn&apos;t know this problem could&#160;lead to client recovery; ouch!&lt;/p&gt;</comment>
                            <comment id="16458594" author="markrmiller@gmail.com" created="Mon, 30 Apr 2018 13:56:39 +0000"  >&lt;p&gt;Yeah, it&#8217;s not super obvious, but the problem with closing ourselves is that the we can&#8217;t clear any data that might be left on the stream and we also can&#8217;t gaurantee some data does t show up from the other side right after an early close. So to ensure connection reuse you cannot close yourself.&lt;/p&gt;</comment>
                            <comment id="16458676" author="markrmiller@gmail.com" created="Mon, 30 Apr 2018 15:47:12 +0000"  >&lt;p&gt;As I&apos;ve been working on this, I realized that we don&apos;t ensure reading full streams when we get files for replication, whether we close the streams early or not.&lt;/p&gt;

&lt;p&gt;I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12293&quot; title=&quot;Updates need to use their own connection pool to maintain connection reuse and prevent spurious recoveries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12293&quot;&gt;&lt;del&gt;SOLR-12293&lt;/del&gt;&lt;/a&gt;. We need to isolate our update connection pool from these other random uses.&lt;/p&gt;</comment>
                            <comment id="16460143" author="markrmiller@gmail.com" created="Tue, 1 May 2018 20:54:48 +0000"  >&lt;p&gt;For a long term strategy to improve all of this yet again (of course all the previous HttpClient Http1.1 connection failure work was always a stop gap band aid and as we found out extremely hard to fully nail down), I filed&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12297&quot; title=&quot;Add Http2SolrClient, capable of HTTP/1.1, HTTP/2, and asynchronous requests.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12297&quot;&gt;&lt;del&gt;SOLR-12297&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16464484" author="jira-bot" created="Fri, 4 May 2018 23:02:17 +0000"  >&lt;p&gt;Commit 296201055f24f01e1610f2fb87aba7fa90b9dda1 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mark.miller%40oblivion.ch&quot; class=&quot;user-hover&quot; rel=&quot;mark.miller@oblivion.ch&quot;&gt;mark.miller@oblivion.ch&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2962010&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2962010&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;: Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&lt;/p&gt;</comment>
                            <comment id="16465235" author="thetaphi" created="Sun, 6 May 2018 17:47:50 +0000"  >&lt;p&gt;This commit breaks TestCSVLoader on Windows. It looks like Solr no longer closes any content streams that are passed separately to the servlet stream:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestCSVLoader -Dtests.method=testLiteral -Dtests.seed=B40869AE03F63CBC -Dtests.locale=ms -Dtests.timezone=ECT -Dtests.asserts=true -Dtests.file.encoding=UTF-8
   [junit4] ERROR   0.06s | TestCSVLoader.testLiteral &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.nio.file.FileSystemException: C:\Users\Uwe Schindler\Projects\lucene\trunk-lusolr1\solr\build\solr-core\test\J0\temp\solr.handler.TestCSVLoader_B40869AE03F63CBC-001\TestCSVLoader-006\solr_tmp.csv: Der Prozess kann nicht auf die Datei zugreifen, da sie von einem anderen Prozess verwendet wird.
   [junit4]    &amp;gt;        at __randomizedtesting.SeedInfo.seed([B40869AE03F63CBC:B2ACAF677D87833E]:0)
   [junit4]    &amp;gt;        at sun.nio.fs.WindowsException.translateToIOException(WindowsException.java:86)
   [junit4]    &amp;gt;        at sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:97)
   [junit4]    &amp;gt;        at sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:102)
   [junit4]    &amp;gt;        at sun.nio.fs.WindowsFileSystemProvider.implDelete(WindowsFileSystemProvider.java:269)
   [junit4]    &amp;gt;        at sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:103)
   [junit4]    &amp;gt;        at java.nio.file.Files.delete(Files.java:1126)
   [junit4]    &amp;gt;        at org.apache.solr.handler.TestCSVLoader.tearDown(TestCSVLoader.java:64)
   [junit4]    &amp;gt;        at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am not sure behind the reasoning of forcefully preventing closing of ServletInputStreams - but IMHO, the better way to handle this is (we had this discussion already a while ago):&lt;/p&gt;

&lt;p&gt;Wrap the ServletInput/ServletOutput streams with a CloseShieldXxxxStream and only pass this one around. This allows that code anywhere in solr is free to close any streams correctly (which it should), but the ServletStreams are kept open by the shield.&lt;br/&gt;
The issue we have now is that ContentStreams are not necessarily (like in BlobUploadHandler, CSVHandler) coming from the servlet streams. If it is a file or a uploaded file, then we HAVE to close the stream.&lt;/p&gt;

&lt;p&gt;The reason behind everything here is a bug in Jetty - in contrast to Tomcat and all other servlet containers, it closes the socket after you close the servlet streams. This is a bug - sorry! Jetty should prevent closing the underlying stream stream!&lt;/p&gt;

&lt;p&gt;Please revert the current commit. I can help in solving this correctly - unfortunately I am on travel next week.&lt;/p&gt;</comment>
                            <comment id="16465237" author="thetaphi" created="Sun, 6 May 2018 17:50:58 +0000"  >&lt;p&gt;I just repeat: We have no a serious file descriptor leak in combination with ContentStreams!!! &lt;/p&gt;</comment>
                            <comment id="16465240" author="thetaphi" created="Sun, 6 May 2018 18:02:13 +0000"  >&lt;p&gt;I think I know how to solve this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Revert all stuf that removed close of code that uses ContentStream&lt;/li&gt;
	&lt;li&gt;In SolrRequestParsers$HttpRequestContentStream add a CloseShieldInputStream in the getStream() method. This should solve the file leaks caused by no longer closing streams on files...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This should make the changes in BlobHandler and CSVLoaderBase obsolete - and code clean again. It&apos;s a no-go to not close streams of unknown origin!&lt;/p&gt;</comment>
                            <comment id="16465241" author="markrmiller@gmail.com" created="Sun, 6 May 2018 18:03:40 +0000"  >&lt;p&gt;I will look into this Uwe. We are still using a CloseShield. Relax, this is only on master and is not a very large change from what we were doing before.&lt;/p&gt;</comment>
                            <comment id="16465244" author="thetaphi" created="Sun, 6 May 2018 18:12:06 +0000"  >&lt;p&gt;I have seen. It&apos;s fine! I was just really annoyed today while running tests locally. All tests that use ContentStreams with file uploads or files break horribly on windows (which is a sign for file dexcriptor leaks, so I am glad that we run tests on Windows).&lt;/p&gt;

&lt;p&gt;As said before: I&apos;d just revert the code where we consume the ContentStream subclasses (BlobHandler, CSVHandler, maybe DIH,...) and just add another CloseShield in the HttpRequestContentStream.&lt;/p&gt;</comment>
                            <comment id="16465248" author="thetaphi" created="Sun, 6 May 2018 18:22:05 +0000"  >&lt;p&gt;I think your patch is fine. Really just revert the code that prevents closing of ContentStream.getStream() stuff. That makes half of the patch obsolete! So it looks like you are doing the wrapping AND preventing closing in solr stuff that reads from those ContentStreams? Why do both if the first already solves the issue?&lt;/p&gt;</comment>
                            <comment id="16465249" author="markrmiller@gmail.com" created="Sun, 6 May 2018 18:28:39 +0000"  >&lt;p&gt;Because we no longer have two separate code paths for tests and normal runs, we have an assert that lets developers know when their closes are no ops so that developers can understand what is actually going on. We don&apos;t need a close when it won&apos;t actually do anything. We should just close where we need to. In cases like the CSVHandler we need to.&lt;/p&gt;

&lt;p&gt;Whether Jetty closed the socket or not, we can&apos;t have anyone close these stream because we have to make sure they are fully consumed.&lt;/p&gt;

&lt;p&gt;Anyway, it&apos;s simple to fix, I&apos;m not going to jam anything in though, I have to run tests and what not.&lt;/p&gt;</comment>
                            <comment id="16465252" author="thetaphi" created="Sun, 6 May 2018 18:55:40 +0000"  >&lt;p&gt;It&apos;s not only CSV handler. It&apos;s all code that consumes ContentStream. It&apos;s not only tests. E.g. if you upload a file to DIH or you upload the CSV file via HTTP file upload (and not as part of the stream), you get a file stream.&lt;/p&gt;

&lt;p&gt;So please, just close the stream, costs nothing if its a no-op. It has nothing to do with tests vs. production! In case of a ContentStream, YOU DO NOT KNOW WHAT TYPE OF INPUT STREAM YOU HAVE BEHIND THE ABSTRACT INTERFACE. It can be anything, so it has to be closed. In the case of HttpRequestContentStream it&apos;s a no-op, but consuming code does not need to know this.&lt;/p&gt;</comment>
                            <comment id="16465254" author="thetaphi" created="Sun, 6 May 2018 19:08:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Whether Jetty closed the socket or not, we can&apos;t have anyone close these stream because we have to make sure they are fully consumed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree that&apos;s fine as workaround for the &quot;jetty bug&quot; (it might be one or now, I don&apos;t want to argue about it - I&apos;m not Robert). I can just say: Tomcat fully consumes the stream automatically if a consumer closes it.&lt;/p&gt;

&lt;p&gt;My complaint was only: If we have a perfect stream handling inside SolrDispatchFilter that handles the stream consuming and prevents closing of underlying ServletOutputStream, the code down the line can handle the input like a normal stream. And so goes for ContentStreams, which are an abstract interface. Here I will behave like &quot;Robert&quot; and cry for revert if you do not revert the broken code!&lt;/p&gt;</comment>
                            <comment id="16465255" author="thetaphi" created="Sun, 6 May 2018 19:09:55 +0000"  >&lt;p&gt;As you are not willing to fix this, should I send you the patch based on your current commit?&lt;/p&gt;</comment>
                            <comment id="16465267" author="jira-bot" created="Sun, 6 May 2018 19:33:59 +0000"  >&lt;p&gt;Commit 5fc725154001c6283315802e1a2193d51d00f9aa in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5fc7251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5fc7251&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;: We must close ContentStreams because we don&apos;t know the source of the inputstream - use a CloseShield to prevent tripping our close assert in SolrDispatchFilter.&lt;/p&gt;</comment>
                            <comment id="16465269" author="thetaphi" created="Sun, 6 May 2018 19:35:18 +0000"  >&lt;p&gt;Oh thanks, that was my patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16465271" author="markrmiller@gmail.com" created="Sun, 6 May 2018 19:36:06 +0000"  >&lt;p&gt;You definitely bring a nasty Lucene vibe into the Solr community sometimes. When did I say I wasn&apos;t willing to fix it? I said the fix was easy and I have to run tests. Cool down man.&lt;/p&gt;</comment>
                            <comment id="16465276" author="thetaphi" created="Sun, 6 May 2018 19:49:38 +0000"  >&lt;p&gt;Sorry, I am a bit worried today. It&apos;s too hot here and it was the yonly day where I fixed a serious security issue caused by me 5 years ago and was really annoyed about tests failing all day.&lt;/p&gt;

&lt;p&gt;You said &quot;there is no need to close streams if closing is a no-op&quot;. I still argue that this is the wrong way do do it. If stuff like Jetty needs special handling on closing, it should be done top-level. If downstream code gets a stream, it should do try-with-resources.&lt;/p&gt;

&lt;p&gt;I am happy with your code in SolrDispatchFilter and the wrapper around the ServletXxxStreams. But I don&apos;t think we should make users forcefully remove try-with-resources blocks (and cause a warning in Eclipse), just because some specific implementation of a stream needs special handling. So I&apos;d put all special case only in SolrDispatchFilter and whenever a user gets an input stream/outputstream further down the code it MUST close it. That&apos;s just a fact of good programming practise. A method gets a stream does something with it and closes it. Solr (especially in tests) is already full of missing closes, so we should not add more. And because of that I am heavily arguing. It was not against you, I was just bored about the sometimes horrible code quality of solr and its tests and a commit that made the code quality of some parts against all programming standards (streams have to be closed after usage). One reason that I try to avoid fixing bugs in Solr, unless they were caused by me or have something to do with XML handling (because that&apos;s one of my beloved parts of code - I love XML).&lt;/p&gt;

&lt;p&gt;I can confirm the tests now pass on Windows. So file leaks with uploaded files or other types of content streams are solved. Thanks, but I have a bad feeling now about one more horrible anti-feature of solr.&lt;/p&gt;</comment>
                            <comment id="16465277" author="markrmiller@gmail.com" created="Sun, 6 May 2018 19:50:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;Oh thanks, that was my patch &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Your welcome. If you insist on behaving like Robert, I&apos;m leaving Solr like I left Lucene. There is no reason for this garbage.&lt;/p&gt;</comment>
                            <comment id="16465280" author="thetaphi" created="Sun, 6 May 2018 19:54:00 +0000"  >&lt;p&gt;See my comment. But some things have to be said. Introducing bad programming practises, just because of a special case or bug in some component (Jetty) is not a good idea. I stop talking here, all is said.&lt;/p&gt;</comment>
                            <comment id="16465331" author="dsmiley" created="Mon, 7 May 2018 00:59:41 +0000"  >&lt;p&gt;Last commit to partially revert looks good to me. &#160;I agree with Uwe&apos;s sentiment about standard coding practices &#8211; if you obtain the stream, close the stream. &#160;I should have thought of this earlier in my review.&lt;/p&gt;</comment>
                            <comment id="16465334" author="markrmiller@gmail.com" created="Mon, 7 May 2018 01:12:37 +0000"  >&lt;p&gt;This wasn&apos;t about coding practices - it&apos;s simply about the ContentStream API. It can return a stream from any source and so streams that come from that API must be closed. We are still still not closing servlet streams where we don&apos;t have to. In some cases we have because the user of the API can&apos;t discern where the stream came from. This wasn&apos;t a coding practice issue, it was a bug.&lt;/p&gt;</comment>
                            <comment id="16465335" author="markrmiller@gmail.com" created="Mon, 7 May 2018 01:15:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;See my comment. But some things have to be said. Introducing bad programming practises, just because of a special case or bug in some component (Jetty) is not a good idea. I stop talking here, all is said.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We didn&apos;t introduce bad coding practices and your opinion on how Jetty handles this has little to do with it. The original patch didn&apos;t handle ContentStream stuff right when working around assert errors. You are supposed to point out bugs. Being an impatient jerk is an unnecessary part of the process.&lt;/p&gt;</comment>
                            <comment id="16465342" author="markrmiller@gmail.com" created="Mon, 7 May 2018 01:33:20 +0000"  >&lt;p&gt;I&apos;m not going to backport this to 7x, I&apos;ve had enough silliness on this issue. If anyone actually understood it, this wouldn&apos;t have turned into a bunch of silly statements and threats.&lt;/p&gt;</comment>
                            <comment id="16465479" author="thetaphi" created="Mon, 7 May 2018 06:21:15 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
I can backport this if needed. I&apos;d just like to have a second iteration on it. I am not really happy with the stuff (especially when handling gzip responses). &lt;/p&gt;

&lt;p&gt;I understand the issues here, I just wanted to have an easier way to consume the Solr Request where everything is handled in SolrRequestParsers and SolrDispatchFilter. The downstream code should just not need to think about (&quot;do I need to close or not?). The code should always use try-with-resources and any stuff that was not yet read from the underlying servlet stream should be consumed before SolrDispatchFilter gives control back to the Jetty container. I am out of office this week, so I will for sure look into it next weekend.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We are still still not closing servlet streams where we don&apos;t have to. In some cases we have because the user of the API can&apos;t discern where the stream came from. This wasn&apos;t a coding practice issue, it was a bug. &amp;#8211; Being an impatient jerk is an unnecessary part of the process.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry for being impatient jerk! It was also missing communication. I asked for a revert initially, because the issue was a file handle leak. This was my first comment. It was just a normal request, not even a veto: I was asking for revert so we can have a look a second time. I was not really following this issue last week, because we were moving offices and so on, maybe I should have looked earlier. &lt;/p&gt;

&lt;p&gt;I then looked into your patch and was understanding and seeing the issue. I was totally fine with keeping the ServletInputStream open, but the bug in the ContentHandler code looked like bad coding practise, because it removed necessary try-with-resources. I brought that up on the issue, but the reaction was - as far as I understand it - something like: &quot;no we don&apos;t need to close streams so I refuse to add CloseShield&quot;. This was the misunderstanding (you talked about the servlet stream, I talked about ContentStreams). And then I proposed to add a patch. While doing this you committed almost the same code that I hacked together (I reverted about 3 or 4 files and added the CloseShield). The &quot;This was my patch&quot; was just a confirmation: All fine! Sorry if you have thought it was sarcastic.&lt;/p&gt;

&lt;p&gt;In some cases I am a bit like Robert, especially if it is around closing stuff and file leaks. I try to write code in a way that the downstream code is forced to always write &quot;correct code&quot; (means closing everything with try-with-resources) and we should work around bugs like Jetty&apos;s at the source of the problem without touching any other code. IMHO, the asserts in test code are not really needed. Just shield the ServletInputStream from being closed in SolrDispatchFilter and if the downstream code calls close and it is not yet fully consumed, just copy the remaining content to Java&apos;s &quot;/dev/null&quot; with IOUtils.&lt;/p&gt;</comment>
                            <comment id="16472902" author="jira-bot" created="Sat, 12 May 2018 04:33:27 +0000"  >&lt;p&gt;Commit 4c09a13afb441bdce1c440263ea61cdb5f10b141 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4c09a13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4c09a13&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;: Update assert messages about closing request / response streams.&lt;/p&gt;</comment>
                            <comment id="16472912" author="jira-bot" created="Sat, 12 May 2018 05:15:24 +0000"  >&lt;p&gt;Commit ab58b7f9ba646a294005f1e433e4faee43c7d22b in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ab58b7f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ab58b7f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;: Update assert messages about closing request / response streams.&lt;/p&gt;</comment>
                            <comment id="16492883" author="varunthacker" created="Mon, 28 May 2018 18:42:41 +0000"  >&lt;p&gt;Hi Mark,&lt;/p&gt;

&lt;p&gt;Is it okay if we backport this to branch_7x&#160; ?&lt;/p&gt;

&lt;p&gt;The motivation being that you mentioned on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1881&quot; title=&quot;SearchHandler prevents HTTPS distributed search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1881&quot;&gt;&lt;del&gt;SOLR-1881&lt;/del&gt;&lt;/a&gt; ( &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11881?focusedCommentId=16458322&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16458322&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-11881?focusedCommentId=16458322&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16458322&lt;/a&gt;&#160;) that this could be one of the underlying reasons for the Jetty exception.&#160;&lt;/p&gt;</comment>
                            <comment id="16492948" author="markrmiller@gmail.com" created="Mon, 28 May 2018 22:46:26 +0000"  >&lt;p&gt;Yeah, feel free - the reason I&#8217;m not very concerned is that the other issue I did around around the same time that gives updates and only updates their own connection pool should remove any issue this would prob help with.&#160;&lt;/p&gt;</comment>
                            <comment id="16492978" author="varunthacker" created="Tue, 29 May 2018 00:40:38 +0000"  >&lt;p&gt;Sounds good! Here&apos;s a patch which&#160;squashes all the 4 commits into one. I&apos;ll run tests and precommit before pushing this&lt;/p&gt;</comment>
                            <comment id="16493988" author="jira-bot" created="Tue, 29 May 2018 18:10:52 +0000"  >&lt;p&gt;Commit 62de5c099476c958229aafe19c3b266fdfec10eb in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mark.miller%40oblivion.ch&quot; class=&quot;user-hover&quot; rel=&quot;mark.miller@oblivion.ch&quot;&gt;mark.miller@oblivion.ch&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=62de5c0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=62de5c0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;: Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&lt;/p&gt;

&lt;p&gt;(cherry picked commit 2962010 + 5fc7251 + 4c09a13 + ab58b7f)&lt;/p&gt;</comment>
                            <comment id="16494006" author="varunthacker" created="Tue, 29 May 2018 18:22:56 +0000"  >&lt;p&gt;Hi Mark,&lt;/p&gt;

&lt;p&gt;I committed it and looks like the author tag was also retained . So the commit technically looks like it&apos;s come from you .&lt;/p&gt;

&lt;p&gt;In master , the CHANGES entry is already under 7.4 so nothing to do there.&#160;&lt;/p&gt;</comment>
                            <comment id="16498738" author="janhoy" created="Sat, 2 Jun 2018 00:04:59 +0000"  >&lt;p&gt;This commit causes incomplete response, see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12391&quot; title=&quot;Core selector dropdown missing in Admin UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12391&quot;&gt;&lt;del&gt;SOLR-12391&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16498886" author="jira-bot" created="Sat, 2 Jun 2018 05:19:45 +0000"  >&lt;p&gt;Commit 1ff24bbb283a4cbfb9a6babfa702fbd57804a7fd in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1ff24bb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1ff24bb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12391&quot; title=&quot;Core selector dropdown missing in Admin UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12391&quot;&gt;&lt;del&gt;SOLR-12391&lt;/del&gt;&lt;/a&gt;: Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&lt;/p&gt;</comment>
                            <comment id="16498892" author="jira-bot" created="Sat, 2 Jun 2018 05:23:15 +0000"  >&lt;p&gt;Commit 88400a14716f163715eac82a35be90e6e3718208 in lucene-solr&apos;s branch refs/heads/branch_7x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=88400a1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=88400a1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12290&quot; title=&quot;Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12290&quot;&gt;&lt;del&gt;SOLR-12290&lt;/del&gt;&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12391&quot; title=&quot;Core selector dropdown missing in Admin UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12391&quot;&gt;&lt;del&gt;SOLR-12391&lt;/del&gt;&lt;/a&gt;: Do not close any servlet streams and improve our servlet stream closing prevention code for users and devs.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13161444">SOLR-12391</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13156115">SOLR-12293</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13121449">SOLR-11692</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12921199" name="SOLR-12290.patch" size="24001" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 23:28:34 +0000"/>
                            <attachment id="12921194" name="SOLR-12290.patch" size="18629" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 21:25:10 +0000"/>
                            <attachment id="12921191" name="SOLR-12290.patch" size="16307" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 20:52:07 +0000"/>
                            <attachment id="12921188" name="SOLR-12290.patch" size="13868" author="markrmiller@gmail.com" created="Sun, 29 Apr 2018 18:39:36 +0000"/>
                            <attachment id="12925480" name="SOLR-12290_7x.patch" size="19011" author="varun" created="Tue, 29 May 2018 00:39:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 24 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3t5lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>