<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:33:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12413] Solr ignores aliases.json from ZooKeeper at startup</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12413</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Since upgrading to 7.2.1, we ran into an issue where Solr ignores &lt;em&gt;aliases.json&lt;/em&gt; file stored in ZooKeeper.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Steps to reproduce the problem:&lt;/ins&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;SolrCloud cluster is down&lt;/li&gt;
	&lt;li&gt;Direct update of &lt;em&gt;aliases.json&lt;/em&gt; file in ZooKeeper with Solr ZkCLI &lt;b&gt;without using Collections API&lt;/b&gt; :
	&lt;ul&gt;
		&lt;li&gt;&lt;tt&gt;java ... org.apache.solr.cloud.ZkCLI -zkhost ... -cmd clear /aliases.json&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;&lt;tt&gt;java ... org.apache.solr.cloud.ZkCLI -zkhost ... -cmd put /aliases.json &quot;new content&quot;&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;SolrCloud cluster is started =&amp;gt; &lt;em&gt;aliases.json&lt;/em&gt; not taken into account&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Analysis:&lt;/ins&gt;&#160;&lt;/p&gt;

&lt;p&gt;Digging a bit in the code, what is actually causing the issue is that, when starting, Solr now checks for the metadata of the &lt;em&gt;aliases.json&lt;/em&gt; file and if the version metadata from ZooKeeper is lower or equal to local version, it keeps the local version.&lt;/p&gt;

&lt;p&gt;When it starts, Solr has a local version of 0 for the aliases but ZooKeeper also has a version of 0 of the file because we just recreated it. So Solr ignores ZooKeeper configuration and never has a chance to load aliases.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Relevant parts of Solr code are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/branch_7_2/solr/solrj/src/java/org/apache/solr/common/cloud/ZkStateReader.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/branch_7_2/solr/solrj/src/java/org/apache/solr/common/cloud/ZkStateReader.java&lt;/a&gt;&#160;: line 1562 : method setIfNewer&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
* Update the internal aliases reference with a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; one, provided that its ZK version has increased.
*
* @param newAliases the potentially newer version of Aliases
*/
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; setIfNewer(Aliases newAliases) {
&#160; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
  &#160; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; cmp = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.compare(aliases.getZNodeVersion(), newAliases.getZNodeVersion());
 &#160;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cmp &amp;lt; 0) {
     &#160;LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Aliases: cmp={}, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; definition is: {}&quot;&lt;/span&gt;, cmp, newAliases);
    &#160; aliases = newAliases;
   &#160;  &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.notifyAll();
  &#160;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
 &#160;  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
   &#160;  LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Aliases: cmp={}, not overwriting ZK version.&quot;&lt;/span&gt;, cmp);
  &#160;   &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; cmp != 0 || Arrays.equals(aliases.toJSON(), newAliases.toJSON()) : aliases + &lt;span class=&quot;code-quote&quot;&gt;&quot; != &quot;&lt;/span&gt; + newAliases;
 &#160;  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&#160;   }
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/branch_7_2/solr/solrj/src/java/org/apache/solr/common/cloud/Aliases.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/branch_7_2/solr/solrj/src/java/org/apache/solr/common/cloud/Aliases.java&lt;/a&gt;&#160;: line 45 : the &quot;empty&quot; Aliases object with default version 0&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
* An empty, minimal Aliases primarily used to support the non-cloud solr use cases. Not normally useful
* in cloud situations where the version of the node needs to be tracked even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; all aliases are removed.
* A version of 0 is provided rather than -1 to minimize the possibility that &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is used in a cloud
* instance data is written without version checking.
*/
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Aliases EMPTY = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Aliases(Collections.emptyMap(), Collections.emptyMap(), 0);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note that a&#160;workaround is to force ZooKeeper to always have a version greater than 0 for &lt;em&gt;aliases.json&lt;/em&gt; file (for instance by not clearing the file and just overwriting it again and again).&lt;/p&gt;</description>
                <environment>&lt;p&gt;A&#160;SolrCloud cluster with ZooKeeper (one node is enough to reproduce).&lt;/p&gt;

&lt;p&gt;Solr 7.2.1.&lt;/p&gt;

&lt;p&gt;ZooKeeper 3.4.6.&lt;/p&gt;</environment>
        <key id="13162507">SOLR-12413</key>
            <summary>Solr ignores aliases.json from ZooKeeper at startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="gjourdan">Ga&#235;l Jourdan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 May 2018 07:39:16 +0000</created>
                <updated>Mon, 7 Apr 2025 19:02:04 +0000</updated>
                            <resolved>Thu, 21 Jun 2018 18:03:46 +0000</resolved>
                                    <version>7.2.1</version>
                                    <fixVersion>7.5</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16494432" author="elyograg" created="Tue, 29 May 2018 23:06:03 +0000"  >&lt;p&gt;At initial startup, we not be looking at the version in zookeeper.  There&apos;s nothing to compare it to, so it should ALWAYS be read and loaded.  That shouldn&apos;t be controversial.&lt;/p&gt;

&lt;p&gt;If collection reloads work in a manner similar to core reloads (where the SolrCore object is built from scratch just like at startup core creation and then replaces the old one), then collection reload should also ignore versions in ZK for things that pertain specifically to that collection.  If a collection reload is more dynamic than a core reload, then that might not be the best option.&lt;/p&gt;

&lt;p&gt;But in general, I don&apos;t think it&apos;s unreasonable to require a full Solr restart for situation where a central config file has been manually deleted and then re-uploaded.  We do need to fix the bug noticed here so that the restart actually works.  Thank you for bringing this to our attention!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gjourdan&quot; class=&quot;user-hover&quot; rel=&quot;gjourdan&quot;&gt;gjourdan&lt;/a&gt;, the workaround is to make changes to your aliases with the Collections API.  If you do it that way, you don&apos;t need to restart Solr or reload anything.  Changes will take effect immediately.  If the reason you are making changes with a replacement file is because we are missing functionality in the Collections API that you require, please discuss it on the mailing list or IRC channel so we can determine whether a feature request is needed.&lt;/p&gt;</comment>
                            <comment id="16494436" author="wunder" created="Tue, 29 May 2018 23:12:09 +0000"  >&lt;p&gt;We upload configuration files to zookeeper, then use a RELOAD command to the collections API. We don&apos;t use aliases.&lt;/p&gt;

&lt;p&gt;We keep the files under version control, so loading them to zookeeper works for us.&lt;/p&gt;</comment>
                            <comment id="16494856" author="gjourdan" created="Wed, 30 May 2018 08:10:16 +0000"  >&lt;p&gt;Thanks for your feedback that this is a real issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt;, you&apos;re right, using Collections API&#160;would work. I did not mention it but actually this problem occurs on a Solr cluster which is shutdown most of the time because it&apos;s a backup cluster and we only start it in some emergency cases. This is why we don&apos;t use Collections API.&lt;/p&gt;</comment>
                            <comment id="16511457" author="dsmiley" created="Wed, 13 Jun 2018 17:30:16 +0000"  >&lt;p&gt;Perhaps the solution is as simple as setting Aliases.EMPTY&apos;s zkNodeVersion to -1?&lt;/p&gt;</comment>
                            <comment id="16511589" author="gjourdan" created="Wed, 13 Jun 2018 19:45:57 +0000"  >&lt;p&gt;Yes, I think it solves the issue.&lt;/p&gt;

&lt;p&gt;But the comment states that &lt;em&gt;&quot;a version of 0 is provided rather than -1 to minimize the possibility that if this is used in a cloud instance data is written without version checking&quot;&lt;/em&gt;, so I&apos;m wondering if we are missing something ?&lt;/p&gt;</comment>
                            <comment id="16517072" author="dsmiley" created="Tue, 19 Jun 2018 13:31:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gus_heck&quot; class=&quot;user-hover&quot; rel=&quot;gus_heck&quot;&gt;gus_heck&lt;/a&gt; I think you wrote that comment. &#160;Admittedly I don&apos;t understand it. &#160;FWIW I changed it to -1 locally and ran AliasIntegrationTest which passed.&lt;/p&gt;</comment>
                            <comment id="16517442" author="gus_heck" created="Tue, 19 Jun 2018 19:23:49 +0000"  >&lt;p&gt;The concern with that comment is that for keeper.setData() a version of -1 means don&apos;t check the version:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
* Set the data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the node of the given path &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; such a node exists and the
* given version matches the version of the node (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the given version is
* -1, it matches any node&apos;s versions). Return the stat of the node.
* &amp;lt;p&amp;gt;
* This operation, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; successful, will trigger all the watches on the node
* of the given path left by getData calls.
* &amp;lt;p&amp;gt;
* A KeeperException with error code KeeperException.NoNode will be thrown
* &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no node with the given path exists.
* &amp;lt;p&amp;gt;
* A KeeperException with error code KeeperException.BadVersion will be
* thrown &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the given version does not match the node&apos;s version.
* &amp;lt;p&amp;gt;
* The maximum allowable size of the data array is 1 MB (1,048,576 bytes).
* Arrays larger than &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will cause a KeeperException to be thrown.
*
* @param path
* the path of the node
* @param data
* the data to set
* @param version
* the expected matching version
* @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the state of the node
* @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException If the server transaction is interrupted.
* @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; KeeperException If the server signals an error with a non-zero error code.
* @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IllegalArgumentException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an invalid path is specified
*/
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Stat setData(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; data[], &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; version)
&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; KeeperException, InterruptedException
{

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16517447" author="gus_heck" created="Tue, 19 Jun 2018 19:36:03 +0000"  >&lt;p&gt;Haven&apos;t entirely thought it through, but maybe what we want is to change setIfNewer(alias) to setIfNewerOrZeroVersion(alias), thus our inital zero version that was never loaded from ZK anyway disappears in the face of any actual data from zk?&lt;/p&gt;</comment>
                            <comment id="16517474" author="gus_heck" created="Tue, 19 Jun 2018 20:08:33 +0000"  >&lt;p&gt;Running tests for a patch along those lines. AliasIntegrationTest wasn&apos;t bothered in my ide FWIW, I think we want to cause an immediate version bump when we see zero too.&lt;/p&gt;</comment>
                            <comment id="16517541" author="gus_heck" created="Tue, 19 Jun 2018 20:59:29 +0000"  >&lt;p&gt;Pull request added&lt;/p&gt;</comment>
                            <comment id="16518599" author="dsmiley" created="Wed, 20 Jun 2018 21:06:39 +0000"  >&lt;p&gt;Here&apos;s a test, intended to be added to AliasIntegrationTest&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPreExistingAliases() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = Aliases.EMPTY.cloneWithCollectionAlias(&lt;span class=&quot;code-quote&quot;&gt;&quot;alias1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;collection1&quot;&lt;/span&gt;).toJSON();
    cluster.getZkClient().delete(ZkStateReader.ALIASES, -1, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    cluster.getZkClient().create(ZkStateReader.ALIASES, bytes, CreateMode.PERSISTENT, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    Stat stat = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Stat();
    cluster.getZkClient().getData(ZkStateReader.ALIASES, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, stat, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    assertEquals(0, stat.getVersion());

    &lt;span class=&quot;code-comment&quot;&gt;// get a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; solrClient instead of the one created before our manual ZK manipulation.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (SolrClient solrClient = getCloudSolrClient(cluster)) {
      &lt;span class=&quot;code-comment&quot;&gt;// put a basic alias1-&amp;gt;collection1 alias mapping into ZK manually ensuring the zk version is 0
&lt;/span&gt;      CollectionAdminRequest.createCollection(&lt;span class=&quot;code-quote&quot;&gt;&quot;collection1&quot;&lt;/span&gt;, 1, 1).process(cluster.getSolrClient());
      solrClient.query(&lt;span class=&quot;code-quote&quot;&gt;&quot;alias1&quot;&lt;/span&gt;, params(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;));&lt;span class=&quot;code-comment&quot;&gt;//does not &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt;; it should resolve
&lt;/span&gt;    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16518798" author="gus_heck" created="Thu, 21 Jun 2018 01:57:52 +0000"  >&lt;p&gt;I did test this manually by&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;creating a 4 node cluster,&lt;/li&gt;
	&lt;li&gt;copying the aliases.json to a file,&lt;/li&gt;
	&lt;li&gt;modifying it to add an alias,&lt;/li&gt;
	&lt;li&gt;bringing the&#160;cluster down,&lt;/li&gt;
	&lt;li&gt;deleting aliases.json from zk,&lt;/li&gt;
	&lt;li&gt;uploading the edited version to zk&lt;/li&gt;
	&lt;li&gt;restarting the cluster...&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;At which time I observed the change in the UI and successfully queried the alias....&#160;&lt;/p&gt;

&lt;p&gt;That test you supplied doesn&apos;t seem to work for me with or without the patch... the deletion of aliases.json appears to blow up the cluster almost immediately... the delete triggers the watch and leads to:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
22756 ERROR (zkCallback-21-thread-1) [ ] o.a.s.c.c.ZkStateReader$AliasesManager A ZK error has occurred
org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /aliases.json
at org.apache.zookeeper.KeeperException.create(KeeperException.java:114) ~[zookeeper-3.4.11.jar:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]
at org.apache.zookeeper.KeeperException.create(KeeperException.java:54) ~[zookeeper-3.4.11.jar:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]
at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1215) ~[zookeeper-3.4.11.jar:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]
at org.apache.solr.common.cloud.SolrZkClient.lambda$getData$5(SolrZkClient.java:341) ~[java/:?]
at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:60) ~[java/:?]
at org.apache.solr.common.cloud.SolrZkClient.getData(SolrZkClient.java:341) ~[java/:?]
at org.apache.solr.common.cloud.ZkStateReader$AliasesManager.process(ZkStateReader.java:1781) ~[java/:?]
at org.apache.solr.common.cloud.SolrZkClient$1.lambda$process$1(SolrZkClient.java:270) ~[java/:?]
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[?:1.8.0_144]
at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[?:1.8.0_144]
at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:209) ~[java/:?]
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [?:1.8.0_144]
22756 ERROR (zkCallback-28-thread-1) [ ] o.a.s.c.c.ZkStateReader$AliasesManager A ZK error has occurred
org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /aliases.json
at org.apache.zookeeper.KeeperException.create(KeeperException.java:114) ~[zookeeper-3.4.11.jar:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]
at org.apache.zookeeper.KeeperException.create(KeeperException.java:54) ~[zookeeper-3.4.11.jar:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]
at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1215) ~[zookeeper-3.4.11.jar:3.4.11-37e277162d567b55a07d1755f0b31c32e93c01a0]
at org.apache.solr.common.cloud.SolrZkClient.lambda$getData$5(SolrZkClient.java:341) ~[java/:?]
at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:60) ~[java/:?]
at org.apache.solr.common.cloud.SolrZkClient.getData(SolrZkClient.java:341) ~[java/:?]
at org.apache.solr.common.cloud.ZkStateReader$AliasesManager.process(ZkStateReader.java:1781) ~[java/:?]
at org.apache.solr.common.cloud.SolrZkClient$1.lambda$process$1(SolrZkClient.java:270) ~[java/:?]
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[?:1.8.0_144]
at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[?:1.8.0_144]
at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:209) ~[java/:?]
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [?:1.8.0_144]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;followed by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; request:[http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:33023/solr/alias1]
&lt;/span&gt;
at __randomizedtesting.SeedInfo.seed([3A63ED446F3BE85D:C178AC5AAC5AF704]:0)
at org.apache.solr.client.solrj.impl.LBHttpSolrClient.request(LBHttpSolrClient.java:462)
at org.apache.solr.client.solrj.impl.CloudSolrClient.sendRequest(CloudSolrClient.java:1106)
at org.apache.solr.client.solrj.impl.CloudSolrClient.requestWithRetryOnStaleState(CloudSolrClient.java:886)
at org.apache.solr.client.solrj.impl.CloudSolrClient.request(CloudSolrClient.java:819)
at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:194)
at org.apache.solr.client.solrj.SolrClient.query(SolrClient.java:942)
at org.apache.solr.cloud.AliasIntegrationTest.testPreExistingAliases(AliasIntegrationTest.java:105)
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.lang.reflect.Method.invoke(Method.java:498)
at com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1737)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All tests running after it fail, so the test cluster is just hosed at that point (not dying a&#160;horribly when we can&apos;t find the aliases.json might be a nice enhancement/bugfix, but&#160;one could also argue that if one goes deleting critical files during running,&#160;that&apos;s not ever a supported use case&#160;).&lt;/p&gt;

&lt;p&gt;AFAIK there&apos;s also no way in zookeeper to manually set the version back to zero (this is understandable).&lt;/p&gt;

&lt;p&gt;I don&apos;t think this particular&#160;fix is unit testable unless we find a way to bring up a truly independent cloud&#160;server with an independent zookeeper&#160;instance. Then we might&#160;have the ability to stop&#160;solr without stopping zookeeper.&#160;&lt;/p&gt;</comment>
                            <comment id="16518891" author="dsmiley" created="Thu, 21 Jun 2018 04:12:10 +0000"  >&lt;p&gt;Good catch on identifying why my proposed test was fundamentally flawed; I wasn&apos;t quite sure yet.  I can also see that it&apos;s probably impossible to do a unit test for this.&lt;/p&gt;

&lt;p&gt;Attached is a &quot;nocommit&quot; patch that hacks ZkController.createClusterZkNodes to ensure that the default aliases.json has &quot;alias1&quot; pointing to &quot;collection1&quot;.  And it has a shortened version of the flawed test that merely tries to see if querying &quot;alias1&quot; from the get-go works.  I wanted to see if Aliases.EMPTY with a zkNodeVersion of -1 works.  Note the additional asserts as well.  The rationale for why I think this works is because the first aliases operation to occur is update() which sets ZkStateReader.AliasesManager.aliases to be whatever zookeeper has, which will be a good zk version (not -1).  applyModificationAndExportToZk will only ever be called &lt;em&gt;after&lt;/em&gt; this point, at which we never see the &apos;-1&apos; again.  This isn&apos;t all to say your patch doesn&apos;t also solve the problem but if we agree this &quot;-1&quot; solution works too then it&apos;s way simpler. (no additional lines of code except some assertions)&lt;/p&gt;</comment>
                            <comment id="16518949" author="gus_heck" created="Thu, 21 Jun 2018 06:00:32 +0000"  >&lt;p&gt;I had&#160;previously figured out that the &#160;&quot;-1 value for version&quot; works for the reason you give, but that solution subtly ties this&#160;in code magic number to the current correct order of operations. If at any time the code saves without updating first (that would be a bug, but&#160;probably a race condition type of bug that might not show up immediately) we&#160;wind up&#160;overwriting the existing aliases.json with a blank one. By using 0 which is a valid version number and handling it as a special case with an automatic increment to version 1 we are guaranteed to never overwrite a long standing aliases.json node. The only case where we can get in trouble due to order of operations is this much narrower case for a&#160;aliases.json node that has just recently been replaced manually while solr was offline. I also like that it&#160;doesn&apos;t muddle&#160;the meaning of a -1 value for a version.&lt;/p&gt;

&lt;p&gt;So I feel like&#160;the patch I supplied is more robust if a bit more complicated. Also the significance is clearer reading the code I think. If these reasons are unconvincing, I can go with&#160;smaller&#160;fix based on a -1 value for version&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16519375" author="dsmiley" created="Thu, 21 Jun 2018 13:42:23 +0000"  >&lt;p&gt;Here&apos;s a new patch (committable) that includes a check at the start of applyModificationAndExportToZk to call update() if the current aliases zk version is -1.  This should never happen but if it does it&apos;s at least safe.  I think the use of -1 is Aliases.EMPTY is more correct than 0.  0 is a valid zk version, and thus could be confused with a genuine zk state.&lt;/p&gt;</comment>
                            <comment id="16519649" author="dsmiley" created="Thu, 21 Jun 2018 18:03:46 +0000"  >&lt;p&gt;Thanks&#160;Ga&#235;l Jourdan for a thorough analysis / bug-report, and Gus for your initial patch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;a=commit;h=7c28d5797387fdf68379ec66f0de3c62e6a079ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;a=commit;h=7c28d5797387fdf68379ec66f0de3c62e6a079ca&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12928562" name="SOLR-12413-nocommit.patch" size="9284" author="dsmiley" created="Thu, 21 Jun 2018 04:01:31 +0000"/>
                            <attachment id="12928631" name="SOLR-12413.patch" size="3725" author="dsmiley" created="Thu, 21 Jun 2018 13:37:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3u8vr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>