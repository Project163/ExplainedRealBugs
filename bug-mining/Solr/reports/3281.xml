<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:20:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10226] JMX metric avgTimePerRequest broken</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10226</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;JMX Metric avgTimePerRequest (of org.apache.solr.handler.component.SearchHandler) doesn&apos;t appear to behave correctly anymore. It was a cumulative value in pre-6.4 versions. Since totalTime metric was removed (which was a base for monitoring calculations), avgTimePerRequest seems like possible alternative to calculate &quot;time spent in requests since last measurement&quot;, but it behaves strangely after 6.4.&lt;/p&gt;

&lt;p&gt;I did a simple test on gettingstarted collection (just unpacked the Solr 6.4.1 version and started it with &quot;bin/solr start -e cloud -noprompt&quot;). The query I used was:&lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/gettingstarted/select?indent=on&amp;amp;q=*:*&amp;amp;wt=json&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/gettingstarted/select?indent=on&amp;amp;q=*:*&amp;amp;wt=json&lt;/a&gt;&lt;br/&gt;
I run it 30 times in a row (with approx 1 sec between executions).&lt;/p&gt;

&lt;p&gt;At the same time I was looking (with jconsole) at bean solr/gettingstarted_shard2_replica2:type=/select,id=org.apache.solr.handler.component.SearchHandler&lt;/p&gt;

&lt;p&gt;Here is how metric was changing over time (first number is &quot;requests&quot; metric, second number is &quot;avgTimePerRequest&quot;):&lt;br/&gt;
10   6.6033&lt;br/&gt;
12   5.9557&lt;br/&gt;
13   0.9015    ---&amp;gt; 13th req would need negative duration if this was cumulative&lt;br/&gt;
15   6.7315&lt;br/&gt;
16   7.4873&lt;br/&gt;
17   0.8458    ---&amp;gt; same case with 17th request&lt;br/&gt;
23   6.1076&lt;/p&gt;

&lt;p&gt;At the same time bean solr/gettingstarted_shard1_replica2:type=/select,id=org.apache.solr.handler.component.SearchHandler  also showed strange values:&lt;br/&gt;
6    5.13482&lt;br/&gt;
8    10.5694&lt;br/&gt;
9    0.504&lt;br/&gt;
10  0.344&lt;br/&gt;
12  8.8121&lt;br/&gt;
18  3.3531&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13048120">SOLR-10226</key>
            <summary>JMX metric avgTimePerRequest broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="bosmid">Bojan Smid</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Mar 2017 17:31:30 +0000</created>
                <updated>Sat, 8 Jun 2019 15:30:00 +0000</updated>
                            <resolved>Tue, 7 Mar 2017 17:10:53 +0000</resolved>
                                    <version>6.4.1</version>
                                    <fixVersion>6.5</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15894980" author="ab" created="Fri, 3 Mar 2017 20:30:34 +0000"  >&lt;p&gt;At what intervals did you check these numbers? Previous versions of Solr used a very old version of the code, which supposedly used a similar exponentially decaying sampling (with a strong bias towards the most recent 5 min window). The new code uses an exponentially decaying reservoir sampling with the same bias so theoretically results should be the same...&lt;/p&gt;

&lt;p&gt;So, both in the new and in the old code these values would be exponentially decaying over time, so if you don&apos;t make any requests for a while the rates will fall down.&lt;/p&gt;

&lt;p&gt;If you could please capture the timestamps at which you made the requests and observations it would be very helpful - thank you!&lt;/p&gt;</comment>
                            <comment id="15895573" author="bosmid" created="Sat, 4 Mar 2017 07:53:15 +0000"  >&lt;p&gt;I think avgTimePerRequest in previous versions didn&apos;t have decay/sampling applied on it. I am looking at one Solr 6.3 node which was up for the past 2 months (I checked few other setups, different Solr version, but saw the same behavior). Here are the stats from its standard handler:&lt;br/&gt;
requests:1791464&lt;br/&gt;
totalTime:564718.746333&lt;br/&gt;
avgTimePerRequest:0.3152275157820643&lt;/p&gt;

&lt;p&gt;Both requests and totalTime metrics are cumulative and avgTimePerRequest shows exactly value totalTime/requests, therefore there was no decay/sampling applied in calculation of avgTime before 6.4.&lt;/p&gt;


&lt;p&gt;When it comes to previously posted sample, there was something like 30-60 sec or so between the requests (the time I needed to write down the numbers). I just did another test, fresh values (this time just 3-5 sec between the requests):&lt;br/&gt;
1  85.3&lt;br/&gt;
2  41.2&lt;br/&gt;
3  26.1&lt;br/&gt;
4 17.0&lt;br/&gt;
6 11.08&lt;br/&gt;
7 7.43&lt;br/&gt;
8 4.98&lt;br/&gt;
9 3.62&lt;br/&gt;
11 3.28&lt;br/&gt;
(few min pause)&lt;br/&gt;
13 8.12&lt;br/&gt;
14 3.33&lt;br/&gt;
(few min pause)&lt;br/&gt;
15 9.69&lt;br/&gt;
16 4.09&lt;/p&gt;

&lt;p&gt;Does decay/sampling explain the behavior even with these short periods between the requests (ranging from few sec to few min)?&lt;/p&gt;</comment>
                            <comment id="15897649" author="ab" created="Mon, 6 Mar 2017 17:01:24 +0000"  >&lt;p&gt;You&apos;re right - the &lt;tt&gt;Timer&lt;/tt&gt; implementation that was used in Solr 6.3 and earlier internally used &lt;tt&gt;Histogram&lt;/tt&gt;, which did not apply decaying to the total accumulated value. When we upgraded this class to a newer version from Codahale Metrics the underlying new implementation of &lt;tt&gt;Histogram&lt;/tt&gt; does apply decaying to this value...&lt;/p&gt;

&lt;p&gt;Anyway, we have to add back a simple counter to track the total value as &quot;totalTime&quot;, which somehow disappeared for no good reason. From that you will be able again to calculate the non-decaying average time.&lt;/p&gt;

&lt;p&gt;The question is what to do with avgTimePerRequest. In my opinion, moving forward we should keep the decaying avgTimePerRequest because it more correctly represents the recent state of the system as opposed to the cumulative non-decayed value, which doesn&apos;t really reflect anything in particular (there could have been extended periods of idle time followed by recent high activity, and the value would be still low even though the recent load was high).&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=otis&quot; class=&quot;user-hover&quot; rel=&quot;otis&quot;&gt;otis&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15897664" author="ab" created="Mon, 6 Mar 2017 17:14:06 +0000"  >&lt;p&gt;Patch adding back non-decayed &quot;totalTime&quot;.&lt;/p&gt;</comment>
                            <comment id="15897711" author="bosmid" created="Mon, 6 Mar 2017 17:35:39 +0000"  >&lt;p&gt;Thanks for looking into this and patching it so quickly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;From what I see, &quot;totalTime&quot; was removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8785&quot; title=&quot;Use Metrics library for core metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8785&quot;&gt;&lt;del&gt;SOLR-8785&lt;/del&gt;&lt;/a&gt;. Having it back solves my problem (actually, any monitoring solution would need such cumulative total time). Re avgTimePerRequest - I agree with what you suggest, decayed value makes much more sense (non-decayed would only be useful as a hack to get to totalTime).&lt;/p&gt;
</comment>
                            <comment id="15897818" author="bosmid" created="Mon, 6 Mar 2017 18:48:54 +0000"  >&lt;p&gt;I tested the patch quickly, metric totalTime is now there, but there is one small problem - it is expressed in ns. To be backward compatible it should be in ms.&lt;/p&gt;</comment>
                            <comment id="15899432" author="ab" created="Tue, 7 Mar 2017 13:27:55 +0000"  >&lt;p&gt;Fixed totalTime conversion so that it&apos;s expressed in ms. If there are no objections I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="15899783" author="jira-bot" created="Tue, 7 Mar 2017 17:10:05 +0000"  >&lt;p&gt;Commit 2d51a42d3cae3eddc89f407cd3611fa2cd5d55d0 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2d51a42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2d51a42&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10226&quot; title=&quot;JMX metric avgTimePerRequest broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10226&quot;&gt;&lt;del&gt;SOLR-10226&lt;/del&gt;&lt;/a&gt; JMX metric avgTimePerRequest broken.&lt;/p&gt;</comment>
                            <comment id="15899784" author="jira-bot" created="Tue, 7 Mar 2017 17:10:35 +0000"  >&lt;p&gt;Commit 242ddfb148eda45347ff34d2b16958a835c340a5 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=242ddfb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=242ddfb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10226&quot; title=&quot;JMX metric avgTimePerRequest broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10226&quot;&gt;&lt;del&gt;SOLR-10226&lt;/del&gt;&lt;/a&gt; JMX metric avgTimePerRequest broken.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12856599" name="SOLR-10226.patch" size="2542" author="ab" created="Tue, 7 Mar 2017 13:27:55 +0000"/>
                            <attachment id="12856312" name="SOLR-10226.patch" size="1846" author="ab" created="Mon, 6 Mar 2017 17:14:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3axfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>