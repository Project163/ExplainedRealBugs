<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:23:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2748] autocommit commits too many times</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2748</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;autocommit seems to commit more frequently than configured.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12521822">SOLR-2748</key>
            <summary>autocommit commits too many times</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Sep 2011 21:20:39 +0000</created>
                <updated>Mon, 18 Jul 2016 16:00:28 +0000</updated>
                            <resolved>Mon, 18 Jul 2016 16:00:28 +0000</resolved>
                                                    <fixVersion>3.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13099598" author="yseeley@gmail.com" created="Wed, 7 Sep 2011 21:52:16 +0000"  >&lt;p&gt;So I think the culprit might be CommitTracker.run()&lt;br/&gt;
At the end (after doing the commit) it has this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-comment&quot;&gt;// check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; docs have been submitted since the commit started
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastAddedTime &amp;gt; started) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (docsUpperBound &amp;gt; 0 &amp;amp;&amp;amp; docsSinceCommit.get() &amp;gt; docsUpperBound) {
        pending = scheduler.schedule(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, 100, TimeUnit.MILLISECONDS);
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeUpperBound &amp;gt; 0) {
        pending = scheduler.schedule(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, timeUpperBound,
            TimeUnit.MILLISECONDS);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which seems to blindly schedule another commit (which should have already been scheduled?).  So now we have 2 commits scheduled for the next round, where there should have only been one.  It seems like those two commits now have the potential to turn into 4 for the next round, and so on.&lt;/p&gt;</comment>
                            <comment id="13099613" author="yseeley@gmail.com" created="Wed, 7 Sep 2011 22:13:07 +0000"  >&lt;p&gt;Hmmm, I&apos;m not quite understanding the logic of this class.&lt;br/&gt;
CommitTracker.didCommit() (which is called by DUH2 after a commit finishes) tries to cancel any pending scheduled operations and resets the doc counter to 0.  But that seems like a bug since documents may have been added during the commit, and a new commit may have been scheduled while the old commit was executing.  Of course we are going to lose track of that since run() sets pending to null.&lt;/p&gt;

&lt;p&gt;edit: and of course trying to cancel &quot;pending&quot; from the DUH2 like that is also another race condition... which &quot;pending&quot; will it cancel?  It could be the old or the new, depending on the thread timings.&lt;/p&gt;</comment>
                            <comment id="13099675" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 00:22:20 +0000"  >&lt;p&gt;Another interesting thing I ran into reviewing this code is that the CommitTracker.run() method is synchronized, and so is _scheduleCommitWithin(), meaning (I think) that a long running commit will block anything calling that method (and an autoCommit by time or an add with a commitWithin specified would qualify).&lt;/p&gt;

&lt;p&gt;edit: and I seem to recall some people reporting that adds were blocked until a new searcher was registered (but I could never reproduce it myself).  This is probably the root cause of those problems.&lt;/p&gt;</comment>
                            <comment id="13099704" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 01:58:44 +0000"  >&lt;p&gt;OK, here&apos;s a first cut at a patch trying to fix some of these issues.&lt;br/&gt;
AutoCommitTest.testSoftCommitMaxTime() is failing once in a while though... not sure what&apos;s up yet.&lt;/p&gt;</comment>
                            <comment id="13099712" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 02:33:01 +0000"  >&lt;p&gt;After adding a bunch of prints, I &lt;b&gt;think&lt;/b&gt; this is a test bug.&lt;br/&gt;
Just because a newSearcher callback has been issued (triggered) does &lt;b&gt;not&lt;/b&gt; mean that a new searcher has been registered yet.&lt;/p&gt;</comment>
                            <comment id="13099722" author="jasonrutherglen" created="Thu, 8 Sep 2011 02:59:01 +0000"  >&lt;p&gt;Seeing all of the bugs related to the Solr NRT code, I can&apos;t help but wonder why the 4.x version of the project needs to be backward compatible.  &lt;/p&gt;

&lt;p&gt;Also why it&apos;s not using IndexReaderWarmer which was ostensibly created precisely for Solr&apos;s usage (and, it&apos;s not used in Solr and never has been).&lt;/p&gt;</comment>
                            <comment id="13099726" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 03:08:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Seeing all of the bugs related to the Solr NRT code, I can&apos;t help but wonder why the 4.x version of the project needs to be backward compatible.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s not really related to NRT since the autoCommit (CommitTracker) code has been around for a very long time (way before NRT).&lt;/p&gt;
</comment>
                            <comment id="13099790" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 04:26:32 +0000"  >&lt;p&gt;Found another race in AutoCommitTest that was causing a failure... the autoCommitCount is incremented &lt;b&gt;after&lt;/b&gt; the commit returns, so depending on thread scheduling, the test can be triggered to continue after the commit, but before autoCommitCount is incremented.&lt;/p&gt;</comment>
                            <comment id="13100351" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 14:24:27 +0000"  >&lt;p&gt;OK, here&apos;s a patch (with still some extra loggong) that fixes some of the bugs in AutoCommitTest, and also moves up where autoCommitCount is incremented to before the commit happens.&lt;/p&gt;

&lt;p&gt;With this patch, things seem much better... but I still got 2 failures in AutoCommitTest out of 45 runs.  Next I plan to repeat some of my performance tests where I was seeing way too many commits for what was configured.&lt;/p&gt;

&lt;p&gt;Hoss also pointed out &quot;see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2565&quot; title=&quot;Prevent IW#close and cut over to IW#commit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2565&quot;&gt;&lt;del&gt;SOLR-2565&lt;/del&gt;&lt;/a&gt; and the HuperDuperAutoCommitTest for an in progress attempt at making it work better&quot;&lt;/p&gt;</comment>
                            <comment id="13100406" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 15:46:44 +0000"  >&lt;p&gt;My 10M doc performance testing now shows the correct number of commits.&lt;br/&gt;
I also tried turning on soft autocommits at 1 sec, and that also resulted in the correct number of soft commits being done.&lt;/p&gt;

&lt;p&gt;Oddly enough the autoCommit + softAutoCommit test ran in 2:35 sec, while the autoCommit only test ran in 3:33.&lt;br/&gt;
One explanation could be that DWPT doesn&apos;t necessarily seem optimal for older (non-SSD) drives (Erick reported seeing trunk as slower than 3x on his system with a spinning-magnets type drive), and the smaller segments avoided some of this.&lt;br/&gt;
The other explanation (and this one actually makes more sense to me) is that the CSV loader used is single-threaded.  Adding the first 1000 documents to a small segment is probably more efficient than adding the last 1000 to a larger segment.  Doing more soft commits means creating smaller segments and doing more work in background merging using other CPU cores (basically, it increased the parallelism).&lt;/p&gt;</comment>
                            <comment id="13100435" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 16:36:09 +0000"  >&lt;p&gt;I re-ran the 10M doc test with soft autocommit set to 10ms (obviously too low, but I just wanted to make sure that things didn&apos;t blow up).  Things went fine, no exceptions, etc, and it did manage to commit at a rate of 73 commits/sec while indexing.  Should be even higher if logging is turned off.&lt;/p&gt;</comment>
                            <comment id="13100556" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 18:39:14 +0000"  >&lt;p&gt;I&apos;ve been through a few hundred iterations of AutoCommitTest with no failures (with logging turned on).&lt;br/&gt;
I think it&apos;s time to clean up the debugging logs and commit!&lt;/p&gt;</comment>
                            <comment id="13100612" author="ryantxu" created="Thu, 8 Sep 2011 19:22:23 +0000"  >&lt;p&gt;Thanks for looking into this!  i vaguely recall stumbling through this with Mike Klaas 5 years ago!&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13100623" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 19:32:50 +0000"  >&lt;p&gt;committed.  will backport to 3x next.&lt;/p&gt;</comment>
                            <comment id="13122840" author="janhoy" created="Fri, 7 Oct 2011 14:44:36 +0000"  >&lt;p&gt;Needed to apply this for a client on 3.3, so here&apos;s the patch&lt;/p&gt;</comment>
                            <comment id="15382498" author="ctargett" created="Mon, 18 Jul 2016 16:00:28 +0000"  >&lt;p&gt;It appears this was fixed long, long ago but simply missed at the time. I see an entry in CHANGES.txt for 3.5, and there is this commit in the history: &lt;a href=&quot;https://git1-us-west.apache.org/repos/asf?p=lucene-solr.git;a=commit;h=013e2776b867cc7f087ec17207a2720f2806689e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git1-us-west.apache.org/repos/asf?p=lucene-solr.git;a=commit;h=013e2776b867cc7f087ec17207a2720f2806689e&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If it should still be open, my mistake, please reopen.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12493593" name="SOLR-2748.patch" size="11287" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 14:24:27 +0000"/>
                            <attachment id="12493537" name="SOLR-2748.patch" size="7279" author="yseeley@gmail.com" created="Thu, 8 Sep 2011 01:58:43 +0000"/>
                            <attachment id="12498167" name="SOLR-2748_solr33.patch" size="28438" author="janhoy" created="Fri, 7 Oct 2011 14:44:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>444</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03itr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18483</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>