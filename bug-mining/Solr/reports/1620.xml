<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:41:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4376] dih.last_index_time has bad Date.toString() format during first delta import</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4376</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;In:&lt;br/&gt;
org.apache.solr.handler.dataimport.DocBuilder#getVariableResolver&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&#160;
      &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Date EPOCH = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(0);

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (persistedProperties.get(LAST_INDEX_TIME) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; added to map
&lt;/span&gt;        indexerNamespace.put(LAST_INDEX_TIME, persistedProperties.get(LAST_INDEX_TIME));
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;  {
        &lt;span class=&quot;code-comment&quot;&gt;// Date added to map
&lt;/span&gt;        indexerNamespace.put(LAST_INDEX_TIME, EPOCH);
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;



&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When LAST_INDEX_TIME is found in the data-import.properties, the value in the map is a String.&lt;/li&gt;
	&lt;li&gt;When LAST_INDEX_TIME is not found, we use timestamp = 0, but the value is a Date&lt;/li&gt;
&lt;/ul&gt;







&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When using full-import it works fine because basically we don&apos;t need this LAST_INDEX_TIME.&lt;/li&gt;
	&lt;li&gt;When doing delta import after a full import it also works fine.&lt;/li&gt;
	&lt;li&gt;But when doing a first delta import on a clean configuration, without any data-import.properties present, I have an SQL exception because of this query:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; xxx 
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; BATCH_JOB_EXECUTION yyy 
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; last_updated &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;Thu Jan 01 01:00:00 CET 1970&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;While normally the query is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; xxx 
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; BATCH_JOB_EXECUTION yyy 
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; last_updated &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;1970-01-01 01:00:00&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For a configured query being:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;deltaQuery=&quot;&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; bje.job_execution_id &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; JOB_EXECUTION_ID
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; BATCH_JOB_EXECUTION bje
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; last_updated &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;${dih.last_index_time}&apos;&lt;/span&gt;&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;



&lt;p&gt;I think in any case, the value associated to the key in the map must be consistent and either be String or Date, but not both. &lt;/p&gt;

&lt;p&gt;Personally I would expect it to be stored as String, and the EPOCH date being formatted in the exact same format the date properties are persisted in the file, which is:&lt;br/&gt;
org.apache.solr.handler.dataimport.SimplePropertiesWriter#dateFormat&lt;/p&gt;




&lt;p&gt;This doesn&apos;t have a real impact on our code but it is just that an integration test &quot;test_delta_import_when_never_indexed&quot; was unexpectedly failing while all others were ok, after a Solr 1.4 to Solr 4.1 migration. &lt;br/&gt;
Thus it seems to be a minor regression.&lt;/p&gt;



&lt;p&gt;Thanks&lt;/p&gt;</description>
                <environment></environment>
        <key id="12629739">SOLR-4376</key>
            <summary>dih.last_index_time has bad Date.toString() format during first delta import</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="sebastienlorber">Sebastien Lorber</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Jan 2013 17:39:22 +0000</created>
                <updated>Mon, 9 May 2016 18:49:32 +0000</updated>
                            <resolved>Fri, 22 Nov 2013 06:48:21 +0000</resolved>
                                    <version>4.1</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>contrib - DataImportHandler</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13565607" author="jdyer" created="Tue, 29 Jan 2013 18:08:54 +0000"  >&lt;p&gt;could explain what is happening to your dataimport.properties file and how it is wrong?&lt;/p&gt;</comment>
                            <comment id="13565611" author="jdyer" created="Tue, 29 Jan 2013 18:10:27 +0000"  >&lt;p&gt;now that I&apos;ve read your edited description, I think I get it.  If you run a delta even though a full import has never been run before, it trips up, right?&lt;/p&gt;</comment>
                            <comment id="13566321" author="sebastienlorber" created="Wed, 30 Jan 2013 09:20:29 +0000"  >&lt;p&gt;Exactly.&lt;/p&gt;

&lt;p&gt;Basically all these integration tests worked with Solr 1.4, but with Solr 4.1, the &quot;test_delta_import_when_never_indexed&quot; had to be disabled.&lt;br/&gt;
&lt;a href=&quot;http://pastebin.com/PDnHv2M2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/PDnHv2M2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The content of the dataimport.properties file itself is not wrong: it does contain the dates in the good format. The matter is that when the file doesn&apos;t exist yet, or doesn&apos;t contain all regular entries, when requesting a LAST_INDEX_TIME from this file, there is a fallback to the EPOCH date for bootstrapping, but the date is added to the map as Date and not as a formatted String.&lt;/p&gt;


&lt;p&gt;The fix could simply be:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;indexerNamespace.put(LAST_INDEX_TIME, getSimplePropertiesWriterDateFormat().format(EPOCH) );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So that both the persisted date retrieval and a date retrieval miss with fallback to timestamp=0 will provide the same kind of formatted date to the indexerNamespace map&lt;/p&gt;</comment>
                            <comment id="13566326" author="sebastienlorber" created="Wed, 30 Jan 2013 09:36:03 +0000"  >&lt;p&gt;By the way, the date format you set in the SimplePropertiesWriter is the dateformat you get when you use ${dih.last_index_time} in your dataimport.xml&lt;br/&gt;
It is not obvious and it could be a good idea to decorelate these 2 date formats. However it&apos;s not a big deal...&lt;/p&gt;


&lt;p&gt;Personally instead of build the query from strings, I think it would be more elegant to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Store all dates (even persisted one) as Dates in the indexerNamespace map&lt;/li&gt;
	&lt;li&gt;When creating the delta query, create a PreparedStatement, replacing the variables by real JDBC parameters so that delta query would be:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; bje.job_execution_id &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; JOB_EXECUTION_ID
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; BATCH_JOB_EXECUTION bje
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; last_updated &amp;gt; ?
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Inject the parameters directly as Date instead of replacing the ${xxx} by strings&lt;/li&gt;
	&lt;li&gt;The JDBC parameters position could be a matter and then Spring has a solution for that -&amp;gt; NamedParameterJdbcTemplate&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13827670" author="arcadius" created="Wed, 20 Nov 2013 14:02:19 +0000"  >&lt;p&gt;This is a patch/fix against trunk.&lt;br/&gt;
It also includes a test-case that triggers the issue.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;Arcadius.&lt;/p&gt;</comment>
                            <comment id="13829717" author="jira-bot" created="Fri, 22 Nov 2013 06:45:15 +0000"  >&lt;p&gt;Commit 1544421 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1544421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1544421&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4376&quot; title=&quot;dih.last_index_time has bad Date.toString() format during first delta import&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4376&quot;&gt;&lt;del&gt;SOLR-4376&lt;/del&gt;&lt;/a&gt;: DataImportHandler uses wrong date format for last_index_time if a delta-import is run first before any full-imports&lt;/p&gt;</comment>
                            <comment id="13829719" author="jira-bot" created="Fri, 22 Nov 2013 06:46:43 +0000"  >&lt;p&gt;Commit 1544422 from shalin@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1544422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1544422&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4376&quot; title=&quot;dih.last_index_time has bad Date.toString() format during first delta import&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4376&quot;&gt;&lt;del&gt;SOLR-4376&lt;/del&gt;&lt;/a&gt;: DataImportHandler uses wrong date format for last_index_time if a delta-import is run first before any full-imports&lt;/p&gt;</comment>
                            <comment id="13829721" author="shalinmangar" created="Fri, 22 Nov 2013 06:48:21 +0000"  >&lt;p&gt;This is fixed.&lt;/p&gt;

&lt;p&gt;Thanks Sebastien and Arcadius!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12641649">SOLR-4694</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12614890" name="SOLR-4376-trunk.patch" size="4032" author="arcadius" created="Wed, 20 Nov 2013 14:02:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>310235</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hjh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>310580</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>