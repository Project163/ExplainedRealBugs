<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:44:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5416] CollapsingQParserPlugin breaks Tag/Exclude Faceting</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5416</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Trying to use CollapsingQParserPlugin with facet tagging throws an exception. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; ModifiableSolrParams params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;fq&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;{!collapse field=group_s}&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;defType&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;edismax&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;bf&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;field(test_ti)&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;fq&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;{!tag=test_ti}test_ti:5&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;facet&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;facet.field&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;{!ex=test_ti}test_ti&quot;&lt;/span&gt;);
    assertQ(req(params), &lt;span class=&quot;code-quote&quot;&gt;&quot;*[count(&lt;span class=&quot;code-comment&quot;&gt;//doc)=1]&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;//doc[./&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[@name=&lt;span class=&quot;code-quote&quot;&gt;&apos;test_ti&apos;&lt;/span&gt;]=&lt;span class=&quot;code-quote&quot;&gt;&apos;5&apos;&lt;/span&gt;]&quot;&lt;/span&gt;);&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12677136">SOLR-5416</key>
            <summary>CollapsingQParserPlugin breaks Tag/Exclude Faceting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbernste">Joel Bernstein</assignee>
                                    <reporter username="dboychuck">David Boychuck</reporter>
                        <labels>
                            <label>group</label>
                            <label>grouping</label>
                    </labels>
                <created>Fri, 1 Nov 2013 19:30:40 +0000</created>
                <updated>Mon, 6 Apr 2020 16:14:29 +0000</updated>
                            <resolved>Sat, 21 Dec 2013 14:40:08 +0000</resolved>
                                    <version>4.6</version>
                                    <fixVersion>4.6.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="13813187" author="dboychuck" created="Mon, 4 Nov 2013 20:02:42 +0000"  >&lt;p&gt;This patch assumes that only tagged documents have a ord &amp;gt; -1 and scorer = null in the collect() method&lt;/p&gt;

&lt;p&gt;If there is a better way to identify tagged documents in this collect() method then it should probably be used in place of ord &amp;gt; -1 &amp;amp;&amp;amp; scorer == null&lt;/p&gt;</comment>
                            <comment id="13813315" author="dboychuck" created="Mon, 4 Nov 2013 21:38:41 +0000"  >&lt;p&gt;This fix uncovers/creates a new bug:&lt;/p&gt;

&lt;p&gt;Error during auto-warming of key:org.apache.solr.search.QueryResultKey@48dfd36d:java.lang.ArrayIndexOutOfBoundsException: 0&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:401)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1636)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1363)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2051)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;</comment>
                            <comment id="13813325" author="dboychuck" created="Mon, 4 Nov 2013 21:43:03 +0000"  >&lt;p&gt;Adding a fix for setNextReader function when contexts.length = 0&lt;/p&gt;</comment>
                            <comment id="13818202" author="joel.bernstein" created="Sat, 9 Nov 2013 17:15:41 +0000"  >&lt;p&gt;Hi David,&lt;/p&gt;

&lt;p&gt;I&apos;ve read through the patch. I don&apos;t think we&apos;ll be able to solve this issue though from inside of the CollapsingQParserPlugin. The main problem is that the CollapsingQParserPlugin really needs the scorer to be present to work properly. So to get this working we&apos;ll need to make sure that the method that builds the docset, builds it in such a way that scorer can be accessed. &lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at finding an approach for this.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13819180" author="dboychuck" created="Mon, 11 Nov 2013 18:28:58 +0000"  >&lt;p&gt;Joel,&lt;/p&gt;

&lt;p&gt;I&apos;m currently using my patch and the facet counts are correct and the performance is good. We were looking to roll this out in production where I work. Would you advise against it? What kind of problems could this cause?&lt;/p&gt;</comment>
                            <comment id="13819224" author="joel.bernstein" created="Mon, 11 Nov 2013 19:02:07 +0000"  >&lt;p&gt;David,&lt;/p&gt;

&lt;p&gt;Here is the flow as I see it with the patch:&lt;br/&gt;
1) The intitial search executes and produces a result based on collapsing the groups by score.&lt;br/&gt;
2) The facet component needs to regenerate the docset because of the tag/exclude parameters. But the scorer is not present when regenerating the docset, so it is using logic that overwrites the group-head each time. This will result in the document that is found latest in the index becoming the group-head, for each group.&lt;/p&gt;

&lt;p&gt;So, the result set used to calculate the facet, will be different from the result set used to generate the search results.&lt;/p&gt;

&lt;p&gt;To keep these in sync you would need to have step 2, also collapse based on score.&lt;/p&gt;</comment>
                            <comment id="13819237" author="dboychuck" created="Mon, 11 Nov 2013 19:10:08 +0000"  >&lt;p&gt;Oh I see.... that won&apos;t actually be a problem for me since all of the documents in the group should have the same facet counts. Thanks for the reply. I will wait for a fix. But for now, if I understand your reply correctly, I don&apos;t think that will affect my facet counts in a negative manner.&lt;/p&gt;</comment>
                            <comment id="13819255" author="joel.bernstein" created="Mon, 11 Nov 2013 19:22:25 +0000"  >&lt;p&gt;Yes, if all the documents in the same group have the same facet counts then you won&apos;t notice this problem.&lt;/p&gt;</comment>
                            <comment id="13844692" author="joel.bernstein" created="Tue, 10 Dec 2013 21:37:27 +0000"  >&lt;p&gt;I uploaded a patch created from trunk which I believe resolves the issues. I started out attempting to fix this in a more generic way but ended up needing to get very specific to not break other test cases. &lt;/p&gt;

&lt;p&gt;The issue with the other test cases is that the patch I added won&apos;t work if the main query is excluded. But for the CollapsingQParserPlugin, then main query is always needed anyway to support collapsing by score. So to not break a test case which excluded the main query, I routed only requests that use the CollapsingQParserPlugin to the new method that scores while creating the docset.&lt;/p&gt;

&lt;p&gt;The next step is to throw an exception if someone tries to exclude the main query while using the CollapsingQParserPlugin. &lt;/p&gt;

&lt;p&gt;David, when you get a chance could you test this patch out and see if it resolves the issue for you. If the patch doesn&apos;t apply for you I&apos;ll create one for your version of Solr.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13845469" author="joel.bernstein" created="Wed, 11 Dec 2013 15:17:33 +0000"  >&lt;p&gt;Added a test case for tag/exclude and also revamped all the tests to better exercise sorting following the collapse.&lt;/p&gt;</comment>
                            <comment id="13845630" author="dboychuck" created="Wed, 11 Dec 2013 18:56:24 +0000"  >&lt;p&gt;Hi Joel I will try to patch it into 4.5.1 and let you know if it works&lt;/p&gt;</comment>
                            <comment id="13845668" author="joel.bernstein" created="Wed, 11 Dec 2013 19:37:02 +0000"  >&lt;p&gt;Hi David,&lt;/p&gt;

&lt;p&gt;It&apos;s probably easiest to put two files in place rather then try to patch 4.5.1. I&apos;ll attache my version of the CollapsingQParserPlugin and SolrIndexSearcher. You can then just copy them to org/apache/solr/search.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13845678" author="dboychuck" created="Wed, 11 Dec 2013 19:47:12 +0000"  >&lt;p&gt;Could you also attach your tests and I&apos;ll see if it works&lt;/p&gt;</comment>
                            <comment id="13845688" author="dboychuck" created="Wed, 11 Dec 2013 20:04:51 +0000"  >&lt;p&gt;patched it into 4.6. Going to upgrade my servers and do some testing with my index&lt;/p&gt;</comment>
                            <comment id="13845852" author="joel.bernstein" created="Wed, 11 Dec 2013 23:42:19 +0000"  >&lt;p&gt;Added empty SearchFilter interface so SolrIndexSearcher can reference something more generic. If a postfilter also implements SearchFilter then the SolrIndexSearcher will call getDocSetScore() rather the getDocSet() when building docsets. &lt;/p&gt;</comment>
                            <comment id="13846549" author="dboychuck" created="Thu, 12 Dec 2013 18:17:42 +0000"  >&lt;p&gt;4.6 had some bugs in the DIH. Going to try to patch this into my 4.5.1.&lt;/p&gt;</comment>
                            <comment id="13846576" author="dboychuck" created="Thu, 12 Dec 2013 18:45:18 +0000"  >&lt;p&gt;Joel,&lt;/p&gt;

&lt;p&gt;This test is failing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;fq&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;{!collapse field=group_s min=test_ti}&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;sort&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;score desc,id asc&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;defType&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;edismax&quot;&lt;/span&gt;);
    params.add(&lt;span class=&quot;code-quote&quot;&gt;&quot;bf&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;field(id)&quot;&lt;/span&gt;);
    assertQ(req(params), &lt;span class=&quot;code-quote&quot;&gt;&quot;*[count(&lt;span class=&quot;code-comment&quot;&gt;//doc)=2]&quot;&lt;/span&gt;,
&lt;/span&gt;                          &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-comment&quot;&gt;//result/doc[1]/&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;[@name=&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;][.=&lt;span class=&quot;code-quote&quot;&gt;&apos;5.0&apos;&lt;/span&gt;]&quot;&lt;/span&gt;,
&lt;/span&gt;                          &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-comment&quot;&gt;//result/doc[2]/&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;[@name=&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;][.=&lt;span class=&quot;code-quote&quot;&gt;&apos;1.0&apos;&lt;/span&gt;]&quot;&lt;/span&gt;);&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m assuming it&apos;s not a problem with the parser and a problem with the test.&lt;/p&gt;</comment>
                            <comment id="13846600" author="joel.bernstein" created="Thu, 12 Dec 2013 19:04:17 +0000"  >&lt;p&gt;The test should be ok. It runs successfully for me.  This specifically tests &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt;. Probably you don&apos;t have that patch applied. If you overlay the attached java files you&apos;ll get both patches.&lt;/p&gt;
</comment>
                            <comment id="13846623" author="dboychuck" created="Thu, 12 Dec 2013 19:20:35 +0000"  >&lt;p&gt;Overlaying the files doesn&apos;t work I get errors resolving:&lt;/p&gt;

&lt;p&gt;import org.apache.lucene.index.StorableField;&lt;br/&gt;
import org.apache.lucene.index.StoredDocument;&lt;/p&gt;

&lt;p&gt;Would you be able to create a patch for 4.5.1?&lt;/p&gt;</comment>
                            <comment id="13846632" author="dboychuck" created="Thu, 12 Dec 2013 19:26:00 +0000"  >&lt;p&gt;I just checked the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt; and it looks like I have that code already.&lt;/p&gt;</comment>
                            <comment id="13846633" author="dboychuck" created="Thu, 12 Dec 2013 19:27:08 +0000"  >&lt;p&gt;oh wait nevermind. I patched solrIndexsearcher with just your changes... then I overlay your CollapsingQParserPlugin... this might work.&lt;/p&gt;</comment>
                            <comment id="13846648" author="dboychuck" created="Thu, 12 Dec 2013 19:33:53 +0000"  >&lt;p&gt;bah... no good&lt;/p&gt;</comment>
                            <comment id="13846663" author="dboychuck" created="Thu, 12 Dec 2013 19:53:48 +0000"  >&lt;p&gt;whew! Ok I applied the patches from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5027&quot; title=&quot;Field Collapsing PostFilter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5027&quot;&gt;&lt;del&gt;SOLR-5027&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5408&quot; title=&quot;CollapsingQParserPlugin scores incorrectly when multiple sort criteria are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5408&quot;&gt;&lt;del&gt;SOLR-5408&lt;/del&gt;&lt;/a&gt;, and from your latest patch attached to this tracker. All tests now pass. Going to upgrade my servers and see if this works for me. In my current implementation I am getting a lot of errors from SolrCache (the patch I provided) and am running into heap memory errors. I&apos;m wondering if the errors are caused by my patch.&lt;/p&gt;</comment>
                            <comment id="13846760" author="dboychuck" created="Thu, 12 Dec 2013 21:27:49 +0000"  >&lt;p&gt;I have patched 4.5.1 with your changes. Functionally everything works correctly. But I am seeing the following errors:&lt;/p&gt;


&lt;p&gt;1672828 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@ad693c4:java.lang.NullPointerException&lt;/p&gt;

&lt;p&gt;1672831 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@e7384164:java.lang.NullPointerException&lt;/p&gt;

&lt;p&gt;1672834 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@569af2fd:java.lang.NullPointerException&lt;/p&gt;

&lt;p&gt;1672837 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@45c8d9aa:java.lang.NullPointerException&lt;/p&gt;

&lt;p&gt;1672899 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@d8a57011:java.lang.NullPointerException&lt;/p&gt;

&lt;p&gt;1672904 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-5-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@eb4c3b23:java.lang.NullPointerException&lt;/p&gt;</comment>
                            <comment id="13846808" author="dboychuck" created="Thu, 12 Dec 2013 22:08:05 +0000"  >&lt;p&gt;Joel,&lt;/p&gt;

&lt;p&gt;Is it possible that the tagged documents are ending up in the solr query cache with null values?&lt;/p&gt;</comment>
                            <comment id="13846827" author="joel.bernstein" created="Thu, 12 Dec 2013 22:27:23 +0000"  >&lt;p&gt;David,&lt;/p&gt;

&lt;p&gt;I&apos;m not gettting the auto-warm cache errors. I have debug logging on, and autowarming turned on. I ran collapse queries to populate the QueryResultCache and then loaded data. The cache seems to warm properly.&lt;/p&gt;

&lt;p&gt;Try turning debug logging on and see if we can get more of the strack trace.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13846872" author="dboychuck" created="Thu, 12 Dec 2013 23:06:35 +0000"  >&lt;p&gt;7668111 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-18-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@cec848a0:java.lang.ArrayIndexOutOfBoundsException: 1&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:402)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1662)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1389)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2077)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;7668114 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-18-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@d9756dd8:java.lang.ArrayIndexOutOfBoundsException: 1&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:402)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1662)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1389)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2077)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;7668123 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-18-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@d38b6b9c:java.lang.ArrayIndexOutOfBoundsException: 1&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:402)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1662)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1389)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2077)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;7668165 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-18-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@9fe9299c:java.lang.ArrayIndexOutOfBoundsException: 1&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:402)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1662)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1389)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2077)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;7668169 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-18-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@94d684c6:java.lang.ArrayIndexOutOfBoundsException: 1&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:402)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1662)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1389)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2077)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;7668175 &lt;span class=&quot;error&quot;&gt;&amp;#91;searcherExecutor-18-thread-1&amp;#93;&lt;/span&gt; ERROR org.apache.solr.search.SolrCache  &#8211; Error during auto-warming of key:org.apache.solr.search.QueryResultKey@31f8a000:java.lang.ArrayIndexOutOfBoundsException: 1&lt;br/&gt;
	at org.apache.solr.search.CollapsingQParserPlugin$CollapsingScoreCollector.setNextReader(CollapsingQParserPlugin.java:402)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)&lt;br/&gt;
	at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListAndSetNC(SolrIndexSearcher.java:1662)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1389)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.access$000(SolrIndexSearcher.java:118)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher$3.regenerateItem(SolrIndexSearcher.java:465)&lt;br/&gt;
	at org.apache.solr.search.LRUCache.warm(LRUCache.java:188)&lt;br/&gt;
	at org.apache.solr.search.SolrIndexSearcher.warm(SolrIndexSearcher.java:2077)&lt;br/&gt;
	at org.apache.solr.core.SolrCore$4.call(SolrCore.java:1631)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;</comment>
                            <comment id="13846953" author="joel.bernstein" created="Fri, 13 Dec 2013 00:12:12 +0000"  >&lt;p&gt;OK, I believe I see the problem. I&apos;ll update this ticket with a new patch shortly.&lt;/p&gt;</comment>
                            <comment id="13847041" author="joel.bernstein" created="Fri, 13 Dec 2013 01:46:00 +0000"  >&lt;p&gt;David,&lt;/p&gt;

&lt;p&gt;This was actually a pretty nasty bug, that pointed to possible memory leaks as well. The latest patch should resolve your exceptions around cache warming and eliminate the memory leak issues.&lt;/p&gt;

&lt;p&gt;Thanks for helping track down these bugs.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13847576" author="joel.bernstein" created="Fri, 13 Dec 2013 15:28:03 +0000"  >&lt;p&gt;Resolved an issue with sort order when an empty sort param is provided, reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5554&quot; title=&quot;Ordering Issue when Collapsing using min max&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5554&quot;&gt;&lt;del&gt;SOLR-5554&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13847788" author="dboychuck" created="Fri, 13 Dec 2013 19:03:48 +0000"  >&lt;p&gt;Thank you for your quick response, I&apos;m actually trying to use your plugin in production as the standard grouping had serious performance issues around facet grouping. I&apos;ll try to patch in your latest fix. Thank you for all of your help!&lt;/p&gt;</comment>
                            <comment id="13847814" author="dboychuck" created="Fri, 13 Dec 2013 19:27:24 +0000"  >&lt;p&gt;I am attaching a patch with all of the patches for CollapseQParserPlugin up to todays date. This patch is for those of use who want to use this plugin in Solr 4.5.1&lt;/p&gt;</comment>
                            <comment id="13849605" author="joel.bernstein" created="Mon, 16 Dec 2013 19:10:48 +0000"  >&lt;p&gt;All tests are passing as well as precommit. I&apos;ll wait a day or so to see if any review comments come in and if not I&apos;ll commit to trunk, 4x and Solr 4.6.1.&lt;/p&gt;
</comment>
                            <comment id="13850390" author="er.shruti" created="Tue, 17 Dec 2013 12:10:28 +0000"  >&lt;p&gt;Joel,&lt;/p&gt;

&lt;p&gt;I am getting the following error when i am applying CollapseQParserPluginPatch-solr-4.5.1.patch in solr-4.5.1.&lt;/p&gt;

&lt;p&gt;Error&lt;br/&gt;
1 out of 1 hunk ignored &amp;#8211; saving rejects to file solr/core/src/java/org/apache/solr/search/QParserPlugin.java.rej&lt;br/&gt;
patching file solr/core/ivy.xml&lt;br/&gt;
Hunk #1 FAILED at 42.&lt;br/&gt;
1 out of 1 hunk FAILED &amp;#8211; saving rejects to file solr/core/ivy.xml.rej&lt;br/&gt;
patching file solr/core/src/test/org/apache/solr/search/QueryEqualityTest.java&lt;br/&gt;
Hunk #1 succeeded at 295 (offset 100 lines).&lt;br/&gt;
patching file solr/core/src/java/org/apache/solr/search/ScoreFilter.java&lt;br/&gt;
patching file solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java&lt;br/&gt;
Reversed (or previously applied) patch detected!  Assume -R? &lt;span class=&quot;error&quot;&gt;&amp;#91;n&amp;#93;&lt;/span&gt; &lt;br/&gt;
Apply anyway? &lt;span class=&quot;error&quot;&gt;&amp;#91;n&amp;#93;&lt;/span&gt; &lt;br/&gt;
Skipping patch.&lt;br/&gt;
2 out of 2 hunks ignored &amp;#8211; saving rejects to file solr/core/src/java/org/apache/solr/search/SolrIndexSearcher.java.rej&lt;br/&gt;
patching file solr/core/src/test/org/apache/solr/search/TestCollapseQParserPlugin.java&lt;br/&gt;
patching file solr/core/src/java/org/apache/solr/search/CollapsingQParserPlugin.java&lt;/p&gt;

&lt;p&gt;Regards&lt;br/&gt;
Shruti &lt;/p&gt;</comment>
                            <comment id="13850479" author="joel.bernstein" created="Tue, 17 Dec 2013 14:08:35 +0000"  >&lt;p&gt;Hi Shruti,&lt;/p&gt;

&lt;p&gt;I suspect you have certain parts of the patch already applied. David created this patch, but I believe it applies the CollapsingQParserPlugin all the way back to the original commit. &lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13851458" author="er.shruti" created="Wed, 18 Dec 2013 07:13:48 +0000"  >&lt;p&gt;Joel&lt;/p&gt;

&lt;p&gt;Please tell me steps to integrate it with svn checkout lucene_solr_4_5_1&lt;/p&gt;

&lt;p&gt;Shruti&lt;/p&gt;</comment>
                            <comment id="13851653" author="joel.bernstein" created="Wed, 18 Dec 2013 12:45:23 +0000"  >&lt;p&gt;David,&lt;/p&gt;

&lt;p&gt;I&apos;d like to credit your work on this ticket in the CHANGES.txt. Let me know if you&apos;d like to use your last name.&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13851867" author="jira-bot" created="Wed, 18 Dec 2013 16:06:14 +0000"  >&lt;p&gt;Commit 1551999 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1551999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1551999&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5416&quot; title=&quot;CollapsingQParserPlugin breaks Tag/Exclude Faceting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5416&quot;&gt;&lt;del&gt;SOLR-5416&lt;/del&gt;&lt;/a&gt;: CollapsingQParserPlugin bug with tagging&lt;/p&gt;</comment>
                            <comment id="13851918" author="jira-bot" created="Wed, 18 Dec 2013 17:05:01 +0000"  >&lt;p&gt;Commit 1552027 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1552027&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1552027&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5416&quot; title=&quot;CollapsingQParserPlugin breaks Tag/Exclude Faceting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5416&quot;&gt;&lt;del&gt;SOLR-5416&lt;/del&gt;&lt;/a&gt;: CollapsingQParserPlugin bug with tagging&lt;/p&gt;</comment>
                            <comment id="13851963" author="dboychuck" created="Wed, 18 Dec 2013 17:52:03 +0000"  >&lt;p&gt;wow thanks Joel! Of course I wouldn&apos;t mind. My full name is David Boychuck.&lt;/p&gt;</comment>
                            <comment id="13852347" author="joel.bernstein" created="Wed, 18 Dec 2013 23:58:16 +0000"  >&lt;p&gt;Thanks David, I think the plan is to get these fixes into Solr 4.6.1. I&apos;ll be sure to credit you in the CHANGES.txt&lt;/p&gt;

&lt;p&gt;Joel&lt;/p&gt;</comment>
                            <comment id="13854798" author="jira-bot" created="Sat, 21 Dec 2013 06:05:28 +0000"  >&lt;p&gt;Commit 1552876 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_6&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1552876&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1552876&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5416&quot; title=&quot;CollapsingQParserPlugin breaks Tag/Exclude Faceting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5416&quot;&gt;&lt;del&gt;SOLR-5416&lt;/del&gt;&lt;/a&gt;: CollapsingQParserPlugin bug with tagging&lt;/p&gt;</comment>
                            <comment id="13868280" author="dboychuck" created="Fri, 10 Jan 2014 20:48:04 +0000"  >&lt;p&gt;Hi Joel,&lt;/p&gt;

&lt;p&gt;I&apos;m noticing that QueryResultCache is not being used when using this plugin. Is it not supposed to? &lt;/p&gt;</comment>
                            <comment id="13868310" author="joel.bernstein" created="Fri, 10 Jan 2014 21:16:14 +0000"  >&lt;p&gt;Actually the reason why I had to disable the QueryResultCache for the CollapsingQParserPlugin is this bug. You could trigger this bug by also doing&lt;/p&gt;

&lt;p&gt;1) Executing a query with the CollapsingQParsePlugin combined with facets.&lt;br/&gt;
2) The query gets cached in the QueryResultCache. But the docset does not (this is normal for Solr).&lt;br/&gt;
3) Execute the same query again, retrieve the query from the QueryResultCache but the docset needs to be regenerated.&lt;br/&gt;
4) Regenerating the docset threw the same exception you reported in this ticket because they use the same method.&lt;/p&gt;

&lt;p&gt;I knew this bug existed, so I disabled the queryResultCache for the CollapsingQParserPlugin. But I didn&apos;t know tag/exclude would trigger the same bug. You pointed that out.&lt;/p&gt;

&lt;p&gt;Now that this issue is fixed, the CollapsingQParserPlugin will work fine with the QueryResultCache. But I haven&apos;t re-enabled it. If you want, you can create another ticket for that. I was planning on doing this for Solr 4.7.&lt;/p&gt;

</comment>
                            <comment id="13868342" author="dboychuck" created="Fri, 10 Jan 2014 21:41:41 +0000"  >&lt;p&gt;Is it something that would be easy to re-enable? I&apos;d like to use it in my 4.5.1 solr&lt;/p&gt;</comment>
                            <comment id="13868345" author="dboychuck" created="Fri, 10 Jan 2014 21:43:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5624&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-5624&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13868356" author="joel.bernstein" created="Fri, 10 Jan 2014 21:53:16 +0000"  >&lt;p&gt;The equals and hashCode methods in the CollapsingPostFilter need to be changed. It&apos;s a pretty quick fix and easy to backport. I&apos;ll try to get to this early next week. &lt;/p&gt;</comment>
                            <comment id="14110639" author="er.shruti" created="Tue, 26 Aug 2014 12:13:10 +0000"  >&lt;p&gt;Hi Joel,&lt;/p&gt;

&lt;p&gt;I am facing an issue with Facet count using  shard query and  collapse filter. &lt;/p&gt;

&lt;p&gt;Query:- &lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/core1/select?fq=&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/core1/select?fq=&lt;/a&gt;&lt;/p&gt;
{!collapse%20field=type}
&lt;p&gt;&amp;amp;q=type:abc&amp;amp;facet=true&amp;amp;facet.field=type&amp;amp;shards=localhost:8983/solr/core1,localhost:8983/solr/core2&lt;/p&gt;

&lt;p&gt;Output:-&lt;br/&gt;
&amp;lt;result name=&quot;response&quot; numFound=&quot;1&quot; start=&quot;0&quot; maxScore=&quot;1.0&quot;&amp;gt;&amp;lt;/result&amp;gt;&lt;br/&gt;
&amp;lt;lst name=&quot;facet_counts&quot;&amp;gt; &lt;br/&gt;
&amp;lt;lst name=&quot;facet_queries&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;lst name=&quot;facet_fields&quot;&amp;gt;&lt;br/&gt;
&amp;lt;lst name=&quot;type&quot;&amp;gt; &lt;br/&gt;
&amp;lt;int name=&quot;abc&quot;&amp;gt;2&amp;lt;/int&amp;gt;&lt;br/&gt;
&amp;lt;int name=&quot;cde&quot;&amp;gt;0&amp;lt;/int&amp;gt;&lt;br/&gt;
&amp;lt;int name=&quot;swe&quot;&amp;gt;0&amp;lt;/int&amp;gt;&lt;br/&gt;
&amp;lt;/lst&amp;gt;&lt;br/&gt;
&amp;lt;/lst&amp;gt;&lt;br/&gt;
&amp;lt;lst name=&quot;facet_dates&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;lst name=&quot;facet_ranges&quot;/&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/response&amp;gt;&lt;/p&gt;

&lt;p&gt;Issue:- In the above output numFound=&quot;1&quot; and facet count for abc is 2. While merging results from shards unique Facet count should drop. &lt;/p&gt;

&lt;p&gt;Regards&lt;br/&gt;
shruti&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13004174">SOLR-9501</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13296555">SOLR-14391</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12657108">SOLR-5027</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12688336">SOLR-5624</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12618665" name="CollapseQParserPluginPatch-solr-4.5.1.patch" size="47123" author="dboychuck" created="Fri, 13 Dec 2013 19:27:24 +0000"/>
                            <attachment id="12618284" name="CollapsingQParserPlugin.java" size="29794" author="jbernste" created="Wed, 11 Dec 2013 19:38:24 +0000"/>
                            <attachment id="12618610" name="SOLR-5416.patch" size="23451" author="jbernste" created="Fri, 13 Dec 2013 15:28:03 +0000"/>
                            <attachment id="12618515" name="SOLR-5416.patch" size="22443" author="jbernste" created="Fri, 13 Dec 2013 01:35:54 +0000"/>
                            <attachment id="12618319" name="SOLR-5416.patch" size="11771" author="jbernste" created="Wed, 11 Dec 2013 23:42:19 +0000"/>
                            <attachment id="12618238" name="SOLR-5416.patch" size="10342" author="jbernste" created="Wed, 11 Dec 2013 15:17:33 +0000"/>
                            <attachment id="12618110" name="SOLR-5416.patch" size="2183" author="jbernste" created="Tue, 10 Dec 2013 21:56:37 +0000"/>
                            <attachment id="12612037" name="SOLR-5416.patch" size="5851" author="dboychuck" created="Mon, 4 Nov 2013 21:42:39 +0000"/>
                            <attachment id="12618285" name="SolrIndexSearcher.java" size="87895" author="jbernste" created="Wed, 11 Dec 2013 19:38:24 +0000"/>
                            <attachment id="12618313" name="TestCollapseQParserPlugin.java" size="8342" author="jbernste" created="Wed, 11 Dec 2013 23:22:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356512</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pgkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356800</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>