<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:43:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14274] Multiple CoreContainers will register the same JVM Metrics</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14274</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When running multiple CoreContainer in the same JVM, either because we called &lt;tt&gt;SolrCloudTestCase.configureCluster(int n)&lt;/tt&gt; with &lt;tt&gt;n &amp;gt; 1&lt;/tt&gt; or because we have multiple tests running in the same JVM in succession, we will have contention on the shared JVM &lt;tt&gt;metricsRegistry&lt;/tt&gt; as they each replace the existing metrics with their own. Further, with multiple nodes at the same time, some of these metrics will be incorrect anyway, since they will only reflect a single core container. Others will be fine since I think they are reading system-level information so it doesn&apos;t matter where it comes from.&lt;/p&gt;

&lt;p&gt;I think this is a test-only issue, since the circumstances where somebody is running multiple core containers in a single JVM in production should be rare, but maybe there are edge cases affected with EmbeddedSolrServer and MapReduce or Spark, or other unusual deployment patterns.&lt;/p&gt;

&lt;p&gt;Removing the metrics registration entirely can speed up &lt;tt&gt;configureCluster(100).build()&lt;/tt&gt; on my machine from 2 minutes to 30 seconds, so I&apos;m optimistic that there can be gains here without sacrificing the feature entirely.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13286593">SOLR-14274</key>
            <summary>Multiple CoreContainers will register the same JVM Metrics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mdrob">Mike Drob</assignee>
                                    <reporter username="mdrob">Mike Drob</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Feb 2020 00:00:34 +0000</created>
                <updated>Fri, 21 Aug 2020 14:38:54 +0000</updated>
                            <resolved>Wed, 25 Mar 2020 22:40:36 +0000</resolved>
                                                    <fixVersion>8.6</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17041399" author="mdrob" created="Fri, 21 Feb 2020 00:37:29 +0000"  >&lt;p&gt;I see that &lt;tt&gt;SolrMetricsManager.registerAll&lt;/tt&gt; has a big synchronized block because adding a metric that already exists will throw an exception, and it looks like we can&apos;t use nice java concurrency primitives for it. I wonder if there&apos;s value in changing the &lt;tt&gt;registerAll&lt;/tt&gt; calls to use &lt;tt&gt;force:false&lt;/tt&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; - do you remember why these are force overwrite? I don&apos;t see any usage outside of test code that doesn&apos;t force it either...&lt;/p&gt;</comment>
                            <comment id="17042129" author="mdrob" created="Fri, 21 Feb 2020 19:34:44 +0000"  >&lt;p&gt;The comment in &lt;tt&gt;SolrMetricManagerTest&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should simply skip existing names
&lt;/span&gt;    metricManager.registerAll(registryName, mr, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;confuses me regarding what the expected behavior really is.&lt;/p&gt;

&lt;p&gt;And the java doc on &lt;tt&gt;registerAll&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   * Register all metrics in the provided {@link MetricSet}, optionally skipping those that
   * already exist.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But there doesn&apos;t appear to be a way to actually skip. Either replace or throw exception on conflict.&lt;/p&gt;</comment>
                            <comment id="17042136" author="ab" created="Fri, 21 Feb 2020 19:53:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob&quot; class=&quot;user-hover&quot; rel=&quot;mdrob&quot;&gt;mdrob&lt;/a&gt; yeah, that comment is wrong - it doesn&apos;t skip, it overwrites the metric instances that are under the same names.&lt;/p&gt;

&lt;p&gt;Regarding the &quot;force: true&quot; argument: Dropwizard&apos;s default behavior is to refuse re-registering an already existing metric. However, Solr must be able to forcefully replace existing metric instances, and this situation occurs frequently and it&apos;s not exceptional, so it should not cause exceptions. This happens eg. when a new SolrIndexSearcher is created, or a core is reloaded - many metrics (specifically, Gauge metrics) are really lambdas tied to the old instances, and the new instances logically belong under the same names - so it makes sense to always forcefully replace the old values with the new ones.&lt;/p&gt;

&lt;p&gt;So if a change is needed to streamline our code I&apos;d go the opposite way - make the &quot;force: true&quot; the default behavior in SolrMetricManager.&lt;/p&gt;</comment>
                            <comment id="17042236" author="mdrob" created="Fri, 21 Feb 2020 23:34:00 +0000"  >&lt;p&gt;Looking at the metrics in SolrIndexSearcher, I wonder if a better approach wouldn&apos;t be to figure out some way to update the value rather than unregistering and registering a whole new provider, especially since these values are all constant over the lifetime of a searcher. That has it&apos;s own pile of thorns...&lt;/p&gt;

&lt;p&gt;It looks to me like we&apos;re currently using the metrics registry as essentially a giant external map? Makes sense that we are seeing synchronization issues.&lt;/p&gt;</comment>
                            <comment id="17043684" author="mdrob" created="Mon, 24 Feb 2020 16:58:13 +0000"  >&lt;p&gt;I think the behavior that we want varies with what kind of metric we are registering. If it is a core-specific metric then replacing makes sense. If it is a JVM or OS metric, then replacing might not make as much sense.&lt;/p&gt;

&lt;p&gt;I&apos;m looking at this with replacing the idea of a binary force flag with an enum dictating what to do in case of conflict - replace, skip, or fail.&lt;/p&gt;</comment>
                            <comment id="17046294" author="ab" created="Thu, 27 Feb 2020 07:57:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m looking at this with replacing the idea of a binary force flag with an enum dictating what to do in case of conflict - replace, skip, or fail.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Makes sense, although it could make the code more complex ... let&apos;s see how it looks like, perhaps we could provide overloaded methods with the default behavior of replace (since that&apos;s the most common case)?&lt;/p&gt;</comment>
                            <comment id="17047848" author="mdrob" created="Fri, 28 Feb 2020 18:04:05 +0000"  >&lt;p&gt;I put up a rough PR of what this might look like, let me know what you think&lt;/p&gt;</comment>
                            <comment id="17052427" author="mdrob" created="Thu, 5 Mar 2020 18:49:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&#160;- gentle ping on this, would be interested to know what you think of this PR.&lt;/p&gt;</comment>
                            <comment id="17066978" author="jira-bot" created="Wed, 25 Mar 2020 18:48:40 +0000"  >&lt;p&gt;Commit 8d937c1dc38f2117ecf989360133953496aa8c64 in lucene-solr&apos;s branch refs/heads/master from Mike&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8d937c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=8d937c1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14274&quot; title=&quot;Multiple CoreContainers will register the same JVM Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14274&quot;&gt;&lt;del&gt;SOLR-14274&lt;/del&gt;&lt;/a&gt; Do not register multiple sets of JVM metrics (#1299)&lt;/p&gt;
</comment>
                            <comment id="17067191" author="jira-bot" created="Wed, 25 Mar 2020 22:40:36 +0000"  >&lt;p&gt;Commit fe0e1d0b9d90d100cd919e20c0c78192b8ddf741 in lucene-solr&apos;s branch refs/heads/branch_8x from Mike&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=fe0e1d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=fe0e1d0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14274&quot; title=&quot;Multiple CoreContainers will register the same JVM Metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14274&quot;&gt;&lt;del&gt;SOLR-14274&lt;/del&gt;&lt;/a&gt; Do not register multiple sets of JVM metrics (#1299)&lt;/p&gt;
</comment>
                            <comment id="17158445" author="broustant" created="Wed, 15 Jul 2020 15:11:38 +0000"  >&lt;p&gt;Closing after the 8.6.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13323971">SOLR-14770</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bpu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>