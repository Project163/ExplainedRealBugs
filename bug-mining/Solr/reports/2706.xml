<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:09:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8075] Leader Initiated Recovery should not stop a leader that participated in an election with all of it&apos;s replicas from becoming a valid leader.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8075</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Currently, because of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8069&quot; title=&quot;Ensure that only the valid ZooKeeper registered leader can put a replica into Leader Initiated Recovery.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8069&quot;&gt;&lt;del&gt;SOLR-8069&lt;/del&gt;&lt;/a&gt;, all the replicas in a shard can be put into LIR.&lt;/p&gt;

&lt;p&gt;If you restart such a shard, the valid leader will will win the election and sync with the shard and then be blocked from registering as ACTIVE because it is in LIR.&lt;/p&gt;

&lt;p&gt;I think that is a little wonky because I don&apos;t think it even tries another candidate because the leader that cannot publish ACTIVE does not have it&apos;s election canceled.&lt;/p&gt;

&lt;p&gt;While &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8069&quot; title=&quot;Ensure that only the valid ZooKeeper registered leader can put a replica into Leader Initiated Recovery.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8069&quot;&gt;&lt;del&gt;SOLR-8069&lt;/del&gt;&lt;/a&gt; should prevent this situation, we should add logic to allow a leader that can sync with it&apos;s full shard to become leader and publish ACTIVE regardless of LIR.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12894987">SOLR-8075</key>
            <summary>Leader Initiated Recovery should not stop a leader that participated in an election with all of it&apos;s replicas from becoming a valid leader.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Sep 2015 14:53:19 +0000</created>
                <updated>Mon, 9 May 2016 18:46:49 +0000</updated>
                            <resolved>Fri, 13 Nov 2015 22:03:21 +0000</resolved>
                                                    <fixVersion>5.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14899964" author="markrmiller@gmail.com" created="Sun, 20 Sep 2015 15:07:34 +0000"  >&lt;p&gt;Patch with some initial exploration.&lt;/p&gt;</comment>
                            <comment id="14902551" author="markrmiller@gmail.com" created="Tue, 22 Sep 2015 13:01:24 +0000"  >&lt;p&gt;Okay, with this patch, if the proper leader still somehow ends up in LIR, on restart of the shard, if all replicas participate in an election, it will still become leader.&lt;/p&gt;

&lt;p&gt;I&apos;ll open another issue into why this test prevents leadership using a safety catch in publish. My worry with that is that it won&apos;t cancel the election, but that is a separate issue.&lt;/p&gt;</comment>
                            <comment id="14904519" author="markrmiller@gmail.com" created="Wed, 23 Sep 2015 13:39:56 +0000"  >&lt;p&gt;New patch - last one missed my new test.&lt;/p&gt;</comment>
                            <comment id="14904531" author="markrmiller@gmail.com" created="Wed, 23 Sep 2015 13:47:03 +0000"  >&lt;p&gt;One more, updated to trunk and cleaned up a bit.&lt;/p&gt;</comment>
                            <comment id="14904732" author="markrmiller@gmail.com" created="Wed, 23 Sep 2015 16:13:20 +0000"  >&lt;p&gt;Patch getting ready for commit - adds a comment and only clears LIR if the leader is in LIR.&lt;/p&gt;</comment>
                            <comment id="14906959" author="mdrob" created="Thu, 24 Sep 2015 20:35:00 +0000"  >&lt;p&gt;Patch LGTM.&lt;/p&gt;

&lt;p&gt;On commit, can you add a comment to &lt;tt&gt;waitForReplicasToComeUp&lt;/tt&gt; explaining what the return value means? It makes sense now, but in six months I&apos;m pretty sure I won&apos;t have a clue.&lt;/p&gt;</comment>
                            <comment id="14942424" author="markrmiller@gmail.com" created="Sat, 3 Oct 2015 19:41:54 +0000"  >&lt;p&gt;I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="14942551" author="shalinmangar" created="Sun, 4 Oct 2015 04:38:57 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;</comment>
                            <comment id="14942712" author="jira-bot" created="Sun, 4 Oct 2015 16:49:06 +0000"  >&lt;p&gt;Commit 1706699 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1706699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1706699&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8075&quot; title=&quot;Leader Initiated Recovery should not stop a leader that participated in an election with all of it&amp;#39;s replicas from becoming a valid leader.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8075&quot;&gt;&lt;del&gt;SOLR-8075&lt;/del&gt;&lt;/a&gt;: Leader Initiated Recovery should not stop a leader that participated in an election with all of it&apos;s replicas from becoming a valid leader.&lt;/p&gt;</comment>
                            <comment id="14942715" author="jira-bot" created="Sun, 4 Oct 2015 16:55:38 +0000"  >&lt;p&gt;Commit 1706701 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1706701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1706701&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8075&quot; title=&quot;Leader Initiated Recovery should not stop a leader that participated in an election with all of it&amp;#39;s replicas from becoming a valid leader.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8075&quot;&gt;&lt;del&gt;SOLR-8075&lt;/del&gt;&lt;/a&gt;: Leader Initiated Recovery should not stop a leader that participated in an election with all of it&apos;s replicas from becoming a valid leader.&lt;/p&gt;</comment>
                            <comment id="14942716" author="markrmiller@gmail.com" created="Sun, 4 Oct 2015 16:56:08 +0000"  >&lt;p&gt;Thanks for taking a look guys.&lt;/p&gt;</comment>
                            <comment id="15000409" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 14:12:22 +0000"  >&lt;p&gt;There appears to be some race or something here. We need to turn off LIR &lt;b&gt;before&lt;/b&gt; we try and publish ACTIVE upon becoming the leader. The test must only pass because somehow the check beats the ACTIVE publish or something.&lt;/p&gt;</comment>
                            <comment id="15000428" author="ichattopadhyaya" created="Wed, 11 Nov 2015 14:26:35 +0000"  >&lt;p&gt;How can I investigate / reproduce this? Is the LeaderInitiatedRecoveryOnShardRestartTest failing under certain circumstances?&lt;/p&gt;</comment>
                            <comment id="15000452" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 14:49:33 +0000"  >&lt;p&gt;Patch with fix.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;How can I investigate / reproduce this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Don&apos;t know. Saw it not working on a real cluster.&lt;/p&gt;

&lt;p&gt;I also saw the shard get stuck with no proper leader still due to the proper leader being in LIR. It seems LIR is still a little buggy. Fixing this should be one step towards alleviating that.&lt;/p&gt;

&lt;p&gt;I&apos;m going to work on a test that indexes while restarting the whole cluster and see if I can reproduce some of those bugs.&lt;/p&gt;</comment>
                            <comment id="15000465" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 14:57:05 +0000"  >&lt;p&gt;Hmm...this still needs a little tweaking I think.&lt;/p&gt;</comment>
                            <comment id="15000604" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 16:30:12 +0000"  >&lt;p&gt;New patch.&lt;/p&gt;</comment>
                            <comment id="15000683" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 17:02:11 +0000"  >&lt;p&gt;The latest patch also fixes LIR handling a bit. The way things worked were a little off.&lt;/p&gt;

&lt;p&gt;If you were the first replica to attempt to be leader, LIR would never stop you early. Instead, things would fail when publish ACTIVE was attempted. That is not good, because it will probably prevent the next leader from trying to take over.&lt;/p&gt;

&lt;p&gt;So I have moved all the LIR checking code in ElectionContext to a new spot. It&apos;s always checked, first attempted leader or not. And not until we see if the replica &lt;b&gt;could&lt;/b&gt; be leader and if all the replicas participated in that election or not.&lt;/p&gt;</comment>
                            <comment id="15002875" author="mdrob" created="Thu, 12 Nov 2015 20:33:36 +0000"  >&lt;p&gt;Update looks good to me. I know you expanded the comments in &lt;tt&gt;checkLIR&lt;/tt&gt;, but can you add a one-line note before the method is called with something to the effect of &quot;needs to happen synchronously before setLeader(true) to avoid rejection?&quot;&lt;/p&gt;</comment>
                            <comment id="15002892" author="markrmiller@gmail.com" created="Thu, 12 Nov 2015 20:42:41 +0000"  >&lt;p&gt;It&apos;s not that it needs to happen before setLeader. The pertinent move it putting it above the super. call.&lt;/p&gt;</comment>
                            <comment id="15002901" author="markrmiller@gmail.com" created="Thu, 12 Nov 2015 20:49:55 +0000"  >&lt;p&gt;Also, the logic here is changed. We now do LIR prevention checks in checkLIR as well. I think it clearly has to come before we declare being the leader. Previously, it was not a checkLIR call - it was logic to just possibly turn LIR off for that replica.&lt;/p&gt;</comment>
                            <comment id="15002905" author="markrmiller@gmail.com" created="Thu, 12 Nov 2015 20:51:41 +0000"  >&lt;p&gt;I&apos;ll add a little comment above checkLIR: we must check LIR before registering as leader&lt;/p&gt;</comment>
                            <comment id="15003133" author="gchanan" created="Thu, 12 Nov 2015 22:52:28 +0000"  >&lt;p&gt;Patch looks good, thanks Mark!&lt;/p&gt;

&lt;p&gt;A comment outside the scope of this JIRA (I know this is pre-existing logic), but which I can&apos;t find a better place for:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+          &lt;span class=&quot;code-comment&quot;&gt;// We can &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; before registering as leader because only setting DOWN requires that
&lt;/span&gt;+          &lt;span class=&quot;code-comment&quot;&gt;// we are leader, and here we are setting ACTIVE
&lt;/span&gt;+          zkController.updateLeaderInitiatedRecoveryState(collection, shardId,
+              leaderProps.getStr(ZkStateReader.CORE_NODE_NAME_PROP), Replica.State.ACTIVE, core.getCoreDescriptor(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This seems difficult to reason about given that there are multiple non-commutative writers potentially racing here: a leader setting DOWN and this node setting ACTIVE.  It would be easier to reason about if there were two states:&lt;br/&gt;
1) leaders view of the world&lt;br/&gt;
2) replicas view of the world (i.e. telling the Overseer I know the leader thinks I&apos;m in LIR but I know some special information and I&apos;m telling you for this election # I&apos;m OK).  That could go in the ZKNodeProps sent to the Overseer (or a separate znode) and the Overseer could do the correct logic with it.&lt;/p&gt;

&lt;p&gt;Anyway, outside of the scope of the jira, just wanted to jot my thoughts down.  if you think this is a valid improvement I can file a jira for it.&lt;/p&gt;</comment>
                            <comment id="15003174" author="markrmiller@gmail.com" created="Thu, 12 Nov 2015 23:18:32 +0000"  >&lt;p&gt;This node has to be the leader in the zk election line at this place it sets active - so there cannot be another valid leader.&lt;/p&gt;</comment>
                            <comment id="15003197" author="markrmiller@gmail.com" created="Thu, 12 Nov 2015 23:32:16 +0000"  >&lt;p&gt;I&apos;d file a JIRA issue to track the idea. It wouldn&apos;t be bad to tighten this up.&lt;/p&gt;</comment>
                            <comment id="15003209" author="gchanan" created="Thu, 12 Nov 2015 23:39:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;This node has to be the leader in the zk election line at this place it sets active - so there cannot be another valid leader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, my point is just:&lt;br/&gt;
1) that&apos;s true now, maybe not always true&lt;br/&gt;
2) that&apos;s more to reason about, better to keep things as simple as possible, at least where state is concerned&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;d file a JIRA issue to track the idea. It wouldn&apos;t be bad to tighten this up.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will do, thanks.&lt;/p&gt;</comment>
                            <comment id="15003992" author="jira-bot" created="Fri, 13 Nov 2015 13:40:53 +0000"  >&lt;p&gt;Commit 1714204 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1714204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1714204&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8075&quot; title=&quot;Leader Initiated Recovery should not stop a leader that participated in an election with all of it&amp;#39;s replicas from becoming a valid leader.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8075&quot;&gt;&lt;del&gt;SOLR-8075&lt;/del&gt;&lt;/a&gt;: Fix faulty implementation.&lt;/p&gt;</comment>
                            <comment id="15003997" author="jira-bot" created="Fri, 13 Nov 2015 13:45:39 +0000"  >&lt;p&gt;Commit 1714205 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1714205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1714205&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8075&quot; title=&quot;Leader Initiated Recovery should not stop a leader that participated in an election with all of it&amp;#39;s replicas from becoming a valid leader.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8075&quot;&gt;&lt;del&gt;SOLR-8075&lt;/del&gt;&lt;/a&gt;: Fix faulty implementation.&lt;/p&gt;</comment>
                            <comment id="15048886" author="markrmiller@gmail.com" created="Wed, 9 Dec 2015 16:03:45 +0000"  >&lt;p&gt;Note that this needs &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8367&quot; title=&quot;The new LIR &amp;#39;all replicas participate&amp;#39; failsafe code needs to be improved.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8367&quot;&gt;&lt;del&gt;SOLR-8367&lt;/del&gt;&lt;/a&gt; to be complete.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12895780">SOLR-8087</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12875394">SOLR-8069</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12918667">SOLR-8367</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12771781" name="SOLR-8075.patch" size="8328" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 16:35:56 +0000"/>
                            <attachment id="12771780" name="SOLR-8075.patch" size="7794" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 16:30:12 +0000"/>
                            <attachment id="12771757" name="SOLR-8075.patch" size="4855" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 14:47:15 +0000"/>
                            <attachment id="12761921" name="SOLR-8075.patch" size="7848" author="markrmiller@gmail.com" created="Wed, 23 Sep 2015 16:13:20 +0000"/>
                            <attachment id="12761894" name="SOLR-8075.patch" size="6760" author="markrmiller@gmail.com" created="Wed, 23 Sep 2015 13:47:03 +0000"/>
                            <attachment id="12761890" name="SOLR-8075.patch" size="7115" author="markrmiller@gmail.com" created="Wed, 23 Sep 2015 13:39:56 +0000"/>
                            <attachment id="12761334" name="SOLR-8075.patch" size="3342" author="markrmiller@gmail.com" created="Sun, 20 Sep 2015 15:07:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2lbmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>