<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13829] RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13829</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In trying to use the &quot;sort&quot; streaming evaluator on float field (pfloat), I am getting casting errors back based upon which values are calculated based upon underlying values in a field.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Docs:&lt;/b&gt; (paste each into &quot;Documents&quot; pane in Solr Admin UI as type:&quot;json&quot;)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;donut&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;vector_fs&quot;&lt;/span&gt;:[5.0,0.0,1.0,5.0,0.0,4.0,5.0,1.0]}

{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;cheese pizza&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;vector_fs&quot;&lt;/span&gt;:[5.0,0.0,4.0,4.0,0.0,1.0,5.0,2.0]}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Streaming Expression:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sort(select(search(food_collection, q=&lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;, fl=&lt;span class=&quot;code-quote&quot;&gt;&quot;id,vector_fs&quot;&lt;/span&gt;, sort=&lt;span class=&quot;code-quote&quot;&gt;&quot;id asc&quot;&lt;/span&gt;), cosineSimilarity(vector_fs, array(5.0,0.0,1.0,5.0,0.0,4.0,5.0,1.0)) as sim, id), by=&lt;span class=&quot;code-quote&quot;&gt;&quot;sim desc&quot;&lt;/span&gt;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Response:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{ 
  &lt;span class=&quot;code-quote&quot;&gt;&quot;result-set&quot;&lt;/span&gt;: {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;docs&quot;&lt;/span&gt;: [
      {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;EXCEPTION&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; (java.lang.&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; and java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; are in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;)&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;EOF&quot;&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;RESPONSE_TIME&quot;&lt;/span&gt;: 13
      }
    ]
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is because in org.apache.solr.client.solrj.io.eval.RecursiveEvaluator, there is a line which examines a numeric (BigDecimal) value and - regardless of the type of the field the value originated from - converts it to a Long if it looks like a whole number. This is the code in question from that class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; normalizeOutputType(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; value) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == value){
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; VectorFunction) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; BigDecimal){
      BigDecimal bd = (BigDecimal)value;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(bd.signum() == 0 || bd.scale() &amp;lt;= 0 || bd.stripTrailingZeros().scale() &amp;lt;= 0){
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bd.longValueExact();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(ArithmeticException e){
          &lt;span class=&quot;code-comment&quot;&gt;// value was too big &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, so use a &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; which can handle scientific notation
&lt;/span&gt;        }
      }
      
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bd.doubleValue();
    }
... [other type conversions]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Because of the &lt;b&gt;return bd.longValueExact()&lt;/b&gt;; line, the calculated value for &quot;sim&quot; in doc 1 is &quot;Float(1)&quot;, whereas the calculated value for &quot;sim&quot; for doc 2 is &quot;Double(0.88938313). These are coming back as incompatible data types, even though the source data is all of the same type and should be comparable.&lt;/p&gt;

&lt;p&gt;Thus when the &lt;b&gt;sort&lt;/b&gt; evaluator streaming expression (and probably others) runs on these calculated values and the list should contain&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;0.88938313&amp;quot;, &amp;quot;1.0&amp;quot;&amp;#93;&lt;/span&gt;, an exception is thrown because the it&apos;s trying to compare incompatible data types&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;Double(&amp;quot;0.99&amp;quot;), Long(1)&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;This bug is occurring on master currently, but has probably existed in the codebase since at least August 2017.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13261184">SOLR-13829</key>
            <summary>RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10003">Resolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="solrtrey">Trey Grainger</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Oct 2019 19:46:49 +0000</created>
                <updated>Sat, 15 Feb 2020 21:49:02 +0000</updated>
                            <resolved>Fri, 11 Oct 2019 13:06:09 +0000</resolved>
                                                    <fixVersion>8.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16947161" author="solrtrey" created="Tue, 8 Oct 2019 19:52:55 +0000"  >&lt;p&gt;Removing the code that converts incoming BigDecimals to a Long fixes the issue, and all Solr tests pass once that is done.&#160;&#160;I&apos;ll upload a patch shortly that makes this change.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if this potentially creates any side effects (i.e. loss of precision on certain calculations that went through multiple data type transformations) that were intended to be avoided by that code. Perhaps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dpgove&quot; class=&quot;user-hover&quot; rel=&quot;dpgove&quot;&gt;dpgove&lt;/a&gt;&#160;or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt;&#160;may know the reason for that original conversion of BigDecimals to longs and could shed some light.&lt;/p&gt;

&lt;p&gt;The other way to solve this would be to modify every streaming expression (like the sort evaluator) to explicitly do type checking and conversions anytime incompatible types are being compared, but this feels inefficient and I&apos;m assuming probably not like the right approach unless doing it that way was an intentional design decision in how the streaming expressions framework is intending to handle data types.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16947245" author="solrtrey" created="Tue, 8 Oct 2019 23:37:02 +0000"  >&lt;p&gt;Submitted a github pull request (just saw on mailing list that has now replaced patch files as the preferred means of submitting changes). Would welcome review and feedback. Thanks!&lt;/p&gt;</comment>
                            <comment id="16948552" author="joel.bernstein" created="Thu, 10 Oct 2019 12:46:22 +0000"  >&lt;p&gt;Yeah this is ugly. Your fix looks good. I see no need to be switching to a long. I&apos;ll get this fix in shortly and see if I can get it back ported for the 8.3 release.&lt;/p&gt;</comment>
                            <comment id="16948695" author="joel.bernstein" created="Thu, 10 Oct 2019 15:31:42 +0000"  >&lt;p&gt;I added a patch that fixes the issue. There were lot&apos;s of tests that broke because they were expecting Longs and I changed those tests so they didn&apos;t do that anymore. In general the test cases should not be expecting specific types unless the underlying function is enforcing a particular return type as part of its contract. An example of this would be the ceil, floor and round functions which always return discrete values. Currently these functions actually return doubles. But the right way to fix this is to have the functions themselves return the long rather than having one wrapper class with rules for when to return a long rather than a double.&lt;/p&gt;

&lt;p&gt;All of the underlying functions that I looked at were returning either doubles or BigDecimals which will now be returned as doubles always. There is no more conversion to longs on the output.&#160;&lt;/p&gt;

&lt;p&gt;If someone specifically wants to convert to a long the &lt;b&gt;long&lt;/b&gt; function exists for that purpose.&lt;/p&gt;

&lt;p&gt;Hopefully this will clear up all cases of type mismatch with comparators.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16948700" author="joel.bernstein" created="Thu, 10 Oct 2019 15:32:47 +0000"  >&lt;p&gt;I&apos;ll test some more this evening and commit if all looks good.&lt;/p&gt;</comment>
                            <comment id="16948874" author="solrtrey" created="Thu, 10 Oct 2019 18:46:31 +0000"  >&lt;p&gt;Awesome - thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16949043" author="jira-bot" created="Fri, 11 Oct 2019 01:25:14 +0000"  >&lt;p&gt;Commit ad1c24e1903a74c611ec610aaf350d50d709519e in lucene-solr&apos;s branch refs/heads/master from Joel Bernstein&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ad1c24e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ad1c24e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13829&quot; title=&quot;RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13829&quot;&gt;&lt;del&gt;SOLR-13829&lt;/del&gt;&lt;/a&gt;: RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&lt;/p&gt;</comment>
                            <comment id="16949048" author="jira-bot" created="Fri, 11 Oct 2019 01:32:31 +0000"  >&lt;p&gt;Commit f38ce1a815a1890a3fe7a0c633cf3720fa850902 in lucene-solr&apos;s branch refs/heads/branch_8x from Joel Bernstein&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f38ce1a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f38ce1a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13829&quot; title=&quot;RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13829&quot;&gt;&lt;del&gt;SOLR-13829&lt;/del&gt;&lt;/a&gt;: RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&lt;/p&gt;</comment>
                            <comment id="16949053" author="jira-bot" created="Fri, 11 Oct 2019 01:50:40 +0000"  >&lt;p&gt;Commit 821d30604b091d9ef6f915544f4d2edcaa4cb8ef in lucene-solr&apos;s branch refs/heads/branch_8_3 from Joel Bernstein&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=821d306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=821d306&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13829&quot; title=&quot;RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13829&quot;&gt;&lt;del&gt;SOLR-13829&lt;/del&gt;&lt;/a&gt;: RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&lt;/p&gt;</comment>
                            <comment id="16949422" author="jira-bot" created="Fri, 11 Oct 2019 13:03:11 +0000"  >&lt;p&gt;Commit bed9e7c47432777ff09fa8d03d435ad0e59b518a in lucene-solr&apos;s branch refs/heads/master from Joel Bernstein&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=bed9e7c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=bed9e7c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13829&quot; title=&quot;RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13829&quot;&gt;&lt;del&gt;SOLR-13829&lt;/del&gt;&lt;/a&gt;: Update CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="16949424" author="jira-bot" created="Fri, 11 Oct 2019 13:04:42 +0000"  >&lt;p&gt;Commit 946df69a8ada8545aef04d653eed8c5fc632ce99 in lucene-solr&apos;s branch refs/heads/branch_8x from Joel Bernstein&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=946df69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=946df69&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13829&quot; title=&quot;RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13829&quot;&gt;&lt;del&gt;SOLR-13829&lt;/del&gt;&lt;/a&gt;: Update CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="16949427" author="jira-bot" created="Fri, 11 Oct 2019 13:05:41 +0000"  >&lt;p&gt;Commit 30feba4045967a95820af670d4e8a9b02e57b536 in lucene-solr&apos;s branch refs/heads/branch_8_3 from Joel Bernstein&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=30feba4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=30feba4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13829&quot; title=&quot;RecursiveEvaluator casts Continuous numbers to Discrete Numbers, causing mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13829&quot;&gt;&lt;del&gt;SOLR-13829&lt;/del&gt;&lt;/a&gt;: Update CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="16950126" author="dpgove" created="Sat, 12 Oct 2019 20:49:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;The other way to solve this would be to modify every streaming expression (like the sort evaluator) to explicitly do type checking and conversions anytime incompatible types are being compared&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Alternatively that modification could be in the&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/solrj/src/java/org/apache/solr/client/solrj/io/comp/FieldComparator.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FieldComparator&lt;/a&gt; class to keep it centralized and consistent.&lt;/p&gt;

&lt;p&gt;The purpose of this conversion to &lt;tt&gt;long&lt;/tt&gt; was to ensure that values that could be represented as scaler values would be. When Evaluators were added there was a need to choose a singular datatype to represent all numeric values within Evaluators, so that comparison and conversion could be done without needing to repeatedly check the value datatypes. The use of BigDecimal was deliberate in that it is able to accurately represent all existing datatypes without the possibly of loss of precision (this is specifically the reason why &lt;tt&gt;double/Double&lt;/tt&gt; were not used). While &lt;tt&gt;Evaluators&lt;/tt&gt; are turning longs and doubles into &lt;tt&gt;BigDecimals&lt;/tt&gt; on the way in there was a need to do the inverse on the way out - that is the impetus for that conversion code to exist.&lt;/p&gt;

&lt;p&gt;I think it&apos;s reasonable to expect &lt;tt&gt;SortStream&lt;/tt&gt; to be able to sort on a field containing a mixture of numeric types. It should be able to handle that. What this patch does is instead insist that every value be the same type (double).&lt;/p&gt;

&lt;p&gt;That said, yes, there was a bug in how the choice was made over which type to convert the value to. I worry that this fix potentially adds latent numeric precision errors.&lt;/p&gt;</comment>
                            <comment id="16950460" author="joel.bernstein" created="Sun, 13 Oct 2019 19:54:16 +0000"  >&lt;p&gt;Let&apos;s open a separate issue to decide on a way forward. I&apos;ll comment first here and then open the ticket.&lt;/p&gt;

&lt;p&gt;The issue of how to handle precision is an interesting question. I&apos;d like to suggest the following approach:&lt;/p&gt;

&lt;p&gt;1) Each math function returns a consistent type (long, double, bigdecimal) based on its design. For example if a function does high precision floating point math it returns a bigdecimal. If it always returns a whole number then it should return a long. If it doesn&apos;t do high precision floating point math it should return a double. Vector math and matrix math traditionally return double arrays and matrices, and I think this convention should be followed.&lt;/p&gt;

&lt;p&gt;It&apos;s important to note that 90% of the math functions are implemented by Apache Commons Math which may or may not be using high precision techniques. So precision is going to be lost in places that we don&apos;t control.&lt;/p&gt;

&lt;p&gt;2) All functions should expect Numbers for parameters and convert to what it expects internally.&#160;&lt;/p&gt;

&lt;p&gt;3) Users can use the &lt;b&gt;precision&lt;/b&gt; function to manage floating point error if they choose to.&#160;A typical approach is to use 5 decimal places of precision to eliminate the floating point errors. This can be done in a stream before adding numbers to an aggregation, following an aggregation or applied after any of the math functions that are not operating with high precision.&lt;/p&gt;

&lt;p&gt;What I like about this approach is that it&apos;s consistent internally, easily explainable, consistent with how other numeric systems like excel operate and provides techniques for achieving a specific level of precision if the user wants it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12982697" name="SOLR-13829.patch" size="24384" author="jbernste" created="Thu, 10 Oct 2019 15:23:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07eiw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>