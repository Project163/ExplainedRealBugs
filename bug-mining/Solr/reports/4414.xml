<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:42:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13089] bin/solr&apos;s use of lsof has some issues</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13089</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The &lt;tt&gt;bin/solr&lt;/tt&gt; script uses this &lt;tt&gt;lsof&lt;/tt&gt; invocation to check if the Solr port is being listened on:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;running=`lsof -PniTCP:$SOLR_PORT -sTCP:LISTEN`
if [ -z &quot;$running&quot; ]; then
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;code is at &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/bin/solr#L2147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;There are a few issues with this.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;1.Falsenegativeswhenportisoccupiedbydifferentuser&quot;&gt;&lt;/a&gt;1. False negatives when port is occupied by different user&lt;/h2&gt;

&lt;p&gt;When &lt;tt&gt;lsof&lt;/tt&gt; runs as non-root, it only shows sockets for processes with your effective uid.&lt;br/&gt;
 For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ id -u &amp;amp;&amp;amp; nc -l 7788 &amp;amp;
[1] 26576
1000

#### works: nc ran as my user
$ lsof -PniTCP:7788 -sTCP:LISTEN
COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
nc      26580  mak    3u  IPv4 2818104      0t0  TCP *:7788 (LISTEN)

#### fails: ssh is running as root
$ lsof -PniTCP:22 -sTCP:LISTEN

#### works if we are root
$ sudo lsof -PniTCP:22 -sTCP:LISTEN
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd    2524 root    3u  IPv4  18426      0t0  TCP *:22 (LISTEN)
sshd    2524 root    4u  IPv6  18428      0t0  TCP *:22 (LISTEN)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Solr runs as non-root.&lt;br/&gt;
 So if some other process owned by a different user occupies that port, you will get a false negative (it will say Solr is not running even though it is)&lt;br/&gt;
 I can&apos;t think of a good way to fix or work around that (short of not using &lt;tt&gt;lsof&lt;/tt&gt; in the first place).&lt;br/&gt;
 Perhaps an uncommon scenario we need not worry too much about.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;2.lsofcancomplainaboutlackof%2Fetc%2Fpasswordentries&quot;&gt;&lt;/a&gt;2. lsof can complain about lack of /etc/password entries&lt;/h2&gt;

&lt;p&gt;If &lt;tt&gt;lsof&lt;/tt&gt; runs without the current effective user having an entry in &lt;tt&gt;/etc/passwd&lt;/tt&gt;,&lt;br/&gt;
 it produces a warning on stderr:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ docker run -d -u 0 solr:7.6.0  bash -c &quot;chown -R 8888 /opt/; gosu 8888 solr-foreground&quot;
4397c3f51d4a1cfca7e5815e5b047f75fb144265d4582745a584f0dba51480c6

$ docker exec -it -u 8888 4397c3f51d4a1cfca7e5815e5b047f75fb144265d4582745a584f0dba51480c6 bash
I have no name!@4397c3f51d4a:/opt/solr$ lsof -PniTCP:8983 -sTCP:LISTEN
lsof: no pwd entry for UID 8888
COMMAND PID     USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
lsof: no pwd entry for UID 8888
java      9     8888  115u  IPv4 2813503      0t0  TCP *:8983 (LISTEN)
I have no name!@4397c3f51d4a:/opt/solr$ lsof -PniTCP:8983 -sTCP:LISTEN&amp;gt;/dev/null
lsof: no pwd entry for UID 8888
lsof: no pwd entry for UID 8888
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can avoid this by using the &lt;tt&gt;-t&lt;/tt&gt; tag, which specifies that lsof should produce terse output with process identifiers only and no header:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;I have no name!@4397c3f51d4a:/opt/solr$ lsof -t -PniTCP:8983 -sTCP:LISTEN
9
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is a rare circumstance, but one I encountered and worked around.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;3.OnAlpine%2Clsofisimplementedbybusybox%2Cbutwithincompatiblearguments&quot;&gt;&lt;/a&gt;3. On Alpine, lsof is implemented by busybox, but with incompatible arguments&lt;/h2&gt;

&lt;p&gt;On Alpine, &lt;tt&gt;busybox&lt;/tt&gt; implements &lt;tt&gt;lsof&lt;/tt&gt;, but does not support the arguments, so you get:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ docker run -it alpine sh
/ # lsof -t -PniTCP:8983 -sTCP:LISTEN
1	/bin/busybox	/dev/pts/0
1	/bin/busybox	/dev/pts/0
1	/bin/busybox	/dev/pts/0
1	/bin/busybox	/dev/tty
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so if you ran Solr, in the background, and it failed to start, this code would produce a false positive.&lt;br/&gt;
 For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;docker volume create mysol
docker run -v mysol:/mysol bash bash -c &quot;chown 8983:8983 /mysol&quot;
docker run -it -v mysol:/mysol -w /mysol -v $HOME/Downloads/solr-7.6.0.tgz:/solr-7.6.0.tgz openjdk:8-alpine sh
apk add procps bash
tar xvzf /solr-7.6.0.tgz
chown -R 8983:8983 .
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then in a separate terminal:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ docker exec -it -u 8983 serene_saha  sh
/mysol $ SOLR_OPTS=--invalid ./solr-7.6.0/bin/solr start
whoami: unknown uid 8983
Waiting up to 180 seconds to see Solr running on port 8983 [|]  
Started Solr server on port 8983 (pid=101). Happy searching!

/mysol $ 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and in another separate terminal:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ docker exec -it thirsty_liskov bash

bash-4.4$ cat server/logs/solr-8983-console.log 
Unrecognized option: --invalid
Error: Could not create the Java Virtual Machine.
Error: A fatal exception has occurred. Program will exit.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so it is saying Solr is running, when it isn&apos;t.&lt;/p&gt;

&lt;p&gt;Now, all this can be avoided by just installing the real &lt;tt&gt;lsof&lt;/tt&gt; with &lt;tt&gt;apk add lsof&lt;/tt&gt; which works properly. So should we detect and warn? Or even refuse to run rather than invoke a tool that does not implement the contract we expect?&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;4.Shellcheckdislikesbackticks&quot;&gt;&lt;/a&gt;4. Shellcheck dislikes backticks&lt;/h2&gt;

&lt;p&gt;Shellcheck says &lt;tt&gt;SC2006: Use $(..) instead of legacy `..`.&lt;/tt&gt;&lt;br/&gt;
 Now, shellcheck complains about 130 other issues too, so it&apos;s a drop in a bucket, but if we&apos;re changing things, might as well fix that.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13205960">SOLR-13089</key>
            <summary>bin/solr&apos;s use of lsof has some issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janhoy">Jan H&#248;ydahl</assignee>
                                    <reporter username="makuk66">Martijn Koster</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Dec 2018 12:52:06 +0000</created>
                <updated>Tue, 24 Mar 2020 12:45:19 +0000</updated>
                            <resolved>Mon, 6 Jan 2020 12:21:18 +0000</resolved>
                                                    <fixVersion>8.5</fixVersion>
                                    <component>SolrCLI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17008443" author="janhoy" created="Sun, 5 Jan 2020 23:17:21 +0000"  >&lt;p&gt;Don&apos;t know if this is necessary still, at least docker-solr is now not on Alpine anymore.&lt;/p&gt;

&lt;p&gt;However, I uploaded a patch with a proposal for a simpler fix. We just replace the &lt;tt&gt;hash lsof&lt;/tt&gt; check&#160;with your check and instead of a hard exit we revert to the same sleep 10 logic as is used when lsof is not found.&lt;/p&gt;</comment>
                            <comment id="17008684" author="makuk66" created="Mon, 6 Jan 2020 09:47:17 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="17008796" author="jira-bot" created="Mon, 6 Jan 2020 12:20:41 +0000"  >&lt;p&gt;Commit ac777a5352224b2c8f46836f0e078809308fc2d8 in lucene-solr&apos;s branch refs/heads/master from Martijn Koster&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ac777a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ac777a5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13089&quot; title=&quot;bin/solr&amp;#39;s use of lsof has some issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13089&quot;&gt;&lt;del&gt;SOLR-13089&lt;/del&gt;&lt;/a&gt;: Fix lsof edge cases in the solr CLI script&lt;/p&gt;</comment>
                            <comment id="17008798" author="jira-bot" created="Mon, 6 Jan 2020 12:21:20 +0000"  >&lt;p&gt;Commit 2aa739ae873b8b1c9dac4a42daa9e790ebdf700e in lucene-solr&apos;s branch refs/heads/branch_8x from Martijn Koster&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=2aa739a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=2aa739a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13089&quot; title=&quot;bin/solr&amp;#39;s use of lsof has some issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13089&quot;&gt;&lt;del&gt;SOLR-13089&lt;/del&gt;&lt;/a&gt;: Fix lsof edge cases in the solr CLI script&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ac777a5352224b2c8f46836f0e078809308fc2d8)&lt;/p&gt;</comment>
                            <comment id="17009441" author="jira-bot" created="Tue, 7 Jan 2020 07:47:13 +0000"  >&lt;p&gt;Commit ac777a5352224b2c8f46836f0e078809308fc2d8 in lucene-solr&apos;s branch refs/heads/gradle-master from Martijn Koster&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ac777a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ac777a5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13089&quot; title=&quot;bin/solr&amp;#39;s use of lsof has some issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13089&quot;&gt;&lt;del&gt;SOLR-13089&lt;/del&gt;&lt;/a&gt;: Fix lsof edge cases in the solr CLI script&lt;/p&gt;</comment>
                            <comment id="17065629" author="romseygeek" created="Tue, 24 Mar 2020 12:45:18 +0000"  >&lt;p&gt;Bulk close for 8.5.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12952681" name="0001-SOLR-13089-lsof-fixes.patch" size="1542" author="makuk66" created="Fri, 21 Dec 2018 13:28:02 +0000"/>
                            <attachment id="12989971" name="SOLR-13089.patch" size="1497" author="janhoy" created="Sun, 5 Jan 2020 23:15:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u008cg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>