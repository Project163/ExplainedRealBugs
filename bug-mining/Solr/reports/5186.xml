<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:10:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17274] atomic update error when using json w/ multiple modifiers</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17274</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I ran into a problem doing a json atomic update that tries to both `add` and `remove` a value for a multivalued field in a single update. I saw it initially in an instance that runs 9.5.0, and reproduced a minimal example using Solr 9.6.0.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;The only fields defined in the schema are:&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &amp;lt;field name=&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;string&quot;&lt;/span&gt; multiValued=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; indexed=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; required=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; stored=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
&#160; &amp;lt;field name=&lt;span class=&quot;code-quote&quot;&gt;&quot;_version_&quot;&lt;/span&gt; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;plong&quot;&lt;/span&gt; indexed=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; stored=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
  &amp;lt;field name=&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;strings&quot;&lt;/span&gt; indexed=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; stored=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;`&amp;lt;uniqueKey&amp;gt;id&amp;lt;/uniqueKey&amp;gt;` is also present, so I&apos;m supplying docs with just an `id` and a multivalued `name` field. The real setup is more complex, but this is a minimal test case to illustrate the problem.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Starting with an empty index, I add the following doc to the index successfully:&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: [&lt;span class=&quot;code-quote&quot;&gt;&quot;John Doe&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Jane Doe&quot;&lt;/span&gt;]}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;And I can query it, seeing the expected result:&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;responseHeader&quot;&lt;/span&gt;:{
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;:0,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;QTime&quot;&lt;/span&gt;:23,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;params&quot;&lt;/span&gt;:{
&#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;name:*&quot;&lt;/span&gt;
&#160; &#160; }
&#160; },
&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;response&quot;&lt;/span&gt;:{
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;numFound&quot;&lt;/span&gt;:1,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt;:0,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;numFoundExact&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;docs&quot;&lt;/span&gt;:[{
&#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
&#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;John Doe&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;Jane Doe&quot;&lt;/span&gt;],
&#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;_version_&quot;&lt;/span&gt;:1797873599884820480
&#160; &#160; }]
&#160; }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;Next, I send an atomic update to modify the `name` field of that document by removing `Jane Doe` and adding `Janet Doe`:&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: {&lt;span class=&quot;code-quote&quot;&gt;&quot;add&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Janet Doe&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;remove&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Jane Doe&quot;&lt;/span&gt;}}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;This atomic update that does both an `add` and a `remove` is something that used to work for us under Solr 6.6, but we just noticed that it fails in our production 9.5 instance and in 9.6, which I just downloaded to test against.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;The error in the solr.log indicates that Solr mistakenly interprets the `{&quot;add&quot;: &quot;Janet Doe&quot;, &quot;remove&quot;: &quot;Jane Doe&quot;}` as a nested document and then throws an exception because our schema doesn&apos;t have the `&lt;em&gt;root&lt;/em&gt;` field that would be expected if we were using nested docs (which we don&apos;t use).&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Here&apos;s the full stack trace from `solr.log` (version 9.6.0):&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2024-05-01 17:49:02.479 ERROR (qtp2059461664-30-0.0.0.0-3) [c: s: r: x:atris t:0.0.0.0-3] o.a.s.h.RequestHandlerBase Client exception =&amp;gt; org.apache.solr.common.SolrException: Unable to index docs with children: the schema must include definitions for both a uniqueKey field and the &apos;_root_&apos; field, using the exact same fieldType
&#160; &#160; &#160; &#160; at org.apache.solr.update.DocumentBuilder.unexpectedNestedDocException(DocumentBuilder.java:369)
org.apache.solr.common.SolrException: Unable to index docs with children: the schema must include definitions for both a uniqueKey field and the &apos;_root_&apos; field, using the exact same fieldType
&#160; &#160; &#160; &#160; at org.apache.solr.update.DocumentBuilder.unexpectedNestedDocException(DocumentBuilder.java:369) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.DocumentBuilder.toDocument(DocumentBuilder.java:153) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.AddUpdateCommand.makeLuceneDocs(AddUpdateCommand.java:213) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.DirectUpdateHandler2.updateDocOrDocValues(DirectUpdateHandler2.java:1056) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.DirectUpdateHandler2.doNormalUpdate(DirectUpdateHandler2.java:421) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:375) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:312) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.RunUpdateProcessorFactory$RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:76) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:54) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:270) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.DistributedUpdateProcessor.doVersionAdd(DistributedUpdateProcessor.java:533) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.DistributedUpdateProcessor.lambda$versionAdd$0(DistributedUpdateProcessor.java:358) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.VersionBucket.runWithLock(VersionBucket.java:43) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:355) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:236) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:111) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.handleAdds(JsonLoader.java:553) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.processUpdate(JsonLoader.java:183) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.load(JsonLoader.java:151) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.loader.JsonLoader.load(JsonLoader.java:86) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:102) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:100) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:226) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.core.SolrCore.execute(SolrCore.java:2886) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.HttpSolrCall.executeCoreRequest(HttpSolrCall.java:910) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:596) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.SolrDispatchFilter.dispatch(SolrDispatchFilter.java:262) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.SolrDispatchFilter.lambda$doFilter$0(SolrDispatchFilter.java:219) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.ServletUtils.traceHttpRequestExecution2(ServletUtils.java:249) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.ServletUtils.rateLimitRequest(ServletUtils.java:215) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:213) ~[?:?]
&#160; &#160; &#160; &#160; at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:195) ~[?:?]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:210) ~[jetty-servlet-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1635) ~[jetty-servlet-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:527) ~[jetty-servlet-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:131) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:598) ~[jetty-security-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:122) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:223) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1580) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:221) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1384) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:176) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:484) ~[jetty-servlet-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1553) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:174) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1306) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:129) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:149) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.InetAccessHandler.handle(InetAccessHandler.java:228) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:141) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:122) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:301) ~[jetty-rewrite-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:122) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:822) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:122) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.Server.handle(Server.java:563) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.HttpChannel$RequestDispatchable.dispatch(HttpChannel.java:1598) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:753) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:501) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:287) ~[jetty-server-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:314) ~[jetty-io-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:100) ~[jetty-io-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.io.SelectableChannelEndPoint$1.run(SelectableChannelEndPoint.java:53) ~[jetty-io-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.runTask(AdaptiveExecutionStrategy.java:421) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.consumeTask(AdaptiveExecutionStrategy.java:390) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.tryProduce(AdaptiveExecutionStrategy.java:277) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.produce(AdaptiveExecutionStrategy.java:193) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:969) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.doRunJob(QueuedThreadPool.java:1194) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1149) ~[jetty-util-10.0.20.jar:10.0.20]
&#160; &#160; &#160; &#160; at java.base/java.lang.Thread.run(Thread.java:829) [?:?]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
In case it matters, the update handler was called with `commitWithin=1000`.&lt;br/&gt;
&#160;&lt;br/&gt;
I believe this is happening because as part of commit 5a9a34daedb3 on 2021-06-12&#160; (&quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15044&quot; title=&quot;Update JSON syntax: detect nested documents via schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15044&quot;&gt;&lt;del&gt;SOLR-15044&lt;/del&gt;&lt;/a&gt;: JSON Loading: nested docs don&apos;t need ID&quot;), the `isChildDoc` method of solr/core/src/java/org/apache/solr/handler/loader/JsonLoader.java was changed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+ &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;/** Is &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; a child doc (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) or a partial update (&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)? */&lt;/span&gt;
&#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isChildDoc(SolrInputDocument extendedFieldValue) {
- &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; extendedFieldValue.containsKey(req.getSchema().getUniqueKeyField().getName());
+ &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (extendedFieldValue.size() != 1) {
+ &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+ &#160; &#160; &#160;}
+ &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the only key is a field in the schema, assume it&apos;s a child doc
&lt;/span&gt;+ &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fieldName = extendedFieldValue.iterator().next().getName();
+ &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; req.getSchema().getFieldOrNull(fieldName) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+ &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// otherwise, assume it&apos;s &lt;span class=&quot;code-quote&quot;&gt;&quot;set&quot;&lt;/span&gt; or some other verb &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a partial update.
&lt;/span&gt;+ &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// NOTE: it&apos;s fundamentally ambiguous with JSON; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a best effort &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;.
&lt;/span&gt;&#160; &#160; &#160;}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In case that diff gets reformatted and garbled, it would previously have checked&#160; if the `id` field was a &#160;key in the `extendedFieldValue`, which would have been `false`, but it now returns `true` if the `extendedFieldValue.size()` is not equal to `1`, which is the case here because I have both an `add` and a `remove` in the extended field value. It does work fine if I submit two separate updates, one for each of the two operations.&lt;/p&gt;

&lt;p&gt;For now, we&apos;re going to do the `add` and `remove` in separate updates and make sure we don&apos;t have other cases of multiple update operations, but it would be nice if users weren&apos;t forced to do that.&lt;/p&gt;

&lt;p&gt;&#160;This was actually the second time we were affected by the `isChildDoc`change I mentioned above. The first issue, when we upgraded from 6.6 to 9.5 last year, we worked around by renaming an existing field from `set` to `sset`. The problem&#160; was that an atomic update like `{&quot;id&quot;: &quot;1&quot;, &quot;name&quot;: {&quot;set&quot;: &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;J Doe&amp;quot;&amp;#93;&lt;/span&gt;}}` would fail with the same error message because since `set` was a field name, `return req.getSchema().getFieldOrNull(fieldName) != null` would evaluate to `true` for `isChildDoc`. After we renamed the field to `sset`, then `req.getSchema().getFieldOrNull(fieldName)` would be null for `set` and so&lt;br/&gt;
`isChildDoc` would evaluate to `false`, as desired.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Observed first in 9.5.0 w/ OpenJDK 11, then reproduced this simple test case in 9.6.0.&lt;/p&gt;</environment>
        <key id="13578121">SOLR-17274</key>
            <summary>atomic update error when using json w/ multiple modifiers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="casmith">Calvin Smith</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 May 2024 23:05:22 +0000</created>
                <updated>Fri, 25 Oct 2024 17:18:54 +0000</updated>
                            <resolved>Tue, 14 May 2024 03:22:47 +0000</resolved>
                                    <version>9.0</version>
                    <version>9.1</version>
                    <version>9.2</version>
                    <version>9.3</version>
                    <version>9.4</version>
                    <version>9.5</version>
                    <version>9.6</version>
                                    <fixVersion>9.7</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17843522" author="dsmiley" created="Sun, 5 May 2024 03:48:54 +0000"  >&lt;p&gt;The JSON syntax is not as rich as XML or &quot;javabin&quot; (native SolrJ), which are typed. &#160;&lt;b&gt;Perhaps&lt;/b&gt; a solution is to assume certain operation names (e.g. &quot;set&quot;, &quot;add&quot;, &quot;remove&quot;, etc.)? &#160;Ugh; it&apos;s kind of inelegant though. &#160;I wish we had used underscores to make them more special. &#160;At least this problem is only specific to JSON; you have a couple other options.&lt;/p&gt;</comment>
                            <comment id="17844440" author="JIRAUSER303825" created="Tue, 7 May 2024 20:26:03 +0000"  >&lt;p&gt;It would be nice if we didn&apos;t have to switch to a non-Json format. We&apos;re a Python backend that uses JSON everywhere and XML nowhere currently, and last time I checked, CBOR didn&apos;t support something that we use via JSON, so the path of least resistance for us would be to work around the JSON limitations somehow.&lt;/p&gt;

&lt;p&gt;In terms of possible changes though, could Solr take into account whether a `&lt;em&gt;root&lt;/em&gt;` field is defined for the index/schema, and if not, then don&apos;t consider it a child doc? Or alternately, maybe a configuration option to enable or disable nested documents that don&apos;t provide a `uniqueKey` field, and it could behave differently in that case (e.g., old logic if nested docs without a `uniqueKey` are not enabled and new logic or something like it if so). For folks like us that don&apos;t ever use nested docs (with or without a `uniqueKey`), the old logic worked perfectly.&lt;/p&gt;</comment>
                            <comment id="17844447" author="dsmiley" created="Tue, 7 May 2024 21:18:36 +0000"  >&lt;p&gt;Ah right, if the schema isn&apos;t child doc enabled, then isChildDoc can return false. &#160;I like it! &#160;Deja-vu... probably an existing idea written somewhere. &#160;If you can submit a PR, that&apos;d be great. Call {{IndexSchema.isUsableForChildDocs() }}to see if we can return early.&lt;/p&gt;</comment>
                            <comment id="17844479" author="JIRAUSER303825" created="Wed, 8 May 2024 01:04:42 +0000"  >&lt;p&gt;Sure, I&apos;ll make a PR and some tests.&lt;/p&gt;</comment>
                            <comment id="17844820" author="JIRAUSER303825" created="Thu, 9 May 2024 00:18:18 +0000"  >&lt;p&gt;I made a PR: &lt;a href=&quot;https://github.com/apache/solr/pull/2451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/2451&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I couldn&apos;t see any atomic update tests using the `JsonLoader`, so I created another test file with a few basic tests using json and some additional tests for the two features that now work if the schema doesn&apos;t support child docs.&lt;/p&gt;</comment>
                            <comment id="17845536" author="jira-bot" created="Sat, 11 May 2024 05:09:52 +0000"  >&lt;p&gt;Commit 3b30f2591ca5369e30741788a5aba43752c9d91b in solr&apos;s branch refs/heads/main from Calvin Smith&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=3b30f2591ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=3b30f2591ca&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17274&quot; title=&quot;atomic update error when using json w/ multiple modifiers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17274&quot;&gt;&lt;del&gt;SOLR-17274&lt;/del&gt;&lt;/a&gt;: allow JSON atomic updates to use multiple modifiers or a modifier like &apos;set&apos; as a field name if child docs not enabled  (#2451)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;fix two problems with json atomic update &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17274&quot; title=&quot;atomic update error when using json w/ multiple modifiers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17274&quot;&gt;&lt;del&gt;SOLR-17274&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this modifies `isChildDoc` to always return false if child docs are&lt;br/&gt;
   not possible according to the schema, and restores part of the&lt;br/&gt;
   logic of `parseObjectFieldValue` so that it can handle&lt;br/&gt;
   multiple modifiers&lt;/li&gt;
	&lt;li&gt;re-enables the ability to use multiple modifiers in a single&lt;br/&gt;
   update, like `
{&quot;add&quot;: &quot;foo&quot;, &quot;remove&quot;: &quot;bar&quot;}
&lt;p&gt;`&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;re-enables the ability to have a field with a name like&lt;br/&gt;
   `set` or `remove` and be able to use updates like&lt;br/&gt;
   `{&quot;set&quot;: 
{&quot;set&quot;: &quot;foo&quot;}
&lt;p&gt;`&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;both of these are possible now but only if the schema&lt;br/&gt;
   doesn&apos;t support child/nested docs; if the schema does&lt;br/&gt;
   support them, then functionality is unchanged and either&lt;br/&gt;
   will continue throwing an exception&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;Co-authored-by: Calvin Smith &amp;lt;casmith@lucasfilm.com&amp;gt;&lt;br/&gt;
Co-authored-by: David Smiley &amp;lt;dsmiley@apache.org&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17846151" author="jira-bot" created="Tue, 14 May 2024 03:19:02 +0000"  >&lt;p&gt;Commit 94d43dfabfb0033ffc8c558aa9d670357c83fed7 in solr&apos;s branch refs/heads/branch_9x from Calvin Smith&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=94d43dfabfb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=94d43dfabfb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17274&quot; title=&quot;atomic update error when using json w/ multiple modifiers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17274&quot;&gt;&lt;del&gt;SOLR-17274&lt;/del&gt;&lt;/a&gt;: allow JSON atomic updates to use multiple modifiers or a modifier like &apos;set&apos; as a field name if child docs not enabled  (#2451)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;fix two problems with json atomic update &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17274&quot; title=&quot;atomic update error when using json w/ multiple modifiers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17274&quot;&gt;&lt;del&gt;SOLR-17274&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this modifies `isChildDoc` to always return false if child docs are&lt;br/&gt;
   not possible according to the schema, and restores part of the&lt;br/&gt;
   logic of `parseObjectFieldValue` so that it can handle&lt;br/&gt;
   multiple modifiers&lt;/li&gt;
	&lt;li&gt;re-enables the ability to use multiple modifiers in a single&lt;br/&gt;
   update, like `
{&quot;add&quot;: &quot;foo&quot;, &quot;remove&quot;: &quot;bar&quot;}
&lt;p&gt;`&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;re-enables the ability to have a field with a name like&lt;br/&gt;
   `set` or `remove` and be able to use updates like&lt;br/&gt;
   `{&quot;set&quot;: 
{&quot;set&quot;: &quot;foo&quot;}
&lt;p&gt;`&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;both of these are possible now but only if the schema&lt;br/&gt;
   doesn&apos;t support child/nested docs; if the schema does&lt;br/&gt;
   support them, then functionality is unchanged and either&lt;br/&gt;
   will continue throwing an exception&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;---------&lt;/p&gt;

&lt;p&gt;Co-authored-by: Calvin Smith &amp;lt;casmith@lucasfilm.com&amp;gt;&lt;br/&gt;
Co-authored-by: David Smiley &amp;lt;dsmiley@apache.org&amp;gt;&lt;br/&gt;
(cherry picked from commit 3b30f2591ca5369e30741788a5aba43752c9d91b)&lt;/p&gt;</comment>
                            <comment id="17846154" author="dsmiley" created="Tue, 14 May 2024 03:22:47 +0000"  >&lt;p&gt;Merged. &#160;Thanks for the PR Calvin!&lt;/p&gt;</comment>
                            <comment id="17846374" author="JIRAUSER303825" created="Tue, 14 May 2024 16:46:47 +0000"  >&lt;p&gt;My pleasure. Thanks for your help in getting it in.&lt;/p&gt;</comment>
                            <comment id="17892926" author="anshumg" created="Fri, 25 Oct 2024 17:18:54 +0000"  >&lt;p&gt;Closing after the 9.7.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1p0x4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>