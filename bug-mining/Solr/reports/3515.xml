<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:25:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10914] RecoveryStrategy&apos;s sendPrepRecoveryCmd can get stuck for 5 minutes if leader is unloaded</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10914</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;tl;dr; a recovering replica is stuck for 5 minutes in the prep recovery request if the leader core is unloaded before the prep recovery request is made.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9716&quot; title=&quot;RecoveryStrategy send prep recovery cmd without setting request time out&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9716&quot;&gt;&lt;del&gt;SOLR-9716&lt;/del&gt;&lt;/a&gt; changed the sendPrepRecoveryCmd to retry on read timeouts (earlier it had no connection/read timeout at all) but the fix has caused another problem. Say &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;A replica starts up (or is newly created) and goes into recovery,&lt;/li&gt;
	&lt;li&gt;Replica finds that leader=X&lt;/li&gt;
	&lt;li&gt;The core X is unloaded but the node that used to host X is still running and taking requests&lt;/li&gt;
	&lt;li&gt;Replica calls sendPrepRecoveryCmd to X&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;At this point, the node X receives the prep recovery command, finds that the core X does not exist and keeps checking again in a sleep-loop until a timeout happens. I am not sure why prep recovery core admin command needs to continue waiting if a local core does not exist. The default timeout here is usually longer than 10 seconds.&lt;/p&gt;

&lt;p&gt;On the recovering replica&apos;s side, the prep recovery has a connection/read timeout of only 10s, so the request always times out and is retried upto 5 minutes. Only then does the recovery attempt fails and may be restarted again with the right leader URL.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13080867">SOLR-10914</key>
            <summary>RecoveryStrategy&apos;s sendPrepRecoveryCmd can get stuck for 5 minutes if leader is unloaded</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Jun 2017 15:37:37 +0000</created>
                <updated>Wed, 2 Oct 2019 17:25:08 +0000</updated>
                            <resolved>Mon, 3 Jul 2017 14:23:32 +0000</resolved>
                                    <version>6.4</version>
                    <version>6.5</version>
                    <version>6.6</version>
                                    <fixVersion>6.7</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16054243" author="shalinmangar" created="Mon, 19 Jun 2017 15:46:29 +0000"  >&lt;p&gt;Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; for catching this with the tests he wrote for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10878&quot; title=&quot;MOVEREPLICA command may lose data when replicationFactor==1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10878&quot;&gt;&lt;del&gt;SOLR-10878&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16055173" author="shalinmangar" created="Tue, 20 Jun 2017 05:36:02 +0000"  >&lt;p&gt;This patch changes the sendPrepRecoveryCmd method to use a small connection timeout (10s) as before and a read timeout which is 5 seconds longer than the max timeout of prep recovery on the server side. It makes no retries anymore. So once the prep recovery returns a 404 after 30s, the recovery fails and can be retries again with the new/correct leader URL.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this but I&apos;ll open another issue to explore removing the wait time on core not found from prep recovery.&lt;/p&gt;</comment>
                            <comment id="16072448" author="shalinmangar" created="Mon, 3 Jul 2017 13:36:05 +0000"  >&lt;p&gt;I added a TestPrepRecovery to this patch. It has two tests:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Test that prep recovery eventually succeeds when the leader doesn&apos;t respond at all. This is an explicit test to protect against regressions of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9716&quot; title=&quot;RecoveryStrategy send prep recovery cmd without setting request time out&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9716&quot;&gt;&lt;del&gt;SOLR-9716&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Test that prep recovery succeeds within 90s (default timeout of waitForState) when the leader is unloaded. The test doesn&apos;t actually wait for 90s unless there is a regression but it can wait upto 23 seconds for the second recovery attempt which will succeed because the fault injection is done only once. Also the fault injection is only done 30% of the time.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This is ready.&lt;/p&gt;</comment>
                            <comment id="16072450" author="shalinmangar" created="Mon, 3 Jul 2017 13:37:04 +0000"  >&lt;p&gt;Fixed wrong code comment in the test in previous patch.&lt;/p&gt;</comment>
                            <comment id="16072513" author="jira-bot" created="Mon, 3 Jul 2017 14:20:42 +0000"  >&lt;p&gt;Commit 157ff9a4e159158f4ecc474d1874da97577e6190 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=157ff9a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=157ff9a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10914&quot; title=&quot;RecoveryStrategy&amp;#39;s sendPrepRecoveryCmd can get stuck for 5 minutes if leader is unloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10914&quot;&gt;&lt;del&gt;SOLR-10914&lt;/del&gt;&lt;/a&gt;: RecoveryStrategy&apos;s sendPrepRecoveryCmd can get stuck for 5 minutes if leader is unloaded&lt;/p&gt;</comment>
                            <comment id="16072516" author="jira-bot" created="Mon, 3 Jul 2017 14:23:14 +0000"  >&lt;p&gt;Commit df727d313f6f63f73b8efe0a0448b263581670bd in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=df727d3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=df727d3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10914&quot; title=&quot;RecoveryStrategy&amp;#39;s sendPrepRecoveryCmd can get stuck for 5 minutes if leader is unloaded&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10914&quot;&gt;&lt;del&gt;SOLR-10914&lt;/del&gt;&lt;/a&gt;: RecoveryStrategy&apos;s sendPrepRecoveryCmd can get stuck for 5 minutes if leader is unloaded&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 157ff9a)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13017229">SOLR-9716</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13079425">SOLR-10878</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12875513" name="SOLR-10914.patch" size="10042" author="shalin" created="Mon, 3 Jul 2017 13:36:55 +0000"/>
                            <attachment id="12875512" name="SOLR-10914.patch" size="10042" author="shalin" created="Mon, 3 Jul 2017 13:35:30 +0000"/>
                            <attachment id="12873602" name="SOLR-10914.patch" size="2142" author="shalin" created="Tue, 20 Jun 2017 05:33:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gg9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>