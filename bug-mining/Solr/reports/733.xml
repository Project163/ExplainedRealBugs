<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:23:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2848] DirectSolrSpellChecker fails in distributed environment</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2848</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2585&quot; title=&quot;Context-Sensitive Spelling Suggestions &amp;amp; Collations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2585&quot;&gt;&lt;del&gt;SOLR-2585&lt;/del&gt;&lt;/a&gt;, it was brought to my attention that DirectSolrSpellChecker has no test coverage involving a distributed environment.  Here I am adding a random element to DistributedSpellCheckComponentTest to alternate between the &quot;IndexBased&quot; and &quot;Direct&quot; spell checkers.  Doing so revealed bugs in using DirectSolrSpellChecker in a distributed environment.  The fixes here roughly mirror those made to the &quot;IndexBased&quot; spell checker with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2083&quot; title=&quot;Problem with Distributed SpellCheck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2083&quot;&gt;&lt;del&gt;SOLR-2083&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12527970">SOLR-2848</key>
            <summary>DirectSolrSpellChecker fails in distributed environment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rcmuir">Robert Muir</assignee>
                                    <reporter username="jdyer">James Dyer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Oct 2011 16:52:26 +0000</created>
                <updated>Fri, 10 May 2013 10:39:08 +0000</updated>
                            <resolved>Thu, 10 Nov 2011 10:54:59 +0000</resolved>
                                    <version>4.0-ALPHA</version>
                                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>SolrCloud</component>
                    <component>spellchecker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13131758" author="jdyer" created="Thu, 20 Oct 2011 16:53:29 +0000"  >&lt;p&gt;increase test coverage &amp;amp; fix bugs subsequently found.&lt;/p&gt;</comment>
                            <comment id="13133044" author="markrmiller@gmail.com" created="Fri, 21 Oct 2011 20:44:32 +0000"  >&lt;p&gt;thanks James!&lt;/p&gt;</comment>
                            <comment id="13133350" author="rcmuir" created="Sat, 22 Oct 2011 12:18:22 +0000"  >&lt;p&gt;Thanks for bringing this up James, a few questions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Can we instead fold these changes into the base spellchecking class or somewhere else in Solr? I don&apos;t think a spellchecking implementation should have to deal with this stuff, this is a plugin API and it should only have to implement spellcheck.&lt;/li&gt;
	&lt;li&gt;Is there a way we can remove the instanceof checks in SpellCheckComponent completely? I think seeing these is a sign there is a serious problem in the spellchecking APIs.&lt;/li&gt;
	&lt;li&gt;what is the problem with the internal levenshtein implementation? I&apos;m not sure we should silently change this here, i don&apos;t understand why we should use the slower one if the user asked for &apos;internal&apos;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13134121" author="jdyer" created="Mon, 24 Oct 2011 14:52:23 +0000"  >&lt;p&gt;Robert,&lt;/p&gt;

&lt;p&gt;I think your first suggestion (moving configuration and response formatting out of the *SolrSpellCheck) is desirable and doable, but I wanted to keep this issue focused on increasing test coverage and to make DirectSolrSpellChecker mirror what AbstractLuceneSpellChecker already does so that it can pass.&lt;/p&gt;

&lt;p&gt;Obviously, if every SpellChecker plug-in implemented or extended something that had a &quot;getStringDistance&quot; or &quot;getAccuracy&quot; method then we wouldn&apos;t need to do instanceof and cast.  Once again, a big structural change like this seems inappropriate in a bug fix, especially as we are not introducing these checks for the first time.  This is a long-standing problem.&lt;/p&gt;

&lt;p&gt;It looks to me like &quot;internal levenshtein&quot; is just a dummy class designed to technically meet the api requirements while not actually doing anything.  But SpellCheckComponent.finishStage() needs to be able to get the StringDistance impl that was used to generate suggestions during the first stage, then re-compute distances using its getDistance() method.  This is how it can know how to order the varying suggestions from multiple shards after-the-fact.  I see from the notes in DirectSpellChecker that using the &quot;internal&quot; StringDistance yields performance improvements over using a pluggable s.d.  I did not look enough to determine if &quot;internal levenshtein&quot; could be modified to re-compute these internally-generated distance calculations and be usable externally, without sacrificing the performance gain.  If possible, this would probably be our best bet, eliminating the Exception hack and any possible discrepancies using 2 different s.d. classes would cause.  Do you agree?&lt;/p&gt;</comment>
                            <comment id="13134123" author="rcmuir" created="Mon, 24 Oct 2011 14:57:55 +0000"  >&lt;blockquote&gt;
&lt;p&gt;But SpellCheckComponent.finishStage() needs to be able to get the StringDistance impl that was used to generate suggestions during the first stage, then re-compute distances using its getDistance() method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is the part i dont understand... we already have the scores in the results, so why recompute?&lt;/p&gt;</comment>
                            <comment id="13134142" author="jdyer" created="Mon, 24 Oct 2011 15:27:49 +0000"  >&lt;p&gt;finishStage() is being run on the Master Shard.  It receives spelling results from all of the shards and then has to integrate them together.  Solr doesn&apos;t return the scores with spelling suggestions back to the client.  I suppose the authors of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-785&quot; title=&quot;Distributed SpellCheckComponent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-785&quot;&gt;&lt;del&gt;SOLR-785&lt;/del&gt;&lt;/a&gt; could have modified the response Solr sends back to its clients.  However, it probably seemed inexpensive enough to just re-compute the string distance after-the-fact (indeed Lucene In Action 2nd ed sect 8.5.3 mentions doing the same thing, so I take it this is a common thing to do?).  The problem now we have is we&apos;ve got a spellchecker that doesn&apos;t fully implement a StringDistance all the time.  I&apos;d imagine the best bet is to try and change that.  Possibly, the slight discrepancies our current patch leave are not serious enough to fix?  If neither option is good, then we&apos;d probably have to modify the solr response to include scores.&lt;/p&gt;</comment>
                            <comment id="13134150" author="rcmuir" created="Mon, 24 Oct 2011 15:37:21 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;d imagine the best bet is to try and change that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK, Lets do this, such that the distance impl is a &quot;real&quot; one computing levenshtein like Lucene does and not a fake one. Then its one less hack.&lt;/p&gt;

&lt;p&gt;Want to open a LUCENE issue for this? I can help if you want.&lt;/p&gt;</comment>
                            <comment id="13134160" author="rcmuir" created="Mon, 24 Oct 2011 15:43:08 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The problem now we have is we&apos;ve got a spellchecker that doesn&apos;t fully implement a StringDistance all the time.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;we should fix that hack as i mentioned I think (its just a hack, caused by me, sorry!).&lt;/p&gt;

&lt;p&gt;But then we should think about how to make sure that SpellChecker subclasses always work correctly distributed if we aren&apos;t going to change the wire format. Rather than instanceof/StringDistance maybe we could add a merge() method that would be more general?&lt;/p&gt;</comment>
                            <comment id="13134182" author="jdyer" created="Mon, 24 Oct 2011 15:59:12 +0000"  >&lt;blockquote&gt;
&lt;p&gt;OK, Lets do this, such that the distance impl is a &quot;real&quot; one computing levenshtein like Lucene does&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3527&quot; title=&quot;Implement getDistance() on DirectSpellChecker.INTERNAL_LEVENSHTEIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3527&quot;&gt;&lt;del&gt;LUCENE-3527&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Rather than instanceof/StringDistance maybe we could add a merge() method that would be more general?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Are you thinking each *SolrSpellChecker should have a merge() that finishStage() calls?  This sounds reasonable to me.&lt;/p&gt;</comment>
                            <comment id="13134187" author="rcmuir" created="Mon, 24 Oct 2011 16:02:48 +0000"  >&lt;p&gt;Yeah, this way a spellchecker can decide how it merges results (since we arent going to put any &apos;score&apos; in the wire format or require it).&lt;/p&gt;

&lt;p&gt;So for example, the default impl of AbstractLuceneSpellChecker&apos;s merge() would use getComparator and such (we can just put this in the abstract class)&lt;/p&gt;
</comment>
                            <comment id="13141442" author="jdyer" created="Tue, 1 Nov 2011 18:31:38 +0000"  >&lt;p&gt;sync w/trunk &amp;amp; modified in light on completion of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3527&quot; title=&quot;Implement getDistance() on DirectSpellChecker.INTERNAL_LEVENSHTEIN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-3527&quot;&gt;&lt;del&gt;LUCENE-3527&lt;/del&gt;&lt;/a&gt;.  This version doesn&apos;t have any refactorings.&lt;/p&gt;</comment>
                            <comment id="13141480" author="jdyer" created="Tue, 1 Nov 2011 19:20:57 +0000"  >&lt;p&gt;This version also contains refactorings to SpellCheckComponent.finishStage(), and moves the final merge to the SolrSpellChecker abstract class.&lt;/p&gt;

&lt;p&gt;An alternative to doing this would be to keep the &quot;mergeSuggestions()&quot; method in SpellCheckComponent and simply implement &quot;getStringDistance()&quot; and &quot;getAccuracy()&quot; in SolrSpellChecker. &lt;/p&gt;</comment>
                            <comment id="13147083" author="jdyer" created="Wed, 9 Nov 2011 15:06:00 +0000"  >&lt;p&gt;I would really like to get this issue resolved if possible.  Here are 3 possible solutions:&lt;/p&gt;

&lt;p&gt;1. The Nov 1 patch &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2848&quot; title=&quot;DirectSolrSpellChecker fails in distributed environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2848&quot;&gt;&lt;del&gt;SOLR-2848&lt;/del&gt;&lt;/a&gt;.patch&quot; increases test coverage and makes the minimal changes to fix the distributed bug with DirectSolrSpellChecker.&lt;/p&gt;

&lt;p&gt;2. The Nov 1 patch &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2848&quot; title=&quot;DirectSolrSpellChecker fails in distributed environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2848&quot;&gt;&lt;del&gt;SOLR-2848&lt;/del&gt;&lt;/a&gt;-refactoring.patch&quot; also refactors the code, breaking the finishStage() method up and also moving the final merge into SolrSpellChecker.  This allows us to theoretically have different spell checkers choose to merge differently.  In practice, all of our spell checkers currently would use the same default version of &quot;merge()&quot;&lt;/p&gt;

&lt;p&gt;3. We could dial back the changes in &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2848&quot; title=&quot;DirectSolrSpellChecker fails in distributed environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2848&quot;&gt;&lt;del&gt;SOLR-2848&lt;/del&gt;&lt;/a&gt;-refactoring.patch&quot; to keep merge() as a method in SpellCheckComponent as all spell checkers use the same algorithm anyhow.  But we could keep the changes to make finishStage() more readable and, more importantly, keep the &quot;getStringDistance()&quot; and &quot;getAccuracy()&quot; methods in SolrSpellChecker.  This at least eliminates the need for &quot;instanceof&quot; checks, making Distributed Spell Check less brittle as new spell checkers are added.&lt;/p&gt;

&lt;p&gt;Please advise how we should move forward.  (I like option #3 the best.  I can create a patch for this if desired.)  Thanks.&lt;/p&gt;

</comment>
                            <comment id="13147094" author="rcmuir" created="Wed, 9 Nov 2011 15:20:35 +0000"  >&lt;p&gt;Personally I really like your 2nd patch. I think its nice to open up merge() like this.&lt;/p&gt;

&lt;p&gt;Some ideas:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I also think for now getStringDistance/getAccuracy need not return null? If you don&apos;t support these methods, throw UOE instead and override merge(). we document that this is how the default merge implementation works.&lt;/li&gt;
	&lt;li&gt;Can we make getStringDistance/getAccuracy protected instead of public? We don&apos;t want them to be suddenly get used by lots of other code when they are really just a merge implementation detail.&lt;/li&gt;
	&lt;li&gt;Is there any way to avoid this extra docFreq call when the spellchecker is &apos;sharded&apos; ? Seems like we call docFreq twice in that case.&lt;/li&gt;
	&lt;li&gt;I&apos;d really like for a specific spellchecker impl to be able to able to work with the default merge implementation etc without having &apos;boolean sharded&apos; (it shouldnt have to &quot;know&quot;). What is this extra check doing, and can we move it to the base class?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13147193" author="jdyer" created="Wed, 9 Nov 2011 17:58:16 +0000"  >&lt;p&gt;Here is a version that addresses Robert&apos;s concerns.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;d really like for a specific spellchecker impl to be able to able to work with the default merge implementation etc without having &apos;boolean sharded&apos; (it shouldnt have to &quot;know&quot;). What is this extra check doing, and can we move it to the base class?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What happens is the first stage of a distributed request needs to return the original tokens plus an empty list so that the master, when merging, can know that the shard found the token misspelled but had no suggestions.  But if this is not a shard request, we don&apos;t want to go sending empty lists back to the enduser.  Hence the &quot;isShard&quot; boolean.  I removed this, allowing it to return empty lists all the time, and then having them removed out of the response if it is a non-distributed scenario.  This invalidated some test scenarios, so I made adjustments to a few unit tests to cope.&lt;/p&gt;

&lt;p&gt;Let me know if this needs more work before committing.&lt;/p&gt;</comment>
                            <comment id="13147198" author="rcmuir" created="Wed, 9 Nov 2011 18:07:16 +0000"  >&lt;p&gt;I&apos;m +1 for this patch... any objections?&lt;/p&gt;

&lt;p&gt;Thanks for cleaning all this up James!&lt;/p&gt;</comment>
                            <comment id="13147602" author="rcmuir" created="Thu, 10 Nov 2011 10:54:59 +0000"  >&lt;p&gt;Thanks again James!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12528512">LUCENE-3527</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12503106" name="SOLR-2848-refactoring.patch" size="38920" author="jdyer" created="Wed, 9 Nov 2011 17:58:16 +0000"/>
                            <attachment id="12501813" name="SOLR-2848-refactoring.patch" size="32678" author="jdyer" created="Tue, 1 Nov 2011 19:20:57 +0000"/>
                            <attachment id="12501808" name="SOLR-2848.patch" size="11568" author="jdyer" created="Tue, 1 Nov 2011 18:31:38 +0000"/>
                            <attachment id="12499886" name="SOLR-2848.patch" size="12023" author="jdyer" created="Thu, 20 Oct 2011 16:53:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92385</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03i7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18382</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>