<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:46:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5721] ConnectionManager can become stuck in likeExpired</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5721</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Here are the sequence of events:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we disconnect&lt;/li&gt;
	&lt;li&gt;The disconnect timer beings to run (so no longer scheduled), but doesn&apos;t  set likelyExpired yet&lt;/li&gt;
	&lt;li&gt;We connect, and set likelyExpired = false&lt;/li&gt;
	&lt;li&gt;The disconnect thread runs and sets likelyExpired to true, and it is never set back to false (note that we cancel the disconnect thread but that only cancels scheduled tasks but not running tasks).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is pretty difficult to reproduce without doing more work in the disconnect thread.  It&apos;s easy to reproduce by adding sleeps in various places &amp;#8211; I have a test that I&apos;ll attach that does that.&lt;/p&gt;

&lt;p&gt;The most straightforward way to solve this would be to grab the synchronization lock on ConnectionManager in the disconnect thread, ensure we aren&apos;t actually connected, and only then setting likelyExpired to true.  In code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (ConnectionManager.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!connected) likelyExpired = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but this is all pretty subtle and error prone.  It&apos;s easier to just get rid of the disconnect thread and record the last time we disconnected.  Then, when we check likelyExpired, we just do a quick calculation to see if we are likelyExpired.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12694886">SOLR-5721</key>
            <summary>ConnectionManager can become stuck in likeExpired</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="gchanan">Gregory Chanan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Feb 2014 00:07:50 +0000</created>
                <updated>Mon, 9 May 2016 18:48:51 +0000</updated>
                            <resolved>Fri, 14 Feb 2014 15:40:28 +0000</resolved>
                                    <version>4.6.1</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13899814" author="gchanan" created="Thu, 13 Feb 2014 00:11:35 +0000"  >&lt;p&gt;Here&apos;s a rough demonstration of a failure with strategic pauses inserted.  I don&apos;t think we&apos;d want such a test, but I couldn&apos;t reproduce the bug with a nicer test.  What I did in the nicer test is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disconnect&lt;/li&gt;
	&lt;li&gt;try to reconnect around the time the disconnect thread would run (with some random error)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;if I inserted something small in the disconnect thread, like a System.err, the nicer test would reproduce the issue.  I can attach that if people are interested.&lt;/p&gt;</comment>
                            <comment id="13899862" author="gchanan" created="Thu, 13 Feb 2014 00:56:53 +0000"  >&lt;p&gt;Here&apos;s a patch that gets rid of the disconnect thread and a test around it.&lt;/p&gt;</comment>
                            <comment id="13900037" author="markrmiller@gmail.com" created="Thu, 13 Feb 2014 05:53:50 +0000"  >&lt;p&gt;Nice! Good call.&lt;/p&gt;</comment>
                            <comment id="13901557" author="jira-bot" created="Fri, 14 Feb 2014 15:36:02 +0000"  >&lt;p&gt;Commit 1568337 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1568337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1568337&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5721&quot; title=&quot;ConnectionManager can become stuck in likeExpired&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5721&quot;&gt;&lt;del&gt;SOLR-5721&lt;/del&gt;&lt;/a&gt;: ConnectionManager can become stuck in likeExpired.&lt;/p&gt;</comment>
                            <comment id="13901566" author="jira-bot" created="Fri, 14 Feb 2014 15:40:07 +0000"  >&lt;p&gt;Commit 1568338 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1568338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1568338&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5721&quot; title=&quot;ConnectionManager can become stuck in likeExpired&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5721&quot;&gt;&lt;del&gt;SOLR-5721&lt;/del&gt;&lt;/a&gt;: ConnectionManager can become stuck in likeExpired.&lt;/p&gt;</comment>
                            <comment id="13901568" author="markrmiller@gmail.com" created="Fri, 14 Feb 2014 15:40:28 +0000"  >&lt;p&gt;Thanks Greg!&lt;/p&gt;</comment>
                            <comment id="13902718" author="andyetitmoves" created="Sun, 16 Feb 2014 13:59:02 +0000"  >&lt;p&gt;Wouldn&apos;t using System.currentTimeMillis for timr deltas lead to errors due to NTP sync or DST? It&apos;s not guaranteed to be monotonic. See&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/2978598/will-sytem-currenttimemillis-always-return-a-value-previous-calls&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/2978598/will-sytem-currenttimemillis-always-return-a-value-previous-calls&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;System.nanoTime seems to provide a better alternative, at least when the OS supports a monotonic clock.&lt;/p&gt;</comment>
                            <comment id="13902747" author="markrmiller@gmail.com" created="Sun, 16 Feb 2014 16:28:52 +0000"  >&lt;p&gt;Yeah, sounds like a good improvement.&lt;/p&gt;</comment>
                            <comment id="13902766" author="markrmiller@gmail.com" created="Sun, 16 Feb 2014 18:01:07 +0000"  >&lt;p&gt;I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5734&quot; title=&quot;We should use System.nanoTime rather than System.currentTimeMillis when calculating elapsed time. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5734&quot;&gt;&lt;del&gt;SOLR-5734&lt;/del&gt;&lt;/a&gt; as this kind of spans the system.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12628633" name="SOLR-5721.patch" size="7613" author="gchanan" created="Thu, 13 Feb 2014 00:56:53 +0000"/>
                            <attachment id="12628616" name="SOLR-5721test.patch" size="3766" author="gchanan" created="Thu, 13 Feb 2014 00:11:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373394</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 40 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1scif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373694</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>