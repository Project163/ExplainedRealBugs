<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:15:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7280] Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7280</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7191&quot; title=&quot;Improve stability and startup performance of SolrCloud with thousands of collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7191&quot;&gt;&lt;del&gt;SOLR-7191&lt;/del&gt;&lt;/a&gt;, Damien mentioned that by loading solr cores in a sorted order and tweaking some of the coreLoadThread counts, he was able to improve the stability of a cluster with thousands of collections. We should explore some of these changes and fold them into Solr.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12783756">SOLR-7280</key>
            <summary>Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Mar 2015 21:32:16 +0000</created>
                <updated>Wed, 18 Mar 2020 03:39:18 +0000</updated>
                            <resolved>Thu, 25 Aug 2016 04:41:09 +0000</resolved>
                                                    <fixVersion>5.5.3</fixVersion>
                    <fixVersion>6.2</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>14</watches>
                                                                                                                <comments>
                            <comment id="15357166" author="noble.paul" created="Thu, 30 Jun 2016 14:31:10 +0000"  >&lt;p&gt;moved patch over from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7191&quot; title=&quot;Improve stability and startup performance of SolrCloud with thousands of collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7191&quot;&gt;&lt;del&gt;SOLR-7191&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15364212" author="noble.paul" created="Wed, 6 Jul 2016 12:06:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; planning to commit this soon&lt;/p&gt;</comment>
                            <comment id="15364423" author="erickerickson" created="Wed, 6 Jul 2016 15:01:46 +0000"  >&lt;p&gt;Great!&lt;/p&gt;</comment>
                            <comment id="15366168" author="markrmiller@gmail.com" created="Thu, 7 Jul 2016 14:13:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;// This assumes replicaCount is less than coreLoadThreadCount?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why is that a question?&lt;/p&gt;

&lt;p&gt;If you don&apos;t have enough threads to load all the cores in a shard, you have to wait for the leader vote timeout which is long.&lt;/p&gt;

&lt;p&gt;That doesn&apos;t seem look good default behavior. How does this address that? I&apos;m only mildly caught up on the related issue.&lt;/p&gt;</comment>
                            <comment id="15366417" author="noble.paul" created="Thu, 7 Jul 2016 17:10:17 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; for looking into this. The &lt;tt&gt;coreLoadThreads&lt;/tt&gt; is something that&apos;s ignored in cloud mode today.  Should the user not have a way to limit the no:of threads used to load cores in cloud mode. If there are thousands of cores, the cluster ends up unstable because of this. Normally, users will have a few cores per node and it is no big deal to keep the thread pool to be unbounded. The power users must have a way to tune this. &lt;/p&gt;</comment>
                            <comment id="15366563" author="erickerickson" created="Thu, 7 Jul 2016 18:33:23 +0000"  >&lt;p&gt;The symptom is that  OOM errors &quot;unable to create native thread&quot; happens, resulting in replicas that never come up, sometimes never ending recovery cycles etc. etc. etc. Decreasing Xss or increasing Xmx  doesn&apos;t help (maybe some other settings?). In my testing  with 400 replicas in a JVM, something on the order of 1K temporary threads were spun up when I tried to start the JVM. More correctly that many threads were running, the rest (number unknown) never started at all.&lt;/p&gt;

&lt;p&gt;What the default should be is certainly debatable. The curious thing was that at no time did the JVM memory appear to be stressed (using jconsole to spot-check, not rigorous at all)....&lt;/p&gt;

&lt;p&gt;I&apos;ve assumed that by ordering the replicas to come up based on what collection they belong to, they won&apos;t get stuck waiting for a leader election just because the ordering on instance1 happened to try to bring up collection1 then collection2 whereas instance2 tried to bring them up in reverse order. More like skip-lists in terms of waiting...&lt;/p&gt;

&lt;p&gt;Sure, with weird enough topology instance1 could have a long queue to get through before getting to collectionX whereas instance N could start with collectionX and have to go through leader vote wait timeouts, but that&apos;s way better than having a cluster that won&apos;t start at all.&lt;/p&gt;

&lt;p&gt;And when I tested starting 3 of my 4 JVMs, it was indeed painfully slow waiting for leader vote wait timeouts. But the cluster came up.&lt;/p&gt;

&lt;p&gt;Using 3 coreLoadThreads and starting all my JVMs at once took just a few minutes.&lt;/p&gt;

&lt;p&gt;And the painfully trappy behavior without this patch is that I can create all my collections just fine, but then I can&apos;t restart the cluster successfully.&lt;/p&gt;
</comment>
                            <comment id="15366614" author="markrmiller@gmail.com" created="Thu, 7 Jul 2016 19:06:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sure, with weird enough topology&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think it takes a weird topology - just more replicas than thread to load them in a shard.&lt;/p&gt;

&lt;p&gt;The current behavior is trappy if you want to try and load tons and tons of cores. The change in behavior is trappy in general.&lt;/p&gt;

&lt;p&gt;I think we always anticipated a better strategy to deal with this, but I don&apos;t think this does it very well.&lt;/p&gt;</comment>
                            <comment id="15366618" author="markrmiller@gmail.com" created="Thu, 7 Jul 2016 19:09:50 +0000"  >&lt;p&gt;One strategy might be to only require a certain number of replicas participate in an election to elect a leader and then tie that to the number of threads used to load replicas and then start replicas in some intelligent, per shard manner.&lt;/p&gt;</comment>
                            <comment id="15366690" author="erickerickson" created="Thu, 7 Jul 2016 20:02:04 +0000"  >&lt;p&gt;bq: I don&apos;t think it takes a weird topology - just more replicas than thread to load them in a shard.&lt;/p&gt;

&lt;p&gt;OK, I think I see what you&apos;re saying. You&apos;re talking about a &quot;deep&quot; topology, i.e. one with many replicas on a particular shard on a particular instance and I was looking at a &quot;wide&quot; topology, many collections per instance but each shard had only a few replicas. I&apos;ve seen both in the field as I&apos;m sure you have....&lt;/p&gt;

&lt;p&gt;How much of both situations would be handled by creating an ordered list of all replicas that were leaders and loading those first then loading an ordered list of all replicas that weren&apos;t labeled as leader? There&apos;s still the case of a zillion leaders on a single instance, so some heuristic like you suggest seems to be in order.&lt;/p&gt;

&lt;p&gt;I&apos;ll emphasize though that the current code (without this patch) can prevent a cluster from coming up at &lt;em&gt;all&lt;/em&gt;. With this patch the cluster at least comes up, albeit slowly if the leaderVoteWait comes into play. Bumping the number of threads to &amp;gt; the max replicas for a shard can handle the case you mentioned while keeping it &quot;reasonable&quot; can deal with the one I&apos;m seeing.&lt;/p&gt;

&lt;p&gt;That said, I think the default should be quite high in the cloud case so we don&apos;t change the current behavior and let situations like I&apos;m seeing deal with configuring this. I think it defaults to 8 currently, perhaps 100 (or unlimited) instead in cloud mode?&lt;/p&gt;

&lt;p&gt;How much of all of the above makes this patch &quot;good enough for now&quot; with perhaps follow-ons on more sophisticated approaches?&lt;/p&gt;</comment>
                            <comment id="15366703" author="markrmiller@gmail.com" created="Thu, 7 Jul 2016 20:15:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ll emphasize though that the current code (without this patch) can prevent a cluster from coming up at all.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The current code is a fix to a bug that existed when we did something like this before &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I don&apos;t want to reintroduce the bug. We didn&apos;t, and as far as I know still don&apos;t, support tons of cores very well. As we move to do that, we don&apos;t want to reintroduce bugs though.&lt;/p&gt;</comment>
                            <comment id="15366705" author="markrmiller@gmail.com" created="Thu, 7 Jul 2016 20:17:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;That said, I think the default should be quite high in the cloud case so we don&apos;t change the current behavior and let situations like I&apos;m seeing deal with configuring this. I think it defaults to 8 currently, perhaps 100 (or unlimited) instead in cloud mode?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s trappy, whatever the default is. Unless we don&apos;t let users create shards with that many replicas or something.&lt;/p&gt;</comment>
                            <comment id="15366706" author="markrmiller@gmail.com" created="Thu, 7 Jul 2016 20:19:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;Unless we don&apos;t let users create shards with that many replicas or something.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Although even that is probably not enough unless we only load one shard at a time.&lt;/p&gt;</comment>
                            <comment id="15367410" author="noble.paul" created="Fri, 8 Jul 2016 08:52:13 +0000"  >&lt;p&gt;Had a chat with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; and came up with the following design.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Objectives&quot;&gt;&lt;/a&gt;Objectives&lt;/h4&gt;

&lt;ul&gt;
	&lt;li&gt;Move away from the current design of infinite number of threads for core loads which leads to OOM or other issues&lt;/li&gt;
	&lt;li&gt;Avoid the leaderVoitWait problem which leads to shards with no leader for a long time or even (down shards)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Blindly sorting cores based on replica names is not foolproof. It can lead to deadlocks depending on how the replicas are distributed. The sorting logic could be as follows.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;CoreSortinglogic&quot;&gt;&lt;/a&gt;Core Sorting logic&lt;/h5&gt;
&lt;p&gt;When a node comes up, it reads the list of live nodes and the states  of each collection it hosts. Construct a List of shards &lt;tt&gt;collectionName+shardName&lt;/tt&gt; it hosts sorted by the (no:of replicas for that shard in other started nodes + no:of replicas present in the current node for that replica) . Break the tie by sorting the name in alphabetic &lt;tt&gt;collectionName+shardName&lt;/tt&gt;  order. This ensures that no other node is waiting for some replica in this node to be up.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Threadcount&quot;&gt;&lt;/a&gt;Thread count&lt;/h5&gt;
&lt;p&gt;The default no:of &lt;tt&gt;coreLoadThreads&lt;/tt&gt; should be much higher for SolrCloud (Maybe 50 ?). The user should be able to override the value by explicitly configuring it. &lt;/p&gt;
</comment>
                            <comment id="15374195" author="damienka" created="Wed, 13 Jul 2016 02:22:36 +0000"  >&lt;p&gt;Or, ensure that the coreLoadThreads is &amp;gt;= max(collection&apos;s replicas on a single node) ?&lt;/p&gt;</comment>
                            <comment id="15374825" author="noble.paul" created="Wed, 13 Jul 2016 10:48:05 +0000"  >&lt;p&gt;A patch with tests implementing the new  design (with some change). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; please take a look&lt;/p&gt;
</comment>
                            <comment id="15374914" author="noble.paul" created="Wed, 13 Jul 2016 12:25:37 +0000"  >&lt;p&gt;The sorting of shards to be loaded in the following order&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The shards with least no:of replicas in &lt;b&gt;down&lt;/b&gt; nodes and there is at least one live node waiting for replicas of this shard. If these nodes are in &lt;b&gt;down&lt;/b&gt; nodes, it is no use bringing up a replica because, until those &lt;b&gt;down&lt;/b&gt; nodes come up, that shard cannot be up&lt;/li&gt;
	&lt;li&gt;The shards with max no:of replica in &lt;b&gt;live&lt;/b&gt; nodes. Because more replicas in other nodes are waiting for this replica to be up&lt;/li&gt;
	&lt;li&gt;least no:of replicas in my node. This helps us finish a shard by starting the least no:of cores&lt;/li&gt;
	&lt;li&gt;finally, use the replica name to break the tie .this  helps in having a predictable order across nodes&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The thread count is set to 24 as the default in cloud. However, users can override that &lt;/p&gt;
</comment>
                            <comment id="15374924" author="noble.paul" created="Wed, 13 Jul 2016 12:33:07 +0000"  >&lt;p&gt;there was a bug in the previous patch &lt;/p&gt;</comment>
                            <comment id="15380062" author="shalinmangar" created="Fri, 15 Jul 2016 20:34:06 +0000"  >&lt;p&gt;What was the motivation behind changing the sorting logic? Can you please explain what use-cases does the new logic cover better?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The shards with least no:of replicas in down nodes and there is at least one live node waiting for replicas of this shard. If these nodes are in down nodes, it is no use bringing up a replica because, until those down nodes come up, that shard cannot be up&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is flawed because with these rules, a shard which has exactly 1 replica in total and that too on the current node will always be chosen last.&lt;/p&gt;</comment>
                            <comment id="15380105" author="shalinmangar" created="Fri, 15 Jul 2016 20:59:49 +0000"  >&lt;p&gt;Hmm, actually the logic we had discussed earlier also fails on this corner case. Let me think more on this.&lt;/p&gt;</comment>
                            <comment id="15380477" author="noble.paul" created="Sat, 16 Jul 2016 04:15:01 +0000"  >&lt;p&gt;Shalin, that is the expected behavior. If there is only one replica for a shard and  that replica is in this node, then nobody else is waiting for that replica to come up.that means nobody else will wait time out because of that replica.&lt;/p&gt;</comment>
                            <comment id="15380491" author="shalinmangar" created="Sat, 16 Jul 2016 04:54:19 +0000"  >&lt;p&gt;Ah, right, I missed that. I&apos;m reviewing the rest of the patch.&lt;/p&gt;</comment>
                            <comment id="15380759" author="jira-bot" created="Sat, 16 Jul 2016 13:43:12 +0000"  >&lt;p&gt;Commit 6c1b75b06bf2fe53be776923097e54b8c560826d in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6c1b75b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6c1b75b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: In cloud-mode sort the cores smartly before loading &amp;amp; limit threads to improve cluster stability&lt;/p&gt;</comment>
                            <comment id="15380791" author="jira-bot" created="Sat, 16 Jul 2016 14:25:11 +0000"  >&lt;p&gt;Commit 74633594d891d3f6eff61ad39310f6410dbfc313 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7463359&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7463359&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: precommit errors&lt;/p&gt;</comment>
                            <comment id="15380855" author="jira-bot" created="Sat, 16 Jul 2016 17:12:48 +0000"  >&lt;p&gt;Commit 6902eddd8df66b6120730eccf179797b6a585848 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6902edd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6902edd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: In cloud-mode sort the cores smartly before loading &amp;amp; limit threads to improve cluster stability&lt;/p&gt;</comment>
                            <comment id="15380860" author="jira-bot" created="Sat, 16 Jul 2016 17:20:52 +0000"  >&lt;p&gt;Commit 5932f52588a2773b2fb87feee8a3501eb8c5cb5c in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5932f52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5932f52&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: In cloud-mode sort the cores smartly before loading &amp;amp; limit threads to improve cluster stability&lt;/p&gt;</comment>
                            <comment id="15382476" author="mdrob" created="Mon, 18 Jul 2016 15:41:05 +0000"  >&lt;p&gt;minor nit: when compiling I see &lt;tt&gt;[javac] /home/mdrob/workspace/lucene-solr/solr/core/src/java/org/apache/solr/core/CoreSorter.java:24: warning: documentation comment not expected here&lt;/tt&gt;. The javadoc should be after the package declaration.&lt;/p&gt;</comment>
                            <comment id="15382879" author="erickerickson" created="Mon, 18 Jul 2016 19:17:42 +0000"  >&lt;p&gt;Work in progress patch for back-porting to 5x, just re-doing the lambdas.&lt;/p&gt;

&lt;p&gt;WIP because I just noticed that the new test class &lt;em&gt;also&lt;/em&gt; has lambdas that have not been changed in this patch. Even so, I could still compile the server and run my test suite on it.&lt;/p&gt;

&lt;p&gt;Results:&lt;/p&gt;

&lt;p&gt;This is &lt;em&gt;vastly&lt;/em&gt; better than the old 5x code, I don&apos;t get OOM errors and the like. Occasionally I&apos;ll get 1 or two replicas (out of 1,600) that stay in the &quot;down&quot; state, but do come back up when I restart the Solr instance hosting them.&lt;/p&gt;

&lt;p&gt;At Ishan&apos;s suggestion I applied my 5x patch to a clean 6x code base and don&apos;t see any replicas staying down there (so far) so it looks like some other changes between 5x and 6x are making the startup process more robust as well.&lt;/p&gt;</comment>
                            <comment id="15382916" author="mdrob" created="Mon, 18 Jul 2016 19:34:19 +0000"  >&lt;p&gt;regarding the lambdas in the test, is there a functional difference between what is there and something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    expect(mockCC.isZooKeeperAware()).andReturn(&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE).anyTimes();
    expect(mockCC.getZkController()).andReturn(mockZKC).anyTimes();
    expect(mockClusterState.getLiveNodes()).andReturn(liveNodes).anyTimes();
    expect(mockZKC.getClusterState()).andReturn(mockClusterState).anyTimes();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looks like a lot of complexity added from the lambdas, but I&apos;m not sure if there is a more subtle nuance.&lt;/p&gt;</comment>
                            <comment id="15383138" author="mdrob" created="Mon, 18 Jul 2016 21:46:07 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getCoreLoadThreadCount() {
-    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; coreLoadThreads;
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getCoreLoadThreadCount(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; def) {
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; coreLoadThreads == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? def : coreLoadThreads;
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It might make sense for this to look like this instead:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getCoreLoadThreadCount(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; zkAware) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; coreLoadThreads == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? (zkAware ? DEFAULT_CORE_LOAD_THREADS_IN_CLOUD : DEFAULT_CORE_LOAD_THREADS) : coreLoadThreads;
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That was the standalone v cloud logic doesn&apos;t have to leak out as much. &lt;/p&gt;</comment>
                            <comment id="15383907" author="noble.paul" created="Tue, 19 Jul 2016 10:23:57 +0000"  >&lt;p&gt;&#128077;&lt;/p&gt;</comment>
                            <comment id="15384095" author="jira-bot" created="Tue, 19 Jul 2016 12:51:48 +0000"  >&lt;p&gt;Commit 2d1496c83d83bb6582af39af6cf272828d83c9e3 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2d1496c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2d1496c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: refactored to incorporate Mike&apos;s suggestions. Default thread count for cloud is limited to 8 now. In our internal teting 8 has given us the best stability during restarts&lt;/p&gt;</comment>
                            <comment id="15384125" author="jira-bot" created="Tue, 19 Jul 2016 13:13:19 +0000"  >&lt;p&gt;Commit fcd2cc57d595440de032cd3a58aabd72e69c3299 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=fcd2cc5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=fcd2cc5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: refactored to incorporate Mike&apos;s suggestions. Default thread count for cloud is limited to 8 now. In our internal teting 8 has given us the best stability during restarts&lt;/p&gt;</comment>
                            <comment id="15384263" author="jira-bot" created="Tue, 19 Jul 2016 14:46:54 +0000"  >&lt;p&gt;Commit 89a1fe661e7b73082d019543a83a7f511e74c9ca in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=89a1fe6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=89a1fe6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: refactored to incorporate Mike&apos;s suggestions. Default thread count for cloud is limited to 8 now. In our internal teting 8 has given us the best stability during restarts&lt;/p&gt;</comment>
                            <comment id="15384526" author="erickerickson" created="Tue, 19 Jul 2016 17:14:31 +0000"  >&lt;p&gt;Success! The problem I was having before was that I was &lt;em&gt;still&lt;/em&gt; getting OOM errors in my setup with the default 24 coreLoadTheads. Reducing it to 8 cured the problem, I ran my test setup all last night and there were zero problems.&lt;br/&gt;
I&apos;ve attached the patch for 5x. I had to re-implement the lambda expressions in the original, I &lt;em&gt;think&lt;/em&gt; I did the right thing in the new CoreSorterTest, but any checks welcome. This patch also sets the default coreLoadThreads to 8 as Noble discussed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob&quot; class=&quot;user-hover&quot; rel=&quot;mdrob&quot;&gt;mdrob&lt;/a&gt; thanks for the pointer on the junit stuff BTW. I didn&apos;t incorporate your other suggestion, but having it in 6x and 7x suffices I think.&lt;/p&gt;

&lt;p&gt;This passes precommit and test as well as my stress test.&lt;/p&gt;

&lt;p&gt;So, the question becomes should this be merged into the 5x code line so it&apos;ll be picked up by any (hypothetical) 5x releases or just left here and we&apos;ll deal with whether it should be included in any new 5x release when the time comes? Any firm opinions? This topic has come up on more than one occasion, but even checking it into 5x still means people would have to build it themselves.&lt;/p&gt;</comment>
                            <comment id="15384572" author="mdrob" created="Tue, 19 Jul 2016 17:42:24 +0000"  >&lt;p&gt;&lt;tt&gt;+    List&amp;lt;CountsForEachShard&amp;gt; l = new ArrayList&amp;lt;&amp;gt;();&lt;/tt&gt;&lt;br/&gt;
Could init this list to copy.size()&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;+    List&amp;lt;CloudDescriptor&amp;gt; ret = new ArrayList&amp;lt;&amp;gt;();&lt;/tt&gt;&lt;br/&gt;
Same idea here, cc.getCores().size()&lt;/p&gt;

&lt;p&gt;Other than that, your unwrapped lambdas look fine to me.&lt;/p&gt;</comment>
                            <comment id="15384614" author="noble.paul" created="Tue, 19 Jul 2016 18:09:38 +0000"  >&lt;p&gt;backported the changes I committed to 6x today&lt;/p&gt;</comment>
                            <comment id="15386201" author="jira-bot" created="Wed, 20 Jul 2016 16:56:33 +0000"  >&lt;p&gt;Commit 9fbb2fe752b5baa224c33e0fd441cfb9082dd102 in lucene-solr&apos;s branch refs/heads/branch_5_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9fbb2fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9fbb2fe&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: Load cores in sorted order &amp;amp; limit threads to improve cluster stability&lt;/p&gt;</comment>
                            <comment id="15386729" author="jira-bot" created="Wed, 20 Jul 2016 22:23:04 +0000"  >&lt;p&gt;Commit bcaf4999d83a5a4cbc7f02ecc8d1f00e4a4a7212 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bcaf499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bcaf499&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7280&quot; title=&quot;Load cores in sorted order and tweak coreLoadThread counts to improve cluster stability on restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7280&quot;&gt;&lt;del&gt;SOLR-7280&lt;/del&gt;&lt;/a&gt;: Load cores in sorted order &amp;amp; limit threads to improve cluster stability&lt;br/&gt;
(cherry picked from commit 9fbb2fe)&lt;/p&gt;</comment>
                            <comment id="15388304" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 19:49:36 +0000"  >&lt;p&gt;Did this just reintroduce the old bug if you do &amp;gt; 8 replicas or it tried to address it somehow?&lt;/p&gt;</comment>
                            <comment id="15388312" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 19:54:33 +0000"  >&lt;p&gt;Yeah, looks like I have the same issue as I mentioned.&lt;/p&gt;

&lt;p&gt;I&apos;ve got to veto this commit unless that issue is addressed nicely or (the ugly fix) you just make it fail if someone tries to create a shard with more replica than load threads.&lt;/p&gt;</comment>
                            <comment id="15388314" author="erickerickson" created="Thu, 21 Jul 2016 19:55:43 +0000"  >&lt;p&gt;Not in my testing, but I&apos;ll give it another whirl tonight just to be sure.&lt;/p&gt;

&lt;p&gt;I&apos;m thinking of, say, 3 collections spread over 4 JVMS each with &lt;br/&gt;
3 shards each with 150 replicas and 3 coreLoadThreads....&lt;/p&gt;

&lt;p&gt;Plus I&apos;ll vary the order of bring the JVMs up and loop all night&lt;br/&gt;
that way.&lt;/p&gt;

&lt;p&gt;I&apos;ve already go the infrastructure in place....&lt;/p&gt;
</comment>
                            <comment id="15388323" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 20:00:55 +0000"  >&lt;p&gt;I have no problem if it works.&lt;/p&gt;

&lt;p&gt;Perhaps some other unrelated changes have influenced how the load threads interact with leader election.&lt;/p&gt;

&lt;p&gt;I just don&apos;t see the problem explained or addressed and there is a previous JIRA issue with this exact problem. The only way I can see it would still not be a problem is if waiting for a leader doesn&apos;t hold up core loading. I don&apos;t remember seeing that change though.&lt;/p&gt;

&lt;p&gt;You may not be able to test this simply with tests either - many tests lower the leaderVoteWait to very low to speed up tests. In production it should be like 3 minutes by default.&lt;/p&gt;</comment>
                            <comment id="15388349" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 20:13:38 +0000"  >&lt;p&gt;If it indeed remains an issue, another thing we might try is loading cores with a limited number of threads, but registering with ZK with many more, instead of doing both in the same thread as we are now.&lt;/p&gt;</comment>
                            <comment id="15388376" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 20:33:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Plus I&apos;ll vary the order of bring the JVMs up and loop all night&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;that way.&lt;/p&gt;

&lt;p&gt;If you simply do that and walk away and come back in the morning, it will work. The bug is that starting your shard will go from as fast as possible to 3 minutes plus just because you created too many replicas. And not only will it take 3 minutes, but all the replicas will not participate in the election as is currently designed. That&apos;s a bug, and one we have already fixed and one I&apos;m not willing to allow back &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15388442" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 21:16:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob&quot; class=&quot;user-hover&quot; rel=&quot;mdrob&quot;&gt;mdrob&lt;/a&gt; made a nice little test for this and the initial results make it look something was fishy before this or after it. Need to dig into it a little more.&lt;/p&gt;</comment>
                            <comment id="15388456" author="markrmiller@gmail.com" created="Thu, 21 Jul 2016 21:23:44 +0000"  >&lt;p&gt;Okay, I think I got it.&lt;/p&gt;

&lt;p&gt;At some point after the bug I&apos;m referring to was resolved, registering in ZK got spun off into it&apos;s own thread and no longer holds up the core load thread. You can see this in ZkContainer. That effectively creates the situation I suggest above:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If it indeed remains an issue, another thing we might try is loading cores with a limited number of threads, but registering with ZK with many more, instead of doing both in the same thread as we are now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So we are okay on this issue. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob&quot; class=&quot;user-hover&quot; rel=&quot;mdrob&quot;&gt;mdrob&lt;/a&gt;, it would be great to get some form of that test committed.&lt;/p&gt;</comment>
                            <comment id="15388529" author="mdrob" created="Thu, 21 Jul 2016 22:23:24 +0000"  >&lt;p&gt;This is the test that Mark was talking about. (attached)&lt;/p&gt;</comment>
                            <comment id="15388538" author="mdrob" created="Thu, 21 Jul 2016 22:28:27 +0000"  >&lt;p&gt;If anybody wants to apply that, they should also add a call to &lt;tt&gt;resetFactory()&lt;/tt&gt; in the &lt;tt&gt;@AfterClass&lt;/tt&gt; that I missed.&lt;/p&gt;</comment>
                            <comment id="15388541" author="erickerickson" created="Thu, 21 Jul 2016 22:29:49 +0000"  >&lt;p&gt;Well, I&apos;ll still test it for fun, if _you&apos;re_worried I should be more se. But it sounds like you&apos;re getting more comfortable with the approach.&lt;/p&gt;

&lt;p&gt;Anyway, a couple of things:&lt;/p&gt;

&lt;p&gt;bq: If you simply do that and walk away and come back in the morning, it will work....&lt;/p&gt;

&lt;p&gt;These aren&apos;t Junit tests, but scripts because of similar concerns I had. They:&lt;br/&gt;
1&amp;gt; bring up and down real solr JVMs via shell scripts, so the default 3 minute timeout is in place That said, making it longer (say 20 minutes?) would emphasize the issue....and...&lt;br/&gt;
2&amp;gt; I have a monitor process that records how long it took for all the replicas to come up so I can see any anomalies.&lt;br/&gt;
3&amp;gt; brings JVMs up and down in different orders to avoid happening to have all the leaders on the first node that comes up.&lt;/p&gt;

&lt;p&gt;I&apos;ve been nervous that the way I&apos;m testing certainly isn&apos;t foolproof.&lt;/p&gt;

&lt;p&gt;bq: registering in ZK got spun off into it&apos;s own thread&lt;/p&gt;

&lt;p&gt;Hmm, interesting since the symptom I&apos;m seeing is being unable to spawn native threads and a large spike in threads during startup (steady-state 1,200 threads, startup started crapping out around 2,600)..... upping the Xmx or Xss (or both) doesn&apos;t matter and bumping the ulimit didn&apos;t either....&lt;/p&gt;
</comment>
                            <comment id="15388992" author="noble.paul" created="Fri, 22 Jul 2016 06:25:22 +0000"  >&lt;p&gt;It should work even if there is only one thread and many replicas. The idea is to sort your cores first in such a way that you prioritize replicas others are waiting for and deprioritize cores which depend on other &apos;down&apos; nodes. So, this node will should not timeout.&lt;/p&gt;</comment>
                            <comment id="15389669" author="erickerickson" created="Fri, 22 Jul 2016 15:20:35 +0000"  >&lt;p&gt;Tests ran find last night FWIW...&lt;/p&gt;</comment>
                            <comment id="15390812" author="noble.paul" created="Sat, 23 Jul 2016 18:48:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mdrob%40cloudera.com&quot; class=&quot;user-hover&quot; rel=&quot;mdrob@cloudera.com&quot;&gt;mdrob@cloudera.com&lt;/a&gt; why do you want to test with &lt;tt&gt;createCollection(collection, &quot;conf1&quot;, 1, NodeConfigBuilder.DEFAULT_CORE_LOAD_THREADS_IN_CLOUD * 3)&lt;/tt&gt;. Why not keep it at the default &lt;tt&gt;8&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;{{ // we only need 1 node because we&apos;re going to be shoving all of the replicas on there to promote deadlock}}&lt;/p&gt;

&lt;p&gt;How do you plan to get a deadlock if you are only going to have one node? The deadlock happens because a node waits for other nodes to come up and those nodes wait for this node (directly or through a circular dependency)&lt;/p&gt;</comment>
                            <comment id="15390819" author="markrmiller@gmail.com" created="Sat, 23 Jul 2016 19:23:26 +0000"  >&lt;p&gt;You only need one node because this issue is about loading cores on one node. You also of course need more replicas than load threads to stimulate the old issue. &lt;/p&gt;

&lt;p&gt;The one issue with the test is I don&apos;t think it would fail nicely if the problem was reintroduced as it was when I saw it? As I saw it, if the problem was reintroduced the test would just take longer.&lt;/p&gt;

&lt;p&gt;We should probably just make sure it doesn&apos;t take 180 seconds + (or whatever we set the leaderVoteWait to in the test) to startup and elect a leader, and if it does, fail with a nice message.&lt;/p&gt;</comment>
                            <comment id="15390820" author="markrmiller@gmail.com" created="Sat, 23 Jul 2016 19:25:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;But it sounds like you&apos;re getting more comfortable with the approach.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It has nothing to do with being comfortable with the approach. There was an existing bug that was fixed that no one working on this issue seems to yet comprehend. Which had me worried the problem still existed. I found that another change from another JIRA has decoupled core loading and leader election. All as I mention above. Details matter.&lt;/p&gt;</comment>
                            <comment id="15391586" author="noble.paul" created="Mon, 25 Jul 2016 09:16:08 +0000"  >&lt;p&gt;the zk register threads are still unbounded and that is done asynchronously. We are just limiting the core load threads. &lt;/p&gt;

&lt;p&gt;So, after this fix, we will not have this reoccurring if there is only one node. It is more important to  test it in a multi-node setup&lt;/p&gt;</comment>
                            <comment id="15392129" author="erickerickson" created="Mon, 25 Jul 2016 15:44:01 +0000"  >&lt;p&gt;Do note that all of my (non jUnit) tests were with 4 nodes. Of course having those built into junit tests is A Good Thing, just FYI.&lt;/p&gt;</comment>
                            <comment id="15436272" author="erickerickson" created="Thu, 25 Aug 2016 04:41:09 +0000"  >&lt;p&gt;Didn&apos;t close this when the code was committed.&lt;/p&gt;</comment>
                            <comment id="15439019" author="mikemccand" created="Fri, 26 Aug 2016 14:00:05 +0000"  >&lt;p&gt;Bulk close resolved issues after 6.2.0 release.&lt;/p&gt;</comment>
                            <comment id="15704322" author="dk" created="Tue, 29 Nov 2016 05:57:19 +0000"  >&lt;p&gt;I&apos;ve just been testing this and found a couple of issues:&lt;/p&gt;

&lt;p&gt;All the core registrations are done in background threads. This can flood the overseer queue. See CoreContainer.load() calls zkSys.registerInZk(core, true, false);&lt;/p&gt;

&lt;p&gt;I&apos;ve increased leaderConflictResolveWait to 30min but every 15s I can see:&lt;br/&gt;
org.apache.solr.handler.admin.PrepRecoveryOp; After 15 seconds, core ip_1224_shard1_replica1 (shard1 of ip_1224) still does not have state: recovering; forcing ClusterState update from ZooKeeper&lt;br/&gt;
Again, I think this can flood the overseer queue.&lt;/p&gt;</comment>
                            <comment id="15705464" author="markrmiller@gmail.com" created="Tue, 29 Nov 2016 14:42:44 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dk&quot; class=&quot;user-hover&quot; rel=&quot;dk&quot;&gt;dk&lt;/a&gt;, could you file a new JIRA issue with this info and link it to this one?&lt;/p&gt;

&lt;p&gt;Sounds like you are probably correct, but this issue has already been released so any further changes or improvements needs a fresh issue on top of notifying the original issue.&lt;/p&gt;</comment>
                            <comment id="15705501" author="markrmiller@gmail.com" created="Tue, 29 Nov 2016 14:53:57 +0000"  >&lt;p&gt;It would seem the next step is probably to make the ZkController#preRegister phase more efficient. We would want to try and avoid all the individual down publish calls. This is what initially populates those entries in ZK though, which is why this was not simply switched to a more efficient &apos;down&apos; node Overseer action like some other places. We may need another bulk Overseer command or perhaps we can expand the &apos;down&apos; node one.&lt;/p&gt;</comment>
                            <comment id="17061365" author="dsmiley" created="Wed, 18 Mar 2020 03:39:18 +0000"  >&lt;p&gt;This is an old issue but nonetheless I want to bring to attention that the CoreSorter introduced here isn&apos;t doing its job.&#160; It only does so in its unit test but not in real-world usage (actual use inside CoreContainer).&#160; See &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14342&quot; title=&quot;CoreSorter is partially broken, thus core loading order is sub-optimal&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14342&quot;&gt;&lt;del&gt;SOLR-14342&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                                                <inwardlinks description="is fixed by">
                                        <issuelink>
            <issuekey id="13292332">SOLR-14342</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12818878" name="SOLR-7280-5x.patch" size="23829" author="noble.paul" created="Tue, 19 Jul 2016 18:09:38 +0000"/>
                            <attachment id="12818860" name="SOLR-7280-5x.patch" size="23720" author="erickerickson" created="Tue, 19 Jul 2016 17:14:31 +0000"/>
                            <attachment id="12818623" name="SOLR-7280-5x.patch" size="24006" author="erickerickson" created="Mon, 18 Jul 2016 19:17:42 +0000"/>
                            <attachment id="12819483" name="SOLR-7280-test.patch" size="6522" author="mdrob" created="Thu, 21 Jul 2016 22:23:24 +0000"/>
                            <attachment id="12817669" name="SOLR-7280.patch" size="23944" author="noble.paul" created="Wed, 13 Jul 2016 12:33:07 +0000"/>
                            <attachment id="12815476" name="SOLR-7280.patch" size="4611" author="noble.paul" created="Thu, 30 Jun 2016 14:31:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i272fb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>