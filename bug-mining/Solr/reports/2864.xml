<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:11:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8738] invalid DBQ initially sent to a non-leader node will report success</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8738</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Discovered this while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-445&quot; title=&quot;Update Handlers abort with bad documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-445&quot;&gt;&lt;del&gt;SOLR-445&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If a Delete By Query gets sent to a node which is not hosting a leader (ie: only hosts replicas, or doesn&apos;t host any cores related to the specified collection) then a success will be returned, even if the DBQ is completely malformed and actually failed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12944621">SOLR-8738</key>
            <summary>invalid DBQ initially sent to a non-leader node will report success</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Feb 2016 19:32:56 +0000</created>
                <updated>Mon, 9 May 2016 18:47:14 +0000</updated>
                            <resolved>Thu, 21 Apr 2016 22:29:47 +0000</resolved>
                                                    <fixVersion>5.5.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15167711" author="hossman" created="Thu, 25 Feb 2016 19:33:26 +0000"  >&lt;p&gt;The most trivial/obvious way to reproduce is...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;bin/solr -e cloud&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Pick &quot;&lt;b&gt;3&lt;/b&gt;&quot; for number of nodes&lt;/li&gt;
	&lt;li&gt;accept the default port numbers (8983, 7574, 8984)&lt;/li&gt;
	&lt;li&gt;accept the default collection name (gettingstarted)&lt;/li&gt;
	&lt;li&gt;pick &quot;&lt;b&gt;1&lt;/b&gt;&quot; for the number of shards&lt;/li&gt;
	&lt;li&gt;accept the default number of replicas per shard (2)&lt;/li&gt;
	&lt;li&gt;accept the default config set (data_driven_schema_configs)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(So now you should have a single collection with a single shard with 2 replicas on 2 diff nodes and the remaining node doesn&apos;t host any cores related to the collection)&lt;/p&gt;

&lt;p&gt;Now try running a broken DBQ against all 3 nodes...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ curl -H &apos;Content-Type: application/json&apos; &apos;http://127.0.1.1:8983/solr/gettingstarted/update&apos; --data-binary &apos;{&quot;delete&quot;:{&quot;query&quot; : &quot;foo_i:yak&quot;}}&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:400,&quot;QTime&quot;:18},&quot;error&quot;:{&quot;metadata&quot;:[&quot;error-class&quot;,&quot;org.apache.solr.common.SolrException&quot;,&quot;root-error-class&quot;,&quot;org.apache.solr.common.SolrException&quot;],&quot;msg&quot;:&quot;Invalid Number: yak&quot;,&quot;code&quot;:400}}
$ curl -H &apos;Content-Type: application/json&apos; &apos;http://127.0.1.1:8984/solr/gettingstarted/update&apos; --data-binary &apos;{&quot;delete&quot;:{&quot;query&quot; : &quot;foo_i:yak&quot;}}&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:25}}
$ curl -H &apos;Content-Type: application/json&apos; &apos;http://127.0.1.1:7574/solr/gettingstarted/update&apos; --data-binary &apos;{&quot;delete&quot;:{&quot;query&quot; : &quot;foo_i:yak&quot;}}&apos;
{&quot;responseHeader&quot;:{&quot;status&quot;:0,&quot;QTime&quot;:7}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...only the node hosting the leader correctly repsponds back with the error, requests that initially hit nodes only hosting replicas or not hosting any cores incorrectly indicate that the delete succeeded.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;2 important notes:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;This can also be reproduced using &lt;tt&gt;numShards &amp;gt; 1&lt;/tt&gt;, most easily by running &lt;tt&gt;-e cloud&lt;/tt&gt; and choosing &lt;b&gt;4&lt;/b&gt; nodes, and accepting the default 2 shards, 2 replicas.  Then repeat the same curl commands above over all 4 ports.
	&lt;ul&gt;
		&lt;li&gt;you should see 2 nodes correctly return failures, and 2 nodes incorrectly claim success&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;You can also reproduce using &lt;tt&gt;-e cloud -noprompt&lt;/tt&gt; but since that that defaults to only 2 nodes they are garunteed to each have a leader on them, so you have to be more explicit about the requests.
	&lt;ul&gt;
		&lt;li&gt;Use the Solr UI to determine the &lt;em&gt;non-leader&lt;/em&gt; core_node_names (ex: &lt;tt&gt;gettingstarted_shard1_replica1&lt;/tt&gt;) and which node they are located on, then use those in url instead of the simple collection name (otherwise smple collection paths will be auto-route to a leader on each node)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


</comment>
                            <comment id="15167914" author="hossman" created="Thu, 25 Feb 2016 21:38:08 +0000"  >&lt;p&gt;here&apos;s a MiniSolrCloudCluster based test patch i hacked out of the existing &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-445&quot; title=&quot;Update Handlers abort with bad documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-445&quot;&gt;&lt;del&gt;SOLR-445&lt;/del&gt;&lt;/a&gt; work demonstrating the problem.&lt;/p&gt;

&lt;p&gt;still tracing trough to try and figure out why the errors aren&apos;t getting propogated.&lt;/p&gt;</comment>
                            <comment id="15169479" author="hossman" created="Fri, 26 Feb 2016 18:29:28 +0000"  >&lt;p&gt;The crux of why the errors are silently ignored seems to be because &lt;tt&gt;DUP.doFinish()&lt;/tt&gt; only logs a WARN &amp;#8211; but does not propogate &amp;#8211; any error returned by &lt;tt&gt;cmdDistrib.getErrors();&lt;/tt&gt; unless the type of Node involved in the request was a &lt;tt&gt;RetryNode&lt;/tt&gt;.  The reason given for this being...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; now we don&apos;t error - we assume &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it was added locally, we
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// succeeded &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem aparently being that when a DBQ is forwarded to all leaders, &lt;tt&gt;StdNode&lt;/tt&gt; is (currently) used &amp;#8211; but there was no local operation executed, only the forward to the leaders, so there is no local success/failure.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;The attached patch changes the DBQ propagation logic to use &lt;tt&gt;RetryNode&lt;/tt&gt; &amp;#8211; i&apos;m still running full tests, but at a minimum it makes the new &lt;tt&gt;TestCloudDeleteByQuery&lt;/tt&gt; in the patch start passing.&lt;/p&gt;

&lt;p&gt;i don&apos;t fully understand the entire ramifications of this change, particularly as it relates to rest of the code in &lt;tt&gt;DUP.doFinish&lt;/tt&gt; and things like forcing leader recovery, but based on the comments on the &lt;tt&gt;StdNode&lt;/tt&gt; / &lt;tt&gt;RetryNode&lt;/tt&gt; classes and the other uses of &lt;tt&gt;StdNode&lt;/tt&gt; / &lt;tt&gt;RetryNode&lt;/tt&gt;&lt;tt&gt;RetryNode&lt;/tt&gt; (notably: STD-&amp;gt;replica vs RETRY-&amp;gt;leader) this seems like the most correct fix in general.&lt;/p&gt;</comment>
                            <comment id="15172958" author="hossman" created="Tue, 1 Mar 2016 00:17:32 +0000"  >&lt;p&gt;Updated patch to refactor test to take advantage of SolrCloudTestCase added by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8758&quot; title=&quot;Add SolrCloudTestCase base class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8758&quot;&gt;&lt;del&gt;SOLR-8758&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Still need someone who actually understands this code to review the non-test changes.&lt;/p&gt;</comment>
                            <comment id="15173921" author="noble.paul" created="Tue, 1 Mar 2016 15:44:31 +0000"  >&lt;p&gt;It is easy to understand why and how this fix works. &lt;br/&gt;
But it&apos;s kinda hard to understand why DUP is written to look at classname to propagate the errors. &lt;/p&gt;

&lt;p&gt;+1 to commit&lt;/p&gt;</comment>
                            <comment id="15174037" author="jira-bot" created="Tue, 1 Mar 2016 17:06:51 +0000"  >&lt;p&gt;Commit ff6557cbcb5308d60f17114de1d0ad29003e9668 in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-445&quot; title=&quot;Update Handlers abort with bad documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-445&quot;&gt;&lt;del&gt;SOLR-445&lt;/del&gt;&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman_lucene%40fucit.org&quot; class=&quot;user-hover&quot; rel=&quot;hossman_lucene@fucit.org&quot;&gt;hossman_lucene@fucit.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ff6557c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ff6557c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8738&quot; title=&quot;invalid DBQ initially sent to a non-leader node will report success&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8738&quot;&gt;&lt;del&gt;SOLR-8738&lt;/del&gt;&lt;/a&gt;: Fixed false success response when invalid deleteByQuery requests intially hit non-leader cloud nodes&lt;/p&gt;</comment>
                            <comment id="15174040" author="jira-bot" created="Tue, 1 Mar 2016 17:06:56 +0000"  >&lt;p&gt;Commit 2401c9495319e1b5065b05ef3a36ee586f06b6d4 in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-445&quot; title=&quot;Update Handlers abort with bad documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-445&quot;&gt;&lt;del&gt;SOLR-445&lt;/del&gt;&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman_lucene%40fucit.org&quot; class=&quot;user-hover&quot; rel=&quot;hossman_lucene@fucit.org&quot;&gt;hossman_lucene@fucit.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2401c94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2401c94&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-445&quot; title=&quot;Update Handlers abort with bad documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-445&quot;&gt;&lt;del&gt;SOLR-445&lt;/del&gt;&lt;/a&gt; Merge branch &apos;master&apos; into jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-445&quot; title=&quot;Update Handlers abort with bad documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-445&quot;&gt;&lt;del&gt;SOLR-445&lt;/del&gt;&lt;/a&gt; (pick up &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8738&quot; title=&quot;invalid DBQ initially sent to a non-leader node will report success&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8738&quot;&gt;&lt;del&gt;SOLR-8738&lt;/del&gt;&lt;/a&gt; changes)&lt;/p&gt;</comment>
                            <comment id="15174041" author="jira-bot" created="Tue, 1 Mar 2016 17:06:57 +0000"  >&lt;p&gt;Commit ff6557cbcb5308d60f17114de1d0ad29003e9668 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman_lucene%40fucit.org&quot; class=&quot;user-hover&quot; rel=&quot;hossman_lucene@fucit.org&quot;&gt;hossman_lucene@fucit.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ff6557c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ff6557c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8738&quot; title=&quot;invalid DBQ initially sent to a non-leader node will report success&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8738&quot;&gt;&lt;del&gt;SOLR-8738&lt;/del&gt;&lt;/a&gt;: Fixed false success response when invalid deleteByQuery requests intially hit non-leader cloud nodes&lt;/p&gt;</comment>
                            <comment id="15252744" author="anshumg" created="Thu, 21 Apr 2016 21:09:24 +0000"  >&lt;p&gt;Reopening for 5.5.1&lt;/p&gt;</comment>
                            <comment id="15252820" author="jira-bot" created="Thu, 21 Apr 2016 21:49:32 +0000"  >&lt;p&gt;Commit 9e77319abcf3ff372b86cec4d66bac11f7e038b6 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman_lucene%40fucit.org&quot; class=&quot;user-hover&quot; rel=&quot;hossman_lucene@fucit.org&quot;&gt;hossman_lucene@fucit.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9e77319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9e77319&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8738&quot; title=&quot;invalid DBQ initially sent to a non-leader node will report success&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8738&quot;&gt;&lt;del&gt;SOLR-8738&lt;/del&gt;&lt;/a&gt;: Fixed false success response when invalid deleteByQuery requests intially hit non-leader cloud nodes&lt;/p&gt;</comment>
                            <comment id="15252873" author="jira-bot" created="Thu, 21 Apr 2016 22:14:59 +0000"  >&lt;p&gt;Commit 66d3c2eb0a1e7b28621557c87c8d5b5219a95add in lucene-solr&apos;s branch refs/heads/branch_5_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman_lucene%40fucit.org&quot; class=&quot;user-hover&quot; rel=&quot;hossman_lucene@fucit.org&quot;&gt;hossman_lucene@fucit.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=66d3c2e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=66d3c2e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8738&quot; title=&quot;invalid DBQ initially sent to a non-leader node will report success&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8738&quot;&gt;&lt;del&gt;SOLR-8738&lt;/del&gt;&lt;/a&gt;: Fixed false success response when invalid deleteByQuery requests intially hit non-leader cloud nodes&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12385211">SOLR-445</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12790617" name="SOLR-8738.patch" size="11976" author="hossman" created="Tue, 1 Mar 2016 00:17:32 +0000"/>
                            <attachment id="12790186" name="SOLR-8738.patch" size="13519" author="hossman" created="Fri, 26 Feb 2016 18:29:28 +0000"/>
                            <attachment id="12790005" name="SOLR-8738.patch" size="12726" author="hossman" created="Thu, 25 Feb 2016 21:38:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2tron:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>