<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:10:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17118] Solr deadlock during servlet container start</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17118</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In rare cases, Solr can run into a deadlock when started. The servlet container startup thread gets blocked and there&apos;s no other thread that could unblock it:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;main&quot; #1 prio=5 os_prio=0 cpu=5922.39ms elapsed=7490.27s tid=0x00007f637402ae70 nid=0x47 waiting on condition [0x00007f6379488000]
   java.lang.Thread.State: WAITING (parking)
    at jdk.internal.misc.Unsafe.park(java.base@17.0.9/Native Method)
    - parking to wait for  &amp;lt;0x0000000081da8000&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)
    at java.util.concurrent.locks.LockSupport.park(java.base@17.0.9/Unknown Source)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@17.0.9/Unknown Source)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(java.base@17.0.9/Unknown Source)
    at java.util.concurrent.CountDownLatch.await(java.base@17.0.9/Unknown Source)
    at org.apache.solr.servlet.CoreContainerProvider$ContextInitializationKey.waitForReadyService(CoreContainerProvider.java:523)
    at org.apache.solr.servlet.CoreContainerProvider$ServiceHolder.getService(CoreContainerProvider.java:562)
    at org.apache.solr.servlet.SolrDispatchFilter.init(SolrDispatchFilter.java:148)
    at org.eclipse.jetty.servlet.FilterHolder.initialize(FilterHolder.java:133)
    at org.eclipse.jetty.servlet.ServletHandler.lambda$initialize$2(ServletHandler.java:725)
    at org.eclipse.jetty.servlet.ServletHandler$$Lambda$315/0x00007f62fc2674b8.accept(Unknown Source)
    at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(java.base@17.0.9/Unknown Source)
    at java.util.stream.Streams$ConcatSpliterator.forEachRemaining(java.base@17.0.9/Unknown Source)
    at java.util.stream.ReferencePipeline$Head.forEach(java.base@17.0.9/Unknown Source)
    at org.eclipse.jetty.servlet.ServletHandler.initialize(ServletHandler.java:749)
    at org.eclipse.jetty.servlet.ServletContextHandler.startContext(ServletContextHandler.java:392) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ContextInitializationKey.waitForReadyService should have been unblocked by CoreContainerProvider#init, which is calling ServiceHolder#setService. This should work because CoreContainerProvider#init is always called before SolrDispatchFilter#init (ServletContextListeners are initialized before Filters). &lt;/p&gt;

&lt;p&gt;But there&apos;s a problem: CoreContainerProvider#init stores the ContextInitializationKey and the mapped ServiceHolder in CoreContainerProvider#services, and that&apos;s a &lt;b&gt;WeakHashMap&lt;/b&gt;: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#160;&#160;&#160;&#160; services 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .computeIfAbsent(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ContextInitializationKey(servletContext), ServiceHolder::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;) 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .setService(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;); 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The key is not referenced anywhere else, which makes the mapping a candidate for garbage collection. The ServiceHolder value also does not reference the key anymore, because #setService cleared the reference. &lt;/p&gt;

&lt;p&gt;With bad luck, the mapping is already gone from the WeakHashMap before SolrDispatchFilter#init tries to retrieve it with CoreContainerProvider#serviceForContext. And that method will then create a new ContextInitializationKey and ServiceHolder, which is then used for #waitForReadyService. But such a new ContextInitializationKey has never received a #makeReady call, and #waitForReadyService will block forever.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13564674">SOLR-17118</key>
            <summary>Solr deadlock during servlet container start</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="ahubold">Andreas Hubold</reporter>
                        <labels>
                            <label>deadlock</label>
                            <label>servlet-context</label>
                    </labels>
                <created>Mon, 15 Jan 2024 07:54:04 +0000</created>
                <updated>Fri, 25 Oct 2024 17:18:49 +0000</updated>
                            <resolved>Wed, 3 Jul 2024 19:49:22 +0000</resolved>
                                    <version>9.2.1</version>
                                    <fixVersion>9.7</fixVersion>
                                    <component>Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10200">2h 50m</timespent>
                                <comments>
                            <comment id="17806670" author="ahubold" created="Mon, 15 Jan 2024 07:56:06 +0000"  >&lt;p&gt;I&apos;d think this is caused by changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15590&quot; title=&quot;Start up Core Container via ServletContextListener&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15590&quot;&gt;&lt;del&gt;SOLR-15590&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s even the same problem as the one that&apos;s causing &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16086&quot; title=&quot;Issues with TestReplicationHandler.doTestIndexFetchOnLeaderRestart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16086&quot;&gt;SOLR-16086&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17848376" author="dsmiley" created="Tue, 21 May 2024 19:58:35 +0000"  >&lt;p&gt;I&apos;ve been stumped a number of times over the years looking at an unreproducible test failure that shows SolrDispatchFilter.init calling CoreContainerProvider.waitForReadyService and waiting on a CoundDownLatch indefinitely. Meanwhile, no other trace or problems in the logs. Eventually the test will timeout and we see a thread dump.&lt;/p&gt;

&lt;p&gt;I suspect a timing bug of exactly when GC happens interplaying with the use of WeakHashMap. In particular I see ContextInitializationKey&apos;s constructor publishing &quot;this&quot; to the ServletContext which seems like a bad place to put such logic (constructors publishing themselves is suspicious in general; avoid it). But the point is that it&apos;ll overwrite an existing entry in the context that may very well be there, thus suddenly making an existing entry in a WeakHashMap weakly reachable and it may be removed. &lt;b&gt;There is too much complexity there&lt;/b&gt;; I think it should be overhauled a bit.&lt;/p&gt;</comment>
                            <comment id="17848378" author="gus_heck" created="Tue, 21 May 2024 20:27:52 +0000"  >&lt;p&gt;Sigh...&lt;/p&gt;

&lt;p&gt;I spent a bunch of time trying to eliminate deadlock/race stuff in this. Seems like something snuck through anyway. If it can be simplified certainly that&apos;s great, but IIRC (it&apos;s been a while) the complexity came from avoiding deadlocks, and from the mismatch between how our tests startup vs the way we actually start up as a server (the tests use JettySolrRunner to skip a bunch of standard web container stuff to speed up tests)&lt;/p&gt;

&lt;p&gt;There&apos;s also an outside chance that there&apos;s some timing difference these days, due to Jetty 10&apos;s move to EventListener, vs LifecycleListner but that&apos;s got no proof and is pure speculation.&lt;/p&gt;</comment>
                            <comment id="17848941" author="dsmiley" created="Thu, 23 May 2024 12:50:04 +0000"  >&lt;p&gt;The problem &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17300?focusedCommentId=17848866&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17848866&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;strikes again&lt;/a&gt;.  As long as this PR of mine seems pretty stable, I&apos;m inclined to merge it to main and then monitor builds closely for spooky stuff.  It&apos;s better than the current alternative.&lt;/p&gt;</comment>
                            <comment id="17851239" author="jira-bot" created="Sat, 1 Jun 2024 02:04:27 +0000"  >&lt;p&gt;Commit 1177796e32631c62d8f00e7df4341c92b75e1617 in solr&apos;s branch refs/heads/main from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=1177796e326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=1177796e326&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17118&quot; title=&quot;Solr deadlock during servlet container start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17118&quot;&gt;&lt;del&gt;SOLR-17118&lt;/del&gt;&lt;/a&gt;: Simplify/fix CoreContainerProvider initialization (#2474)&lt;/p&gt;

&lt;p&gt;Thereby fixing a rare occurrence of Solr hanging on startup.&lt;/p&gt;

&lt;p&gt;CoreContainerProvider:  Don&apos;t need any CountDownLatch (x2), the synchronized WeakHashMap of &quot;services&quot;, the ServiceHolder, the ContextInitializationKey.  No looping to wait for initialization.&lt;/p&gt;

&lt;p&gt;JettySolrRunner: incorporate the CoreContainerProvider and various servlet filters in a normal way &amp;#8211; add all this before starting, not after.  Thus Jetty will shut them down properly so we don&apos;t have to.  Removed some needless synchronized wait/notify and other needless stuff.&lt;/p&gt;

&lt;p&gt;HealthCheckHandlerTest was shutting down CoreContainer improperly; this subset of the test was removed.&lt;/p&gt;</comment>
                            <comment id="17862832" author="jira-bot" created="Wed, 3 Jul 2024 15:31:08 +0000"  >&lt;p&gt;Commit 53a2a36df2fb843df640ce51ead4a6e0f65d8e74 in solr&apos;s branch refs/heads/branch_9x from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=53a2a36df2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=53a2a36df2f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17118&quot; title=&quot;Solr deadlock during servlet container start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17118&quot;&gt;&lt;del&gt;SOLR-17118&lt;/del&gt;&lt;/a&gt;: Simplify/fix CoreContainerProvider initialization (#2474)&lt;/p&gt;

&lt;p&gt;Thereby fixing a rare occurrence of Solr hanging on startup.&lt;/p&gt;

&lt;p&gt;CoreContainerProvider:  Don&apos;t need any CountDownLatch (x2), the synchronized WeakHashMap of &quot;services&quot;, the ServiceHolder, the ContextInitializationKey.  No looping to wait for initialization.&lt;/p&gt;

&lt;p&gt;JettySolrRunner: incorporate the CoreContainerProvider and various servlet filters in a normal way &amp;#8211; add all this before starting, not after.  Thus Jetty will shut them down properly so we don&apos;t have to.  Removed some needless synchronized wait/notify and other needless stuff.&lt;/p&gt;

&lt;p&gt;HealthCheckHandlerTest was shutting down CoreContainer improperly; this subset of the test was removed.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 1177796e32631c62d8f00e7df4341c92b75e1617)&lt;/p&gt;</comment>
                            <comment id="17866525" author="jira-bot" created="Tue, 16 Jul 2024 20:28:42 +0000"  >&lt;p&gt;Commit 53a2a36df2fb843df640ce51ead4a6e0f65d8e74 in solr&apos;s branch refs/heads/backport_&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16842&quot; title=&quot;Eliminate special case code in solrCLI by introducing VersionTool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16842&quot;&gt;&lt;del&gt;SOLR-16842&lt;/del&gt;&lt;/a&gt;_to_branch_9x from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=53a2a36df2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=53a2a36df2f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17118&quot; title=&quot;Solr deadlock during servlet container start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17118&quot;&gt;&lt;del&gt;SOLR-17118&lt;/del&gt;&lt;/a&gt;: Simplify/fix CoreContainerProvider initialization (#2474)&lt;/p&gt;

&lt;p&gt;Thereby fixing a rare occurrence of Solr hanging on startup.&lt;/p&gt;

&lt;p&gt;CoreContainerProvider:  Don&apos;t need any CountDownLatch (x2), the synchronized WeakHashMap of &quot;services&quot;, the ServiceHolder, the ContextInitializationKey.  No looping to wait for initialization.&lt;/p&gt;

&lt;p&gt;JettySolrRunner: incorporate the CoreContainerProvider and various servlet filters in a normal way &amp;#8211; add all this before starting, not after.  Thus Jetty will shut them down properly so we don&apos;t have to.  Removed some needless synchronized wait/notify and other needless stuff.&lt;/p&gt;

&lt;p&gt;HealthCheckHandlerTest was shutting down CoreContainer improperly; this subset of the test was removed.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 1177796e32631c62d8f00e7df4341c92b75e1617)&lt;/p&gt;</comment>
                            <comment id="17892887" author="anshumg" created="Fri, 25 Oct 2024 17:18:49 +0000"  >&lt;p&gt;Closing after the 9.7.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13580018">SOLR-17305</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13395689">SOLR-15590</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13432523">SOLR-16086</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mqx4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>