<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11882] SolrMetric registries retain references to SolrCores when closed</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11882</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;b&gt;Description:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Our setup involves using a lot of small cores (possibly hundred thousand), but working only on a few of them at any given time.&lt;/p&gt;

&lt;p&gt;We already followed all recommendations in this guide: &lt;a href=&quot;https://wiki.apache.org/solr/LotsOfCores&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/solr/LotsOfCores&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We noticed that after creating/loading around 1000-2000&#160;empty cores, with no documents inside, the heap consumption went through the roof despite having set transientCacheSize to only 64 (heap size set to 12G).&lt;/p&gt;

&lt;p&gt;All cores are correctly set to loadOnStartup=false and transient=true, and we have verified via logs that the cores in excess are actually being closed.&lt;/p&gt;

&lt;p&gt;However, a reference remains in the org.apache.solr.metrics.SolrMetricManager#registries that is never removed until a core if fully unloaded.&lt;/p&gt;

&lt;p&gt;Restarting the JVM loads all cores in the admin UI, but doesn&apos;t populate the ConcurrentHashMap until a core is actually fully loaded.&lt;/p&gt;

&lt;p&gt;I reproduced the issue on a smaller scale (transientCacheSize = 5, heap size = 512m) and made a report (attached) using eclipse MAT.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Desired outcome:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When a transient core is closed, the references in the SolrMetricManager should be removed, in the same fashion the reporters for the core are also closed and removed.&lt;/p&gt;

&lt;p&gt;In alternative, a unloadOnClose=true|false flag could be implemented to fully unload a transient core when closed due to the cache size.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Note:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The documentation mentions everywhere that the unused cores will be unloaded, but it&apos;s misleading as the cores are never fully unloaded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13132790">SOLR-11882</key>
            <summary>SolrMetric registries retain references to SolrCores when closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="eros.taborelli">Eros Taborelli</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 Jan 2018 16:19:44 +0000</created>
                <updated>Wed, 26 May 2021 19:42:07 +0000</updated>
                            <resolved>Tue, 3 Apr 2018 09:41:26 +0000</resolved>
                                    <version>7.1</version>
                                    <fixVersion>7.4</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>metrics</component>
                    <component>Server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16335349" author="erickerickson" created="Tue, 23 Jan 2018 03:30:58 +0000"  >&lt;p&gt;Ignore that patch, something&apos;s pretty screwy with my test.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16335488" author="eros.taborelli" created="Tue, 23 Jan 2018 08:23:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; I also uploaded our configuration and the test script used to create multiple cores.&lt;br/&gt;
If you want to test it, you&apos;ll need to add -Dfts.solr.indexdatadir=&amp;lt;directory&amp;gt; to your solr.in.sh.&#160;&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SOLR_OPTS=&quot;$SOLR_OPTS -Dfts.solr.indexdatadir=/tmp/solrdata&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then, run ./create-cores.sh {1..1000}&lt;/p&gt;

&lt;p&gt;Let me know if you need more details.&lt;/p&gt;</comment>
                            <comment id="16335996" author="erickerickson" created="Tue, 23 Jan 2018 16:16:09 +0000"  >&lt;p&gt;What I see at this point is that the number of cores in memory is actually capped by the total number of cores that have been defined. Say I have 30 transient cores and my transient core cache limit is 4. Eventually I see exactly 30 cores in memory.&lt;/p&gt;

&lt;p&gt;However, I have to stop my indexing program that&apos;s cycling through all the cores and trigger a GC for the SolrCores to drop back to 30. So if I randomly sample the number of Solr cores it&apos;ll be between 40-50 (or more, depending on how much free memory I have allocated) as the stress program is running, but when I stop indexing and trigger a GC, it drops back to exactly 30.&lt;/p&gt;

&lt;p&gt;Does that square with what you see? This is still a problem of course, it should drop back to 4.&lt;/p&gt;</comment>
                            <comment id="16336891" author="erickerickson" created="Wed, 24 Jan 2018 04:45:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; kindly provided this suggestion, I applied it&lt;/p&gt;

&lt;p&gt;-&#160;it fixes the cores lingering around. As above I had to stop indexing and force a GC to have the cores drop back to 4 in my test scenario. In &quot;real&quot; situations where you have hundreds/thousands of cores I&apos;d expect the number of references to peak somewhat above your cache size as some wait around for GC&lt;/p&gt;

&lt;p&gt;2&amp;gt; precommit passes&lt;/p&gt;

&lt;p&gt;3&amp;gt; tests pass. I had one failure with&#160;AutoscalingHistoryHandlerTest, then 3 of 10 failed (beasting). However, 2 of 10 failed without this patch so I don&apos;t think it&apos;s relevant.&lt;/p&gt;

&lt;p&gt;What I have &lt;em&gt;not&lt;/em&gt; looked at yet is what happens when metrics are requested for non-resident cores, or whether having the cores come and go accumulates metrics over successive loads of the core.&lt;/p&gt;</comment>
                            <comment id="16337104" author="eros.taborelli" created="Wed, 24 Jan 2018 08:11:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; yes, that is what we see.&lt;/p&gt;</comment>
                            <comment id="16337190" author="ab" created="Wed, 24 Jan 2018 09:24:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;kindly provided this suggestion, I applied it&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My suggestion was to replace Gauge metrics in the registry inside &lt;tt&gt;SolrCoreMetricManager.close()&lt;/tt&gt; with their last primitive values (because most of these Gauges are created as lambdas and keep referencing SolrCore, whereas values they produce don&apos;t reference the core) - this way we would stop referencing SolrCore but still preserve a snapshot of gauge values. Something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
metricRegistry.getGauges().forEach((k, v) -&amp;gt; {
 &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; val = v.getValue();
 metricRegistry.remove(k);
 metricRegistry.register(k, (Gauge)() -&amp;gt; val);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m surprised your patch works, because &lt;tt&gt;SolrCoreMetricManager.close()&lt;/tt&gt; is called from inside &lt;tt&gt;SolrCore.close()&lt;/tt&gt;, and calling &lt;tt&gt;SolrCore.close()&lt;/tt&gt; here again should IMHO lead to &quot;Too many closes&quot; exception...&lt;/p&gt;</comment>
                            <comment id="16338504" author="erickerickson" created="Thu, 25 Jan 2018 00:52:11 +0000"  >&lt;p&gt;Oh total bother. I put up a second copy of the &lt;em&gt;same&lt;/em&gt;&#160;hack patch up rather than the one you coached me on that I tested with. I&apos;ll put the right&#160;one up shortly.&lt;/p&gt;</comment>
                            <comment id="16342313" author="erickerickson" created="Sat, 27 Jan 2018 21:04:56 +0000"  >&lt;p&gt;Any reason &lt;em&gt;not&lt;/em&gt; to commit this? Otherwise I&apos;ll commit this this weekend.... Now that I have the right patch up there.&lt;/p&gt;</comment>
                            <comment id="16342852" author="erickerickson" created="Mon, 29 Jan 2018 03:43:50 +0000"  >&lt;p&gt;Patch with CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="16342853" author="jira-bot" created="Mon, 29 Jan 2018 03:44:19 +0000"  >&lt;p&gt;Commit f0509c19c16ded1557f8d7168acb0b7faf926ab7 in lucene-solr&apos;s branch refs/heads/master from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f0509c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f0509c1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&lt;/p&gt;</comment>
                            <comment id="16342855" author="jira-bot" created="Mon, 29 Jan 2018 03:44:20 +0000"  >&lt;p&gt;Commit c724845fabcdbffe15ad78f5335c77cae0900194 in lucene-solr&apos;s branch refs/heads/master from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c724845&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c724845&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&lt;/p&gt;</comment>
                            <comment id="16342856" author="jira-bot" created="Mon, 29 Jan 2018 03:44:22 +0000"  >&lt;p&gt;Commit d85a1666a18423eeeda83ca89ce4ab959ce39066 in lucene-solr&apos;s branch refs/heads/master from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d85a166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d85a166&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&lt;/p&gt;</comment>
                            <comment id="16342863" author="jira-bot" created="Mon, 29 Jan 2018 03:50:14 +0000"  >&lt;p&gt;Commit a729fc83311a2f6426664d098d2a5920e2b62852 in lucene-solr&apos;s branch refs/heads/branch_7x from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a729fc8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a729fc8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&lt;/p&gt;

&lt;p&gt;(cherry picked from commit f0509c1)&lt;/p&gt;</comment>
                            <comment id="16342864" author="jira-bot" created="Mon, 29 Jan 2018 03:50:16 +0000"  >&lt;p&gt;Commit 2feb3e794a03e07fa1eee34188d667f24d357db5 in lucene-solr&apos;s branch refs/heads/branch_7x from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2feb3e7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2feb3e7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&lt;/p&gt;

&lt;p&gt;(cherry picked from commit c724845)&lt;/p&gt;</comment>
                            <comment id="16342868" author="erickerickson" created="Mon, 29 Jan 2018 03:53:15 +0000"  >&lt;p&gt;Thanks Andrzej!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16345026" author="ab" created="Tue, 30 Jan 2018 13:24:22 +0000"  >&lt;p&gt;This fix exposed another existing issue, which is not fatal but looks ugly:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR - 2018-01-30 12:51:11.480; [c:gettingstarted s:shard1 r:core_node5 x:gettingstarted_shard1_replica_n2] org.apache.solr.common.SolrException; org.apache.lucene.store.AlreadyClosedException: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; IndexReader is closed
        at org.apache.lucene.index.IndexReader.ensureOpen(IndexReader.java:268)
        at org.apache.lucene.index.StandardDirectoryReader.getVersion(StandardDirectoryReader.java:338)
        at org.apache.lucene.index.FilterDirectoryReader.getVersion(FilterDirectoryReader.java:119)
        at org.apache.lucene.index.FilterDirectoryReader.getVersion(FilterDirectoryReader.java:119)
        at org.apache.solr.search.SolrIndexSearcher.lambda$initializeMetrics$14(SolrIndexSearcher.java:2262)
        at org.apache.solr.metrics.SolrCoreMetricManager.lambda$close$93(SolrCoreMetricManager.java:156)
        at java.util.TreeMap.forEach(TreeMap.java:1001)
        at java.util.Collections$UnmodifiableMap.forEach(Collections.java:1505)
        at org.apache.solr.metrics.SolrCoreMetricManager.close(SolrCoreMetricManager.java:155)
        at org.apache.solr.core.SolrCore.close(SolrCore.java:1513)
        at org.apache.solr.core.CoreContainer.registerCore(CoreContainer.java:898)
        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1292)
        at org.apache.solr.core.SolrCore.lambda$getConfListener$38(SolrCore.java:2969)
        at org.apache.solr.cloud.ZkController.lambda$fireEventListeners$190(ZkController.java:2610)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is caused by a bunch of too simplistic lambda expressions in SolrIndexSearch:2257 and following - basically, they should first check if the reader is still open, and return eg. -1 if it&apos;s not.&lt;/p&gt;</comment>
                            <comment id="16348833" author="ab" created="Thu, 1 Feb 2018 16:19:06 +0000"  >&lt;p&gt;It turns out that this fix is wrong... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The new section in &lt;tt&gt;SolrCoreMetricManager.close()&lt;/tt&gt; causes the new instances of gauges to be closed because the new core is registered first (and registers new instances of metrics) and only then the old one is closed - and it closes the new metrics instead of the old ones&#8230;&lt;/p&gt;

&lt;p&gt;One solution, which is more complicated than I&#8217;d like, is to use a subclass of Gauge that has a tag (the same as we do with MetricReporters) and remove instances only when the tag matches the one in the core that is being closed&lt;br/&gt;
or revert this fix and see if there&#8217;s something better that we could do here.&lt;/p&gt;</comment>
                            <comment id="16348848" author="erickerickson" created="Thu, 1 Feb 2018 16:24:55 +0000"  >&lt;p&gt;OK, let&apos;s revert this. I am traveling today, so feel free if you&apos;d like. I&apos;ll get to it this weekend if you don&apos;t get to it.&lt;/p&gt;</comment>
                            <comment id="16348930" author="jira-bot" created="Thu, 1 Feb 2018 17:14:22 +0000"  >&lt;p&gt;Commit 8418081c4ae5bfe752938c1ae6db9cf5063c8e7f in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8418081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8418081&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit f0509c19c16ded1557f8d7168acb0b7faf926ab7.&lt;/p&gt;</comment>
                            <comment id="16348931" author="jira-bot" created="Thu, 1 Feb 2018 17:14:23 +0000"  >&lt;p&gt;Commit b0b963c68e04a249b87d5b3ab70ade52d19d85ee in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b0b963c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b0b963c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit c724845fabcdbffe15ad78f5335c77cae0900194.&lt;/p&gt;</comment>
                            <comment id="16348956" author="jira-bot" created="Thu, 1 Feb 2018 17:31:42 +0000"  >&lt;p&gt;Commit 83696042649e5c7460c47d0ca121c46a58d2fa54 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8369604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8369604&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit a729fc83311a2f6426664d098d2a5920e2b62852.&lt;/p&gt;</comment>
                            <comment id="16348957" author="jira-bot" created="Thu, 1 Feb 2018 17:31:44 +0000"  >&lt;p&gt;Commit b586dca89ff0b7c365dcbb3e1e403adf477790b1 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b586dca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b586dca&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retain references to SolrCores when closed&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 2feb3e794a03e07fa1eee34188d667f24d357db5.&lt;/p&gt;</comment>
                            <comment id="16399440" author="erickerickson" created="Wed, 14 Mar 2018 21:22:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; OK, I think the light finally dawned. We&apos;re talking about two different cases and they both have to be handled.&lt;/p&gt;

&lt;p&gt;1&amp;gt; transient core case, the one I&apos;m started with. In this case, the core is closed out and &lt;em&gt;may&lt;/em&gt;, some time in the near or far future be opened again. In this case the patch from 28-Jan is probably almost fine although there&apos;s still a (probably small but unacceptable) chance that a new version of the core would be opened before the closer thread got &apos;round to closing the old one.&lt;/p&gt;

&lt;p&gt;2&amp;gt; reopening a core which is the case you&apos;re talking about in your comment 1-Feb.&lt;/p&gt;

&lt;p&gt;In &amp;lt;2&amp;gt; there&apos;s no problem with cores accumulating due to the reference in the metrics code since they&apos;ve been released by the new assignment already.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;

&lt;p&gt;And is there a good way other than inspection to test any fixes I make?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16402474" author="erickerickson" created="Fri, 16 Mar 2018 20:39:26 +0000"  >&lt;p&gt;Bah, I had some cruft in there, what I had in this comment doesn&apos;t work at all.&lt;/p&gt;</comment>
                            <comment id="16413869" author="ab" created="Mon, 26 Mar 2018 13:49:09 +0000"  >&lt;p&gt;Here&apos;s the setup that I used to test and verify this issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;created &lt;tt&gt;core0/conf .. core9/conf&lt;/tt&gt; dirs under &lt;tt&gt;server/solr/&lt;/tt&gt; and copied the &lt;tt&gt;_default&lt;/tt&gt; configset to each of the conf dirs.&lt;/li&gt;
	&lt;li&gt;created in each &lt;tt&gt;core0 .. core9&lt;/tt&gt; dir a &lt;tt&gt;core.properties&lt;/tt&gt; file containing a single line: &lt;tt&gt;transient=true&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;modified &lt;tt&gt;server/solr/solr.xml&lt;/tt&gt; to contain &lt;tt&gt;&amp;lt;int name=&quot;transientCacheSize&quot;&amp;gt;2&amp;lt;/int&amp;gt;&lt;/tt&gt; under &lt;tt&gt;solr&lt;/tt&gt; element&lt;/li&gt;
	&lt;li&gt;ran &lt;tt&gt;bin/solr start&lt;/tt&gt; and issued a simple query request to each of the cores, to force its loading (and unloading from the small cache)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After attaching a profiler I was able to verify that indeed 10 instances of SolrCore exist, all strongly referenced, and forcing GC doesn&apos;t affect this.&lt;/p&gt;

&lt;p&gt;I attached a possible patch - it associates each Gauge with the SolrInfoBean that registered it, and then unregisters these gauge instances that correspond to the bean that is being closed (whether it&apos;s SolrCore or other plugin).&lt;/p&gt;

&lt;p&gt;There are a few things that I don&apos;t like about this patch, though: I used &lt;tt&gt;WeakReference&lt;/tt&gt; to tell JVM that it can garbage collect the lambdas as soon as their parent object is unreferenced, and I had to explicitly call unregistration in &lt;tt&gt;SolrCoreMetricManager.close()&lt;/tt&gt;. Either one of these didn&apos;t work on its own, although I think the unregistration step should - only when used both I could see that indeed the references to old transient cores were being released. So there&apos;s likely still some other factor at play here... but at least the patch can be used as a workaround.&lt;/p&gt;</comment>
                            <comment id="16414314" author="erickerickson" created="Mon, 26 Mar 2018 18:41:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; LGTM, after I cycle through my tests (and do a GC), my SolrCore count now drops back to (non-transient-cores + transient-queue-size) which is what I&apos;d hoped for.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16415218" author="romseygeek" created="Tue, 27 Mar 2018 08:24:58 +0000"  >&lt;p&gt;This looks like a pretty serious bug.&#160; I&apos;m going to build another RC for the 7.3.0 release once &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12141&quot; title=&quot;Solr does not start on Windows and Linux/Mac with Java 10 or later&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12141&quot;&gt;&lt;del&gt;SOLR-12141&lt;/del&gt;&lt;/a&gt; is in, do you want to backport this fix as well or does it need more time to bake?&lt;/p&gt;</comment>
                            <comment id="16415225" author="ab" created="Tue, 27 Mar 2018 08:32:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; the patch appears to be working but as I indicated above it&apos;s probably not the whole story, so let&apos;s wait at least for a few jenkins builds to confirm that it doesn&apos;t break anything.&lt;br/&gt;
(Edit: at the moment the patch still causes multiple test failures so it still needs work).&lt;/p&gt;</comment>
                            <comment id="16415849" author="erickerickson" created="Tue, 27 Mar 2018 16:12:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; This has been around since at least 6.4 I believe. Plus, it&apos;s rather obscure. In the normal course of events, we don&apos;t close cores &lt;em&gt;and leave them closed&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;If we re-open a core, the orphan reference is re-assigned. So if I open/close/open/close the same core a zillion times, I only have one SolrCore object.&lt;/p&gt;

&lt;p&gt;It manifests itself is if someone is using &quot;transient cores&quot;. In that case, if the transient core cache is capped at, say, 10 and I have 100 transient cores, after I cycle through them all I&apos;ll have 90 &quot;orphan&quot; references. I&apos;ll never have more than that though. And never less.&lt;/p&gt;

&lt;p&gt;For anyone running &quot;stock&quot; Solr, it won&apos;t show up. People will open all the cores at startup and keep them open (even if reopened) and won&apos;t have any orphans.&lt;/p&gt;

&lt;p&gt;I suppose if people are unloading cores it might occur as well, but I think that&apos;s rare.&lt;/p&gt;

&lt;p&gt;All FYI to evaluate whether you want to put it in 7.3. For people affected it is, indeed serious if they have a lot of cores....&lt;/p&gt;</comment>
                            <comment id="16416320" author="ab" created="Tue, 27 Mar 2018 22:08:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; The current patch is broken (Solr silently loses some metrics from active cores .. oops). I&apos;m preparing a new patch that is conceptually simpler and appears to be working well.&lt;/p&gt;

&lt;p&gt;However, this new fix requires changing the API of &lt;tt&gt;SolrMetricProducer&lt;/tt&gt; (new parameter in &lt;tt&gt;initializeMetrics(...)&lt;/tt&gt; method) so I think it&apos;s suitable only for 8.0 - definitely not for 7.3. I think that at this point the only thing we can do for 7.3 is to add this issue to the&#160;&quot;known bugs&quot; section.&lt;/p&gt;</comment>
                            <comment id="16416335" author="markrmiller@gmail.com" created="Tue, 27 Mar 2018 22:22:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;definitely not for 7.3.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could we introspect the impl and do the right thing with new impls that take the new param?&lt;/p&gt;</comment>
                            <comment id="16416355" author="ab" created="Tue, 27 Mar 2018 22:40:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could we introspect the impl and do the right thing with new impls that take the new param?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That would be exceedingly messy - this method is called in many components and from different contexts (eg. most but not all mbeans are initialized in SolrCore, but handlers are also initialized in CoreContainer, some components initialize their own sub-components, etc...)&lt;/p&gt;</comment>
                            <comment id="16416468" author="ab" created="Tue, 27 Mar 2018 23:36:14 +0000"  >&lt;p&gt;Updated patch. This adds a SolrCore instance identifier (tag) to all gauges in a registry, which are then matched and removed when SolrCore is closed.&lt;/p&gt;

&lt;p&gt;The size of the patch is partially caused by the change in &lt;tt&gt;SolrMetricProducer.initializeMetrics(...)&lt;/tt&gt; and the need to pass around the SolrCore instance tag.&lt;br/&gt;
All unit tests pass, and the scenario described above also passes, ie. produces only 2 strongly referenced SolrCore objects.&lt;/p&gt;</comment>
                            <comment id="16417100" author="jira-bot" created="Wed, 28 Mar 2018 09:46:37 +0000"  >&lt;p&gt;Commit 7260d9ce713b5f6378b97e4c64f3045eb62f98bd in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7260d9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7260d9c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retained references to SolrCores when closed.&lt;/p&gt;</comment>
                            <comment id="16418820" author="ab" created="Thu, 29 Mar 2018 11:40:57 +0000"  >&lt;p&gt;Patch for branch_7x that allows us to maintain back-compat API - this is functionally identical to the patch for master except the changes in &lt;tt&gt;SolrMetricProducer&lt;/tt&gt; interface. The old method is marked here as deprecated, and the new method has a default implementation that calls the old one - so third-party components that implement only the old method will be correctly called by Solr via the default impl. of the new method.&lt;/p&gt;

&lt;p&gt;If there are no objections I&apos;ll commit this shortly.&lt;/p&gt;</comment>
                            <comment id="16423749" author="jira-bot" created="Tue, 3 Apr 2018 09:40:58 +0000"  >&lt;p&gt;Commit 483914b6a4c5aaa163625169066e8c6bb3942566 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=483914b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=483914b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;: SolrMetric registries retained references to SolrCores when closed.&lt;/p&gt;</comment>
                            <comment id="17351751" author="dsmiley" created="Wed, 26 May 2021 12:23:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; I&apos;m looking very closely at the SolrDispatchFilter.close/destroy process to ensure I understand every detail thoroughly.  This &lt;tt&gt;metricManager.unregisterGauges&lt;/tt&gt; call was added in this JIRA issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11882&quot; title=&quot;SolrMetric registries retain references to SolrCores when closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11882&quot;&gt;&lt;del&gt;SOLR-11882&lt;/del&gt;&lt;/a&gt;.  I&apos;m guessing this change was not contributing to the memory leak but other parts of this JIRA issue were because this memory leak is about individual SolrCore leaks?  Could/should it go to CoreContainer.close?  Why does SolrDispatchFilter have a reference to the MetricManager; can&apos;t it simply look it up via CoreContainer.getMetricManager?  Less state is better IMO.&lt;/p&gt;</comment>
                            <comment id="17351771" author="ab" created="Wed, 26 May 2021 13:16:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; I think we can do even better - move all the logic related to metrics to the CoreContainer.load(). After all, if we fail to init CC the node and its metrics are unusable anyway. And when we close the CoreContainer the metrics are not available either, so we can equally well do the cleanup in CC.shutdown().&lt;/p&gt;</comment>
                            <comment id="17352039" author="dsmiley" created="Wed, 26 May 2021 19:42:07 +0000"  >&lt;p&gt;I&apos;m working on a PR for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15438&quot; title=&quot;Refactor: Simplify SolrDispatchFilter close/destroy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15438&quot;&gt;&lt;del&gt;SOLR-15438&lt;/del&gt;&lt;/a&gt; that has a small change to not add a field MetricManager to SolrDispatchFilter.  I&apos;ll leave it to you if you want to move the register &amp;amp; unregister logic completely to CoreContainer.  Perhaps many tests that don&apos;t need Jetty but need a CoreContainer might not need the extra metrics?  Yet moreover it&apos;d probably be better to disable MetricManager somehow and I recall you did something to allow for that?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12916818" name="SOLR-11882-7x.patch" size="113025" author="ab" created="Thu, 29 Mar 2018 11:35:45 +0000"/>
                            <attachment id="12916496" name="SOLR-11882.patch" size="111074" author="ab" created="Tue, 27 Mar 2018 23:31:57 +0000"/>
                            <attachment id="12916202" name="SOLR-11882.patch" size="12630" author="ab" created="Mon, 26 Mar 2018 13:51:53 +0000"/>
                            <attachment id="12908080" name="SOLR-11882.patch" size="1654" author="erickerickson" created="Mon, 29 Jan 2018 03:43:35 +0000"/>
                            <attachment id="12907601" name="SOLR-11882.patch" size="1097" author="erickerickson" created="Thu, 25 Jan 2018 00:56:43 +0000"/>
                            <attachment id="12907422" name="SOLR-11882.patch" size="695" author="erickerickson" created="Wed, 24 Jan 2018 04:39:31 +0000"/>
                            <attachment id="12907228" name="SOLR-11882.patch" size="695" author="erickerickson" created="Tue, 23 Jan 2018 03:04:07 +0000"/>
                            <attachment id="12907253" name="create-cores.zip" size="382" author="eros.taborelli" created="Tue, 23 Jan 2018 08:19:57 +0000"/>
                            <attachment id="12907147" name="solr-dump-full_Leak_Suspects.zip" size="72914" author="eros.taborelli" created="Mon, 22 Jan 2018 16:14:01 +0000"/>
                            <attachment id="12907252" name="solr.config.zip" size="149518" author="eros.taborelli" created="Tue, 23 Jan 2018 08:18:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p7cf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>