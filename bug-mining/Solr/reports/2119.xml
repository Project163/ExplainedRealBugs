<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:57:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6511] Fencepost error in LeaderInitiatedRecoveryThread</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6511</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;At line 106:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (continueTrying &amp;amp;&amp;amp; ++tries &amp;lt; maxTries) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should be&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (continueTrying &amp;amp;&amp;amp; ++tries &amp;lt;= maxTries) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is only a problem when called from DistributedUpdateProcessor, as it can have maxTries set to 1, which means the loop is never actually run.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12741109">SOLR-6511</key>
            <summary>Fencepost error in LeaderInitiatedRecoveryThread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thelabdude">Timothy Potter</assignee>
                                    <reporter username="romseygeek">Alan Woodward</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Sep 2014 17:16:59 +0000</created>
                <updated>Wed, 29 Oct 2014 14:38:12 +0000</updated>
                            <resolved>Mon, 13 Oct 2014 16:36:13 +0000</resolved>
                                                    <fixVersion>4.10.2</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14131777" author="romseygeek" created="Fri, 12 Sep 2014 17:25:23 +0000"  >&lt;p&gt;So here&apos;s how this manifested:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;replica1 is busy sending updates to replica2 when it gets a network blip and it&apos;s ZK connection times out&lt;/li&gt;
	&lt;li&gt;replica2 is then elected leader&lt;/li&gt;
	&lt;li&gt;replica1 also still thinks it&apos;s leader (because it hasn&apos;t noticed the ZK timeout yet) and then gets errors back from replica2 saying &quot;I&apos;m the leader, stop sending me these updates!&quot;&lt;/li&gt;
	&lt;li&gt;replica1 interprets these as errors, and attempts to put replica2 into leader-initiated recovery&lt;/li&gt;
	&lt;li&gt;what ought to happen here is that replica2 sends a message back saying &quot;no need, I&apos;m the leader, I&apos;ll take it from here, thanks&quot;.  But because of the fencepost error, the message to replica2 is never actually sent, and replica1 then writes replica2&apos;s state as DOWN into the LIRT zk node&lt;/li&gt;
	&lt;li&gt;the two replicas send each other some request-recover messages, trying to work out who is actually leader&lt;/li&gt;
	&lt;li&gt;replica2 then tries to recover, but it can&apos;t publish itself as active, because you can&apos;t do that if your LIRT state is DOWN, so it eventually goes into RECOVERY_FAILED&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There is a bunch of fairly confusing logging around all this as well.  I particularly liked the messages that said &quot;WaitingForState recovering, but I see state: recovering&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14131805" author="thelabdude" created="Fri, 12 Sep 2014 17:40:12 +0000"  >&lt;p&gt;yeah, that WaitForState stuff is not actually related to this code and is very confusing, but that&apos;s another issue ... for this issue, I&apos;ll post a patch shortly but I think it should also include a check for whether the node trying to start LIR thread is still the leader&lt;/p&gt;

&lt;p&gt;not hitting this loop at least once is pretty bad actually, so we try to get this into 4.10.1 IMHO&lt;/p&gt;</comment>
                            <comment id="14131923" author="thelabdude" created="Fri, 12 Sep 2014 18:50:43 +0000"  >&lt;p&gt;Here&apos;s a patch to address this problem, specifically it does:&lt;/p&gt;

&lt;p&gt;1) tries the recovery command at least once (Alan&apos;s fix)&lt;/p&gt;

&lt;p&gt;2) doesn&apos;t put a replica into LIR if the node is not currently the leader anymore (added safeguard) ... the LIR thread also checks to make sure it is still running in the leader before continuing to nag the replica&lt;/p&gt;</comment>
                            <comment id="14131972" author="thelabdude" created="Fri, 12 Sep 2014 19:19:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;what ought to happen here is that replica2 sends a message back saying &quot;no need, I&apos;m the leader, I&apos;ll take it from here, thanks&quot;. But because of the fencepost error, the message to replica2 is never actually sent, and replica1 then writes replica2&apos;s state as DOWN into the LIRT zk node&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The more I think about this, I don&apos;t see how the fencepost error gets hit here? maxTries will be 120 if replica1 is setting replica2 to down&lt;/p&gt;

&lt;p&gt;So I think the real fix is to do what Alan suggests - have the new leader respond with: no need, I&apos;m the leader, I&apos;ll take it from here, thanks&lt;/p&gt;

&lt;p&gt;The patch I posted earlier has some good improvements in it, but I think we need a unit test that proves the code works correctly for the scenario described above.&lt;/p&gt;</comment>
                            <comment id="14132960" author="romseygeek" created="Sat, 13 Sep 2014 21:16:47 +0000"  >&lt;p&gt;I think you might have some extra stuff on the end of the patch?&lt;/p&gt;

&lt;p&gt;Digging a bit further into the logs, maxTries is set to 1 because ensureReplicaInLeaderInitiatedRecovery throws a SessionExpiredException (presumably because ZK has noticed the network blip and removed the relevant ephemeral node).  Maybe maxTries should &lt;b&gt;always&lt;/b&gt; be set to 120?&lt;/p&gt;

&lt;p&gt;One thing that might be nice here would be to add a utility method to ZkController called something like ensureLeadership(CloudDescriptor cd), which checks if the core described by the CloudDescriptor really is the current leader according to ZK, and throws an exception if it isn&apos;t.&lt;/p&gt;</comment>
                            <comment id="14140974" author="thelabdude" created="Fri, 19 Sep 2014 17:52:50 +0000"  >&lt;p&gt;I now have a test case that duplicates Alan&apos;s scenario exactly, which is good. In devising a fix, the following problem has come up &amp;#8211; the request has been accepted locally on the used to be leader and is failing on one of the replicas because of the leader change (&quot;Request says it is coming from leader, but we are the leader&quot;).&lt;/p&gt;

&lt;p&gt;So does the old leader (the one receiving the error back from the new leader) try to be clever and forward the request to the leader as any replica would do under normal circumstances? Keep in mind that this request has already been accepted locally and possibly on other replicas. Or does this old leader just propagate the failure back to the client and let it decide what to do? Guess it comes down to whether we think its safe to just re-process a request? Seems like it would be but wanted feedback before assuming that.&lt;/p&gt;</comment>
                            <comment id="14141269" author="romseygeek" created="Fri, 19 Sep 2014 20:49:23 +0000"  >&lt;p&gt;I think the safest response is to return the error to the client.  Updates are idempotent, right?  An ADD will just overwrite the previous ADD, DELETE doesn&apos;t necessarily have to delete anything to be successful, etc.  So if the client gets a 503 back again it can just resend.&lt;/p&gt;

&lt;p&gt;The only tricky bit might be what happens if a replica finds itself ahead of its leader, as would be the case here.  Does it automatically try and send updates on, or does it roll back?&lt;/p&gt;</comment>
                            <comment id="14141411" author="thelabdude" created="Fri, 19 Sep 2014 22:14:50 +0000"  >&lt;p&gt;Here&apos;s an updated patch. It&apos;ll need to be updated again after &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt; is committed. Key things in this patch are:&lt;/p&gt;

&lt;p&gt;1) HttpPartitionTest.testLeaderZkSessionLoss: reproduces the scenario described in this ticket&lt;/p&gt;

&lt;p&gt;2) DistributedUpdateProcessor now checks to see if the reason for a failure is because of a leader change and if so, the request fails and an error is sent to the client&lt;/p&gt;

&lt;p&gt;I had to add a way to pass-thru some additional context information about an error from server to client, which I&apos;ll do that work in another ticket but this patch shows the approach I&apos;m taking.&lt;/p&gt;

&lt;p&gt;Lastly, HttpPartitionTest continues to be a problem - I beast&apos;d it for 10 times and it failed after 6 runs locally (sometimes fewer), so will need to get that problem resolved before committing this patch too. It consistently fails in the testRf3WithLeaderFailover but for different reasons. My thinking is that I&apos;ll break the problem test case (testRf3WithLeaderFailover) out to its own test class as the other tests in this class work well and cover a lot of important functionality.&lt;/p&gt;</comment>
                            <comment id="14143678" author="thelabdude" created="Mon, 22 Sep 2014 19:40:11 +0000"  >&lt;p&gt;I&apos;m ready to commit this solution, but before I do, I&apos;d like some feedback on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6550&quot; title=&quot;Provide simple mechanism for passing additional metadata / context about a server-side SolrException back to the client-side&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6550&quot;&gt;&lt;del&gt;SOLR-6550&lt;/del&gt;&lt;/a&gt;, which is how I&apos;m implementing Alan&apos;s &quot;no need, I&apos;m the leader, I&apos;ll take it from here, thanks&quot; recommendation.&lt;/p&gt;</comment>
                            <comment id="14146420" author="jira-bot" created="Wed, 24 Sep 2014 15:21:48 +0000"  >&lt;p&gt;Commit 1627347 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1627347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1627347&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: Fencepost error in LeaderInitiatedRecoveryThread; refactor HttpPartitionTest to resolve jenkins failures.&lt;/p&gt;</comment>
                            <comment id="14151781" author="jira-bot" created="Mon, 29 Sep 2014 15:19:14 +0000"  >&lt;p&gt;Commit 1628203 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1628203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1628203&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: adjust test logic to account for timing issues in zk session expiration scenario.&lt;/p&gt;</comment>
                            <comment id="14156445" author="shalinmangar" created="Thu, 2 Oct 2014 11:45:22 +0000"  >&lt;p&gt;Tim, I&apos;ve committed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt; on trunk. I&apos;ll merge it to branch_5x after you merge these changes.&lt;/p&gt;</comment>
                            <comment id="14156641" author="jira-bot" created="Thu, 2 Oct 2014 14:58:27 +0000"  >&lt;p&gt;Commit 1628989 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1628989&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1628989&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: Fencepost error in LeaderInitiatedRecoveryThread; refactor HttpPartitionTest to resolve jenkins failures.&lt;/p&gt;</comment>
                            <comment id="14157843" author="shalinmangar" created="Fri, 3 Oct 2014 09:52:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Digging a bit further into the logs, maxTries is set to 1 because ensureReplicaInLeaderInitiatedRecovery throws a SessionExpiredException (presumably because ZK has noticed the network blip and removed the relevant ephemeral node).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s not just SessionExpiredException. Sometime it might throw a ConnectionLossException which also should be handled in the same way. I got the following stack trace in my testing when a node was partitioned from ZooKeeper for a long time:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;7984566 [qtp1600876769-17] ERROR org.apache.solr.update.processor.DistributedUpdateProcessor  &#8211; Leader failed to set replica http:&lt;span class=&quot;code-comment&quot;&gt;//n4:8983/solr/collection_5x3_shard4_replica3/ state to DOWN due to: org.apache.solr.common.SolrException: Failed to update data to down &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; znode: /collections/collection_5x3/leader_initiated_recovery/shard4/core_node10
&lt;/span&gt;org.apache.solr.common.SolrException: Failed to update data to down &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; znode: /collections/collection_5x3/leader_initiated_recovery/shard4/core_node10
        at org.apache.solr.cloud.ZkController.updateLeaderInitiatedRecoveryState(ZkController.java:1959)
        at org.apache.solr.cloud.ZkController.ensureReplicaInLeaderInitiatedRecovery(ZkController.java:1841)
        at org.apache.solr.update.processor.DistributedUpdateProcessor.doFinish(DistributedUpdateProcessor.java:837)
        at org.apache.solr.update.processor.DistributedUpdateProcessor.finish(DistributedUpdateProcessor.java:1679)
        at org.apache.solr.update.processor.LogUpdateProcessor.finish(LogUpdateProcessorFactory.java:179)
        at org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:76)
        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:83)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1967)
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:777)
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:418)
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)
        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)
        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)
        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)
        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)
        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)
        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)
        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)
        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)
        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)
        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)
        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)
        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)
        at org.eclipse.jetty.server.Server.handle(Server.java:368)
        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)
        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)
        at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:953)
        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1014)
        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:953)
        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:240)
        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)
        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)
        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)
        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /collections/collection_5x3/leader_initiated_recovery/shard4/core_node10
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:99)
        at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
        at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1045)
        at org.apache.solr.common.cloud.SolrZkClient$5.execute(SolrZkClient.java:256)
        at org.apache.solr.common.cloud.SolrZkClient$5.execute(SolrZkClient.java:253)
        at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:74)
        at org.apache.solr.common.cloud.SolrZkClient.exists(SolrZkClient.java:253)
        at org.apache.solr.cloud.ZkController.updateLeaderInitiatedRecoveryState(ZkController.java:1949)
        ... 36 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14158073" author="thelabdude" created="Fri, 3 Oct 2014 15:15:18 +0000"  >&lt;p&gt;Re-opening this to address the problem Shalin noticed.&lt;/p&gt;</comment>
                            <comment id="14160573" author="jira-bot" created="Mon, 6 Oct 2014 17:50:50 +0000"  >&lt;p&gt;Commit 1629720 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1629720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1629720&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: Better handling of ZooKeeper related exceptions when deciding to start the leader-initiated recovery nag thread&lt;/p&gt;</comment>
                            <comment id="14162377" author="jira-bot" created="Tue, 7 Oct 2014 19:35:13 +0000"  >&lt;p&gt;Commit 1629966 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1629966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1629966&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: keep track of the node that created the leader-initiated recovery znode, helpful for debugging&lt;/p&gt;</comment>
                            <comment id="14163608" author="jira-bot" created="Wed, 8 Oct 2014 15:20:24 +0000"  >&lt;p&gt;Commit 1630137 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1630137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1630137&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: backport latest changes to branch_5x&lt;/p&gt;</comment>
                            <comment id="14163701" author="jira-bot" created="Wed, 8 Oct 2014 16:25:21 +0000"  >&lt;p&gt;Commit 1630164 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1630164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1630164&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6550&quot; title=&quot;Provide simple mechanism for passing additional metadata / context about a server-side SolrException back to the client-side&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6550&quot;&gt;&lt;del&gt;SOLR-6550&lt;/del&gt;&lt;/a&gt;: backport to 4_10 branch so we can backport &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14163950" author="jira-bot" created="Wed, 8 Oct 2014 18:41:39 +0000"  >&lt;p&gt;Commit 1630196 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1630196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1630196&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: backport to 4.10 branch&lt;/p&gt;</comment>
                            <comment id="14169037" author="shalinmangar" created="Mon, 13 Oct 2014 07:38:53 +0000"  >&lt;p&gt;Tim, the change to the LIR state to be kept as map is not back-compatible. For example, I saw the following error upon upgrading a cluster (to trunk) (which had some LIR state written down in ZK already). But looking at the code, the same exception can happen on upgrading to latest lucene_solr_4_10 branch too.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;41228 [RecoveryThread] ERROR org.apache.solr.cloud.RecoveryStrategy   Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to recover. core=coll_5x3_shard5_replica3:java.lang.ClassCastException: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to java.util.Map
        at org.apache.solr.cloud.ZkController.getLeaderInitiatedRecoveryStateObject(ZkController.java:1993)
        at org.apache.solr.cloud.ZkController.getLeaderInitiatedRecoveryState(ZkController.java:1958)
        at org.apache.solr.cloud.ZkController.publish(ZkController.java:1105)
        at org.apache.solr.cloud.ZkController.publish(ZkController.java:1075)
        at org.apache.solr.cloud.ZkController.publish(ZkController.java:1071)
        at org.apache.solr.cloud.RecoveryStrategy.doRecovery(RecoveryStrategy.java:355)
        at org.apache.solr.cloud.RecoveryStrategy.run(RecoveryStrategy.java:235)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14169402" author="jira-bot" created="Mon, 13 Oct 2014 15:35:37 +0000"  >&lt;p&gt;Commit 1631439 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631439&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631439&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: fix back compat issue when reading existing data from ZK&lt;/p&gt;</comment>
                            <comment id="14169428" author="jira-bot" created="Mon, 13 Oct 2014 15:52:14 +0000"  >&lt;p&gt;Commit 1631444 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631444&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631444&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: fix back compat issue when reading existing data from ZK&lt;/p&gt;</comment>
                            <comment id="14169432" author="jira-bot" created="Mon, 13 Oct 2014 15:55:45 +0000"  >&lt;p&gt;Commit 1631447 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631447&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6511&quot; title=&quot;Fencepost error in LeaderInitiatedRecoveryThread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6511&quot;&gt;&lt;del&gt;SOLR-6511&lt;/del&gt;&lt;/a&gt;: fix back compat issue when reading existing data from ZK&lt;/p&gt;</comment>
                            <comment id="14169433" author="thelabdude" created="Mon, 13 Oct 2014 15:57:00 +0000"  >&lt;p&gt;Good catch Shalin thanks. That&apos;s my bad for changing functionality as part of this ticket.&lt;/p&gt;</comment>
                            <comment id="14175862" author="shalinmangar" created="Sat, 18 Oct 2014 05:31:18 +0000"  >&lt;p&gt;Hi Tim, sorry for the late review but it&apos;d more awesome if we put the replica core in addition to the node name inside createdByNode key (or maybe just coreNodeName). Otherwise if there are more than one replica for the same shard on the node then we don&apos;t know which one created the LIR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12670115" name="SOLR-6511.patch" size="30041" author="thelabdude" created="Fri, 19 Sep 2014 22:14:50 +0000"/>
                            <attachment id="12668426" name="SOLR-6511.patch" size="11283" author="thelabdude" created="Fri, 12 Sep 2014 18:50:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zzen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>