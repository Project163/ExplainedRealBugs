<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:12:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17916] Jetty 12.0.25 upgrade exposes RST_STREAM burst issue</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17916</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;After upgrading Jetty from &lt;b&gt;12.0.19 &#8594; 12.0.25&lt;/b&gt;, the test &lt;tt&gt;DistributedDebugComponentTest.testTolerantSearch&lt;/tt&gt; starts failing.&lt;/p&gt;

&lt;p&gt;The test sets up a query with a deliberately bad shard:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; badShard = DEAD_HOST_1 + &lt;span class=&quot;code-quote&quot;&gt;&quot;/solr/collection1&quot;&lt;/span&gt;;
query.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;shards&quot;&lt;/span&gt;, badShard+ &lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt; + shard2 + &lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt; + shard1);
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; (TEST_NIGHTLY ? 500 : 200); i++) {
&#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// verify that the request would fail &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; shards.tolerant=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/span&gt;&#160; &#160; &#160; query.set(ShardParams.SHARDS_TOLERANT, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
&#160; &#160; &#160; ignoreException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection refused&quot;&lt;/span&gt;);
&#160; &#160; &#160; expectThrows(SolrException.class, () -&amp;gt; collection1.query(query));
&#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// verify that the request would succeed &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; shards.tolerant=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/span&gt;&#160; &#160; &#160; query.set(ShardParams.SHARDS_TOLERANT, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);
&#160; &#160; &#160; QueryResponse response = collection1.query(query); &lt;span class=&quot;code-comment&quot;&gt;// fail here!
&lt;/span&gt;....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For each iteration, it issues:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;shards.tolerant = false&lt;/b&gt; &#8594; as expected, the coordinator fails fast because one shard is dead.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;shards.tolerant = true&lt;/b&gt; &#8594; expected to succeed using results from the good shard(s), but &lt;b&gt;fails after the Jetty upgrade&lt;/b&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Observed behavior&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In the non-tolerant branch, &lt;tt&gt;SearchHandler&lt;/tt&gt; throws early on the shard exception.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;At this point &lt;tt&gt;HttpShardHandler&lt;/tt&gt; cancels the outstanding async requests to the other shards, calling &lt;tt&gt;future.cancel(true)&lt;/tt&gt; / &lt;tt&gt;request.abort()&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;That abort translates into &lt;b&gt;RST_STREAM&lt;/b&gt; frames sent to Jetty.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;With the loop running hundreds of iterations, these cancels accumulate on a single HTTP/2 session.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Jetty 12.0.25 enforces stricter HTTP/2 rate control:&lt;br/&gt;
GoAwayFrame{... enhance_your_calm_error/invalid_rst_stream_frame_rate}&lt;/li&gt;
	&lt;li&gt;Once the rate limit is tripped, the server responds with GOAWAY and closes the connection.&lt;/li&gt;
	&lt;li&gt;The subsequent tolerant request then fails, even though at least one shard is healthy.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13628754">SOLR-17916</key>
            <summary>Jetty 12.0.25 upgrade exposes RST_STREAM burst issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sanjaydutt">Sanjay Dutt</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 12 Sep 2025 09:57:25 +0000</created>
                <updated>Tue, 14 Oct 2025 06:57:07 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="18019810" author="JIRAUSER305513" created="Fri, 12 Sep 2025 10:04:29 +0000"  >&lt;p&gt;This is where the client aborts the request, inside the Http2SolrClient#requestAsync. If I comment it, then client never sends RST_STREAM and test runs smoothly.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.exceptionally(
&#160; (error) -&amp;gt; {
&#160; &#160; mrrv.request.abort(error);
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
});&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="18019994" author="dsmiley" created="Sat, 13 Sep 2025 05:27:43 +0000"  >&lt;p&gt;I&apos;m so impressed with this analysis Sanjay!  This is deja-vu with some similar maybe benchmark module issue that I&apos;ve forgotten about.&lt;/p&gt;

&lt;p&gt;I think we &lt;b&gt;do&lt;/b&gt; want to abort the stream to inform the server that any work it does is for naught.  I&apos;m uncertain the server can realistically know what happened.&lt;/p&gt;

&lt;p&gt;Can we configure the rate control of this or disable it?  If not, maybe this test should use HTTP 1.1 to avoid this?  It doesn&apos;t seem like this test is really trying to test HTTP 2 or Jetty.  WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt; &amp;#8211; you recently updated this test.&lt;/p&gt;</comment>
                            <comment id="18020163" author="JIRAUSER305513" created="Sun, 14 Sep 2025 14:31:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can we configure the rate control?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This test can send hundreds of requests in a second, which fans out into thousands once each request hits three shards. That makes it harder to come up with any realistic limit.&lt;/p&gt;

&lt;p&gt;For reference, here&#8217;s how the limit can be set:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;In &lt;tt&gt;JettySolrRunner&lt;/tt&gt;:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HTTP2ServerConnectionFactory http2ConnectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTTP2CServerConnectionFactory(configuration);
http2ConnectionFactory.setRateControlFactory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WindowRateControl.Factory(256));
connector =
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServerConnector(
server,
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpConnectionFactory(configuration),
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTTP2CServerConnectionFactory(configuration));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
&lt;b&gt;In &lt;tt&gt;jetty-https.xml&lt;/tt&gt;:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;New class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.eclipse.jetty.http2.server.HTTP2ServerConnectionFactory&quot;&lt;/span&gt;&amp;gt;
&amp;lt;Arg name=&lt;span class=&quot;code-quote&quot;&gt;&quot;config&quot;&lt;/span&gt;&amp;gt;&amp;lt;Ref refid=&lt;span class=&quot;code-quote&quot;&gt;&quot;sslHttpConfig&quot;&lt;/span&gt;/&amp;gt;&amp;lt;/Arg&amp;gt;
&amp;lt;Set name=&lt;span class=&quot;code-quote&quot;&gt;&quot;rateControlFactory&quot;&lt;/span&gt;&amp;gt;
&amp;lt;New class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.eclipse.jetty.http2.WindowRateControl$Factory&quot;&lt;/span&gt;&amp;gt;
&amp;lt;Arg type=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;&amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;jetty.http2.rateControl.maxEventsPerSecond&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;256&quot;&lt;/span&gt;/&amp;gt;&amp;lt;/Arg&amp;gt;
&amp;lt;/New&amp;gt;
&amp;lt;/Set&amp;gt;
&amp;lt;/New&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Should we just disable it?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The rate control exists because of &lt;a href=&quot;https://github.com/advisories/GHSA-mmxm-8w33-wc4h&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this CVE&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thus, the attacker can exploit this vulnerability to cause the server to handle an unbounded number of concurrent streams from a client on the same connection. The exploitation is very simple: the client issues a request in a stream, and then sends the control frame that causes the server to send a RST_STREAM.&lt;/em&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If not, maybe this test should use HTTP 1.1 to avoid this?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Are you talking about starting Solr with HTTP/1.1&#8212;tests already use &lt;tt&gt;HttpSolrClient&lt;/tt&gt;. The connection that trips the limit is the one used by &lt;tt&gt;HttpShardHandler&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Have you noticed that other tests were also failing from the same class and have nothing to do with shard_tolerant queries?&#160;&lt;/p&gt;

&lt;p&gt;Once &lt;tt&gt;testTolerantSearch&lt;/tt&gt; crosses the limit, the entire HTTP/2 session used by &lt;tt&gt;HttpShardHandler&lt;/tt&gt; is closed. That closes all streams on that session, which is why other tests fail as well. In production, if that happened and I believe it would be very easy to create such scenario, we could easily gets into situation where HttpShardHandler also silently closing/failing other requests as well.&#160;&lt;/p&gt;</comment>
                            <comment id="18020236" author="dsmiley" created="Mon, 15 Sep 2025 03:01:16 +0000"  >&lt;p&gt;At the very start of the test setup (DistributedDebugComponentTest.createThings()), I added this:&lt;br/&gt;
&lt;tt&gt;System.setProperty(&quot;solr.http1&quot;, &quot;true&quot;);&lt;/tt&gt; and the test started passing.  This is honored as the default for all clients created throughout Solr.&lt;/p&gt;

&lt;p&gt;I have not noticed other failing tests.  It&apos;s definitely a rare test to do this.  It&apos;s tempting to disable this rate control limit in JettySolrRunner, which is just for tests and also the benchmark module.  That&apos;s my preference but just a preference.&lt;/p&gt;</comment>
                            <comment id="18020803" author="houston" created="Wed, 17 Sep 2025 00:10:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sanjaydutt&quot; class=&quot;user-hover&quot; rel=&quot;sanjaydutt&quot;&gt;sanjaydutt&lt;/a&gt; I did the exact same thing when fixing this test before. Comment out the request abort. Because it would bleed over to other (unrelated) requests in the Solr 9 branch. When testing, it didn&apos;t happen in the main branch, so I left it.&lt;/p&gt;

&lt;p&gt;I guess we were using a more &quot;up-to-date&quot; jetty in 9.x at the time. But that ticket was: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17819&quot; title=&quot;HttpShardHandler non-tolerant request cancellation bleeds across requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17819&quot;&gt;&lt;del&gt;SOLR-17819&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I say we comment it out, because it can only cause issues for us going forward. It&apos;s much better to leave the request running than have 1 bad request start cancelling other requests that are in flight.&lt;/p&gt;</comment>
                            <comment id="18021675" author="dsmiley" created="Sun, 21 Sep 2025 15:34:03 +0000"  >&lt;p&gt;Okay +1.  I suppose cancelling the request wouldn&apos;t &lt;em&gt;actually&lt;/em&gt; lead to any savings anyway &amp;#8211; I doubt Solr&apos;s request would be interrupted, for example.&lt;/p&gt;</comment>
                            <comment id="18029432" author="jira-bot" created="Mon, 13 Oct 2025 08:46:02 +0000"  >&lt;p&gt;Commit 4bcdf2cbad3ff5e9eefcba04a330ff73480e3b17 in solr&apos;s branch refs/heads/main from Sanjay Dutt&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=4bcdf2cbad3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=4bcdf2cbad3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17916&quot; title=&quot;Jetty 12.0.25 upgrade exposes RST_STREAM burst issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17916&quot;&gt;SOLR-17916&lt;/a&gt;: Bump up jetty to 12.0.27 (#3695)&lt;/p&gt;
</comment>
                            <comment id="18029686" author="jira-bot" created="Tue, 14 Oct 2025 06:57:07 +0000"  >&lt;p&gt;Commit 4bcdf2cbad3ff5e9eefcba04a330ff73480e3b17 in solr&apos;s branch refs/heads/dependabot/gradle/apache-poi-5.4.1 from Sanjay Dutt&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=4bcdf2cbad3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=4bcdf2cbad3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17916&quot; title=&quot;Jetty 12.0.25 upgrade exposes RST_STREAM burst issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17916&quot;&gt;SOLR-17916&lt;/a&gt;: Bump up jetty to 12.0.27 (#3695)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xnzc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>