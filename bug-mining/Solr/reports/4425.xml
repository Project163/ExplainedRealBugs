<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:42:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14192] Race condition between SchemaManager and ZkIndexSchemaReader</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14192</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Spin-off from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14128&quot; title=&quot;SystemCollectionCompatTest times out waiting for Overseer to do compatibility checks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14128&quot;&gt;&lt;del&gt;SOLR-14128&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13368&quot; title=&quot;SchemaManager failures when processing schema update requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13368&quot;&gt;&lt;del&gt;SOLR-13368&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In SolrCloud when a SolrCore is created and it uses managed schema then its &lt;tt&gt;ManagedIndexSchemaFactory&lt;/tt&gt; performs an automatic upgrade of the initial &lt;tt&gt;schema.xml&lt;/tt&gt; to &lt;tt&gt;managed-schema&lt;/tt&gt;. This includes removing the original &lt;tt&gt;schema.xml&lt;/tt&gt; file.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13368&quot; title=&quot;SchemaManager failures when processing schema update requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13368&quot;&gt;&lt;del&gt;SOLR-13368&lt;/del&gt;&lt;/a&gt; added some locking to make sure the changed resource name (i.e. &lt;tt&gt;managed-schema&lt;/tt&gt;) becomes visible only when this process is complete, and that in-flight requests to /admin/schema block until this process is complete, to avoid returning inconsistent data. This locking mechanism uses simple Object monitors.&lt;/p&gt;

&lt;p&gt;However, if there&apos;s more than 1 node in the cluster the subsequent request to retrieve schema may execute on a core that still hasn&apos;t reloaded its schema (&lt;tt&gt;ZkIndexSchemaReader&lt;/tt&gt; uses a ZK watcher, which may take some time to trigger), and the resource name in that stale schema still points to &lt;tt&gt;schema.xml&lt;/tt&gt;, which by this time no longer exists because it was removed by &lt;tt&gt;ManagedIndexSchemaFactory&lt;/tt&gt; in the first core.&lt;/p&gt;

&lt;p&gt;As I see it there are two bugs here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;there&apos;s no distributed locking when this upgrade is performed, so it&apos;s natural that there are multiple cores racing against each other to perform this upgrade.&lt;/li&gt;
	&lt;li&gt;the upgrade process removes &lt;tt&gt;schema.xml&lt;/tt&gt; too early - it triggers all other cores by creating the &lt;tt&gt;managed-schema&lt;/tt&gt; file, and then other cores reload from the new managed schema - but it should wait until this reload is complete on all cores because only then it&apos;s safe to delete the non-managed resource as it&apos;s no longer in use by any core.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Issue 1. can be solved by adding an ephemeral znode lock so that only one core can perform the upgrade. Issue 2. can be solved by using &lt;tt&gt;ManagedIndexSchema.waitForSchemaZkVersionAgreement&lt;/tt&gt; after upgrade, and deleting &lt;tt&gt;schema.xml&lt;/tt&gt; only after it&apos;s done.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13279945">SOLR-14192</key>
            <summary>Race condition between SchemaManager and ZkIndexSchemaReader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Jan 2020 17:40:49 +0000</created>
                <updated>Tue, 24 Mar 2020 12:46:17 +0000</updated>
                            <resolved>Tue, 21 Jan 2020 11:29:01 +0000</resolved>
                                    <version>8.4</version>
                                    <fixVersion>8.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17017466" author="ab" created="Thu, 16 Jan 2020 20:38:33 +0000"  >&lt;p&gt;This patch seems to fix it for me, at least I wasn&apos;t able to reproduce this anymore.&lt;/p&gt;

&lt;p&gt;Summary of changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;use an ephemeral ZK lock when upgrading the schema to managed.&lt;/li&gt;
	&lt;li&gt;be more lenient when retrieving the schema - if local core claims to be still using &lt;tt&gt;schema.xml&lt;/tt&gt;&#160;but it cannot be found in ZK then try to retrieve the backup left over after upgrade, ie. &lt;tt&gt;schema.xml.bak&lt;/tt&gt;, and if that doesn&apos;t exist either then simply use the current in-memory schema.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17019576" author="jira-bot" created="Mon, 20 Jan 2020 16:12:06 +0000"  >&lt;p&gt;Commit 6244b7150e6dd544879e142e59c8f98a2694d837 in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6244b71&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6244b71&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14192&quot; title=&quot;Race condition between SchemaManager and ZkIndexSchemaReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14192&quot;&gt;&lt;del&gt;SOLR-14192&lt;/del&gt;&lt;/a&gt;: Race condition between SchemaManager and ZkIndexSchemaReader.&lt;/p&gt;</comment>
                            <comment id="17019638" author="jira-bot" created="Mon, 20 Jan 2020 17:08:55 +0000"  >&lt;p&gt;Commit 4c72b3d9704d6dc2fcb7a85b628d7658477a651f in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4c72b3d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4c72b3d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14192&quot; title=&quot;Race condition between SchemaManager and ZkIndexSchemaReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14192&quot;&gt;&lt;del&gt;SOLR-14192&lt;/del&gt;&lt;/a&gt;: Race condition between SchemaManager and ZkIndexSchemaReader.&lt;/p&gt;</comment>
                            <comment id="17022357" author="jira-bot" created="Thu, 23 Jan 2020 18:34:43 +0000"  >&lt;p&gt;Commit 434f90265b676211e06a4727327e775cf35c42bd in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=434f902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=434f902&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14211&quot; title=&quot;TestBulkSchemaConcurrent failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14211&quot;&gt;&lt;del&gt;SOLR-14211&lt;/del&gt;&lt;/a&gt;: Fix a bug introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14192&quot; title=&quot;Race condition between SchemaManager and ZkIndexSchemaReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14192&quot;&gt;&lt;del&gt;SOLR-14192&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17022705" author="dsmiley" created="Fri, 24 Jan 2020 05:39:12 +0000"  >&lt;p&gt;IMO we should remove the underlying complexity and not have the schema file change on the fly.  Certainly out of scope here but this bug reveals it&apos;s tricky.  Also I encountered this as a limitation when doing schema sharing in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14040&quot; title=&quot;solr.xml shareSchema does not work in SolrCloud&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14040&quot;&gt;&lt;del&gt;SOLR-14040&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17024155" author="jira-bot" created="Mon, 27 Jan 2020 08:25:13 +0000"  >&lt;p&gt;Commit df91041652d1045f0d1bec5fec6b096c71ba85e3 in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=df91041&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=df91041&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14211&quot; title=&quot;TestBulkSchemaConcurrent failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14211&quot;&gt;&lt;del&gt;SOLR-14211&lt;/del&gt;&lt;/a&gt;: Fix a bug introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14192&quot; title=&quot;Race condition between SchemaManager and ZkIndexSchemaReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14192&quot;&gt;&lt;del&gt;SOLR-14192&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17065699" author="romseygeek" created="Tue, 24 Mar 2020 12:46:17 +0000"  >&lt;p&gt;Bulk close for 8.5.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12991173" name="SOLR-14192.patch" size="6643" author="ab" created="Thu, 16 Jan 2020 20:36:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0al3k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>