<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17720] Deadlock in CollectionPropertiesZkStateReader</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17720</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;CollectionPropertiesZkStateReader&lt;/tt&gt; has multiple different mechanisms for synchronizing when modifying its concurrent data structures.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;synchronized (getCollectionLock(collection))&lt;/tt&gt;&#160;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;collectionPropsObservers&lt;/tt&gt; is a ConcurrentHashMap, and therefore locks on updating a single key within the map.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Unfortunately this can cause a deadlock.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;CollectionPropertiesZkStateReader.removeCollectionPropsWatcher()&lt;/tt&gt;,  &lt;tt&gt;collectionPropsObservers.compute(collection, &amp;lt;function&amp;gt;)&lt;/tt&gt; is used which will create a lock in &lt;tt&gt;collectionPropsObservers&lt;/tt&gt; on the &lt;tt&gt;collection&lt;/tt&gt; key. Within this locked &lt;tt&gt;&amp;lt;function&amp;gt;&lt;/tt&gt; command, &lt;tt&gt;synchronized (getCollectionLock(collection))&lt;/tt&gt; is called.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;CollectionPropertiesZkStateReader.refreshAndWatch()&lt;/tt&gt;, &lt;tt&gt;synchronized (getCollectionLock(coll))&lt;/tt&gt; is used for the whole method. And within this synchronized block, &lt;tt&gt;collectionPropsObservers.remove(coll)&lt;/tt&gt; is called (which will obviously get a lock on the &lt;tt&gt;coll&lt;/tt&gt; key for &lt;tt&gt;collectionPropsObservers&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So &lt;tt&gt;CollectionPropertiesZkStateReader.removeCollectionPropsWatcher()&lt;/tt&gt; has the lock for &lt;tt&gt;collectionPropsObservers&lt;/tt&gt; but is waiting on the lock for &lt;tt&gt;getCollectionLock(coll)&lt;/tt&gt;. And &lt;tt&gt;CollectionPropertiesZkStateReader.refreshAndWatch()&lt;/tt&gt; has the lock for &lt;tt&gt;getCollectionLock(coll)&lt;/tt&gt; and is waiting on the lock for &lt;tt&gt;collectionPropsObservers&lt;/tt&gt;. Hence deadlock.&lt;/p&gt;

&lt;p&gt;This code is quite complex, and I think it can really be simplified, but that&apos;s just a gut reaction. I think moving the &lt;tt&gt;synchronized (getCollectionLock(collection))&lt;/tt&gt; block in &lt;tt&gt;removeCollectionPropsWatcher()&lt;/tt&gt; outside of the &lt;tt&gt;compute()&lt;/tt&gt; call would solve this one deadlock though.&lt;/p&gt;

&lt;p&gt;Hopefully we can really simplify this with Curator though.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13613192">SOLR-17720</key>
            <summary>Deadlock in CollectionPropertiesZkStateReader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="houston">Houston Putman</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 26 Mar 2025 16:22:21 +0000</created>
                <updated>Thu, 24 Jul 2025 22:50:54 +0000</updated>
                            <resolved>Wed, 23 Apr 2025 14:20:37 +0000</resolved>
                                    <version>9.7</version>
                                    <fixVersion>9.9</fixVersion>
                                    <component>SolrJ</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17938704" author="dsmiley" created="Wed, 26 Mar 2025 18:42:36 +0000"  >&lt;p&gt;Fascinating. &#160;Did a test (which?) reveal this?&lt;/p&gt;</comment>
                            <comment id="17938705" author="houston" created="Wed, 26 Mar 2025 18:46:46 +0000"  >&lt;p&gt;Yep, here: &lt;a href=&quot;https://jenkins.thetaphi.de/view/Solr/job/Solr-main-Linux/24100/testReport/junit/org.apache.solr.cloud/CollectionPropsTest/testWatcher/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/view/Solr/job/Solr-main-Linux/24100/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s failed a few other times too.&lt;/p&gt;</comment>
                            <comment id="17939027" author="dsmiley" created="Thu, 27 Mar 2025 17:38:33 +0000"  >&lt;p&gt;Collection Properties is definitely ripe for a Curator oriented overhaul. &#160;We shouldn&apos;t have so much low level code around it!&lt;/p&gt;</comment>
                            <comment id="17939032" author="JIRAUSER302780" created="Thu, 27 Mar 2025 17:50:41 +0000"  >&lt;p&gt;Yes - the possibility of deadlock also existed in ZkStateReader between&#160;watchedCollectionProps and collectionPropsWatchers before collection properties management was delegated to CollectionPropertiesZkStateReader.&lt;/p&gt;

&lt;p&gt;&#160;&quot;I think moving the &lt;tt&gt;synchronized (getCollectionLock(collection))&lt;/tt&gt;&#160;block in&#160;&lt;tt&gt;removeCollectionPropsWatcher()&lt;/tt&gt;&#160;outside of the&#160;&lt;tt&gt;compute()&lt;/tt&gt; call would solve this one deadlock though.&quot;&lt;br/&gt;
Yes, that would ensure locks are acquired in consistent order. I will be happy to contribute a fix shortly&#160;&lt;/p&gt;</comment>
                            <comment id="17940402" author="JIRAUSER302780" created="Wed, 2 Apr 2025 15:52:35 +0000"  >&lt;p&gt;Created a PR today.&lt;/p&gt;</comment>
                            <comment id="17946570" author="jira-bot" created="Tue, 22 Apr 2025 23:35:19 +0000"  >&lt;p&gt;Commit 67a642fe0263588155627c0429ea5cf39f519c8e in solr&apos;s branch refs/heads/main from aparnasuresh85&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=67a642fe026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=67a642fe026&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17720&quot; title=&quot;Deadlock in CollectionPropertiesZkStateReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17720&quot;&gt;&lt;del&gt;SOLR-17720&lt;/del&gt;&lt;/a&gt;: Fix rare deadlock in CollectionProperties (#3304)&lt;/p&gt;

&lt;p&gt;The problem pre-dated CollectionPropertiesZkStateReader&apos;s existence.&lt;/p&gt;</comment>
                            <comment id="17946571" author="jira-bot" created="Tue, 22 Apr 2025 23:38:37 +0000"  >&lt;p&gt;Commit eb3bafab83b4f3c4801835f8d97740992f6ca93d in solr&apos;s branch refs/heads/branch_9x from aparnasuresh85&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=eb3bafab83b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=eb3bafab83b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17720&quot; title=&quot;Deadlock in CollectionPropertiesZkStateReader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17720&quot;&gt;&lt;del&gt;SOLR-17720&lt;/del&gt;&lt;/a&gt;: Fix rare deadlock in CollectionProperties (#3304)&lt;/p&gt;

&lt;p&gt;The problem pre-dated CollectionPropertiesZkStateReader&apos;s existence.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 67a642fe0263588155627c0429ea5cf39f519c8e)&lt;/p&gt;</comment>
                            <comment id="17946725" author="dsmiley" created="Wed, 23 Apr 2025 14:20:37 +0000"  >&lt;p&gt;Thanks for contributing the fix Aparna!&lt;/p&gt;</comment>
                            <comment id="18009763" author="houston" created="Thu, 24 Jul 2025 22:50:54 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1v0bs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>