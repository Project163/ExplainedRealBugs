<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:41:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5418] Background merge after field removed from solr.xml causes error</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5418</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Problem from the user&apos;s list, cut/pasted below. Robert Muir hacked out a quick patch he pasted on the dev list, I&apos;ll append it shortly.&lt;/p&gt;

&lt;p&gt;I am working at implementing solr to work as the search backend for our web&lt;br/&gt;
system.  So far things have been going well, but today I made some schema&lt;br/&gt;
changes and now things have broken.&lt;/p&gt;

&lt;p&gt;I updated the schema.xml file and reloaded the core (via the admin&lt;br/&gt;
interface).  No errors were reported in the logs.&lt;/p&gt;

&lt;p&gt;I then pushed 100 records to be indexed.  A call to Commit afterwards&lt;br/&gt;
seemed fine, however my next call for Optimize caused the following errors:&lt;/p&gt;

&lt;p&gt;java.io.IOException: background merge hit exception:&lt;br/&gt;
_2n(4.4):C4263/154 _30(4.4):C134 _32(4.4):C10 _31(4.4):C10 into _37&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;maxNumSegments=1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;null:java.io.IOException: background merge hit exception:&lt;br/&gt;
_2n(4.4):C4263/154 _30(4.4):C134 _32(4.4):C10 _31(4.4):C10 into _37&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;maxNumSegments=1&amp;#93;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;Unfortunately, googling for background merge hit exception came up&lt;br/&gt;
with 2 thing: a corrupt index or not enough free space.  The host&lt;br/&gt;
machine that&apos;s hosting solr has 227 out of 229GB free (according to df&lt;br/&gt;
-h), so that&apos;s not it.&lt;/p&gt;


&lt;p&gt;I then ran CheckIndex on the index, and got the following results:&lt;br/&gt;
&lt;a href=&quot;http://apaste.info/gmGU&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apaste.info/gmGU&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;As someone who is new to solr and lucene, as far as I can tell this&lt;br/&gt;
means my index is fine. So I am coming up at a loss. I&apos;m somewhat sure&lt;br/&gt;
that I could probably delete my data directory and rebuild it but I am&lt;br/&gt;
more interested in finding out why is it having issues, what is the&lt;br/&gt;
best way to fix it, and what is the best way to prevent it from&lt;br/&gt;
happening when this goes into production.&lt;/p&gt;


&lt;p&gt;Does anyone have any advice that may help?&lt;/p&gt;

&lt;p&gt;I helped Matthew find the logs and he posted this stack trace:&lt;/p&gt;

&lt;p&gt;1691103929 &lt;span class=&quot;error&quot;&gt;&amp;#91;http-bio-8080-exec-3&amp;#93;&lt;/span&gt; INFO  org.apache.solr.update.UpdateHandler  &#226; start commit&lt;/p&gt;
{,optimize=true,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}
&lt;p&gt;1691104153 &lt;span class=&quot;error&quot;&gt;&amp;#91;http-bio-8080-exec-3&amp;#93;&lt;/span&gt; INFO  org.apache.solr.update.processor.LogUpdateProcessor  &#226; &lt;span class=&quot;error&quot;&gt;&amp;#91;dbqItems&amp;#93;&lt;/span&gt; webapp=/solr path=/update params=&lt;/p&gt;
{optimize=true&amp;amp;_=1382999386564&amp;amp;wt=json&amp;amp;waitFlush=true}
&lt;p&gt; {} 0 224&lt;br/&gt;
1691104154 &lt;span class=&quot;error&quot;&gt;&amp;#91;http-bio-8080-exec-3&amp;#93;&lt;/span&gt; ERROR org.apache.solr.core.SolrCore  &#226; java.io.IOException: background merge hit exception: _2n(4.4):C4263/154 _30(4.4):C134 _32(4.4):C10 _31(4.4):C10 into _39 &lt;span class=&quot;error&quot;&gt;&amp;#91;maxNumSegments=1&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.lucene.index.IndexWriter.forceMerge(IndexWriter.java:1714)&lt;br/&gt;
        at org.apache.lucene.index.IndexWriter.forceMerge(IndexWriter.java:1650)&lt;br/&gt;
        at org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:530)&lt;br/&gt;
        at org.apache.solr.update.processor.RunUpdateProcessor.processCommit(RunUpdateProcessorFactory.java:95)&lt;br/&gt;
        at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:64)&lt;br/&gt;
        at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalCommit(DistributedUpdateProcessor.java:1240)&lt;br/&gt;
        at org.apache.solr.update.processor.DistributedUpdateProcessor.processCommit(DistributedUpdateProcessor.java:1219)&lt;br/&gt;
        at org.apache.solr.update.processor.LogUpdateProcessor.processCommit(LogUpdateProcessorFactory.java:157)&lt;br/&gt;
        at org.apache.solr.handler.RequestHandlerUtils.handleCommit(RequestHandlerUtils.java:69)&lt;br/&gt;
        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)&lt;br/&gt;
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)&lt;br/&gt;
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1904)&lt;br/&gt;
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:659)&lt;br/&gt;
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:362)&lt;br/&gt;
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:158)&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:243)&lt;br/&gt;
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:210)&lt;br/&gt;
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:222)&lt;br/&gt;
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:123)&lt;br/&gt;
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)&lt;br/&gt;
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:99)&lt;br/&gt;
        at org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:953)&lt;br/&gt;
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:118)&lt;br/&gt;
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)&lt;br/&gt;
        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1023)&lt;br/&gt;
        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)&lt;br/&gt;
        at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:312)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1146)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:679)&lt;br/&gt;
Caused by: java.lang.IllegalArgumentException: no such field what&lt;br/&gt;
        at org.apache.solr.core.SchemaCodecFactory$1.getPostingsFormatForField(SchemaCodecFactory.java:59)&lt;br/&gt;
        at org.apache.lucene.codecs.lucene42.Lucene42Codec$1.getPostingsFormatForField(Lucene42Codec.java:59)&lt;br/&gt;
        at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.addField(PerFieldPostingsFormat.java:102)&lt;br/&gt;
        at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:71)&lt;br/&gt;
        at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:365)&lt;br/&gt;
        at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:98)&lt;br/&gt;
        at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3772)&lt;br/&gt;
        at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3376)&lt;br/&gt;
        at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:405)&lt;br/&gt;
        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:482)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677225">SOLR-5418</key>
            <summary>Background merge after field removed from solr.xml causes error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="erickerickson">Erick Erickson</assignee>
                                    <reporter username="erickerickson">Erick Erickson</reporter>
                        <labels>
                    </labels>
                <created>Sat, 2 Nov 2013 12:40:15 +0000</created>
                <updated>Mon, 9 May 2016 18:43:46 +0000</updated>
                            <resolved>Tue, 5 Nov 2013 01:54:22 +0000</resolved>
                                    <version>4.5</version>
                                    <fixVersion>4.6</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>Schema and Analysis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13811976" author="erickerickson" created="Sat, 2 Nov 2013 13:20:00 +0000"  >&lt;p&gt;Patch constructed from cut-n-paste of Robert&apos;s quick code change on the dev list.&lt;/p&gt;

&lt;p&gt;Warning, it&apos;s cut/paste, not generated from svn so be warned....&lt;/p&gt;</comment>
                            <comment id="13812088" author="rcmuir" created="Sat, 2 Nov 2013 17:58:56 +0000"  >&lt;p&gt;Here is the patch from my svn checkout.&lt;/p&gt;

&lt;p&gt;I sent it to the list really quick just to get an opinion on it. I don&apos;t remember why the current checks were added. I guess I can see a line of reasoning that its good for the user to know they are dragging unused shit around in their index.&lt;/p&gt;

&lt;p&gt;And I can agree with that, but I don&apos;t think its the job of the codec to fail a background merge to communicate such a thing to the user.&lt;/p&gt;

&lt;p&gt;Such a warning/failure could be implemented in other ways, for example a warmer in the example for &quot;firstSearcher&quot; event that looks at fieldinfos and warns or fails &quot;YOU ARE DRAGGING AROUND BOGUS STUFF IN YOUR INDEX&quot; if it finds things that don&apos;t match to the schema or something like that: and it would be easy for users to enable/disable.&lt;/p&gt;</comment>
                            <comment id="13812094" author="erickerickson" created="Sat, 2 Nov 2013 18:07:18 +0000"  >&lt;p&gt;Thanks Robert! Mostly I was making sure I didn&apos;t lose anything....&lt;/p&gt;


</comment>
                            <comment id="13813020" author="erickerickson" created="Mon, 4 Nov 2013 17:12:15 +0000"  >&lt;p&gt;Well, this is annoying. I can generate this failure easily enough with running stock Solr (trunk or 4x), but I can&apos;t seem to get a test case to fail inside or outside of IntelliJ. &lt;/p&gt;

&lt;p&gt;I&apos;ve tracked creating two separate segments (forced disk index). They are being merged into one. But in the test case, it&apos;s not getting to the code that Robert changed. I&apos;ve verified that I am successfully changing the schema (tried to index a second doc with the removed field and it fails in the IDE).&lt;/p&gt;

&lt;p&gt;So I can easily enough reproduce the problem, but I&apos;m having difficulty making a test case. I want a verified failure before I apply the patch...&lt;/p&gt;

&lt;p&gt;I&apos;m in the midst of seeing if our test suite &lt;em&gt;ever&lt;/em&gt; hits the code in question (Siigggh. Back to debugging by println).&lt;/p&gt;

&lt;p&gt;Any pointers gratefully received.&lt;/p&gt;

&lt;p&gt;Erick&lt;/p&gt;</comment>
                            <comment id="13813045" author="erickerickson" created="Mon, 4 Nov 2013 17:45:04 +0000"  >&lt;p&gt;Apparently, NONE of our test code hits the code in question. I notice that this is a 4.6 codec, am I missing something obvious here? Well of course I am. I just wish I knew what it was.&lt;/p&gt;</comment>
                            <comment id="13813404" author="erickerickson" created="Mon, 4 Nov 2013 23:18:18 +0000"  >&lt;p&gt;Patch back with a test.&lt;/p&gt;</comment>
                            <comment id="13813405" author="erickerickson" created="Mon, 4 Nov 2013 23:20:26 +0000"  >&lt;p&gt;Put entry in CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="13813407" author="jira-bot" created="Mon, 4 Nov 2013 23:21:45 +0000"  >&lt;p&gt;Commit 1538802 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickoerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickoerickson&quot;&gt;erickoerickson&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1538802&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1538802&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5418&quot; title=&quot;Background merge after field removed from solr.xml causes error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5418&quot;&gt;&lt;del&gt;SOLR-5418&lt;/del&gt;&lt;/a&gt;, merge after altering schema produces error&lt;/p&gt;</comment>
                            <comment id="13813517" author="jira-bot" created="Tue, 5 Nov 2013 01:23:22 +0000"  >&lt;p&gt;Commit 1538848 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickoerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickoerickson&quot;&gt;erickoerickson&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1538848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1538848&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5418&quot; title=&quot;Background merge after field removed from solr.xml causes error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5418&quot;&gt;&lt;del&gt;SOLR-5418&lt;/del&gt;&lt;/a&gt;, merge after altering schema produces error&lt;/p&gt;</comment>
                            <comment id="13813546" author="erickerickson" created="Tue, 5 Nov 2013 01:54:22 +0000"  >&lt;p&gt;Thanks Matthew and Robert!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12612053" name="SOLR-5418.patch" size="11040" author="erickerickson" created="Mon, 4 Nov 2013 23:20:26 +0000"/>
                            <attachment id="12612052" name="SOLR-5418.patch" size="10546" author="erickerickson" created="Mon, 4 Nov 2013 23:18:18 +0000"/>
                            <attachment id="12611776" name="SOLR-5418.patch" size="3001" author="rcmuir" created="Sat, 2 Nov 2013 17:58:56 +0000"/>
                            <attachment id="12611760" name="SOLR-5418.patch" size="2995" author="erickerickson" created="Sat, 2 Nov 2013 13:20:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356600</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ph4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356890</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>