<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10525] Stacked recovery requests do no cancel an in progress recovery first.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10525</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/update/DefaultSolrCoreState.java#L300-L310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/update/DefaultSolrCoreState.java#L300-L310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Two issues with this code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;          &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; locked = recoveryLock.tryLock();
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!locked) {
              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (recoveryWaiting.get() &amp;gt; 0) { &lt;span class=&quot;code-comment&quot;&gt;// line 1
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
              }
              recoveryWaiting.incrementAndGet(); &lt;span class=&quot;code-comment&quot;&gt;// line 2
&lt;/span&gt;            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
              recoveryWaiting.incrementAndGet();
              cancelRecovery(); &lt;span class=&quot;code-comment&quot;&gt;// line 3
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;tt&gt;cancelRecovery&lt;/tt&gt; on line 3 call will only hit when there are no recoveries to actually cancel (since we got the lock that means there are no recoveries in progress). Instead it should be moved either to the either branch of the if, or outside after the if since we know we will be running a recovery at that point.&lt;/p&gt;

&lt;p&gt;This code doesn&apos;t always prevent multiple requests from stacking. If there is a recovery running, but no recoveries currently waiting, multiple requests can check the count at line 1 before any of them will increment the count at line 2 and thus all of them will hit the increment.&lt;/p&gt;

&lt;p&gt;I don&apos;t have specific tests for this, but it&apos;s causing failures for me on my &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9555&quot; title=&quot;Leader incorrectly publishes state for replica when it puts replica into LIR.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9555&quot;&gt;&lt;del&gt;SOLR-9555&lt;/del&gt;&lt;/a&gt; work in progress.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13065208">SOLR-10525</key>
            <summary>Stacked recovery requests do no cancel an in progress recovery first.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="caomanhdat">Cao Manh Dat</assignee>
                                    <reporter username="mdrob">Mike Drob</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Apr 2017 20:10:57 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:21 +0000</updated>
                            <resolved>Mon, 29 Jan 2018 09:01:14 +0000</resolved>
                                                    <fixVersion>7.3</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15975488" author="mdrob" created="Wed, 19 Apr 2017 20:48:30 +0000"  >&lt;p&gt;Patch for 7.0 fixed, probably good for 6.x also (in which case whoever commits should move the changes entry)&lt;/p&gt;</comment>
                            <comment id="15975493" author="markrmiller@gmail.com" created="Wed, 19 Apr 2017 20:49:53 +0000"  >&lt;p&gt;Good catch! We def want to fix that cancel. The fact that multiple can still stack is as designed though. The current design was simply to make stacking unlikely vs the old guaranteed - but that is why we have a counter rather than a boolean.&lt;/p&gt;</comment>
                            <comment id="15975512" author="mdrob" created="Wed, 19 Apr 2017 20:59:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;The fact that multiple can still stack is as designed though&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;why? Looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8371&quot; title=&quot;Try and prevent too many recovery requests from stacking up and clean up some faulty logic.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8371&quot;&gt;&lt;del&gt;SOLR-8371&lt;/del&gt;&lt;/a&gt; I see &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; noticed the same thing which went unanswered, and we also filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8702&quot; title=&quot;Improve our strategy for preventing recovery requests from stacking up.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8702&quot;&gt;SOLR-8702&lt;/a&gt; that looks like the same issue of multiple requests stacking.&lt;/p&gt;</comment>
                            <comment id="15975566" author="markrmiller@gmail.com" created="Wed, 19 Apr 2017 21:33:32 +0000"  >&lt;p&gt;Don&apos;t know if I answered Shalin&apos;s comment, but I&apos;ve answered others about it. I&apos;m sure that is part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8702&quot; title=&quot;Improve our strategy for preventing recovery requests from stacking up.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8702&quot;&gt;SOLR-8702&lt;/a&gt; being filed, but seems no one has worked on it. The current strategy was easy to get to from where we were, and still very fast.&lt;/p&gt;</comment>
                            <comment id="15975573" author="markrmiller@gmail.com" created="Wed, 19 Apr 2017 21:36:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;looks like the same issue of multiple requests stacking.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The reason for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8702&quot; title=&quot;Improve our strategy for preventing recovery requests from stacking up.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8702&quot;&gt;SOLR-8702&lt;/a&gt; by the way is to examine no stacking at all. The issue that reduced stacking was titled more like &quot;reduce stacking&quot; not eliminate it. To eliminate it, we would want a patch and to examine if the change is worth any slow down in recovery calls we might have. Right now we can get hammered by recovery calls and they should all be very, very fast and result in few or no stack ups. Previously you stacked up every request.&lt;/p&gt;

&lt;p&gt;In other words, if you eliminate stacking completely, is a recovery request going to cost more than a tryLock and atomic integer increment. Cause in the a concurrent env, that is super fast.&lt;/p&gt;</comment>
                            <comment id="15975585" author="markrmiller@gmail.com" created="Wed, 19 Apr 2017 21:44:01 +0000"  >&lt;p&gt;Of course its complicated though. With the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9555&quot; title=&quot;Leader incorrectly publishes state for replica when it puts replica into LIR.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9555&quot;&gt;&lt;del&gt;SOLR-9555&lt;/del&gt;&lt;/a&gt;, we may finally be eliminating the main way we can get pounded with recovery requests (in a similar progress not perfection improvement, we have reduced how much pounding happens in the past).&lt;/p&gt;</comment>
                            <comment id="15975807" author="mdrob" created="Thu, 20 Apr 2017 00:29:52 +0000"  >&lt;p&gt;It occurs to me that with this change if there is a steady stream of recovery requests then each one will start up and get cancelled. I don&apos;t have a good grasp on how heavy the start cost here is, it looks like mostly checking the update log in RecoveryStrategy.&lt;/p&gt;

&lt;p&gt;The previous behaviour would be to run a full recovery and then run another full recovery. If failures were still happening at that point, then we could queue up another recovery. So we&apos;re not impacting availability when the root cause hasn&apos;t been fixed.&lt;/p&gt;

&lt;p&gt;It does get better if the root cause is more temporal, since the final recovery can start as soon as the problem is fixed, instead of waiting for another recovery to finish.&lt;/p&gt;

&lt;p&gt;I think I&apos;ve convinced myself to not worry about the churn, but would like a second opinion.&lt;/p&gt;</comment>
                            <comment id="15976934" author="mdrob" created="Thu, 20 Apr 2017 15:49:37 +0000"  >&lt;p&gt;New patch attached that keeps the recoveryWaiting counter.&lt;/p&gt;</comment>
                            <comment id="15980716" author="markrmiller@gmail.com" created="Mon, 24 Apr 2017 04:26:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think I&apos;ve convinced myself to not worry about the churn, but would like a second opinion.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, I do think it&apos;s a problem at a high level. I&apos;m actually hoping we get the other issue so that it won&apos;t hit ZK for every failed update. That is part of the problem now and why I tried to make this so concurrent. Right now, tons of update failures coming in ends up generating tons of recovery http requests from the leader to the replica, and I guess with LIR, a ZK contact. Rather than just hitting ZK the same way in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9555&quot; title=&quot;Leader incorrectly publishes state for replica when it puts replica into LIR.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9555&quot;&gt;&lt;del&gt;SOLR-9555&lt;/del&gt;&lt;/a&gt; though, it would be nice to have something that would hit ZK at most n times per second or something. An update fail means, some point later than now, but very soonish, trigger a recovery. We shouldn&apos;t have to do this per update and in fact we really don&apos;t want to anymore.&lt;/p&gt;

&lt;p&gt;With that issue fixed, ensuring no recovery stack up no longer really has to worry about such high concurrency.&lt;/p&gt;</comment>
                            <comment id="16343100" author="caomanhdat" created="Mon, 29 Jan 2018 09:01:14 +0000"  >&lt;p&gt;Committed by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11702&quot; title=&quot;Redesign current LIR implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11702&quot;&gt;&lt;del&gt;SOLR-11702&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16343203" author="jira-bot" created="Mon, 29 Jan 2018 10:47:37 +0000"  >&lt;p&gt;Commit f7a75dcc1a2935deda9e4dd4068e141b4b79b820 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f7a75dc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f7a75dc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10525&quot; title=&quot;Stacked recovery requests do no cancel an in progress recovery first.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10525&quot;&gt;&lt;del&gt;SOLR-10525&lt;/del&gt;&lt;/a&gt;: Updates CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="16343204" author="jira-bot" created="Mon, 29 Jan 2018 10:48:22 +0000"  >&lt;p&gt;Commit ec2198126fde3638064617d83a077717189d514c in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ec21981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ec21981&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10525&quot; title=&quot;Stacked recovery requests do no cancel an in progress recovery first.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10525&quot;&gt;&lt;del&gt;SOLR-10525&lt;/del&gt;&lt;/a&gt;: Updates CHANGES.txt&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12919021">SOLR-8371</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13007388">SOLR-9555</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12864290" name="SOLR-10525.patch" size="1882" author="mdrob" created="Thu, 20 Apr 2017 15:49:37 +0000"/>
                            <attachment id="12864077" name="SOLR-10525.patch" size="4394" author="mdrob" created="Wed, 19 Apr 2017 20:48:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dtxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>