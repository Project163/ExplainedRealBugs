<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:39:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5150] HdfsIndexInput may not fully read requested bytes.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5150</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Patrick Hunt noticed that our HdfsDirectory code was a bit behind Blur here - the read call we are using may not read all of the requested bytes - it returns the number of bytes actually written - which we ignore.&lt;/p&gt;

&lt;p&gt;Blur moved to using a seek and then readFully call - synchronizing across the two calls to deal with clones.&lt;/p&gt;

&lt;p&gt;We have seen that really kills performance, and using the readFully call that lets you pass the position rather than first doing a seek, performs much better and does not require the synchronization.&lt;/p&gt;

&lt;p&gt;I also noticed that the seekInternal impl should not seek but be a no op since we are seeking on the read.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12663652">SOLR-5150</key>
            <summary>HdfsIndexInput may not fully read requested bytes.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Aug 2013 13:23:33 +0000</created>
                <updated>Mon, 9 May 2016 18:55:10 +0000</updated>
                            <resolved>Mon, 16 Sep 2013 15:20:37 +0000</resolved>
                                    <version>4.4</version>
                                    <fixVersion>4.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13739664" author="thetaphi" created="Wed, 14 Aug 2013 13:33:09 +0000"  >&lt;p&gt;Nice catch! As there is a positioned readFully we can handle that in a good way without loosing performance. Otherwise I would have suggested to use an approach like done in NIOFSDir (we using chunking + a while (remaining) loop and update the position pointer).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I also noticed that the seekInternal impl should not seek but be a no-op since we are seeking on the read.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right! I dont know why seekInternal in the BufferedIndexInput is still there. IMHO, it should be removed from the base class, as it is no longer used anywhere (at least it should default to an empty method). No IndexInput in Lucene is implementing it anymore, because with positional reads it is not applicable and in the case of separate seek/read, the seek and read must be synchronized because of clones (unless every IndexInput has a separate file descriptor).&lt;/p&gt;</comment>
                            <comment id="13742432" author="markrmiller@gmail.com" created="Fri, 16 Aug 2013 17:37:16 +0000"  >&lt;p&gt;I&apos;ve held off on committing this because some performance tests indicate the upstream blur patch may have been more performant for merging/flushing while the current patch is &lt;b&gt;much&lt;/b&gt; more performant for queries.&lt;/p&gt;

&lt;p&gt;We might be able to use one or the other based on the IOContext.&lt;/p&gt;

&lt;p&gt;I&apos;m waiting until I can get some more results and testing done though - I&apos;ve seen lots of random deadlock situations in some of my testing with the upstream blur fix (synchronization around two calls).&lt;/p&gt;</comment>
                            <comment id="13742433" author="markrmiller@gmail.com" created="Fri, 16 Aug 2013 17:37:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt; was on vacation, but is now back and may have some thoughts on this issue as well.&lt;/p&gt;</comment>
                            <comment id="13742441" author="markrmiller@gmail.com" created="Fri, 16 Aug 2013 17:44:58 +0000"  >&lt;p&gt;To describe that more fully: not deadlock - just really long pauses - no cpu or harddrive usage by either hdfs processes or solr for a &lt;b&gt;long&lt;/b&gt; time - threads hanging out in socket waits of some kind it seemed.&lt;/p&gt;

&lt;p&gt;That is how I first saw the slowdown with the blur fix - I was running one of the HdfsDirectory tests on my mac and it took 10 min instead of 14 seconds. On linux, the test was still fast. Some other perf tests around querying took a nose dive on linux as well though. Meanwhile, some tests involving indexing sped up.&lt;/p&gt;

&lt;p&gt;The current patch sped that test back up on my mac and fixed the query perf test.&lt;/p&gt;

&lt;p&gt;We might be able to get the best of both worlds, or the synchronized version might not be worth it.&lt;/p&gt;</comment>
                            <comment id="13742465" author="thetaphi" created="Fri, 16 Aug 2013 17:59:30 +0000"  >&lt;p&gt;Hi Mark,&lt;br/&gt;
I think your version should be preferred in both cases. The Apache Blur upstream version looks like SimpleFSIndexInput (which has synchronization on the RandomAccessFile). The difference is here, that reading from a real file has no network involved (at least not for local filesystems) so the time spent in the locked code block is shorter. Still SimpleFSDir is bad for queries.&lt;br/&gt;
When merging the whole stuff works single-threaded per file so you would see no difference in both approaches. If the positional readFully approach would be slower, then this would be clearly a bug in Hdfs.&lt;br/&gt;
Another alternative would be: When cloning a file also clone the underlying Hdfs connection. With RandomAccessFile we cannot do this in the JDK (we have no dup() for file descriptors), but if Hdfs supports some dup() like approach with delete on-last close semantics (the file could already be deleted when you dup the file descriptor) you could create 2 different connection for each thread.&lt;br/&gt;
The backside: Lucene never closes clones - one reason why I gave up on implementig a Windows-Optimized directory that would clone underlying file descriptor: The clone would never close the dup &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13742831" author="markrmiller@gmail.com" created="Sat, 17 Aug 2013 04:02:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;If the positional readFully approach would be slower, then this would be clearly a bug in Hdfs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right - if that turns out to be the case, I&apos;d raise an issue with the hdfs team. The performance difference actually looks fairly large on first glance though, so it might be worth working around for a while if possible. I don&apos;t really know yet.&lt;/p&gt;
</comment>
                            <comment id="13743168" author="phunt" created="Sun, 18 Aug 2013 07:02:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, thanks for filing this while I was out. I was trying to track down another issue and happened across it while reviewing code (then noticed that blur had changed from the original).&lt;/p&gt;

&lt;p&gt;I realized the seekInternal change while on vacation, was going to mention that but it looks like you fixed it already. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I reviewed the HDFS client code for readInternal with a member of our HDFS team before generating the original patch. Based on the feedback I got the understood was that doing the seek followed by the readFully should have been highest performance. It&apos;s interesting that the query performance was so negatively impacted. We should followup with those folks again, perhaps you could provide more insight (than I) into how lucene accesses the underlying filesystem for query based reads vs other access patterns? Might help get more insight from the HDFS devs. Perhaps there is some way to trace those accesses...&lt;/p&gt;

&lt;p&gt;We have not yet tried &quot;short circuit local HDFS client reads&quot; (see 12.11.2 here &lt;a href=&quot;http://hbase.apache.org/book/perf.hdfs.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hbase.apache.org/book/perf.hdfs.html&lt;/a&gt;) but we should at some point (soon) and that will further complicate things. Based on the results other clients have seen we should see significant performance benefits from that (at least when the blocks are indeed local).&lt;/p&gt;</comment>
                            <comment id="13743215" author="amccurry" created="Sun, 18 Aug 2013 14:12:45 +0000"  >&lt;p&gt;First off I&apos;m really happy to see other people trying to improve performance of the HDFSDirectory.  So I will offer some reasons as to why I have landed on the current implementation in Blur.&lt;/p&gt;

&lt;p&gt;Why Blur doesn&apos;t clone the HDFS file handle for clone in Lucene.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Mainly because since Lucene 4 cloned file handles don&apos;t seem to get closed all the time.  So I didn&apos;t want to have all those objects hanging around for long periods of time and not being closed.  Related: Also for those that are interested, Blur has Directory reference counter so that files that are deleted by Lucene stick around long enough for running queries to finish.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Why Blur doesn&apos;t use the read&lt;span class=&quot;error&quot;&gt;&amp;#91;Fully&amp;#93;&lt;/span&gt;(position,buf,off,len) method instead of the seek plus read&lt;span class=&quot;error&quot;&gt;&amp;#91;Fully&amp;#93;&lt;/span&gt;(buf,off,len).&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When accessing the local file system with the call would take a huge amount of time because of some internal setup the Hadoop was doing for every call.  This didn&apos;t seem to be an issue when using HDFS, but if you start using short-circuit reads it might become a problem.  I have not tested this for 6 months, so this may have been improved in the newer versions of Hadoop.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Why Blur uses readFully versus read.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Laziness?  Not sure, I&apos;m sure that I thought that a single call to seek + read from the filesystem would be better (even if it was more operations) than multiple calls with multiple seeks + reads.  Perhaps though it would be better to not use the readFully as you all are discussing because of the sync call.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;How would I really like to implement it?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I would like to implement the file access system as a pool of file handles for each file.  So that each file would have up to N (configured by default to 10 or something like that) file handles open and all the accesses from the base file objects and clones would check out the handle and release it when finished.  So that way there is some limit to the number of handles but some parallel accesses are allowed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Hope this helps to explain why Blur has the implementation that is does.&lt;/p&gt;

&lt;p&gt;Aaron&lt;/p&gt;</comment>
                            <comment id="13743289" author="markrmiller@gmail.com" created="Sun, 18 Aug 2013 17:13:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Based on the feedback I got the understood was that doing the seek followed by the readFully should have been highest performance.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would go along with speed improvements we saw in indexing. As Uwe said, that does seem kind of weird or buggish, but the numbers seem to bear it out.&lt;/p&gt;

&lt;p&gt;I think the issue is, in the indexing case, it&apos;s one thread dong the reading - and our perf tests do show it to be faster quite a bit faster. But the sync simply &lt;b&gt;kills&lt;/b&gt; concurrent query reads. We see qps drop from like 38 qps to 3 qps. Totally unacceptable performance.&lt;/p&gt;

&lt;p&gt;This is why I&apos;ve been looking at doing the synched seek + read or just the read based on the IO context.&lt;/p&gt;</comment>
                            <comment id="13743306" author="amccurry" created="Sun, 18 Aug 2013 17:54:46 +0000"  >&lt;p&gt;Just as a FYI the IOContext won&apos;t give the expected behavior, because if the writer already has a index input open for searching it won&apos;t reopen the file.  If my memory is correct it will just clone the existing index input that was open with a IOContext of Default (or whatever it uses for searching).  So if you are doing NRT updates you may never see a IOContext of merge in the directory implementation.  I know this was true in 4.2ish but I haven&apos;t reviewed the code for this situation lately.&lt;/p&gt;

&lt;p&gt;Aaron&lt;/p&gt;</comment>
                            <comment id="13743319" author="markrmiller@gmail.com" created="Sun, 18 Aug 2013 18:20:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikemccand&quot; class=&quot;user-hover&quot; rel=&quot;mikemccand&quot;&gt;mikemccand&lt;/a&gt;, do you have any insight into the above comment?&lt;/p&gt;</comment>
                            <comment id="13743347" author="mikemccand" created="Sun, 18 Aug 2013 20:00:05 +0000"  >&lt;p&gt;That&apos;s correct: if IndexWriter already has a SegmentReader open on that segment because it&apos;s pooling readers, in turn because an NRT reader was pulled, then if that segment is merged it will re-use that already opened SegmentReader rather than open a new one.&lt;/p&gt;</comment>
                            <comment id="13743814" author="markrmiller@gmail.com" created="Mon, 19 Aug 2013 13:38:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;But the sync simply kills concurrent query reads. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, I was not being very careful with my words. The &apos;sync&apos; option (with the seek + read) kills concurrent query reads - but I don&apos;t think it&apos;s the sync at all. The first perf tests I looked at with just a readFully had a sync as well - which seems to make sense because this is not an NRT test or anything. Everything seems to be related to the hdfs calls.&lt;/p&gt;</comment>
                            <comment id="13768381" author="markrmiller@gmail.com" created="Mon, 16 Sep 2013 14:56:56 +0000"  >&lt;p&gt;I&apos;m just going to commit the current fix and worry about any performance improvements in another issue.&lt;/p&gt;</comment>
                            <comment id="13768387" author="jira-bot" created="Mon, 16 Sep 2013 15:06:29 +0000"  >&lt;p&gt;Commit 1523693 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1523693&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1523693&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5150&quot; title=&quot;HdfsIndexInput may not fully read requested bytes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5150&quot;&gt;&lt;del&gt;SOLR-5150&lt;/del&gt;&lt;/a&gt;: HdfsIndexInput may not fully read requested bytes.&lt;/p&gt;</comment>
                            <comment id="13768393" author="jira-bot" created="Mon, 16 Sep 2013 15:11:32 +0000"  >&lt;p&gt;Commit 1523694 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1523694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1523694&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5150&quot; title=&quot;HdfsIndexInput may not fully read requested bytes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5150&quot;&gt;&lt;del&gt;SOLR-5150&lt;/del&gt;&lt;/a&gt;: HdfsIndexInput may not fully read requested bytes.&lt;/p&gt;</comment>
                            <comment id="13768400" author="jira-bot" created="Mon, 16 Sep 2013 15:17:51 +0000"  >&lt;p&gt;Commit 1523698 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_5&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1523698&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1523698&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5150&quot; title=&quot;HdfsIndexInput may not fully read requested bytes.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5150&quot;&gt;&lt;del&gt;SOLR-5150&lt;/del&gt;&lt;/a&gt;: HdfsIndexInput may not fully read requested bytes.&lt;/p&gt;</comment>
                            <comment id="13787110" author="jpountz" created="Sat, 5 Oct 2013 10:19:16 +0000"  >&lt;p&gt;4.5 release -&amp;gt; bulk close&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12597970" name="SOLR-5150.patch" size="2029" author="markrmiller@gmail.com" created="Wed, 14 Aug 2013 13:24:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343653</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n9j3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343957</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>