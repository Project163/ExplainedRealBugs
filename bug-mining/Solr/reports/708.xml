<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:23:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2762] FSTLookup returns one less suggestion than it should when onlyMorePopular=true</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2762</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I&apos;m using the Suggester.  When I switched from TSTLookup to FSTLookup, I noticed that it returned one fewer suggestion than what I asked for. I have spellcheck.onlyMorePopular=true; when I set it to false, I see the correct count. Another aspect of the bug is that this off-by-one bug only seems to occur when my suggestion has an exact match.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12523001">SOLR-2762</key>
            <summary>FSTLookup returns one less suggestion than it should when onlyMorePopular=true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dweiss">Dawid Weiss</assignee>
                                    <reporter username="dsmiley">David Smiley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Sep 2011 05:54:04 +0000</created>
                <updated>Sun, 27 Nov 2011 12:36:07 +0000</updated>
                            <resolved>Sat, 17 Sep 2011 16:27:16 +0000</resolved>
                                    <version>3.3</version>
                    <version>3.4</version>
                                    <fixVersion>3.5</fixVersion>
                                    <component>spellchecker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13104313" author="dweiss" created="Wed, 14 Sep 2011 07:01:55 +0000"  >&lt;p&gt;David, can you add a test case for this? I&apos;ll be happy to fix it, probably something trivial, but a failing test case would be a great start.&lt;/p&gt;</comment>
                            <comment id="13104503" author="dsmiley" created="Wed, 14 Sep 2011 13:48:20 +0000"  >&lt;p&gt;Maybe some day; sorry. I&apos;m trying to push out the 2nd edition of my Solr book and I ran into this when kicking the tires on the Suggester. I thought it best to at least report the problem instead of do nothing.&lt;/p&gt;</comment>
                            <comment id="13104582" author="mikemccand" created="Wed, 14 Sep 2011 15:43:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;I thought it best to at least report the problem instead of do nothing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13104708" author="dweiss" created="Wed, 14 Sep 2011 17:38:36 +0000"  >&lt;p&gt;Ok, I&apos;ll try to reproduce on my own, thanks.&lt;/p&gt;</comment>
                            <comment id="13105289" author="dweiss" created="Thu, 15 Sep 2011 11:55:50 +0000"  >&lt;p&gt;I&apos;ve been looking at this code for a longer while but I don&apos;t see how it can be off-by-one... Can you send me the snippet of code/ data you used while testing this?&lt;/p&gt;</comment>
                            <comment id="13105291" author="dweiss" created="Thu, 15 Sep 2011 12:12:33 +0000"  >&lt;p&gt;The relevant snippet for the scenario you described (exactMatchFirst, onlyMorePopular, input match is exactly represented in the suggestions list) is here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (collect(res, num, weight, output, arc) &amp;amp;&amp;amp; greedy) {
          &lt;span class=&quot;code-comment&quot;&gt;// We have enough suggestions to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; immediately. Keep on looking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// exact match, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; requested.
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exactMatchFirst) {
            &lt;span class=&quot;code-object&quot;&gt;Float&lt;/span&gt; exactMatchWeight = getExactMatchStartingFromRootArc(i, key);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exactMatchWeight != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
              res.add(0, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LookupResult(key, exactMatchWeight));
              &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (res.size() &amp;gt; num) {
                res.remove(res.size() - 1);
              }
            }
          }
          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the only place where elements are removed from the suggestion list is in the while loop... but the condition is correct so I&apos;ve no idea.&lt;/p&gt;</comment>
                            <comment id="13105406" author="dsmiley" created="Thu, 15 Sep 2011 14:57:41 +0000"  >&lt;p&gt;I will try and debug this tonight or within a few days against my data and point out what the problem is.&lt;/p&gt;</comment>
                            <comment id="13105409" author="dweiss" created="Thu, 15 Sep 2011 15:00:28 +0000"  >&lt;p&gt;Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="13105869" author="dsmiley" created="Fri, 16 Sep 2011 05:40:06 +0000"  >&lt;p&gt;The bug is that the &quot;if (exactMatchFirst) {&quot; condition fails to consider the fact that an exact match is already in the results. As I was fooling around with my data, it was usually already there.&lt;/p&gt;

&lt;p&gt;I added code to check to see if the key is already present and if so to shift it to the top. I also made a trivial change to the existing code you wrote that was in this condition that changed the order of shrinking the result array before inserting a new LookupResult into the first position. This will avoid ArrayList needlessly growing its array.  As an aside, it&apos;s not clear to me why you did a min(10,num) when initializing the ArrayList capacity.&lt;/p&gt;

&lt;p&gt;I have to admit that this code seems overall tricky to test due to all the branch conditions.  And this method probably has a high cyclomatic complexity. It would be nice to move the &quot;if (exactMatchFirst) {&quot; branch outside the loops. At a glance it seems doable but then I noticed getExactMatchStartingFromRootArc(i,key) took the loop index &apos;i&apos; and I&apos;m not sure what the implications are there.&lt;/p&gt;</comment>
                            <comment id="13105887" author="dweiss" created="Fri, 16 Sep 2011 06:18:20 +0000"  >&lt;p&gt;I will review it later today. The code is based on several assumptions to speed things up (for example it assumes the fst yields sorted output). I will try to write a failing test case first. &lt;/p&gt;

&lt;p&gt;@cyclomatic complexity: the conditions inside loops are meant to early-interrupt the search. That&apos;s where the gain is and it&apos;ll be hard to get rid of in a clean way.&lt;/p&gt;

&lt;p&gt;@min(10, num): I typically try to avoid overallocating buffers; if somebody requests &amp;gt; 10 matches (unlikely?) then we will gracefully expand the buffers as we go. Also: the point of doing this is so that somebody could request &lt;em&gt;all&lt;/em&gt; matches by passing Integer.MAX_VALUE which would otherwise cause an OOM.&lt;/p&gt;</comment>
                            <comment id="13105891" author="dsmiley" created="Fri, 16 Sep 2011 06:25:14 +0000"  >&lt;p&gt;Here is a trivial update to my patch. I forgot to add a &quot;break&quot;. Without the break the code worked but needlessly checked for alreadyFoundIt after it was already true.&lt;/p&gt;</comment>
                            <comment id="13105901" author="dweiss" created="Fri, 16 Sep 2011 06:34:50 +0000"  >&lt;p&gt;The patch is fine and I think I now know the circumstances in which the off by one could happen (or more specifically: when the exact match could be on the list at the point of getting to that snippet). I&apos;ll try to write a failing test case and then apply your patch.&lt;/p&gt;</comment>
                            <comment id="13105910" author="dweiss" created="Fri, 16 Sep 2011 06:55:03 +0000"  >&lt;p&gt;I realize when this could happen, indeed &amp;#8211; trivial. Thanks David.&lt;/p&gt;</comment>
                            <comment id="13105914" author="dweiss" created="Fri, 16 Sep 2011 07:07:48 +0000"  >&lt;p&gt;This is my take at fixing this issue. Took David&apos;s suggestion about complexity into account and moved the checks into a separate method. A previously failing test case added and passing. David, feel free to check now, should be fine. I plan to commit in a few hours.&lt;/p&gt;</comment>
                            <comment id="13105937" author="dsmiley" created="Fri, 16 Sep 2011 08:06:38 +0000"  >&lt;p&gt;Please don&apos;t commit in only a few hours.  That is too soon for something being put together now and it&apos;s 4am in my time zone &amp;#8211; I haven&apos;t gone to bed yet.&lt;/p&gt;

&lt;p&gt;I looked at your patch. Your code will only swap the existing match with the first entry, but doesn&apos;t that hurt any existing ordering?  My code shifted them down to preserve ordering.  Hey by the way, you did your own swap code when the JDK already has Collections.swap().&lt;/p&gt;</comment>
                            <comment id="13105958" author="dweiss" created="Fri, 16 Sep 2011 09:15:02 +0000"  >&lt;p&gt;4am, you say? You should watch this one: &lt;a href=&quot;http://www.ted.com/talks/rives_on_4_a_m.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ted.com/talks/rives_on_4_a_m.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, I didn&apos;t commit mostly because I&apos;m in and out of office today too. You&apos;re right about the ordering &amp;#8211; it will change with the swap() that I used. I&apos;m thinking it&apos;ll be easier code-wise to shift by removing and then re-adding the matching element. I&apos;ll prepare a patch, won&apos;t commit.&lt;/p&gt;</comment>
                            <comment id="13105962" author="dweiss" created="Fri, 16 Sep 2011 09:36:08 +0000"  >&lt;p&gt;Corrected swap() (preserve score order if pushing exact match to the front).&lt;/p&gt;</comment>
                            <comment id="13106088" author="dsmiley" created="Fri, 16 Sep 2011 14:19:37 +0000"  >&lt;p&gt;That TED 4am video was entertaining but weird. Normally I think of TED video as educational / inspiring but that was a bit random.&lt;/p&gt;

&lt;p&gt;I like your rename of &quot;greedy&quot; to &quot;collectAll&quot;.&lt;/p&gt;

&lt;p&gt;The code is definitely easier to read with a remove and then an add, even if it internally does more work than my loop did.  I actually considered that approach but I know how performance-contious the developers here are so I didn&apos;t do that.  I hoped ArrayList had some sort of shift method but it doesn&apos;t. &lt;/p&gt;

&lt;p&gt;By the way, you forgot to copy the code improvement I put in my patch to your existing logic that I told you about.  At your comment: &quot;// Insert as the first result and truncate at num.&quot;, you did an add then a remove, when you should do a remove then an add in order to avoid potentially needlessly expanding ArrayList&apos;s internal array.&lt;/p&gt;</comment>
                            <comment id="13106522" author="dweiss" created="Fri, 16 Sep 2011 15:26:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;That TED 4am video was entertaining but weird. Normally I think of TED video as educational / inspiring but that was a bit random.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s &quot;Technology Entertainment and Design&quot;, there&apos;s actually plenty of pure entertainers there (musicians, comedians). That 4am was quite funny to me, so I couldn&apos;t resist.&lt;/p&gt;

&lt;p&gt;I will update to remove before insert, thanks. I didn&apos;t think of that. All your other remarks hold, but they&apos;re super-minor improvements compared to iterating over the fsa or sorting scores (which we will need to do to make the bucketing proportional), so I&apos;d sacrifice them for code clarity this time.&lt;/p&gt;</comment>
                            <comment id="13106699" author="dweiss" created="Fri, 16 Sep 2011 18:54:26 +0000"  >&lt;p&gt;Hope I didn&apos;t screw up anything. Commit please, I&apos;m done for the day &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13107029" author="dsmiley" created="Sat, 17 Sep 2011 05:20:24 +0000"  >&lt;p&gt;The patch looks good to me, Dawid. You tease me with asking me to commit it; I can&apos;t :-/&lt;/p&gt;</comment>
                            <comment id="13107050" author="dweiss" created="Sat, 17 Sep 2011 06:44:44 +0000"  >&lt;p&gt;Ugh... David, you&apos;re a machine (5:20am). No, I wasn&apos;t teasing, I was really done for the day yesterday. I will commit today, thanks for your help again!&lt;/p&gt;</comment>
                            <comment id="13157860" author="thetaphi" created="Sun, 27 Nov 2011 12:36:07 +0000"  >&lt;p&gt;Bulk close after 3.5 is released&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12523000">SOLR-2761</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12494847" name="SOLR-2762.patch" size="6439" author="dweiss" created="Fri, 16 Sep 2011 18:54:26 +0000"/>
                            <attachment id="12494774" name="SOLR-2762.patch" size="6438" author="dweiss" created="Fri, 16 Sep 2011 09:36:08 +0000"/>
                            <attachment id="12494764" name="SOLR-2762.patch" size="4059" author="dweiss" created="Fri, 16 Sep 2011 07:07:48 +0000"/>
                            <attachment id="12494759" name="SOLR-2762_FSTLookup_off_by_one.patch" size="2012" author="dsmiley" created="Fri, 16 Sep 2011 06:25:14 +0000"/>
                            <attachment id="12494754" name="SOLR-2762_FSTLookup_off_by_one.patch" size="1988" author="dsmiley" created="Fri, 16 Sep 2011 05:40:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3093</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03iqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18468</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>