<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:07:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16983] ObjectReleaseTracker completely useless in all SolrTestCaseJ4 based tests - masking unclosed InputStream in some SolrStream usecases</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16983</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;NOTE: This was masking a real bug in SolrStream&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Fixing tests that fialed while working on this bug lead me to discover that some usages of &lt;tt&gt;SolrStream&lt;/tt&gt; weren&apos;t closing their &lt;tt&gt;TupleStreamParser&lt;/tt&gt; which could result in unclosed &lt;tt&gt;InputStream&lt;/tt&gt; (returned from the underlying HTTP client)&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;SolrTestCase&lt;/tt&gt; has a &lt;tt&gt;@ClassRule&lt;/tt&gt; named &lt;tt&gt;solrClassRules&lt;/tt&gt; which calls &lt;tt&gt;ObjectReleaseTracker.clearObjectTrackerAndCheckEmpty()&lt;/tt&gt; in it&apos;s &lt;tt&gt;afterIfSuccessful()&lt;/tt&gt; method to ensure that any objects which use &lt;tt&gt;ObjectReleaseTracker&lt;/tt&gt; are correctly released (ie: closed)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;b&gt;...BUT...&lt;/b&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;SolrTestCaseJ4&lt;/tt&gt; has an &lt;tt&gt;@AfterClass&lt;/tt&gt; method named &lt;tt&gt;teardownTestCases()&lt;/tt&gt; which calls &lt;tt&gt;ObjectReleaseTracker.clear()&lt;/tt&gt; &lt;em&gt;before&lt;/em&gt; the &lt;tt&gt;afterIfSuccessful()&lt;/tt&gt; method of it&apos;s parent class&apos;s &lt;tt&gt;solrClassRules&lt;/tt&gt; gets to run.&lt;/p&gt;

&lt;p&gt;... Which means that &lt;tt&gt;ObjectReleaseTracker&lt;/tt&gt; is completley useless in every test that descends from &lt;tt&gt;SolrTestCaseJ4&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13550899">SOLR-16983</key>
            <summary>ObjectReleaseTracker completely useless in all SolrTestCaseJ4 based tests - masking unclosed InputStream in some SolrStream usecases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Sep 2023 23:07:15 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:15 +0000</updated>
                            <resolved>Thu, 21 Sep 2023 22:55:06 +0000</resolved>
                                                    <fixVersion>9.4</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17765874" author="hossman" created="Fri, 15 Sep 2023 23:09:37 +0000"  >&lt;p&gt;I&apos;m attaching a rough nocommit patch that demonstrates the problem: &lt;tt&gt;BasicFunctionalityTest.testObjectTrackerSanityCheck&lt;/tt&gt; should clearly fail...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testObjectTrackerSanityCheck() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception { &lt;span class=&quot;code-comment&quot;&gt;// nocommit
&lt;/span&gt;    assertTrue(org.apache.solr.common.util.ObjectReleaseTracker.track(&lt;span class=&quot;code-quote&quot;&gt;&quot;nocommit:tracked-object-never-released&quot;&lt;/span&gt;));
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...but it in fact passes, and the &lt;tt&gt;System.err.println&lt;/tt&gt; calls in the patch make it clear why...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hossman@slate:~/lucene/solr [j11] [*main] $ ./gradlew test --max-workers=1 --tests BasicFunctionalityTest.testObjectTrackerSanityCheck -Ptests.verbose=true
...
  2&amp;gt; nocommit: STCJ4.AfterClass
  2&amp;gt; nocommit: ORT.clear
  2&amp;gt; nocommit: STC.rule.afterIfSuccessful
  2&amp;gt; nocommit: ORT.checkEmpty
  2&amp;gt; nocommit: ORT.clear
...
  2&amp;gt; NOTE: All tests run in this JVM: [BasicFunctionalityTest]
:solr:core:test (SUCCESS): 1 test(s)
The slowest suites (exceeding 1s) during this run:
   3.26s BasicFunctionalityTest (:solr:core)

BUILD SUCCESSFUL in 18s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At a quick glance, I suspect this bug was introduced by changes made in &lt;tt&gt;commit 21bc46c43c94cc90589cc536ffc7518908e64240&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16573&quot; title=&quot;SolrClientTestRule for EmbeddedSolrServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16573&quot;&gt;&lt;del&gt;SOLR-16573&lt;/del&gt;&lt;/a&gt;) that affected when in the lifecycle of &lt;tt&gt;SolrTestCase&lt;/tt&gt; subclasses the &lt;tt&gt;ObjectReleaseTracker.clearObjectTrackerAndCheckEmpty()&lt;/tt&gt; check got called &#8211; But I haven&apos;t verified that. (It&apos;s possible the problem is much older).&lt;/p&gt;

&lt;p&gt;/ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;&#160; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshgogz&quot; class=&quot;user-hover&quot; rel=&quot;joshgogz&quot;&gt;joshgogz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17765875" author="hossman" created="Fri, 15 Sep 2023 23:15:34 +0000"  >&lt;p&gt;I believe the most straightforward fix is to simply remove the &lt;tt&gt;ObjectReleaseTracker.clear()&lt;/tt&gt; call from &lt;tt&gt;SolrTestCaseJ4&lt;/tt&gt; &#8211; that code probably should have been removed long long ago whenever the &quot;check&quot; logic got moved to the &lt;tt&gt;SolrTestCase&lt;/tt&gt; base class.&lt;/p&gt;

&lt;p&gt;But based on a quick check (w/o trying multiple seeds, or running nightly) fixing this test framework bug is going to cause at least ~17 test classes to start failing &#8211; tests that should have been failing for a long time, either because the test doesn&apos;t properly cleanup, or because the code being tested has an underlying object leak bug.&lt;/p&gt;

&lt;p&gt;I don&apos;t think i have the bandwidth or energy to try and fix all of these &#8211; so help would be appreciated from anyone that wants to help up and try to tackle this.&lt;/p&gt;</comment>
                            <comment id="17765884" author="hossman" created="Sat, 16 Sep 2023 00:40:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;But based on a quick check (w/o trying multiple seeds, or running nightly) fixing this test framework bug is going to cause at least ~17 test classes to start failing  ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Skimming these failures, some of them are probably legit leaks of &lt;tt&gt;SolrClient&lt;/tt&gt; instances in tests &amp;#8211; but the majority of them relate to &quot;leaked&quot; instances of &lt;tt&gt;org.eclipse.jetty.client.util.InputStreamResponseListener$Input&lt;/tt&gt; that seem like false positives because &lt;tt&gt;Http2SolrClient&lt;/tt&gt; calls &lt;tt&gt;ObjectReleaseTracker.track(...)&lt;/tt&gt; on instances of &lt;tt&gt;InputStream&lt;/tt&gt; returned by &lt;tt&gt;InputStreamResponseListener&lt;/tt&gt; but there are code paths where &lt;tt&gt;Http2SolrClient&lt;/tt&gt; explicitly doesn&apos;t close/release an &lt;tt&gt;InputStream&lt;/tt&gt; because it returns it to the caller &amp;#8211; most of which don&apos;t seem to make any attempt to call &lt;tt&gt;ObjectReleaseTracker.release(...)&lt;/tt&gt; on them.&lt;/p&gt;

&lt;p&gt;Fixing this could either involve adding a crap ton of  &lt;tt&gt;ObjectReleaseTracker.release(inputStream)&lt;/tt&gt; calls all over the code base, or we could replace/subclass &lt;tt&gt;InputStreamResponseListener&lt;/tt&gt; w/our own impl that created &amp;amp; returned custom &lt;tt&gt;InputStream&lt;/tt&gt; wrappers that handle the &lt;tt&gt;ObjectReleaseTracker&lt;/tt&gt; tracking &amp;amp; releasing in it&apos;s own constructor and &lt;tt&gt;close()&lt;/tt&gt; method.&lt;/p&gt;</comment>
                            <comment id="17765908" author="hossman" created="Sat, 16 Sep 2023 05:00:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;but the majority of them relate to &quot;leaked&quot; instances of &lt;tt&gt;org.eclipse.jetty.client.util.InputStreamResponseListener$Input&lt;/tt&gt; that seem like false positives ...&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;Fixing this could either involve adding a crap ton of &lt;tt&gt;ObjectReleaseTracker.release(inputStream)&lt;/tt&gt; calls all over the code base, or we could replace/subclass &lt;tt&gt;InputStreamResponseListener&lt;/tt&gt; w/our own impl that created &amp;amp; returned custom &lt;tt&gt;InputStream&lt;/tt&gt; wrappers that handle the &lt;tt&gt;ObjectReleaseTracker&lt;/tt&gt; tracking &amp;amp; releasing in it&apos;s own constructor and &lt;tt&gt;close()&lt;/tt&gt; method.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I worked up the attached patch to do this, and discovered that most of these aren&apos;t acctually false positives &#8211; they are legit bugs, because even though the &lt;tt&gt;TupleStreamParser.close()&lt;/tt&gt; impl&apos;s call &lt;tt&gt;InputStream.close()&lt;/tt&gt; &amp;#8211; there isn&apos;t anything in &lt;tt&gt;SolrStream&lt;/tt&gt; that ever calls &lt;tt&gt;TupleStreamParser.close()&lt;/tt&gt; !&lt;/p&gt;

&lt;p&gt;So the patch fixes this ... but there are still lots of other remaining failures that seem to be related to leaked SolrClient/HttpClient instances...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR: The following test(s) have failed:
  - org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.classMethod (:solr:solrj-streaming)
    Test output: /home/hossman/lucene/solr/solr/solrj-streaming/build/test-results/test/outputs/OUTPUT-org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.txt
    Reproduce with: gradlew :solr:solrj-streaming:test --tests &quot;org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.classMethod (:solr:solrj-streaming)
    Test output: /home/hossman/lucene/solr/solr/solrj-streaming/build/test-results/test/outputs/OUTPUT-org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.txt
    Reproduce with: gradlew :solr:solrj-streaming:test --tests &quot;org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.classMethod (:solr:solrj-streaming)
    Test output: /home/hossman/lucene/solr/solr/solrj-streaming/build/test-results/test/outputs/OUTPUT-org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.txt
    Reproduce with: gradlew :solr:solrj-streaming:test --tests &quot;org.apache.solr.client.solrj.io.stream.CloudAuthStreamTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.client.solrj.impl.BasicHttpSolrClientTest.classMethod (:solr:solrj)
    Test output: /home/hossman/lucene/solr/solr/solrj/build/test-results/test/outputs/OUTPUT-org.apache.solr.client.solrj.impl.BasicHttpSolrClientTest.txt
    Reproduce with: gradlew :solr:solrj:test --tests &quot;org.apache.solr.client.solrj.impl.BasicHttpSolrClientTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.client.solrj.embedded.SolrExampleJettyTest.classMethod (:solr:solrj)
    Test output: /home/hossman/lucene/solr/solr/solrj/build/test-results/test/outputs/OUTPUT-org.apache.solr.client.solrj.embedded.SolrExampleJettyTest.txt
    Reproduce with: gradlew :solr:solrj:test --tests &quot;org.apache.solr.client.solrj.embedded.SolrExampleJettyTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.client.solrj.impl.Http2SolrClientTest.classMethod (:solr:solrj)
    Test output: /home/hossman/lucene/solr/solr/solrj/build/test-results/test/outputs/OUTPUT-org.apache.solr.client.solrj.impl.Http2SolrClientTest.txt
    Reproduce with: gradlew :solr:solrj:test --tests &quot;org.apache.solr.client.solrj.impl.Http2SolrClientTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.response.TestRawTransformer.classMethod (:solr:core)
    Test output: /home/hossman/lucene/solr/solr/core/build/test-results/test/outputs/OUTPUT-org.apache.solr.response.TestRawTransformer.txt
    Reproduce with: gradlew :solr:core:test --tests &quot;org.apache.solr.response.TestRawTransformer.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

  - org.apache.solr.metrics.SolrMetricsIntegrationTest.classMethod (:solr:core)
    Test output: /home/hossman/lucene/solr/solr/core/build/test-results/test/outputs/OUTPUT-org.apache.solr.metrics.SolrMetricsIntegrationTest.txt
    Reproduce with: gradlew :solr:core:test --tests &quot;org.apache.solr.metrics.SolrMetricsIntegrationTest.classMethod&quot; -Ptests.jvms=5 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=D4A9A04D095FAD9E -Ptests.file.encoding=UTF-8

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17766189" author="dsmiley" created="Mon, 18 Sep 2023 03:36:38 +0000"  >&lt;p&gt;Great find! &#160;I&apos;m glad to see you propose ORT be removed completely from STCJ4 because it&apos;s more logical to reason about it as having one location of existence &#8211; as a Rule in SolrTestCase.&lt;/p&gt;

&lt;p&gt;I wish we had a test that was checking that the O.R.T. was operational. &#160;Your proposal showed the problem but didn&apos;t appear to be something we could commit.&lt;/p&gt;</comment>
                            <comment id="17766939" author="hossman" created="Tue, 19 Sep 2023 23:14:26 +0000"  >&lt;p&gt;I&apos;ve updated the patch to fix a few more failures.&lt;/p&gt;

&lt;p&gt;In at least one of the remaining outstanding problems, the code is calling this method in&#160; &lt;tt&gt;SolrTestCaseJ4...&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;/** This method creates a HttpClient from a URL. */&lt;/span&gt;
&#160; @Deprecated &lt;span class=&quot;code-comment&quot;&gt;// We are migrating away from Apache HttpClient.
&lt;/span&gt;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; HttpClient getHttpClient(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; url) {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpSolrClient.Builder(url).build().getHttpClient();
&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...which is a disaster ... no clean way to close the &lt;tt&gt;HttpSolrClient&lt;/tt&gt; that gets leaked, and the no easy way to &quot;close&quot; the &lt;tt&gt;HttpClient&lt;/tt&gt; interface which is returned.&lt;/p&gt;

&lt;p&gt;not sure what to do about any of that.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;blockquote&gt;&lt;p&gt;&#160;I wish we had a test that was checking that the O.R.T. was operational. &#160;Your proposal showed the problem but didn&apos;t appear to be something we could commit.&lt;/p&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;
&lt;p&gt;We have a test tha ObjectReleaseTracker does what it says it will do, the problem is there&apos;s no way (i know of) to write a test that proves the test baseclasses (and their combinations of rules) will fail when expected)&lt;/p&gt;</comment>
                            <comment id="17766990" author="dsmiley" created="Wed, 20 Sep 2023 05:07:08 +0000"  >&lt;p&gt;Well getHttpClient is deprecated, so we could begin weening tests off of it. &#160;I&apos;ve used the JDK&apos;s HttpClient, and it worked out well.&lt;/p&gt;</comment>
                            <comment id="17767327" author="hossman" created="Wed, 20 Sep 2023 23:20:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Well getHttpClient is deprecated, so we could begin weening tests off of it. &#160;I&apos;ve used the JDK&apos;s HttpClient, and it worked out well.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Re-writing tests to use a new HTTP client implementation is more then i&apos;m willing to bite off at the moment &#8211; especially given how prevalent it seems to be for tests to call &lt;tt&gt;HttpSolrClient.getHttpClient()&lt;/tt&gt; &lt;/p&gt;

&lt;p&gt;( &lt;tt&gt;SolrTestCaseJ4.getHttpClient(String)&lt;/tt&gt; is just the ugliest tip of the iceberg).&lt;/p&gt;

&lt;p&gt;It didn&apos;t really click for me the other day, but even if we knew we had a &lt;tt&gt;ClosableHttpClient&lt;/tt&gt; instance, and we called &lt;tt&gt;close()&lt;/tt&gt; on it, &lt;tt&gt;ObjectReleaseTracker&lt;/tt&gt; would still complain because that&apos;s not our class and it&apos;s close method doesn&apos;t know/care to call &lt;tt&gt;ObjectReleaseTracker.release(this)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Apparently this is the whole purpose of the static &lt;tt&gt;HttpClientUtils.close()&lt;/tt&gt; method which is already used in many tests: to call &lt;tt&gt;release()&lt;/tt&gt; on &lt;tt&gt;HttpClient&lt;/tt&gt; that are created by &lt;tt&gt;HttpClientUtils&lt;/tt&gt;.  So I updated the handful of tests I know of &quot;leaking&quot; &lt;tt&gt;HttpClient&lt;/tt&gt; instances to use that method.&lt;/p&gt;

&lt;p&gt;The attached patch fixes all of the tests (that i know of) which currently break with  &lt;tt&gt;ObjectReleaseTracker&lt;/tt&gt; correctly enabled in &lt;tt&gt;SolrTestCase&lt;/tt&gt; ... if there are no objections i&apos;ll commit tomorrow so we stem the bleeding before even more tests get written that leak stuff &lt;/p&gt;</comment>
                            <comment id="17767690" author="jira-bot" created="Thu, 21 Sep 2023 18:57:56 +0000"  >&lt;p&gt;Commit 117a6cdf415ae43e3279aa1ea91adc8180a1cf74 in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=117a6cdf415&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=117a6cdf415&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16983&quot; title=&quot;ObjectReleaseTracker completely useless in all SolrTestCaseJ4 based tests - masking unclosed InputStream in some SolrStream usecases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16983&quot;&gt;&lt;del&gt;SOLR-16983&lt;/del&gt;&lt;/a&gt;: Fixed a bug that could cause some usages of SolrStream to fail to close InputStreams from the server.&lt;/p&gt;

&lt;p&gt;Also fixed the usage of ObjectReleaseTracker in SolrTestCaseJ4 to catch these kinds of bugs&lt;/p&gt;</comment>
                            <comment id="17767691" author="hossman" created="Thu, 21 Sep 2023 18:59:33 +0000"  >&lt;p&gt;committed to main.&lt;/p&gt;

&lt;p&gt;The backport to 9x was frighteningly easy&#160; .... running tests now to see if any new test failures pop up that weren&apos;t on main.&lt;/p&gt;</comment>
                            <comment id="17767733" author="alex.parvulescu" created="Thu, 21 Sep 2023 21:23:01 +0000"  >&lt;p&gt;very interesting find. I was not aware of this work (are you not a fan of github PRs?). I posted another potential fix of a missing close in a test &lt;a href=&quot;https://github.com/apache/solr/pull/1947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1947&lt;/a&gt; which was probably surfaced by this change.&lt;/p&gt;</comment>
                            <comment id="17767750" author="jira-bot" created="Thu, 21 Sep 2023 22:34:52 +0000"  >&lt;p&gt;Commit 665070b97d8fee30f3dd8c57b7d02791b3bf3ba6 in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=665070b97d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=665070b97d8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16983&quot; title=&quot;ObjectReleaseTracker completely useless in all SolrTestCaseJ4 based tests - masking unclosed InputStream in some SolrStream usecases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16983&quot;&gt;&lt;del&gt;SOLR-16983&lt;/del&gt;&lt;/a&gt;: Fixed a bug that could cause some usages of SolrStream to fail to close InputStreams from the server.&lt;/p&gt;

&lt;p&gt;Also fixed the usage of ObjectReleaseTracker in SolrTestCaseJ4 to catch these kinds of bugs&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 117a6cdf415ae43e3279aa1ea91adc8180a1cf74)&lt;/p&gt;</comment>
                            <comment id="17767754" author="hossman" created="Thu, 21 Sep 2023 22:54:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;(are you not a fan of github PRs?)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am not. (I don&apos;t mind looking at PR links from jira, but i don&apos;t create PRs myself, and i don&apos;t go out of my way to hunt for PRs)&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I posted another potential fix of a missing close in a test &lt;a href=&quot;https://github.com/apache/solr/pull/1947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1947&lt;/a&gt; which was probably surfaced by this change.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I was aware of those jenkins failures when i created this issue &#8211; it was actually one of the reasons i started looking into where/why/how ObjectReleaseTracker was being used in our test-framework, because i couldn&apos;t understand how we could be leaking &lt;tt&gt;&quot;h2sc&quot;&lt;/tt&gt; threads w/o seeing ObjectReleaseTracker complainingg about un-closed instances of &lt;tt&gt;Http2SolrClient&lt;/tt&gt;...&lt;/p&gt;

&lt;p&gt;The thing your PR overlooks is that the &lt;tt&gt;StreamingTest.getTuple(estream);&lt;/tt&gt; call is already going to call &lt;tt&gt;estream.close()&lt;/tt&gt; internally &#8211; unless the &lt;tt&gt;open()&lt;/tt&gt; or &lt;tt&gt;read()&lt;/tt&gt; calls throw an Exception &#8211; but if they did that then &lt;tt&gt;testExceptionStream()&lt;/tt&gt; stream would propogate that exception and the test method would fail (in addition to the leaked threads/objects) .. but it doesn&apos;t fail, because the point of the &lt;tt&gt;ExceptionStream&lt;/tt&gt; method is to swallow those exceptions &#8211; so &lt;tt&gt;estream.close()&lt;/tt&gt; is (almost certainly) being called already .... the question is whether everything &lt;tt&gt;ExceptionStream&lt;/tt&gt; hangs on to is being closed.&lt;/p&gt;

&lt;p&gt;Since the jenkins failures don&apos;t reliably reproduce on other machines, the problem isn&apos;t deterministic (based on the seed) and is likely related to thread scheduling/concurrency.&lt;/p&gt;

&lt;p&gt;I have a loose theory about these &lt;tt&gt;StreamingTest&lt;/tt&gt; failures that i&apos;ll file in a new jira later today once i have a chance to think it through fully, and I&apos;ll make sure to tag you in it you want to investigate further.&lt;/p&gt;</comment>
                            <comment id="17767757" author="alex.parvulescu" created="Thu, 21 Sep 2023 23:18:34 +0000"  >&lt;p&gt;yes I am interested in the followup, please tag me if you have something new.&lt;br/&gt;
you are correct, and I remember seeing this already in the past and forgetting about it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I caught a glimpse in crave build with the new stacktraces pointing to this specific test, but I did not save the trace and now it&apos;s not available anymore. will close the PR it is not useful.&lt;/p&gt;</comment>
                            <comment id="17775464" author="alex.parvulescu" created="Sun, 15 Oct 2023 19:57:06 +0000"  >&lt;p&gt;Closing after the 9.4.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13551597">SOLR-16992</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063034" name="SOLR-16983-1.patch" size="13686" author="hossman" created="Tue, 19 Sep 2023 23:14:24 +0000"/>
                            <attachment id="13063076" name="SOLR-16983-2.patch" size="19341" author="hossman" created="Wed, 20 Sep 2023 23:20:47 +0000"/>
                            <attachment id="13062957" name="SOLR-16983.bug-demo.nocommit.patch" size="2987" author="hossman" created="Fri, 15 Sep 2023 23:09:30 +0000"/>
                            <attachment id="13062961" name="SOLR-16983.patch" size="5179" author="hossman" created="Sat, 16 Sep 2023 05:00:29 +0000"/>
                            <attachment id="13062959" name="test-output-if-clear-is-removed-from-SolrTestCaseJ4.txt.gz" size="803668" author="hossman" created="Sat, 16 Sep 2023 00:43:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1keaw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>