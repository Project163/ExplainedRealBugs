<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:43:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14159] Fix errors in TestCloudConsistency</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14159</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Moving over here from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13486&quot; title=&quot;race condition between leader&amp;#39;s &amp;quot;replay on startup&amp;quot; and non-leader&amp;#39;s &amp;quot;recover from leader&amp;quot; can leave replicas out of sync (TestTlogReplayVsRecovery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13486&quot;&gt;SOLR-13486&lt;/a&gt; as per Hoss.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13277285">SOLR-14159</key>
            <summary>Fix errors in TestCloudConsistency</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="erickerickson">Erick Erickson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Jan 2020 00:35:39 +0000</created>
                <updated>Tue, 14 Apr 2020 12:23:48 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17007784" author="erickerickson" created="Fri, 3 Jan 2020 21:51:45 +0000"  >&lt;p&gt;I&apos;m baffled. What I know now:&lt;/p&gt;

&lt;p&gt;1&amp;gt; I ran into this while trying to figure out &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13486&quot; title=&quot;race condition between leader&amp;#39;s &amp;quot;replay on startup&amp;quot; and non-leader&amp;#39;s &amp;quot;recover from leader&amp;quot; can leave replicas out of sync (TestTlogReplayVsRecovery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13486&quot;&gt;SOLR-13486&lt;/a&gt;. Near as I can tell, it&apos;s a completely different issue.&lt;br/&gt;
2&amp;gt; I can reproduce this reasonably regularly on my MBP, but not on my mac pro.&lt;br/&gt;
3&amp;gt; the failure is in TestCloudConsistency.assertDocExists and it&apos;s &quot;connection refused&quot;. The cases I&apos;ve seen seem to be a follower, not the leader.&lt;br/&gt;
4&amp;gt; I have no clue whether the follower being queried is up to date since the connection refused error short-circuits the check.&lt;br/&gt;
5&amp;gt; The port is not a proxy. The attached log file shows failures on port 49186.&lt;br/&gt;
6&amp;gt; This failure happens when beasting a single test in TestCloudConsistency, so it&apos;s not the case that some other test is polluting the test space,&lt;br/&gt;
7&amp;gt; If I&apos;m reading the log file correctly, the recovery process completes successfully for the node that we can&apos;t connect to.&lt;br/&gt;
8&amp;gt; live_nodes contains the problem node and the cluster state looks like it&apos;s active.&lt;br/&gt;
9&amp;gt; Just for yucks, I tried creating a new HttpSolrServer in the failure case and that doesn&apos;t seem to make any difference.&lt;/p&gt;

&lt;p&gt;The attached failure log has a ton of additional debug information in it. The attached patch is what I&apos;m using, it doesn&apos;t have any substantive changes except all the additional logging.&lt;/p&gt;

&lt;p&gt;The log file is very confusing since it has all this additional logging output. So far I can&apos;t find any smoking guns.&lt;/p&gt;

&lt;p&gt;I suspect this is something in our underlying test framework, or something in Jetty that I&apos;m not seeing. Perhaps the underlying cause has wider implications for other tests, but that&apos;s speculation.&lt;/p&gt;

&lt;p&gt;Any help appreciated, I&apos;m pretty much at my wit&apos;s end.&lt;/p&gt;</comment>
                            <comment id="17007804" author="hossman" created="Fri, 3 Jan 2020 22:33:48 +0000"  >&lt;p&gt;Erick: i&apos;m having trouble wrapping my head around a lot of the stuff in your debug patch &#8211; could you please post the full log file (not just a reproduce line) showing hte results you were getting &lt;em&gt;before&lt;/em&gt; your patch?&lt;/p&gt;

&lt;p&gt;...ideally after the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13486&quot; title=&quot;race condition between leader&amp;#39;s &amp;quot;replay on startup&amp;quot; and non-leader&amp;#39;s &amp;quot;recover from leader&amp;quot; can leave replicas out of sync (TestTlogReplayVsRecovery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13486&quot;&gt;SOLR-13486&lt;/a&gt; / 0fac7c1a26395ed21f14e02a471e6350144074c7 commit ?&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;(Being able to see what the error looked like with out your patch is also going to be important for people who might encounter the same probably you were seeing in their local boxes &#8211; knowing what failures you got&#160;&lt;b&gt;after&lt;/b&gt; changing the test won&apos;t help them understand if you&#160;&lt;em&gt;were&lt;/em&gt; getting the same failure before you bad those changes.)&lt;/p&gt;</comment>
                            <comment id="17008057" author="erickerickson" created="Sat, 4 Jan 2020 14:57:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; Many thanks for your effort here, I&apos;m totally going out of my gourd trying to track this.&lt;/p&gt;

&lt;p&gt;The full output is in stdout that I attached yesterday. And all the debug output is a total mess, I posted it there for masochists &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;Basically, it&apos;s a scattergun approach &quot;put all this logging in everywhere you can and see what sticks to the wall&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Most of it is dumping a bunch of data trying to figure out whether there was something weird with proxies, whether the server where the connection was refused was somehow NOT in live_nodes, anything I could think of that would shed light on what I was seeing, but none of the things I was looking at as possible causes were borne out.&lt;/p&gt;

&lt;p&gt;AFAICT:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The proxies are fine, at least to my untrained eye.&lt;/li&gt;
	&lt;li&gt;Recovery was successful.&lt;/li&gt;
	&lt;li&gt;The host is in live_nodes.&lt;/li&gt;
	&lt;li&gt;The node where the connection is refused is up and has updated state.json marking itself as active.&lt;/li&gt;
	&lt;li&gt;The query happens after the node recovers and posts itself as active and the host is in live_nodes.&lt;/li&gt;
	&lt;li&gt;The request that&apos;s failing is actually going to the host, not using the proxy (I think).&lt;/li&gt;
	&lt;li&gt;Just to see what would happen, I tried re-opening the HttpSolrClient upon failure, but the test still fails with &quot;connection refused&quot;.&lt;/li&gt;
	&lt;li&gt;There a bunch of messages about how things are closing down, but these are all after the failure and part of the normal test termination. They&apos;re in close proximity in the log file though, which mislead me for a bit.&lt;/li&gt;
	&lt;li&gt;I can generate this by beasting only the single failing test in this suite.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ll apply the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13486&quot; title=&quot;race condition between leader&amp;#39;s &amp;quot;replay on startup&amp;quot; and non-leader&amp;#39;s &amp;quot;recover from leader&amp;quot; can leave replicas out of sync (TestTlogReplayVsRecovery)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13486&quot;&gt;SOLR-13486&lt;/a&gt; and post that if I can get it to fail again, that&apos;ll be later today. Probably much later today as it may take several hundred runs, beasting only the failing test. I&apos;ll leave in exactly one dump of all the information in clusterstate and the local member variables just before the test that fails, delimited with &quot;EOE START&quot;, and &quot;EOE END&quot;, that may be useful and should be much easier to ignore.&lt;/p&gt;

&lt;p&gt;FWIW, I&apos;ve seen at least two different flavors of failure apart from what is in 13486:&lt;br/&gt;
1&amp;gt; the Connection Refused problem&lt;br/&gt;
2&amp;gt; unable to create the cluster&lt;/p&gt;

&lt;p&gt;&amp;lt;2&amp;gt; is much rarer than &amp;lt;1&amp;gt; FWIW. If I can get failures for both I&apos;ll attach.&lt;/p&gt;</comment>
                            <comment id="17008082" author="erickerickson" created="Sat, 4 Jan 2020 16:34:36 +0000"  >&lt;p&gt;Not sure I can call this &quot;lucky&quot;, but here&apos;s the failure. I think it&apos;s appropriate that if was the 13th attempt. See FailWithHossFix&lt;/p&gt;

&lt;p&gt;This is the &quot;Server refused connection&quot; failure.&lt;/p&gt;</comment>
                            <comment id="17008087" author="erickerickson" created="Sat, 4 Jan 2020 16:48:52 +0000"  >&lt;p&gt;And here&apos;s the patch I used (WithHossFix.patch). NOTE: it has two other changes. One for an NPE in: SolrClientNodeStateProvider that I ran into occasionally, I think a race condition when shutting down hit it. And one cleanup in MiniSolrCloudCluster where we pass a timeout value to waitForAllNodes then ignore it and use a hard-coded 30 seconds. &lt;/p&gt;</comment>
                            <comment id="17008190" author="erickerickson" created="Sat, 4 Jan 2020 23:32:17 +0000"  >&lt;p&gt;I just attached the failure I&apos;ve seen with &quot;Timeout waiting for active collection&quot;. The FailWithHossFix I attached earlier is the more common failure I get &quot;Server refused connecrtion&quot;.&lt;/p&gt;</comment>
                            <comment id="17010081" author="hossman" created="Tue, 7 Jan 2020 20:47:28 +0000"  >&lt;p&gt;So far I&apos;ve been unable to reprodue either of the failures Erick mentioned in my local beasting (close to a thousand iterations).&lt;/p&gt;

&lt;p&gt;While beasting, I&apos;ve been looking over the &quot;FailWithHossFix&quot; which shows the &quot;Connection Refused&quot; problem. (i have not looked into the other log file/problem)&lt;/p&gt;

&lt;p&gt;Nothing in the log messages gives me an immediate &quot;Ah-HA!&quot; moment, but I do want to reply directly to a few comments Erick has made, which has lead to a &quot;best guess&quot; as to what the problem may be (below)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Note first that the specific failure condition in this log is...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestCloudConsistency -Dtests.method=testOutOfSyncReplicasCannotBecomeLeader -Dtests.seed=66748AAA9CB5BE46 -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=nyn-UG -Dtests.timezone=Pacific/Apia -Dtests.asserts=true -Dtests.file.encoding=US-ASCII
   [junit4] ERROR   50.2s | TestCloudConsistency.testOutOfSyncReplicasCannotBecomeLeader &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: org.apache.solr.client.solrj.SolrServerException: Server refused connection at: http://127.0.0.1:49158/solr/outOfSyncReplicasCannotBecomeLeader-false
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... So the problem relates to port #49158 (which hosts a single replica of the single shard collection) ...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Recovery was successful.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That does not appear to be true? ... when the leader is shutdown (after doc4 gets added) there is an attempt at an election in which both (live) replicas (including 49158) realize they are not eligable to be the leader (due to stale ShardTerm) and need to wait for the leader to come back and then recover...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 42358 INFO  (zkCallback-125-thread-1) [n:127.0.0.1:49158_solr c:outOfSyncReplicasCannotBecomeLeader-false s:shard1 r:core_node6 x:outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n5 ] o.a.s.c.ShardLeaderElectionContext Can&apos;t become leader, other replicas with higher term participated in leader election
   [junit4]   2&amp;gt; 42358 INFO  (zkCallback-125-thread-1) [n:127.0.0.1:49158_solr c:outOfSyncReplicasCannotBecomeLeader-false s:shard1 r:core_node6 x:outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n5 ] o.a.s.c.ShardLeaderElectionContext There may be a better leader candidate than us - going back into recovery
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...but AFAICT, even though &apos;127.0.0.1:49158_solr&apos; has a recovery thread (recoveryExecutor-122-thread-1-processing-n:127.0.0.1:49158_solr) that is running all the way to the end of the test, that replica never seems to log thta it has recovered.&lt;/p&gt;

&lt;p&gt;When the leader replica does come back online, AFAICT it successfully PeerSyncs to the &lt;em&gt;other&lt;/em&gt; replica, but it logs that can &lt;b&gt;NOT&lt;/b&gt; PeerSync to 49158 &#8211; it encounters a &quot;Connection Refused&quot; (just like the test thread does later)...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 44867 INFO  (zkCallback-168-thread-2) [n:127.0.0.1:65519_solr c:outOfSyncReplicasCannotBecomeLeader-false s:shard1 r:core_node2 x:outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n1 ] o.a.s.c.SyncStrategy Sync replicas to http://127.0.0.1:65519/solr/outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n1/
   [junit4]   2&amp;gt; 44877 INFO  (zkCallback-168-thread-2) [n:127.0.0.1:65519_solr c:outOfSyncReplicasCannotBecomeLeader-false s:shard1 r:core_node2 x:outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n1 ] o.a.s.u.PeerSync PeerSync: core=outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n1 url=http://127.0.0.1:65519/solr START replicas=[http://127.0.0.1:65529/solr/outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n3/, http://127.0.0.1:49158/solr/outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n5/] nUpdates=100
   [junit4]   2&amp;gt; 44880 INFO  (SocketProxy-Acceptor-65529) [     ] o.a.s.c.s.c.SocketProxy accepted Socket[addr=/127.0.0.1,port=49422,localport=65529], receiveBufferSize:408300
   [junit4]   2&amp;gt; 44890 INFO  (SocketProxy-Acceptor-65529) [     ] o.a.s.c.s.c.SocketProxy proxy connection Socket[addr=/127.0.0.1,port=65534,localport=49424], receiveBufferSize=408300
   [junit4]   2&amp;gt; 44892 WARN  (zkCallback-168-thread-2) [n:127.0.0.1:65519_solr c:outOfSyncReplicasCannotBecomeLeader-false s:shard1 r:core_node2 x:outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n1 ] o.a.s.u.PeerSync PeerSync: core=outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n1 url=http://127.0.0.1:65519/solr  couldn&apos;t connect to http://127.0.0.1:49158/solr/outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n5/, counting as success
   [junit4]   2&amp;gt;           =&amp;gt; org.apache.solr.client.solrj.SolrServerException: Server refused connection at: http://127.0.0.1:49158/solr/outOfSyncReplicasCannotBecomeLeader-false_shard1_replica_n5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that while the leader is trying to PeerSync to the 2 replicas, the SocketProxy for 65529 records (the &lt;em&gt;other&lt;/em&gt; replica) the connection it got, but the proxy for 49158 doesn&apos;t log anything.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Perhaps because the proxy for 49158 hasn&apos;t successfully restarted yet?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;_(Seems unlikely given that it&apos;s had over 10 full seconds to do so since the proxies were re-opened ... but then again, now that i look at the logic in TestCloudConsistency that &quot;waits&quot; to see if a replica erroneously becomes the leader (even though it&apos;s ShardTerm is too low), i realize it&apos;s a spin loop w/o any sleep or waiting ... it could be causing thread starvation?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    TimeOut timeOut = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimeOut(10, TimeUnit.SECONDS, TimeSource.NANO_TIME);
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!timeOut.hasTimedOut()) {
      Replica newLeader = getCollectionState(collection).getLeader(&lt;span class=&quot;code-quote&quot;&gt;&quot;shard1&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newLeader != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !newLeader.getName().equals(leader.getName()) &amp;amp;&amp;amp; newLeader.getState() == Replica.State.ACTIVE) {
        fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Out of sync replica became leader &quot;&lt;/span&gt; + newLeader);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;The request that&apos;s failing is actually going to the host, not using the proxy (I think).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, it&apos;s definitely going to the proxy &#8211; what might be confusing you is that the testclass spins up the SockProxy instances extenrally from the JettySolrRunner&apos;s (because MiniSolrCloud doesn&apos;t provide an easy way to do that) so things like &lt;tt&gt;JettySolrRunner.getProxy()&lt;/tt&gt; return null &#8211; but port 49158 is still a proxy port (and jett knows it ... note when/where &lt;tt&gt;JettySolrRunner.setProxyPort(int)&lt;/tt&gt; is called in TestCloudConsistency)&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;NOTE: it has two other changes. One for an NPE in: SolrClientNodeStateProvider that I ran into occasionally, I think a race condition when shutting down hit it. And one cleanup in MiniSolrCloudCluster where we pass a timeout value to waitForAllNodes then ignore it and use a hard-coded 30 seconds.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;These both seem like very legit bugs unrelated to this specific test that should be tracked &amp;amp; fixed in their own jiras ... have you filed new jiras for these?&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I&apos;m attaching 2 independent patches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;_proxy_logging.patch&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;_waitFor_testfix.patch&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;: I would appreciate it if you could try the following and report back with logs&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Try beasting with &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;_proxy_logging.patch&lt;/tt&gt; applied and see if you can trigger a &quot;Connection refused&quot; failure
	&lt;ul&gt;
		&lt;li&gt;the added logging will be very noisy, and it&apos;s possible it will shift the thread timing so the error no longer happens, or some other error happens&lt;/li&gt;
		&lt;li&gt;if you can reproduce with this patch applied, please capture &amp;amp; upload the logs before proceeding&lt;/li&gt;
		&lt;li&gt;if you can&apos;t reproduce with this patch applied, go ahead and revert it&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Then apply &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;_waitFor_testfix.patch&lt;/tt&gt; and see if that can still trigger a &quot;Connection refused&quot; failure
	&lt;ul&gt;
		&lt;li&gt;If so please report back wih those logs as well (ie: if it still fails, then ideally it would be good to have the logs with both patches applied at the same time)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17010126" author="hossman" created="Tue, 7 Jan 2020 22:04:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;I just attached the failure I&apos;ve seen with &quot;Timeout waiting for active collection&quot;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So at a glance, the file &lt;tt&gt;FailWaitingForCollection_WithHossFix&lt;/tt&gt; seems to show the same underlying problem of the (socket) port refusing a connection &#8211; but instead of it being a replica refusing hte connection (when checking if it has all the documents) it&apos;s the &lt;b&gt;Leader&lt;/b&gt; that&apos;s refusing connections, which causes hte replicas to fail to be able to talk to it in order to come online and recover &#8211; so the &lt;tt&gt;&quot;Timeout waiting for active collection&quot;&lt;/tt&gt; causes a failure.&lt;/p&gt;

&lt;p&gt;Going back to an earlier comment...&lt;br/&gt;
&lt;blockquote&gt;&lt;/blockquote&gt;Recovery was successful.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;That does not appear to be true? ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I see what you mean now &#8211; the &lt;em&gt;other&lt;/em&gt; logs (&lt;tt&gt;FailWithHossFix&lt;/tt&gt;) seemed to show that the leader couldn&apos;t &lt;em&gt;initiate&lt;/em&gt; the PeerSync recovery, but (evidently ... still not sure where) it did eventually happen (and i just didn&apos;t notice it in the logs) because the replica came online and considered itself active (hence the test made it past the failure we see here in {FailWaitingForCollection_WithHossFix}}) ... but in this case neither replica is able to recover at all because they were never able to &quot;fetch&quot; the data from the leader.&lt;/p&gt;

&lt;p&gt;This smells like the same root problem as the other log: somehow/somewhere a Socket proxy isn&apos;t functioning properly after &lt;tt&gt;reopen()&lt;/tt&gt; &#8211; In &lt;tt&gt;FailWithHossFix&lt;/tt&gt; it&apos;s the proxy of a replica, in &lt;tt&gt;FailWaitingForCollection_WithHossFix&lt;/tt&gt; it&apos;s the Leader.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;definitely curious to see if &lt;em&gt;either&lt;/em&gt; type of failure reproduces with patches i posted earlier&lt;/p&gt;</comment>
                            <comment id="17021535" author="hossman" created="Wed, 22 Jan 2020 21:37:50 +0000"  >&lt;p&gt;Erick mentioned offline that he hasn&apos;t had much time to test these patches, but i plan to go ahead and commit &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;_waitFor_testfix.patch&lt;/tt&gt; because even if it doesn&apos;t fix the problems he was seeing, they are still good improvements to prevent CPU saturation.&lt;/p&gt;

&lt;p&gt;I actually realized when looking at the patch again today that there&apos;s a second place in TestCloudConsistency with the same bug &#8211; so i&apos;m attaching an updated patch that i plan to commit shortly.&lt;/p&gt;</comment>
                            <comment id="17021542" author="jira-bot" created="Wed, 22 Jan 2020 21:45:06 +0000"  >&lt;p&gt;Commit 6b3e7feba19d2314d8c38205dbf1ab1fe2607096 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6b3e7fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=6b3e7fe&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;: Eliminate some &apos;spin loops&apos; in tests that may be contributing factors to odd test failures&lt;/p&gt;</comment>
                            <comment id="17021567" author="jira-bot" created="Wed, 22 Jan 2020 22:04:58 +0000"  >&lt;p&gt;Commit e0820acc45c24cf0c7bd8dabe36d9a9c72b35483 in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=e0820ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=e0820ac&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14159&quot; title=&quot;Fix errors in TestCloudConsistency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14159&quot;&gt;SOLR-14159&lt;/a&gt;: Eliminate some &apos;spin loops&apos; in tests that may be contributing factors to odd test failures&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6b3e7feba19d2314d8c38205dbf1ab1fe2607096)&lt;/p&gt;</comment>
                            <comment id="17022114" author="erickerickson" created="Thu, 23 Jan 2020 13:49:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; I had 2 failures out of 1,000 last nigh. One is &quot;ADDREPLICA failed to create replica&quot; and the other is &quot;Expected mime type application/octet-stream but got text/html. &amp;lt;!doctype html&amp;gt;&amp;lt;title&amp;gt;404 Not Found&amp;lt;/title&amp;gt;&amp;lt;h1 style=&quot;text-align: center&quot;&amp;gt;404 Not Found&quot;&lt;/p&gt;

&lt;p&gt;They may well be &quot;something else&quot;, attached for your perusal.&lt;/p&gt;</comment>
                            <comment id="17083158" author="erickerickson" created="Tue, 14 Apr 2020 12:23:29 +0000"  >&lt;p&gt;I&apos;m unassigning this, there haven&apos;t been failures in the last 4 weeks...&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13234669">SOLR-13486</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12989953" name="FailWaitingForCollection_WithHossFix" size="528254" author="erickerickson" created="Sat, 4 Jan 2020 23:30:56 +0000"/>
                            <attachment id="12989937" name="FailWithHossFix" size="499994" author="erickerickson" created="Sat, 4 Jan 2020 16:33:55 +0000"/>
                            <attachment id="12989908" name="SOLR-14159_debug.patch" size="21251" author="erickerickson" created="Fri, 3 Jan 2020 21:35:47 +0000"/>
                            <attachment id="12990130" name="SOLR-14159_proxy_logging.patch" size="1976" author="hossman" created="Tue, 7 Jan 2020 20:45:05 +0000"/>
                            <attachment id="12991577" name="SOLR-14159_waitFor_testfix.patch" size="6993" author="hossman" created="Wed, 22 Jan 2020 21:36:04 +0000"/>
                            <attachment id="12990131" name="SOLR-14159_waitFor_testfix.patch" size="4452" author="hossman" created="Tue, 7 Jan 2020 20:45:05 +0000"/>
                            <attachment id="12989940" name="WithHossFix.patch" size="8701" author="erickerickson" created="Sat, 4 Jan 2020 16:41:18 +0000"/>
                            <attachment id="12991660" name="stdout" size="667438" author="erickerickson" created="Thu, 23 Jan 2020 13:49:14 +0000"/>
                            <attachment id="12991661" name="stdout" size="600760" author="erickerickson" created="Thu, 23 Jan 2020 13:48:45 +0000"/>
                            <attachment id="12989909" name="stdout" size="1103821" author="erickerickson" created="Fri, 3 Jan 2020 21:36:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0a5eo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>