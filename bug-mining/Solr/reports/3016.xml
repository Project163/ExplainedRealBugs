<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:14:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9207] PeerSync recovery fails if number of updates requested is high</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9207</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;tt&gt;PeerSync&lt;/tt&gt; recovery fails if we request more than ~99K updates. &lt;/p&gt;

&lt;p&gt;If update solrconfig to retain more &lt;tt&gt;tlogs&lt;/tt&gt; to leverage &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6359&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-6359&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;During out testing we found out that recovery using &lt;tt&gt;PeerSync&lt;/tt&gt; fails if we ask for more than ~99K updates, with following error&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; WARN  PeerSync [RecoveryThread] - PeerSync: core=hold_shard1 url=&amp;lt;shardUrl&amp;gt;
exception talking to &amp;lt;leaderUrl&amp;gt;, failed
org.apache.solr.client.solrj.impl.HttpSolrServer$RemoteSolrException: Expected mime type application/octet-stream but got application/xml. 
&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;response&amp;gt;
&amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;&amp;gt;&amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;msg&quot;&lt;/span&gt;&amp;gt;application/x-www-form-urlencoded content length (4761994 bytes) exceeds upload limit of 2048 KB&amp;lt;/str&amp;gt;&amp;lt;in
t name=&lt;span class=&quot;code-quote&quot;&gt;&quot;code&quot;&lt;/span&gt;&amp;gt;400&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;lt;/lst&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;We arrived at ~99K with following match&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;max_version_number = Long.MAX_VALUE = 9223372036854775807&lt;/li&gt;
	&lt;li&gt;bytes per version number =  20 (on the wire as POST request sends version number as string)&lt;/li&gt;
	&lt;li&gt;additional bytes for separator ,&lt;/li&gt;
	&lt;li&gt;max_versions_in_single_request = 2MB/21 = ~99864&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I could think of 2 ways to fix it&lt;br/&gt;
1. Ask for about updates in chunks of 90K inside &lt;tt&gt;PeerSync.requestUpdates()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;2. Use application/octet-stream encoding &lt;/p&gt;</description>
                <environment></environment>
        <key id="12978195">SOLR-9207</key>
            <summary>PeerSync recovery fails if number of updates requested is high</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="praste">Pushkar Raste</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jun 2016 15:35:14 +0000</created>
                <updated>Wed, 6 Oct 2021 16:36:26 +0000</updated>
                            <resolved>Wed, 6 Jul 2016 21:06:49 +0000</resolved>
                                    <version>5.1</version>
                    <version>6.0</version>
                                    <fixVersion>6.2</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15346632" author="shalinmangar" created="Thu, 23 Jun 2016 15:43:39 +0000"  >&lt;p&gt;Thanks Pushkar. PeerSync doesn&apos;t stream so this is not surprising. Which solution have you implemented in the patch? A rough description would go a long way. Also, there are some unrelated changes in TSTLookup which don&apos;t belong here. A workaround would be to increase the default upload limit in Jetty.&lt;/p&gt;</comment>
                            <comment id="15346944" author="praste" created="Thu, 23 Jun 2016 18:37:35 +0000"  >&lt;p&gt;Here is high level description&lt;/p&gt;

&lt;p&gt;PeerSync currently computes versions the node recovery is missing and then sends all the version numbers to a replica to get corresponding updates. When a node under recovery is missing too many updates, the payload of &lt;tt&gt;getUpdates&lt;/tt&gt; goes above 2MB and jetty would reject the request. Problem can be solved using one of the following technique&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Increasing jetty payload limit pay solve this problem. We still would be sending a lot of data over the network, which might not be needed.&lt;/li&gt;
	&lt;li&gt;Stream versions to replica while asking for updates.&lt;/li&gt;
	&lt;li&gt;Request versions in chunks of about 90K versions at a time&lt;/li&gt;
	&lt;li&gt;gzip versions , and unzip it on the other side.&lt;/li&gt;
	&lt;li&gt;Ask for version using version ranges instead of sending individual versions.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Approaches 1-3 require sending lot of data over the wire. &lt;br/&gt;
Approach #3 also requires making multiple calls. Additionally #3 might not be feasible consider how current code works by submitting requests to &lt;tt&gt;shardHandler&lt;/tt&gt; and calling &lt;tt&gt;handleResponse&lt;/tt&gt;.&lt;br/&gt;
#4 may work, but looks a little inelegant. &lt;/p&gt;

&lt;p&gt;Hence I settle on approach #5 (suggested by Ramkumar). Here is how it works &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Let&apos;s say replica has version &lt;span class=&quot;error&quot;&gt;&amp;#91;1, 2, 3, 4, 5, 6&amp;#93;&lt;/span&gt; and leader has versions &lt;span class=&quot;error&quot;&gt;&amp;#91;1, 2, 3, 4, 5, 6, 10, -11, 12, 13, 15, 18&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;While recovery using &lt;tt&gt;PeerSync&lt;/tt&gt; strategy, replica computes, that range it is missing is &lt;tt&gt;10...18&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Replica now requests for versions by specifying range &lt;tt&gt;10...18&lt;/tt&gt; instead of sending all the individual versions (namely 10,11,-11,12,13,15,18)&lt;/li&gt;
	&lt;li&gt;I have made using version ranges for PeerSync configurable, by introducing following configuration section
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &amp;lt;peerSync&amp;gt;
    &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;useRangeVersions&quot;&lt;/span&gt;&amp;gt;${solr.peerSync.useRangeVersions:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}&amp;lt;/str&amp;gt;
  &amp;lt;/peerSync&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Further I have it backwards compatible and a recovering node will use version ranges only if node it asks for updates can process version ranges&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15361557" author="shalinmangar" created="Mon, 4 Jul 2016 16:32:34 +0000"  >&lt;p&gt;Thanks Pushkar! The patch looks good to me except that the testing is not adequate. The one test modified by the patch is RecoveryAfterSoftCommitTest which is designed to never trigger PeerSync at all. I think we should enable useRangeVersions by default and randomly set it to false during tests for good coverage.&lt;/p&gt;</comment>
                            <comment id="15361608" author="praste" created="Mon, 4 Jul 2016 17:10:33 +0000"  >&lt;p&gt;Thanks a lot Shalin.&lt;br/&gt;
I will make the suggested change for randomized testing.&lt;/p&gt;</comment>
                            <comment id="15362859" author="praste" created="Tue, 5 Jul 2016 17:47:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; - Please check updated patch.&lt;/p&gt;</comment>
                            <comment id="15364990" author="shalinmangar" created="Wed, 6 Jul 2016 20:08:42 +0000"  >&lt;p&gt;Changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The value for useRangeVersions being set in solrconfig.xml wasn&apos;t being read at all because it was written in solrconfig.xml with the element &apos;str&apos; but it was being read as &apos;useRangeVersions&apos;. I changed the element name in configuration to useRangeVersions to make it work.&lt;/li&gt;
	&lt;li&gt;The value for useRangeVersions should be in EditableSolrConfigAttributes.json so that it can be changed via the config API&lt;/li&gt;
	&lt;li&gt;Similarly, useRangeVersions should be returned in SolrConfig.toMap so that its value is returned by the config API&lt;/li&gt;
	&lt;li&gt;System property set in SolrTestCase4J for useRangeVersions should be cleared in the tear down method&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ll run precommit + tests and commit if there are no surprises.&lt;/p&gt;</comment>
                            <comment id="15365072" author="jira-bot" created="Wed, 6 Jul 2016 21:03:01 +0000"  >&lt;p&gt;Commit 380c5a6b9727beabb8ccce04add7e8e7089aa798 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=380c5a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=380c5a6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9207&quot; title=&quot;PeerSync recovery fails if number of updates requested is high&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9207&quot;&gt;&lt;del&gt;SOLR-9207&lt;/del&gt;&lt;/a&gt;: PeerSync recovery failes if number of updates requested is high. A new useRangeVersions config option is introduced (defaults to true) to send version ranges instead of individual versions for peer sync.&lt;/p&gt;</comment>
                            <comment id="15365086" author="jira-bot" created="Wed, 6 Jul 2016 21:05:29 +0000"  >&lt;p&gt;Commit a942de68fc34602ad0640a2726fd3dd240352357 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a942de6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a942de6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9207&quot; title=&quot;PeerSync recovery fails if number of updates requested is high&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9207&quot;&gt;&lt;del&gt;SOLR-9207&lt;/del&gt;&lt;/a&gt;: PeerSync recovery failes if number of updates requested is high. A new useRangeVersions config option is introduced (defaults to true) to send version ranges instead of individual versions for peer sync.&lt;br/&gt;
(cherry picked from commit 380c5a6)&lt;/p&gt;</comment>
                            <comment id="15365088" author="shalinmangar" created="Wed, 6 Jul 2016 21:06:49 +0000"  >&lt;p&gt;Thanks Pushkar!&lt;/p&gt;</comment>
                            <comment id="15438975" author="mikemccand" created="Fri, 26 Aug 2016 13:59:11 +0000"  >&lt;p&gt;Bulk close resolved issues after 6.2.0 release.&lt;/p&gt;</comment>
                            <comment id="17212621" author="evgeny ivanskiy" created="Mon, 12 Oct 2020 19:26:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=praste&quot; class=&quot;user-hover&quot; rel=&quot;praste&quot;&gt;praste&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We are seeing an intermittent issue where some of our collections fail to elect a leader after a restart. The log shows that hosts are failing to become leader due to a sync failure.&lt;br/&gt;
And that the sync failure is due to not receiving the expected number of updates &lt;br/&gt;
Investigation shows that there are duplicate versions in tlogs.&lt;br/&gt;
So, in this case: &lt;br/&gt;
If we get versions: &lt;b&gt;1,1,2,2,3,3&lt;/b&gt; we than request the updates in range &lt;b&gt;1...3&lt;/b&gt;. &lt;br/&gt;
As result we get &lt;b&gt;3 updates&lt;/b&gt; but &lt;b&gt;totalRequestedUpdates is 6&lt;/b&gt; and sync failed.&lt;br/&gt;
Is there is an assumption that getVersions should return distinct values or that is the bug in PeerSync.handleVersionsWithRanges which does&apos;t take into account duplicate versions?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17425079" author="cpoerschke" created="Wed, 6 Oct 2021 16:36:26 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Evgeny+Ivanskiy&quot; class=&quot;user-hover&quot; rel=&quot;Evgeny Ivanskiy&quot;&gt;Evgeny Ivanskiy&lt;/a&gt;, the issue here is closed but it seems that &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15676&quot; title=&quot;PeerSync failure due to RealTimeGetComponent returning duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15676&quot;&gt;&lt;del&gt;SOLR-15676&lt;/del&gt;&lt;/a&gt; is potentially similar to your issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13273950">SOLR-14058</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13108877">SOLR-11475</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12816486" name="SOLR-9207.patch" size="17572" author="shalin" created="Wed, 6 Jul 2016 20:08:42 +0000"/>
                            <attachment id="12812828" name="SOLR-9207.patch" size="17733" author="praste" created="Thu, 23 Jun 2016 13:43:39 +0000"/>
                            <attachment id="12816235" name="SOLR-9207.patch_updated" size="16880" author="praste" created="Tue, 5 Jul 2016 17:46:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zdzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>