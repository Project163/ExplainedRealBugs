<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17414] multiThreaded=true can result in RejectedExecutionException</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17414</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Since the new multiThreaded search feature landed, I see a new test&lt;br/&gt;
failure involving &quot;RejectedExecutionException&quot; being thrown &lt;a href=&quot;https://ge.apache.org/s/5ack462ji4mlu/tests/task/:solr:core:test/details/org.apache.solr.search.TestRealTimeGet/testStressGetRealtime?top-execution=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It is thrown at a low level in Lucene building TermStates&lt;br/&gt;
concurrently.  I doubt the problem is specific to that test&lt;br/&gt;
(TestRealTimeGet) but that test might induce more activity than most&lt;br/&gt;
tests, thus crossing some thresholds like the queue size &amp;#8211; apparently&lt;br/&gt;
1000.&lt;/p&gt;

&lt;p&gt;*I don&apos;t think we should be throwing a RejectedExecutionException&lt;br/&gt;
when running a Search query*&lt;/p&gt;</description>
                <environment></environment>
        <key id="13589614">SOLR-17414</key>
            <summary>multiThreaded=true can result in RejectedExecutionException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="dsmiley">David Smiley</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 21 Aug 2024 14:08:48 +0000</created>
                <updated>Sun, 2 Feb 2025 04:47:47 +0000</updated>
                            <resolved>Wed, 18 Dec 2024 21:54:24 +0000</resolved>
                                                    <fixVersion>9.8</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17876471" author="gus_heck" created="Sun, 25 Aug 2024 02:02:29 +0000"  >&lt;p&gt;While running tests locally I hit this which reproduced 4/4 times&lt;/p&gt;

&lt;p&gt;Reproduce with: ./gradlew :solr:core:test --tests &quot;org.apache.solr.search.TestRealTimeGet.testStressGetRealtime&quot; -Ptests.jvms=30 &quot;-Ptests.jvmargs=-XX:TieredStopAtLevel=1 -XX:+UseParallelGC -XX:ActiveProcessorCount=1 -XX:ReservedCodeCacheSize=120m&quot; -Ptests.seed=7A02F52071F9D051 -Ptests.file.encoding=US-ASCII&lt;/p&gt;</comment>
                            <comment id="17879286" author="dsmiley" created="Wed, 4 Sep 2024 16:11:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt; on the dev list when I raised this concern, you said you&apos;d look into it.  If you have WIP or are doing so then assign it to yourself.  If not, I might take it up; sounds like fun.  &lt;/p&gt;</comment>
                            <comment id="17879327" author="dsmiley" created="Wed, 4 Sep 2024 18:13:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://lists.apache.org/thread/3hyh6m2llwd4r95hqslvp8mlkdo24vvh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;I proposed in the dev list&lt;/a&gt; a solution in which RejectedExecutionException would never occur.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Perhaps a LinkedBlockingQueue (thus infinite queue size) but have an ExecutorService subclass that observes the queue size to see if a threshold is reached and if so then runs the task directly? This way we never reject and the caller threads receive back pressure by doing the work that they would have done anyway with multiThreaded=false ! There is plenty of precedent for an ExecutorService that runs the task in the caller thread &amp;#8211; I&apos;m thinking of Lucene&apos;s SameThreadExecutorService and Solr&apos;s SimpleFacets.directExecutor &lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17885462" author="dsmiley" created="Fri, 27 Sep 2024 19:30:21 +0000"  >&lt;p&gt;(PR is ready)&lt;/p&gt;</comment>
                            <comment id="17889248" author="jira-bot" created="Mon, 14 Oct 2024 14:46:56 +0000"  >&lt;p&gt;Commit 7405bb19fa424ec79c6daaafd986670dc54d7dfe in solr&apos;s branch refs/heads/main from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=7405bb19fa4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=7405bb19fa4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17414&quot; title=&quot;multiThreaded=true can result in RejectedExecutionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17414&quot;&gt;&lt;del&gt;SOLR-17414&lt;/del&gt;&lt;/a&gt;: multiThreaded search: don&apos;t throw RejectedExecutionException (#2701)&lt;/p&gt;

&lt;p&gt;When searching with multiThreaded=true, the internal tasks may now block instead of enqueuing with a risk of rejection. Solr will use less resources under stress but to get the most of your machine, you may want to increase the thread pool.&lt;br/&gt;
And:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Revert ExecutorUtil change from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17298&quot; title=&quot;Multithreaded search breaks limits, and possibly other things&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17298&quot;&gt;&lt;del&gt;SOLR-17298&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Revert ExecutorUtil change from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13350&quot; title=&quot;Explore collector managers for multi-threaded search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13350&quot;&gt;&lt;del&gt;SOLR-13350&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;rename CoreContainer.collectorManager to indexSearcherExecutor&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17889319" author="jira-bot" created="Mon, 14 Oct 2024 19:43:15 +0000"  >&lt;p&gt;Commit 8d07c7321ce2a789291e139b26898500fc2b9cac in solr&apos;s branch refs/heads/branch_9x from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=8d07c7321ce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=8d07c7321ce&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17414&quot; title=&quot;multiThreaded=true can result in RejectedExecutionException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17414&quot;&gt;&lt;del&gt;SOLR-17414&lt;/del&gt;&lt;/a&gt;: multiThreaded search: don&apos;t throw RejectedExecutionException (#2701)&lt;/p&gt;

&lt;p&gt;When searching with multiThreaded=true, the internal tasks may now block instead of enqueuing with a risk of rejection. Solr will use less resources under stress but to get the most of your machine, you may want to increase the thread pool.&lt;br/&gt;
And:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Revert ExecutorUtil change from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17298&quot; title=&quot;Multithreaded search breaks limits, and possibly other things&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17298&quot;&gt;&lt;del&gt;SOLR-17298&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Revert ExecutorUtil change from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13350&quot; title=&quot;Explore collector managers for multi-threaded search&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13350&quot;&gt;&lt;del&gt;SOLR-13350&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;rename CoreContainer.collectorManager to indexSearcherExecutor&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cherry picked from commit 7405bb19fa424ec79c6daaafd986670dc54d7dfe)&lt;/p&gt;</comment>
                            <comment id="17914252" author="varunthacker" created="Fri, 17 Jan 2025 22:25:56 +0000"  >&lt;p&gt;Just posting here to close the loop.&#160;&lt;/p&gt;

&lt;p&gt;A user on the lucene user mailing list had reported a vector query bug &lt;a href=&quot;https://lists.apache.org/thread/xn1xg5szxhrs0sbcy4gmx4cvohy6flvh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/xn1xg5szxhrs0sbcy4gmx4cvohy6flvh.&#160;&lt;/a&gt;I have a local setup where I request `fl=score,sort=id desc` and export 10k rows out of a knn query and can reproduce this bug&lt;/p&gt;

&lt;p&gt;So I started looking into this yesterday and here is my analysis&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The issue reported was introduced in 9.7&lt;/li&gt;
	&lt;li&gt;The commit that caused it was &lt;a href=&quot;https://github.com/apache/solr/commit/cfec121bab2ecfc4c06e20a5533596025ae63d98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/commit/cfec121bab2ecfc4c06e20a5533596025ae63d98&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Even though multi-threading is disabled by default, the collector manager executor changed for single threaded search in that commit. Still very unsure how that subtle change caused it.&lt;/li&gt;
	&lt;li&gt;However the good news is the changes made in this Jira actually fixes the issues reported by the user.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17921917" author="anshumg" created="Tue, 28 Jan 2025 22:17:50 +0000"  >&lt;p&gt;Closing after the 9.8.0 release&lt;/p&gt;</comment>
                            <comment id="17923016" author="dsmiley" created="Sun, 2 Feb 2025 04:01:30 +0000"  >&lt;p&gt;Lucene 9.12 has a fix for this &amp;#8211; &lt;a href=&quot;https://github.com/apache/lucene/pull/13622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene/pull/13622&lt;/a&gt; in which RejectedExecutionException is caught and the task is run.  This is done with a simple Executor wrapper in IndexSearcher&apos;s constructor.  I propose I remove the hack/work-around here in favor leaning on Lucene&apos;s solution &amp;#8211; less for us to maintain.  This brings back a queue size to determine.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13224397">SOLR-13350</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="13607021">SOLR-17648</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13071094" name="build-out2.txt" size="1077040" author="gus" created="Sun, 25 Aug 2024 02:03:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qzqo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>