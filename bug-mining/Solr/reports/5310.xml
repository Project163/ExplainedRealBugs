<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:12:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17863] SolrCore&apos;s perSegmentFingerprintCache Is Not Thread-safe</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17863</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16713&quot; title=&quot;Replace Guava usages with pure Java &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16713&quot;&gt;&lt;del&gt;SOLR-16713&lt;/del&gt;&lt;/a&gt; introduced a race condition into the perSegmentFingerprintCache as it changed it from the &lt;a href=&quot;https://github.com/apache/solr/commit/375ac647ad507638686848c549c30e6c077dca1b#diff-3bf44f923643744a743460bb0f64301618dd7529a602d945fe2f7f193d4cdde0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thread-safe guava implementation to the thread-UNSAFE WeakHashMap&lt;/a&gt;. This flew under the radar for some time because this map previously had very little contention between threads. However after &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17756&quot; title=&quot;Parallelize calculation of index fingerprint across segments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17756&quot;&gt;&lt;del&gt;SOLR-17756&lt;/del&gt;&lt;/a&gt; we turbo-charged the race after parallelizing at a much more granular level upstream of this call. The net effect is that WeakHashMap:put can get stuck in an infinite-loop (probably due to a cycle in the underlying linked-list that it modifies):&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13077986/13077986_image-2025-08-14-11-29-04-739.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13077985/13077985_image-2025-08-14-11-29-42-832.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13626391">SOLR-17863</key>
            <summary>SolrCore&apos;s perSegmentFingerprintCache Is Not Thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kotman12">Luke Kot-Zaniewski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 14 Aug 2025 15:30:36 +0000</created>
                <updated>Fri, 7 Nov 2025 08:38:07 +0000</updated>
                            <resolved>Thu, 21 Aug 2025 20:00:07 +0000</resolved>
                                    <version>9.3</version>
                    <version>9.8.1</version>
                                    <fixVersion>9.10</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="18013937" author="JIRAUSER309589" created="Thu, 14 Aug 2025 15:36:10 +0000"  >&lt;p&gt;+1 this was leading to a nasty bug in which replicas were holding leader election hostage until a timeout finally triggers on shards.&lt;/p&gt;</comment>
                            <comment id="18013939" author="risdenk" created="Thu, 14 Aug 2025 15:42:40 +0000"  >&lt;p&gt;Ouch sorry about that. It looks like wrapping WeakHashMap with Collections.synchronizedMap() would be just fine here?&lt;/p&gt;</comment>
                            <comment id="18013940" author="risdenk" created="Thu, 14 Aug 2025 15:43:45 +0000"  >&lt;p&gt;Another option that might be even better is using Caffeine cache potentially - &lt;a href=&quot;https://github.com/ben-manes/caffeine/wiki/Eviction#reference-based&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ben-manes/caffeine/wiki/Eviction#reference-based&lt;/a&gt; since we already use that dependency elsewhere.&lt;/p&gt;</comment>
                            <comment id="18013947" author="JIRAUSER304885" created="Thu, 14 Aug 2025 16:15:37 +0000"  >&lt;p&gt;No worries &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krisden&quot; class=&quot;user-hover&quot; rel=&quot;krisden&quot;&gt;krisden&lt;/a&gt;&#160; .. I&apos;m looking to raise a PR. And yea .. Matt and I were looking at caffeine for the more granular locks .. will see if it is worth the overhead.&lt;/p&gt;</comment>
                            <comment id="18014444" author="dsmiley" created="Sun, 17 Aug 2025 20:40:03 +0000"  >&lt;p&gt;The analysis as depicted in the description was well researched. &#160;Thanks for tracking this down with a straight-forward fix.&lt;/p&gt;</comment>
                            <comment id="18014625" author="JIRAUSER304885" created="Mon, 18 Aug 2025 14:16:01 +0000"  >&lt;p&gt;Thanks, also need to credit &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mlbiscoc&quot; class=&quot;user-hover&quot; rel=&quot;mlbiscoc&quot;&gt;mlbiscoc&lt;/a&gt; for his work on this.&lt;/p&gt;</comment>
                            <comment id="18015480" author="jira-bot" created="Thu, 21 Aug 2025 16:57:41 +0000"  >&lt;p&gt;Commit 4659f9b1f053d091d06c47e6a9cc96e4bc6b2a5c in solr&apos;s branch refs/heads/main from Luke Kot-Zaniewski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=4659f9b1f05&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=4659f9b1f05&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17863&quot; title=&quot;SolrCore&amp;#39;s perSegmentFingerprintCache Is Not Thread-safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17863&quot;&gt;&lt;del&gt;SOLR-17863&lt;/del&gt;&lt;/a&gt;: fix per segment fingerprint cache race (#3477)&lt;/p&gt;

&lt;p&gt;Fix race condition in SolrCore&apos;s fingerprint cache which caused leader election to hang&lt;/p&gt;</comment>
                            <comment id="18015485" author="jira-bot" created="Thu, 21 Aug 2025 17:23:05 +0000"  >&lt;p&gt;Commit 764aff6cf5d5a3827a2c1376c5c89719abf86d21 in solr&apos;s branch refs/heads/branch_9x from Luke Kot-Zaniewski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=764aff6cf5d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=764aff6cf5d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17863&quot; title=&quot;SolrCore&amp;#39;s perSegmentFingerprintCache Is Not Thread-safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17863&quot;&gt;&lt;del&gt;SOLR-17863&lt;/del&gt;&lt;/a&gt;: fix per segment fingerprint cache race (#3477)&lt;/p&gt;

&lt;p&gt;Fix race condition in SolrCore&apos;s fingerprint cache which caused leader election to hang&lt;/p&gt;</comment>
                            <comment id="18036131" author="janhoy" created="Fri, 7 Nov 2025 08:38:07 +0000"  >&lt;p&gt;Closing after the 9.10.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13529440">SOLR-16713</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13617486">SOLR-17756</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13077986" name="image-2025-08-14-11-29-04-739.png" size="165283" author="kotman12" created="Thu, 14 Aug 2025 15:29:05 +0000"/>
                            <attachment id="13077985" name="image-2025-08-14-11-29-42-832.png" size="50119" author="kotman12" created="Thu, 14 Aug 2025 15:29:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1x9e8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>