<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:39:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5241] SimplePostToolTest is slow on some systmes - likely due to hostname resolution of &quot;example.com&quot;</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5241</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;As noted by Shai on the dev @lucene list, SimplePostToolTest is ridiculously slow when he ran from ant, but only takes 1 second in his IDE.&lt;/p&gt;

&lt;p&gt;problem seems to be relate to the URL class attempting to response &quot;example.com&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12668529">SOLR-5241</key>
            <summary>SimplePostToolTest is slow on some systmes - likely due to hostname resolution of &quot;example.com&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Sep 2013 18:44:52 +0000</created>
                <updated>Mon, 9 May 2016 18:57:58 +0000</updated>
                            <resolved>Mon, 16 Sep 2013 16:47:55 +0000</resolved>
                                                    <fixVersion>4.6</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13766791" author="hossman" created="Fri, 13 Sep 2013 18:46:38 +0000"  >&lt;p&gt;patch switching all usage of example.com to a lookback IP.&lt;/p&gt;

&lt;p&gt;this makes the entire test class take 2 seconds on my system (as 6 minutes before this)&lt;/p&gt;</comment>
                            <comment id="13766811" author="rcmuir" created="Fri, 13 Sep 2013 18:57:56 +0000"  >&lt;p&gt;Won&apos;t this still be an issue for jenkins runs because even loopback addresses are blackholed?&lt;/p&gt;</comment>
                            <comment id="13766818" author="dweiss" created="Fri, 13 Sep 2013 19:03:24 +0000"  >&lt;p&gt;Yeah... maybe that fake:// protocol handler is actually a sensible idea for such tests.&lt;/p&gt;</comment>
                            <comment id="13766823" author="hossman" created="Fri, 13 Sep 2013 19:05:27 +0000"  >&lt;p&gt;I don&apos;t think so, but maybe i don&apos;t fully understand what the FreeBSD blackhole does.&lt;/p&gt;

&lt;p&gt;The test never attempts to open any sockets to these URL objects &amp;#8211; the problem so far (that i can see) is just that by nature of being java.net.URL, there is a DNS check when the equals/hashCode methods get used and that seems to be the speed problem when the urls contain &quot;example.com&quot; ... so i figured using a &quot;safe&quot; IP would prevent that...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.eishay.com/2008/04/javas-url-little-secret.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.eishay.com/2008/04/javas-url-little-secret.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;is there any reason the freebsd blackhole would affect dns lookups on &quot;127.42.42.42&quot; even if the URL class did decide to try to &quot;resolve&quot; that IP as a hostname (i don&apos;t think it does) ?&lt;/p&gt;</comment>
                            <comment id="13766827" author="hossman" created="Fri, 13 Sep 2013 19:08:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;maybe that fake:// protocol handler is actually a sensible idea for such tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure, but i think the URL class would still try to resolve the hostname portion of the URL, even if we registered our own fake protocol.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;I really don&apos;t see how the blackhole could affect this even if it did block dns lookups, since no lookup should ever happen with an ip specified, but if it does then i think the whole test just needs re-written not to use the URL class.&lt;/p&gt;</comment>
                            <comment id="13766835" author="dweiss" created="Fri, 13 Sep 2013 19:13:54 +0000"  >&lt;p&gt;I&apos;d have to check, I don&apos;t remember. Looking at this it seems you could write a custom parsing routine &amp;#8211;&lt;br/&gt;
&lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/net/URLStreamHandler.html#parseURL(java.net.URL&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/7/docs/api/java/net/URLStreamHandler.html#parseURL(java.net.URL&lt;/a&gt;, java.lang.String, int, int)&lt;/p&gt;

&lt;p&gt;but this may be an overkill.&lt;/p&gt;</comment>
                            <comment id="13766840" author="rcmuir" created="Fri, 13 Sep 2013 19:19:34 +0000"  >&lt;p&gt;why is it trying to resolve the host? Is it so that it can then try to connect to it and the test expects that this will fail?&lt;/p&gt;

&lt;p&gt;Its the latter part that will cause the issue: use ips like &lt;span class=&quot;error&quot;&gt;&amp;#91;ff01::114&amp;#93;&lt;/span&gt; instead.&lt;/p&gt;</comment>
                            <comment id="13766844" author="rcmuir" created="Fri, 13 Sep 2013 19:21:43 +0000"  >&lt;p&gt;and if you really just need a URL, why not use &lt;a href=&quot;file://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://&lt;/a&gt;....&lt;/p&gt;</comment>
                            <comment id="13766874" author="shaie" created="Fri, 13 Sep 2013 19:55:49 +0000"  >&lt;p&gt;With this patch, the test runs for 1.8-3.2s (varies, but &lt;b&gt;much&lt;/b&gt; faster than before).&lt;/p&gt;</comment>
                            <comment id="13766913" author="hossman" created="Fri, 13 Sep 2013 20:36:02 +0000"  >&lt;p&gt;FYI: today is the first time i&apos;ve looked at this test before, so take all of my comments with a grain of salt...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;why is it trying to resolve the host? Is it so that it can then try to connect to it and the test expects that this will fail?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;From what i can tell, &lt;b&gt;nothing&lt;/b&gt; in the test, that i can see, is trying to resolve the hostname or IP or connect to any of these URLs.  A &quot;MockPageFetcher&quot; is explicitly plugged into the SimplePostTool when used in the test to mock out the HTTP communication to prevent this.&lt;/p&gt;

&lt;p&gt;The problem (again: as far as i can tell) is entirely because the tests (and underlying code in SimplePostTool) use the java.net.URL class, which can/will attempt hostname resolution of DNS names used in URLs under the covers in some cases &amp;#8211; notable anytime the URL.equals() or URL.hashCode methods are called.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;use ips like &lt;span class=&quot;error&quot;&gt;&amp;#91;ff01::114&amp;#93;&lt;/span&gt; instead.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve got no problem doing that if you think it makes a diff &amp;#8211; but just so i understand: can you explain why that is better then 127.42.42.42 ?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if you really just need a URL, why not use &lt;a href=&quot;file://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://&lt;/a&gt;....&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That might work, but the SimplePostTool actually supports diff options for dealing with local files vs remote web urls, and the test&apos;s MockPageFetcher actually simulates servers that response with diff HTTP status codes, so i&apos;m not sure if using &quot;file://&quot; will work and/or test the same things.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;attaching an updated patch using &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;ff01::114&amp;#93;&lt;/span&gt;&quot; instead of &quot;127.42.42.42&quot; per rmuir&apos;s request.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shaie&quot; class=&quot;user-hover&quot; rel=&quot;shaie&quot;&gt;shaie&lt;/a&gt;: does this still run &quot;fast&quot; for you?&lt;/p&gt;

&lt;p&gt;any objections from anyone to be committing this?&lt;/p&gt;</comment>
                            <comment id="13767328" author="rcmuir" created="Sat, 14 Sep 2013 02:49:33 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;ve got no problem doing that if you think it makes a diff &#8211; but just so i understand: can you explain why that is better then 127.42.42.42 ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;its specifically allocated for test purposes and wont be routed if something tries to make a connection, and will fail fast with protocol not supported, or worst case no route to host... everywhere, not just jenkins.&lt;/p&gt;

&lt;p&gt;in jenkins specifically, tests can &lt;b&gt;never&lt;/b&gt; try to connect to an unbound port and expected a connection refused, it will just hang for a huge amount of time until it finally times out.&lt;/p&gt;
</comment>
                            <comment id="13767351" author="shaie" created="Sat, 14 Sep 2013 03:45:01 +0000"  >&lt;p&gt;This still runs fast, but a bit slower than with the previous patch: 5s from Ant. However, with this patch (I haven&apos;t checked previous patch), Eclipse runs faster than before: 0.1s (vs 1s). I&apos;ll try to get to the bottom of it, though let&apos;s commit this (or previous) patch, because it&apos;s already a huge improvement.&lt;/p&gt;</comment>
                            <comment id="13767367" author="shaie" created="Sat, 14 Sep 2013 04:32:51 +0000"  >&lt;p&gt;Hoss, see my comments on the thread. Seems to be related to our tests.policy security settings. I don&apos;t mind if you commit the patch, but maybe if there&apos;s a simple solution, we don&apos;t need to change the test.&lt;/p&gt;</comment>
                            <comment id="13767368" author="rcmuir" created="Sat, 14 Sep 2013 04:44:03 +0000"  >&lt;p&gt;if the test violates the security settings, then SecurityException would be thrown.&lt;/p&gt;

&lt;p&gt;So maybe there is a bug in the solr code hiding/masking exceptions.&lt;/p&gt;</comment>
                            <comment id="13767404" author="dweiss" created="Sat, 14 Sep 2013 07:49:31 +0000"  >&lt;p&gt;While I appreciate Hoss&apos;s solution I think what Robert said &amp;#8211; we should get to the bottom of this problem, this difference in runtime is not easily explained and it may lead to a bigger can of worms.&lt;/p&gt;</comment>
                            <comment id="13767411" author="thetaphi" created="Sat, 14 Sep 2013 08:16:47 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
as I said in response to Shai&apos;s e-mail: The problem may indeed be related to the security policy. To check if a connection is allowed, the security manager has to resolve dns. As this gets a not found or whatever error, it will not throw a security exception. This also explains why there is a runtime env difference: With Eclipse the security manager is not used, with ANT it is.&lt;br/&gt;
The fix should be not to use hostnames for invalid URLs and use the same strategy like in Solr Cloud tests: Use a non-routeable IPv6 address. To me the problem is exactly what Robert and I thought is the reason.&lt;/p&gt;

&lt;p&gt;See BaseDistributedTestCase:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deadServers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {&lt;span class=&quot;code-quote&quot;&gt;&quot;[ff01::114]:33332&quot;&lt;/span&gt; + context, 
                                     &lt;span class=&quot;code-quote&quot;&gt;&quot;[ff01::083]:33332&quot;&lt;/span&gt; + context, 
                                     &lt;span class=&quot;code-quote&quot;&gt;&quot;[ff01::213]:33332&quot;&lt;/span&gt; + context};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please use these URLs and the problem should be gone. Real DNS names out of our control are bad to emulate failures. What happens if soebody links example.com to real IP adresses?&lt;/p&gt;</comment>
                            <comment id="13767421" author="thetaphi" created="Sat, 14 Sep 2013 09:08:18 +0000"  >&lt;p&gt;From analyzing the test:&lt;br/&gt;
The main probelm is just the DNS resolve. We can really use any IP (IPv6 or IPv4) here, because the stream handler never actually connects to anywhere. Theoretically we could also use 127.0.0.1, the blackhole is not related here, because it just looks up hostnames. The actual connection is prevented by the stream handler. So finally we can use any numeric IP, just no host name.&lt;/p&gt;</comment>
                            <comment id="13767484" author="dweiss" created="Sat, 14 Sep 2013 13:31:14 +0000"  >&lt;p&gt;Thanks Uwe.&lt;/p&gt;</comment>
                            <comment id="13768474" author="jira-bot" created="Mon, 16 Sep 2013 16:39:30 +0000"  >&lt;p&gt;Commit 1523725 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1523725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1523725&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5241&quot; title=&quot;SimplePostToolTest is slow on some systmes - likely due to hostname resolution of &amp;quot;example.com&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5241&quot;&gt;&lt;del&gt;SOLR-5241&lt;/del&gt;&lt;/a&gt;: Fix SimplePostToolTest performance problem - implicit DNS lookups&lt;/p&gt;</comment>
                            <comment id="13768478" author="jira-bot" created="Mon, 16 Sep 2013 16:43:16 +0000"  >&lt;p&gt;Commit 1523726 from hossman@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1523726&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1523726&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5241&quot; title=&quot;SimplePostToolTest is slow on some systmes - likely due to hostname resolution of &amp;quot;example.com&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5241&quot;&gt;&lt;del&gt;SOLR-5241&lt;/del&gt;&lt;/a&gt;: Fix SimplePostToolTest performance problem - implicit DNS lookups (merge r1523725)&lt;/p&gt;</comment>
                            <comment id="13768481" author="hossman" created="Mon, 16 Sep 2013 16:47:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;... Theoretically we could also use 127.0.0.1, the blackhole is not related here, because it just looks up hostnames. ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;we could, this was my point earlier when i asked rmuir why &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;ff01::114&amp;#93;&lt;/span&gt;&quot; was better - since we&apos;re never opening a socket i didn&apos;t understand the diff.&lt;/p&gt;

&lt;p&gt;now that i do understand the diff however, i definitely think &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;ff01::114&amp;#93;&lt;/span&gt;&quot; is better &amp;#8211; not because of anything in the test now, but because it helps protect us from the risk of someone working on the test in the future and accidentally changing something so that it &lt;b&gt;does&lt;/b&gt; start trying to open sockets.&lt;/p&gt;

&lt;p&gt;so i&apos;ve committed the most recent patch as is.&lt;/p&gt;

&lt;p&gt;Thanks everybody for your help.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12603095" name="SOLR-5241.patch" size="10293" author="hossman" created="Fri, 13 Sep 2013 20:36:02 +0000"/>
                            <attachment id="12603072" name="SOLR-5241.patch" size="10348" author="hossman" created="Fri, 13 Sep 2013 18:46:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348463</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1o33j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348760</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>