<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:05:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7585] ConcurrentLFUCache throws NoSuchElementException under a write-heavy load</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7585</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Under a write-heavy load &lt;tt&gt;ConcurrentLFUCache&lt;/tt&gt; throws &lt;tt&gt;NoSuchElementException&lt;/tt&gt;. The problem lies within &lt;tt&gt;org.apache.solr.util.ConcurrentLFUCache#put&lt;/tt&gt; method, which allows for a race condition between the check and the call to &lt;tt&gt;markAndSweep&lt;/tt&gt; method. Despite that a thread must acquire a lock to perform sweeping, it&apos;s still possible that multiple threads successfully detected a need for calling markAndSweep. If they execute it sequentially, subsequent runs will fail with &lt;tt&gt;NoSuchElementException&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12832139">SOLR-7585</key>
            <summary>ConcurrentLFUCache throws NoSuchElementException under a write-heavy load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="elyograg">Shawn Heisey</assignee>
                                    <reporter username="maciej.zasada">Maciej Zasada</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 May 2015 11:38:59 +0000</created>
                <updated>Mon, 9 May 2016 18:56:28 +0000</updated>
                            <resolved>Sun, 24 May 2015 14:26:33 +0000</resolved>
                                    <version>5.1</version>
                                    <fixVersion>5.2</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14556013" author="maciej.zasada" created="Fri, 22 May 2015 11:41:24 +0000"  >&lt;p&gt;Attached a patch containing a test case + a fix that mitigates the race condition. Cheers!&lt;/p&gt;</comment>
                            <comment id="14556707" author="elyograg" created="Fri, 22 May 2015 19:44:39 +0000"  >&lt;p&gt;The LFU cache implementation is my code, but I didn&apos;t write it from scratch.  I started with the existing LRU code.  Now that I look at ConcurrentLRUCache, the markAndSweep method there seems to be quite a bit different, and I can&apos;t remember what I actually did or whether the differences came afterwards.&lt;/p&gt;

&lt;p&gt;I tried adding just the test so I could see if the test fails without the patch.  I did so on branch_5x, which is how I discovered that the test uses a lambda expression &amp;#8211; it won&apos;t compile on branch_5x because the build is targeted for a 1.7 compile version, and lamba expressions require 1.8.  Since I haven&apos;t yet wrestled with lambda expressions, I have no idea what they actually do.  Can you rewrite the test so it&apos;s compatible with Java 7?&lt;/p&gt;</comment>
                            <comment id="14557338" author="maciej.zasada" created="Sat, 23 May 2015 13:33:50 +0000"  >&lt;p&gt;Of course, latest patch contains same test compatible with Java 7. My bad, I tested against &lt;tt&gt;trunk&lt;/tt&gt; (which is now on Java 8) instead of a 5.x branch. Cheers!&lt;/p&gt;</comment>
                            <comment id="14557422" author="elyograg" created="Sat, 23 May 2015 16:32:22 +0000"  >&lt;p&gt;Alternate patch that checks the size of the TreeSet when deciding whether to simple add() or do a more complicated check involving remove/add.&lt;/p&gt;

&lt;p&gt;This feels like it fixes the underlying problem, rather than exiting the code early.&lt;/p&gt;

&lt;p&gt;The patch also gets rid of a bunch of warnings about parameterization of objects, and one warning about an unused variable.  I chose to suppress the warning instead of removing the variable, because it&apos;s a variable that might find a use later.&lt;/p&gt;</comment>
                            <comment id="14557504" author="maciej.zasada" created="Sat, 23 May 2015 19:59:26 +0000"  >&lt;p&gt;Personally I like exiting the code early. If I understand correctly, new implementation will always evict at least one entry, which means cache size may drop below &lt;tt&gt;lowerWaterMark&lt;/tt&gt; (which somehow brakes a contract). To fix underlying problem we should get rid of a race condition at all, but I haven&apos;t measure the performance impact of such change. Moreover, first approach has 2 additional benefits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;not producing additional garbage&lt;/li&gt;
	&lt;li&gt;not executing unnecessary code (if cache size is below &lt;tt&gt;upperWaterMark&lt;/tt&gt;, there&apos;s no need to evict anything)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;both seem to be important for a cache. WDYT?&lt;/p&gt;</comment>
                            <comment id="14557511" author="elyograg" created="Sat, 23 May 2015 20:14:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;both seem to be important for a cache. WDYT?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The benefits you noted certainly do sound like good things, but it looks like markAndSweep was designed to reduce the cache size to lowerWaterMark.  Is it acceptable to avoid eviction if the current cache size is somewhere between the two watermarks?  Will anything strange happen in a situation where a cache is defined with settings where any of the sizes/watermarks are not different numbers?&lt;/p&gt;

&lt;p&gt;FYI, the entire LFUCache implementation is due for replacement, because it&apos;s a very slow and naive implementation, and I figured out a better way to do it.  See &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3393&quot; title=&quot;Implement an optimized LFUCache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3393&quot;&gt;&lt;del&gt;SOLR-3393&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14557517" author="maciej.zasada" created="Sat, 23 May 2015 20:36:49 +0000"  >&lt;p&gt;Yes, I saw &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3393&quot; title=&quot;Implement an optimized LFUCache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3393&quot;&gt;&lt;del&gt;SOLR-3393&lt;/del&gt;&lt;/a&gt; before, but I assumed it will take a while to deprecate and remove the old class, and we&apos;re currently experiencing some exceptions because of this race condition &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Having in mind that you&apos;re working on more performant LFU cache, I tried to make changes as small and noninvasive as possible.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it looks like markAndSweep was designed to reduce the cache size to lowerWaterMark.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Exactly. I believe that your change will actually reduce (sometimes) the cache size to be equal to &lt;tt&gt;lowerWaterMark -1&lt;/tt&gt;, instead of equal to &lt;tt&gt;lowerWaterMark&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is it acceptable to avoid eviction if the current cache size is somewhere between the two watermarks?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Eviction will be only avoided if the size was less than or equal to &lt;tt&gt;upperWaterMark&lt;/tt&gt;, which is exactly the same condition as in &lt;tt&gt;org.apache.solr.util.ConcurrentLFUCache#put&lt;/tt&gt; method (L#139), where it&apos;s decided whether to call &lt;tt&gt;markAndSweep&lt;/tt&gt; at all or not. Essentially, the same condition is checked after acquiring a lock to mitigate a race condition.&lt;/p&gt;</comment>
                            <comment id="14557540" author="elyograg" created="Sat, 23 May 2015 21:48:03 +0000"  >&lt;p&gt;Now both checks are present.  The method will abort if the cache is already below upperWaterMark, and the code further down will avoid executing the TreeSet#first() method when the set is empty, which is where the NoSuchElementException is actually thrown.&lt;/p&gt;

&lt;p&gt;I hope the comments are clear and correct.&lt;/p&gt;</comment>
                            <comment id="14557555" author="maciej.zasada" created="Sat, 23 May 2015 22:18:04 +0000"  >&lt;p&gt;Looks good to me, +1. Cheers!&lt;/p&gt;</comment>
                            <comment id="14557567" author="elyograg" created="Sat, 23 May 2015 23:10:45 +0000"  >&lt;p&gt;The test fails precommit.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;forbidden-apis&amp;#93;&lt;/span&gt; Forbidden method invocation: java.util.concurrent.Executors#newFixedThreadPool(int) &lt;span class=&quot;error&quot;&gt;&amp;#91;Spawns threads with vague names; use a custom thread factory (Lucene&amp;#39;s NamedThreadFactory, Solr&amp;#39;s DefaultSolrThreadFactory) and name threads so that you can tell (by its name) which executor it is associated with&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;forbidden-apis&amp;#93;&lt;/span&gt;   in org.apache.solr.search.TestLFUCache (TestLFUCache.java:371)&lt;/p&gt;

&lt;p&gt;I&apos;m looking at existing uses of DefaultSolrThreadFactory trying to figure out how to adapt it to this test code, but it&apos;s not making sense to me.&lt;/p&gt;</comment>
                            <comment id="14557572" author="elyograg" created="Sat, 23 May 2015 23:26:44 +0000"  >&lt;p&gt;I think i figured it out.  If precommit passes now, I&apos;ll have a new patch momentarily.&lt;/p&gt;</comment>
                            <comment id="14557576" author="elyograg" created="Sat, 23 May 2015 23:47:35 +0000"  >&lt;p&gt;Apparently 6 threads is not enough to trigger the bug.  When I ran the test (without the fix) on a system with three cores, the test passed.  When I hard-coded the number of threads in the test to 8, then the test failed as expected.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maciej.zasada&quot; class=&quot;user-hover&quot; rel=&quot;maciej.zasada&quot;&gt;maciej.zasada&lt;/a&gt;, should we hard-code the number of threads in the test to a number like 8 or 10?&lt;/p&gt;</comment>
                            <comment id="14557580" author="elyograg" created="Sun, 24 May 2015 00:07:16 +0000"  >&lt;p&gt;New patch against trunk.  Used DefaultSolrThreadFactory to fix the precommit.  Also hard-coded the number of threads in the new test to 10 so that the unpatched ConcurrentLFUCache implementation fails the test even on systems with less than four CPUs.&lt;/p&gt;

&lt;p&gt;The CHANGES.txt assumes that the fix is going into version 5.2.  I&apos;ve asked the release manager for 5.2 whether this fix is OK to backport.&lt;/p&gt;</comment>
                            <comment id="14557684" author="maciej.zasada" created="Sun, 24 May 2015 09:16:24 +0000"  >&lt;p&gt;+1 for a fixed thread count and DefaultSolrThreadFactory. Cheers!&lt;/p&gt;</comment>
                            <comment id="14557734" author="jira-bot" created="Sun, 24 May 2015 13:20:05 +0000"  >&lt;p&gt;Commit 1681449 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1681449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1681449&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7585&quot; title=&quot;ConcurrentLFUCache throws NoSuchElementException under a write-heavy load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7585&quot;&gt;&lt;del&gt;SOLR-7585&lt;/del&gt;&lt;/a&gt;: Fix NoSuchElementException in LFUCache&lt;/p&gt;</comment>
                            <comment id="14557739" author="jira-bot" created="Sun, 24 May 2015 13:40:53 +0000"  >&lt;p&gt;Commit 1681453 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1681453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1681453&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7585&quot; title=&quot;ConcurrentLFUCache throws NoSuchElementException under a write-heavy load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7585&quot;&gt;&lt;del&gt;SOLR-7585&lt;/del&gt;&lt;/a&gt;: Fix NoSuchElementException in LFUCache (merge trunk r1681449)&lt;/p&gt;</comment>
                            <comment id="14557743" author="jira-bot" created="Sun, 24 May 2015 13:56:32 +0000"  >&lt;p&gt;Commit 1681456 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_5_2&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1681456&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1681456&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7585&quot; title=&quot;ConcurrentLFUCache throws NoSuchElementException under a write-heavy load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7585&quot;&gt;&lt;del&gt;SOLR-7585&lt;/del&gt;&lt;/a&gt;: Fix NoSuchElementException in LFUCache (merge trunk r1681449)&lt;/p&gt;</comment>
                            <comment id="14557747" author="elyograg" created="Sun, 24 May 2015 14:26:33 +0000"  >&lt;p&gt;Committed to trunk, branch_5x, and lucene_solr_5_2.  Precommit passed for each.  Also made sure that the new test failed without the fix and passed with the fix.  Thanks for figuring this out, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maciej.zasada&quot; class=&quot;user-hover&quot; rel=&quot;maciej.zasada&quot;&gt;maciej.zasada&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14586884" author="anshumg" created="Mon, 15 Jun 2015 21:43:57 +0000"  >&lt;p&gt;Bulk close for 5.2.0.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12735041" name="SOLR-7585.patch" size="8388" author="elyograg" created="Sun, 24 May 2015 00:07:16 +0000"/>
                            <attachment id="12735035" name="SOLR-7585.patch" size="7509" author="elyograg" created="Sat, 23 May 2015 21:48:03 +0000"/>
                            <attachment id="12735026" name="SOLR-7585.patch" size="4643" author="elyograg" created="Sat, 23 May 2015 16:32:22 +0000"/>
                            <attachment id="12735018" name="SOLR-7585.patch" size="2623" author="maciej.zasada" created="Sat, 23 May 2015 13:33:50 +0000"/>
                            <attachment id="12734804" name="SOLR-7585.patch" size="2691" author="maciej.zasada" created="Fri, 22 May 2015 11:41:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2f3q7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>