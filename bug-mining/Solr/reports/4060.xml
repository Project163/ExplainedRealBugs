<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:35:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12882] Eliminate excessive lambda allocation in FacetFieldProcessorByHashDV.collectValFirstPhase</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12882</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The FacetFieldProcessorByHashDV.collectValFirstPhase method looks like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;private void collectValFirstPhase(int segDoc, long val) throws IOException {
 int slot = table.add(val); // this can trigger a rehash

 // Our countAcc is virtual, so this is not needed:
 // countAcc.incrementCount(slot, 1);

super.collectFirstPhase(segDoc, slot, slotNum -&amp;gt;

{ Comparable value = calc.bitsToValue(val); return new SlotContext(sf.getType().getFieldQuery(null, sf, calc.formatValue(value))); }

);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For each value that is being iterated over there is a lambda allocation that is passed as the slotContext argument to the super.collectFirstPhase method. The lambda can be factored out such that there is only a single instance per FacetFieldProcessorByHashDV instance.&#160;&lt;/p&gt;

&lt;p&gt;The only tradeoff being that the value needs to be looked up from the table in the lambda.&#160; However looking the value up in the table is going to be less expensive than a memory allocation and also the slotContext lambda is only used in&#160;RelatednessAgg and not for any of the field faceting or metrics.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;private void collectValFirstPhase(int segDoc, long val) throws IOException {
  int slot = table.add(val); // this can trigger a rehash

  // Our countAcc is virtual, so this is not needed:
  // countAcc.incrementCount(slot, 1);

  super.collectFirstPhase(segDoc, slot, slotContext);
}

/**
 * SlotContext to use during all {@link SlotAcc} collection.
 *
 * This avoids a memory allocation for each invocation of collectValFirstPhase.
 */
private IntFunction&amp;lt;SlotContext&amp;gt; slotContext = (slotNum) -&amp;gt; {
  long val = table.vals[slotNum];
  Comparable value = calc.bitsToValue(val);
  return new SlotContext(sf.getType().getFieldQuery(null, sf, calc.formatValue(value)));
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;FacetFieldProcessorByArray already follows this same pattern&lt;/p&gt;</description>
                <environment></environment>
        <key id="13192380">SOLR-12882</key>
            <summary>Eliminate excessive lambda allocation in FacetFieldProcessorByHashDV.collectValFirstPhase</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dsmiley">David Smiley</assignee>
                                    <reporter username="tpunder">Tim Underwood</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Oct 2018 21:47:58 +0000</created>
                <updated>Sat, 8 Jun 2019 14:59:14 +0000</updated>
                            <resolved>Thu, 1 Nov 2018 19:10:08 +0000</resolved>
                                    <version>7.5</version>
                                    <fixVersion>7.6</fixVersion>
                                    <component>Facet Module</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16654258" author="tpunder" created="Wed, 17 Oct 2018 21:49:46 +0000"  >&lt;p&gt;Pull request here:&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/476&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16666424" author="elyograg" created="Sun, 28 Oct 2018 14:54:10 +0000"  >&lt;p&gt;From 2018-10-24 on the #solr-dev IRC channel:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;12:22 &amp;lt; tpunder&amp;gt; I have a few Solr Issues I&apos;d like to get reviewed/merged (SOLR-12875, SOLR-12878, SOLR-12882, SOLR-12880).  What&apos;s the best way to go about doing that?
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;These issues look very compelling, especially &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12878&quot; title=&quot;FacetFieldProcessorByHashDV is reconstructing FieldInfos on every instantiation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12878&quot;&gt;&lt;del&gt;SOLR-12878&lt;/del&gt;&lt;/a&gt;.  We&apos;ve been fighting facet performance regression for a while now.  If I had even a sliver of understanding of the code you&apos;re working on, I would help you.  You might want to ping the dev list to raise visibility.&lt;/p&gt;</comment>
                            <comment id="16668664" author="dsmiley" created="Tue, 30 Oct 2018 12:57:14 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I wonder how much this helps? &#160;Did you do benchmarking?&lt;/p&gt;</comment>
                            <comment id="16669586" author="tpunder" created="Wed, 31 Oct 2018 04:33:56 +0000"  >&lt;p&gt;It&apos;s not a huge improvement but I noticed it showing up in YourKit memory allocation profiling:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12946329/12946329_start_-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png&quot; width=&quot;600px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12946329/start_-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12946329/start_-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12946330/12946330_start-2018-10-31_snapshot___Users_tim_Snapshots__-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png&quot; width=&quot;600px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12946330/start-2018-10-31_snapshot___Users_tim_Snapshots__-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12946330/start-2018-10-31_snapshot___Users_tim_Snapshots__-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;My informal benchmarking (I should really setup JMH for this stuff) for one of my facet heavy queries went from ~270-275 requests/second to ~285-293 requests/second for my setup.&lt;/p&gt;

&lt;p&gt;So it&apos;s a very minor improvement.&lt;/p&gt;</comment>
                            <comment id="16672030" author="jira-bot" created="Thu, 1 Nov 2018 19:05:25 +0000"  >&lt;p&gt;Commit cf445ba54998710466a7c6cb489d3162d20d127a in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpunder&quot; class=&quot;user-hover&quot; rel=&quot;tpunder&quot;&gt;tpunder&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cf445ba&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cf445ba&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12882&quot; title=&quot;Eliminate excessive lambda allocation in FacetFieldProcessorByHashDV.collectValFirstPhase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12882&quot;&gt;&lt;del&gt;SOLR-12882&lt;/del&gt;&lt;/a&gt;: Eliminate excessive lambda allocation in json facet FacetFieldProcessorByHashDV.collectValFirstPhase&lt;/p&gt;</comment>
                            <comment id="16672041" author="jira-bot" created="Thu, 1 Nov 2018 19:08:32 +0000"  >&lt;p&gt;Commit 1320db356833a6e4823e29416c388593b027948b in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpunder&quot; class=&quot;user-hover&quot; rel=&quot;tpunder&quot;&gt;tpunder&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1320db3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1320db3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12882&quot; title=&quot;Eliminate excessive lambda allocation in FacetFieldProcessorByHashDV.collectValFirstPhase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12882&quot;&gt;&lt;del&gt;SOLR-12882&lt;/del&gt;&lt;/a&gt;: Eliminate excessive lambda allocation in json facet FacetFieldProcessorByHashDV.collectValFirstPhase&lt;/p&gt;

&lt;p&gt;(cherry picked from commit cf445ba54998710466a7c6cb489d3162d20d127a)&lt;/p&gt;</comment>
                            <comment id="16672050" author="dsmiley" created="Thu, 1 Nov 2018 19:10:08 +0000"  >&lt;p&gt;Thanks Tim.  It&apos;s also nice to see this change is consistent with some of the other classes in this module that do the same thing.&lt;/p&gt;</comment>
                            <comment id="16673298" author="tpunder" created="Fri, 2 Nov 2018 15:48:12 +0000"  >&lt;p&gt;Thanks for merging!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13002831">SOLR-9480</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12946330" name="start-2018-10-31_snapshot___Users_tim_Snapshots__-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png" size="562793" author="tpunder" created="Wed, 31 Oct 2018 04:20:19 +0000"/>
                            <attachment id="12946329" name="start_-_YourKit_Java_Profiler_2017_02-b75_-_64-bit.png" size="715628" author="tpunder" created="Wed, 31 Oct 2018 04:17:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zc07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>