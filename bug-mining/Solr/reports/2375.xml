<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:03:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7109] Indexing threads stuck during network partition can put leader into down state</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7109</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I found this recently while running some Jepsen tests. I found that some threads get stuck on zk operations for a long time in ZkController.updateLeaderInitiatedRecoveryState method and when they wake up they go ahead with setting the LIR state to down. But in the mean time, new leader has been elected and sometimes you&apos;d get into a state where the leader itself is put into recovery causing the shard to reject all writes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12774965">SOLR-7109</key>
            <summary>Indexing threads stuck during network partition can put leader into down state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Feb 2015 17:21:19 +0000</created>
                <updated>Mon, 9 May 2016 18:58:16 +0000</updated>
                            <resolved>Sun, 15 Mar 2015 18:42:15 +0000</resolved>
                                    <version>4.10.3</version>
                    <version>5.0</version>
                                    <fixVersion>5.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14320682" author="markrmiller@gmail.com" created="Fri, 13 Feb 2015 20:09:58 +0000"  >&lt;p&gt;I ran into a similar issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7065&quot; title=&quot;Let a replica become the leader regardless of it&amp;#39;s last published state if all replicas participate in the election process.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7065&quot;&gt;&lt;del&gt;SOLR-7065&lt;/del&gt;&lt;/a&gt; with the new test I have there.&lt;/p&gt;

&lt;p&gt;It&apos;s still exploratory, so I just took that DOWN publish out for the time being.&lt;/p&gt;</comment>
                            <comment id="14343551" author="shalinmangar" created="Mon, 2 Mar 2015 18:39:49 +0000"  >&lt;p&gt;Here&apos;s a patch which uses ZooKeeper &apos;multi&apos; transactions to make sure that the LIR state can be set only when the requesting leader node is still alive. This ensures that regardless of how long the network partition lasts (long GC, whatever), the node setting the LIR state must be the leader or else the LIR state cannot be set.&lt;/p&gt;

&lt;p&gt;Initially I attempted to use the shard leader path as the &apos;exists&apos; check in the &apos;multi&apos; command but this doesn&apos;t work because the leader path is always created fresh which means that it&apos;s version is always 0 and the check always succeeds regardless of who the current leader is. This is why we must use the election&apos;s leader sequence path.&lt;/p&gt;

&lt;p&gt;This is just a first cut of this approach. I intend to refactor some of these LIR methods &amp;#8211; they have become too big. I will also write a test which exercises these new transactional semantics and reproduces the failure.&lt;/p&gt;

&lt;p&gt;Edit - I also remove the replicaUrl parameter from ZkController.ensureReplicaInLeaderInitiatedRecovery because replicaProps were already being passed as a parameter and the replica url can be derived from it.&lt;/p&gt;</comment>
                            <comment id="14360341" author="shalinmangar" created="Fri, 13 Mar 2015 13:35:18 +0000"  >&lt;p&gt;Patch updated to trunk.&lt;/p&gt;

&lt;p&gt;I&apos;ve been testing with Jepsen on trunk with this patch and it has worked very well. Unfortunately, writing a junit test to simulate this failure is proving to be very difficult. I&apos;m inclined to commit this as-is for now so a code review would be appreciated.&lt;/p&gt;

&lt;p&gt;Also note that this patch doesn&apos;t solve the problem of the threads being stuck but it only ensures that the LIR state is written only if the ephemeral sequential election node of the current leader exists.&lt;/p&gt;</comment>
                            <comment id="14360622" author="anshumg" created="Fri, 13 Mar 2015 16:48:27 +0000"  >&lt;p&gt;Looks good Shalin. There&apos;s one thing that I&apos;d like to point:&lt;br/&gt;
You&apos;ve changed the signature of Zkcontroller.ensureReplicaInLeaderInitiatedRecovery(), which is a public method. Though it&apos;s advanced and internal, it&apos;s a public method and might break back-compat for developers.&lt;/p&gt;</comment>
                            <comment id="14361295" author="andyetitmoves" created="Fri, 13 Mar 2015 23:17:04 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14361387" author="yseeley@gmail.com" created="Sat, 14 Mar 2015 00:23:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;You&apos;ve changed the signature of Zkcontroller.ensureReplicaInLeaderInitiatedRecovery(), which is a public method. Though it&apos;s advanced and internal,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats&apos; fine, we should be able to freely change stuff like that.&lt;/p&gt;

&lt;p&gt;Ram, was your +1 echoing Anshum&apos;s concern?&lt;/p&gt;</comment>
                            <comment id="14361527" author="markrmiller@gmail.com" created="Sat, 14 Mar 2015 02:23:59 +0000"  >&lt;p&gt;I think we need to open an issue to start using annotations for what API&apos;s you can count on in Java. We can start labeling most of them internal and open them based on demand, maturity, sensibility, but a plugin writer should have an idea of what API&apos;s they can count on and still get support for things like rolling upgrades. Perhaps that just most of the basic SolrCore methods and ZKStateReader methods, but it should be something over time. Eventually it would be nice if basic plugins could survive rolling upgrades if they use some common simple API&apos;s.&lt;/p&gt;

&lt;p&gt;Given where things are currently though, these particular types of internal methods - especially those on ZkController, are still under considerable flux.&lt;/p&gt;</comment>
                            <comment id="14361714" author="andyetitmoves" created="Sat, 14 Mar 2015 11:10:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Ram, was your +1 echoing Anshum&apos;s concern?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, no, it was a +1 overall for the patch.&lt;/p&gt;

&lt;p&gt;I agree with you that we should be able to freely change this stuff. As Mark mentions we need to decide on what is considered as API. Personally I feel we should guarantee only the methods and classes used for anything pluggable and in SolrJ (even in SolrJ we should perhaps mark a few things internal). I know people depend on other things, but we shouldn&apos;t be burdened with back compact on those.&lt;/p&gt;</comment>
                            <comment id="14362001" author="anshumg" created="Sat, 14 Mar 2015 20:09:42 +0000"  >&lt;p&gt;Sure, I&apos;m +1 about Mark&apos;s idea and +1 on the patch too.&lt;/p&gt;</comment>
                            <comment id="14362493" author="jira-bot" created="Sun, 15 Mar 2015 18:40:52 +0000"  >&lt;p&gt;Commit 1666825 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1666825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1666825&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7109&quot; title=&quot;Indexing threads stuck during network partition can put leader into down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7109&quot;&gt;&lt;del&gt;SOLR-7109&lt;/del&gt;&lt;/a&gt;: Indexing threads stuck during network partition can put leader into down state&lt;/p&gt;</comment>
                            <comment id="14362494" author="jira-bot" created="Sun, 15 Mar 2015 18:41:27 +0000"  >&lt;p&gt;Commit 1666826 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1666826&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1666826&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7109&quot; title=&quot;Indexing threads stuck during network partition can put leader into down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7109&quot;&gt;&lt;del&gt;SOLR-7109&lt;/del&gt;&lt;/a&gt;: Indexing threads stuck during network partition can put leader into down state&lt;/p&gt;</comment>
                            <comment id="14362495" author="shalinmangar" created="Sun, 15 Mar 2015 18:42:15 +0000"  >&lt;p&gt;Thanks everyone!&lt;/p&gt;</comment>
                            <comment id="14362750" author="jira-bot" created="Mon, 16 Mar 2015 05:07:54 +0000"  >&lt;p&gt;Commit 1666863 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1666863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1666863&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7109&quot; title=&quot;Indexing threads stuck during network partition can put leader into down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7109&quot;&gt;&lt;del&gt;SOLR-7109&lt;/del&gt;&lt;/a&gt;: fix java7 compile error&lt;/p&gt;</comment>
                            <comment id="14362787" author="shalinmangar" created="Mon, 16 Mar 2015 06:03:41 +0000"  >&lt;p&gt;Thanks for fixing the Java7 error, Yonik!&lt;/p&gt;</comment>
                            <comment id="14495217" author="thelabdude" created="Wed, 15 Apr 2015 00:30:06 +0000"  >&lt;p&gt;Bulk close after 5.1 release&lt;/p&gt;</comment>
                            <comment id="14899971" author="markrmiller@gmail.com" created="Sun, 20 Sep 2015 15:16:27 +0000"  >&lt;p&gt;FYI, we found an issue with this improvement because of how it tries to ensure only a legal replica can put anoither replica into LIR. Working on a fix here in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8069&quot; title=&quot;Ensure that only the valid ZooKeeper registered leader can put a replica into Leader Initiated Recovery.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8069&quot;&gt;&lt;del&gt;SOLR-8069&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12782000">SOLR-7245</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12875394">SOLR-8069</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12704430" name="SOLR-7109.patch" size="17732" author="shalin" created="Fri, 13 Mar 2015 13:35:18 +0000"/>
                            <attachment id="12701937" name="SOLR-7109.patch" size="13928" author="shalin" created="Mon, 2 Mar 2015 18:39:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25m0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>