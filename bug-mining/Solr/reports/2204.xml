<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:59:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3881] frequent OOM in LanguageIdentifierUpdateProcessor</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3881</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We are seeing frequent failures from Solr causing it to OOM. Here is the stack trace we observe when this happens:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.OutOfMemoryError: Java heap space
        at java.util.Arrays.copyOf(Arrays.java:2882)
        at java.lang.AbstractStringBuilder.expandCapacity(AbstractStringBuilder.java:100)
        at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:390)
        at java.lang.StringBuffer.append(StringBuffer.java:224)
        at org.apache.solr.update.processor.LanguageIdentifierUpdateProcessor.concatFields(LanguageIdentifierUpdateProcessor.java:286)
        at org.apache.solr.update.processor.LanguageIdentifierUpdateProcessor.process(LanguageIdentifierUpdateProcessor.java:189)
        at org.apache.solr.update.processor.LanguageIdentifierUpdateProcessor.processAdd(LanguageIdentifierUpdateProcessor.java:171)
        at org.apache.solr.handler.BinaryUpdateRequestHandler$2.update(BinaryUpdateRequestHandler.java:90)
        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readOuterMostDocIterator(JavaBinUpdateRequestCodec.java:140)
        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readIterator(JavaBinUpdateRequestCodec.java:120)
        at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:221)
        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readNamedList(JavaBinUpdateRequestCodec.java:105)
        at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:186)
        at org.apache.solr.common.util.JavaBinCodec.unmarshal(JavaBinCodec.java:112)
        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec.unmarshal(JavaBinUpdateRequestCodec.java:147)
        at org.apache.solr.handler.BinaryUpdateRequestHandler.parseAndLoadDocs(BinaryUpdateRequestHandler.java:100)
        at org.apache.solr.handler.BinaryUpdateRequestHandler.access$000(BinaryUpdateRequestHandler.java:47)
        at org.apache.solr.handler.BinaryUpdateRequestHandler$1.load(BinaryUpdateRequestHandler.java:58)
        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:59)
        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)
        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1540)
        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:435)
        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:256)
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1337)
        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:484)
        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)
        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:524)
        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:233)
        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1065)
        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:413)
        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:192)
        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:999)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;CentOS 6.x, JDK 1.6, (java -server -Xms2G -Xmx2G -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=....)&lt;/p&gt;</environment>
        <key id="12608913">SOLR-3881</key>
            <summary>frequent OOM in LanguageIdentifierUpdateProcessor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarowe">Steven Rowe</assignee>
                                    <reporter username="rtulloh">Rob Tulloh</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Sep 2012 18:21:51 +0000</created>
                <updated>Wed, 2 Oct 2019 17:30:18 +0000</updated>
                            <resolved>Thu, 26 Feb 2015 12:44:36 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.10.4</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13462943" author="rtulloh" created="Tue, 25 Sep 2012 16:44:39 +0000"  >&lt;p&gt;One possible solution is to limit the size of the string that is selected for concatenation. I don&apos;t know if there is a good way to guess which part of the string to select. Just picking the first 64K seems like a reasonable solution with the lack of any heuristics to suggest otherwise. Thoughts?&lt;/p&gt;

&lt;p&gt;In LanguageIdentifierUpdateProcessor.concatFields:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;          String fieldValue = (String) doc.getFieldValue(fieldName);
          if (fieldValue != null &amp;amp;&amp;amp; fieldValue.length() &amp;gt; 0) {
             fieldValue = fieldValue.substring(0,Math.min(65536,fieldValue.length()));
          }
          sb.append(fieldValue);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13476584" author="hossman" created="Mon, 15 Oct 2012 23:49:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;One possible solution is to limit the size of the string that is selected for concatenation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t know if there is anyway to make LanguageIdentifierUpdateProcessor more memory efficient (in particular, i&apos;m not sure why it needs to concat the field values instead of operating on them directly) but if you want to give langId just the first N characters of another field: that should already be possible w/o cod changes by wiring together the  CloneFieldUpdateProcessorFactory with the TruncateFieldUpdateProcessorFactory.&lt;/p&gt;

&lt;p&gt;Something like this should work...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; ...
 &amp;lt;processor class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.CloneFieldUpdateProcessorFactory&quot;&lt;/span&gt;&amp;gt;
   &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;source&quot;&lt;/span&gt;&amp;gt;GIANT_HONKING_STRING_FIELD&amp;lt;/str&amp;gt;
   &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;dest&quot;&lt;/span&gt;&amp;gt;truncated_string_field_for_lang_detect&amp;lt;/str&amp;gt;
 &amp;lt;/processor&amp;gt;
 &amp;lt;processor class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.TruncateFieldUpdateProcessorFactory&quot;&lt;/span&gt;&amp;gt;
   &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fieldName&quot;&lt;/span&gt;&amp;gt;truncated_string_field_for_lang_detect&amp;lt;/str&amp;gt;
   &amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maxLength&quot;&lt;/span&gt;&amp;gt;65536&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
 &amp;lt;/processor&amp;gt;
 &amp;lt;processor class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.LangDetectLanguageIdentifierUpdateProcessorFactory&quot;&lt;/span&gt;&amp;gt;
   &amp;lt;!-- &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;langid.fl&quot;&lt;/span&gt;&amp;gt;title,subject,GIANT_HONKING_STRING_FIELD&amp;lt;/str&amp;gt; --&amp;gt;
   &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;langid.fl&quot;&lt;/span&gt;&amp;gt;title,subject,truncated_string_field_for_lang_detect&amp;lt;/str&amp;gt;
   ...
 &amp;lt;/processor&amp;gt;
 &amp;lt;processor class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.IgnoreFieldUpdateProcessorFactory&quot;&lt;/span&gt;&amp;gt;
   &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fieldName&quot;&lt;/span&gt;&amp;gt;truncated_string_field_for_lang_detect&amp;lt;/str&amp;gt;
 &amp;lt;/processor&amp;gt;
 ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Neither CloneFieldUpdateProcessorFactory nor TruncateFieldUpdateProcessorFactory will make a full copy of the original String value, and TruncateFieldUpdateProcessorFactory will only make a truncated copy if the sources is longer then the configured max (and even then wether any copy is actaully made really just depends on how the JVM implements substring). IgnoreFieldUpdateProcessorFactory will ensure that the truncated copy is freed up for GC as soon as you are done with LangId.&lt;/p&gt;</comment>
                            <comment id="13476942" author="janhoy" created="Tue, 16 Oct 2012 11:47:33 +0000"  >&lt;p&gt;I&apos;m sure it&apos;s possible to optimize memory footprint somehow. The reason why we concat all &quot;fl&quot; fields before detection was originally because Tika&apos;s detector gets better and better the longer input text you have. So while detection for individual short fields have a high risk of mis-detection, the resulting concatenated string has a better chance.&lt;/p&gt;

&lt;p&gt;A configurable max-cap in the concatenation may make sense, as the detection accuracy flattens out after some threshold.&lt;/p&gt;

&lt;p&gt;Perhaps we could also avoid the expandCapacity() and Ararys.copyOf() calls if we pre-allocate the StringBuffer with the theoretical max size, being the size of our SolrInputDoc. If StringBuffer is at 10kb and needs an extra 10b for an append, it will allocate a new buffer of (10kb+1)*2 capacity which is a waste. We should also switch to StringBuilder which is more performant.&lt;/p&gt;</comment>
                            <comment id="13477104" author="hossman" created="Tue, 16 Oct 2012 15:55:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;The reason why we concat all &quot;fl&quot; fields before detection was originally because Tika&apos;s detector gets better and better the longer input text you have.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But is it possible to give Tika a String[] or List&amp;lt;String&amp;gt; instead of concating everything into a single String?&lt;/p&gt;</comment>
                            <comment id="13477123" author="rcmuir" created="Tue, 16 Oct 2012 16:18:10 +0000"  >&lt;p&gt;The langdetect implementation can append each piece at a time.&lt;/p&gt;

&lt;p&gt;It can also take reader: append(Reader), but that is really just syntactic sugar forwarding to append(String)&lt;br/&gt;
and not exceeding the Detector.max_text_length.&lt;/p&gt;

&lt;p&gt;Seems like the concatenating stuff should be pushed out of the base class into the Tika impl.&lt;/p&gt;</comment>
                            <comment id="13477426" author="janhoy" created="Tue, 16 Oct 2012 22:45:31 +0000"  >&lt;p&gt;Probably built-in truncation is enough to avoid the OOMs, and we could refactor the multi string append if neccesary later.&lt;/p&gt;</comment>
                            <comment id="13486862" author="tomasflobbe" created="Tue, 30 Oct 2012 13:33:00 +0000"  >&lt;p&gt;Do you think it would make more sense to limit each append (for the different fields) or to limit the total size of the buffer/builder (stop appending fields when the maximum was reached)? Both ways would prevent OOM, however they could give different results.&lt;/p&gt;</comment>
                            <comment id="13487865" author="tomasflobbe" created="Wed, 31 Oct 2012 15:36:34 +0000"  >&lt;p&gt;Added the proposed changes&lt;/p&gt;</comment>
                            <comment id="13717135" author="steve_rowe" created="Tue, 23 Jul 2013 18:47:13 +0000"  >&lt;p&gt;Bulk move 4.4 issues to 4.5 and 5.0&lt;/p&gt;</comment>
                            <comment id="13961420" author="vzhovtiuk" created="Sun, 6 Apr 2014 14:39:40 +0000"  >&lt;p&gt;Updated to latest trunk.&lt;br/&gt;
Fixed multivalue support.&lt;br/&gt;
Added string size calculation as string builder capacity. Used to prevent multiple array allocation on append. (Maybe also need to be configurable - for large documents only) &lt;/p&gt;</comment>
                            <comment id="13971157" author="thetaphi" created="Wed, 16 Apr 2014 12:57:19 +0000"  >&lt;p&gt;Move issue to Solr 4.9.&lt;/p&gt;</comment>
                            <comment id="14062122" author="steve_rowe" created="Tue, 15 Jul 2014 14:28:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;Added string size calculation as string builder capacity. Used to prevent multiple array allocation on append. (Maybe also need to be configurable - for large documents only)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vzhovtiuk&quot; class=&quot;user-hover&quot; rel=&quot;vzhovtiuk&quot;&gt;vzhovtiuk&lt;/a&gt;, I agree - I think we should have two configurable limits: max chars per field value (already in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt; and your updated patches), and a max total chars (not there yet).&lt;/p&gt;

&lt;p&gt;Tom&#225;s wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Do you think it would make more sense to limit each append (for the different fields) or to limit the total size of the buffer/builder (stop appending fields when the maximum was reached)? Both ways would prevent OOM, however they could give different results.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should have &lt;b&gt;both&lt;/b&gt; limits.&lt;/p&gt;

&lt;p&gt;I think it&apos;s more important, though, to do as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rcmuir&quot; class=&quot;user-hover&quot; rel=&quot;rcmuir&quot;&gt;rcmuir&lt;/a&gt; said earlier in this issue: &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The langdetect implementation can append each piece at a time.&lt;/p&gt;

&lt;p&gt;It can also take reader: append(Reader), but that is really just syntactic sugar forwarding to append(String)&lt;br/&gt;
and not exceeding the Detector.max_text_length.&lt;/p&gt;

&lt;p&gt;Seems like the concatenating stuff should be pushed out of the base class into the Tika impl.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;See &lt;a href=&quot;http://language-detection.googlecode.com/svn/trunk/doc/com/cybozu/labs/langdetect/Detector.html#setMaxTextLength(int&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://language-detection.googlecode.com/svn/trunk/doc/com/cybozu/labs/langdetect/Detector.html#setMaxTextLength(int&lt;/a&gt;) - the default is 10K chars - we can pass the configured max total chars here.&lt;/p&gt;

&lt;p&gt;We should also set default maxima for both per-value and total chars, rather than MAX_INT, as in the current patch.&lt;/p&gt;</comment>
                            <comment id="14062157" author="steve_rowe" created="Tue, 15 Jul 2014 14:52:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;See &lt;a href=&quot;http://language-detection.googlecode.com/svn/trunk/doc/com/cybozu/labs/langdetect/Detector.html#setMaxTextLength(int&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://language-detection.googlecode.com/svn/trunk/doc/com/cybozu/labs/langdetect/Detector.html#setMaxTextLength(int&lt;/a&gt;) - the default is 10K chars - we can pass the configured max total chars here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;del&gt;The default is actually 10K &lt;b&gt;bytes&lt;/b&gt;, not chars, so we&apos;d need to divide by two when passing the configured max total chars.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;edit&lt;/b&gt; Disregard the above comment; the javadocs refer to &quot;10KB&quot; as the default max text length, but &lt;a href=&quot;https://code.google.com/p/language-detection/source/browse/src/com/cybozu/labs/langdetect/Detector.java#141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Detector.append()&lt;/tt&gt;&lt;/a&gt; uses the &lt;tt&gt;max_text_length&lt;/tt&gt; config as a max number of chars.&lt;/p&gt;</comment>
                            <comment id="14070862" author="vzhovtiuk" created="Tue, 22 Jul 2014 20:43:54 +0000"  >&lt;p&gt;Added global limit to concatenated string&lt;br/&gt;
Added limit to detector to detector.setMaxTextLength(maxTotalAppendSize);&lt;/p&gt;

&lt;p&gt;About moving org.apache.solr.update.processor.LanguageIdentifierUpdateProcessor#concatFields to org.apache.solr.update.processor.TikaLanguageIdentifierUpdateProcessor it&apos;s a bit unclear because concatFields is used in both org.apache.solr.update.processor.TikaLanguageIdentifierUpdateProcessor and org.apache.solr.update.processor.LangDetectLanguageIdentifierUpdateProcessor&lt;/p&gt;</comment>
                            <comment id="14072529" author="steve_rowe" created="Wed, 23 Jul 2014 23:14:29 +0000"  >&lt;p&gt;Vitaliy, those changes look good.&lt;/p&gt;

&lt;p&gt;About moving &lt;tt&gt;concatFields()&lt;/tt&gt; to the tika language identifier: I think the way to go is just move the whole method there, then change the &lt;tt&gt;detectLanguage()&lt;/tt&gt; method to take the &lt;tt&gt;SolrInputDocument&lt;/tt&gt; instead of a String.  You don&apos;t need to carry over the &lt;tt&gt;field[]&lt;/tt&gt; parameter from &lt;tt&gt;concatFields()&lt;/tt&gt;, since data member &lt;tt&gt;inputFields&lt;/tt&gt; will be accessible everywhere it&apos;s needed. &lt;/p&gt;

&lt;p&gt;I should have mentioned previously: I don&apos;t like the &lt;tt&gt;maxAppendSize&lt;/tt&gt; and &lt;tt&gt;maxTotalAppendSize&lt;/tt&gt; names - &quot;size&quot; is ambiguous (could refer to bytes, chars, whatever), and &quot;append&quot; refers to an internal operation... I&apos;d like to see &quot;append&quot;=&amp;gt;&quot;field value&quot; and &quot;size&quot;=&amp;gt;&quot;chars&quot;: &lt;tt&gt;maxFieldValueChars&lt;/tt&gt;, and &lt;tt&gt;maxTotalChars&lt;/tt&gt; (since appending doesn&apos;t need to be mentioned for the global limit).  The same thing goes for the default constants and the test method names.&lt;/p&gt;

&lt;p&gt;Some minor issues I found with your patch:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;As I said previously: &quot;We should also set default maxima for both per-value and total chars, rather than MAX_INT, as in the current patch.&quot;&lt;/li&gt;
	&lt;li&gt;The total chars default should be its own setting; I was thinking we could make it double the per-value default?&lt;/li&gt;
	&lt;li&gt;It&apos;s better not to reorder import statements unless you&apos;re already making significant changes to them; it distracts from the meat of the change.  (You reordered them in &lt;tt&gt;LangDetectLanguageIdentifierUpdateProcessor&lt;/tt&gt; and &lt;tt&gt;LanguageIdentifierUpdateProcessorFactoryTestCase&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;LanguageIdentifierUpdateProcessor.concatFields()&lt;/tt&gt;, when you trim the concatenated text to &lt;tt&gt;maxTotalAppendSize&lt;/tt&gt;, I think &lt;tt&gt;StringBuilder.setLength(maxTotalAppendSize);&lt;/tt&gt; would be more efficient than &lt;tt&gt;StringBuilder.delete(maxTotalAppendSize, sb.length() - 1);&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;In addition to the test you added for the global limit, we should also test using both the per-value and global limits at the same time.&lt;/li&gt;
&lt;/ol&gt;


</comment>
                            <comment id="14086730" author="vzhovtiuk" created="Tue, 5 Aug 2014 20:50:51 +0000"  >&lt;p&gt;About moving concatFields() to the tika language identifier: I think the way to go is just move the whole method there, then change the detectLanguage() method to take the SolrInputDocument instead of a String. You don&apos;t need to carry over the field[] parameter from concatFields(), since data member inputFields will be accessible everywhere it&apos;s needed.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; This call looks more cleaner now, i changed inputFields to private now to reduce visibility scope&lt;/p&gt;

&lt;p&gt;I should have mentioned previously: I don&apos;t like the maxAppendSize and maxTotalAppendSize names - &quot;size&quot; is ambiguous (could refer to bytes, chars, whatever), and &quot;append&quot; refers to an internal operation... I&apos;d like to see &quot;append&quot;=&amp;gt;&quot;field value&quot; and &quot;size&quot;=&amp;gt;&quot;chars&quot;: maxFieldValueChars, and maxTotalChars (since appending doesn&apos;t need to be mentioned for the global limit). The same thing goes for the default constants and the test method names.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Renamed parameters and test methods&lt;/p&gt;

&lt;p&gt;Some minor issues I found with your patch:&lt;br/&gt;
As I said previously: &quot;We should also set default maxima for both per-value and total chars, rather than MAX_INT, as in the current patch.&quot;&lt;br/&gt;
The total chars default should be its own setting; I was thinking we could make it double the per-value default?&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; added default value to maxTotalChars and changed both to 10K like in com.cybozu.labs.langdetect.Detector.maxLength&lt;/p&gt;

&lt;p&gt;It&apos;s better not to reorder import statements unless you&apos;re already making significant changes to them; it distracts from the meat of the change. (You reordered them in LangDetectLanguageIdentifierUpdateProcessor and LanguageIdentifierUpdateProcessorFactoryTestCase)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; This is IDE optimization to put imports in alphabetical order - restored it to original order&lt;/p&gt;

&lt;p&gt;In LanguageIdentifierUpdateProcessor.concatFields(), when you trim the concatenated text to maxTotalAppendSize, I think StringBuilder.setLength(maxTotalAppendSize); would be more efficient than StringBuilder.delete(maxTotalAppendSize, sb.length() - 1);&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Yep, cleaned that &lt;/p&gt;

&lt;p&gt;In addition to the test you added for the global limit, we should also test using both the per-value and global limits at the same time.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Tests for both limits added&lt;/p&gt;</comment>
                            <comment id="14088223" author="steve_rowe" created="Wed, 6 Aug 2014 20:44:28 +0000"  >&lt;p&gt;Vitaliy, thanks for the changes.&lt;/p&gt;

&lt;p&gt;I see a few more issues in your latest patch:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;LangDetectLanguageIdentifierUpdateProcessor.detectLanguage()&lt;/tt&gt; still uses &lt;tt&gt;concatFields()&lt;/tt&gt;, but it shouldn&apos;t &amp;#8211; that was the whole point about moving it to &lt;tt&gt;TikaLanguageIdentifierUpdateProcessor&lt;/tt&gt;; instead,  &lt;tt&gt;LangDetectLanguageIdentifierUpdateProcessor.detectLanguage()&lt;/tt&gt; should loop over &lt;tt&gt;inputFields&lt;/tt&gt; and call &lt;tt&gt;detector.append()&lt;/tt&gt; (similarly to what &lt;tt&gt;concatFields()&lt;/tt&gt; does).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;concatFields()&lt;/tt&gt; and &lt;tt&gt;getExpectedSize()&lt;/tt&gt; should move to &lt;tt&gt;TikaLanguageIdentifierUpdateProcessor&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;LanguageIdentifierUpdateProcessor.getExpectedSize()&lt;/tt&gt; still takes a &lt;tt&gt;maxAppendSize&lt;/tt&gt;, which didn&apos;t get renamed, but that param could be removed entirely, since &lt;tt&gt;maxFieldValueChars&lt;/tt&gt; is available as a data member.&lt;/li&gt;
	&lt;li&gt;There are a bunch of whitespace changes in &lt;tt&gt;LanguageIdentifierUpdateProcessorFactoryTestCase.java&lt;/tt&gt; - it makes reviewing patches significantly harder when they include changes like this.  Your IDE should have settings that make it stop doing this.&lt;/li&gt;
	&lt;li&gt;There is still some import reordering in &lt;tt&gt;TikaLanguageIdentifierUpdateProcessor.java&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;One last thing:&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The total chars default should be its own setting; I was thinking we could make it double the per-value default?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;[VZ] added default value to maxTotalChars and changed both to 10K like in com.cybozu.labs.langdetect.Detector.maxLength&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for adding the total chars default, but you didn&apos;t make it double the field value chars default, as I suggested.  Not sure if that&apos;s better - if the user specifies multiple fields and the first one is the only one that&apos;s used to determine the language because it&apos;s larger than the total char default, is that an issue?  I was thinking that it would be better to visit at least one other field (hence the idea of total = 2 * per-field), but that wouldn&apos;t fully address the issue.  What do you think?&lt;/p&gt;</comment>
                            <comment id="14230080" author="vzhovtiuk" created="Mon, 1 Dec 2014 17:29:04 +0000"  >&lt;p&gt;1. LangDetectLanguageIdentifierUpdateProcessor.detectLanguage() still uses concatFields(), but it shouldn&apos;t &#8211; that was the whole point about moving it to TikaLanguageIdentifierUpdateProcessor; instead, LangDetectLanguageIdentifierUpdateProcessor.detectLanguage() should loop over inputFields and call detector.append() (similarly to what concatFields() does).&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; LangDetectLanguageIdentifierUpdateProcessor.detectLanguage() changed to use old flow with limit on field and max total on detector.&lt;br/&gt;
Each field value appended to detector.&lt;/p&gt;

&lt;p&gt;2. concatFields() and getExpectedSize() should move to TikaLanguageIdentifierUpdateProcessor.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Moved to TikaLanguageIdentifierUpdateProcessor. Tests using concatFields() moved to TikaLanguageIdentifierUpdateProcessorFactoryTest.&lt;/p&gt;

&lt;p&gt;3. LanguageIdentifierUpdateProcessor.getExpectedSize() still takes a maxAppendSize, which didn&apos;t get renamed, but that param could be removed entirely, since maxFieldValueChars is available as a data member.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Argument removed.&lt;/p&gt;

&lt;p&gt;4. There are a bunch of whitespace changes in LanguageIdentifierUpdateProcessorFactoryTestCase.java - it makes reviewing patches significantly harder when they include changes like this. Your IDE should have settings that make it stop doing this.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Whitespaces removed.&lt;/p&gt;

&lt;p&gt;5. There is still some import reordering in TikaLanguageIdentifierUpdateProcessor.java.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; Fixed.&lt;/p&gt;

&lt;p&gt;One last thing:&lt;br/&gt;
The total chars default should be its own setting; I was thinking we could make it double the per-value default?&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; added default value to maxTotalChars and changed both to 10K like in com.cybozu.labs.langdetect.Detector.maxLength&lt;br/&gt;
Thanks for adding the total chars default, but you didn&apos;t make it double the field value chars default, as I suggested. Not sure if that&apos;s better - if the user specifies multiple fields and the first one is the only one that&apos;s used to determine the language because it&apos;s larger than the total char default, is that an issue? I was thinking that it would be better to visit at least one other field (hence the idea of total = 2 * per-field), but that wouldn&apos;t fully address the issue. What do you think?&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; i think in most cases it will be only one field, but since both parameters are optional we should not restrict result if only per field specified more then 10K.&lt;br/&gt;
Updated total default value to 20K. &lt;/p&gt;</comment>
                            <comment id="14233220" author="steve_rowe" created="Wed, 3 Dec 2014 17:35:23 +0000"  >&lt;p&gt;Thanks Vitaliy, looks great.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;VZ&amp;#93;&lt;/span&gt; ... since both parameters are optional we should not restrict result if only per field specified more then 10K.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree - I added code to &lt;tt&gt;LanguageIdentifierUpdateProcessor.initParams()&lt;/tt&gt; to check if &lt;tt&gt;maxFieldValueChars &amp;gt; maxTotalChars&lt;/tt&gt;, and if so, set &lt;tt&gt;maxTotalChars&lt;/tt&gt; to the value of &lt;tt&gt;maxFieldValueChars&lt;/tt&gt; and log a warning.&lt;/p&gt;

&lt;p&gt;Attaching a version of the patch that includes the above change, as well as a &lt;tt&gt;CHANGES.txt&lt;/tt&gt; entry.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit when Subversion lets me (can&apos;t connect right now).&lt;/p&gt;</comment>
                            <comment id="14233237" author="steve_rowe" created="Wed, 3 Dec 2014 17:47:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;I added code to &lt;tt&gt;LanguageIdentifierUpdateProcessor.initParams()&lt;/tt&gt; to check if &lt;tt&gt;maxFieldValueChars &amp;gt; maxTotalChars&lt;/tt&gt;, and if so, set &lt;tt&gt;maxTotalChars&lt;/tt&gt; to the value of &lt;tt&gt;maxFieldValueChars&lt;/tt&gt; and log a warning.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The above was too simplistic.  If &lt;tt&gt;maxFieldValueChars &amp;gt; maxTotalChars&lt;/tt&gt; and the user only set &lt;tt&gt;maxTotalChars&lt;/tt&gt;, then the reverse should happen: &lt;tt&gt;maxFieldValueChars&lt;/tt&gt; should be set &lt;tt&gt;maxTotalChars&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The attached patch fixes this, and allows the tests to pass.&lt;/p&gt;</comment>
                            <comment id="14235843" author="jira-bot" created="Fri, 5 Dec 2014 18:22:39 +0000"  >&lt;p&gt;Commit 1643377 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sarowe%40syr.edu&quot; class=&quot;user-hover&quot; rel=&quot;sarowe@syr.edu&quot;&gt;sarowe@syr.edu&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1643377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1643377&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3881&quot; title=&quot;frequent OOM in LanguageIdentifierUpdateProcessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3881&quot;&gt;&lt;del&gt;SOLR-3881&lt;/del&gt;&lt;/a&gt;: Avoid OOMs in LanguageIdentifierUpdateProcessor:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added langid.maxFieldValueChars and langid.maxTotalChars params to limit&lt;br/&gt;
  input, by default 10k and 20k chars, respectively.&lt;/li&gt;
	&lt;li&gt;Moved input concatenation to Tika implementation; the langdetect&lt;br/&gt;
  implementation instead appends each input piece via the langdetect API.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14235896" author="jira-bot" created="Fri, 5 Dec 2014 18:54:02 +0000"  >&lt;p&gt;Commit 1643390 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sarowe%40syr.edu&quot; class=&quot;user-hover&quot; rel=&quot;sarowe@syr.edu&quot;&gt;sarowe@syr.edu&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1643390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1643390&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3881&quot; title=&quot;frequent OOM in LanguageIdentifierUpdateProcessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3881&quot;&gt;&lt;del&gt;SOLR-3881&lt;/del&gt;&lt;/a&gt;: Avoid OOMs in LanguageIdentifierUpdateProcessor:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added langid.maxFieldValueChars and langid.maxTotalChars params to limit&lt;br/&gt;
  input, by default 10k and 20k chars, respectively.&lt;/li&gt;
	&lt;li&gt;Moved input concatenation to Tika implementation; the langdetect&lt;br/&gt;
  implementation instead appends each input piece via the langdetect API. &lt;br/&gt;
(merged trunk r1643377)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14235899" author="steve_rowe" created="Fri, 5 Dec 2014 18:55:38 +0000"  >&lt;p&gt;Committed to trunk and branch_5x.&lt;/p&gt;

&lt;p&gt;Thanks all!&lt;/p&gt;</comment>
                            <comment id="14332777" author="anshumg" created="Mon, 23 Feb 2015 05:01:51 +0000"  >&lt;p&gt;Bulk close after 5.0 release.&lt;/p&gt;</comment>
                            <comment id="14338335" author="shalinmangar" created="Thu, 26 Feb 2015 12:43:04 +0000"  >&lt;p&gt;Reopening to backport to 4.10.4&lt;/p&gt;</comment>
                            <comment id="14338338" author="jira-bot" created="Thu, 26 Feb 2015 12:45:32 +0000"  >&lt;p&gt;Commit 1662436 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1662436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1662436&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3881&quot; title=&quot;frequent OOM in LanguageIdentifierUpdateProcessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3881&quot;&gt;&lt;del&gt;SOLR-3881&lt;/del&gt;&lt;/a&gt;: Avoid OOMs in LanguageIdentifierUpdateProcessor:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added langid.maxFieldValueChars and langid.maxTotalChars params to limit&lt;br/&gt;
  input, by default 10k and 20k chars, respectively.&lt;/li&gt;
	&lt;li&gt;Moved input concatenation to Tika implementation; the langdetect&lt;br/&gt;
  implementation instead appends each input piece via the langdetect API.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14348922" author="mikemccand" created="Thu, 5 Mar 2015 15:36:31 +0000"  >&lt;p&gt;Bulk close for 4.10.4 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13125674">SOLR-11774</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12684933" name="SOLR-3881.patch" size="21635" author="sarowe" created="Wed, 3 Dec 2014 17:47:06 +0000"/>
                            <attachment id="12684931" name="SOLR-3881.patch" size="21095" author="sarowe" created="Wed, 3 Dec 2014 17:35:23 +0000"/>
                            <attachment id="12684439" name="SOLR-3881.patch" size="20097" author="vzhovtiuk" created="Mon, 1 Dec 2014 17:29:04 +0000"/>
                            <attachment id="12659944" name="SOLR-3881.patch" size="26415" author="vzhovtiuk" created="Tue, 5 Aug 2014 20:50:51 +0000"/>
                            <attachment id="12657186" name="SOLR-3881.patch" size="12959" author="vzhovtiuk" created="Tue, 22 Jul 2014 20:43:54 +0000"/>
                            <attachment id="12638913" name="SOLR-3881.patch" size="8131" author="vzhovtiuk" created="Sun, 6 Apr 2014 14:39:40 +0000"/>
                            <attachment id="12551566" name="SOLR-3881.patch" size="6993" author="tflobbe" created="Wed, 31 Oct 2012 15:36:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243115</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03c3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>