<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:10:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17255] ClientUtils.encodeLocalParamVal doesn&apos;t work with param refs, breaks SolrParams.toLocalParamsString</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17255</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;If you try to use &lt;tt&gt;SolrParams.toLocalParamsString&lt;/tt&gt; where some of your param values are &lt;tt&gt;$other_param&lt;/tt&gt; style param references, those refs will wind up wrapped in single quotes, preventing the param de-referencing from working.&lt;/p&gt;

&lt;p&gt;Example...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ModifiableSolrParams params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;edismax&quot;&lt;/span&gt;);
params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;v&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;$other_param&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(params.toLocalParamString())

&lt;span class=&quot;code-comment&quot;&gt;// Output: {! type=edismax v=&lt;span class=&quot;code-quote&quot;&gt;&apos;$other_param&apos;&lt;/span&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Ironically: &lt;tt&gt;ClientUtils.encodeLocalParamVal&lt;/tt&gt; actually has a check to see if the string starts with &lt;tt&gt;&quot;$&quot;&lt;/tt&gt; which causes it to bypass a loop that checks to see if the string needs to be quoted &#8211; but bypassing that loop doesn&apos;t leave the method variables (&lt;tt&gt;i&lt;/tt&gt; and &lt;tt&gt;len&lt;/tt&gt;) in a state that allow the subsequent short-circut check (which returns the original value) to kick in &#8211; so the value is always falls through to the &lt;tt&gt;// We need to enclose in quotes... but now we need to escape&lt;/tt&gt; logic&lt;/p&gt;

&lt;p&gt;(It looks like this bug has always existed in every version of these methods)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13577109">SOLR-17255</key>
            <summary>ClientUtils.encodeLocalParamVal doesn&apos;t work with param refs, breaks SolrParams.toLocalParamsString</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Apr 2024 19:07:21 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:40 +0000</updated>
                            <resolved>Tue, 18 Jun 2024 22:18:29 +0000</resolved>
                                                    <fixVersion>9.7</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                    <component>SolrJ</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17840578" author="dsmiley" created="Wed, 24 Apr 2024 21:02:51 +0000"  >&lt;p&gt;Ouch; good catch!  I recall writing that a long time ago.&lt;/p&gt;</comment>
                            <comment id="17840583" author="hossman" created="Wed, 24 Apr 2024 21:37:51 +0000"  >&lt;p&gt;I think you added&#160; &lt;tt&gt;SolrParams.toLocalParamsString&lt;/tt&gt; but the logic for handling in &lt;tt&gt;ClientUtils.encodeLocalParamVal&lt;/tt&gt; dates back much older &#8211; it looks like it was intentionally added by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2110&quot; title=&quot;Distributed faceting can create invalid refinement requests when &amp;quot;key&amp;quot; is complex&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2110&quot;&gt;&lt;del&gt;SOLR-2110&lt;/del&gt;&lt;/a&gt; ? .... I haven&apos;t really dug into the history but it looks like that jira (and the tests it add) are trying to ensure that values starting with &lt;tt&gt;&quot;$&quot;&lt;/tt&gt; are &lt;b&gt;intentionally&lt;/b&gt; quoted ... evidently because of how some facet refinement logic (that calls &lt;tt&gt;encodeLocalParamVal&lt;/tt&gt; directly) duplicates &lt;tt&gt;&quot;key&quot;&lt;/tt&gt; local params  and it must have been trying to derefrence the values when it shouldn&apos;t have been?&lt;/p&gt;

&lt;p&gt;I suspect the &quot;correct&quot; fix (w/o breaking faceting) is that &lt;tt&gt;SolrParams.toLocalParamsString&lt;/tt&gt; should special case check for param refs, and not delegate to &lt;tt&gt;ClientUtils.encodeLocalParamVal&lt;/tt&gt; in that case?  (and of course: a lot more tests and javadocs about what callers can/should expect)&lt;/p&gt;</comment>
                            <comment id="17840584" author="hossman" created="Wed, 24 Apr 2024 21:43:56 +0000"  >&lt;p&gt;Thinking about it more: &lt;tt&gt;SolrParams.toLocalParamsString&lt;/tt&gt; also probably has a bug if/when the value is the empty string? ... &lt;/p&gt;

&lt;p&gt;Pretty sure a use case like this will break because it will produce something like  &lt;tt&gt;... bq= v=foo ...&lt;/tt&gt; which will cause solr to try to use &lt;tt&gt;v=foo&lt;/tt&gt; as the value for the &lt;tt&gt;bq&lt;/tt&gt; local param.  Empty strings in local params need to be quoted.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ModifiableSolrParams params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;edismax&quot;&lt;/span&gt;);
params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;bq&quot;&lt;/span&gt;,&quot;&quot;);
params.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;v&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(params.toLocalParamString())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17855776" author="hossman" created="Tue, 18 Jun 2024 02:07:27 +0000"  >&lt;p&gt;attaching patch with fix and tests&lt;/p&gt;</comment>
                            <comment id="17855919" author="dsmiley" created="Tue, 18 Jun 2024 12:32:23 +0000"  >&lt;p&gt;+1 thanks&lt;/p&gt;</comment>
                            <comment id="17892953" author="anshumg" created="Fri, 25 Oct 2024 17:18:57 +0000"  >&lt;p&gt;Closing after the 9.7.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13069553" name="SOLR-17255.patch" size="4893" author="hossman" created="Tue, 18 Jun 2024 02:07:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ouqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>