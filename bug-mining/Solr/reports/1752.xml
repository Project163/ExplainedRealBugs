<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:45:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5593] shard leader loss due to ZK session expiry</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5593</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The problem we saw was that the shard leader ceased to be shard leader (in our case due to its zookeeper session expiring). The followers thus rejected update requests (DistributedUpdateProcessor setupRequest&apos;s call to ZkStateReader getLeaderRetry) and the leader asked them to recover (DistributedUpdateProcessor doFinish). The followers published themselves as recovering (CoreAdminHandler handleRequestRecoveryAction) and the shard leader loss triggered an election in which none of the followers became the leader due to their recovering state (ShardLeaderElectionContext shouldIBeLeader). The former shard leader also did not become shard leader because its new seq number placed it after the existing replicas (LeaderElector checkIfIamLeader seq &amp;lt;= intSeqs.get(0)).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12686851">SOLR-5593</key>
            <summary>shard leader loss due to ZK session expiry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="cpoerschke">Christine Poerschke</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Dec 2013 16:04:37 +0000</created>
                <updated>Mon, 9 May 2016 18:50:25 +0000</updated>
                            <resolved>Thu, 6 Feb 2014 02:42:31 +0000</resolved>
                                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13859546" author="cpoerschke" created="Tue, 31 Dec 2013 16:08:26 +0000"  >&lt;p&gt;Attaching one potential solution (we are investigating others):&lt;/p&gt;

&lt;p&gt;As part of the recovery process state=recovering publishing already happens (RecoveryStrategy doRecovery) but only after a shard leader to recover from has been found. If the CoreAdminHandler handleRequestRecoveryAction publish had not happened then one of the followers should have been elected shard leader.&lt;/p&gt;</comment>
                            <comment id="13859557" author="markrmiller@gmail.com" created="Tue, 31 Dec 2013 16:44:30 +0000"  >&lt;p&gt;Great find!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The former shard leader also did not become shard leader because its new seq number placed it after the existing replicas (LeaderElector checkIfIamLeader seq &amp;lt;= intSeqs.get(0)).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This I&apos;m surprised to see - when someone cannot be the leader, for instance if they published a non active state last, they should get back in line - the original leader should have his chance again...&lt;/p&gt;</comment>
                            <comment id="13859562" author="markrmiller@gmail.com" created="Tue, 31 Dec 2013 16:48:38 +0000"  >&lt;p&gt;I think your change is probably good in general. Let&apos;s see what else we can do here.&lt;/p&gt;

&lt;p&gt;One thing that seems kind of silly is that those replicas reject the updates at all. It seems like perhaps we should relax things a bit so that they would be accepted.&lt;/p&gt;</comment>
                            <comment id="13859600" author="cpoerschke" created="Tue, 31 Dec 2013 18:14:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;One thing that seems kind of silly is that those replicas reject the updates at all. It seems like perhaps we should relax things a bit so that they would be accepted.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, we are working on changes to DistributedUpdateProcessor to relax the requirement for the getLeaderRetry to succeed within setupRequest (if phase is DistribPhase.FROMLEADER and the shard state shows it could not be subShardLeader then getLeaderRetry success should be optional).&lt;/p&gt;</comment>
                            <comment id="13859652" author="steve_rowe" created="Tue, 31 Dec 2013 20:05:14 +0000"  >&lt;p&gt;I didn&apos;t mean to reassign - I was typing in another window, accidentally hit the mouse button with my elbow, which focused the browser window with this issue up, and then I guess JIRA interpreted my random typing as keyboard shortcuts ....&lt;/p&gt;</comment>
                            <comment id="13859683" author="markrmiller@gmail.com" created="Tue, 31 Dec 2013 20:44:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yes, we are working on changes to DistributedUpdateProcessor to relax the requirement for the getLeaderRetry to succeed within setupRequest (if phase is DistribPhase.FROMLEADER and the shard state shows it could not be subShardLeader then getLeaderRetry success should be optional).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, on some thought, this is the right approach I think. Removing the publish is actually probably not a good idea. It actually protects us from losing data - we don&apos;t want a replica that was asked to recover to become the leader - that could mean updates were accepted that it is expected to have. If the previous leader died before one of the replicas became a leader, that leader might have been ahead. In this case, we don&apos;t choose a new leader, because you should really reboot the whole shard with all the replicas you can to avoid any possible data lose.&lt;/p&gt;</comment>
                            <comment id="13859684" author="markrmiller@gmail.com" created="Tue, 31 Dec 2013 20:44:58 +0000"  >&lt;p&gt;bq within setupRequest &lt;/p&gt;

&lt;p&gt;The tough case seems to be nailing delete by query - I&apos;ve been peaking a bit at it.&lt;/p&gt;</comment>
                            <comment id="13888944" author="markrmiller@gmail.com" created="Sun, 2 Feb 2014 14:59:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yes, we are working on changes to DistributedUpdateProcessor to relax&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Any progress? I&apos;ll likely look at attacking this soon.&lt;/p&gt;</comment>
                            <comment id="13889416" author="cpoerschke" created="Mon, 3 Feb 2014 11:49:16 +0000"  >&lt;p&gt;Uploaded &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/27&lt;/a&gt; which rather than relaxing the error handling for the getLeaderRetry call actually tries to completely avoid it in the first place (if circumstances seem to permit it i.e. the request said it came from the leader and we don&apos;t think we are leader and we could not be sub-shard leader).&lt;/p&gt;</comment>
                            <comment id="13892720" author="markrmiller@gmail.com" created="Wed, 5 Feb 2014 22:57:48 +0000"  >&lt;p&gt;Great, thanks Christine! Patch looks good on first glance.&lt;/p&gt;</comment>
                            <comment id="13892937" author="jira-bot" created="Thu, 6 Feb 2014 02:38:01 +0000"  >&lt;p&gt;Commit 1565049 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1565049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1565049&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5593&quot; title=&quot;shard leader loss due to ZK session expiry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5593&quot;&gt;&lt;del&gt;SOLR-5593&lt;/del&gt;&lt;/a&gt;: Replicas should accept the last updates from a leader that has just  lost it&apos;s connection to ZooKeeper.&lt;/p&gt;</comment>
                            <comment id="13892941" author="jira-bot" created="Thu, 6 Feb 2014 02:41:57 +0000"  >&lt;p&gt;Commit 1565053 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1565053&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1565053&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5593&quot; title=&quot;shard leader loss due to ZK session expiry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5593&quot;&gt;&lt;del&gt;SOLR-5593&lt;/del&gt;&lt;/a&gt;: Replicas should accept the last updates from a leader that has just  lost it&apos;s connection to ZooKeeper.&lt;/p&gt;</comment>
                            <comment id="13892942" author="markrmiller@gmail.com" created="Thu, 6 Feb 2014 02:42:31 +0000"  >&lt;p&gt;Thanks Christine!&lt;/p&gt;</comment>
                            <comment id="15094561" author="githubbot" created="Tue, 12 Jan 2016 19:13:46 +0000"  >&lt;p&gt;Github user cpoerschke closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/27&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12695125">SOLR-5727</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12620943" name="CoreAdminHandler.patch" size="2089" author="cpoerschke" created="Tue, 31 Dec 2013 16:08:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365844</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r28v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366151</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>