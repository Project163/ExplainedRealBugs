<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:22:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10420] Solr 6.x leaking one SolrZkClient instance per second</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10420</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;One of our nodes became berzerk after a restart, Solr went completely nuts! So i opened VisualVM to keep an eye on it and spotted a different problem that occurs in all our Solr 6.4.2 and 6.5.0 nodes.&lt;/p&gt;

&lt;p&gt;It appears Solr is leaking one SolrZkClient instance per second via DistributedQueue$ChildWatcher. That one per second is quite accurate for all nodes, there are about the same amount of instances as there are seconds since Solr started. I know VisualVM&apos;s instance count includes objects-to-be-collected, the instance count does not drop after a forced garbed collection round.&lt;/p&gt;

&lt;p&gt;It doesn&apos;t matter how many cores or collections the nodes carry or how heavy traffic is.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13061441">SOLR-10420</key>
            <summary>Solr 6.x leaking one SolrZkClient instance per second</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dragonsinth">Scott Blum</assignee>
                                    <reporter username="markus17">Markus Jelsma</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Apr 2017 14:15:03 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:47 +0000</updated>
                            <resolved>Tue, 18 Apr 2017 20:45:40 +0000</resolved>
                                    <version>5.5.2</version>
                    <version>6.4.2</version>
                    <version>6.5</version>
                                    <fixVersion>5.5.5</fixVersion>
                    <fixVersion>5.6</fixVersion>
                    <fixVersion>6.5.1</fixVersion>
                    <fixVersion>6.6</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="15955222" author="ichattopadhyaya" created="Tue, 4 Apr 2017 15:00:58 +0000"  >&lt;p&gt;Nothing changed in that code in the last few releases. Do you know if this worked fine in a prior 6x release?&lt;br/&gt;
FYI, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; &amp;lt;-- experts in that code.&lt;/p&gt;</comment>
                            <comment id="15955253" author="markus17" created="Tue, 4 Apr 2017 15:30:10 +0000"  >&lt;p&gt;I only have 6.5.0 and a not-yet upgraded 6.4.2, both suffer the same.&lt;/p&gt;

&lt;p&gt;But i just built a 6.3.0, ran it in cloud mode without registering a collection or core using the built-in Zookeeper. After two minutes, i had ~120 client objects, now i have more.&lt;/p&gt;

&lt;p&gt;6.0.0 doesn&apos;t show increased instance counts. Can&apos;t test 6.1 and 6.2, ant keeps hanging on resolve for whatever reason.&lt;/p&gt;</comment>
                            <comment id="15955259" author="ichattopadhyaya" created="Tue, 4 Apr 2017 15:34:15 +0000"  >&lt;p&gt;The ant resolve could hang due to lock files. You could try this: &lt;tt&gt;find ~ -name &quot;*lck&quot; | xargs rm&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15955282" author="markus17" created="Tue, 4 Apr 2017 15:46:04 +0000"  >&lt;p&gt;Ah, i found it, the problem appeared in 6.1.0. Versions 6.0.0 and 6.0.1 do not show this problem, the instances are eaten by GC.&lt;/p&gt;</comment>
                            <comment id="15955283" author="dragonsinth" created="Tue, 4 Apr 2017 15:48:15 +0000"  >&lt;p&gt;Hard to see how the problem could be localized to DistributedQueue$ChildWatcher.. it doesn&apos;t create any ZkClients, it&apos;s passed in from the outside.&lt;/p&gt;</comment>
                            <comment id="15955287" author="markus17" created="Tue, 4 Apr 2017 15:51:49 +0000"  >&lt;p&gt;Well, actually DistributedQueue$ChildWatcher is being leaked well, so leaking of SolrZkClient could be a consequence of that.&lt;/p&gt;
</comment>
                            <comment id="15955293" author="markus17" created="Tue, 4 Apr 2017 15:56:53 +0000"  >&lt;p&gt;To note another oddity, some nodes of our regular search cluster (6.5.0) do not show increased counts. Some nodes with other roles (but running Solr) show the problem immediately after each restart every time i restarted them today. So it could be 6.0.1 and 6.0.0 also show the problem, although they didn&apos;t when i just tested them.&lt;/p&gt;</comment>
                            <comment id="15955538" author="wunder" created="Tue, 4 Apr 2017 18:11:51 +0000"  >&lt;p&gt;To be clear, these are uncollectable objects?&lt;/p&gt;</comment>
                            <comment id="15955575" author="markus17" created="Tue, 4 Apr 2017 18:33:54 +0000"  >&lt;p&gt;So it seems. Forced GC does not remove the object instances in &amp;gt;= 6.1.0. In 6.0.x regular GC and forced GC does remove the instances from the object count. I think almost everyone should be able to see it for themselves, almost all our Solr instances show this problem immediately after restart, some don&apos;t in some occasions.&lt;/p&gt;

&lt;p&gt;Although they don&apos;t consume a lot of bytes, the problem appears to cause more CPU time being used up.&lt;/p&gt;

&lt;p&gt;Filtering the memory sampler for org.apache.solr.common reveals it right away. Also, the number of instances should correspond the the number of seconds the instance is running. A node running how about six days has roughly 500k instances, one running roughly 30 minutes just below 2k.&lt;/p&gt;</comment>
                            <comment id="15965658" author="caomanhdat" created="Wed, 12 Apr 2017 10:51:09 +0000"  >&lt;p&gt;Patch for this ticket. This problem was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9191&quot; title=&quot;OverseerTaskQueue.peekTopN() fatally flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9191&quot;&gt;&lt;del&gt;SOLR-9191&lt;/del&gt;&lt;/a&gt;. Serious problem for Solr 6.x&lt;/p&gt;</comment>
                            <comment id="15965790" author="markus17" created="Wed, 12 Apr 2017 13:03:11 +0000"  >&lt;p&gt;This patch appears to solve the problem. &lt;/p&gt;</comment>
                            <comment id="15965973" author="steve_rowe" created="Wed, 12 Apr 2017 14:37:54 +0000"  >&lt;p&gt;I ran all Solr tests with the patch on master, and one test failed: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 264992 ERROR (OverseerExitThread) [    ] o.a.s.c.Overseer could not read the data
   [junit4]   2&amp;gt; org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /overseer_elect/leader
   [junit4]   2&amp;gt;        at org.apache.zookeeper.KeeperException.create(KeeperException.java:127)
   [junit4]   2&amp;gt;        at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
   [junit4]   2&amp;gt;        at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1155)
   [junit4]   2&amp;gt;        at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:356)
   [junit4]   2&amp;gt;        at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:353)
   [junit4]   2&amp;gt;        at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:60)
   [junit4]   2&amp;gt;        at org.apache.solr.common.cloud.SolrZkClient.getData(SolrZkClient.java:353)
   [junit4]   2&amp;gt;        at org.apache.solr.cloud.Overseer$ClusterStateUpdater.checkIfIamStillLeader(Overseer.java:290)
   [junit4]   2&amp;gt;        at java.lang.Thread.run(Thread.java:745)
   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=OverseerTest -Dtests.method=testExternalClusterStateChangeBehavior -Dtests.seed=2110CE0AEF674CFA -Dtests.slow=true -Dtests.locale=es-GT -Dtests.timezone=Asia/Kolkata -Dtests.asserts=true -Dtests.file.encoding=UTF-8
   [junit4] FAILURE 5.46s J12 | OverseerTest.testExternalClusterStateChangeBehavior &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: Illegal state, was: down expected:active clusterState:live nodes:[]collections:{c1=DocCollection(c1//clusterstate.json/2)={
   [junit4]    &amp;gt;   &quot;shards&quot;:{&quot;shard1&quot;:{
   [junit4]    &amp;gt;       &quot;parent&quot;:null,
   [junit4]    &amp;gt;       &quot;range&quot;:null,
   [junit4]    &amp;gt;       &quot;state&quot;:&quot;active&quot;,
   [junit4]    &amp;gt;       &quot;replicas&quot;:{&quot;core_node1&quot;:{
   [junit4]    &amp;gt;           &quot;base_url&quot;:&quot;http://127.0.0.1/solr&quot;,
   [junit4]    &amp;gt;           &quot;node_name&quot;:&quot;node1&quot;,
   [junit4]    &amp;gt;           &quot;core&quot;:&quot;core1&quot;,
   [junit4]    &amp;gt;           &quot;roles&quot;:&quot;&quot;,
   [junit4]    &amp;gt;           &quot;state&quot;:&quot;down&quot;}}}},
   [junit4]    &amp;gt;   &quot;router&quot;:{&quot;name&quot;:&quot;implicit&quot;}}, test=LazyCollectionRef(test)}
   [junit4]    &amp;gt;        at __randomizedtesting.SeedInfo.seed([2110CE0AEF674CFA:490ECDE60DF716B4]:0)
   [junit4]    &amp;gt;        at org.apache.solr.cloud.AbstractDistribZkTestBase.verifyReplicaStatus(AbstractDistribZkTestBase.java:273)
   [junit4]    &amp;gt;        at org.apache.solr.cloud.OverseerTest.testExternalClusterStateChangeBehavior(OverseerTest.java:1259)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I ran the repro line a couple of times and it didn&apos;t reproduce.  I then beasted 100 iterations of the test suite using Miller&apos;s beasting script, and it failed once.  I&apos;m attaching the test log from the failure.&lt;/p&gt;

&lt;p&gt;Looking at emailed Jenkins reports of &lt;tt&gt;testExternalClusterStateChangeBehavior()&lt;/tt&gt; failing, I see that it was failing almost daily until the day &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9191&quot; title=&quot;OverseerTaskQueue.peekTopN() fatally flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9191&quot;&gt;&lt;del&gt;SOLR-9191&lt;/del&gt;&lt;/a&gt; was committed (June 9, 2016), and then zero failures since, so this failure seems suspicious to me, since this issue is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9191&quot; title=&quot;OverseerTaskQueue.peekTopN() fatally flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9191&quot;&gt;&lt;del&gt;SOLR-9191&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I beasted 200 iterations of OverseerTest without the patch, and got zero failures.&lt;/p&gt;</comment>
                            <comment id="15967064" author="caomanhdat" created="Thu, 13 Apr 2017 03:34:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; I think this is problem of the test. Can you run the test with this patch ( I increased the amount of time waiting for replica become active ). I also run testExternalClusterStateChangeBehavior for 1000 times and can not find any failure.&lt;/p&gt;</comment>
                            <comment id="15967149" author="caomanhdat" created="Thu, 13 Apr 2017 05:18:00 +0000"  >&lt;p&gt;A patch for this ticket. In this patch, we reuse the ChildWatcher (this is Noble idea) so in any case ( race conditions ) we always reach the line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;lastWatcher = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15967158" author="ichattopadhyaya" created="Thu, 13 Apr 2017 05:33:23 +0000"  >&lt;p&gt;Ran the test with original patch as well as 15s timeout patch 250 times each. I saw no failures. I can run this on better hardware early next week (my AMD Ryzen is arriving soon!).&lt;/p&gt;</comment>
                            <comment id="15967425" author="steve_rowe" created="Thu, 13 Apr 2017 11:19:43 +0000"  >&lt;p&gt;I beasted the latest patch (the one without the increased OverseerTest timeouts) for 200 iterations and got 2 failures - I&apos;ve attached their logs: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863247/12863247_OverseerTest.106.stdout&quot; title=&quot;OverseerTest.106.stdout attached to SOLR-10420&quot;&gt;OverseerTest.106.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; and &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863248/12863248_OverseerTest.119.stdout&quot; title=&quot;OverseerTest.119.stdout attached to SOLR-10420&quot;&gt;OverseerTest.119.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Next I&apos;ll try the patch with the OverseerTest changes.&lt;/p&gt;</comment>
                            <comment id="15967470" author="steve_rowe" created="Thu, 13 Apr 2017 11:48:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;Next I&apos;ll try the patch with the OverseerTest changes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I got 4 failures from 100 beasting iterations using this version of the patch.  The failures looked the same as the previously posted logs, so I won&apos;t add them.&lt;/p&gt;

&lt;p&gt;Next I&apos;ll try beasting the latest patch again, this time with DEBUG level on &lt;tt&gt;org.apache.solr.cloud&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15967499" author="steve_rowe" created="Thu, 13 Apr 2017 12:12:02 +0000"  >&lt;p&gt;I got 5 failures out of 100, attaching 3 of them here: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863260/12863260_OverseerTest.DEBUG.43.stdout&quot; title=&quot;OverseerTest.DEBUG.43.stdout attached to SOLR-10420&quot;&gt;OverseerTest.DEBUG.43.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863261/12863261_OverseerTest.DEBUG.48.stdout&quot; title=&quot;OverseerTest.DEBUG.48.stdout attached to SOLR-10420&quot;&gt;OverseerTest.DEBUG.48.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863262/12863262_OverseerTest.DEBUG.58.stdout&quot; title=&quot;OverseerTest.DEBUG.58.stdout attached to SOLR-10420&quot;&gt;OverseerTest.DEBUG.58.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15968618" author="dragonsinth" created="Fri, 14 Apr 2017 05:07:27 +0000"  >&lt;p&gt;Fix LGTM.&lt;/p&gt;

&lt;p&gt;Is this actual fix this?&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
      // we&apos;re not in a dirty state, and we do not have in-memory children&lt;br/&gt;
      if (lastWatcher != null) return null;&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;IE, if you just do that, would that fix the leak even without reusing the same object?&lt;/p&gt;</comment>
                            <comment id="15968869" author="caomanhdat" created="Fri, 14 Apr 2017 10:24:39 +0000"  >&lt;p&gt;It&apos;s actually fix the problem even without reusing the same object. But It makes the OverseerTest fail.&lt;/p&gt;</comment>
                            <comment id="15969839" author="caomanhdat" created="Sat, 15 Apr 2017 07:12:58 +0000"  >&lt;p&gt;I kinda find out the reason why the test failure. There are some notice here&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In current DQ version, for each time we peek() if in-memory queue is empty, we will actually look at the ZK to get new elements ( watcher are useless in this scenario )&lt;/li&gt;
	&lt;li&gt;With the patch, for each time we peek()  if in-memory queue is empty, we will only look at the ZK nodes when watcher tell us that there are change in our queue. So If ZK already contain new items we may still return empty.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So this is the reason why the test failure&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;overseer.queue &amp;lt;- set a replica down&lt;/li&gt;
	&lt;li&gt;overseer run the command successfully&lt;/li&gt;
	&lt;li&gt;overseer.queue &amp;lt;- set a replica active&lt;/li&gt;
	&lt;li&gt;overseer delay this command ( overseer.workqueue &amp;lt;- set a replica active )&lt;/li&gt;
	&lt;li&gt;touch /clusterstate.json to change its version&lt;/li&gt;
	&lt;li&gt;overseer.queue &amp;lt;- some ZKWriteCommand, let&apos;s call this one ZK1&lt;/li&gt;
	&lt;li&gt;overseer change the clusterstate to set replica active&lt;/li&gt;
	&lt;li&gt;overseer meet badversion exception&lt;/li&gt;
	&lt;li&gt;overseer fetch last element from overseer.workqueue. Here are where problem happen, overseer.workqueue.peek() return empty because the watcher is not fired.&lt;/li&gt;
	&lt;li&gt;overseer process ZK1, it success -&amp;gt; overseer.workqueue is emptied.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15969843" author="caomanhdat" created="Sat, 15 Apr 2017 07:23:31 +0000"  >&lt;p&gt;I&apos;m thinking about two different way to solve this problem :&lt;br/&gt;
1. DQ will set lastWatcher = null when we run &lt;tt&gt;DQ.offer(byte[] data)&lt;/tt&gt; sucessfully. Because the overseer.workqueue is locally offered by overseer so that will fix the problem. But we changed &lt;tt&gt;DQ.peek()&lt;/tt&gt; from true positive ( if ZK contain new item, we will return that ) to false positive ( if ZK contain new item, we may not return that ) so this may inflict other parts as well.&lt;br/&gt;
2. each time DQ.peek() is called we will look at the ZK nodes without using the watcher.&lt;/p&gt;</comment>
                            <comment id="15969865" author="caomanhdat" created="Sat, 15 Apr 2017 08:30:16 +0000"  >&lt;p&gt;I have a discussion with Noble. It seems that DQ are not used in any places except Overseer. So I will go with solution #1.&lt;/p&gt;

&lt;p&gt;Will beast the test in Steve machine tonight ( thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; a lot )&lt;/p&gt;</comment>
                            <comment id="15969966" author="caomanhdat" created="Sat, 15 Apr 2017 13:55:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; Can you review the patch?&lt;/p&gt;</comment>
                            <comment id="15970030" author="dragonsinth" created="Sat, 15 Apr 2017 17:14:03 +0000"  >&lt;p&gt;Let me try to unpack what you said..&lt;/p&gt;

&lt;p&gt;1) We want a synchronous offer() -&amp;gt; peek() on the same thread to return the item offered without delay.&lt;br/&gt;
2) This works on master, but the original patch to fix the leak breaks #1.&lt;/p&gt;

&lt;p&gt;Is that correct?&lt;/p&gt;

&lt;p&gt;Let me look at this on Monday with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhump&quot; class=&quot;user-hover&quot; rel=&quot;jhump&quot;&gt;jhump&lt;/a&gt;.  I&apos;m pretty sure there&apos;s a simplification to be made in DQ with how we&apos;re handling the watcher and dirty tracking.  There used to be an explicit &quot;isDirty&quot; bit that we traded out for watcher nullability, which in retrospect I&apos;m not sure was the best choice.&lt;/p&gt;</comment>
                            <comment id="15970205" author="caomanhdat" created="Sun, 16 Apr 2017 00:10:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; that&apos;s correct.&lt;/p&gt;

&lt;p&gt;The last patch pass all the tests. &lt;/p&gt;</comment>
                            <comment id="15970215" author="caomanhdat" created="Sun, 16 Apr 2017 00:59:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; As Steve said, Overseer.external.. test failed frequently before &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9191&quot; title=&quot;OverseerTaskQueue.peekTopN() fatally flawed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9191&quot;&gt;&lt;del&gt;SOLR-9191&lt;/del&gt;&lt;/a&gt; got committed. So I doubt that &quot;isDirty&quot; in retro-code will fix the problem.&lt;/p&gt;</comment>
                            <comment id="15970955" author="caomanhdat" created="Mon, 17 Apr 2017 10:33:22 +0000"  >&lt;p&gt;Latest patch, I would like not to reuse lastWatcher. It can come to this case&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;peek -&amp;gt; lastWatcher = resuseWatcher (1)
offer -&amp;gt; lastWatcher = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
peek -&amp;gt; lastWatcher = reuseWatcher (2)
(1) event -&amp;gt; lastWatcher = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15971259" author="dragonsinth" created="Mon, 17 Apr 2017 15:54:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; I didn&apos;t literally mean that we should bring back the isDirty bit.  I meant that clearly the last time around, there was a hole in the design that led to this leak.  I want to take the opportunity to re-look at the design again as a whole and make sure everything seems good, and we&apos;re not just putting a band-aid on it.  You may have already done this, so just give me a little bit to catch up. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15971753" author="dragonsinth" created="Mon, 17 Apr 2017 22:31:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhump&quot; class=&quot;user-hover&quot; rel=&quot;jhump&quot;&gt;jhump&lt;/a&gt; I think this may be the right approach after reviewing the overall design.  I don&apos;t see any real reason to specifically track lastWatcher, we just need to ensure that no more than one is ever set.  And having lastWatcher serve double-duty was a misdesign on my part.  There are really two separate stateful questions to answer:&lt;/p&gt;

&lt;p&gt;1) Is there a watcher set?&lt;br/&gt;
2) Are we known to be dirty?&lt;/p&gt;

&lt;p&gt;The answer to those two questions is not the same if we want to support same-thread synchronous offer -&amp;gt; poll working as you would want.  So this patch tracks them separately.&lt;/p&gt;</comment>
                            <comment id="15971964" author="caomanhdat" created="Tue, 18 Apr 2017 01:37:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; The patch LGTM! &lt;br/&gt;
I think this is good to reuse the watcher in your patch.&lt;/p&gt;</comment>
                            <comment id="15973070" author="caomanhdat" created="Tue, 18 Apr 2017 17:06:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; This issue is blocker for Solr 6.5.1. So I think we (you) should commit soon.&lt;/p&gt;</comment>
                            <comment id="15973093" author="dragonsinth" created="Tue, 18 Apr 2017 17:13:40 +0000"  >&lt;p&gt;Agreed.  It passes for me.  Anyone on this issue want to do any extensive testing of &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863715/SOLR-10420-dragonsinth.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12863715/SOLR-10420-dragonsinth.patch&lt;/a&gt; before I commit?  Otherwise I&apos;ll commit this today to master and then start backporting it to a number of branches.&lt;/p&gt;</comment>
                            <comment id="15973118" author="steve_rowe" created="Tue, 18 Apr 2017 17:31:14 +0000"  >&lt;p&gt;I did 500 beasting iterations of OverseerTest using your latest patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;, zero failures.&lt;/p&gt;

&lt;p&gt;I&apos;m running the full Solr core test suite a couple times now, I&apos;ll report back when it finishes (should be less than half an hour).&lt;/p&gt;</comment>
                            <comment id="15973207" author="steve_rowe" created="Tue, 18 Apr 2017 18:15:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m running the full Solr core test suite a couple times now, I&apos;ll report back when it finishes (should be less than half an hour).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I ran the solr-core and solrj suites three times each with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;&apos;s latest patch on master, and there were zero failures.&lt;/p&gt;</comment>
                            <comment id="15973246" author="dragonsinth" created="Tue, 18 Apr 2017 18:30:32 +0000"  >&lt;p&gt;Great!  Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt;!  I&apos;ll get this committed.&lt;/p&gt;</comment>
                            <comment id="15973261" author="jira-bot" created="Tue, 18 Apr 2017 18:44:30 +0000"  >&lt;p&gt;Commit 43c2b2320dcf344c42086ceb782e0fc53c439952 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=43c2b23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=43c2b23&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10420&quot; title=&quot;Solr 6.x leaking one SolrZkClient instance per second&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10420&quot;&gt;&lt;del&gt;SOLR-10420&lt;/del&gt;&lt;/a&gt;: fix watcher leak in DistributedQueue&lt;/p&gt;</comment>
                            <comment id="15973320" author="dragonsinth" created="Tue, 18 Apr 2017 19:14:35 +0000"  >&lt;p&gt;So my plan is to commit this to master, branch_6x, and branch_5x, and let the release managers pull it into the actual release branches.  SG?&lt;/p&gt;</comment>
                            <comment id="15973330" author="steve_rowe" created="Tue, 18 Apr 2017 19:22:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;So my plan is to commit this to master, branch_6x, and branch_5x, and let the release managers pull it into the actual release branches. SG?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think at a minimum you should also commit to branch_6_5, since it&apos;s definitely going to be released, and you&apos;ll be better equipped to handle conflicts if there are any.&lt;/p&gt;

&lt;p&gt;I noticed you set fixVersion to releases on branches you won&apos;t be committing to: 6.4.3, 5.5.5.  I don&apos;t think you should do that.  If you&apos;re going to commit to branch_5x, then the fixVersion would be 5.6, since that&apos;s the next release on that branch.  Unless you commit to branch_6_4, you shouldn&apos;t include 6.4.3 as a fixVersion.&lt;/p&gt;

&lt;p&gt;More generally, if you think it&apos;s essential that any X.Y.Z release includes this fix, i.e. that it would be a mistake to release without it, then you should commit to the branch from which that release will be made.  Otherwise you and others may/will forget to backport when such a release materializes.&lt;/p&gt;</comment>
                            <comment id="15973331" author="ichattopadhyaya" created="Tue, 18 Apr 2017 19:23:07 +0000"  >&lt;p&gt;I think you should do master, branch_6x and branch_6_5. branch_5x is optional.&lt;/p&gt;</comment>
                            <comment id="15973346" author="dragonsinth" created="Tue, 18 Apr 2017 19:33:24 +0000"  >&lt;p&gt;Got it.  I do think it would be a mistake.  In that case, after I&apos;ve committed to 5x and 6x, I&apos;ll also commit to 6_5 and 5_5.&lt;/p&gt;</comment>
                            <comment id="15973351" author="jira-bot" created="Tue, 18 Apr 2017 19:36:45 +0000"  >&lt;p&gt;Commit ae55dfc10fd3843d35df9096b7626aad36735670 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ae55dfc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ae55dfc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10420&quot; title=&quot;Solr 6.x leaking one SolrZkClient instance per second&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10420&quot;&gt;&lt;del&gt;SOLR-10420&lt;/del&gt;&lt;/a&gt;: fix watcher leak in DistributedQueue&lt;/p&gt;</comment>
                            <comment id="15973354" author="jira-bot" created="Tue, 18 Apr 2017 19:38:17 +0000"  >&lt;p&gt;Commit 42d08dd28c6609a2c70a691e6a88725c9aa31377 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=42d08dd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=42d08dd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10420&quot; title=&quot;Solr 6.x leaking one SolrZkClient instance per second&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10420&quot;&gt;&lt;del&gt;SOLR-10420&lt;/del&gt;&lt;/a&gt;: fix watcher leak in DistributedQueue&lt;/p&gt;</comment>
                            <comment id="15973382" author="jira-bot" created="Tue, 18 Apr 2017 20:04:25 +0000"  >&lt;p&gt;Commit e3beb61a72efbce37710ce3cc48b24093070d052 in lucene-solr&apos;s branch refs/heads/branch_6_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e3beb61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e3beb61&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10420&quot; title=&quot;Solr 6.x leaking one SolrZkClient instance per second&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10420&quot;&gt;&lt;del&gt;SOLR-10420&lt;/del&gt;&lt;/a&gt;: fix watcher leak in DistributedQueue&lt;/p&gt;</comment>
                            <comment id="15973453" author="jira-bot" created="Tue, 18 Apr 2017 20:43:54 +0000"  >&lt;p&gt;Commit 89beee8d61346d50dbbf02f0cc9cfc5032e46eee in lucene-solr&apos;s branch refs/heads/branch_5_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=89beee8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=89beee8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10420&quot; title=&quot;Solr 6.x leaking one SolrZkClient instance per second&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10420&quot;&gt;&lt;del&gt;SOLR-10420&lt;/del&gt;&lt;/a&gt;: fix watcher leak in DistributedQueue&lt;/p&gt;</comment>
                            <comment id="15974402" author="markus17" created="Wed, 19 Apr 2017 09:55:50 +0000"  >&lt;p&gt;Thanks! Great work!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12863247" name="OverseerTest.106.stdout" size="228172" author="sarowe" created="Thu, 13 Apr 2017 11:19:43 +0000"/>
                            <attachment id="12863248" name="OverseerTest.119.stdout" size="336392" author="sarowe" created="Thu, 13 Apr 2017 11:19:43 +0000"/>
                            <attachment id="12863053" name="OverseerTest.80.stdout" size="244609" author="sarowe" created="Wed, 12 Apr 2017 14:37:54 +0000"/>
                            <attachment id="12863260" name="OverseerTest.DEBUG.43.stdout" size="839216" author="sarowe" created="Thu, 13 Apr 2017 12:12:02 +0000"/>
                            <attachment id="12863261" name="OverseerTest.DEBUG.48.stdout" size="720546" author="sarowe" created="Thu, 13 Apr 2017 12:12:02 +0000"/>
                            <attachment id="12863262" name="OverseerTest.DEBUG.58.stdout" size="776847" author="sarowe" created="Thu, 13 Apr 2017 12:12:02 +0000"/>
                            <attachment id="12863715" name="SOLR-10420-dragonsinth.patch" size="6926" author="dragonsinth" created="Tue, 18 Apr 2017 00:48:27 +0000"/>
                            <attachment id="12863633" name="SOLR-10420.patch" size="4890" author="caomanhdat" created="Mon, 17 Apr 2017 10:33:22 +0000"/>
                            <attachment id="12863541" name="SOLR-10420.patch" size="4318" author="caomanhdat" created="Sat, 15 Apr 2017 08:30:16 +0000"/>
                            <attachment id="12863206" name="SOLR-10420.patch" size="3147" author="caomanhdat" created="Thu, 13 Apr 2017 05:18:00 +0000"/>
                            <attachment id="12863196" name="SOLR-10420.patch" size="5435" author="caomanhdat" created="Thu, 13 Apr 2017 03:34:59 +0000"/>
                            <attachment id="12863004" name="SOLR-10420.patch" size="2577" author="caomanhdat" created="Wed, 12 Apr 2017 10:51:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3d6q7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>