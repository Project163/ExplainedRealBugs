<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:10:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8367] The new LIR &apos;all replicas participate&apos; failsafe code needs to be improved.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8367</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;For one, it currently only kicks in the first attempted leader. If it&apos;s another replica that is stuck in LIR, it won&apos;t help.&lt;/p&gt;

&lt;p&gt;Second, when we attempt to be leader, knowing we might fail due to LIR, we should not put other replicas into recovery if they fail to sync with us - not until we know we will actually be leader.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12918667">SOLR-8367</key>
            <summary>The new LIR &apos;all replicas participate&apos; failsafe code needs to be improved.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Dec 2015 00:49:21 +0000</created>
                <updated>Mon, 9 May 2016 18:58:43 +0000</updated>
                            <resolved>Thu, 10 Dec 2015 16:22:28 +0000</resolved>
                                                    <fixVersion>5.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15046960" author="markrmiller@gmail.com" created="Tue, 8 Dec 2015 15:21:01 +0000"  >&lt;p&gt;Patch with initial logic change.&lt;/p&gt;

&lt;p&gt;We need to see if all the replicas are involved even if we are not the first replica in line for the leader election.&lt;/p&gt;

&lt;p&gt;We also wait to request recoveries until we actually see we will be the leader.&lt;/p&gt;</comment>
                            <comment id="15047142" author="markrmiller@gmail.com" created="Tue, 8 Dec 2015 17:48:30 +0000"  >&lt;p&gt;Working on a test, just hitting some issues. I think someone broke it so that when you restart a Jetty instance in a test, it&apos;s not getting the same data dir or something.&lt;/p&gt;</comment>
                            <comment id="15047208" author="markrmiller@gmail.com" created="Tue, 8 Dec 2015 18:31:03 +0000"  >&lt;p&gt;Or it&apos;s my head is dopey and I need to be hard coding a filesystem based directory.&lt;/p&gt;

&lt;p&gt;Just surprised that when you don&apos;t, tlogs don&apos;t survive restart either. Perhaps because of the old index dir cleanup code.&lt;/p&gt;</comment>
                            <comment id="15047612" author="markrmiller@gmail.com" created="Tue, 8 Dec 2015 22:42:06 +0000"  >&lt;p&gt;Okay, here is basically what we need with additional testing. Still need to give it another once over.&lt;/p&gt;</comment>
                            <comment id="15047731" author="mdrob" created="Wed, 9 Dec 2015 00:09:25 +0000"  >&lt;p&gt;SyncStrategy, the try-catch at line ~218 can go away.&lt;br/&gt;
Do we need to check &lt;tt&gt;isClosed&lt;/tt&gt; again during &lt;tt&gt;requestRecoveries&lt;/tt&gt;? It&apos;s possible that it&apos;s false when the recoveries are being set up, but changes to true later by the time we actually make the RPC.&lt;br/&gt;
An optimization might be to break out of the whole loop when closed, since it looks like not much will be happening anyway.&lt;/p&gt;

&lt;p&gt;In ZkController, can we log which retry we are on (in both places)? That will make parsing logs easier when this failure happens.&lt;/p&gt;

&lt;p&gt;You have a couple &lt;tt&gt;System.out.println&lt;/tt&gt; in SolrCore that could probably be &lt;tt&gt;log.debug&lt;/tt&gt; or even &lt;tt&gt;trace&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In the test, you could store &lt;tt&gt;(HttpSolrClient) clients.get(0)).getBaseURL()&lt;/tt&gt; as a local variable instead of loading it twice.&lt;/p&gt;

&lt;p&gt;If you&apos;re fixing shard count to 2 in the test, do we still want to &lt;tt&gt;createCollection(testCollectionName, 1, 3, 1);&lt;/tt&gt; for three shards?&lt;/p&gt;

&lt;p&gt;Architecture question &amp;#8211; What happens when you send an update FROMLEADER to the one that happens to be the leader? Also, why are we using decreasing versions?&lt;/p&gt;</comment>
                            <comment id="15048768" author="markrmiller@gmail.com" created="Wed, 9 Dec 2015 14:52:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;in SolrCore that could probably be log.debug or even trace.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;System.out is not allowed in SolrCore, I just have not cleaned up yet.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If you&apos;re fixing shard count to 2 in the test, do we still want to createCollection(testCollectionName, 1, 3, 1); for three shards?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, create api uses 3 shards (there is a control jetty).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What happens when you send an update FROMLEADER to the one that happens to be the leader?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;See the conflict exception we check for.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, why are we using decreasing versions?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Because it doesn&apos;t matter for this test.&lt;/p&gt;</comment>
                            <comment id="15048776" author="markrmiller@gmail.com" created="Wed, 9 Dec 2015 15:00:13 +0000"  >&lt;p&gt;I&apos;ve clean up the patch and beasted the test. Looking good.&lt;/p&gt;</comment>
                            <comment id="15048782" author="markrmiller@gmail.com" created="Wed, 9 Dec 2015 15:03:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;An optimization might be to break out of the whole loop when closed, since it looks like not much will be happening anyway.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Since they are all fired off async, I don&apos;t know that it is really worth it. All the isClosed stuff is really just best effort to bail early, but not really critical it&apos;s at every point.&lt;/p&gt;</comment>
                            <comment id="15049146" author="mdrob" created="Wed, 9 Dec 2015 18:32:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since they are all fired off async, I don&apos;t know that it is really worth it. All the isClosed stuff is really just best effort to bail early, but not really critical it&apos;s at every point.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I see what you&apos;re saying about it being async, so it was still possible for a close to sneak in before this patch as well. If we&apos;re closed, but still request a replica to recover, then I see that it has it&apos;s own checks for shutting down and closed as well so things will be fine there.&lt;/p&gt;

&lt;p&gt;Unrelated: while trying to trace the execution path here, I noticed that &lt;tt&gt;CoreAdminHandler::handleRequestRecoveryAction&lt;/tt&gt; creates a thread and starts it without either giving it a name or submitting it to an executor. Should I file a separate JIRA for that? Looks like that thread was added by you in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4254&quot; title=&quot;Harden the &amp;#39;leader requests replica to recover&amp;#39; code path.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4254&quot;&gt;&lt;del&gt;SOLR-4254&lt;/del&gt;&lt;/a&gt;, maybe that was before we had the executors everywhere.&lt;/p&gt;</comment>
                            <comment id="15049155" author="markrmiller@gmail.com" created="Wed, 9 Dec 2015 18:37:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;Should I file a separate JIRA for that? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, probably a good idea.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;maybe that was before we had the executors everywhere.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, most of the first pass cloud code was not using executors - recovery stuff, syncstrategy stuff, etc. Most of it has been converted over time.&lt;/p&gt;</comment>
                            <comment id="15049625" author="jira-bot" created="Wed, 9 Dec 2015 23:30:36 +0000"  >&lt;p&gt;Commit 1718987 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1718987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1718987&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8367&quot; title=&quot;The new LIR &amp;#39;all replicas participate&amp;#39; failsafe code needs to be improved.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8367&quot;&gt;&lt;del&gt;SOLR-8367&lt;/del&gt;&lt;/a&gt;: Fix the LeaderInitiatedRecovery &apos;all replicas participate&apos; fail-safe.&lt;/p&gt;</comment>
                            <comment id="15049928" author="jira-bot" created="Thu, 10 Dec 2015 03:02:45 +0000"  >&lt;p&gt;Commit 1719005 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1719005&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1719005&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8367&quot; title=&quot;The new LIR &amp;#39;all replicas participate&amp;#39; failsafe code needs to be improved.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8367&quot;&gt;&lt;del&gt;SOLR-8367&lt;/del&gt;&lt;/a&gt;: Fix the LeaderInitiatedRecovery &apos;all replicas participate&apos; fail-safe.&lt;/p&gt;</comment>
                            <comment id="15051178" author="markrmiller@gmail.com" created="Thu, 10 Dec 2015 16:22:28 +0000"  >&lt;p&gt;Thanks for the review Mike! Let me know if anything else comes up.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12894987">SOLR-8075</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12912278">SOLR-8279</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12776565" name="SOLR-8367.patch" size="17184" author="markrmiller@gmail.com" created="Wed, 9 Dec 2015 15:00:13 +0000"/>
                            <attachment id="12776424" name="SOLR-8367.patch" size="16170" author="markrmiller@gmail.com" created="Tue, 8 Dec 2015 22:42:06 +0000"/>
                            <attachment id="12776337" name="SOLR-8367.patch" size="5981" author="markrmiller@gmail.com" created="Tue, 8 Dec 2015 15:21:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pcxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>