<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:09:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7989] After a new leader is elected it, it should ensure it&apos;s state is ACTIVE if it has already registered with ZK.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7989</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;It is possible that a down replica gets elected as a leader, and that it stays down after the election.&lt;/p&gt;

&lt;p&gt;Here&apos;s how I hit upon this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There are 3 replicas: leader, notleader0, notleader1&lt;/li&gt;
	&lt;li&gt;Introduced network partition to isolate notleader0, notleader1 from leader (leader puts these two in LIR via zk).&lt;/li&gt;
	&lt;li&gt;Kill leader, remove partition. Now leader is dead, and both of notleader0 and notleader1 are down. There is no leader.&lt;/li&gt;
	&lt;li&gt;Remove LIR znodes in zk.&lt;/li&gt;
	&lt;li&gt;Wait a while, and there happens a (flawed?) leader election.&lt;/li&gt;
	&lt;li&gt;Finally, the state is such that one of notleader0 or notleader1 (which were down before) become leader, but stays down.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12860473">SOLR-7989</key>
            <summary>After a new leader is elected it, it should ensure it&apos;s state is ACTIVE if it has already registered with ZK.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="ichattopadhyaya">Ishan Chattopadhyaya</reporter>
                        <labels>
                    </labels>
                <created>Sat, 29 Aug 2015 03:32:11 +0000</created>
                <updated>Mon, 9 May 2016 18:56:14 +0000</updated>
                            <resolved>Fri, 13 Nov 2015 22:03:03 +0000</resolved>
                                                    <fixVersion>5.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14988858" author="ichattopadhyaya" created="Wed, 4 Nov 2015 04:32:04 +0000"  >&lt;p&gt;Finally understood why this is happening. &lt;/p&gt;

&lt;p&gt;When a DOWN replica is elected a leader, the ElectionContext&apos;s runLeaderProcess() finally tries to publish the new leader as well as the new state (now ACTIVE) in the same message. For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{
  &quot;operation&quot;:&quot;leader&quot;,
  &quot;shard&quot;:&quot;shard1&quot;,
  &quot;collection&quot;:&quot;forceleader_test_collection&quot;,
  &quot;base_url&quot;:&quot;http://127.0.0.1:36501/sz_sie&quot;,
  &quot;core&quot;:&quot;forceleader_test_collection_shard1_replica2&quot;,
  &quot;state&quot;:&quot;active&quot;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, the OverseerAction for LEADER operation doesn&apos;t actually update the &quot;state&quot; that was passed in. So, although the replica gets elected as the leader, its state stays DOWN in the cluster state. Example (immediately after the leader election in above example):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;shard1:{
  &quot;range&quot;:&quot;80000000-7fffffff&quot;,
  &quot;state&quot;:&quot;active&quot;,
  &quot;replicas&quot;:{
    &quot;core_node1&quot;:{
      &quot;core&quot;:&quot;forceleader_test_collection_shard1_replica1&quot;,
      &quot;base_url&quot;:&quot;http://127.0.0.1:44845/sz_sie&quot;,
      &quot;node_name&quot;:&quot;127.0.0.1:44845_sz_sie&quot;,
      &quot;state&quot;:&quot;down&quot;},
    &quot;core_node2&quot;:{
      &quot;state&quot;:&quot;down&quot;,
      &quot;base_url&quot;:&quot;http://127.0.0.1:36501/sz_sie&quot;,
      &quot;core&quot;:&quot;forceleader_test_collection_shard1_replica2&quot;,
      &quot;node_name&quot;:&quot;127.0.0.1:36501_sz_sie&quot;,
      &quot;leader&quot;:&quot;true&quot;},
    &quot;core_node3&quot;:{
      &quot;state&quot;:&quot;down&quot;,
      &quot;base_url&quot;:&quot;http://127.0.0.1:33088/sz_sie&quot;,
      &quot;core&quot;:&quot;forceleader_test_collection_shard1_replica3&quot;,
      &quot;node_name&quot;:&quot;127.0.0.1:33088_sz_sie&quot;}}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll raise a patch for this soon.&lt;/p&gt;</comment>
                            <comment id="14988863" author="ichattopadhyaya" created="Wed, 4 Nov 2015 04:41:52 +0000"  >&lt;p&gt;Patch for fixing this problem.&lt;br/&gt;
Split out the current overseer LEADER operation message into two messages, one for the LEADER and one for the STATE.&lt;/p&gt;</comment>
                            <comment id="14988867" author="ichattopadhyaya" created="Wed, 4 Nov 2015 04:48:30 +0000"  >&lt;p&gt;The DownLeaderTest passes after this fix, fails without it.&lt;/p&gt;

&lt;p&gt;I&apos;m adding the test separate from the patch for fix, since this test relies on a very specific scenario to hit this bug. However, there might be a more generic way of simulating the same scenario, just that I can&apos;t think of any simpler way of simulating in a unit test.&lt;/p&gt;</comment>
                            <comment id="14989195" author="noble.paul" created="Wed, 4 Nov 2015 09:26:12 +0000"  >&lt;p&gt;Send the state=ACTIVE first before the LEADER msg&lt;br/&gt;
Let&apos;s check if the node is actually active before sending the state=ACTIVE message &lt;/p&gt;</comment>
                            <comment id="14989284" author="ichattopadhyaya" created="Wed, 4 Nov 2015 10:34:23 +0000"  >&lt;p&gt;Thanks Noble, makes sense. Changed the order of the two messages.&lt;/p&gt;</comment>
                            <comment id="14989460" author="ichattopadhyaya" created="Wed, 4 Nov 2015 12:20:43 +0000"  >&lt;p&gt;Forgot the check for current state in the last patch. Added it now.&lt;/p&gt;</comment>
                            <comment id="14989679" author="ichattopadhyaya" created="Wed, 4 Nov 2015 15:18:32 +0000"  >&lt;p&gt;This check for state, and more precisely the use of zkStateReader to update/access the cluster state, is causing a hang/stall in `LeaderElectionTest`. I&apos;m looking into the reason / fix.&lt;/p&gt;</comment>
                            <comment id="14989699" author="ichattopadhyaya" created="Wed, 4 Nov 2015 15:25:30 +0000"  >&lt;p&gt;From that test, &lt;tt&gt;LeaderElectionTest&lt;/tt&gt;, the clusterstate was obtained as null. Added a check for that, so now the test passes smoothly as before.&lt;/p&gt;

&lt;p&gt;Attached the updated patch, running full suite of tests now.&lt;/p&gt;</comment>
                            <comment id="14989720" author="markrmiller@gmail.com" created="Wed, 4 Nov 2015 15:32:10 +0000"  >&lt;p&gt;Great catch Ishan!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Here&apos;s how I hit upon this:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can we catch this in a unit test using the proxy jetties to simulate the partitions?&lt;/p&gt;</comment>
                            <comment id="14989723" author="markrmiller@gmail.com" created="Wed, 4 Nov 2015 15:33:18 +0000"  >&lt;p&gt;Nevermind, I see a new test is broken out on it&apos;s own, was just looking at the patch files. Awesome.&lt;/p&gt;</comment>
                            <comment id="14989741" author="noble.paul" created="Wed, 4 Nov 2015 15:39:54 +0000"  >&lt;p&gt;That is a unit test. Never has any clusterstate . It only tests for leader election&lt;/p&gt;</comment>
                            <comment id="14989768" author="ichattopadhyaya" created="Wed, 4 Nov 2015 15:53:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can we catch this in a unit test using the proxy jetties to simulate the partitions?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, there&apos;s the DownLeaderTest. However, I don&apos;t think we should commit the test. The test is quite a complex way of proving that there is a problem, and that the problem is fixed once this patch goes in. But, it relies on LIR logic, and if LIR code changes later, the test will have to keep up with that, which is maintenance work. I couldn&apos;t find an easier way (apart from LIR) to trigger this particular situation (down replica becoming leader, staying down).&lt;/p&gt;</comment>
                            <comment id="14989798" author="markrmiller@gmail.com" created="Wed, 4 Nov 2015 16:06:23 +0000"  >&lt;p&gt;I&apos;d still lean toward trying to get that test in, even if just in some nightly form. I think these specific tests are great. And I&apos;m hoping LIR is not going to have to change too much. As recovery code hardens, it should actually continually change less and less is my hope.&lt;/p&gt;

&lt;p&gt;Up to you though, I get the current concern with the test. But while the test is specific, it doesn&apos;t seem too terribly complicated. And we are going to want to add more and more specific tests over time. Perhaps we should do some work to make a test like this more possible with built in support somehow?&lt;/p&gt;</comment>
                            <comment id="14989824" author="erickerickson" created="Wed, 4 Nov 2015 16:21:28 +0000"  >&lt;p&gt;How about just a comment in the test about &quot;don&apos;t waste too much time making this test pass if LIR code changes&quot; or something?&lt;/p&gt;</comment>
                            <comment id="14991446" author="ichattopadhyaya" created="Thu, 5 Nov 2015 10:09:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Attached the updated patch, running full suite of tests now.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ran many times now, some test or the other fails. Neither of them reproducible. I think this is good to go in.&lt;/p&gt;

&lt;p&gt;I just realized that I&apos;ve written up a very similar test for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7569&quot; title=&quot;Create an API to force a leader election between nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7569&quot;&gt;&lt;del&gt;SOLR-7569&lt;/del&gt;&lt;/a&gt; (ForceLeaderTest). One of the tests in that suite does exactly what the DownLeaderTest is doing here. As with the test here, that test too fails without this patch in. Only difference is that in that test, the call to FORCELEADER is clearing the LIR state, whereas the DownLeaderTest here is clearing the LIR state directly. I think we should ignore the test here and when &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7569&quot; title=&quot;Create an API to force a leader election between nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7569&quot;&gt;&lt;del&gt;SOLR-7569&lt;/del&gt;&lt;/a&gt; goes in, we&apos;ll have a test that covers the code path taken in this patch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; Can you please review and commit this? Thanks.&lt;/p&gt;</comment>
                            <comment id="14991619" author="jira-bot" created="Thu, 5 Nov 2015 12:51:28 +0000"  >&lt;p&gt;Commit 1712753 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1712753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1712753&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;: After a new leader is elected it should change it&apos;s state to ACTIVE even&lt;br/&gt;
  if the last published state is something else&lt;/p&gt;</comment>
                            <comment id="14991715" author="jira-bot" created="Thu, 5 Nov 2015 14:19:54 +0000"  >&lt;p&gt;Commit 1712781 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1712781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1712781&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;: After a new leader is elected it should change it&apos;s state to ACTIVE even&lt;br/&gt;
if the last published state is something else&lt;/p&gt;</comment>
                            <comment id="14991716" author="ichattopadhyaya" created="Thu, 5 Nov 2015 14:21:19 +0000"  >&lt;p&gt;Thanks, Noble!&lt;/p&gt;</comment>
                            <comment id="14992163" author="markrmiller@gmail.com" created="Thu, 5 Nov 2015 18:17:45 +0000"  >&lt;p&gt;I think I was just hitting this pretty consistently while working on a new ChaosMonkey type test after fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8244&quot; title=&quot;ChaosMonkey is not actually expiring connections or causing connection loss anymore.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8244&quot;&gt;SOLR-8244&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Had a live and down replica at the end that would never recover. Updated to this commit and it no longer happens.&lt;/p&gt;</comment>
                            <comment id="14998758" author="markrmiller@gmail.com" created="Tue, 10 Nov 2015 15:36:00 +0000"  >&lt;p&gt;Why do we use the stale clusterstate to see if we are already active and prevent publishing active if we are not? Doesn&apos;t that just allow for unknown races? Shouldn&apos;t we just publish active regardless?&lt;/p&gt;</comment>
                            <comment id="14999972" author="ichattopadhyaya" created="Wed, 11 Nov 2015 05:47:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t we just publish active regardless?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s what I wanted to do in my initial patch. Though, upon&apos;s Noble&apos;s comment to add the check, I thought it would help reduce one overseer message and be more efficient.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why do we use the stale clusterstate to see if we are already active and prevent publishing active if we are not?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What do you think we should do, do you suggest (1) we force update the cluster state before the check so that we don&apos;t check against stale clusterstate, or (2) send the active state message regardless?&lt;/p&gt;

&lt;p&gt;Attaching the patch for (1), this required a change to the LeaderElectionTest. &lt;/p&gt;

&lt;p&gt;To do (2), it would require a change to OverseerTest.testOverseerStatsReset (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8249&quot; title=&quot;OverseerTest failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8249&quot;&gt;&lt;del&gt;SOLR-8249&lt;/del&gt;&lt;/a&gt;), and I don&apos;t currently know how to make it work if the STATE=ACTIVE message is sent regardless. If that&apos;s the way you suggest we should go, maybe I could raise a patch to send the message without a state check and disable the test for now.&lt;/p&gt;</comment>
                            <comment id="15000256" author="noble.paul" created="Wed, 11 Nov 2015 11:24:47 +0000"  >&lt;p&gt;99/100 times the state=ACTIVE&lt;/p&gt;

&lt;p&gt;you can do a force read before checking the state .&lt;/p&gt;</comment>
                            <comment id="15000414" author="ichattopadhyaya" created="Wed, 11 Nov 2015 14:15:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;you can do a force read before checking the state .&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s what I think I&apos;ve done in the last patch. Can you/Mark please review?&lt;br/&gt;
Sorry for missing this out; I did this update cluster state in a patch before the original commit itself; but the LeaderElectionTest failure threw me off and I somehow missed the update cluster state in the final patch for the commit.&lt;/p&gt;</comment>
                            <comment id="15000474" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 15:04:56 +0000"  >&lt;p&gt;I actually think this is wrong on other levels.&lt;/p&gt;

&lt;p&gt;All publishing of state should go through ZkController - we do things like track the last published state. I&apos;m not sure this is the right place to do this either. I&apos;m reviewing this in another issue.&lt;/p&gt;</comment>
                            <comment id="15000483" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 15:11:58 +0000"  >&lt;p&gt;Also, what about basic stuff like:&lt;/p&gt;

&lt;p&gt;Core starts up, starts election, it&apos;s not active. Becomes leader, it&apos;s not active so it&apos;s made active with this change.&lt;/p&gt;

&lt;p&gt;Now register is called. Register has the core do tlog replay and then is ready to go active. So it does. But we are already active too early?&lt;/p&gt;</comment>
                            <comment id="15000486" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 15:12:49 +0000"  >&lt;p&gt;There is def an issue to be fixed here, but I think it may be more complicated than this.&lt;/p&gt;</comment>
                            <comment id="15000554" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 15:54:22 +0000"  >&lt;p&gt;Hmm...doesn&apos;t this test create the problem itself?&lt;/p&gt;

&lt;p&gt;It puts all bunch of replicas in LIR manually, causing the DOWN state. Then it manually clears LIR and tries to see who will become leader.&lt;/p&gt;

&lt;p&gt;This is not a normal case?&lt;/p&gt;

&lt;p&gt;In any case, I will revert the current fix. Now I think the test may be creating the problem itself, but regardless, this change really breaks things.&lt;/p&gt;</comment>
                            <comment id="15000571" author="jira-bot" created="Wed, 11 Nov 2015 16:02:52 +0000"  >&lt;p&gt;Commit 1713882 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1713882&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1713882&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;: Revert changes.&lt;/p&gt;</comment>
                            <comment id="15000574" author="jira-bot" created="Wed, 11 Nov 2015 16:05:45 +0000"  >&lt;p&gt;Commit 1713883 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1713883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1713883&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;: Revert changes.&lt;/p&gt;</comment>
                            <comment id="15000576" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 16:06:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ichattopadhyaya&quot; class=&quot;user-hover&quot; rel=&quot;ichattopadhyaya&quot;&gt;ichattopadhyaya&lt;/a&gt;, I don&apos;t think this is a valid test at all.&lt;/p&gt;

&lt;p&gt;Why does it clear LIR while Solr is running? That is not a valid real world scenario.&lt;/p&gt;</comment>
                            <comment id="15000578" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 16:10:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why does it clear LIR while Solr is running? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I guess this tests our emergency force a leader API? That&apos;s part of why that API is so janky. It&apos;s not really valid to simply clear out LIR nodes on a running system. And it&apos;s a really hard problem to make it doable - this approach certainly won&apos;t work.&lt;/p&gt;

&lt;p&gt;What we really need to do is fix things so it&apos;s not needed.&lt;/p&gt;</comment>
                            <comment id="15000721" author="jira-bot" created="Wed, 11 Nov 2015 17:26:28 +0000"  >&lt;p&gt;Commit 1713898 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1713898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1713898&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7569&quot; title=&quot;Create an API to force a leader election between nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7569&quot;&gt;&lt;del&gt;SOLR-7569&lt;/del&gt;&lt;/a&gt;: Ignore this test.&lt;/p&gt;</comment>
                            <comment id="15000725" author="jira-bot" created="Wed, 11 Nov 2015 17:27:52 +0000"  >&lt;p&gt;Commit 1713899 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1713899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1713899&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7569&quot; title=&quot;Create an API to force a leader election between nodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7569&quot;&gt;&lt;del&gt;SOLR-7569&lt;/del&gt;&lt;/a&gt;: Ignore this test.&lt;/p&gt;</comment>
                            <comment id="15000794" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 18:00:14 +0000"  >&lt;p&gt;Something like this might work.&lt;/p&gt;</comment>
                            <comment id="15001034" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 20:28:18 +0000"  >&lt;p&gt;New version.&lt;/p&gt;

&lt;p&gt;Added some logging.&lt;/p&gt;

&lt;p&gt;Changed so we won&apos;t publish ACTIVE after a leader election win if the current state is RECOVERING. Doesn&apos;t seem safe to force a move from RECOVERING to ACTIVE.&lt;/p&gt;</comment>
                            <comment id="15002241" author="ichattopadhyaya" created="Thu, 12 Nov 2015 15:32:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think this is a valid test at all. Why does it clear LIR while Solr is running? That is not a valid real world scenario.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Indeed, that&apos;s why I didn&apos;t include it in the patch. I just wanted to bring out that there is a problem, but then I couldn&apos;t replicate it in a test in any other way that represents a real world situation. However, just that fact that there were two messages passed as one (LEADER message had a state param) indicated to me that we should, in theory, split them out.&lt;/p&gt;

&lt;p&gt;+1 to your patch, I hadn&apos;t considered the core registration scenario. Also, the change from only DOWN to ACTIVE makes sense, and excluding the RECOVERING to ACTIVE change.&lt;/p&gt;</comment>
                            <comment id="15002288" author="markrmiller@gmail.com" created="Thu, 12 Nov 2015 15:55:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Indeed, that&apos;s why I didn&apos;t include it in the patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that doing that is fine in a test - we just have to carefully understand what we are testing and what we are fixing. This one was particularly tricky - I did not catch the issue the first few times I looked at it. Many things are impossible to test without some of this artificial hand waving though.&lt;/p&gt;
</comment>
                            <comment id="15004035" author="markrmiller@gmail.com" created="Fri, 13 Nov 2015 14:31:18 +0000"  >&lt;p&gt;Also, something I was not really aware of initially, what you are doing does seem to be a valid test for the force leader API that you added in the other issue.&lt;/p&gt;</comment>
                            <comment id="15004038" author="jira-bot" created="Fri, 13 Nov 2015 14:33:28 +0000"  >&lt;p&gt;Commit 1714211 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1714211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1714211&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;: After a new leader is elected it, it should ensure it&apos;s state is ACTIVE if it has already registered with ZK.&lt;/p&gt;</comment>
                            <comment id="15004040" author="jira-bot" created="Fri, 13 Nov 2015 14:35:28 +0000"  >&lt;p&gt;Commit 1714212 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1714212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1714212&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7989&quot; title=&quot;After a new leader is elected it, it should ensure it&amp;#39;s state is ACTIVE if it has already registered with ZK.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7989&quot;&gt;&lt;del&gt;SOLR-7989&lt;/del&gt;&lt;/a&gt;: After a new leader is elected it, it should ensure it&apos;s state is ACTIVE if it has already registered with ZK.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12831089">SOLR-7569</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12770519" name="DownLeaderTest.java" size="7544" author="ichattopadhyaya" created="Wed, 4 Nov 2015 04:48:30 +0000"/>
                            <attachment id="12753115" name="DownLeaderTest.java" size="7542" author="ichattopadhyaya" created="Sat, 29 Aug 2015 03:33:55 +0000"/>
                            <attachment id="12771833" name="SOLR-7989.patch" size="6723" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 20:28:18 +0000"/>
                            <attachment id="12771803" name="SOLR-7989.patch" size="3812" author="markrmiller@gmail.com" created="Wed, 11 Nov 2015 18:00:14 +0000"/>
                            <attachment id="12771700" name="SOLR-7989.patch" size="1984" author="ichattopadhyaya" created="Wed, 11 Nov 2015 05:48:14 +0000"/>
                            <attachment id="12770601" name="SOLR-7989.patch" size="3417" author="ichattopadhyaya" created="Wed, 4 Nov 2015 15:25:30 +0000"/>
                            <attachment id="12770580" name="SOLR-7989.patch" size="3422" author="ichattopadhyaya" created="Wed, 4 Nov 2015 12:20:43 +0000"/>
                            <attachment id="12770568" name="SOLR-7989.patch" size="2104" author="ichattopadhyaya" created="Wed, 4 Nov 2015 10:34:23 +0000"/>
                            <attachment id="12770516" name="SOLR-7989.patch" size="2150" author="ichattopadhyaya" created="Wed, 4 Nov 2015 04:41:52 +0000"/>
                            <attachment id="12770575" name="SOLR-8233.patch" size="4750" author="ichattopadhyaya" created="Wed, 4 Nov 2015 11:44:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jk8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>