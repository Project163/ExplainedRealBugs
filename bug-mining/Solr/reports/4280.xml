<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:39:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13678] ZkStateReader.removeCollectionPropsWatcher can deadlock with concurrent zkCallback thread on props watcher</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13678</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;while investigating an (unrelated) test bug in CollectionPropsTest I discovered a deadlock situation that can occur when calling &lt;tt&gt;ZkStateReader.removeCollectionPropsWatcher()&lt;/tt&gt; if a zkCallback thread tries to concurrently fire the watchers set on the collection props.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ZkStateReader.removeCollectionPropsWatcher()&lt;/tt&gt; is itself called when a &lt;tt&gt;CollectionPropsWatcher.onStateChanged()&lt;/tt&gt; impl returns &quot;true&quot; &amp;#8211; meaning that IIUC any usage of &lt;tt&gt;CollectionPropsWatcher&lt;/tt&gt; could potentially result in this type of deadlock situation. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;TEST-CollectionPropsTest.testReadWriteCached-seed#[D3C6921874D1CFEB]&quot; #15 prio=5 os_prio=0 cpu=567.78ms elapsed=682.12s tid=0x00007
fa5e8343800 nid=0x3f61 waiting for monitor entry  [0x00007fa62d222000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at org.apache.solr.common.cloud.ZkStateReader.lambda$removeCollectionPropsWatcher$20(ZkStateReader.java:2001)
        - waiting to lock &amp;lt;0x00000000e6207500&amp;gt; (a java.util.concurrent.ConcurrentHashMap)
        at org.apache.solr.common.cloud.ZkStateReader$$Lambda$617/0x00000001006c1840.apply(Unknown Source)
        at java.util.concurrent.ConcurrentHashMap.compute(java.base@11.0.3/ConcurrentHashMap.java:1932)
        - locked &amp;lt;0x00000000eb9156b8&amp;gt; (a java.util.concurrent.ConcurrentHashMap$Node)
        at org.apache.solr.common.cloud.ZkStateReader.removeCollectionPropsWatcher(ZkStateReader.java:1994)
        at org.apache.solr.cloud.CollectionPropsTest.testReadWriteCached(CollectionPropsTest.java:125)

...

&quot;zkCallback-88-thread-2&quot; #213 prio=5 os_prio=0 cpu=14.06ms elapsed=672.65s tid=0x00007fa6041bf000 nid=0x402f waiting for monitor ent
ry  [0x00007fa5b8f39000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at java.util.concurrent.ConcurrentHashMap.compute(java.base@11.0.3/ConcurrentHashMap.java:1923)
        - waiting to lock &amp;lt;0x00000000eb9156b8&amp;gt; (a java.util.concurrent.ConcurrentHashMap$Node)
        at org.apache.solr.common.cloud.ZkStateReader$PropsNotification.&amp;lt;init&amp;gt;(ZkStateReader.java:2262)
        at org.apache.solr.common.cloud.ZkStateReader.notifyPropsWatchers(ZkStateReader.java:2243)
        at org.apache.solr.common.cloud.ZkStateReader$PropsWatcher.refreshAndWatch(ZkStateReader.java:1458)
        - locked &amp;lt;0x00000000e6207500&amp;gt; (a java.util.concurrent.ConcurrentHashMap)
        at org.apache.solr.common.cloud.ZkStateReader$PropsWatcher.process(ZkStateReader.java:1440)
        at org.apache.solr.common.cloud.SolrZkClient$ProcessWatchWithExecutor.lambda$process$1(SolrZkClient.java:838)
        at org.apache.solr.common.cloud.SolrZkClient$ProcessWatchWithExecutor$$Lambda$253/0x00000001004a4440.run(Unknown Source)
        at java.util.concurrent.Executors$RunnableAdapter.call(java.base@11.0.3/Executors.java:515)
        at java.util.concurrent.FutureTask.run(java.base@11.0.3/FutureTask.java:264)
        at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:209)
        at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor$$Lambda$140/0x0000000100308c40.run(Unknown Source)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@11.0.3/ThreadPoolExecutor.java:1128)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@11.0.3/ThreadPoolExecutor.java:628)
        at java.lang.Thread.run(java.base@11.0.3/Thread.java:834)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13248666">SOLR-13678</key>
            <summary>ZkStateReader.removeCollectionPropsWatcher can deadlock with concurrent zkCallback thread on props watcher</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Aug 2019 21:52:10 +0000</created>
                <updated>Tue, 21 Jan 2020 16:56:07 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16899231" author="hossman" created="Fri, 2 Aug 2019 21:58:02 +0000"  >&lt;p&gt;attaching the full jstack output that i captured from observing this during a run of &lt;tt&gt;CollectionPropsTest.testReadWriteCached&lt;/tt&gt; (ie: the source of the snippet included in the summary)&lt;/p&gt;

&lt;p&gt;Please note that i captured this threaddump while in the process of testing some unrelated changes to other methods in &lt;tt&gt;CollectionPropsTest&lt;/tt&gt; &amp;#8211; i believe all of my local changes to that test class at the time this thread dump was captured were to code that appeared farther down in the test file then any line numbers that might be mentioned in this threaddump, so all line numbers should be accurate on master circa ~ 52b5ec8068, but i&apos;m not 100% certain.  the key thing to focus on is the line numbers and callstack for the non-test code .... i am 100% certain i had no local changes to the &lt;tt&gt;CollectionPropsTest.testReadWriteCached&lt;/tt&gt;, or any non-test code.&lt;/p&gt;</comment>
                            <comment id="16899236" author="hossman" created="Fri, 2 Aug 2019 22:04:02 +0000"  >&lt;p&gt;AFAICT CollectionPropWatcher isn&apos;t used internally by solr anywhere, so this issue will only ipmact solr clients that explicitly register their own watchers.&lt;br/&gt;
/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tflobbe&quot; class=&quot;user-hover&quot; rel=&quot;tflobbe&quot;&gt;tflobbe&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prusko&quot; class=&quot;user-hover&quot; rel=&quot;prusko&quot;&gt;prusko&lt;/a&gt; and linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11960&quot; title=&quot;Add collection level properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11960&quot;&gt;&lt;del&gt;SOLR-11960&lt;/del&gt;&lt;/a&gt; where this was ntroduced.&lt;/p&gt;</comment>
                            <comment id="16900310" author="jira-bot" created="Mon, 5 Aug 2019 18:49:44 +0000"  >&lt;p&gt;Commit a052fb5436840b45909446668c1137cb3f266c99 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a052fb5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a052fb5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13678&quot; title=&quot;ZkStateReader.removeCollectionPropsWatcher can deadlock with concurrent zkCallback thread on props watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13678&quot;&gt;SOLR-13678&lt;/a&gt;: Harden CollectionPropsTest.testReadWriteCached to work around removeCollectionPropsWatcher() deadlock bug&lt;/p&gt;</comment>
                            <comment id="16900323" author="jira-bot" created="Mon, 5 Aug 2019 19:03:30 +0000"  >&lt;p&gt;Commit b18041476ff0ad710c2ddf423cc4a9b0edddba4e in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b180414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b180414&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13678&quot; title=&quot;ZkStateReader.removeCollectionPropsWatcher can deadlock with concurrent zkCallback thread on props watcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13678&quot;&gt;SOLR-13678&lt;/a&gt;: Harden CollectionPropsTest.testReadWriteCached to work around removeCollectionPropsWatcher() deadlock bug&lt;/p&gt;

&lt;p&gt;(cherry picked from commit a052fb5436840b45909446668c1137cb3f266c99)&lt;/p&gt;</comment>
                            <comment id="16901371" author="tomasflobbe" created="Tue, 6 Aug 2019 18:46:00 +0000"  >&lt;p&gt;Thanks Hoss. I&apos;ll try to take a look as soon as I can.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13137311">SOLR-11960</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12976582" name="collectionpropswatcher-deadlock-jstack.txt" size="160514" author="hossman" created="Fri, 2 Aug 2019 21:52:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05apk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>