<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:31:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2045] DIH doesn&apos;t release jdbc connections in conjunction with DB2 </title>
                <link>https://issues.apache.org/jira/browse/SOLR-2045</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Using the JDBCDatasource in conjunction with the DB2 JDBC Drivers results in the following error when the DIH tries to close the the connection due to active transactions. As a consequence each delta im port or full import opens a new connection without closing it. So the maximum amount of connections will be reached soon. Setting the connection to readOnly or changing the transaction isolation level doesn&apos;t help neither.&lt;/p&gt;

&lt;p&gt;The JDBC Driver I used: &quot;com.ibm.db2.jcc.DB2Driver&quot; relieing in db2jcc4.jar shipped with DB2 Express 9.7 for example&lt;/p&gt;

&lt;p&gt;Here is the stack trace...&lt;/p&gt;

&lt;p&gt;14.08.2010 01:49:51 org.apache.solr.handler.dataimport.JdbcDataSource closeConnection&lt;br/&gt;
FATAL: Ignoring Error when closing connection&lt;br/&gt;
com.ibm.db2.jcc.am.SqlException: &lt;span class=&quot;error&quot;&gt;&amp;#91;jcc&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;10251&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;10308&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;4.8.87&amp;#93;&lt;/span&gt; java.sql.Connection.close() requested while a transaction is in progress on the connection.The transaction remains active, and the connection cannot be closed. ERRORCODE=-4471, SQLSTATE=null&lt;br/&gt;
	at com.ibm.db2.jcc.am.gd.a(gd.java:660)&lt;br/&gt;
	at com.ibm.db2.jcc.am.gd.a(gd.java:60)&lt;br/&gt;
	at com.ibm.db2.jcc.am.gd.a(gd.java:120)&lt;br/&gt;
	at com.ibm.db2.jcc.am.lb.u(lb.java:1202)&lt;br/&gt;
	at com.ibm.db2.jcc.am.lb.x(lb.java:1225)&lt;br/&gt;
	at com.ibm.db2.jcc.am.lb.v(lb.java:1211)&lt;br/&gt;
	at com.ibm.db2.jcc.am.lb.close(lb.java:1195)&lt;br/&gt;
	at com.ibm.db2.jcc.uw.UWConnection.close(UWConnection.java:838)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.JdbcDataSource.closeConnection(JdbcDataSource.java:399)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.JdbcDataSource.close(JdbcDataSource.java:390)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.DataConfig$Entity.clearCache(DataConfig.java:173)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.DataConfig.clearCaches(DataConfig.java:331)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:339)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:389)&lt;br/&gt;
	at org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:370)&lt;/p&gt;

&lt;p&gt;Well the issue can be solved by invoking a commit or rollback directly before the connection.close() statement. Here is the code snipped of changes I made in JdbcDatasource.java&lt;/p&gt;

&lt;p&gt;  private void closeConnection()  {&lt;br/&gt;
    try {&lt;br/&gt;
      if (conn != null) {&lt;/p&gt;

&lt;p&gt;    	if (conn.isReadOnly())&lt;br/&gt;
		&lt;/p&gt;
{
			LOG.info(&quot;connection is readonly, therefore rollback&quot;);
			conn.rollback();
		}
&lt;p&gt; else&lt;/p&gt;
		{
			LOG.info(&quot;connection is not readonly, therefore commit&quot;);
			conn.commit();
		}

&lt;p&gt;        conn.close();&lt;br/&gt;
      }&lt;br/&gt;
    } catch (Exception e) &lt;/p&gt;
{
      LOG.error(&quot;Ignoring Error when closing connection&quot;, e);
    }
&lt;p&gt;  }&lt;/p&gt;
</description>
                <environment>&lt;p&gt;DB2 SQLLIB 9.5, 9.7 jdbc Driver&lt;/p&gt;</environment>
        <key id="12471593">SOLR-2045</key>
            <summary>DIH doesn&apos;t release jdbc connections in conjunction with DB2 </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdyer">James Dyer</assignee>
                                    <reporter username="fenlor">Fenlor Sebastia</reporter>
                        <labels>
                    </labels>
                <created>Sat, 14 Aug 2010 00:03:36 +0000</created>
                <updated>Mon, 9 May 2016 18:56:52 +0000</updated>
                            <resolved>Mon, 12 Nov 2012 17:45:09 +0000</resolved>
                                    <version>1.4.1</version>
                    <version>3.6</version>
                    <version>4.0</version>
                                    <fixVersion>4.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>contrib - DataImportHandler</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="12915577" author="lancenorskog" created="Tue, 28 Sep 2010 00:49:01 +0000"  >&lt;p&gt;Mysql has the same problem: incremental updates do not reuse a connection and therefore fail.&lt;/p&gt;</comment>
                            <comment id="12933479" author="kjetilod" created="Thu, 18 Nov 2010 17:10:13 +0000"  >&lt;p&gt;We see the same issue on Oracle (11g).&lt;/p&gt;</comment>
                            <comment id="13047948" author="alexey" created="Sat, 11 Jun 2011 16:55:54 +0000"  >&lt;p&gt;I encountered the same problem with Derby database. The reason is that you need to issue commit or rollback before releasing jdbc connection (that&apos;s ridiculous requirement but it is what it is). So this patch fixing this problem.&lt;/p&gt;

&lt;p&gt;But there&apos;s even more easy workaround that doesn&apos;t require patching Solr sources. You can set data source autoCommit property to true.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Setting the connection to readOnly or changing the transaction isolation level doesn&apos;t help neither.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;readOnly property should help as well, but there&apos;s a bug in parameters parsing logic. Documentation claims that readOnly parameter causes setting autoCommit property to true, but that&apos;s not true as the next conditional statement resets this property back to false.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;&quot;JDBCDataSource.createConnectionFactory:164&quot;&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.parseBoolean(initProps.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;readOnly&quot;&lt;/span&gt;))) {
  c.setReadOnly(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
  &lt;span class=&quot;code-comment&quot;&gt;// Add other sane defaults
&lt;/span&gt;  c.setAutoCommit(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
  c.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);
  c.setHoldability(ResultSet.CLOSE_CURSORS_AT_COMMIT);
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.parseBoolean(initProps.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;autoCommit&quot;&lt;/span&gt;))) {
  c.setAutoCommit(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13491788" author="jdyer" created="Tue, 6 Nov 2012 20:27:23 +0000"  >&lt;p&gt;For this issue I will add Derby alongside HSQLDB as a random option for testing SqlEntityProcessor, building on the new tests added with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3856&quot; title=&quot;DIH: Better tests for SqlEntityProcessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3856&quot;&gt;&lt;del&gt;SOLR-3856&lt;/del&gt;&lt;/a&gt;.  The bug described here fails with Derby but not HSQLDB, so it is good to have at least RDBMS to test with.&lt;/p&gt;</comment>
                            <comment id="13491791" author="jdyer" created="Tue, 6 Nov 2012 20:35:00 +0000"  >&lt;p&gt;This patch fixes the problem by issuing a &quot;commit&quot; before closing the connection, as suggested by Fenior.  &lt;/p&gt;

&lt;p&gt;I added Derby as a randomly-selected test db to have coverage for this bug.  As derby is only needed for testing, I configured Ivy to locate the derby jar in the same directory as the hsqldb jar, under the dih example.  &lt;/p&gt;

&lt;p&gt;I also added the 2 db jars to the Eclipse dot.classpath and to the Idea config files so that you can easily run these tests from either ide. (this is my first exposure to Idea but with all the good words I&apos;ve heard on this mailing list I thought this a good time to try it out...)&lt;/p&gt;

&lt;p&gt;I plan on committing this patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="13495429" author="jdyer" created="Mon, 12 Nov 2012 17:16:49 +0000"  >&lt;p&gt;new patch to commit.&lt;/p&gt;</comment>
                            <comment id="13495445" author="jdyer" created="Mon, 12 Nov 2012 17:45:09 +0000"  >&lt;p&gt;committed...&lt;br/&gt;
Trunk: r1408364/r1408368 (CHANGES.txt)&lt;br/&gt;
4x: r1408370&lt;/p&gt;

&lt;p&gt;Thanks, Fenlor.  Sorry it took 2+ years for such an easy change.&lt;/p&gt;</comment>
                            <comment id="13504144" author="commit-tag-bot" created="Mon, 26 Nov 2012 21:46:33 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; James Dyer&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1412266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1412266&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;: workaround for Locales not supported by Derby&lt;/p&gt;
</comment>
                            <comment id="13504153" author="commit-tag-bot" created="Mon, 26 Nov 2012 21:46:38 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; James Dyer&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1412262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1412262&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;: workaround for Locales not supported by Derby&lt;/p&gt;
</comment>
                            <comment id="13610510" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:14:11 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; James Dyer&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1412266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1412266&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;: workaround for Locales not supported by Derby&lt;/p&gt;</comment>
                            <comment id="13610553" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:17:16 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Steven Rowe&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408688&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;: Maven configuration: add derby test dependency to DIH (merge trunk r1408685)&lt;/p&gt;</comment>
                            <comment id="13610559" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:17:34 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; James Dyer&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408389&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;:  fix svn:eol-style for sha1 file&lt;/p&gt;</comment>
                            <comment id="13610560" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:17:37 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; James Dyer&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408380&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;:  suppress creation of derby.log during test&lt;/p&gt;</comment>
                            <comment id="13610561" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:17:42 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; James Dyer&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1408370&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2045&quot; title=&quot;DIH doesn&amp;#39;t release jdbc connections in conjunction with DB2 &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2045&quot;&gt;&lt;del&gt;SOLR-2045&lt;/del&gt;&lt;/a&gt;:  DIH doesn&apos;t release jdbc connections for some databases&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12608265">SOLR-3856</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12553138" name="SOLR-2045.patch" size="43322" author="jdyer" created="Mon, 12 Nov 2012 17:16:49 +0000"/>
                            <attachment id="12552334" name="SOLR-2045.patch" size="34082" author="jdyer" created="Tue, 6 Nov 2012 20:35:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5447</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03n4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19179</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>