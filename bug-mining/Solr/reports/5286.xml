<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17754] Race condition in overseer main loop leaves collection/shard/replica locked</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17754</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We hit a rare race condition in overseer main loop, but it led to a full stuck overseer. All operations submitted to the collection API were then never dequeued and never processed until a restart of the overseer.&lt;/p&gt;

&lt;p&gt;For the race condition to reproduce, we need at least 100 concurrent tasks running in the collection API. This bug is reproducible only when the overseer is under high load.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;b&gt;Note on overseer threading&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The overseer main loop in class &lt;tt&gt;OverseerTaskProcessor&lt;/tt&gt; processes tasks that were previously enqueued to the overseer distributed queue (stored in Zookeeper). This class has a producer/consumer pattern:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a single thread dequeues tasks from the distributed queue (named later the &lt;em&gt;main loop&lt;/em&gt; thread)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;before submitting the task, the &lt;em&gt;main loop&lt;/em&gt; thread tries to lock on the collection/shard/replica (depending on the task type). If the lock was already taken because another task is already running on same resource, the task is not submitted and will be reconsidered during a later iteration.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;then a pool with up to 100 threads executes the tasks (named later the &lt;em&gt;runner&lt;/em&gt; threads).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at the end of the task, the &lt;em&gt;runner&lt;/em&gt; thread unlocks the collection/shard/replica.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;br/&gt;
Since the pool uses a &lt;tt&gt;SynchronousQueue&lt;/tt&gt;, it is not allowed to submit more than 100 concurrent tasks to the pool, otherwise the task is rejected by the pool and an exception is raised (see the exception below). To avoid this exception, the &lt;em&gt;main loop&lt;/em&gt; threads makes sure it does not submit more than 100 concurrent tasks by maintaining the IDs of the current running tasks in an in-memory collection. Each time a task is being submitted, the task ID is added into collection &lt;tt&gt;runningTasks&lt;/tt&gt;. Then, once the &lt;em&gt;runner&lt;/em&gt; thread completed the task (same in case of a failure), it removes the task ID from this collection. Before submitting a task to the &lt;em&gt;runner&lt;/em&gt; pool, the &lt;em&gt;main loop&lt;/em&gt; thread checks the size of collection runningTasks. In case there are already 100 items in the collection, the task is not submitted but instead added into another collection (&lt;tt&gt;blockedTasks&lt;/tt&gt;) so it will be submitted to the pool in a later iteration, once the size of runningTask will be below 100 (full mechanism not detailed here).&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Root cause race condition&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The bug is that the list of IDs in collection &lt;tt&gt;runningTasks&lt;/tt&gt; is not fully aligned with list of &lt;em&gt;runner&lt;/em&gt; threads currently executing a task. The instant right after the &lt;em&gt;runner&lt;/em&gt; thread removed the ID, the thread is still running and hasn&apos;t returned back to the pool. But since the task ID is not in the collection anymore, the &lt;em&gt;main loop&lt;/em&gt; thread thinks we have a room available to submit a new task to the pool. There is a time window where the &lt;em&gt;main loop&lt;/em&gt; thread may submit a 101th task the pool. Bellow exception is raised:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.concurrent.RejectedExecutionException: Task org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor$$Lambda/0x00000070013f2a30@53c6a1bb rejected from org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor@1f9c1653[Running, pool size = 100, active threads = 100, queued tasks = 0, completed tasks = 100]
	at java.base/java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2081) ~[?:?]
	at java.base/java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:841) ~[?:?]
	at java.base/java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1376) ~[?:?]
	at org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.execute(ExecutorUtil.java:361) ~[main/:?]
	at org.apache.solr.cloud.OverseerTaskProcessor.run(OverseerTaskProcessor.java:376) ~[main/:?]
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1583) [?:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Impact&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Once we hit the above exception, the lock on the collection/shard/replica is not released (it was acquired before submitting a task to the &lt;em&gt;runner&lt;/em&gt; thread pool). This means that all the future tasks that require to lock on the same collection/shard/replica won&apos;t be processed and will remaining the Zookeeper queue forever, until the overseer is restarted.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
Another impact is the overseer does not read more than 1000 tasks from the queue. Consequently, if more than 1000 are blocked by the unreleased lock, later tasks will not be read (and not processed) even if they don&apos;t require the same lock. After 1000 tasks waiting for the lock, the overseer is fully blocked. It may take a long time between the root race condition and reaching a fully blocked overseer (days/weeks depending on the number of submitted API calls).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13617285">SOLR-17754</key>
            <summary>Race condition in overseer main loop leaves collection/shard/replica locked</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="psalagnac">Pierre Salagnac</assignee>
                                    <reporter username="psalagnac">Pierre Salagnac</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 6 May 2025 15:12:41 +0000</created>
                <updated>Thu, 24 Jul 2025 22:50:52 +0000</updated>
                            <resolved>Fri, 6 Jun 2025 17:25:34 +0000</resolved>
                                    <version>9.8</version>
                                    <fixVersion>9.9</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17950162" author="dsmiley" created="Thu, 8 May 2025 01:39:42 +0000"  >&lt;p&gt;Amazing investigation / root-cause-analysis Pierre!&lt;/p&gt;</comment>
                            <comment id="17951216" author="JIRAUSER308021" created="Tue, 13 May 2025 15:38:58 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m opening a pull request to fix this bug. The change also fixes a minor logging bug in the task queue, so adding details here&lt;/p&gt;

&lt;p&gt;For each (Collection API) overseer task, we try to set data in the result node multiple times. That why we have the log message &lt;tt&gt;&quot;Response ZK path: &lt;em&gt;&amp;lt;node&amp;gt;&lt;/em&gt; doesn&apos;t exist. Requestor may have disconnected from ZooKeeper&quot;&lt;/tt&gt; so often.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For each synchronous task (&lt;tt&gt;asyncId == null&lt;/tt&gt;), we set the result twice (we call &lt;tt&gt;workQueue.remove()&lt;/tt&gt; twice), once in the main loop thread and once in the task runner thread. Depending on thread scheduling, either the main loop thread of the runner thread is the first. There is a chance the node was already removed by the client thread (jetty) at the second attempt of writing the result.&lt;/li&gt;
	&lt;li&gt;For each asynchronous task (&lt;tt&gt;asyncId != null&lt;/tt&gt;), we don&apos;t create the result node at all when enqueuing the task in the queue. The result is supposed to be written in &lt;tt&gt;/overseer/collection-map-completed&lt;/tt&gt; ZK distributed map instead (or similar for a failure). But current code still tries to write to the unixesting response node. Consequently, the message is logged twice for each asynchronous task.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This fix removes the erroneous messages. Wow only the runner sub-thread removes the item of task completion, and we make sure we try to store the result in the response node only we synchronous tasks.&lt;/p&gt;</comment>
                            <comment id="17951217" author="dsmiley" created="Tue, 13 May 2025 15:41:55 +0000"  >&lt;p&gt;You created a &quot;Task&quot;, not a &quot;Bug&quot;.  Why?&lt;/p&gt;</comment>
                            <comment id="17951219" author="JIRAUSER308021" created="Tue, 13 May 2025 15:42:55 +0000"  >&lt;p&gt;Oh my bad !&lt;br/&gt;
Fixing this.&lt;/p&gt;</comment>
                            <comment id="17956626" author="jira-bot" created="Fri, 6 Jun 2025 15:43:26 +0000"  >&lt;p&gt;Commit e364f3971100e323b14df8770473179475a2eb3e in solr&apos;s branch refs/heads/main from Pierre Salagnac&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=e364f397110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=e364f397110&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17754&quot; title=&quot;Race condition in overseer main loop leaves collection/shard/replica locked&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17754&quot;&gt;&lt;del&gt;SOLR-17754&lt;/del&gt;&lt;/a&gt; Fix race condition in overseer main loop. (#3350)&lt;/p&gt;

&lt;p&gt;This fixes the overseer main loop so we never submit more than 100 concurrent tasks to the thread pool. Instead of manually tracking when a task is complete, we check the status using a standard Future.&lt;/p&gt;</comment>
                            <comment id="17956644" author="jira-bot" created="Fri, 6 Jun 2025 17:24:55 +0000"  >&lt;p&gt;Commit 82864fa65a68b283eee78ab9b1e6ed40e98e3dfb in solr&apos;s branch refs/heads/branch_9x from Pierre Salagnac&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=82864fa65a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=82864fa65a6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17754&quot; title=&quot;Race condition in overseer main loop leaves collection/shard/replica locked&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17754&quot;&gt;&lt;del&gt;SOLR-17754&lt;/del&gt;&lt;/a&gt; Fix race condition in overseer main loop. (#3350)&lt;/p&gt;

&lt;p&gt;This fixes the overseer main loop so we never submit more than 100 concurrent tasks to the thread pool. Instead of manually tracking when a task is complete, we check the status using a standard Future.&lt;/p&gt;</comment>
                            <comment id="18009726" author="houston" created="Thu, 24 Jul 2025 22:50:52 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vpk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>