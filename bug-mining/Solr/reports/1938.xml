<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:51:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6056] Zookeeper crash JVM stack OOM because of recover strategy </title>
                <link>https://issues.apache.org/jira/browse/SOLR-6056</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Some errors&quot;org.apache.solr.common.SolrException: Error opening new searcher. exceeded limit of maxWarmingSearchers=2, try again later&quot;, that occur distributedupdateprocessor trig the core admin recover process.&lt;br/&gt;
That means every update request will send the core admin recover request.&lt;br/&gt;
(see the code DistributedUpdateProcessor.java doFinish())&lt;/p&gt;

&lt;p&gt;The terrible thing is CoreAdminHandler will start a new thread to publish the recover status and start recovery. Threads increase very quickly, and stack OOM , Overseer can&apos;t handle a lot of status update , zookeeper node for  /overseer/queue/qn-0000125553 increase more than 40 thousand in two minutes.&lt;/p&gt;

&lt;p&gt;At the last zookeeper crash. &lt;br/&gt;
The worse thing is queue has too much nodes in the zookeeper, the cluster can&apos;t publish the right status because only one overseer work, I have to start three threads to clear the queue nodes. The cluster doesn&apos;t work normal near 30 minutes...&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Two linux servers, 65G memory, 16 core cpu&lt;br/&gt;
20 collections, every collection has one shard two replica &lt;br/&gt;
one zookeeper&lt;/p&gt;</environment>
        <key id="12713438">SOLR-6056</key>
            <summary>Zookeeper crash JVM stack OOM because of recover strategy </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="raintung.li">Raintung Li</reporter>
                        <labels>
                            <label>cluster</label>
                            <label>crash</label>
                            <label>recover</label>
                    </labels>
                <created>Sat, 10 May 2014 06:07:47 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:28 +0000</updated>
                            <resolved>Fri, 27 Jan 2017 19:58:39 +0000</resolved>
                                    <version>4.6</version>
                                    <fixVersion>5.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13994821" author="raintung.li" created="Mon, 12 May 2014 05:34:30 +0000"  >&lt;p&gt;1. Move report the status from the  coreadminhandle to the doRecovery method, only one thread will report this status.&lt;br/&gt;
2.  While find the thread is working for recovery, the other recovery thread will quit except set the parameter to enforce recovery.&lt;/p&gt;</comment>
                            <comment id="13995618" author="shalinmangar" created="Mon, 12 May 2014 20:58:05 +0000"  >&lt;p&gt;Good find! Both are terrible bugs.&lt;/p&gt;</comment>
                            <comment id="13996036" author="markrmiller@gmail.com" created="Tue, 13 May 2014 04:24:52 +0000"  >&lt;p&gt;+1, good stuff. &lt;/p&gt;

&lt;p&gt;Regarding 2, we have to think carefully before making this change. &lt;/p&gt;

&lt;p&gt;What about the sequence where a replica is recovering, and an update to be buffered randomly fails - what ensures the replica fully recovers?&lt;/p&gt;</comment>
                            <comment id="13996039" author="markrmiller@gmail.com" created="Tue, 13 May 2014 04:27:45 +0000"  >&lt;p&gt;Just  reviewing by iphone, but I think the move in 1 is likely unnecessary as it some what defeats the purpose of the quick publish comment. It&apos;s really just a a best effort thing, and we can likely fall back to the natural publish that running recovery does. &lt;/p&gt;</comment>
                            <comment id="14027970" author="markrmiller@gmail.com" created="Wed, 11 Jun 2014 16:22:09 +0000"  >&lt;p&gt;I think we have to think through 2 more, but 1 is really nasty and we should just fix it by taking out the quick publish attempt I think.&lt;/p&gt;</comment>
                            <comment id="14028033" author="shalinmangar" created="Wed, 11 Jun 2014 17:12:20 +0000"  >&lt;p&gt;I agree, we should remove the publish in CoreAdminHandler.&lt;/p&gt;</comment>
                            <comment id="14029029" author="jira-bot" created="Thu, 12 Jun 2014 11:18:34 +0000"  >&lt;p&gt;Commit 1602123 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1602123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1602123&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6056&quot; title=&quot;Zookeeper crash JVM stack OOM because of recover strategy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6056&quot;&gt;&lt;del&gt;SOLR-6056&lt;/del&gt;&lt;/a&gt;: Don&apos;t publish recovery state until recovery runs to avoid overwhelming the overseer state queue&lt;/p&gt;</comment>
                            <comment id="14029055" author="shalinmangar" created="Thu, 12 Jun 2014 11:31:44 +0000"  >&lt;p&gt;I don&apos;t understand #2 because cancelRecovery will make sure that an old recovery thread joins and so at any given point there should be only one thread doing the recovery. If that is true, the while (recoveryRunning) block is also redundant. Am I missing something?&lt;/p&gt;

&lt;p&gt;Overall this doesn&apos;t seem like the best strategy because when each recovery request from DUPF.finish() will create a recovery thread and the next such request will cancel the last recovery and start a new recovery thread and so on. Also, if a long running recovery is in progress and there are additional request recovery threads coming in then the core will rapidly block up threads increasing the chances of deadlock.&lt;/p&gt;</comment>
                            <comment id="14029516" author="markrmiller@gmail.com" created="Thu, 12 Jun 2014 17:59:59 +0000"  >&lt;p&gt;Yes, only one thread should be running recovery at any time.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Overall this doesn&apos;t seem like the best strategy &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is a better strategy - this one was just the simplest that also provides for the promises we need for proper recovery. It&apos;s &apos;evolved&apos; a bit over time though, and it&apos;s certainly possible there is code in some spots that is no longer necessary. It&apos;s been a long time since I have been through it.&lt;/p&gt;

&lt;p&gt;Certainly it&apos;s an improvement to have no blocked threads, but any such improvement still has to work properly with recovery. I assumed Raintung had supplied at an attempt at such an improvement as a fix for #2. I have not had a chance to look closely at it. The reason that I punted on such a solution initially was that this was the easy way to be compliant with recovery.&lt;/p&gt;

&lt;p&gt;There are many parts of SolrCloud like this - few initial builders means a lot of quick impls and leaves a lot of low hanging fruit improvements.&lt;/p&gt;</comment>
                            <comment id="14031601" author="andyetitmoves" created="Sat, 14 Jun 2014 15:23:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5593&quot; title=&quot;shard leader loss due to ZK session expiry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5593&quot;&gt;&lt;del&gt;SOLR-5593&lt;/del&gt;&lt;/a&gt; was one more place where we had debated taking out the quick publish, but decided against it as you increase the chance of an unhealthy replica becoming the leader and losing updates. That argument probably still holds, if the leader is sending tons of recovery requests, couldn&apos;t either the leader or the replica not send/accept one while a recovery is in progress?&lt;/p&gt;</comment>
                            <comment id="14035947" author="jira-bot" created="Wed, 18 Jun 2014 17:02:02 +0000"  >&lt;p&gt;Commit 1603527 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1603527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1603527&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Remove &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6056&quot; title=&quot;Zookeeper crash JVM stack OOM because of recover strategy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6056&quot;&gt;&lt;del&gt;SOLR-6056&lt;/del&gt;&lt;/a&gt; from 4.9 section&lt;/p&gt;</comment>
                            <comment id="15674255" author="ichattopadhyaya" created="Thu, 17 Nov 2016 17:08:38 +0000"  >&lt;p&gt;It seems #1 was committed here and #2 was dealt with at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8371&quot; title=&quot;Try and prevent too many recovery requests from stacking up and clean up some faulty logic.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8371&quot;&gt;&lt;del&gt;SOLR-8371&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, can we link &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8371&quot; title=&quot;Try and prevent too many recovery requests from stacking up and clean up some faulty logic.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8371&quot;&gt;&lt;del&gt;SOLR-8371&lt;/del&gt;&lt;/a&gt; as a related issue, and close this?&lt;/p&gt;</comment>
                            <comment id="15843399" author="ctargett" created="Fri, 27 Jan 2017 19:58:39 +0000"  >&lt;p&gt;Per Ishan&apos;s last comment, it seems part of this issue was committed, and the other part was fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8371&quot; title=&quot;Try and prevent too many recovery requests from stacking up and clean up some faulty logic.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8371&quot;&gt;&lt;del&gt;SOLR-8371&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12919021">SOLR-8371</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12644376" name="patch-6056.txt" size="3450" author="raintung.li" created="Mon, 12 May 2014 05:31:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391754</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vgwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391960</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>