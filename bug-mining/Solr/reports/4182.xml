<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:37:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12860] MetricsHistoryHandler does not work with BasicAuth</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12860</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I setup a 2 node cluster ( bin/solr start -e cloud -noprompt ) and then uploaded the default security.json from &lt;a href=&quot;http://lucene.apache.org/solr/guide/7_5/basic-authentication-plugin.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://lucene.apache.org/solr/guide/7_5/basic-authentication-plugin.html&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m seeing errors like these in the logs which would indicate that the metrics history handler would not work with basic auth enabled?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-10-12 22:06:43.496 WARN&#160; (MetricsHistoryHandler-12-thread-1) [&#160;&#160; ] o.a.s.c.s.i.SolrClientNodeStateProvider could not get tags from node 192.168.0.8:7574_solr
org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http:&lt;span class=&quot;code-comment&quot;&gt;//192.168.0.8:7574/solr: Expected mime type application/octet-stream but got text/html. &amp;lt;html&amp;gt;
&lt;/span&gt;&amp;lt;head&amp;gt;
&amp;lt;meta http-equiv=&lt;span class=&quot;code-quote&quot;&gt;&quot;Content-Type&quot;&lt;/span&gt; content=&lt;span class=&quot;code-quote&quot;&gt;&quot;text/html;charset=utf-8&quot;&lt;/span&gt;/&amp;gt;
&amp;lt;title&amp;gt;Error 401 require authentication&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;lt;h2&amp;gt;HTTP ERROR 401&amp;lt;/h2&amp;gt;
&amp;lt;p&amp;gt;Problem accessing /solr/admin/metrics. Reason:
&amp;lt;pre&amp;gt;&#160;&#160;&#160; require authentication&amp;lt;/pre&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;

&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:607) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:255) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:244) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.SolrClient.request(SolrClient.java:1219) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.SolrClientNodeStateProvider$ClientSnitchCtx.invoke(SolrClientNodeStateProvider.java:342) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.SolrClientNodeStateProvider.fetchReplicaMetrics(SolrClientNodeStateProvider.java:195) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.SolrClientNodeStateProvider$AutoScalingSnitch.getRemoteInfo(SolrClientNodeStateProvider.java:241) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.common.cloud.rule.ImplicitSnitch.getTags(ImplicitSnitch.java:76) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.SolrClientNodeStateProvider.fetchTagValues(SolrClientNodeStateProvider.java:139) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.client.solrj.impl.SolrClientNodeStateProvider.getNodeValues(SolrClientNodeStateProvider.java:128) ~[solr-solrj-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:58]
&#160;&#160; &#160;at org.apache.solr.handler.admin.MetricsHistoryHandler.collectGlobalMetrics(MetricsHistoryHandler.java:498) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.handler.admin.MetricsHistoryHandler.collectMetrics(MetricsHistoryHandler.java:371) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at org.apache.solr.handler.admin.MetricsHistoryHandler.lambda$&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;$0(MetricsHistoryHandler.java:231) ~[solr-core-7.5.0.jar:7.5.0 b5bf70b7e32d7ddd9742cc821d471c5fabd4e3df - jimczi - 2018-09-18 13:07:55]
&#160;&#160; &#160;at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_112]
&#160;&#160; &#160;at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_112]
&#160;&#160; &#160;at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [?:1.8.0_112]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13191321">SOLR-12860</key>
            <summary>MetricsHistoryHandler does not work with BasicAuth</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janhoy">Jan H&#248;ydahl</assignee>
                                    <reporter username="varun">Varun Thacker</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Oct 2018 22:26:40 +0000</created>
                <updated>Sat, 8 Jun 2019 14:59:02 +0000</updated>
                            <resolved>Fri, 12 Apr 2019 09:30:29 +0000</resolved>
                                    <version>7.4</version>
                                    <fixVersion>7.7.2</fixVersion>
                    <fixVersion>8.1</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                    <component>Authentication</component>
                    <component>metrics</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16648879" author="epugh" created="Sat, 13 Oct 2018 10:46:43 +0000"  >&lt;p&gt;I&apos;ve been seeing the same thing!  &lt;/p&gt;</comment>
                            <comment id="16649490" author="janhoy" created="Sun, 14 Oct 2018 18:30:52 +0000"  >&lt;p&gt;This may be the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12526&quot; title=&quot;Metrics History doesn&amp;#39;t work with AuthenticationPlugin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12526&quot;&gt;&lt;del&gt;SOLR-12526&lt;/del&gt;&lt;/a&gt; although that one was closed as not a bug since the auth plugin having issues was a custom one and we could not reproduce.&lt;/p&gt;</comment>
                            <comment id="16718935" author="janhoy" created="Wed, 12 Dec 2018 12:43:42 +0000"  >&lt;p&gt;Anyone had another look at this?&lt;/p&gt;</comment>
                            <comment id="16769547" author="lskv" created="Fri, 15 Feb 2019 17:53:15 +0000"  >&lt;p&gt;I see the same issue on Solr 7.6.0.with the metrics history request failing when using BasicAuthPlugin (blockUnknown=true).&lt;/p&gt;</comment>
                            <comment id="16769758" author="dartfish" created="Fri, 15 Feb 2019 21:27:50 +0000"  >&lt;p&gt;There&apos;s possibly some crossover with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12584&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-12584&lt;/a&gt;&#160;which has a similar problem&#160;when using the BasicAuthPlugin.&lt;/p&gt;</comment>
                            <comment id="16774367" author="lskv" created="Thu, 21 Feb 2019 18:09:07 +0000"  >&lt;p&gt;This is a&#160;duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12526&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-12526&lt;/a&gt;&#160;but it has been marked as &quot;resolved&quot;. The metrics history doesn&apos;t work occurs with BasicAuthPlugin and also our custom auth plugin which delegates internode requests to the PKIAuthplugin by not implementing HttpClientBuilderPlugin&#160;.&lt;/p&gt;

&lt;p&gt;As a workaround I tried the suggestion by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;&#160; in that thread to&#160;delegate internal request to PKI Auth plugin explicitly by implementing&#160;HttpClientBuilderPlugin and calling &quot;coreContainer.getPkiAuthenticationPlugin().setHeader(request);&quot; While this seems to work , I see&#160; this is an issue with the Metrics history.&lt;/p&gt;</comment>
                            <comment id="16774751" author="bruce gao" created="Fri, 22 Feb 2019 04:18:17 +0000"  >&lt;p&gt;In our env, it reports the same in 7.6, when base auth is actived (not customized plug-in). for inter-node interaction, seems PKI should work, why not for this case? any graceful way to solve it? thanks.&lt;/p&gt;</comment>
                            <comment id="16775107" author="janhoy" created="Fri, 22 Feb 2019 12:57:07 +0000"  >&lt;p&gt;PKI should kick in automatically for inter-node, but I have a theory that the MetricsHistoryHandler uses a wrong ThreadPool which is not instrumented for this? Don&apos;t have time to debug now, patches welcome!&lt;/p&gt;</comment>
                            <comment id="16795101" author="guebeli" created="Mon, 18 Mar 2019 15:13:03 +0000"  >&lt;p&gt;Same situation here with Solr 7.7.1 and&#160;BasicAuthPlugin.&lt;/p&gt;

&lt;p&gt;/security.json&lt;br/&gt;
  &quot;authentication&quot;:{&lt;br/&gt;
    &quot;blockUnknown&quot;:true,&lt;br/&gt;
    &quot;class&quot;:&quot;solr.BasicAuthPlugin&quot;,&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;Since we do not use MetricsHistory we use the following workaround in order to keep the log-files clean.&lt;/p&gt;

&lt;p&gt;/clusterprops.json&lt;br/&gt;
{&lt;br/&gt;
  &quot;urlScheme&quot;:&quot;https&quot;,  &lt;font color=&quot;#FF0000&quot;&gt;&quot;metrics&quot;:{&quot;history&quot;:{&quot;enable&quot;:false}}}&lt;/font&gt;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16796449" author="yael.lorenzo" created="Tue, 19 Mar 2019 19:23:16 +0000"  >&lt;p&gt;The same is happening here with BasiAuthPlugin Sor 7.7.0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/security.json
&lt;span class=&quot;code-quote&quot;&gt;&quot;authentication&quot;&lt;/span&gt;:{
   &lt;span class=&quot;code-quote&quot;&gt;&quot;blockUnknown&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
   &lt;span class=&quot;code-quote&quot;&gt;&quot;class&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.BasicAuthPlugin&quot;&lt;/span&gt;, ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16796463" author="yael.lorenzo" created="Tue, 19 Mar 2019 19:44:09 +0000"  >&lt;p&gt;Just for info while I investigate.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MetricsHistoryHandler.collectGlobalMetrics()...
...
NodeStateProvider nodeStateProvider = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.cloudManager.getNodeStateProvider();
...
Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;ReplicaInfo&amp;gt;&amp;gt;&amp;gt; infos = nodeStateProvider.getReplicaInfo(node, collTags);
...
  Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; tagValues = fetchReplicaMetrics(node, metricsKeyVsTagReplica);
  ... 
  fetchReplicaMetrics(node, ctx, collect);
  ...
     rsp = ctx.invoke(solrNode, CommonParams.METRICS_PATH, params);
     ...

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SimpleSolrResponse invoke(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; solrNode, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path, SolrParams params)
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, SolrServerException {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; url = zkClientClusterStateProvider.getZkStateReader().getBaseUrlForNodeName(solrNode);

    GenericSolrRequest request = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericSolrRequest(SolrRequest.METHOD.POST, path, params);
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (HttpSolrClient client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpSolrClient.Builder()
        .withHttpClient(solrClient.getHttpClient())
        .withBaseSolrUrl(url)
        .withResponseParser(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BinaryResponseParser())
        .build()) {
      NamedList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; rsp = client.request(request);
      request.response.nl = rsp;
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; request.response;
    }
  }

}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The HTTPClient instance this handler uses is apparently pre-configured. HTTPClient comes from&#160;&lt;tt&gt;coreContainer.getUpdateShardHandler().getDefaultHTTPClient().&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16798371" author="yael.lorenzo" created="Thu, 21 Mar 2019 19:48:43 +0000"  >&lt;p&gt;BasicAuthPlugin is not implementing HttpClientBuilderPlugin as the others, therefore when reaching this code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
setupHttpClientForAuthPlugin(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; authcPlugin)
  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in CoreContainer, the HttpClient is not refreshed and the Object that contains the client is&#160;&lt;/p&gt;

&lt;p&gt;updateShardHandler that gets updated with the PKI and this does not contain the credentials&#160; that the authcPlugin does. So, I am working on a patch.&lt;/p&gt;</comment>
                            <comment id="16798405" author="janhoy" created="Thu, 21 Mar 2019 20:26:07 +0000"  >&lt;p&gt;A better solution is to force PKI Auth for the Metrics history requests.&lt;/p&gt;</comment>
                            <comment id="16798439" author="yael.lorenzo" created="Thu, 21 Mar 2019 21:16:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;, I don&apos;t&#160;understand what you mean. What I see is PKI and Basic Auth as different plugins. Metrics History fails now on Basic auth.&#160;&lt;/p&gt;

&lt;p&gt;I am pretty new to this code, so perhaps I am very mistaken. Please advise me in other case.&lt;/p&gt;

&lt;p&gt;From what I saw in the method &lt;b&gt;setupHttpClientForAuthPlugin&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I have to&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;build the correct&#160;HttpClientBuilderPlugin&lt;/li&gt;
	&lt;li&gt;set this new object to&#160;updateShardHandler&lt;/li&gt;
	&lt;li&gt;set the new object to HttpClientUtil.setHttpClientRequestContextBuilder&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Otherwise future usages will not work either as the httpclient would be outdated.&lt;/p&gt;</comment>
                            <comment id="16798466" author="janhoy" created="Thu, 21 Mar 2019 21:43:02 +0000"  >&lt;p&gt;PKI is always active and will be used for inter node communications if the chosen auth is not explicitly configured to handle it. Question is why does not PKI kick in for the metrics history calls?&lt;/p&gt;</comment>
                            <comment id="16799085" author="yael.lorenzo" created="Fri, 22 Mar 2019 15:08:54 +0000"  >&lt;p&gt;I am checking&#160;further... as I am a little lost&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CoreContainer
...
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void setupHttpClientForAuthPlugin(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; authcPlugin) {
 ...
  &lt;span class=&quot;code-comment&quot;&gt;// Always register PKI auth interceptor, which will then delegate the decision of who should secure
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// each request to the configured authentication plugin.
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pkiAuthenticationPlugin != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !pkiAuthenticationPlugin.isInterceptorRegistered()) {
  pkiAuthenticationPlugin.getHttpClientBuilder(HttpClientUtil.getHttpClientBuilder());
  shardHandlerFactory.setSecurityBuilder(pkiAuthenticationPlugin);
  updateShardHandler.setSecurityBuilder(pkiAuthenticationPlugin);
  &lt;span class=&quot;code-comment&quot;&gt;// to force PKI Auth &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the Metrics history requests.
&lt;/span&gt;}
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PKIAuthenticationPlugin
...
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setup(Http2SolrClient client) {
  &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HttpListenerFactory.RequestResponseListener listener = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpListenerFactory.RequestResponseListener() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onQueued(Request request) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cores.getAuthenticationPlugin() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!cores.getAuthenticationPlugin().interceptInternodeRequest(request)) {
        log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} secures &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; internode request&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass().getSimpleName());
        generateToken().ifPresent(s -&amp;gt; request.header(HEADER, myNodeName + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + s));
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} secures &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; internode request&quot;&lt;/span&gt;, cores.getAuthenticationPlugin().getClass().getSimpleName());
      }
    }
  };
  client.addListenerFactory(() -&amp;gt; listener);
}
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BasicAuthPlugin
...
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; interceptInternodeRequest(Request request) {
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am a bit lost at the moment because &lt;b&gt;PKIAuthenticationPlugin&lt;/b&gt;&#160;uses&#160;&lt;b&gt;Http2SolrClient&lt;/b&gt;&#160;and the&#160;**&#160;class that gets the metrics is&lt;/p&gt;

&lt;p&gt;&lt;b&gt;SolrClientNodeStateProvider&lt;/b&gt; who has a&#160;&lt;b&gt;ClientSnitchCtx&lt;/b&gt;&#160;that uses a &lt;b&gt;CloudSolrClient.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Also the interceptor is set only for&#160;&lt;b&gt;onQueued ?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Should the&#160;flow work as Forwarded Credentials?&lt;/p&gt;

&lt;p&gt;&lt;b&gt;//////&#160; Comments&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;What I did to check the HttpClient scope and gave me positive results is&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Make BasicAuthPlugin implement&#160;HttpClientBuilderPlugin&lt;/li&gt;
	&lt;li&gt;Previous forced me to implement the following where I set the credentials (only for testing, this is not the solution)&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SolrHttpClientBuilder getHttpClientBuilder(SolrHttpClientBuilder builder) {
  builder.setDefaultCredentialsProvider(() -&amp;gt; {
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Whit this setup the &lt;b&gt;ClientSnitchCtx&lt;/b&gt; has the correct &lt;b&gt;HttpClient.&lt;/b&gt;&lt;/p&gt;


&lt;p&gt;Thanks for any input on this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16799359" author="yael.lorenzo" created="Fri, 22 Mar 2019 21:16:40 +0000"  >&lt;p&gt;I have reached in the &lt;b&gt;PKIAuthenticationPlugin&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;HttpHeaderClientInterceptor &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; HttpRequestInterceptor {

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; HttpHeaderClientInterceptor() {
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(HttpRequest httpRequest, HttpContext httpContext) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HttpException, IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cores.getAuthenticationPlugin() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!cores.getAuthenticationPlugin().interceptInternodeRequest(httpRequest, httpContext)) {
      log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} secures &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; internode request&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass().getSimpleName());
      setHeader(httpRequest);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} secures &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; internode request&quot;&lt;/span&gt;, cores.getAuthenticationPlugin().getClass().getSimpleName());
    }
  }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;this actually is going through the BasicAuthPlugin on every requests but&#160;forwardCredentials is false.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; interceptInternodeRequest(HttpRequest httpRequest, HttpContext httpContext) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (forwardCredentials) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (httpContext &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; HttpClientContext) {
      HttpClientContext httpClientContext = (HttpClientContext) httpContext;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (httpClientContext.getUserToken() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; BasicAuthUserPrincipal) {
        BasicAuthUserPrincipal principal = (BasicAuthUserPrincipal) httpClientContext.getUserToken();
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; userPassBase64 = Base64.encodeBase64String((principal.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt; + principal.getPassword()).getBytes(StandardCharsets.UTF_8));
        httpRequest.setHeader(HttpHeaders.AUTHORIZATION, &lt;span class=&quot;code-quote&quot;&gt;&quot;Basic &quot;&lt;/span&gt; + userPassBase64);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
      }
    }
  }
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Anyway,&#160; the issue is that the credentials are in the context, but the password is encrypted, so it is not valid for http requests with the header &quot;authorization: basic user:pwd&quot; as it expects the&#160;&lt;em&gt;original&lt;/em&gt; ( unencrypted ) password.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16802137" author="yael.lorenzo" created="Tue, 26 Mar 2019 20:26:49 +0000"  >&lt;p&gt;I found the issue. I am preparing the PR.&lt;/p&gt;</comment>
                            <comment id="16803281" author="yael.lorenzo" created="Wed, 27 Mar 2019 19:35:06 +0000"  >&lt;p&gt;The situation is that the fix breaks the following...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit4] - org.apache.solr.handler.TestReplicationHandlerDiskOverFlow.testDiskOverFlow
[junit4] - org.apache.solr.security.PKIAuthenticationIntegrationTest.testPkiAuth
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testDelegationTokenRenew
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testDelegationTokenVerify
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testDelegationTokenRenewFail
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testZNodePaths
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testDelegationTokenCancel
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testDelegationTokenSolrClient
[junit4] - org.apache.solr.security.hadoop.TestDelegationWithHadoopAuth.testDelegationTokenCancelFail
[junit4] - org.apache.solr.security.BasicAuthIntegrationTest.testBasicAuth
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16803867" author="yael.lorenzo" created="Thu, 28 Mar 2019 12:07:11 +0000"  >&lt;p&gt;Here is the PR with the changes and unit test. &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/624&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/624&lt;/a&gt;&lt;br/&gt;
I am checking the other UTs as I think I don&apos;t like the comment in the code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSolrThread()) {
  &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not running inside a Solr threadpool (as in testcases)
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// then no need to add any header
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional.empty();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16803948" author="janhoy" created="Thu, 28 Mar 2019 13:59:53 +0000"  >&lt;p&gt;Have you tried to get the MetricsHistoryHandler to use a Solr thread? I&apos;m sure there was as reason for this code path? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16804034" author="yael.lorenzo" created="Thu, 28 Mar 2019 15:35:10 +0000"  >&lt;p&gt;Thanks for the feedback, not yet. I will give it a shot.&lt;/p&gt;</comment>
                            <comment id="16804099" author="janhoy" created="Thu, 28 Mar 2019 16:37:47 +0000"  >&lt;p&gt;I attached&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12964056/12964056_SOLR-12860.patch&quot; title=&quot;SOLR-12860.patch attached to SOLR-12860&quot;&gt;SOLR-12860.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;as an attempt to make the scheduled executor behave like a &quot;Solr threadpool&quot;. Seems to work with manual testing here. Not sure if it is the best solution though. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16804255" author="noble.paul" created="Thu, 28 Mar 2019 19:55:37 +0000"  >&lt;p&gt;This is the correct fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; . &lt;br/&gt;
&lt;tt&gt;Executors.newScheduledThreadPool&lt;/tt&gt; should be a forbidden API. Only Solr Threads can propagate the proper credentials &lt;/p&gt;</comment>
                            <comment id="16804337" author="janhoy" created="Thu, 28 Mar 2019 21:59:09 +0000"  >&lt;p&gt;What is this whole MDC thing, do we need it for the scheduled tasks? And will it work ok to just set the flag on the thread when execute() starts, and not bother to clear it? Will that thread be re-used again somewhere else later where it would matter? Tried to keep it short.&lt;/p&gt;</comment>
                            <comment id="16804344" author="noble.paul" created="Thu, 28 Mar 2019 22:07:31 +0000"  >&lt;p&gt;MDC may not be required for the trans if it&apos;s not logging anything in that thread. But how can we be sure about it.? It&apos;s much better to just use the standard thread pool instead of rolling your own&#160;&lt;/p&gt;</comment>
                            <comment id="16804351" author="janhoy" created="Thu, 28 Mar 2019 22:14:19 +0000"  >&lt;p&gt;Ok. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yael.lorenzo&quot; class=&quot;user-hover&quot; rel=&quot;yael.lorenzo&quot;&gt;yael.lorenzo&lt;/a&gt; perhaps you want to give it a shot, to add the same MDC stuff to the patch as is done for the other pools, with proper unsetting the flag?&lt;/p&gt;</comment>
                            <comment id="16804988" author="yael.lorenzo" created="Fri, 29 Mar 2019 13:40:55 +0000"  >&lt;p&gt;I will try! I am checking your code right now.&lt;/p&gt;</comment>
                            <comment id="16807328" author="yael.lorenzo" created="Tue, 2 Apr 2019 00:47:45 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12964504/12964504_SOLR-12028_metics_handler_not_work_basic_auth.patch&quot; title=&quot;SOLR-12028_metics_handler_not_work_basic_auth.patch attached to SOLR-12860&quot;&gt;SOLR-12028_metics_handler_not_work_basic_auth.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;I have reused the other code in the MDC to make it the most similar for the new&#160;&lt;b&gt;ScheduledThreadPoolExecutorForSolr.&lt;/b&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;I suppose that what I left in&#160;&lt;b&gt;getAtomicReferences&lt;/b&gt;&#160;is not in a thread safe list to handle a direct reference to the list. Although the name of the variable for the list &lt;b&gt;providersCopy&lt;/b&gt; made me doubt abut it.&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;I had to update the CoreContainer class to set the PKIAuthPlugin for the tests.&lt;/sup&gt; &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;sup&gt;I mocked the plugin to return true in the&#160;method&#160;&lt;b&gt;isSolrThread()&lt;/b&gt;&#160;(otherwhise the test does not work :\ )&lt;/sup&gt;&lt;/li&gt;
	&lt;li&gt;&lt;sup&gt;I have to reload the security options of CoreContainer to make it aware of the Plugin change.&lt;/sup&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;sup&gt;I also launched the compiled server and didn&apos;t see in the logs the 401 status code on the MetricsHistoryHandler.&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;If you have any comments I welcome them &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Thanks in advanced.&lt;/sup&gt;&lt;/p&gt;</comment>
                            <comment id="16814456" author="yael.lorenzo" created="Wed, 10 Apr 2019 13:41:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;&#160;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; did you have a chance to check the patch ?&lt;/p&gt;</comment>
                            <comment id="16815240" author="janhoy" created="Thu, 11 Apr 2019 09:18:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yael.lorenzo&quot; class=&quot;user-hover&quot; rel=&quot;yael.lorenzo&quot;&gt;yael.lorenzo&lt;/a&gt; I had a look today. Tried to continue with your patch, removing the hacks in CoreContainer and the Mock class, since we want to test The Real Thing&#8482; as much as possible.&lt;/p&gt;

&lt;p&gt;It turned out that the &lt;tt&gt;execute()&lt;/tt&gt; method of our &lt;tt&gt;ScheduledThreadPoolExecutorForSolr&lt;/tt&gt; was never called, so it did not actually work. The scheduled stuff puts the runnable on a queue and invokes the code in a different way, so I could not really figure out how to override it.&lt;/p&gt;

&lt;p&gt;Instead, I took a step back and made a simpler solution without the MDC stuff. I&apos;m now simply&#160;setting the &lt;tt&gt;ExecutorUtil.setServerThreadFlag(true)&lt;/tt&gt;&#160;at the beginning of the &lt;tt&gt;collectMetrics()&lt;/tt&gt; method and clearing it at the end. I also did a much simpler and more realistic integration test which protects the &lt;tt&gt;/admin/metrics&lt;/tt&gt; endpoint, sets a short &lt;tt&gt;collectPeriod&lt;/tt&gt; and waits a few seconds to validate that the background thread collection succeeded.&#160;The test fails without the fix, and succeeds with the fix. I have also beasted&#160;the test so it looks robust.&lt;/p&gt;

&lt;p&gt;See new&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/642&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #642&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I will commit this PR tomorrow, so speak up if you have comments.&lt;/p&gt;</comment>
                            <comment id="16815536" author="yael.lorenzo" created="Thu, 11 Apr 2019 16:01:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;, thanks for the quick reply. The&#160;&lt;tt&gt;execute()&lt;/tt&gt;&#160;method of our&#160;&lt;tt&gt;ScheduledThreadPoolExecutorForSolr&lt;/tt&gt;&#160;was never called &lt;b&gt;during the test (sadly true).&lt;/b&gt;&#160;That is why I came out with more intrusions in the corecontainer (i didn&apos;t like updating it btw).&lt;/p&gt;

&lt;p&gt;I see your solution is really very simple and the test is much more precise.&#160;&lt;/p&gt;

&lt;p&gt;You rock man! Thanks!&lt;/p&gt;</comment>
                            <comment id="16816078" author="jira-bot" created="Fri, 12 Apr 2019 08:21:22 +0000"  >&lt;p&gt;Commit f2c59db2736ecdded9601acf0549094769781a4a in lucene-solr&apos;s branch refs/heads/master from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now always uses PKI Auth (#642)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16816079" author="jira-bot" created="Fri, 12 Apr 2019 08:21:23 +0000"  >&lt;p&gt;Commit f2c59db2736ecdded9601acf0549094769781a4a in lucene-solr&apos;s branch refs/heads/master from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now always uses PKI Auth (#642)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16816080" author="jira-bot" created="Fri, 12 Apr 2019 08:23:18 +0000"  >&lt;p&gt;Commit de432003a7e440625c88571a2d118b01476ee9a6 in lucene-solr&apos;s branch refs/heads/branch_8x from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=de43200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=de43200&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/p&gt;

&lt;p&gt;(cherry picked from commit f2c59db2736ecdded9601acf0549094769781a4a)&lt;/p&gt;</comment>
                            <comment id="16816123" author="jira-bot" created="Fri, 12 Apr 2019 09:29:51 +0000"  >&lt;p&gt;Commit b643549000970b5a3e6dc5e9a3a3869608911542 in lucene-solr&apos;s branch refs/heads/branch_7_7 from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b643549&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b643549&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now always uses PKI Auth (#642)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cherry picked from commit f2c59db2736ecdded9601acf0549094769781a4a)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Conflicts:&lt;/li&gt;
	&lt;li&gt;solr/CHANGES.txt&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16816124" author="jira-bot" created="Fri, 12 Apr 2019 09:29:53 +0000"  >&lt;p&gt;Commit b643549000970b5a3e6dc5e9a3a3869608911542 in lucene-solr&apos;s branch refs/heads/branch_7_7 from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b643549&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b643549&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now always uses PKI Auth (#642)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cherry picked from commit f2c59db2736ecdded9601acf0549094769781a4a)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Conflicts:&lt;/li&gt;
	&lt;li&gt;solr/CHANGES.txt&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16816125" author="janhoy" created="Fri, 12 Apr 2019 09:30:29 +0000"  >&lt;p&gt;Thanks all &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16817115" author="jira-bot" created="Sat, 13 Apr 2019 22:50:51 +0000"  >&lt;p&gt;Commit f2c59db2736ecdded9601acf0549094769781a4a in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-8738&quot; title=&quot;Bump minimum Java version requirement to 11&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-8738&quot;&gt;&lt;del&gt;LUCENE-8738&lt;/del&gt;&lt;/a&gt; from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now always uses PKI Auth (#642)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16817116" author="jira-bot" created="Sat, 13 Apr 2019 22:50:52 +0000"  >&lt;p&gt;Commit f2c59db2736ecdded9601acf0549094769781a4a in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-8738&quot; title=&quot;Bump minimum Java version requirement to 11&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-8738&quot;&gt;&lt;del&gt;LUCENE-8738&lt;/del&gt;&lt;/a&gt; from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=f2c59db&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now always uses PKI Auth (#642)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12860&quot; title=&quot;MetricsHistoryHandler does not work with BasicAuth&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12860&quot;&gt;&lt;del&gt;SOLR-12860&lt;/del&gt;&lt;/a&gt;: MetricsHistoryHandler now uses PKI Auth for metrics collection in background thread&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16857084" author="janhoy" created="Wed, 5 Jun 2019 21:30:58 +0000"  >&lt;p&gt;Closing after the 7.7.2 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13168895">SOLR-12526</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13213863">SOLR-13218</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13218200">SOLR-13274</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13191313">SOLR-12859</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12964504" name="SOLR-12028_metics_handler_not_work_basic_auth.patch" size="18476" author="yael.lorenzo" created="Tue, 2 Apr 2019 00:39:51 +0000"/>
                            <attachment id="12964056" name="SOLR-12860.patch" size="3466" author="janhoy" created="Thu, 28 Mar 2019 16:35:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z5in:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>