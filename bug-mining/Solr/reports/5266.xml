<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17699] High Query Time in Solr When Using&#160;OR&#160;with&#160;frange&#160;in&#160;fq</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17699</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;HighQueryTimeinSolrWhenUsing%C2%A0%7B%7BOR%7D%7D%C2%A0with%C2%A0%7B%7Bfrange%7D%7D%C2%A0in%C2%A0%7B%7Bfq%7D%7D&quot;&gt;&lt;/a&gt;High Query Time in Solr When Using&#160;&lt;tt&gt;OR&lt;/tt&gt;&#160;with&#160;&lt;tt&gt;frange&lt;/tt&gt;&#160;in&#160;&lt;tt&gt;fq&lt;/tt&gt;&lt;/h3&gt;

&lt;p&gt;I am experiencing high query times in Solr when using an&#160;&lt;tt&gt;fq&lt;/tt&gt;&#160;filter that combines an&#160;&lt;tt&gt;OR&lt;/tt&gt;&#160;condition with&#160;&lt;tt&gt;frange&lt;/tt&gt;. The response time significantly increases compared to queries that do not use this combination.&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;QueryExample&quot;&gt;&lt;/a&gt;Query Example&lt;/h4&gt;

&lt;p&gt;&#160;&lt;br/&gt;
&lt;tt&gt;fq={!cache=false tag=prm}field:value OR {!frange l=1 u=1 v=$funcQuery&lt;/tt&gt;}&lt;br/&gt;
Here,&#160;&lt;tt&gt;$funcQuery&lt;/tt&gt;&#160;is a function query that retrieves documents dynamically based on dynamic parameters.&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;Observations&quot;&gt;&lt;/a&gt;Observations&lt;/h4&gt;
&lt;ul&gt;
	&lt;li&gt;When I use just&#160;{{{}
{!frange l=1 u=1 v=$funcQuery}
&lt;p&gt;{}}}, the query executes quickly&lt;span class=&quot;error&quot;&gt;&amp;#91;20ms&amp;#93;&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;When I use&#160;{{
{!cache=false tag=prm}
&lt;p&gt;field:value}}&#160;alone, the query is also fast.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;However, when combining both with&#160;&lt;tt&gt;OR&lt;/tt&gt;, the query time increases significantly &lt;span class=&quot;error&quot;&gt;&amp;#91;700ms&amp;#93;&lt;/span&gt;.&lt;/li&gt;
	&lt;li&gt;The dataset is relatively large, but other queries with similar complexity run efficiently.&lt;/li&gt;
&lt;/ul&gt;


&lt;h4&gt;&lt;a name=&quot;Questions&quot;&gt;&lt;/a&gt;Questions&lt;/h4&gt;
&lt;ol&gt;
	&lt;li&gt;Why does the&#160;&lt;tt&gt;OR&lt;/tt&gt;&#160;operation with&#160;&lt;tt&gt;frange&lt;/tt&gt;&#160;cause a significant increase in query time?&lt;/li&gt;
	&lt;li&gt;Are there any optimizations or alternative query structures that could improve performance?&lt;/li&gt;
	&lt;li&gt;Would it help to restructure how function queries and filters are applied in this case?&lt;/li&gt;
	&lt;li&gt;Is there any alternative for frange for this use case because in our use case, this cannot be done at index time because the function parameters change very&#160;frequently?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Any insights or suggestions would be greatly appreciated!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13611543">SOLR-17699</key>
            <summary>High Query Time in Solr When Using&#160;OR&#160;with&#160;frange&#160;in&#160;fq</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="puneet.sharma">Puneet Sharma</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 12 Mar 2025 06:42:03 +0000</created>
                <updated>Thu, 24 Jul 2025 22:55:06 +0000</updated>
                            <resolved>Wed, 19 Mar 2025 20:17:09 +0000</resolved>
                                    <version>9.0</version>
                    <version>9.6.1</version>
                                    <fixVersion>9.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17934514" author="dsmiley" created="Wed, 12 Mar 2025 13:02:15 +0000"  >&lt;p&gt;When you tried just the &lt;tt&gt;frange&lt;/tt&gt; alone in a fq and said it was fast, did you disable the cache on it as well with &lt;tt&gt;cache=false&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Frange is a little special in that it is a so-called &quot;PostFilter&quot; in Solr, which activates when it&apos;s by itself in a filter query. &#160;It&apos;s fairly efficient, only needing to process the documents that passed through the rest of the search (whatever that is). &#160;But if it&apos;s &lt;b&gt;not&lt;/b&gt; by itself, then ideally it wouldn&apos;t make much difference... but... okay I see a bug; I&apos;ll post a small fix soon&lt;/p&gt;</comment>
                            <comment id="17934523" author="dsmiley" created="Wed, 12 Mar 2025 13:28:17 +0000"  >&lt;p&gt;If I had merged &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14164&quot; title=&quot;Replace Solr&amp;#39;s FunctionRangeQuery with Lucene&amp;#39;s&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14164&quot;&gt;SOLR-14164&lt;/a&gt; way back then we wouldn&apos;t have seen this problem since we wouldn&apos;t have a code with this bug to maintain. &#160;But I wasn&apos;t sure if the change over there might have hurt the typical/standard case. (fq with frange only).&lt;/p&gt;

&lt;p&gt;The bug we have here could could also apply to some numeric range queries (numeric field with numeric range) where the lower side is less than 0 and upper side is not.&lt;/p&gt;</comment>
                            <comment id="17935796" author="dsmiley" created="Sun, 16 Mar 2025 04:55:03 +0000"  >&lt;p&gt;I pushed a test.&lt;/p&gt;

&lt;p&gt;My first attempt to test it used a different test query that was simpler, revealing a performance problem in Lucene, which I reported &lt;a href=&quot;https://github.com/apache/lucene/pull/14357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene/pull/14357&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17936091" author="dsmiley" created="Mon, 17 Mar 2025 05:31:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=puneet.sharma&quot; class=&quot;user-hover&quot; rel=&quot;puneet.sharma&quot;&gt;puneet.sharma&lt;/a&gt; In the scenario you describe, I suppose &lt;tt&gt;field:value&lt;/tt&gt; in your query is often true?  Thus we&apos;d hope it&apos;s true-ness should shield invoking the expensive frange for at least those docs.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;When I use just {&lt;tt&gt;!frange l=1 u=1 v=$funcQuery&lt;/tt&gt;}, the query executes quickly&lt;span class=&quot;error&quot;&gt;&amp;#91;20ms&amp;#93;&lt;/span&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Probably in part because the query is matching fewer docs; is not a disjunction with &lt;tt&gt;field:value&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17936345" author="jira-bot" created="Tue, 18 Mar 2025 01:26:39 +0000"  >&lt;p&gt;Commit ac74ced99e288f74a18655ec4cd2f205b976ca54 in solr&apos;s branch refs/heads/main from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=ac74ced99e2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=ac74ced99e2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17699&quot; title=&quot;High Query Time in Solr When Using&#160;OR&#160;with&#160;frange&#160;in&#160;fq&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17699&quot;&gt;&lt;del&gt;SOLR-17699&lt;/del&gt;&lt;/a&gt;: Fix &lt;/p&gt;
{!frange}
&lt;p&gt; perf regression in disjunction (#3259)&lt;/p&gt;

&lt;p&gt;Since 9.0 with &quot;frange&quot; function queries when in a disjunction (OR).  TwoPhaseIterator must be used; was iterating all docs instead.&lt;/p&gt;</comment>
                            <comment id="17936369" author="JIRAUSER304723" created="Tue, 18 Mar 2025 05:22:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;When you tried just the&#160;&lt;tt&gt;frange&lt;/tt&gt;&#160;alone in a fq and said it was fast, did you disable the cache on it as well with&#160;&lt;tt&gt;cache=false&lt;/tt&gt;?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; I used &lt;tt&gt;cache=false w&lt;/tt&gt;hen i tried just the &lt;tt&gt;frange&lt;/tt&gt; alone in a fq.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Puneet Sharma In the scenario you describe, I suppose field:value in your query is often true?&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I have 8.1 million doc in solr and for 77125 docs field:value is true.&lt;/p&gt;</comment>
                            <comment id="17936506" author="jira-bot" created="Tue, 18 Mar 2025 13:57:20 +0000"  >&lt;p&gt;Commit 01e1d917d9a032d705322a805d7bf3906aeef11a in solr&apos;s branch refs/heads/branch_9x from David Smiley&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=01e1d917d9a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=01e1d917d9a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17699&quot; title=&quot;High Query Time in Solr When Using&#160;OR&#160;with&#160;frange&#160;in&#160;fq&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17699&quot;&gt;&lt;del&gt;SOLR-17699&lt;/del&gt;&lt;/a&gt;: Fix &lt;/p&gt;
{!frange}
&lt;p&gt; perf regression in disjunction (#3259)&lt;/p&gt;

&lt;p&gt;Since 9.0 with &quot;frange&quot; function queries when in a disjunction (OR).  TwoPhaseIterator must be used; was iterating all docs instead.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ac74ced99e288f74a18655ec4cd2f205b976ca54)&lt;/p&gt;</comment>
                            <comment id="18009713" author="houston" created="Thu, 24 Jul 2025 22:50:51 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13158260">SOLR-12336</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13277427">SOLR-14164</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1uq5c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>