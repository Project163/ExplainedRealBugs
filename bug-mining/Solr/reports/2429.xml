<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:04:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7419] Initial value of thread local in SolrQueryTimeoutImpl overflows a long</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7419</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Same as the title.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; /**
   * The ThreadLocal variable to store the time beyond which, the processing should exit.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ThreadLocal&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; timeoutAt = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; initialValue() {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; nanoTime() + &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    }
  };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12822054">SOLR-7419</key>
            <summary>Initial value of thread local in SolrQueryTimeoutImpl overflows a long</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="sarowe">Steven Rowe</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Apr 2015 04:20:27 +0000</created>
                <updated>Mon, 9 May 2016 18:50:30 +0000</updated>
                            <resolved>Mon, 20 Apr 2015 14:31:21 +0000</resolved>
                                    <version>4.10.4</version>
                    <version>5.1</version>
                                    <fixVersion>5.2</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>search</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14502383" author="steve_rowe" created="Mon, 20 Apr 2015 05:46:08 +0000"  >&lt;p&gt;I don&apos;t think it&apos;s a problem - the &lt;tt&gt;timeoutAt&lt;/tt&gt; value is never directly compared - instead the result of subtracting &lt;tt&gt;nanoTime()&lt;/tt&gt; from it is compared to zero:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; get() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; timeoutAt.get();
  }
[...]
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; shouldExit() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; get() - nanoTime() &amp;lt; 0L;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This little java program tests some of the overflow cases, and passes for me with assertions enabled (Java 8):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LongOverflowTest {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; start = 1L;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; = start + &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; end = start + 1; 
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end &amp;gt; 0L;
    
    end = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end &amp;gt; 0L;

    ++end;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end == 0L;

   ++end;
   &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end &amp;lt; 0L;
    
    start = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; = start + &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    end = start + 1;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end &amp;gt; 0L;

    end = (start - 1) + &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end &amp;gt; 0L;

    ++end;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end == 0L;

    ++end;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; - end &amp;lt; 0L;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14502742" author="shalinmangar" created="Mon, 20 Apr 2015 12:56:50 +0000"  >&lt;p&gt;Thanks Steve. Yes, on overflow the JVM circles back to MIN_VALUE so even though it works fine, I don&apos;t see a reason for the initialValue to be assigned this way. &lt;/p&gt;</comment>
                            <comment id="14502744" author="yseeley@gmail.com" created="Mon, 20 Apr 2015 12:58:14 +0000"  >&lt;p&gt;Heh, yeah, this doesn&apos;t result in bad behavior since the original overflow is paired with an underflow.  &lt;br/&gt;
But if something like that is intentional it should certainly be commented.&lt;br/&gt;
In this case, we should just set the initial value to Long.MAX_VALUE&lt;/p&gt;</comment>
                            <comment id="14502760" author="steve_rowe" created="Mon, 20 Apr 2015 13:08:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yes, on overflow the JVM circles back to MIN_VALUE so even though it works fine, I don&apos;t see a reason for the initialValue to be assigned this way.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The idea is to put &lt;tt&gt;timeoutAt&lt;/tt&gt; as far in the future as possible, so that it effectively never happens.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In this case, we should just set the initial value to Long.MAX_VALUE&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think that will work, since nanoTime() values can be anything from Long.MIN_VALUE to Long.MAX_VALUE - that&apos;s my interpretation anyway of this from &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#nanoTime--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the &lt;tt&gt;nanoTime()&lt;/tt&gt; javadocs&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This method can only be used to measure elapsed time and is not related to any other notion of system or wall-clock time. The value returned represents nanoseconds since some fixed but arbitrary origin time (perhaps in the future, so values may be negative).&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14502764" author="yseeley@gmail.com" created="Mon, 20 Apr 2015 13:13:54 +0000"  >&lt;p&gt;Right you are, I hadn&apos;t realized that &quot;This method can only be used to measure elapsed time and is not related to any other notion of system or wall-clock time.&quot;&lt;/p&gt;</comment>
                            <comment id="14502770" author="shalinmangar" created="Mon, 20 Apr 2015 13:18:37 +0000"  >&lt;p&gt;I see. Can you please put a comment to that effect in the code and close this issue?&lt;/p&gt;</comment>
                            <comment id="14502774" author="steve_rowe" created="Mon, 20 Apr 2015 13:21:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can you please put a comment to that effect in the code and close this issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will do.  Thanks for bringing it up.&lt;/p&gt;</comment>
                            <comment id="14502910" author="jira-bot" created="Mon, 20 Apr 2015 14:25:54 +0000"  >&lt;p&gt;Commit 1674866 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1674866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1674866&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7419&quot; title=&quot;Initial value of thread local in SolrQueryTimeoutImpl overflows a long&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7419&quot;&gt;&lt;del&gt;SOLR-7419&lt;/del&gt;&lt;/a&gt;: document intentional overflow in SolrQueryTimeoutImpl thread local&lt;/p&gt;</comment>
                            <comment id="14502911" author="jira-bot" created="Mon, 20 Apr 2015 14:27:45 +0000"  >&lt;p&gt;Commit 1674867 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1674867&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1674867&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7419&quot; title=&quot;Initial value of thread local in SolrQueryTimeoutImpl overflows a long&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7419&quot;&gt;&lt;del&gt;SOLR-7419&lt;/del&gt;&lt;/a&gt;: document intentional overflow in SolrQueryTimeoutImpl thread local (merged trunk r1674866)&lt;/p&gt;</comment>
                            <comment id="14502917" author="steve_rowe" created="Mon, 20 Apr 2015 14:31:21 +0000"  >&lt;p&gt;Here&apos;s the comment I added to explain the intentional overflow:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: solr/core/src/java/org/apache/solr/search/SolrQueryTimeoutImpl.java
===================================================================
--- solr/core/src/java/org/apache/solr/search/SolrQueryTimeoutImpl.java	(revision 1674843)
+++ solr/core/src/java/org/apache/solr/search/SolrQueryTimeoutImpl.java	(working copy)
@@ -33,6 +33,23 @@
    * The ThreadLocal variable to store the time beyond which, the processing should exit.
    */
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ThreadLocal&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; timeoutAt = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;() {
+    /**
+     * {@inheritDoc}
+     * &amp;lt;p&amp;gt;
+     * By &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;, timeoutAt is set as far in the &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; as possible, 
+     * so that it effectively never happens.
+     * &amp;lt;p&amp;gt;
+     * Since nanoTime() values can be anything from &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MIN_VALUE to
+     * &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE, adding &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE can cause overflow.  That&apos;s
+     * expected and works fine, since in that &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the subtraction of a
+     * &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; nanoTime() value from timeoutAt (in 
+     * {@link SolrQueryTimeoutImpl#shouldExit}) will result in underflow,
+     * and checking the sign of the result of that subtraction (via
+     * comparison to zero) will correctly indicate whether the &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;
+     * nanoTime() value has exceeded the timeoutAt value.
+     * &amp;lt;p&amp;gt; 
+     * See {@link &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;#nanoTime}
+     */
     @Override
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; initialValue() {
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; nanoTime() + &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14502919" author="shalinmangar" created="Mon, 20 Apr 2015 14:32:36 +0000"  >&lt;p&gt;Thanks Steve!&lt;/p&gt;</comment>
                            <comment id="14586845" author="anshumg" created="Mon, 15 Jun 2015 21:43:22 +0000"  >&lt;p&gt;Bulk close for 5.2.0.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dfmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>