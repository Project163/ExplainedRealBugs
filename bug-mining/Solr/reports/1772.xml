<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:45:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5709] Highlighting grouped duplicate docs from different shards with group.limit &gt; 1 throws ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5709</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In a sharded (non-SolrCloud) deployment, if you index a document with the same unique key value into more than one shard, and then try to highlight grouped docs with more than one doc per group, where the grouped docs contain at least one duplicate doc pair, you get an AIOOBE.&lt;/p&gt;

&lt;p&gt;Here&apos;s the stack trace I got from such a situation, with 1 doc indexed into each shard in a 2-shard index, with &lt;tt&gt;group.limit=2&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR null:java.lang.ArrayIndexOutOfBoundsException: 1
		at org.apache.solr.handler.component.HighlightComponent.finishStage(HighlightComponent.java:185)
		at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:328)
		at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
		at org.apache.solr.core.SolrCore.execute(SolrCore.java:1916)
		at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:758)
		at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:412)
		at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:202)
		at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)
		at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:136)
		at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)
		at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)
		at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:229)
		at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)
		at org.eclipse.jetty.server.handler.GzipHandler.handle(GzipHandler.java:301)
		at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1077)
		at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)
		at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)
		at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)
		at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)
		at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)
		at org.eclipse.jetty.server.Server.handle(Server.java:368)
		at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)
		at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)
		at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)
		at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)
		at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)
		at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82)
		at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:628)
		at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52)
		at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)
		at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)
		at java.lang.Thread.run(Thread.java:724)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12694046">SOLR-5709</key>
            <summary>Highlighting grouped duplicate docs from different shards with group.limit &gt; 1 throws ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarowe">Steven Rowe</assignee>
                                    <reporter username="sarowe">Steven Rowe</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Feb 2014 00:13:56 +0000</created>
                <updated>Mon, 9 May 2016 18:45:55 +0000</updated>
                            <resolved>Mon, 10 Feb 2014 21:13:14 +0000</resolved>
                                    <version>4.3</version>
                    <version>4.4</version>
                    <version>4.5</version>
                    <version>4.6</version>
                    <version>6.0</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>highlighter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13895304" author="steve_rowe" created="Sat, 8 Feb 2014 00:30:41 +0000"  >&lt;p&gt;Simple patch fixing the issue, with tests that fail before the fix and succeed afterward.&lt;/p&gt;

&lt;p&gt;Here&apos;s what&apos;s wrong with the current implementation:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;In &lt;tt&gt;TopGroupsShardResponseProcessor.process()&lt;/tt&gt;, when grouped &lt;tt&gt;ShardDoc&lt;/tt&gt;-s are put into the response&apos;s &lt;tt&gt;resultIds&lt;/tt&gt; unique-key =&amp;gt; &lt;tt&gt;ShardDoc&lt;/tt&gt; map, each &lt;tt&gt;ShardDoc&lt;/tt&gt;&apos;s &lt;tt&gt;positionInResponse&lt;/tt&gt; is set assuming that there will be no duplicate unique-key values.  So when a duplicate is added, the &lt;tt&gt;resultIds&lt;/tt&gt; cardinality doesn&apos;t change, but the 1-up &lt;tt&gt;positionInResponse&lt;/tt&gt; does, and so is thereafter no longer valid.  As a result, when the highlighting component attempts to use &lt;tt&gt;ShardDoc&lt;/tt&gt;-s&apos; &lt;tt&gt;positionInResponse&lt;/tt&gt; to index into an array with the same cardinality as &lt;tt&gt;resultIds&lt;/tt&gt;, an AIOOBE is thrown.&lt;/li&gt;
	&lt;li&gt;When duplicate docs replace previous docs in the &lt;tt&gt;resultIds&lt;/tt&gt; map, the lowest-sorted duplicate is kept, rather than the highest-sorted.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The patch fixes both these problems.&lt;/p&gt;</comment>
                            <comment id="13895928" author="steve_rowe" created="Sun, 9 Feb 2014 17:13:59 +0000"  >&lt;p&gt;I&apos;ll commit tomorrow if there are no objections.&lt;/p&gt;</comment>
                            <comment id="13897007" author="jira-bot" created="Mon, 10 Feb 2014 21:08:04 +0000"  >&lt;p&gt;Commit 1566743 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1566743&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1566743&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5709&quot; title=&quot;Highlighting grouped duplicate docs from different shards with group.limit &amp;gt; 1 throws ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5709&quot;&gt;&lt;del&gt;SOLR-5709&lt;/del&gt;&lt;/a&gt;: Highlighting grouped duplicate docs from different shards with group.limit &amp;gt; 1 throws ArrayIndexOutOfBoundsException&lt;/p&gt;</comment>
                            <comment id="13897014" author="jira-bot" created="Mon, 10 Feb 2014 21:12:47 +0000"  >&lt;p&gt;Commit 1566746 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1566746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1566746&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5709&quot; title=&quot;Highlighting grouped duplicate docs from different shards with group.limit &amp;gt; 1 throws ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5709&quot;&gt;&lt;del&gt;SOLR-5709&lt;/del&gt;&lt;/a&gt;: Highlighting grouped duplicate docs from different shards with group.limit &amp;gt; 1 throws ArrayIndexOutOfBoundsException (merged trunk r1566743)&lt;/p&gt;</comment>
                            <comment id="13897015" author="steve_rowe" created="Mon, 10 Feb 2014 21:13:14 +0000"  >&lt;p&gt;Committed to branch_4x and trunk.&lt;/p&gt;</comment>
                            <comment id="13897359" author="jira-bot" created="Tue, 11 Feb 2014 00:46:13 +0000"  >&lt;p&gt;Commit 1566914 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1566914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1566914&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5709&quot; title=&quot;Highlighting grouped duplicate docs from different shards with group.limit &amp;gt; 1 throws ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5709&quot;&gt;&lt;del&gt;SOLR-5709&lt;/del&gt;&lt;/a&gt;: add missing license&lt;/p&gt;</comment>
                            <comment id="13897362" author="jira-bot" created="Tue, 11 Feb 2014 00:47:29 +0000"  >&lt;p&gt;Commit 1566918 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1566918&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1566918&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5709&quot; title=&quot;Highlighting grouped duplicate docs from different shards with group.limit &amp;gt; 1 throws ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5709&quot;&gt;&lt;del&gt;SOLR-5709&lt;/del&gt;&lt;/a&gt;: add missing license (merged trunk r1566914)&lt;/p&gt;</comment>
                            <comment id="13903444" author="rtulloh" created="Mon, 17 Feb 2014 18:53:05 +0000"  >&lt;p&gt;With this patch, you don&apos;t get AIOOB, but hit count and documents returned do not match.&lt;/p&gt;

&lt;p&gt;I wrote a script to test this. I have 10 documents on one shard. I then duplicated 6 of the documents on another shard. Hit count reports 16, but actual documents returned is 10. I think the values should agree.&lt;/p&gt;

&lt;p&gt;Mon Feb 17 12:50:02 2014 numDocs 16 query cost 1.1669998168945312&lt;br/&gt;
Mon Feb 17 12:50:02 2014 numDocs 0 query cost 0.1399998664855957&lt;br/&gt;
Done counted 10&lt;/p&gt;</comment>
                            <comment id="13903626" author="steve_rowe" created="Tue, 18 Feb 2014 00:23:22 +0000"  >&lt;p&gt;Hi Rob,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;With this patch, you don&apos;t get AIOOB, but hit count and documents returned do not match.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;To which hit count are you referring?  &lt;/p&gt;

&lt;p&gt;The grouped document count reflects all matching documents, including duplicated docs.  Since the returned grouped docs include duplicates, this seems correct to me: the reported count matches the set cardinality.&lt;/p&gt;

&lt;p&gt;When highlighting and grouping, I don&apos;t see a hit count for the highlighted docs &amp;#8211; I&apos;m guessing it&apos;s the highlighted docs that you&apos;re referring to when you say &quot;actual documents returned&quot;.&lt;/p&gt;

&lt;p&gt;Can you attach a response illustrating what you&apos;re talking about?&lt;/p&gt;</comment>
                            <comment id="13903755" author="rtulloh" created="Tue, 18 Feb 2014 03:55:07 +0000"  >&lt;p&gt;Thank you for the question. Let me try and explain with an example.&lt;/p&gt;

&lt;p&gt;We use field collapsing to return all the documents associated with a single ID. We parse the results and apply highlighting for end users to see how their search terms were matched in the returned text. In the case of the test I am running, there are 10 unique IDs to be found. The fact that 6 documents are duplicated should not impact the unique number of groups returned. In fact, that is proven because we count 10 results when we iterate the results. What I would also expect is that the hit count (ngroups) would reflect this. Here is a query result to demonstrate the issue.  Note that the group field is group.field=storageid&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[root@aggregator-1 solr]# wget -O- -q &apos;http://localhost:8983/solr/select?params={hl.requireFieldMatch=true&amp;amp;group.ngroups=true&amp;amp;group.limit=1000&amp;amp;isPartial=0&amp;amp;hl.simple.pre=&amp;lt;b&amp;gt;&amp;amp;hl.fl=*&amp;amp;wt=xml&amp;amp;hl=true&amp;amp;rows=1&amp;amp;EmsQueryId=INTERNAL&amp;amp;f.mailsubject2.qf=mailsubject&amp;amp;shards=archive-8.ems.labmanager.net:8983/solr,archive-6.ems.labmanager.net:8983/solr&amp;amp;start=0&amp;amp;q=customerid:352&amp;amp;f.body2.qf=body&amp;amp;group.field=storageid&amp;amp;hl.simple.post=&amp;lt;/b&amp;gt;&amp;amp;group=true&amp;amp;qt=/search-any&amp;amp;EmsQueryTs=1392658773339}&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the output. Note the value of matches and ngroups in the output.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;response&amp;gt;
&amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;&amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;QTime&quot;&amp;gt;39&amp;lt;/int&amp;gt;&amp;lt;lst name=&quot;params&quot;&amp;gt;&amp;lt;str name=&quot;group.ngroups&quot;&amp;gt;true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;group.limit&quot;&amp;gt;1000&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;isPartial&quot;&amp;gt;0&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl.simple.pre&quot;&amp;gt;&amp;amp;lt;b&amp;amp;gt;&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;params&quot;&amp;gt;{hl.requireFieldMatch=true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl.fl&quot;&amp;gt;*&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;wt&quot;&amp;gt;xml&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl&quot;&amp;gt;true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;rows&quot;&amp;gt;1&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;EmsQueryId&quot;&amp;gt;INTERNAL&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;f.mailsubject2.qf&quot;&amp;gt;mailsubject&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;shards&quot;&amp;gt;archive-8.ems.labmanager.net:8983/solr,archive-6.ems.labmanager.net:8983/solr&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;start&quot;&amp;gt;0&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;q&quot;&amp;gt;customerid:352&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;f.body2.qf&quot;&amp;gt;body&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;group.field&quot;&amp;gt;storageid&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl.simple.post&quot;&amp;gt;&amp;amp;lt;/b&amp;amp;gt;&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;group&quot;&amp;gt;true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;qt&quot;&amp;gt;/search-any&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;EmsQueryTs&quot;&amp;gt;1392658773339}&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst name=&quot;grouped&quot;&amp;gt;&amp;lt;lst name=&quot;storageid&quot;&amp;gt;&amp;lt;int name=&quot;matches&quot;&amp;gt;16&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;ngroups&quot;&amp;gt;16&amp;lt;/int&amp;gt;&amp;lt;arr name=&quot;groups&quot;&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;long name=&quot;groupValue&quot;&amp;gt;43937&amp;lt;/long&amp;gt;&amp;lt;result name=&quot;doclist&quot; numFound=&quot;1&quot; start=&quot;0&quot; maxScore=&quot;7.0955024&quot;&amp;gt;&amp;lt;doc&amp;gt;&amp;lt;str name=&quot;contentid&quot;&amp;gt;43937&amp;lt;/str&amp;gt;&amp;lt;int name=&quot;senderid&quot;&amp;gt;12759&amp;lt;/int&amp;gt;&amp;lt;arr name=&quot;recipientids&quot;&amp;gt;&amp;lt;int&amp;gt;12741&amp;lt;/int&amp;gt;&amp;lt;/arr&amp;gt;&amp;lt;long name=&quot;storageid&quot;&amp;gt;43937&amp;lt;/long&amp;gt;&amp;lt;date name=&quot;receiveddate&quot;&amp;gt;2000-12-12T11:07:00Z&amp;lt;/date&amp;gt;&amp;lt;str name=&quot;mailfrom&quot;&amp;gt;donna.martens@enron.com&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;envsender&quot;&amp;gt;donna.martens@enron.com&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;mailto&quot;&amp;gt;sharon.solon@enron.com &amp;lt;/str&amp;gt;&amp;lt;int name=&quot;partitionid&quot;&amp;gt;1&amp;lt;/int&amp;gt;&amp;lt;str name=&quot;indexlevel&quot;&amp;gt;0&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;mailcc&quot;&amp;gt;david.roensch@enron.com rich.jolly@enron.com maria.pavlou@enron.com dorothy.mccoppin@enron.com kevin.hyatt@enron.com mary.darveaux@enron.com lorraine.lindberg@enron.com steven.harris@enron.com drew.fossum@enron.com earl.chanley@enron.com ronald.matthews@enron.com arnold.eisenstein@enron.com jerry.martin@enron.com patrick.brennan@enron.com dave.waymire@enron.com keith.petersen@enron.com &amp;lt;/str&amp;gt;&amp;lt;int name=&quot;importance&quot;&amp;gt;1&amp;lt;/int&amp;gt;&amp;lt;date name=&quot;emaildate&quot;&amp;gt;2000-12-12T11:07:00Z&amp;lt;/date&amp;gt;&amp;lt;int name=&quot;customerid&quot;&amp;gt;352&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;igen1&quot;&amp;gt;0&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;totalsize&quot;&amp;gt;3780&amp;lt;/int&amp;gt;&amp;lt;bool name=&quot;isattachment&quot;&amp;gt;false&amp;lt;/bool&amp;gt;&amp;lt;str name=&quot;mime&quot;&amp;gt;text/plain&amp;lt;/str&amp;gt;&amp;lt;int name=&quot;clusterlocationid&quot;&amp;gt;102&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;islandid&quot;&amp;gt;101&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;size&quot;&amp;gt;2240&amp;lt;/int&amp;gt;&amp;lt;str name=&quot;language&quot;&amp;gt;en&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;mailsubject_en&quot;&amp;gt;Re: Gallup Expansion&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;mailsubject2_en&quot;&amp;gt;Re: Gallup Expansion&amp;lt;/str&amp;gt;&amp;lt;long name=&quot;_version_&quot;&amp;gt;1460308152307154944&amp;lt;/long&amp;gt;&amp;lt;date name=&quot;processingtime&quot;&amp;gt;2014-02-17T17:32:58.887Z&amp;lt;/date&amp;gt;&amp;lt;/doc&amp;gt;&amp;lt;/result&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/arr&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst name=&quot;highlighting&quot;&amp;gt;&amp;lt;lst name=&quot;43937&quot;/&amp;gt;&amp;lt;/lst&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are exactly 10 unique results associated with that field. I can understand matches being 16 (the number of documents matching the query), but I would expect ngroups to be 10 for the number of unique groups being returned. Our code reads ngroups and returns this as the hit count for the query so that we report to the caller the number of unique hits observed.&lt;/p&gt;

&lt;p&gt;I hope I have made it clear. Please let me know if I can answer any more questions.&lt;/p&gt;</comment>
                            <comment id="13903776" author="rtulloh" created="Tue, 18 Feb 2014 04:40:19 +0000"  >&lt;p&gt;Here is an example where we get the result we expect (no duplicates involved):&lt;/p&gt;

&lt;p&gt;In this case 3 documents map to the same storageid parent. Notice that in this result, matches is 3 (number of documents) and ngroups is 1 (the number of unique results):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;lst name=&quot;responseHeader&quot;&amp;gt;&amp;lt;int name=&quot;status&quot;&amp;gt;0&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;QTime&quot;&amp;gt;194&amp;lt;/int&amp;gt;&amp;lt;lst name=&quot;params&quot;&amp;gt;&amp;lt;str name=&quot;group.ngroups&quot;&amp;gt;true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;group.limit&quot;&amp;gt;1000&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;isPartial&quot;&amp;gt;0&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl.simple.pre&quot;&amp;gt;&amp;amp;lt;b&amp;amp;gt;&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;params&quot;&amp;gt;{hl.requireFieldMatch=true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl.fl&quot;&amp;gt;*&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;wt&quot;&amp;gt;xml&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl&quot;&amp;gt;true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;rows&quot;&amp;gt;1&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;EmsQueryId&quot;&amp;gt;INTERNAL&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;f.mailsubject2.qf&quot;&amp;gt;mailsubject&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;shards&quot;&amp;gt;archive-8.ems.labmanager.net:8983/solr,archive-6.ems.labmanager.net:8983/solr&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;start&quot;&amp;gt;0&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;q&quot;&amp;gt;customerid:352&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;f.body2.qf&quot;&amp;gt;body&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;group.field&quot;&amp;gt;storageid&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;hl.simple.post&quot;&amp;gt;&amp;amp;lt;/b&amp;amp;gt;&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;group&quot;&amp;gt;true&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;qt&quot;&amp;gt;/search-any&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;fq&quot;&amp;gt;{!lucene}storageid:{44414 TO 44415]&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;EmsQueryTs&quot;&amp;gt;1392658773339}&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;/lst&amp;gt;&amp;lt;lst name=&quot;grouped&quot;&amp;gt;&amp;lt;lst name=&quot;storageid&quot;&amp;gt;&amp;lt;int name=&quot;matches&quot;&amp;gt;3&amp;lt;/int&amp;gt;&amp;lt;int name=&quot;ngroups&quot;&amp;gt;1&amp;lt;/int&amp;gt;&amp;lt;arr name=&quot;groups&quot;&amp;gt;&amp;lt;lst&amp;gt;&amp;lt;long name=&quot;groupValue&quot;&amp;gt;44415&amp;lt;/long&amp;gt;&amp;lt;result name=&quot;doclist&quot; numFound=&quot;3&quot; start=&quot;0&quot; maxScore=&quot;2.8401346&quot;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What puzzles me is why the result with duplicates doesn&apos;t group the same way. Clearly, this result shows it does work without duplicates involved. Is there an explanation for why this is the case?&lt;/p&gt;</comment>
                            <comment id="13904063" author="steve_rowe" created="Tue, 18 Feb 2014 14:05:23 +0000"  >&lt;p&gt;Rob,&lt;/p&gt;

&lt;p&gt;I see what you mean: ngroups should be the same as the number of groups.  This problem still happens when I don&apos;t request highlighting, so it appears to be a problem with grouping only.&lt;/p&gt;

&lt;p&gt;This may be related to a known issue - from the &lt;tt&gt;group.ngroups&lt;/tt&gt; description on &lt;a href=&quot;http://wiki.apache.org/solr/FieldCollapsing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/solr/FieldCollapsing&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;WARNING: If this parameter is set to true on a sharded environment, all the documents that belong to the same group have to be located in the same shard, otherwise the count will be incorrect. If you are using SolrCloud, consider using &quot;custom hashing&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ll do some more testing.&lt;/p&gt;</comment>
                            <comment id="13904280" author="rtulloh" created="Tue, 18 Feb 2014 17:25:18 +0000"  >&lt;p&gt;Thanks for reminding to look back at the documentation. I agree that the duplicates are likely the cause of the unexpected counts because the duplicates live on different shards. The field collapsing wiki does document this limitation.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12627753" name="SOLR-5709.patch" size="5679" author="sarowe" created="Sat, 8 Feb 2014 00:30:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372555</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s7dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372859</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>