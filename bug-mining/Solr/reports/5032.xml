<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:58:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7609] ShardSplitTest NPE</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7609</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I&apos;m guessing this is a test bug, but the seed doesn&apos;t reproduce for me (tried on the same Linux machine it occurred on and on OS X):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=ShardSplitTest -Dtests.method=test -Dtests.seed=9318DDA46578ECF9 -Dtests.slow=true -Dtests.locale=is -Dtests.timezone=America/St_Vincent -Dtests.asserts=true -Dtests.file.encoding=US-ASCII
   [junit4] ERROR   55.8s J6  | ShardSplitTest.test &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.NullPointerException
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([9318DDA46578ECF9:1B4CE27ECB848101]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardSplitTest.logDebugHelp(ShardSplitTest.java:547)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardSplitTest.checkDocCountsAndShardStates(ShardSplitTest.java:438)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardSplitTest.splitByUniqueKeyTest(ShardSplitTest.java:222)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.ShardSplitTest.test(ShardSplitTest.java:84)
   [junit4]    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsFixedStatement.callStatement(BaseDistributedSearchTestCase.java:960)
   [junit4]    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsStatement.evaluate(BaseDistributedSearchTestCase.java:935)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Line 547 of &lt;tt&gt;ShardSplitTest.java&lt;/tt&gt; is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      idVsVersion.put(document.getFieldValue(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;).toString(), document.getFieldValue(&lt;span class=&quot;code-quote&quot;&gt;&quot;_version_&quot;&lt;/span&gt;).toString());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Skimming the code, it&apos;s not obvious what could be null.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12833816">SOLR-7609</key>
            <summary>ShardSplitTest NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tflobbe">Tomas Eduardo Fernandez Lobbe</assignee>
                                    <reporter username="sarowe">Steven Rowe</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 May 2015 14:49:17 +0000</created>
                <updated>Fri, 17 Oct 2025 20:04:55 +0000</updated>
                            <resolved>Thu, 27 Apr 2023 23:08:52 +0000</resolved>
                                                    <fixVersion>9.3</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15000">4h 10m</timespent>
                                <comments>
                            <comment id="14564918" author="steve_rowe" created="Fri, 29 May 2015 14:51:25 +0000"  >&lt;p&gt;Attaching log excerpt for the failing test.&lt;/p&gt;</comment>
                            <comment id="17706995" author="risdenk" created="Thu, 30 Mar 2023 18:57:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt; added some debug to find out that &quot;&lt;em&gt;version&lt;/em&gt;&quot; looks to be null - &lt;a href=&quot;https://github.com/apache/solr/pull/1504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1504&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am also linking a few related jiras he found to try to consolidate.&lt;/p&gt;</comment>
                            <comment id="17707396" author="alex.parvulescu" created="Fri, 31 Mar 2023 18:54:58 +0000"  >&lt;p&gt;(pasting my PR comment here as well, for future reference &lt;a href=&quot;https://github.com/apache/solr/pull/1504#issuecomment-1492441639&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1504#issuecomment-1492441639&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;I have pushed a tentative patch for review and more importantly for discussion.&lt;/p&gt;

&lt;p&gt;I have ran this test extensively (hundreds of beast jobs) and it looks like this is the way to go, all &apos;add&apos; exceptions are gone once the isLeader flag is updated. BUT I am not completely convinced this is the correct patch. possibly something could be made better in the DistributedZkUpdateProcessor area instead (where a lot of leader calculations are being made but the result is not correct in this edge case).&lt;br/&gt;
While I am still evaluating a patch for DistributedZkUpdateProcessor, I would love some feedback on the observations so far.&lt;/p&gt;

&lt;p&gt;More on the isLeader update: I have decided to only do this in the case where it can be used to avoid throwing an exception. this was to add a best-effort way correct an inconsistent state before bailing out, possibly a cleaner fix would compute the &apos;isLeader&apos; flag in a way that this approach is no longer needed.&lt;/p&gt;

&lt;p&gt;Together with the patch I have added a check which will not allow additions with no version. this is now consistent with the delete flows. although I must admit I am confused by the fact that this check was missing on this execution path, while the delete path had this from at least 8 years ago.&lt;/p&gt;

&lt;p&gt;Other points&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;in the current test, there are a few operations (add and deletes) that run parallel to the split operation. these can fail and this is where the bug is. because the exceptions are not correctly accounted for, the NPE popped up at a weird place. I added tracking and assertions on this part too (except for deletes, see below)&lt;/li&gt;
	&lt;li&gt;deletes can also cause exceptions, I don&apos;t have a good handle on how to fix this, so I removed the strict error check. this can be added once the confidence level is higher and this flow is accounted for. until then I will focus on the addition parts.&lt;/li&gt;
	&lt;li&gt;DistributedZkUpdateProcessor will call setupRequest twice. this is probably a minor nuisance for some future improvement PR.&lt;/li&gt;
	&lt;li&gt;finding the code very hard to read I took the decision to remove one variable that is not really needed (the updateCommand), this change is purely cosmetic and I can revert it if it adds too much noise to the current patch.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17716031" author="alex.parvulescu" created="Mon, 24 Apr 2023 23:16:45 +0000"  >&lt;p&gt;Updating with the GitHub data as PR is close to being merged, for future reference&lt;/p&gt;

&lt;p&gt;Changes done:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;added the version check on additions to fail in case we are not leader and version = 0. (to match delete flows)&lt;/li&gt;
	&lt;li&gt;changed error status from BAD_REQUEST to INVALID_STATE to allow for retries. I was able to verify retries are happening &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;removed a &apos;cmd&apos; variable - this is just minor readability refactoring, I tried to avoid changing the code as much as possible&lt;/li&gt;
	&lt;li&gt;updated the ShardSplitTest to keep track of exceptions happening during the concurrent adds and deletes and fail if needed.&lt;/li&gt;
	&lt;li&gt;fixed wrong NPE check on &lt;a href=&quot;https://github.com/apache/solr/blob/db4cb66271f615da6a0a3ae6fed5fb2e184fd053/solr/core/src/java/org/apache/solr/update/processor/DistributedZkUpdateProcessor.java#L889&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DistributedZkUpdateProcessor#getCollectionUrls&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;Things to followup later:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;there is still one failure happening&#160;`Request says it is coming from parent shard leader but we are in active state`&lt;/li&gt;
	&lt;li&gt;noticed the setupRequest() method is usually called twice, I think this is easy to fix with a basic flag, I can add it if it doesn&apos;t grow the PR too much, or it can be done on a followup PR.&lt;/li&gt;
	&lt;li&gt;all over the class there is a pattern of checking read only status to prevent some operations I believe could be broken.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
clusterState = zkController.getClusterState();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isReadOnly()) {
  &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrException(ErrorCode.FORBIDDEN, &lt;span class=&quot;code-quote&quot;&gt;&quot;Collection &quot;&lt;/span&gt; + collection + &lt;span class=&quot;code-quote&quot;&gt;&quot; is read-only.&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;refreshing the clusterState is insufficient, because the isReadOnly is based on the readOnlyCollection flag that is only initialized at the beginning. if the intent was to have a fresh check, the readOnlyCollection flag needs to be updated too, based on the new clusterState&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17716363" author="jira-bot" created="Tue, 25 Apr 2023 16:59:46 +0000"  >&lt;p&gt;Commit 1d8781d61746d0b9c6dbf3cc2b5c9ecd4f90537b in solr&apos;s branch refs/heads/main from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=1d8781d6174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=1d8781d6174&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7609&quot; title=&quot;ShardSplitTest NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7609&quot;&gt;&lt;del&gt;SOLR-7609&lt;/del&gt;&lt;/a&gt;: Validate the version is present on follower replicas when adding documents (#1504)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Add the version check on additions to fail in case we are not leader and version = 0. (to match delete flows)&lt;/li&gt;
	&lt;li&gt;Change error status from BAD_REQUEST to INVALID_STATE to allow for retries.&lt;/li&gt;
	&lt;li&gt;Remove a &apos;cmd&apos; variable - this is just minor readability refactoring, I tried to avoid changing the code as much as possible&lt;/li&gt;
	&lt;li&gt;Update the ShardSplitTest to keep track of exceptions happening during the concurrent adds and deletes and fail if needed.&lt;br/&gt;
*Fix bad null validation&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17716397" author="jira-bot" created="Tue, 25 Apr 2023 18:56:45 +0000"  >&lt;p&gt;Commit fbf0980dba4118c17f658f5a0b79f929799910c1 in solr&apos;s branch refs/heads/branch_9x from Alex Deparvu&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=fbf0980dba4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=fbf0980dba4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7609&quot; title=&quot;ShardSplitTest NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7609&quot;&gt;&lt;del&gt;SOLR-7609&lt;/del&gt;&lt;/a&gt;: Validate the version is present on follower replicas when adding documents (#1504)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Add the version check on additions to fail in case we are not leader and version = 0. (to match delete flows)&lt;/li&gt;
	&lt;li&gt;Change error status from BAD_REQUEST to INVALID_STATE to allow for retries.&lt;/li&gt;
	&lt;li&gt;Remove a &apos;cmd&apos; variable - this is just minor readability refactoring, I tried to avoid changing the code as much as possible&lt;/li&gt;
	&lt;li&gt;Update the ShardSplitTest to keep track of exceptions happening during the concurrent adds and deletes and fail if needed.&lt;br/&gt;
*Fix bad null validation&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17716408" author="tomasflobbe" created="Tue, 25 Apr 2023 19:24:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stillalex&quot; class=&quot;user-hover&quot; rel=&quot;stillalex&quot;&gt;stillalex&lt;/a&gt;! Let&apos;s give this a couple days to see if this error clears and then we can mark as resolved&lt;/p&gt;</comment>
                            <comment id="17717397" author="tomasflobbe" created="Thu, 27 Apr 2023 23:08:52 +0000"  >&lt;p&gt;Haven&apos;t seen a failure recently, but failures weren&apos;t that frequently before so it&apos;s not really a confirmation of the fix. That said, I&apos;m going to be optimistic and close this one. If we see new failures with the test they may be different, or at least have a different stacktrace.&lt;/p&gt;</comment>
                            <comment id="17745789" author="houston" created="Fri, 21 Jul 2023 20:40:39 +0000"  >&lt;p&gt;Closing after the 9.3.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12661986">SOLR-5117</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12902326">SOLR-8122</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12818698">SOLR-7354</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12736156" name="ShardSplitTest.NPE.log" size="1315635" author="sarowe" created="Fri, 29 May 2015 14:51:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fdvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>