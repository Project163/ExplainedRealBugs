<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:06:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6357] Using query time Join in deleteByQuery throws ClassCastException</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6357</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Consider the following input document where we have:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1 Samsung mobile phone and&lt;/li&gt;
	&lt;li&gt;2 manufactures: Apple and Samsung.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[
   {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;galaxy note ii&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;cat&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;product&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;manu_s&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;samsung&quot;&lt;/span&gt;
   },
   {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;samsung&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;cat&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;manufacturer&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;Samsung Electronics&quot;&lt;/span&gt;
   },
   {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;apple&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;cat&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;manufacturer&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;Apple Inc&quot;&lt;/span&gt;
   }
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My objective is to delete from the default index all manufacturers not having any product in the index.&lt;/p&gt;

&lt;p&gt;After indexing (  curl &apos;http://localhost:8983/solr/update?commit=true&apos; -H &quot;Content-Type: text/json&quot; --data-binary @delete-by-join-query.json )&lt;/p&gt;

&lt;p&gt;I went to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/select?q=cat:manufacturer -{!join from=manu_s to=id}cat:product&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and I could see only Apple, the only manufacturer not having any product in the index.&lt;/p&gt;

&lt;p&gt;However, when I use that same query for deletion: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/update?commit=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;stream.body=&amp;lt;delete&amp;gt;&amp;lt;query&amp;gt;cat:manufacturer -{!join from=manu_s to=id}cat:product&amp;lt;/query&amp;gt;&amp;lt;/delete&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I get&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ClassCastException: org.apache.lucene.search.IndexSearcher cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.solr.search.SolrIndexSearcher
	at org.apache.solr.search.JoinQuery.createWeight(JoinQParserPlugin.java:143)
	at org.apache.lucene.search.BooleanQuery$BooleanWeight.&amp;lt;init&amp;gt;(BooleanQuery.java:185)
	at org.apache.lucene.search.BooleanQuery.createWeight(BooleanQuery.java:526)
	at org.apache.lucene.search.BooleanQuery$BooleanWeight.&amp;lt;init&amp;gt;(BooleanQuery.java:185)
	at org.apache.lucene.search.BooleanQuery.createWeight(BooleanQuery.java:526)
	at org.apache.lucene.search.IndexSearcher.createNormalizedWeight(IndexSearcher.java:684)
	at org.apache.lucene.search.QueryWrapperFilter.getDocIdSet(QueryWrapperFilter.java:55)
	at org.apache.lucene.index.BufferedUpdatesStream.applyQueryDeletes(BufferedUpdatesStream.java:552)
	at org.apache.lucene.index.BufferedUpdatesStream.applyDeletesAndUpdates(BufferedUpdatesStream.java:287)
	at 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This seems to be a bug.&lt;/p&gt;

&lt;p&gt;Looking at the source code, the exception is happening in &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Weight createWeight(IndexSearcher searcher) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JoinQueryWeight((SolrIndexSearcher)searcher);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12733045">SOLR-6357</key>
            <summary>Using query time Join in deleteByQuery throws ClassCastException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mkhl">Mikhail Khludnev</assignee>
                                    <reporter username="arcadius">Arcadius Ahouansou</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Aug 2014 18:07:32 +0000</created>
                <updated>Thu, 23 Nov 2017 09:58:39 +0000</updated>
                            <resolved>Thu, 6 Jul 2017 07:38:24 +0000</resolved>
                                    <version>4.9</version>
                                    <fixVersion>7.0</fixVersion>
                                    <component>query parsers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14092504" author="mkhludnev" created="Mon, 11 Aug 2014 06:34:53 +0000"  >&lt;p&gt;I&apos;m not sure but it might be challenging to use purely Solr query {!join ..} deep inside of Lucene core, where deleteQuery is handled. Try to use native Lucene query-time join &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6234&quot; title=&quot;Scoring modes for query time join &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6234&quot;&gt;&lt;del&gt;SOLR-6234&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14255528" author="mkhludnev" created="Mon, 22 Dec 2014 07:47:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6234&quot; title=&quot;Scoring modes for query time join &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6234&quot;&gt;&lt;del&gt;SOLR-6234&lt;/del&gt;&lt;/a&gt;  is a solution &lt;/p&gt;</comment>
                            <comment id="14644680" author="thelabdude" created="Tue, 28 Jul 2015 17:19:01 +0000"  >&lt;p&gt;Adding a unit test that uses the score join solution to fix this issue.&lt;/p&gt;</comment>
                            <comment id="14646479" author="thelabdude" created="Wed, 29 Jul 2015 17:41:34 +0000"  >&lt;p&gt;Here&apos;s a patch with a simple unit test to verify that delete by query works using score join.&lt;/p&gt;</comment>
                            <comment id="14646643" author="mkhludnev" created="Wed, 29 Jul 2015 19:40:03 +0000"  >&lt;p&gt;+1 for commit. &lt;/p&gt;</comment>
                            <comment id="14646652" author="jira-bot" created="Wed, 29 Jul 2015 19:45:49 +0000"  >&lt;p&gt;Commit 1693338 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1693338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1693338&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6357&quot; title=&quot;Using query time Join in deleteByQuery throws ClassCastException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6357&quot;&gt;&lt;del&gt;SOLR-6357&lt;/del&gt;&lt;/a&gt;: Allow delete documents by doing a score join query.&lt;/p&gt;</comment>
                            <comment id="14646659" author="jira-bot" created="Wed, 29 Jul 2015 19:53:30 +0000"  >&lt;p&gt;Commit 1693339 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1693339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1693339&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6357&quot; title=&quot;Using query time Join in deleteByQuery throws ClassCastException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6357&quot;&gt;&lt;del&gt;SOLR-6357&lt;/del&gt;&lt;/a&gt;: Allow delete documents by doing a score join query.&lt;/p&gt;</comment>
                            <comment id="14646660" author="thelabdude" created="Wed, 29 Jul 2015 19:54:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;! Nice work on the score join stuff.&lt;/p&gt;</comment>
                            <comment id="14647408" author="arcadius" created="Thu, 30 Jul 2015 09:46:45 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; for fixing this issue.&lt;/p&gt;</comment>
                            <comment id="14713133" author="shalinmangar" created="Wed, 26 Aug 2015 13:05:51 +0000"  >&lt;p&gt;Bulk close for 5.3.0 release&lt;/p&gt;</comment>
                            <comment id="16074496" author="mkhludnev" created="Wed, 5 Jul 2017 09:39:04 +0000"  >&lt;p&gt;broken by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10986&quot; title=&quot;TestScoreJoinQPScore.testDeleteByScoreJoinQuery() failure: mismatch: &amp;#39;0&amp;#39;!=&amp;#39;1&amp;#39; @ response/numFound&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10986&quot;&gt;&lt;del&gt;SOLR-10986&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9217&quot; title=&quot;{!join score=..}.. should delay join to createWeight&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9217&quot;&gt;&lt;del&gt;SOLR-9217&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16263448" author="ahankinson" created="Wed, 22 Nov 2017 22:16:05 +0000"  >&lt;p&gt;I&apos;m still seeing a problem related to this in Solr 7.0.1 (OSX) and 7.1.0 (RHEL7).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Sample data:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;collections_sm is a dynamic multivalued string field. All others are string fields.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-javascript&quot;&gt;
{
&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1234&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;object_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1234&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;object&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;collections_sm&quot;&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;printed books&quot;&lt;/span&gt;]
}

{
&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;4567&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;object_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1234&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;surface&quot;&lt;/span&gt;
}

{
&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;7890&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;object_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1234&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;image&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Query:&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;delete&amp;gt;&amp;lt;query&amp;gt;{!join from=id to=object_id}collections_sm:(&lt;span class=&quot;code-quote&quot;&gt;&apos;printed books&apos;&lt;/span&gt;)&amp;lt;/query&amp;gt;&amp;lt;/delete&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Query log&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2017-11-22 22:00:20.802 INFO  (qtp466002798-19) [   x:mycore] o.a.s.u.p.LogUpdateProcessorFactory [mycore]  webapp=/solr path=/update params={commit=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;}{deleteByQuery={!join from=id to=object_id}collections_sm:(&lt;span class=&quot;code-quote&quot;&gt;&apos;printed books&apos;&lt;/span&gt;) (-1584805205294186496)} 0 5
2017-11-22 22:00:20.802 ERROR (qtp466002798-19) [   x:mycore] o.a.s.h.RequestHandlerBase org.apache.lucene.store.AlreadyClosedException: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; IndexWriter is closed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Corrupted Index&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This seems to put the index in a corrupt state &amp;#8211; it will not accept any more write or modification operations to the core until the data directory is deleted. Any attempts to make changes to the core will result in an error:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.ClassCastException: org.apache.lucene.search.IndexSearcher cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.solr.search.SolrIndexSearcher
	at org.apache.solr.search.JoinQuery.createWeight(JoinQParserPlugin.java:169)
	at org.apache.lucene.search.IndexSearcher.createWeight(IndexSearcher.java:734)
	at org.apache.lucene.search.BooleanWeight.&amp;lt;init&amp;gt;(BooleanWeight.java:54)
	at org.apache.lucene.search.BooleanQuery.createWeight(BooleanQuery.java:204)
	at org.apache.solr.update.DeleteByQueryWrapper.createWeight(DeleteByQueryWrapper.java:72)
	at org.apache.lucene.search.IndexSearcher.createWeight(IndexSearcher.java:734)
	at org.apache.lucene.search.IndexSearcher.createNormalizedWeight(IndexSearcher.java:724)
	at org.apache.lucene.index.FrozenBufferedUpdates.applyQueryDeletes(FrozenBufferedUpdates.java:687)
	at org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:443)
	at org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:324)
	at org.apache.lucene.index.DocumentsWriter$ResolveUpdatesEvent.process(DocumentsWriter.java:723)
	at org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5057)
	at org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5045)
	at org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:466)
	at org.apache.lucene.index.StandardDirectoryReader.doOpenFromWriter(StandardDirectoryReader.java:293)
	at org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:278)
	at org.apache.lucene.index.DirectoryReader.openIfChanged(DirectoryReader.java:235)
	at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1987)
	at org.apache.solr.update.UpdateLog.openRealtimeSearcher(UpdateLog.java:648)
	at org.apache.solr.update.UpdateLog.deleteByQuery(UpdateLog.java:629)
	at org.apache.solr.update.DirectUpdateHandler2.deleteByQuery(DirectUpdateHandler2.java:534)
	at org.apache.solr.update.processor.RunUpdateProcessor.processDelete(RunUpdateProcessorFactory.java:78)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:59)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalDelete(DistributedUpdateProcessor.java:996)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.versionDeleteByQuery(DistributedUpdateProcessor.java:1691)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.doDeleteByQuery(DistributedUpdateProcessor.java:1595)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.processDelete(DistributedUpdateProcessor.java:1404)
	at org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processDelete(LogUpdateProcessorFactory.java:124)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:59)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:59)
	at org.apache.solr.handler.loader.XMLLoader.processDelete(XMLLoader.java:366)
	at org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:292)
	at org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:188)
	at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)
	at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)
	... 33 more

2017-11-22 22:00:20.803 ERROR (qtp466002798-19) [   x:mycore] o.a.s.s.HttpSolrCall &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;:org.apache.lucene.store.AlreadyClosedException: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; IndexWriter is closed
	at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:896)
	at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:910)
	at org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3377)
	at org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:679)
	at org.apache.solr.update.processor.RunUpdateProcessor.processCommit(RunUpdateProcessorFactory.java:93)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:68)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalCommit(DistributedUpdateProcessor.java:1950)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.processCommit(DistributedUpdateProcessor.java:1926)
	at org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processCommit(LogUpdateProcessorFactory.java:160)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:68)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processCommit(UpdateRequestProcessor.java:68)
	at org.apache.solr.handler.RequestHandlerUtils.handleCommit(RequestHandlerUtils.java:69)
	at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:72)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:177)
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:2484)
	at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:720)
	at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:526)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:382)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:326)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1751)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)
	at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)
	at org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)
	at org.eclipse.jetty.server.Server.handle(Server.java:534)
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:283)
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:108)
	at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)
	at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.ClassCastException: org.apache.lucene.search.IndexSearcher cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.solr.search.SolrIndexSearcher
	at org.apache.solr.search.JoinQuery.createWeight(JoinQParserPlugin.java:169)
	at org.apache.lucene.search.IndexSearcher.createWeight(IndexSearcher.java:734)
	at org.apache.lucene.search.BooleanWeight.&amp;lt;init&amp;gt;(BooleanWeight.java:54)
	at org.apache.lucene.search.BooleanQuery.createWeight(BooleanQuery.java:204)
	at org.apache.solr.update.DeleteByQueryWrapper.createWeight(DeleteByQueryWrapper.java:72)
	at org.apache.lucene.search.IndexSearcher.createWeight(IndexSearcher.java:734)
	at org.apache.lucene.search.IndexSearcher.createNormalizedWeight(IndexSearcher.java:724)
	at org.apache.lucene.index.FrozenBufferedUpdates.applyQueryDeletes(FrozenBufferedUpdates.java:687)
	at org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:443)
	at org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:324)
	at org.apache.lucene.index.DocumentsWriter$ResolveUpdatesEvent.process(DocumentsWriter.java:723)
	at org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5057)
	at org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5045)
	at org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:466)
	at org.apache.lucene.index.StandardDirectoryReader.doOpenFromWriter(StandardDirectoryReader.java:293)
	at org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:278)
	at org.apache.lucene.index.DirectoryReader.openIfChanged(DirectoryReader.java:235)
	at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1987)
	at org.apache.solr.update.UpdateLog.openRealtimeSearcher(UpdateLog.java:648)
	at org.apache.solr.update.UpdateLog.deleteByQuery(UpdateLog.java:629)
	at org.apache.solr.update.DirectUpdateHandler2.deleteByQuery(DirectUpdateHandler2.java:534)
	at org.apache.solr.update.processor.RunUpdateProcessor.processDelete(RunUpdateProcessorFactory.java:78)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:59)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalDelete(DistributedUpdateProcessor.java:996)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.versionDeleteByQuery(DistributedUpdateProcessor.java:1691)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.doDeleteByQuery(DistributedUpdateProcessor.java:1595)
	at org.apache.solr.update.processor.DistributedUpdateProcessor.processDelete(DistributedUpdateProcessor.java:1404)
	at org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processDelete(LogUpdateProcessorFactory.java:124)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:59)
	at org.apache.solr.update.processor.UpdateRequestProcessor.processDelete(UpdateRequestProcessor.java:59)
	at org.apache.solr.handler.loader.XMLLoader.processDelete(XMLLoader.java:366)
	at org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:292)
	at org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:188)
	at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)
	at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)
	... 33 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16263774" author="mkhludnev" created="Thu, 23 Nov 2017 04:03:22 +0000"  >&lt;p&gt;Add &lt;tt&gt;score=none&lt;/tt&gt; to the local params&lt;/p&gt;</comment>
                            <comment id="16263984" author="ahankinson" created="Thu, 23 Nov 2017 08:39:45 +0000"  >&lt;p&gt;OK, thank you &amp;#8211; I will try that. &lt;/p&gt;

&lt;p&gt;It seems the issue with the locking IndexWriter might still be a problem, though? I wouldn&apos;t expect a query to irretrievably lock the index for modifications.&lt;/p&gt;</comment>
                            <comment id="16264038" author="mkhludnev" created="Thu, 23 Nov 2017 09:16:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahankinson&quot; class=&quot;user-hover&quot; rel=&quot;ahankinson&quot;&gt;ahankinson&lt;/a&gt; I wouldn&apos;t call it &lt;em&gt;locking IW&lt;/em&gt;. It usually means something more severe. That ill deleteQuery hangs in IW and applied at least on commit or flush and perhaps more often. So, &lt;em&gt;turning it off and on again&lt;/em&gt; should wipe the ill query away. &lt;/p&gt;</comment>
                            <comment id="16264059" author="ahankinson" created="Thu, 23 Nov 2017 09:38:40 +0000"  >&lt;p&gt;I certainly tried turning it off and on again, but it didn&apos;t seem to work on both systems that I tried. I would be interested to know if you (or anyone else) has a different experience.&lt;/p&gt;</comment>
                            <comment id="16264066" author="mkhludnev" created="Thu, 23 Nov 2017 09:44:30 +0000"  >&lt;p&gt;aghh.. could this DQ survive in transaction  log?&lt;/p&gt;</comment>
                            <comment id="16264072" author="ahankinson" created="Thu, 23 Nov 2017 09:49:22 +0000"  >&lt;p&gt;Looking at it, I think it does. It looks like it crashes, then on restart replays the transaction log with the failed DQ, which then re-locks the index. I can&apos;t find the exact log message at the moment, though.&lt;/p&gt;</comment>
                            <comment id="16264084" author="mkhludnev" created="Thu, 23 Nov 2017 09:58:39 +0000"  >&lt;p&gt;so, you know what to nuke then. assuming tx-log&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12920560">SOLR-8397</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12492692">SOLR-2272</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13083824">SOLR-10986</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12726408">SOLR-6234</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12747820" name="SOLR-6357.patch" size="939" author="thelabdude" created="Wed, 29 Jul 2015 17:41:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411073</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yq0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411065</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>