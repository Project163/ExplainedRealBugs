<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:37:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13386] Remove race in OverseerTaskQueue#remove that can result in the Overseer causing a Zookeeper call spin spike.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13386</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;If the data call hits NoNodeException, it will throw and the Overseer work queue processor will catch it and loop and repeat, which causes major zk getData / NoNode call traffic or other such things.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13227091">SOLR-13386</key>
            <summary>Remove race in OverseerTaskQueue#remove that can result in the Overseer causing a Zookeeper call spin spike.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Apr 2019 03:17:09 +0000</created>
                <updated>Sat, 8 Jun 2019 15:03:43 +0000</updated>
                            <resolved>Mon, 15 Apr 2019 18:24:00 +0000</resolved>
                                                    <fixVersion>7.7.2</fixVersion>
                    <fixVersion>8.1</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16814018" author="markrmiller@gmail.com" created="Wed, 10 Apr 2019 03:49:21 +0000"  >&lt;p&gt;We just need to catch the NoNodeException setData can throw and treat it the same as exists returning false (NOOP). I&apos;ve been reviewing for any similar case to fix, but have not spotted anything yet.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /**
   * Remove the event and save the response into the other path.
   */
  public void remove(QueueEvent event) throws KeeperException,
      InterruptedException {
    Timer.Context time = stats.time(dir + &quot;_remove_event&quot;);
    try {
      String path = event.getId();
      String responsePath = dir + &quot;/&quot; + RESPONSE_PREFIX
          + path.substring(path.lastIndexOf(&quot;-&quot;) + 1);
      if (zookeeper.exists(responsePath, true)) {
        zookeeper.setData(responsePath, event.getBytes(), true);
      } else {
        log.info(&quot;Response ZK path: &quot; + responsePath + &quot; doesn&apos;t exist.&quot;
            + &quot;  Requestor may have disconnected from ZooKeeper&quot;);
      }
      try {
        zookeeper.delete(path, -1, true);
      } catch (KeeperException.NoNodeException ignored) {
      }
    } finally {
      time.stop();
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16814624" author="mdrob" created="Wed, 10 Apr 2019 16:36:21 +0000"  >&lt;p&gt;I see similar pattern in &lt;tt&gt;ClusterProperties&lt;/tt&gt; and &lt;tt&gt;CollectionProperties&lt;/tt&gt; where we catch &lt;tt&gt;KeeperException.NodeExistsException&lt;/tt&gt; but that probably needs to be &lt;tt&gt;NoNodeException&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16814630" author="tomasflobbe" created="Wed, 10 Apr 2019 16:40:47 +0000"  >&lt;p&gt;Good catch&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;and treat it the same as exists returning false&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Maybe we can just skip the &quot;exists&quot; call? The NoNodeException should not be the normal case. I mean, something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    zookeeper.setData(responsePath, event.getBytes(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (NoNodeException e) {
  log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Response path doesn&apos;t exist...&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16818095" author="markrmiller@gmail.com" created="Mon, 15 Apr 2019 15:57:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe we can just skip the &quot;exists&quot; call? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, good point, being optimistic here is nicer.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I see similar pattern in ClusterProperties and CollectionProperties where we catch KeeperException.NodeExistsException but that probably needs to be NoNodeException?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="16818172" author="markrmiller@gmail.com" created="Mon, 15 Apr 2019 16:55:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ll take a look.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m hesitant to change these as part of this fix. It&apos;s a similiar pattern, but also a bit different and maybe not so straightforward to do more optimistically. It also doesn&apos;t continue on any KeeperException, so you should not hit a bad spin case like in the Overseer.&lt;/p&gt;</comment>
                            <comment id="16818178" author="markrmiller@gmail.com" created="Mon, 15 Apr 2019 16:59:55 +0000"  >&lt;p&gt;Here is patch that handles NoNodeException and also prevents the Overseer work loop from free spinning when it hits an KeeperException.&lt;/p&gt;</comment>
                            <comment id="16818191" author="mdrob" created="Mon, 15 Apr 2019 17:15:33 +0000"  >&lt;p&gt;I imagine this is basically impossible to write a unit test for?&lt;/p&gt;

&lt;p&gt;Might be helpful to add a comment about how we are being optimistic and what our assumptions are for that method.&lt;/p&gt;


&lt;p&gt;LGTM otherwise.&lt;/p&gt;</comment>
                            <comment id="16818195" author="markrmiller@gmail.com" created="Mon, 15 Apr 2019 17:19:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;I imagine this is basically impossible to write a unit test for?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The only way I&apos;ve seen it spin is some very strange case and I think it requires more than one Overseer to overlap and it was a slightly different version of similiar code.&lt;/p&gt;

&lt;p&gt;Trying to catch some case of it and then assert ZK was not hit too often is a tough ask I think. We have to dig for a very uncommon case of that loop that we may or may not be able to tingle and then everything still works so we just have to see how many calls to ZK where made and decide if it was too much. So yeah, I&apos;m not sure we can add a lot of value with a test myself.&lt;/p&gt;</comment>
                            <comment id="16818202" author="anshumg" created="Mon, 15 Apr 2019 17:32:51 +0000"  >&lt;p&gt;Nice catch! LGTM.&lt;/p&gt;</comment>
                            <comment id="16818252" author="jira-bot" created="Mon, 15 Apr 2019 18:23:01 +0000"  >&lt;p&gt;Commit fe37e18d1064cc1460be67bd1ea891ad1d0d362e in lucene-solr&apos;s branch refs/heads/branch_8x from Mark Robert Miller&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=fe37e18&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=fe37e18&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13386&quot; title=&quot;Remove race in OverseerTaskQueue#remove that can result in the Overseer causing a Zookeeper call spin spike.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13386&quot;&gt;&lt;del&gt;SOLR-13386&lt;/del&gt;&lt;/a&gt;: OverseerTaskQueue#remove should not throw an exception when no node exists after an exists check and the Overseer work loop should not allow free spinning the loop when it hits a KeeperException.&lt;/p&gt;</comment>
                            <comment id="16818255" author="jira-bot" created="Mon, 15 Apr 2019 18:23:38 +0000"  >&lt;p&gt;Commit ecbf7daf5674a3bd754781b1b2a0fcb1777dba06 in lucene-solr&apos;s branch refs/heads/master from Mark Robert Miller&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ecbf7da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=ecbf7da&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13386&quot; title=&quot;Remove race in OverseerTaskQueue#remove that can result in the Overseer causing a Zookeeper call spin spike.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13386&quot;&gt;&lt;del&gt;SOLR-13386&lt;/del&gt;&lt;/a&gt;: OverseerTaskQueue#remove should not throw an exception when no node exists after an exists check and the Overseer work loop should not allow free spinning the loop when it hits a KeeperException.&lt;/p&gt;</comment>
                            <comment id="16841531" author="jira-bot" created="Thu, 16 May 2019 16:48:42 +0000"  >&lt;p&gt;Commit 1ebc103a8231ba5143f0b5fa487ff4ebd316ac1b in lucene-solr&apos;s branch refs/heads/branch_7_7 from Mark Robert Miller&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=1ebc103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=1ebc103&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13386&quot; title=&quot;Remove race in OverseerTaskQueue#remove that can result in the Overseer causing a Zookeeper call spin spike.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13386&quot;&gt;&lt;del&gt;SOLR-13386&lt;/del&gt;&lt;/a&gt;: OverseerTaskQueue#remove should not throw an exception when no node exists after an exists check and the Overseer work loop should not allow free spinning the loop when it hits a KeeperException.&lt;/p&gt;

&lt;p&gt;(Cherry picked from fe37e18d1064cc1460be67bd1ea891ad1d0d362e)&lt;/p&gt;</comment>
                            <comment id="16857078" author="janhoy" created="Wed, 5 Jun 2019 21:30:55 +0000"  >&lt;p&gt;Closing after the 7.7.2 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12965961" name="SOLR-13386.patch" size="2432" author="markrmiller@gmail.com" created="Mon, 15 Apr 2019 16:58:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01mh4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>