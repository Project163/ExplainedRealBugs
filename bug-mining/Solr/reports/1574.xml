<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:40:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5330] PerSegmentSingleValuedFaceting overwrites facet values</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5330</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I recently tried enabling facet.method=fcs for one of my indexes and found a significant performance improvement (with a large index, many facet values, and near-realtime updates). Unfortunately, the results were also wrong. Specifically, some facet values were being partially overwritten by other facet values. (That is, if I expected facet values like &quot;abcdef&quot; and &quot;123&quot;, I would get a value like &quot;123def&quot;.)&lt;/p&gt;

&lt;p&gt;Debugging through the code, it looks like the problem was in PerSegmentSingleValuedFaceting, specifically in the getFacetCounts method, when BytesRef val is shallow-copied from the temporary per-segment BytesRef. The byte array assigned to val is shared with the byte array for seg.tempBR, and is overwritten a few lines down by the call to seg.tenum.next().&lt;/p&gt;

&lt;p&gt;I managed to fix it locally by replacing the shallow copy with a deep copy.&lt;/p&gt;

&lt;p&gt;While I encountered this problem on Solr 4.2.1, I see that the code is identical in 4.5. Unless the behavior of TermsEnum.next() has changed, I believe this bug still exists.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12673187">SOLR-5330</key>
            <summary>PerSegmentSingleValuedFaceting overwrites facet values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="msfroh">Michael Froh</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Oct 2013 07:25:00 +0000</created>
                <updated>Mon, 9 May 2016 18:43:29 +0000</updated>
                            <resolved>Wed, 16 Oct 2013 20:55:42 +0000</resolved>
                                    <version>4.2.1</version>
                                    <fixVersion>4.5.1</fixVersion>
                    <fixVersion>4.6</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13791394" author="erickerickson" created="Thu, 10 Oct 2013 11:07:53 +0000"  >&lt;p&gt;Michael:&lt;/p&gt;

&lt;p&gt;Thanks for the detailed explanation! Could I trouble you to go ahead and attach a patch? Don&apos;t worry about &quot;polish&quot;, having your code change as a place to at least start (if not use entire) makes things easier for whoever picks this up...&lt;/p&gt;</comment>
                            <comment id="13791580" author="msfroh" created="Thu, 10 Oct 2013 15:17:59 +0000"  >&lt;p&gt;Patch attached&lt;/p&gt;</comment>
                            <comment id="13791612" author="yseeley@gmail.com" created="Thu, 10 Oct 2013 16:02:17 +0000"  >&lt;p&gt;Yikes, looks like this bug has been around a while.  I&apos;ll take it.&lt;/p&gt;</comment>
                            <comment id="13791896" author="yseeley@gmail.com" created="Thu, 10 Oct 2013 19:30:44 +0000"  >&lt;p&gt;It&apos;s unfortunate that even the random faceting testing didn&apos;t catch this... I&apos;m trying to fix that now.&lt;/p&gt;</comment>
                            <comment id="13793213" author="yseeley@gmail.com" created="Sat, 12 Oct 2013 02:28:28 +0000"  >&lt;p&gt;So I instrumented the faceting code like so:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;          seg.tempBR = seg.tenum.next();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (seg.tempBR.bytes == val.bytes) {
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;##########SHARING DETECTED: val.offset=&quot;&lt;/span&gt;+val.offset + &lt;span class=&quot;code-quote&quot;&gt;&quot; val.length=&quot;&lt;/span&gt;+val.length + &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.offset=&quot;&lt;/span&gt;+seg.tempBR.offset + &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.length=&quot;&lt;/span&gt;+seg.tempBR.length);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (val.offset == seg.tempBR.offset) {
  &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;!!!!!!SHARING USING SAME OFFSET&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And it detects tons of sharing (the returned bytesref still pointing to the same byte[]) of course... but the thing is, it never generates an invalid result.  calling next() on the term enum never changes the bytes that were previously pointed to... it simply points to a different part of the same byte array.  I can never detect a case where the original bytes are changed, thus invalidating the shallow copy.&lt;/p&gt;

&lt;p&gt;Example output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;##########SHARING DETECTED: val.offset=1 val.length=4 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.offset=6 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;.length=4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13797235" author="jira-bot" created="Wed, 16 Oct 2013 20:45:49 +0000"  >&lt;p&gt;Commit 1532900 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1532900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1532900&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5330&quot; title=&quot;PerSegmentSingleValuedFaceting overwrites facet values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5330&quot;&gt;&lt;del&gt;SOLR-5330&lt;/del&gt;&lt;/a&gt;: make copy of term bytes before calling next&lt;/p&gt;</comment>
                            <comment id="13797237" author="jira-bot" created="Wed, 16 Oct 2013 20:49:00 +0000"  >&lt;p&gt;Commit 1532903 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1532903&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1532903&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5330&quot; title=&quot;PerSegmentSingleValuedFaceting overwrites facet values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5330&quot;&gt;&lt;del&gt;SOLR-5330&lt;/del&gt;&lt;/a&gt;: make copy of term bytes before calling next&lt;/p&gt;</comment>
                            <comment id="13797240" author="jira-bot" created="Wed, 16 Oct 2013 20:51:41 +0000"  >&lt;p&gt;Commit 1532905 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/lucene_solr_4_5&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1532905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1532905&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5330&quot; title=&quot;PerSegmentSingleValuedFaceting overwrites facet values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5330&quot;&gt;&lt;del&gt;SOLR-5330&lt;/del&gt;&lt;/a&gt;: make copy of term bytes before calling next&lt;/p&gt;</comment>
                            <comment id="13797244" author="yseeley@gmail.com" created="Wed, 16 Oct 2013 20:55:21 +0000"  >&lt;p&gt;I never was able to reproduce... so I just fixed the issue anyway, making a copy of the bytes only instead of cloning the complete BytesRef.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12607822" name="solr-5330.patch" size="916" author="msfroh" created="Thu, 10 Oct 2013 15:17:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352810</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ottb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353097</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>