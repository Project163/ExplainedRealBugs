<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:35:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12969] Inconsistency with leader when PeerSync return ALREADY_IN_SYNC</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12969</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Under certain circumstances, replication fails between a leader and follower.&#160; The follower will not receive updates from the leader, even though the leader has a newer version.&#160; If the leader is restarted, it will get the older version from the follower.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This was discussed on the&#160;&lt;a href=&quot;https://mail-archives.apache.org/mod_mbox/lucene-solr-user/201810.mbox/%3CBYAPR04MB4406710795EA07E93BF80913ADCD0%40BYAPR04MB4406.namprd04.prod.outlook.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;mailing list&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=risdenk&quot; class=&quot;user-hover&quot; rel=&quot;risdenk&quot;&gt;risdenk&lt;/a&gt;&#160;&lt;a href=&quot;https://github.com/risdenk/test-solr-start-stop-replica-consistency&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;wrote a script&lt;/a&gt;&#160;that demonstrates this error.&#160; He also verified that the error occurs when the script is run outside of docker.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is the scenario of the failure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A collection with 1 shards and 2 replicas&lt;/li&gt;
	&lt;li&gt;Stop non-leader replica (B)&lt;/li&gt;
	&lt;li&gt;Index more than 100 documents to the collection&lt;/li&gt;
	&lt;li&gt;Start replica B, it failed to do PeerSync and&#160;starts segments replication&lt;/li&gt;
	&lt;li&gt;Index document 101th to the collection
	&lt;ul&gt;
		&lt;li&gt;Leader&apos;s tlog: &lt;span class=&quot;error&quot;&gt;&amp;#91;1, 2, 3, ..., 100, 101&amp;#93;&lt;/span&gt;&lt;/li&gt;
		&lt;li&gt;Replica&apos;s tlog: &lt;span class=&quot;error&quot;&gt;&amp;#91;101&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Stop replica B&lt;/li&gt;
	&lt;li&gt;Index document 102th to the collection&lt;/li&gt;
	&lt;li&gt;Start replica B, on doing PeerSync
	&lt;ul&gt;
		&lt;li&gt;Leader&apos;s tlog: &lt;span class=&quot;error&quot;&gt;&amp;#91;1, 2, 3, ..., 100, 101, 102&amp;#93;&lt;/span&gt;&lt;/li&gt;
		&lt;li&gt;Replica&apos;s tlog: &lt;span class=&quot;error&quot;&gt;&amp;#91;101&amp;#93;&lt;/span&gt;&lt;/li&gt;
		&lt;li&gt;Leader&apos;s high (80th): 80&lt;/li&gt;
		&lt;li&gt;Replica&apos;s low: 101&lt;/li&gt;
		&lt;li&gt;By comparison: replica&apos;s low &amp;gt; leader&apos;s high =&amp;gt; ALREADY_IN_SYNC&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13196673">SOLR-12969</key>
            <summary>Inconsistency with leader when PeerSync return ALREADY_IN_SYNC</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="caomanhdat">Cao Manh Dat</assignee>
                                    <reporter username="Jeremy Smith">Jeremy Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Nov 2018 20:14:54 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:44 +0000</updated>
                            <resolved>Sun, 16 Dec 2018 17:02:47 +0000</resolved>
                                    <version>6.6.5</version>
                    <version>7.5</version>
                                    <fixVersion>8.0</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16677277" author="risdenk" created="Tue, 6 Nov 2018 20:31:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt; - Do you have any ideas here? I think you did work on replication.&lt;/p&gt;</comment>
                            <comment id="16679971" author="caomanhdat" created="Thu, 8 Nov 2018 16:23:16 +0000"  >&lt;p&gt;I confirm that this problem happens on different versions of Solr (maybe from the start since this is problem of PeerSync logic).&#160;&lt;/p&gt;

&lt;p&gt;Attached patch here that fix the problem, but I really don&apos;t like the way we current do PeerSync. I may think about this for couple of days before committing the patch.&lt;/p&gt;

&lt;p&gt;P/S: The scenario when this failure happen is tricky and this bug appear with the appearance of SolrCloud so we don&apos;t have to rush about it.&lt;/p&gt;</comment>
                            <comment id="16683323" author="caomanhdat" created="Mon, 12 Nov 2018 07:17:18 +0000"  >&lt;p&gt;There are actually 2 problems that I think we should fix here:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Since PeerSyncWithLeader is the case replica sync with its leader, the result should not be ALREADY_IN_SYNC in case of fingerprint comparison failed.&lt;/li&gt;
	&lt;li&gt;PeerSync check for already_in_sync should be more robust &quot;&lt;tt&gt;ourLowThreshold &amp;gt; otherHigh &amp;amp;&amp;amp; ourHighest &amp;gt;= otherHighest&lt;/tt&gt;&quot; insteads of &quot;&lt;tt&gt;ourLowThreshold &amp;gt; otherHigh&lt;/tt&gt;&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Attached a patch for fixing this problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16683475" author="caomanhdat" created="Mon, 12 Nov 2018 09:47:15 +0000"  >&lt;p&gt;Actually, I have another idea for not relying on tlog for PeerSync. This idea requires 2 changes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Versions should be monotonic increased (instead of relying on clock time).&lt;/li&gt;
	&lt;li&gt;Each commit point will contains the compressed format of all the updates versions had been applied. I.E: 1..100,103..1000.&lt;/li&gt;
	&lt;li&gt;Therefore based on above changes, we can quickly compare version that we missed without caring about compute fingerprint or relying on tlog.&lt;/li&gt;
	&lt;li&gt;We still need to think about cases with FORCELEADER or similar cases, i.e: different updates have same update version.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But this approach requires a lot of changes and I&apos;m not sure it is worth or not. What we gain here by going with above approach is&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Faster and more reliable PeerSync process.&lt;/li&gt;
	&lt;li&gt;We don&apos;t have to compute fingerprint any more.&lt;br/&gt;
May be one or two more cases will convince me on switching to above approach. Any thoughts? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16683505" author="jira-bot" created="Mon, 12 Nov 2018 10:10:33 +0000"  >&lt;p&gt;Commit f357c06276139defa26d0569fe5903cfd3d66cdb in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f357c06&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f357c06&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12969&quot; title=&quot;Inconsistency with leader when PeerSync return ALREADY_IN_SYNC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12969&quot;&gt;&lt;del&gt;SOLR-12969&lt;/del&gt;&lt;/a&gt;: Inconsistency with leader when PeerSync return ALREADY_IN_SYNC&lt;/p&gt;</comment>
                            <comment id="16683659" author="jira-bot" created="Mon, 12 Nov 2018 11:55:24 +0000"  >&lt;p&gt;Commit f357c06276139defa26d0569fe5903cfd3d66cdb in lucene-solr&apos;s branch refs/heads/jira/http2 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f357c06&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f357c06&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12969&quot; title=&quot;Inconsistency with leader when PeerSync return ALREADY_IN_SYNC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12969&quot;&gt;&lt;del&gt;SOLR-12969&lt;/del&gt;&lt;/a&gt;: Inconsistency with leader when PeerSync return ALREADY_IN_SYNC&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12947787" name="SOLR-12969.patch" size="26669" author="caomanhdat" created="Mon, 12 Nov 2018 07:19:04 +0000"/>
                            <attachment id="12947747" name="SOLR-12969.patch" size="25902" author="caomanhdat" created="Sun, 11 Nov 2018 15:49:07 +0000"/>
                            <attachment id="12947431" name="SOLR-12969.patch" size="20605" author="caomanhdat" created="Thu, 8 Nov 2018 16:19:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s0075s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>