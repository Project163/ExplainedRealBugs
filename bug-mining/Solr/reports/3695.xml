<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:29:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11484] CloudSolrClient&apos;s cache of collection clusterstate can cause RouteExceptions when attempting directUpdates after collection modifications</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11484</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;This was discovered while auditing jenkins failures from &lt;br/&gt;
&lt;tt&gt;TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete&lt;/tt&gt; (where a test explicitly deletes and then recreates a collection with the same name), but as noted in a comment below, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11392&quot; title=&quot;StreamExpressionTest.testParallelExecutorStream fails too frequently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11392&quot;&gt;SOLR-11392&lt;/a&gt; is another example of non-obvious test failures that can pop up because of this bug.&lt;/p&gt;

&lt;p&gt;In practice, it can affect any CloudSolrClient user after changes have been made to a collection (to add/move replicas, etc...)&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Original jira notes...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete&lt;/tt&gt;&lt;br/&gt;
seems to fail with non-trivial frequency, so I grabbed the logs from a recent failure and starting trying to follow along with the actions to figure out what exactly is happening....&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/20662/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/20662/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4] ERROR   20.3s J1 | TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: org.apache.solr.client.solrj.impl.CloudSolrClient$RouteException: Error from server at https://127.0.0.1:42959/solr/testcollection_shard1_replica_n3: Expected mime type a
pplication/octet-stream but got text/html. &amp;lt;html&amp;gt;
   [junit4]    &amp;gt; &amp;lt;head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=ISO-8859-1&quot;/&amp;gt;
   [junit4]    &amp;gt; &amp;lt;title&amp;gt;Error 404 &amp;lt;/title&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The crux of this failure appears to be a genuine bug in how CloudSolrClient uses it&apos;s cached ClusterState info when doing (direct) updates.  The key bits seem to be:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;CloudSolrClient does &lt;em&gt;something&lt;/em&gt; (update,query,etc...) with a collection causing the current cluster state for the collection to be cached&lt;/li&gt;
	&lt;li&gt;The actual collection changes such that a Solr node/core no longer exists as part of the collection&lt;/li&gt;
	&lt;li&gt;CloudSolrClient is asked to process an UpdateRequest which triggers the code paths for the &lt;tt&gt;directUpdate()&lt;/tt&gt; method &amp;#8211; which attempts to route the updates directly to a replica of the appropriate shard using the (cache) collection state info&lt;/li&gt;
	&lt;li&gt;CloudSolrClient (may) attempt to send that UpdateRequest to a node/core that doesn&apos;t exist, getting a 404 &amp;#8211; which does not (seem to) trigger a state refresh, or retry to find a correct URL to resend the update to.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Details to follow in comment....&lt;/p&gt;</description>
                <environment></environment>
        <key id="13109096">SOLR-11484</key>
            <summary>CloudSolrClient&apos;s cache of collection clusterstate can cause RouteExceptions when attempting directUpdates after collection modifications</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Oct 2017 00:19:34 +0000</created>
                <updated>Thu, 21 Nov 2019 00:41:40 +0000</updated>
                            <resolved>Sat, 28 Oct 2017 01:38:19 +0000</resolved>
                                                    <fixVersion>7.2</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="16202862" author="hossman" created="Fri, 13 Oct 2017 00:22:17 +0000"  >&lt;p&gt;I&apos;ve attached the log from &lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/20662/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/20662/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A quick walk through of some of the key bits of logging from testCollectionCreateSearchDelete ...&lt;/p&gt;


&lt;p&gt;Test Creates a 2x2 collection, resulting in 4 SolrCores...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   
   [junit4]   2&amp;gt; 334246 INFO  (parallelCoreAdminExecutor-1592-thread-1-processing-n:127.0.0.1:42959_solr aecb57e9-be15-41b4-892b-269c3ef4df623724636310642455 CREATE) [n:127.0.0.1:42959_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;async=aecb57e9-be15-41b4-892b-269c3ef4df623724636310642455&amp;amp;coreNodeName=core_node4&amp;amp;name=testcollection_shard1_replica_n3&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard1&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
   [junit4]   2&amp;gt; 334261 INFO  (parallelCoreAdminExecutor-1581-thread-1-processing-n:127.0.0.1:34827_solr aecb57e9-be15-41b4-892b-269c3ef4df623724636321671098 CREATE) [n:127.0.0.1:34827_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;async=aecb57e9-be15-41b4-892b-269c3ef4df623724636321671098&amp;amp;coreNodeName=core_node8&amp;amp;name=testcollection_shard2_replica_n6&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard2&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
   [junit4]   2&amp;gt; 334272 INFO  (parallelCoreAdminExecutor-1579-thread-1-processing-n:127.0.0.1:38927_solr aecb57e9-be15-41b4-892b-269c3ef4df623724636317202530 CREATE) [n:127.0.0.1:38927_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;async=aecb57e9-be15-41b4-892b-269c3ef4df623724636317202530&amp;amp;coreNodeName=core_node7&amp;amp;name=testcollection_shard2_replica_n5&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard2&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
   [junit4]   2&amp;gt; 334272 INFO  (parallelCoreAdminExecutor-1577-thread-1-processing-n:127.0.0.1:36233_solr aecb57e9-be15-41b4-892b-269c3ef4df623724636304239736 CREATE) [n:127.0.0.1:36233_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;async=aecb57e9-be15-41b4-892b-269c3ef4df623724636304239736&amp;amp;coreNodeName=core_node2&amp;amp;name=testcollection_shard1_replica_n1&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard1&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that these initial Cores are:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;testcollection_shard1_replica_n3&lt;/li&gt;
	&lt;li&gt;testcollection_shard2_replica_n6&lt;/li&gt;
	&lt;li&gt;testcollection_shard2_replica_n5&lt;/li&gt;
	&lt;li&gt;testcollection_shard1_replica_n1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...the test then does some searching of this collection, and a few other things, before ultimately deleting this collection, and verifies the delete worked correctly...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   ....
   [junit4]   2&amp;gt; 340530 INFO  (TEST-TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete-seed#[DC2FFDE51D1E4138]) [    ] o.a.s.c.AbstractDistribZkTestBase Wait for collection to disappear - collection: testcollection failOnTimeout:true timeout (sec):330
   [junit4]   1&amp;gt; -
   [junit4]   2&amp;gt; 340530 INFO  (TEST-TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete-seed#[DC2FFDE51D1E4138]) [    ] o.a.s.c.AbstractDistribZkTestBase Collection has disappeared - collection: testcollection
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...at which point it recreates the collection, and we get 4 completely new SolrCores...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 340531 INFO  (qtp6784903-4183) [n:127.0.0.1:38927_solr    ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :create with params replicationFactor=2&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;maxShardsPerNode=1&amp;amp;name=testcollection&amp;amp;nrtReplicas=2&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin&amp;amp;version=2 and sendToOCPQueue=true
   [junit4]   2&amp;gt; 340533 INFO  (OverseerThreadFactory-1587-thread-3-processing-n:127.0.0.1:34827_solr) [n:127.0.0.1:34827_solr    ] o.a.s.c.CreateCollectionCmd Create collection testcollection
   ....
   [junit4]   2&amp;gt; 340948 INFO  (qtp13197426-4184) [n:127.0.0.1:36233_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;coreNodeName=core_node8&amp;amp;name=testcollection_shard2_replica_n6&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard2&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
   [junit4]   2&amp;gt; 340948 INFO  (qtp13767699-4323) [n:127.0.0.1:42959_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;coreNodeName=core_node5&amp;amp;name=testcollection_shard1_replica_n2&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard1&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
   [junit4]   2&amp;gt; 340949 INFO  (qtp18576982-4232) [n:127.0.0.1:34827_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;coreNodeName=core_node3&amp;amp;name=testcollection_shard1_replica_n1&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard1&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
   [junit4]   2&amp;gt; 341020 INFO  (qtp1638616-4379) [n:127.0.0.1:40813_solr    ] o.a.s.h.a.CoreAdminOperation core create command qt=/admin/cores&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;newCollection=true&amp;amp;collection=testcollection&amp;amp;version=2&amp;amp;replicaType=NRT&amp;amp;coreNodeName=core_node7&amp;amp;name=testcollection_shard2_replica_n4&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;shard=shard2&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note the new SolrCore names/paths...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;testcollection_shard1_replica_n1&lt;/li&gt;
	&lt;li&gt;testcollection_shard1_replica_n2&lt;/li&gt;
	&lt;li&gt;testcollection_shard2_replica_n4&lt;/li&gt;
	&lt;li&gt;testcollection_shard2_replica_n6&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...note in particular that there is &lt;b&gt;NOT&lt;/b&gt; a &quot;testcollection_shard1_replica_n3&quot; core in the &quot;new&quot; instance of this collection ... that was only the &lt;b&gt;prior&lt;/b&gt; (instance) of this collection.&lt;/p&gt;

&lt;p&gt;Collection creation finishes...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 344142 INFO  (qtp6784903-4183) [n:127.0.0.1:38927_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={replicationFactor=2&amp;amp;collection.configName=solrCloudCollectionConfig&amp;amp;maxShardsPerNode=1&amp;amp;name=testcollection&amp;amp;nrtReplicas=2&amp;amp;action=CREATE&amp;amp;numShards=2&amp;amp;property.solr.directoryFactory=solr.StandardDirectoryFactory&amp;amp;wt=javabin&amp;amp;version=2} status=0 QTime=3610
   [junit4]   2&amp;gt; 344143 INFO  (TEST-TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete-seed#[DC2FFDE51D1E4138]) [    ] o.a.s.c.AbstractDistribZkTestBase Wait for recoveries to finish - collection: testcollection failOnTimeout:true timeout (sec):330
   ...
   [junit4]   2&amp;gt; 344144 INFO  (TEST-TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete-seed#[DC2FFDE51D1E4138]) [    ] o.a.s.c.AbstractDistribZkTestBase Recoveries finished - collection: testcollection
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...now the test does a &quot;&lt;b&gt;:&lt;/b&gt;&quot; query over the colleciton &amp;#8211; to ensure no docs found...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 344168 INFO  (qtp13767699-4319) [n:127.0.0.1:42959_solr c:testcollection s:shard1 r:core_node5 x:testcollection_shard1_replica_n2] o.a.s.c.S.Request [testcollection_shard1_replica_n2]  webapp=/solr path=/select params={df=text&amp;amp;distrib=false&amp;amp;_stateVer_=testcollection:7&amp;amp;fl=id&amp;amp;fl=score&amp;amp;shards.purpose=4&amp;amp;start=0&amp;amp;fsv=true&amp;amp;shard.url=https://127.0.0.1:42959/solr/testcollection_shard1_replica_n2/|https://127.0.0.1:34827/solr/testcollection_shard1_replica_n1/&amp;amp;rows=10&amp;amp;version=2&amp;amp;q=*:*&amp;amp;NOW=1507805797249&amp;amp;isShard=true&amp;amp;wt=javabin} hits=0 status=0 QTime=0
   [junit4]   2&amp;gt; 344168 INFO  (qtp1638616-4384) [n:127.0.0.1:40813_solr c:testcollection s:shard2 r:core_node7 x:testcollection_shard2_replica_n4] o.a.s.c.S.Request [testcollection_shard2_replica_n4]  webapp=/solr path=/select params={df=text&amp;amp;distrib=false&amp;amp;_stateVer_=testcollection:7&amp;amp;fl=id&amp;amp;fl=score&amp;amp;shards.purpose=4&amp;amp;start=0&amp;amp;fsv=true&amp;amp;shard.url=https://127.0.0.1:40813/solr/testcollection_shard2_replica_n4/|https://127.0.0.1:36233/solr/testcollection_shard2_replica_n6/&amp;amp;rows=10&amp;amp;version=2&amp;amp;q=*:*&amp;amp;NOW=1507805797249&amp;amp;isShard=true&amp;amp;wt=javabin} hits=0 status=0 QTime=0
   [junit4]   2&amp;gt; 344169 INFO  (qtp18576982-4231) [n:127.0.0.1:34827_solr c:testcollection s:shard1 r:core_node3 x:testcollection_shard1_replica_n1] o.a.s.c.S.Request [testcollection_shard1_replica_n1]  webapp=/solr path=/select params={q=*:*&amp;amp;_stateVer_=testcollection:7&amp;amp;wt=javabin&amp;amp;version=2} hits=0 status=0 QTime=2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...that request was directed to &quot;testcollection_shard1_replica_n1&quot; (a core name that just so happened to exist in both instances of the &quot;testcollection&quot;) and that works and we get the correct response of numFound=0.&lt;/p&gt;

&lt;p&gt;But the next line in the test/lots is an attempt to add a document &amp;#8211; and this is what fails...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 344173 ERROR (TEST-TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete-seed#[DC2FFDE51D1E4138]) [    ] o.a.s.c.s.i.CloudSolrClient Request to collection testcollection failed due to (404) org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at https://127.0.0.1:42959/solr/testcollection_shard1_replica_n3: Expected mime type application/octet-stream but got text/html. &amp;lt;html&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;head&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=ISO-8859-1&quot;/&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;title&amp;gt;Error 404 &amp;lt;/title&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;/head&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;body&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;h2&amp;gt;HTTP ERROR: 404&amp;lt;/h2&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;p&amp;gt;Problem accessing /solr/testcollection_shard1_replica_n3/update. Reason:
   [junit4]   2&amp;gt; &amp;lt;pre&amp;gt;    Can not find: /solr/testcollection_shard1_replica_n3/update&amp;lt;/pre&amp;gt;&amp;lt;/p&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;hr /&amp;gt;&amp;lt;a href=&quot;http://eclipse.org/jetty&quot;&amp;gt;Powered by Jetty:// 9.3.20.v20170531&amp;lt;/a&amp;gt;&amp;lt;hr/&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;/body&amp;gt;
   [junit4]   2&amp;gt; &amp;lt;/html&amp;gt;
   [junit4]   2&amp;gt; , retry? 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;...the key problem being that &lt;tt&gt;CloudSolrClient.directUpdate&lt;/tt&gt; is using (stale) ClusterState info about the collection to try and route that update directly to &quot;testcollection_shard1_replica_n3&quot; which doesn&apos;t exist in the collection &amp;#8211; it hasn&apos;t existed since the &lt;b&gt;last&lt;/b&gt; time this collection existed.&lt;/p&gt;

&lt;p&gt;And once this 404 is returned, CloudSolrClient does not (or can not? not sure what the rules are for Updates) make any attempt to retry this update.&lt;/p&gt;

&lt;p&gt;The stale collection info and the resulting 404 are ultimately what fails the test...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4] ERROR   20.3s J1 | TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: org.apache.solr.client.solrj.impl.CloudSolrClient$RouteException: Error from server at https://127.0.0.1:42959/solr/testcollection_shard1_replica_n3: Expected mime type a
pplication/octet-stream but got text/html. &amp;lt;html&amp;gt;
   [junit4]    &amp;gt; &amp;lt;head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=ISO-8859-1&quot;/&amp;gt;
   [junit4]    &amp;gt; &amp;lt;title&amp;gt;Error 404 &amp;lt;/title&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;body&amp;gt;
   [junit4]    &amp;gt; &amp;lt;h2&amp;gt;HTTP ERROR: 404&amp;lt;/h2&amp;gt;
   [junit4]    &amp;gt; &amp;lt;p&amp;gt;Problem accessing /solr/testcollection_shard1_replica_n3/update. Reason:
   [junit4]    &amp;gt; &amp;lt;pre&amp;gt;    Can not find: /solr/testcollection_shard1_replica_n3/update&amp;lt;/pre&amp;gt;&amp;lt;/p&amp;gt;
   [junit4]    &amp;gt; &amp;lt;hr /&amp;gt;&amp;lt;a href=&quot;http://eclipse.org/jetty&quot;&amp;gt;Powered by Jetty:// 9.3.20.v20170531&amp;lt;/a&amp;gt;&amp;lt;hr/&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/body&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/html&amp;gt;
   [junit4]    &amp;gt;        at __randomizedtesting.SeedInfo.seed([DC2FFDE51D1E4138:7FD553409AF6AB9D]:0)
   [junit4]    &amp;gt;        at org.apache.solr.client.solrj.impl.CloudSolrClient.directUpdate(CloudSolrClient.java:539)
   [junit4]    &amp;gt;        at org.apache.solr.client.solrj.impl.CloudSolrClient.sendRequest(CloudSolrClient.java:993)
   [junit4]    &amp;gt;        at org.apache.solr.client.solrj.impl.CloudSolrClient.requestWithRetryOnStaleState(CloudSolrClient.java:862)
   [junit4]    &amp;gt;        at org.apache.solr.client.solrj.impl.CloudSolrClient.request(CloudSolrClient.java:793)
   [junit4]    &amp;gt;        at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:178)
   [junit4]    &amp;gt;        at org.apache.solr.client.solrj.request.UpdateRequest.commit(UpdateRequest.java:233)
   [junit4]    &amp;gt;        at org.apache.solr.cloud.TestCollectionsAPIViaSolrCloudCluster.testCollectionCreateSearchDelete(TestCollectionsAPIViaSolrCloudCluster.java:167)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;...shouldn&apos;t this type of failure cause the (stale) collection info in CloudSolrClient to be refreshed, and then retry the update?&lt;/p&gt;</comment>
                            <comment id="16202881" author="joel.bernstein" created="Fri, 13 Oct 2017 00:49:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;, this is related I believe to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11392&quot; title=&quot;StreamExpressionTest.testParallelExecutorStream fails too frequently&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11392&quot;&gt;SOLR-11392&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;, discusses the issue in the ticket.&lt;/p&gt;</comment>
                            <comment id="16203289" author="noble.paul" created="Fri, 13 Oct 2017 09:27:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wasCommError =
          (rootCause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ConnectException ||
              rootCause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ConnectTimeoutException ||
              rootCause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; NoHttpResponseException ||
              rootCause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SocketException);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we should add &lt;tt&gt;RouteException&lt;/tt&gt; to this list&lt;/p&gt;</comment>
                            <comment id="16207928" author="hossman" created="Tue, 17 Oct 2017 17:11:23 +0000"  >
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;:  IIUC you&apos;re saying &amp;#8211; at a broader level &amp;#8211; that you think this is a bug in CloudSolrClient, and not a mistake in the affected test(s), correct?&lt;/p&gt;

&lt;p&gt;In that case, I&apos;m attaching a patch with test explicitly targeted at this caching problem in CloudSolrClient that fails reliably (for me) 100% of the time, and i&apos;ll re-word the summary/description to more specificaly describe the underlying problem.&lt;/p&gt;

&lt;p&gt;That said: I don&apos;t really understand all the possible code paths well enough to be confident of your suggested fix:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;is adding &lt;tt&gt;RouteException&lt;/tt&gt; to the &lt;tt&gt;wasCommError&lt;/tt&gt; logic safe?
	&lt;ul&gt;
		&lt;li&gt;it&apos;s not clear to me that every possible reason for a &lt;tt&gt;RouteException&lt;/tt&gt; is actually a &quot;communication error&quot; that should trigger all the affected downstream logic that comes with setting that boolean&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;is setting &lt;tt&gt;wasCommError&lt;/tt&gt; enough to actually fix this bug?
	&lt;ul&gt;
		&lt;li&gt;It doesn&apos;t seem like setting that is sufficient, because I don&apos;t think the &lt;tt&gt;directUpdate()&lt;/tt&gt; code paths will (currently) attempt a retry even if &lt;tt&gt;true==wasCommError&lt;/tt&gt;  ?&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;?&lt;/p&gt;</comment>
                            <comment id="16208006" author="ab" created="Tue, 17 Oct 2017 17:40:59 +0000"  >&lt;p&gt;Effects of this bug may be also combined with effects of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9440&quot; title=&quot;ZkStateReader on a client can cache collection state and never refresh it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9440&quot;&gt;&lt;del&gt;SOLR-9440&lt;/del&gt;&lt;/a&gt;, so fixing the caching at this level may not completely solve the issue.&lt;/p&gt;</comment>
                            <comment id="16216583" author="caomanhdat" created="Tue, 24 Oct 2017 09:12:58 +0000"  >&lt;p&gt;I have an idea for this problem. The node responds a proper error ( like the node cannot find this core or collection, including clusterstate version), therefore cloudclient can know about it stale state and do retry.&lt;/p&gt;</comment>
                            <comment id="16218227" author="noble.paul" created="Wed, 25 Oct 2017 07:50:00 +0000"  >&lt;p&gt;The exceptions are used to invalidate cache and retry. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;, the node is supposed to respond with the new &lt;tt&gt;state.json&lt;/tt&gt; version in every response.&lt;/p&gt;</comment>
                            <comment id="16220377" author="noble.paul" created="Thu, 26 Oct 2017 12:26:05 +0000"  >&lt;p&gt;There were 2 bugs&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;When there is a RouteException, CSC never invalidated it&apos;s state cache&lt;/li&gt;
	&lt;li&gt;When &lt;tt&gt;directUpdatesToLeadersOnly==true&lt;/tt&gt;, it errors out if the &lt;tt&gt;state.json&lt;/tt&gt; doesn&apos;t have a node marked as leader. If there is no leader to be found, it&apos;s safer to just send the request to any &lt;tt&gt;live&lt;/tt&gt; &lt;tt&gt;NRT&lt;/tt&gt; replica instead of throwing an &lt;tt&gt;Exception&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16221714" author="jira-bot" created="Fri, 27 Oct 2017 04:58:36 +0000"  >&lt;p&gt;Commit 0d29f7a1a24c98149485bb96f835fe0d35df8f7f in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0d29f7a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0d29f7a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11484&quot; title=&quot;CloudSolrClient&amp;#39;s cache of collection clusterstate can cause RouteExceptions when attempting directUpdates after collection modifications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11484&quot;&gt;&lt;del&gt;SOLR-11484&lt;/del&gt;&lt;/a&gt;: CloudSolrClient does not invalidate cache or retry for RouteException&lt;/p&gt;</comment>
                            <comment id="16221742" author="jira-bot" created="Fri, 27 Oct 2017 05:46:17 +0000"  >&lt;p&gt;Commit 59109e1b15f0ab8fd4cf980880282bc820315c79 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=59109e1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=59109e1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11484&quot; title=&quot;CloudSolrClient&amp;#39;s cache of collection clusterstate can cause RouteExceptions when attempting directUpdates after collection modifications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11484&quot;&gt;&lt;del&gt;SOLR-11484&lt;/del&gt;&lt;/a&gt;: CloudSolrClient does not invalidate cache or retry for RouteException&lt;/p&gt;</comment>
                            <comment id="16223062" author="steve_rowe" created="Fri, 27 Oct 2017 23:54:37 +0000"  >&lt;p&gt;Reopening to address a 100% reproducing &lt;tt&gt;CloudSolrClient&lt;/tt&gt; NPE that begins at commit 59109e1b1 on this issue, from &lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Linux/685&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Linux/685&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Checking out Revision 14bb48e3268c8e2f4aa509b1a71a9fb3e361b082 (refs/remotes/origin/branch_7x)
[...]
   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestCloudSchemaless -Dtests.method=test -Dtests.seed=2542B6AD904A6296 -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=th-TH-u-nu-thai-x-lvariant-TH -Dtests.timezone=America/Nipigon -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1
   [junit4] ERROR   48.2s J0 | TestCloudSchemaless.test &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.NullPointerException
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([2542B6AD904A6296:AD1689773EB60F6E]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClient.requestWithRetryOnStaleState(CloudSolrClient.java:925)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClient.request(CloudSolrClient.java:808)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:178)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.SolrClient.add(SolrClient.java:106)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.SolrClient.add(SolrClient.java:71)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.SolrClient.add(SolrClient.java:85)
   [junit4]    &amp;gt; 	at org.apache.solr.schema.TestCloudSchemaless.test(TestCloudSchemaless.java:171)
   [junit4]    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsFixedStatement.callStatement(BaseDistributedSearchTestCase.java:993)
   [junit4]    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsStatement.evaluate(BaseDistributedSearchTestCase.java:968)
[...]
   [junit4]   2&amp;gt; NOTE: test params are: codec=Asserting(Lucene70): {}, docValues:{}, maxPointsInLeafNode=350, maxMBSortInHeap=6.677333545717319, sim=RandomSimilarity(queryNorm=true): {}, locale=th-TH-u-nu-thai-x-lvariant-TH, timezone=America/Nipigon
   [junit4]   2&amp;gt; NOTE: Linux 4.10.0-33-generic i386/Oracle Corporation 1.8.0_144 (32-bit)/cpus=8,threads=1,free=305236536,total=523501568
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16223129" author="jira-bot" created="Sat, 28 Oct 2017 01:27:56 +0000"  >&lt;p&gt;Commit cf75e14e41f9c670c1346974693b9706325bec63 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cf75e14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cf75e14&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11484&quot; title=&quot;CloudSolrClient&amp;#39;s cache of collection clusterstate can cause RouteExceptions when attempting directUpdates after collection modifications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11484&quot;&gt;&lt;del&gt;SOLR-11484&lt;/del&gt;&lt;/a&gt;: fixing NPE&lt;/p&gt;</comment>
                            <comment id="16223132" author="jira-bot" created="Sat, 28 Oct 2017 01:34:33 +0000"  >&lt;p&gt;Commit f1a6b68d75e58f464b2ed4ee3702a6c1b14511a0 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f1a6b68&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f1a6b68&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11484&quot; title=&quot;CloudSolrClient&amp;#39;s cache of collection clusterstate can cause RouteExceptions when attempting directUpdates after collection modifications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11484&quot;&gt;&lt;del&gt;SOLR-11484&lt;/del&gt;&lt;/a&gt;: fixing NPE&lt;/p&gt;</comment>
                            <comment id="16223608" author="varunthacker" created="Sat, 28 Oct 2017 15:51:02 +0000"  >&lt;p&gt;After this commit what&apos;s the definition of {{directUpdatesToLeadersOnly?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       Replica leader = slice.getLeader();
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (directUpdatesToLeadersOnly &amp;amp;&amp;amp; leader == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica replica : slice.getReplicas(
+            replica -&amp;gt; replica.isActive(getClusterStateProvider().getLiveNodes())
+                &amp;amp;&amp;amp; replica.getType() == Replica.Type.NRT)) {
+          leader = replica;
+          &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
+        }
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16223767" author="noble.paul" created="Sat, 28 Oct 2017 22:55:06 +0000"  >&lt;p&gt;If there is no leader, send the request to any live NRT node&lt;/p&gt;</comment>
                            <comment id="16223821" author="varunthacker" created="Sun, 29 Oct 2017 03:17:56 +0000"  >&lt;p&gt;But then why have the directUpdatesToLeadersOnly flag? Shouldn&apos;t that be just the default behaviour? &lt;/p&gt;</comment>
                            <comment id="16223822" author="noble.paul" created="Sun, 29 Oct 2017 03:22:07 +0000"  >&lt;p&gt;I have to agree with you on that&lt;/p&gt;</comment>
                            <comment id="16234311" author="varunthacker" created="Wed, 1 Nov 2017 16:15:17 +0000"  >&lt;p&gt;Hi Everyone,&lt;/p&gt;

&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cpoerschke&quot; class=&quot;user-hover&quot; rel=&quot;cpoerschke&quot;&gt;cpoerschke&lt;/a&gt; what are your thoughts on this? I guess the work &quot;Only&quot; in the flag would mean that the update should fail if there are no leaders?&lt;/p&gt;

&lt;p&gt;In which case our tests should not set this flag and use the default behaviour which is &quot;If there is no leader, send the request to any live NRT node&quot;&lt;/p&gt;</comment>
                            <comment id="16238555" author="cpoerschke" created="Fri, 3 Nov 2017 23:11:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt; - thanks for including me here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... I guess the work &quot;Only&quot; in the flag would mean that the update should fail if there are no leaders? ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Correct, that was the intention. For convenience &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512?focusedCommentId=15506019&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15506019&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;copy/pasting&lt;/a&gt; a &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt; comment here:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9090&quot; title=&quot;solrj CloudSolrClient: add directUpdatesToLeadersOnly support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9090&quot;&gt;&lt;del&gt;SOLR-9090&lt;/del&gt;&lt;/a&gt; &lt;tt&gt;directUpdatesToLeadersOnly&lt;/tt&gt; motivation/intention was for the flag to be not a hint but a directive and for updates to &apos;fail fast&apos; if there is (temporarily or otherwise) no shard leader. Fail fast (and let the caller of the &lt;tt&gt;CloudSolrClient&lt;/tt&gt; handle alarming and retries as it sees fit) as opposed to sending or retry-sending to a non-leader which would then forward to the leader (and potentially still fail eventually, eventually/not-fast-slowly).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As far as the&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... In which case our tests should not set this flag and use the default behaviour ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;alternative is concerned, hmm, i&apos;m not sure, wouldn&apos;t that reduce test coverage in general, though yes perhaps for very specific tests a test could opt-out of randomising the value of the flag.&lt;/p&gt;

&lt;p&gt;ticket cross-reference: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11507&quot; title=&quot;simplify and extend SolrTestCaseJ4.CloudSolrClientBuilder randomisation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11507&quot;&gt;&lt;del&gt;SOLR-11507&lt;/del&gt;&lt;/a&gt; concerns flag randomisation in the test CloudSolrClient - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gerlowskija&quot; class=&quot;user-hover&quot; rel=&quot;gerlowskija&quot;&gt;gerlowskija&lt;/a&gt; any thoughts on this?&lt;/p&gt;

&lt;p&gt;(I should also mention that the &lt;tt&gt;directUpdatesToLeadersOnly&lt;/tt&gt; flag&apos;s addition predates the new replica types and I haven&apos;t yet considered if/how that might change the meaning of the flag.)&lt;/p&gt;</comment>
                            <comment id="16238569" author="noble.paul" created="Fri, 3 Nov 2017 23:24:28 +0000"  >&lt;p&gt;There are two possibilities&lt;br/&gt;
1) the state.json had no leader&lt;br/&gt;
2) there is no leader at all&lt;/p&gt;

&lt;p&gt;Most often it&apos;s because of #1. In case of #1 it&apos;s better to try a random node than fail fast&lt;/p&gt;</comment>
                            <comment id="16248775" author="steve_rowe" created="Sun, 12 Nov 2017 03:50:26 +0000"  >&lt;p&gt;Reproducing failure of a test added on this issue, from &lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-MacOSX/302/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-MacOSX/302/&lt;/a&gt; (reproduces for me on master branch on Linux):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Checking out Revision 6b5fbd3265e6819469e1b70a68908767fc14dd87 (refs/remotes/origin/branch_7x)
[...]
   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=CloudSolrClientTest -Dtests.method=testRetryUpdatesWhenClusterStateIsStale -Dtests.seed=3D8409F14A788F1 -Dtests.slow=true -Dtests.locale=fr-BL -Dtests.timezone=MET -Dtests.asserts=true -Dtests.file.encoding=UTF-8
   [junit4] ERROR   5.59s J1 | CloudSolrClientTest.testRetryUpdatesWhenClusterStateIsStale &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http://127.0.0.1:65235/solr/stale_state_test_col_shard1_replica_n1: Expected mime type application/octet-stream but got text/html. &amp;lt;html&amp;gt;
   [junit4]    &amp;gt; &amp;lt;head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=ISO-8859-1&quot;/&amp;gt;
   [junit4]    &amp;gt; &amp;lt;title&amp;gt;Error 404 &amp;lt;/title&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/head&amp;gt;
   [junit4]    &amp;gt; &amp;lt;body&amp;gt;
   [junit4]    &amp;gt; &amp;lt;h2&amp;gt;HTTP ERROR: 404&amp;lt;/h2&amp;gt;
   [junit4]    &amp;gt; &amp;lt;p&amp;gt;Problem accessing /solr/stale_state_test_col_shard1_replica_n1/update. Reason:
   [junit4]    &amp;gt; &amp;lt;pre&amp;gt;    Can not find: /solr/stale_state_test_col_shard1_replica_n1/update&amp;lt;/pre&amp;gt;&amp;lt;/p&amp;gt;
   [junit4]    &amp;gt; &amp;lt;hr /&amp;gt;&amp;lt;a href=&quot;http://eclipse.org/jetty&quot;&amp;gt;Powered by Jetty:// 9.3.20.v20170531&amp;lt;/a&amp;gt;&amp;lt;hr/&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/body&amp;gt;
   [junit4]    &amp;gt; &amp;lt;/html&amp;gt;
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([3D8409F14A788F1:B7E9D877F74EFEDD]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:607)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:255)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:244)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.LBHttpSolrClient.doRequest(LBHttpSolrClient.java:483)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.LBHttpSolrClient.request(LBHttpSolrClient.java:413)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClient.directUpdate(CloudSolrClient.java:559)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClient.sendRequest(CloudSolrClient.java:1016)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClient.requestWithRetryOnStaleState(CloudSolrClient.java:883)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClient.request(CloudSolrClient.java:816)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:194)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.request.UpdateRequest.commit(UpdateRequest.java:233)
   [junit4]    &amp;gt; 	at org.apache.solr.client.solrj.impl.CloudSolrClientTest.testRetryUpdatesWhenClusterStateIsStale(CloudSolrClientTest.java:844)
   [junit4]    &amp;gt; 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
   [junit4]    &amp;gt; 	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
   [junit4]    &amp;gt; 	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
   [junit4]    &amp;gt; 	at java.base/java.lang.reflect.Method.invoke(Method.java:564)
   [junit4]    &amp;gt; 	at java.base/java.lang.Thread.run(Thread.java:844)
[...]
   [junit4]   2&amp;gt; NOTE: test params are: codec=CheapBastard, sim=RandomSimilarity(queryNorm=false): {}, locale=fr-BL, timezone=MET
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16307051" author="githubbot" created="Sun, 31 Dec 2017 03:09:46 +0000"  >&lt;p&gt;Github user SerCeMan commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/264&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closing as this might be fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11484&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-11484&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13104531">SOLR-11392</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12894118" name="SOLR-11484.patch" size="6230" author="noble.paul" created="Thu, 26 Oct 2017 12:22:48 +0000"/>
                            <attachment id="12892649" name="SOLR-11484.patch" size="4448" author="hossman" created="Tue, 17 Oct 2017 17:09:10 +0000"/>
                            <attachment id="12891864" name="jenkins.thetaphi.20662.txt" size="4018320" author="hossman" created="Fri, 13 Oct 2017 00:20:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3l7xj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>