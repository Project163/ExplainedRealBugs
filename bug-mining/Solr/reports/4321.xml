<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13790] LRUStatsCache size explosion and ineffective caching</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13790</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;On a sizeable cluster with multi-shard multi-replica collections, when&#160;&lt;tt&gt;LRUStatsCache&lt;/tt&gt;&#160;was in use we encountered excessive memory usage, which consequently led to severe performance problems.&lt;/p&gt;

&lt;p&gt;On a closer examination of the heapdumps it became apparent that when&#160;&lt;tt&gt;LRUStatsCache.addToPerShardTermStats&lt;/tt&gt;&#160;is called it creates instances of&#160;&lt;tt&gt;FastLRUCache&lt;/tt&gt;&#160;using the passed&#160;&lt;tt&gt;shard&lt;/tt&gt;&#160;argument - however, the value of this argument is not a simple shard name but instead it&apos;s a randomly ordered list of ALL replica URLs for this shard.&lt;/p&gt;

&lt;p&gt;As a result, due to the combinatoric number of possible keys, over time the map in &lt;tt&gt;LRUStatsCache.perShardTemStats&lt;/tt&gt;&#160;grew to contain ~2 mln entries...&lt;/p&gt;

&lt;p&gt;The fix seems to be simply to extract the shard name and cache using this name instead of the full string value of the&#160;&lt;tt&gt;shard&lt;/tt&gt;&#160;parameter. Existing unit tests also need much improvement.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13258790">SOLR-13790</key>
            <summary>LRUStatsCache size explosion and ineffective caching</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Sep 2019 12:14:11 +0000</created>
                <updated>Thu, 3 Nov 2022 22:18:56 +0000</updated>
                            <resolved>Tue, 8 Oct 2019 07:57:00 +0000</resolved>
                                    <version>7.7.2</version>
                    <version>8.2</version>
                    <version>8.3</version>
                                    <fixVersion>8.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16941213" author="ab" created="Mon, 30 Sep 2019 18:09:30 +0000"  >&lt;p&gt;This patch is a work in progress - it fixes the error described above but it also tries to fix an existential problem in LRUStatsCache - namely, as it is now it would always send requests for fetching stats (thus adding a round-trip to every query), even for repeated queries, consequently defeating the point of LRU caching.&lt;/p&gt;

&lt;p&gt;Changes in this patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;consistenly use shard name instead of the full shard URL lists as caching keys, both in SolrCloud mode and in standalone distributed mode&lt;/li&gt;
	&lt;li&gt;optimized serialization of stats in order to minimize the size of data and to prevent serialization errors when terms contain separators or url-unsafe characters&lt;/li&gt;
	&lt;li&gt;added SolrCloud unit tests, still need much improvement&lt;/li&gt;
	&lt;li&gt;added some logic in LRUStatsCache that tries to avoid sending a stats request if all global data is already available in cache. This part is a little bit shaky but I don&apos;t have any better idea at the moment how to address this problem. Basically, it rewrites a query locally to see if there are any missing stats to be fetched - but the answer &quot;none&quot; is not 100% fool-proof because queries may be rewritten differently based on the available terms and fields in the local vs. remote index. The code tries to fix it post-factum by detecting missing global stats and forcing a fetch+cache of the missing stats with the next request.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16942904" author="ab" created="Wed, 2 Oct 2019 15:25:37 +0000"  >&lt;p&gt;Upon further examination it looks like &lt;tt&gt;ExactSharedStatsCache&lt;/tt&gt; and &lt;tt&gt;LRUStatsCache&lt;/tt&gt; have a problem with staleness - they don&apos;t track updates in the shards so they have no way of knowing when to refresh the stats. As a result the global stats may be even more wrong than if we used just local stats - imagine a scenario where there&apos;s a heavy indexing activity that adds a lot of terms and postings. In this scenario local stats from the local shard would reflect this growth, albeit partially, but the global stats that are stale would not.&lt;/p&gt;

&lt;p&gt;Another issue is with the purported optimization in &lt;tt&gt;LRUStatsCache&lt;/tt&gt; and &lt;tt&gt;ExactSharedStatsCache&lt;/tt&gt; - the claimed advantage of these caches is that they help to avoid unnecessary fetching of stats from shards. Only they don&apos;t ... as explained in my previous comment, both of these implementations always send ShardRequest-s to fetch the stats, thus adding one more round-trip to every query. Since the stats are fetched on every request at least there was no problem with the staleness &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; but the &quot;caching&quot; aspect was completely false - per-shard stats were being fetched on every request, and on every request new global stats would be built and send out.&lt;/p&gt;

&lt;p&gt;I plan to address these issues separately, the current patch is already large.&lt;/p&gt;

&lt;p&gt;Updated patch with the following additional changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the biggest change is that now StatsCache instances are tied to SolrIndexSearcher and its life-cycle and not to SolrCore - this helps to at least mitigate the problem of staleness and also the problem of unbound memory consumption of &lt;tt&gt;ExactSharedStatsCache&lt;/tt&gt;. The downside is that after every commit the cache needs to be re-populated.&lt;/li&gt;
	&lt;li&gt;more optimization and safety in StatsUtil serialization code&lt;/li&gt;
	&lt;li&gt;fixed a bug in &lt;tt&gt;DebugComponent&lt;/tt&gt; where only local stats would be used for explanations - this threw me off for a while, as I relied on explanations to explain the details of scoring &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;added more substance to SolrCloud unit tests&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All tests are passing. If there are no objections I&apos;d like to commit this shortly.&lt;/p&gt;</comment>
                            <comment id="16942908" author="ab" created="Wed, 2 Oct 2019 15:28:13 +0000"  >&lt;p&gt;Oh, and until the staleness issue is fixed I would recommend using only&#160;&lt;tt&gt;ExactStatsCache&lt;/tt&gt; - other implementations can only make matters worse, both in terms of memory use and scoring inaccuracies.&lt;/p&gt;</comment>
                            <comment id="16943149" author="dsmiley" created="Wed, 2 Oct 2019 20:39:30 +0000"  >&lt;p&gt;Interesting; your proposal makes sense.  Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16945948" author="ab" created="Mon, 7 Oct 2019 15:02:13 +0000"  >&lt;p&gt;Final patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;added stats caching metrics&lt;/li&gt;
	&lt;li&gt;improved SolrCloud tests&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16946081" author="jira-bot" created="Mon, 7 Oct 2019 17:54:09 +0000"  >&lt;p&gt;Commit c0a446b179e8091f84e795ab04c6c3fcc9396ebe in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c0a446b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c0a446b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13790&quot; title=&quot;LRUStatsCache size explosion and ineffective caching&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13790&quot;&gt;&lt;del&gt;SOLR-13790&lt;/del&gt;&lt;/a&gt;: LRUStatsCache size explosion and ineffective caching.&lt;/p&gt;</comment>
                            <comment id="16946207" author="jira-bot" created="Mon, 7 Oct 2019 20:41:53 +0000"  >&lt;p&gt;Commit 611966ec7b4d200568395ec4d1f1d353453ce9e2 in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=611966e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=611966e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13790&quot; title=&quot;LRUStatsCache size explosion and ineffective caching&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13790&quot;&gt;&lt;del&gt;SOLR-13790&lt;/del&gt;&lt;/a&gt;: LRUStatsCache size explosion and ineffective caching.&lt;/p&gt;</comment>
                            <comment id="16946440" author="jira-bot" created="Tue, 8 Oct 2019 03:13:31 +0000"  >&lt;p&gt;Commit c0a446b179e8091f84e795ab04c6c3fcc9396ebe in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13821&quot; title=&quot;Package Store&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13821&quot;&gt;&lt;del&gt;SOLR-13821&lt;/del&gt;&lt;/a&gt; from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c0a446b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c0a446b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13790&quot; title=&quot;LRUStatsCache size explosion and ineffective caching&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13790&quot;&gt;&lt;del&gt;SOLR-13790&lt;/del&gt;&lt;/a&gt;: LRUStatsCache size explosion and ineffective caching.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="12842929">SOLR-7759</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12982395" name="SOLR-13790.patch" size="103426" author="ab" created="Mon, 7 Oct 2019 15:01:29 +0000"/>
                            <attachment id="12981996" name="SOLR-13790.patch" size="83788" author="ab" created="Wed, 2 Oct 2019 15:06:28 +0000"/>
                            <attachment id="12981823" name="SOLR-13790.patch" size="51617" author="ab" created="Mon, 30 Sep 2019 18:09:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0705c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>