<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:44:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14423] static caches in StreamHandler ought to move to CoreContainer lifecycle</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14423</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;StreamHandler (at &quot;/stream&quot;) has several statically declared caches.  I think this is problematic, such as in testing wherein multiple nodes could be in the same JVM.  One of them is more serious &amp;#8211; SolrClientCache which is closed/cleared via a SolrCore close hook.  That&apos;s bad for performance but also dangerous since another core might want to use one of these clients!&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13300083">SOLR-14423</key>
            <summary>static caches in StreamHandler ought to move to CoreContainer lifecycle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="dsmiley">David Smiley</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Apr 2020 20:31:35 +0000</created>
                <updated>Sat, 1 Feb 2025 02:21:57 +0000</updated>
                            <resolved>Wed, 13 May 2020 20:02:35 +0000</resolved>
                                                    <fixVersion>8.6</fixVersion>
                                    <component>streaming expressions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17089049" author="dsmiley" created="Tue, 21 Apr 2020 20:38:58 +0000"  >&lt;p&gt;I propose we add a general purpose enhancement to CoreContainer to help multiple plugins that might want to have core-wide facilities.  Imagine the CoreContainer offering a ConcurrentMap keyed by class and value is an instance of the class.  On CoreContainer shutdown, these are examined to see which are closeable, and they are then closed.  The typed nature would mean you can&apos;t usefully add something generic like a String but I think that&apos;s a fine trade-off for some type safety.&lt;/p&gt;</comment>
                            <comment id="17089534" author="ab" created="Wed, 22 Apr 2020 10:30:20 +0000"  >&lt;p&gt;&lt;tt&gt;SolrCloudManager.getObjectCache()&lt;/tt&gt; was implemented for precisely this reason - there was no other place that was related to a &quot;node&quot; concept where we could keep references to node-wide resources. I think it would be fine to make it type-safe in the way you described.&lt;/p&gt;</comment>
                            <comment id="17089726" author="dsmiley" created="Wed, 22 Apr 2020 14:21:21 +0000"  >&lt;p&gt;Interesting; I&apos;ve never seen/heard of &lt;tt&gt;SolrCloudManager&lt;/tt&gt; before.  I don&apos;t think this is quite the right fit though because that thing is expressly associated with SolrCloud whereas I think something on CoreContainer specifically is more useful and also either to find than SCM.&lt;/p&gt;</comment>
                            <comment id="17089798" author="ab" created="Wed, 22 Apr 2020 15:44:44 +0000"  >&lt;p&gt;Fair enough &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;tt&gt;SolrCloudManager&lt;/tt&gt; was an effort to separate SolrCloud from Zookeeper API, and it succeeded in the autoscaling APIs that are now completely ZK agnostic - it would be a monumental task to completely switch Solr to using its APIs instead of ZK, but it is used in a few other places too, even in some handlers (MetricsHistoryHandler, AutoscalingHandler). It&apos;s easy to mock or provide alternative implementations / delegates in tests, and it has the above-mentioned ObjectCache. Conversely, it&apos;s very difficult to mock a CoreContainer properly.&lt;/p&gt;

&lt;p&gt;But I agree it&apos;s specific to SolrCloud. I&apos;m worried that if you add this map to CC then it will become much harder to simulate / mock this in tests, because you will always need to instantiate a CoreContainer.&lt;/p&gt;

&lt;p&gt;(If we had a proper dependency injection framework many of these crutches wouldn&apos;t be necessary ... but that&apos;s another discussion.)&#160;&lt;/p&gt;</comment>
                            <comment id="17091198" author="dsmiley" created="Fri, 24 Apr 2020 04:58:31 +0000"  >&lt;p&gt;Great feedback AB.  I agree on the dependency injection framework point.&lt;/p&gt;</comment>
                            <comment id="17099091" author="cpoerschke" created="Mon, 4 May 2020 16:25:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;... StreamHandler (at &quot;/stream&quot;) has several statically declared caches. ... SolrClientCache ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I had noticed that GraphHandler references StreamHandler&apos;s client cache &amp;#8211; e.g. &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.1/solr/core/src/java/org/apache/solr/handler/GraphHandler.java#L150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.5.1/solr/core/src/java/org/apache/solr/handler/GraphHandler.java#L150&lt;/a&gt; &amp;#8211; and it sounds like the above solution could take care of that too then.&lt;/p&gt;</comment>
                            <comment id="17100106" author="ab" created="Tue, 5 May 2020 17:28:58 +0000"  >&lt;p&gt;I created a PR with the initial attempt at fixing this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;CoreContainer.solrClientCache&lt;/tt&gt; is initialized on &lt;tt&gt;load()&lt;/tt&gt; and closed on &lt;tt&gt;shutdown()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;I modified the StreamHandler, GraphHandler, ReindexCollectionCmd, ColStatus, SolrReporter and a few other places to use this instance.&lt;/li&gt;
	&lt;li&gt;probably the most controversial change is in the &lt;tt&gt;org.apache.solr.handler.sql.CalciteSolrDriver&lt;/tt&gt; and &lt;tt&gt;SolrSchema&lt;/tt&gt; / &lt;tt&gt;SolrTable&lt;/tt&gt;. These objects are initialized in a way that makes it very difficult to pass an existing instance of SolrClientCache. For this reason I decided to create a single instance of the cache in &lt;tt&gt;SolrSchema&lt;/tt&gt; and manage its lifecycle through the &lt;tt&gt;Connection&lt;/tt&gt; - which required adding a wrapper to intercept the &lt;tt&gt;Connection.close()&lt;/tt&gt; call. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt;&#160;I would appreciate your feedback.&lt;/li&gt;
	&lt;li&gt;I also added an instance of&#160;&lt;tt&gt;CoreContainer.objectCache&lt;/tt&gt; - this is not strictly required by the other changes but it illustrates how we could use a single generic object cache at the CC level instead of adding many specialized accessors like the one for SolrClientCache. We can decide which way to go in the future.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17100212" author="joel.bernstein" created="Tue, 5 May 2020 19:32:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;, I&apos;ll take a look at the PR this week.&lt;/p&gt;</comment>
                            <comment id="17105692" author="jira-bot" created="Tue, 12 May 2020 19:44:24 +0000"  >&lt;p&gt;Commit 4680e9245f26e8ba99400dfbbdc0002c6b2886fe in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4680e92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=4680e92&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14423&quot; title=&quot;static caches in StreamHandler ought to move to CoreContainer lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14423&quot;&gt;&lt;del&gt;SOLR-14423&lt;/del&gt;&lt;/a&gt;: Move static SolrClientCache from StreamHandler to CoreContainer for wider reuse and better life-cycle management.&lt;/p&gt;</comment>
                            <comment id="17106511" author="jira-bot" created="Wed, 13 May 2020 17:37:29 +0000"  >&lt;p&gt;Commit dd4fa8f2f87d1dc7a10d72febc9241520b6294d6 in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=dd4fa8f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=dd4fa8f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14423&quot; title=&quot;static caches in StreamHandler ought to move to CoreContainer lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14423&quot;&gt;&lt;del&gt;SOLR-14423&lt;/del&gt;&lt;/a&gt;: Additional fixes for object caching and incorrect test assumptions.&lt;/p&gt;</comment>
                            <comment id="17106629" author="jira-bot" created="Wed, 13 May 2020 19:54:43 +0000"  >&lt;p&gt;Commit 3abd7585689db17ced6084cc360a87769d73d481 in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3abd758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=3abd758&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14423&quot; title=&quot;static caches in StreamHandler ought to move to CoreContainer lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14423&quot;&gt;&lt;del&gt;SOLR-14423&lt;/del&gt;&lt;/a&gt;: Move static SolrClientCache from StreamHandler to CoreContainer for wider reuse and better life-cycle management.&lt;/p&gt;</comment>
                            <comment id="17106630" author="jira-bot" created="Wed, 13 May 2020 19:54:45 +0000"  >&lt;p&gt;Commit d1aaa5ed34e5e6224ce57150cb143dd249bfef90 in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d1aaa5e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=d1aaa5e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14423&quot; title=&quot;static caches in StreamHandler ought to move to CoreContainer lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14423&quot;&gt;&lt;del&gt;SOLR-14423&lt;/del&gt;&lt;/a&gt;: Additional fixes for object caching and incorrect test assumptions.&lt;/p&gt;</comment>
                            <comment id="17106634" author="ab" created="Wed, 13 May 2020 20:02:35 +0000"  >&lt;p&gt;The final fix initializes &lt;tt&gt;CoreContainer.solrClientCache&lt;/tt&gt; instance and uses it in most other places.&lt;/p&gt;

&lt;p&gt;One odd duck was the &lt;tt&gt;CalciteSolrDriver&lt;/tt&gt;, which is configured statically by the JDBC framework. Here the CoreContainer explicitly finds that singleton instance and sets it to use the common SolrClientCache.&lt;/p&gt;

&lt;p&gt;Additionally, other static members of &lt;tt&gt;StreamHandler&lt;/tt&gt; are now kept in an &lt;tt&gt;ObjectCache&lt;/tt&gt; instance, which is again initialized in &lt;tt&gt;CoreContainer.objectCache&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;These changes should improve performance of /sql handler and increase the isolation of CoreContainers.&lt;/p&gt;

&lt;p&gt;Thank you David, Christine, and especially Joel for some insights into the streaming&apos;s inner workings and for additional testing.&lt;/p&gt;</comment>
                            <comment id="17158361" author="broustant" created="Wed, 15 Jul 2020 15:10:31 +0000"  >&lt;p&gt;Closing after the 8.6.0 release&lt;/p&gt;</comment>
                            <comment id="17922888" author="dsmiley" created="Sat, 1 Feb 2025 02:21:57 +0000"  >&lt;p&gt;Following up to those here; I&apos;m discussing with others in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17630&quot; title=&quot;Add CloudSolrClient instance for a Solr node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17630&quot;&gt;&lt;del&gt;SOLR-17630&lt;/del&gt;&lt;/a&gt; about deprecating CoreContainer.getSolrClientCache in lieu of a node CloudSolrClient and node Http2SolrClient (that can use any URL to talk to whoever) for general inter-node use.  SCC then becomes something only needed by the streaming expressions framework, so would likely go back there.  If you have thoughts, please raise them there.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13302622">SOLR-14459</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dwyo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>