<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:11:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17670] Fix unnecessary memory allocation caused by a large reRankDocs param</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17670</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The reRank function has a reRankDocs parameter that specifies the number of documents to re-rank. I&apos;ve observed that increasing this parameter to test its performance impact causes queries to become progressively slower. Even when the parameter value exceeds the total number of documents in the index, further increases continue to slow down the query, which is counterintuitive.&lt;br/&gt;
&#160;&lt;br/&gt;
Therefore, I investigated the code:&lt;br/&gt;
&#160;&lt;br/&gt;
For a query containing re-ranking, such as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{
&lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt;: 10,
&lt;span class=&quot;code-quote&quot;&gt;&quot;fl&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;ID,score&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;q&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;rq&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;{!rerank reRankQuery=&lt;span class=&quot;code-quote&quot;&gt;&apos;{!func} 100&apos;&lt;/span&gt; reRankDocs=1000000000 reRankWeight=2}&quot;&lt;/span&gt;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The current execution logic is as follows:&lt;br/&gt;
1. Perform normal retrieval using the q parameter.&lt;br/&gt;
2. Re-score all documents retrieved in the q phase using the rq parameter.&lt;br/&gt;
&#160;&lt;br/&gt;
During the retrieval in phase 1 (using q), a TopScoreDocCollector is created. Underneath, this creates a PriorityQueue which contains an Object[]. The length of this Object[] continuously increases with reRankDocs without any limit.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
On my local test cluster with limited JVM memory, this can even trigger an OOM, causing the Solr node to crash. I can also reproduce the OOM situation using the SolrCloudTestCase unit test.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
I think limiting the length of the Object[] array using searcher.getIndexReader().maxDoc() at ReRankCollector would resolve this issue. This way, when reRankDocs exceeds maxDoc, memory allocation will not continue to increase indefinitely.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13608330">SOLR-17670</key>
            <summary>Fix unnecessary memory allocation caused by a large reRankDocs param</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="gaojiabao1991">JiaBaoGao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 13 Feb 2025 02:12:44 +0000</created>
                <updated>Tue, 11 Mar 2025 23:42:57 +0000</updated>
                            <resolved>Sat, 22 Feb 2025 18:42:54 +0000</resolved>
                                                    <fixVersion>9.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17929377" author="jira-bot" created="Sat, 22 Feb 2025 17:57:51 +0000"  >&lt;p&gt;Commit 76c09a35dba42913a6bcb281b52b00f87564624a in solr&apos;s branch refs/heads/main from jiabao.gao&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=76c09a35dba&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=76c09a35dba&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17670&quot; title=&quot;Fix unnecessary memory allocation caused by a large reRankDocs param&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17670&quot;&gt;&lt;del&gt;SOLR-17670&lt;/del&gt;&lt;/a&gt;: Fix unnecessary memory allocation caused by a large reRankDocs param (#3181)&lt;/p&gt;
</comment>
                            <comment id="17929379" author="jira-bot" created="Sat, 22 Feb 2025 18:38:50 +0000"  >&lt;p&gt;Commit 17ccccf12dd7462691933f13285f93a2b5c444a3 in solr&apos;s branch refs/heads/branch_9x from jiabao.gao&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=17ccccf12dd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=17ccccf12dd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17670&quot; title=&quot;Fix unnecessary memory allocation caused by a large reRankDocs param&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17670&quot;&gt;&lt;del&gt;SOLR-17670&lt;/del&gt;&lt;/a&gt;: Fix unnecessary memory allocation caused by a large reRankDocs param (#3181)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 76c09a35dba42913a6bcb281b52b00f87564624a)&lt;/p&gt;</comment>
                            <comment id="17929380" author="jira-bot" created="Sat, 22 Feb 2025 18:41:18 +0000"  >&lt;p&gt;Commit 6e2b61e529ad2c8d9068740dffb9cab8f4d9416e in solr&apos;s branch refs/heads/branch_9_8 from jiabao.gao&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=6e2b61e529a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=6e2b61e529a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17670&quot; title=&quot;Fix unnecessary memory allocation caused by a large reRankDocs param&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17670&quot;&gt;&lt;del&gt;SOLR-17670&lt;/del&gt;&lt;/a&gt;: Fix unnecessary memory allocation caused by a large reRankDocs param (#3181)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 76c09a35dba42913a6bcb281b52b00f87564624a)&lt;/p&gt;</comment>
                            <comment id="17929381" author="dsmiley" created="Sat, 22 Feb 2025 18:42:54 +0000"  >&lt;p&gt;Thanks for contributing!&lt;/p&gt;</comment>
                            <comment id="17929443" author="JIRAUSER308664" created="Sun, 23 Feb 2025 09:28:33 +0000"  >&lt;p&gt;Thank you, David.&lt;/p&gt;</comment>
                            <comment id="17933681" author="jira-bot" created="Mon, 10 Mar 2025 01:46:16 +0000"  >&lt;p&gt;Commit 76c09a35dba42913a6bcb281b52b00f87564624a in solr&apos;s branch refs/heads/deprecations from jiabao.gao&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=76c09a35dba&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=76c09a35dba&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17670&quot; title=&quot;Fix unnecessary memory allocation caused by a large reRankDocs param&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17670&quot;&gt;&lt;del&gt;SOLR-17670&lt;/del&gt;&lt;/a&gt;: Fix unnecessary memory allocation caused by a large reRankDocs param (#3181)&lt;/p&gt;
</comment>
                            <comment id="17934380" author="houston" created="Tue, 11 Mar 2025 23:42:57 +0000"  >&lt;p&gt;Closing after the 9.8.1 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1u6s8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>