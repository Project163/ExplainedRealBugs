<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11661] New HDFS collection reuses unremoved data from a deleted HDFS collection with same name causes inconsistent view of documents</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11661</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;While testing &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11458&quot; title=&quot;Bugs in MoveReplicaCmd handling of failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11458&quot;&gt;&lt;del&gt;SOLR-11458&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; ran into an interesting failure which resulted in different document counts between leader and replica. The test is MoveReplicaHDFSTest on jira/solr-11458-2 branch.&lt;/p&gt;

&lt;p&gt;The failure is rare but reproducible on beasting:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
reproduce with: ant test  -Dtestcase=MoveReplicaHDFSTest -Dtests.method=testNormalFailedMove -Dtests.seed=161856CB543CD71C -Dtests.slow=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.locale=ar-SA -Dtests.timezone=US/Michigan -Dtests.asserts=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.file.encoding=ISO-8859-1
   [junit4] FAILURE 14.2s | MoveReplicaHDFSTest.testNormalFailedMove &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: expected:&amp;lt;100&amp;gt; but was:&amp;lt;56&amp;gt;
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([161856CB543CD71C:31134983787E4905]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.MoveReplicaTest.testFailedMove(MoveReplicaTest.java:305)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.MoveReplicaHDFSTest.testNormalFailedMove(MoveReplicaHDFSTest.java:69)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root problem here is when the old replica is not live during deletion of a collection, the correspond HDFS data of that replica is not removed therefore when a new collection with the same name as the deleted collection is created, new replicas will reuse the old HDFS data. This leads to many problems in leader election and recovery&lt;/p&gt;</description>
                <environment></environment>
        <key id="13119580">SOLR-11661</key>
            <summary>New HDFS collection reuses unremoved data from a deleted HDFS collection with same name causes inconsistent view of documents</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="caomanhdat">Cao Manh Dat</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Nov 2017 08:45:25 +0000</created>
                <updated>Wed, 2 Oct 2019 17:23:43 +0000</updated>
                            <resolved>Tue, 13 Mar 2018 04:49:09 +0000</resolved>
                                                    <fixVersion>7.3</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16258955" author="shalinmangar" created="Mon, 20 Nov 2017 08:51:39 +0000"  >&lt;p&gt;Full logs attached.&lt;/p&gt;

&lt;p&gt;Dat and I analyzed the logs and we found this problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# New collection called MoveReplicaHDFSTest_failed_coll is being created. New replicas core_node7 and core_node8 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard are in process of being created.
# New core MoveReplicaHDFSTest_failed_coll_shard2_replica_n4 core_node7 tries to become leader, asks MoveReplicaHDFSTest_failed_coll_shard2_replica_n6 core_node8 to sync
# Sync fails because core_node8 has no versions
# core_node7 becomes leader and asks core_node8 to recover
# core_node8 gets a request to recover and starts recovery thread recoveryExecutor-53-thread-1-processing-n:127.0.0.1:61049_solr
# core_node8 enters buffering state
# core_node8 sends prep recovery command to core_node7 and publishes itself in recovery state
# core_node7 has a thread in WaitForState and sees core_node8 as down currently
# At t=70388, some DataStreamer Exception is reported from DFSClient and leader core_node7 logs that  it could not close the HDFS transaction log due to no more good datanodes being available -- these look like they aren&apos;t relevant to the problem
# core_node7 (leader) publishes itself as active
# core_node7 create core is complete
# core_node8 create thread (qtp1713789948-2124) sees that there is a leader and publishes itself as active, skipping recovery
# core_node8 create core command is successful
# collection create is finished
# core_node7 remains tied in WaitForState because from now on it only sees core_node8 in active but not in recovery
# the recovery thread in core_node8 remains waiting in prep recovery
# New documents are added to the collection but they aren&apos;t visible to searchers because core_node8 is buffering and therefore ignores commit requests
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So there is a race between the core create thread publishing local as active after the leader has asked said core to recover. This is a side effect of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9566&quot; title=&quot;Can we avoid doing recovery when collections are first created?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9566&quot;&gt;&lt;del&gt;SOLR-9566&lt;/del&gt;&lt;/a&gt; which skips recovery for replicas which are being created as part of a new collection.&lt;/p&gt;</comment>
                            <comment id="16259155" author="shalinmangar" created="Mon, 20 Nov 2017 11:59:24 +0000"  >&lt;p&gt;Actually, Dat pointed out to me privately that the recovery thread is created because of core_node8 losing leader election. The request to recover made by core_node7 to core_node8 becomes a no-op because a recovery is already underway.&lt;/p&gt;</comment>
                            <comment id="16284644" author="caomanhdat" created="Sat, 9 Dec 2017 07:27:36 +0000"  >&lt;p&gt;This bug relates to HDFS lease recovery. When tlog files of a replica (core_node7 in this case) get deleted and get recovered when a new collection of the same name gets created.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; : for newly created core, should we skip lease recovery??&lt;/p&gt;</comment>
                            <comment id="16328125" author="caomanhdat" created="Wed, 17 Jan 2018 01:42:32 +0000"  >&lt;p&gt;Attached a patch for reproduce the problem 100%, the case here is &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;when a node get down in DELETECOLLECTION, the correspond cores in that node is never being cleanup ( the core.properties, the index dir and tlog dir )&lt;/li&gt;
	&lt;li&gt;after that if a core with same name and same collection get created on different node, it will reuse the old stale tlog and index dir which leads to many problems&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16337088" author="caomanhdat" created="Wed, 24 Jan 2018 07:55:25 +0000"  >&lt;p&gt;A patch for this ticket, this patch solve the problem by do not remove the counter node in case of failures, hence even when a new collection with same name is created, the core node name will be different -&amp;gt; the data dir will be different on HDFS. ( this solution is found after a discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;, thanks! )&lt;/p&gt;

&lt;p&gt;This require some changes in several places&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ClusterStateUpdater only remove state.json of a collection, the rest data on ZK will be deleted by DeleteCollectionCmd.&lt;/li&gt;
	&lt;li&gt;OverseerCollectionMessageHandler.collectionCmd will return a list of replicas which did not online to receive the request&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16339045" author="caomanhdat" created="Thu, 25 Jan 2018 10:34:34 +0000"  >&lt;p&gt;The test passed so I will commit tomorrow if there are no objection&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16344485" author="jira-bot" created="Tue, 30 Jan 2018 04:30:47 +0000"  >&lt;p&gt;Commit c56d774eb6555baa099fec22f290a9b5640a366d in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c56d774&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c56d774&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11661&quot; title=&quot;New HDFS collection reuses unremoved data from a deleted HDFS collection with same name causes inconsistent view of documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11661&quot;&gt;&lt;del&gt;SOLR-11661&lt;/del&gt;&lt;/a&gt;: New HDFS collection reuses unremoved data from a deleted HDFS collection with same name causes inconsistent view of documents&lt;/p&gt;</comment>
                            <comment id="16344487" author="jira-bot" created="Tue, 30 Jan 2018 04:32:12 +0000"  >&lt;p&gt;Commit 3527fa5979f6d4fded58767d84ffb0988734acd2 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=caomanhdat&quot; class=&quot;user-hover&quot; rel=&quot;caomanhdat&quot;&gt;caomanhdat&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3527fa5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3527fa5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11661&quot; title=&quot;New HDFS collection reuses unremoved data from a deleted HDFS collection with same name causes inconsistent view of documents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11661&quot;&gt;&lt;del&gt;SOLR-11661&lt;/del&gt;&lt;/a&gt;: New HDFS collection reuses unremoved data from a deleted HDFS collection with same name causes inconsistent view of documents&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13108260">SOLR-11458</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13007558">SOLR-9566</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12898437" name="11458-2-MoveReplicaHDFSTest-log.txt" size="2237712" author="shalin" created="Mon, 20 Nov 2017 08:46:38 +0000"/>
                            <attachment id="12907445" name="SOLR-11661.patch" size="17748" author="caomanhdat" created="Wed, 24 Jan 2018 07:50:38 +0000"/>
                            <attachment id="12906314" name="SOLR-11661.patch" size="4492" author="caomanhdat" created="Wed, 17 Jan 2018 01:39:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mzl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>