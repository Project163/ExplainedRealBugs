<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:22:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10277] On &apos;downnode&apos;, lots of wasteful mutations are done to ZK</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10277</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When a node restarts, it submits a single &apos;downnode&apos; message to the overseer&apos;s state update queue.&lt;/p&gt;

&lt;p&gt;When the overseer processes the message, it does way more writes to ZK than necessary. In our cluster of 48 hosts, the majority of collections have only 1 shard and 1 replica. So a single node restarting should only result in ~1/40th of the collections being updated with new replica states (to indicate the node that is no longer active).&lt;/p&gt;

&lt;p&gt;However, the current logic in NodeMutator#downNode always updates &lt;b&gt;every&lt;/b&gt; collection. So we end up having to do rolling restarts very slowly to avoid having a severe outage due to the overseer having to do way too much work for each host that is restarted. And subsequent shards becoming leader can&apos;t get processed until the `downnode` message is fully processed. So a fast rolling restart can result in the overseer queue growing incredibly large and nearly all shards winding up in a leader-less state until that backlog is processed.&lt;/p&gt;

&lt;p&gt;The fix is a trivial logic change to only add a ZkWriteCommand for collections that actually have an impacted replica.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13055739">SOLR-10277</key>
            <summary>On &apos;downnode&apos;, lots of wasteful mutations are done to ZK</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dragonsinth">Scott Blum</assignee>
                                    <reporter username="jhump">Joshua Humphries</reporter>
                        <labels>
                            <label>leader</label>
                            <label>zookeeper</label>
                    </labels>
                <created>Mon, 13 Mar 2017 21:55:49 +0000</created>
                <updated>Thu, 21 Nov 2019 00:42:11 +0000</updated>
                            <resolved>Wed, 5 Apr 2017 10:37:16 +0000</resolved>
                                    <version>5.5.3</version>
                    <version>5.5.4</version>
                    <version>6.0.1</version>
                    <version>6.2.1</version>
                    <version>6.3</version>
                    <version>6.4.2</version>
                                    <fixVersion>6.5.1</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15923092" author="varunthacker" created="Mon, 13 Mar 2017 22:25:28 +0000"  >&lt;p&gt;Hi Joshua,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;However, the current logic in NodeMutator#downNode always updates &lt;b&gt;every&lt;/b&gt; collection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am checking against Solr 5.5.3 since you have listed that as the &apos;Affected Versions&apos; . Looking at &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/5.5.3/solr/core/src/java/org/apache/solr/cloud/overseer/NodeMutator.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/releases/lucene-solr/5.5.3/solr/core/src/java/org/apache/solr/cloud/overseer/NodeMutator.java#L65&lt;/a&gt; it looks to me that it only updates those replicas of collection which belong to this node.  Am i missing something here?&lt;/p&gt;</comment>
                            <comment id="15923390" author="jhump" created="Tue, 14 Mar 2017 01:53:26 +0000"  >&lt;p&gt;It&apos;s only changing properties for replicas that correspond to this node. However, if you look at the whole method, especially 10 lines below, you&apos;ll find that it&apos;s always adding a ZkWriteCommand for each collection, regardless of whether any replica properties were touched. So it generates the necessary changes &lt;b&gt;and&lt;/b&gt; a bunch of no-op updates for every other collection.&lt;/p&gt;</comment>
                            <comment id="15925280" author="varunthacker" created="Tue, 14 Mar 2017 23:53:31 +0000"  >&lt;p&gt;Hi Joshua,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;and a bunch of no-op updates for every other collection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay I see what you&apos;re saying now. Will you want to submit a patch? Else I will take a look at it.&lt;/p&gt;</comment>
                            <comment id="15925290" author="jhump" created="Tue, 14 Mar 2017 23:57:43 +0000"  >&lt;p&gt;I have a patch and a test for 5.5.3. Looks like this particular file (NodeMutator.java) hasn&apos;t changed and is still basically the same at HEAD, so it should be easy to apply to 6.4/6.5, too.&lt;/p&gt;

&lt;p&gt;I&apos;d like to actually get my patch deployed in our cluster so I can measure its impact to rolling-restarts of the cluster.&lt;/p&gt;</comment>
                            <comment id="15925296" author="varunthacker" created="Wed, 15 Mar 2017 00:01:02 +0000"  >&lt;p&gt;Yes the patch should apply to master cleanly. You can always post the patch before testing and report back with the numbers once you have deployed it. Either way it&apos;s fine. &lt;/p&gt;

&lt;p&gt;I think it&apos;s an important fix for large clusters so I would like to get this in Solr 6.5 &lt;/p&gt;</comment>
                            <comment id="15925340" author="jhump" created="Wed, 15 Mar 2017 00:40:10 +0000"  >&lt;p&gt;I&apos;ve attached a patch file that should cleanly apply to version 5.5.3, and hopefully to other versions to.&lt;/p&gt;</comment>
                            <comment id="15925372" author="varunthacker" created="Wed, 15 Mar 2017 01:12:09 +0000"  >&lt;p&gt;Hi Joshua,&lt;/p&gt;

&lt;p&gt;The patch didn&apos;t apply cleanly but was pretty simple to fix the couple of conflicts that I had with master.&lt;/p&gt;

&lt;p&gt;It&apos;s great that we have a test for this. We already have &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/core/src/test/org/apache/solr/cloud/SharedFSAutoReplicaFailoverUtilsTest.java#L83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/master/solr/core/src/test/org/apache/solr/cloud/SharedFSAutoReplicaFailoverUtilsTest.java#L83&lt;/a&gt; which is similar to &lt;tt&gt;NodeMutatorTest#makeClusterState&lt;/tt&gt; , but thats only because I had seen that test in the past for some other work. Should we put that method into a class like &lt;tt&gt;GenerateClusterStateMocks&lt;/tt&gt; or something so thats it&apos;s more discoverable in the future and reuse that here ? &lt;/p&gt;

&lt;p&gt;Lastly I just want to understand the motivation behind changing &lt;tt&gt;ClusterState#getCollections&lt;/tt&gt; to use a LinkedHashSet instead of a HashSet. Do you think the ordering of the entries helps us in any way here?&lt;/p&gt;

&lt;p&gt;Patch looks great otherwise! &lt;/p&gt;</comment>
                            <comment id="15925386" author="jhump" created="Wed, 15 Mar 2017 01:33:04 +0000"  >&lt;p&gt;Thanks for pointing out SharedFSAutoReplicaFailoverUtilsTest. I&apos;ll take a look to see how things could be consolidated a little better.&lt;/p&gt;

&lt;p&gt;The change in ClusterState to use a LinkedHashSet is for deterministic ordering. If you remove that part of the patch, you&apos;ll find that the test no longer passes as iteration order over the collection names becomes non-deterministic. I saw that LinkedHash* is used in a few other places and figured it would not be objectionable.&lt;/p&gt;</comment>
                            <comment id="15926140" author="jhump" created="Wed, 15 Mar 2017 13:16:02 +0000"  >&lt;p&gt;Oops. I was wrong about needing the LinkedHashSet in ClusterState.&lt;/p&gt;

&lt;p&gt;Looks like I solved the deterministic ordering issue twice and left both of the fixes in the patch. The other fix is where the test sorts the list of writes, and that alone suffices. So we can undo those changes in ClusterState.java.&lt;/p&gt;</comment>
                            <comment id="15926163" author="jhump" created="Wed, 15 Mar 2017 13:20:46 +0000"  >&lt;p&gt;New (slightly smaller) patch file uploaded. Undoes change to ClusterState.java which turns out to be superfluous.&lt;/p&gt;</comment>
                            <comment id="15948297" author="dragonsinth" created="Thu, 30 Mar 2017 02:37:16 +0000"  >&lt;p&gt;Patch LGTM, any objections to merging this?&lt;/p&gt;</comment>
                            <comment id="15948303" author="varunthacker" created="Thu, 30 Mar 2017 02:43:49 +0000"  >&lt;p&gt;Hi Scott,&lt;/p&gt;

&lt;p&gt;I was updating the patch and trying to reuse SharedFSAutoReplicaFailoverUtilsTest for the test case when it create a cluster state.&lt;/p&gt;

&lt;p&gt;Give me a coupe of hour. I just started working on it today evening and should have something up soon.&lt;/p&gt;

&lt;p&gt;You can review and commit it then.&lt;/p&gt;</comment>
                            <comment id="15948316" author="dragonsinth" created="Thu, 30 Mar 2017 02:56:46 +0000"  >&lt;p&gt;Sure thing, no rush!  Would love to get more eyes + miles on it.&lt;/p&gt;</comment>
                            <comment id="15948470" author="varunthacker" created="Thu, 30 Mar 2017 06:00:09 +0000"  >&lt;p&gt;New patch which basically takes Joshua&apos;s patch and reuses existing test code to create a cluster state.&lt;/p&gt;

&lt;p&gt;The test fails if we don&apos;t change &lt;tt&gt;NodeMutator&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;We probably need to make a couple of minor changes before committing ( addressing the nocommit etc )&lt;/p&gt;</comment>
                            <comment id="15951407" author="varunthacker" created="Fri, 31 Mar 2017 18:03:52 +0000"  >&lt;p&gt;Hi Scott,&lt;/p&gt;

&lt;p&gt;Any comments on the last patch apart from addressing the nocommit ?&lt;/p&gt;

&lt;p&gt;Joshua curious if you deployed this on your cluster and how much improvements did you see?&lt;/p&gt;

&lt;p&gt;Regardless this should be a good candidate for Solr 6.5.1 as the fix is pretty safe. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; let me know if you&apos;re okay to commit this to the 6_5 branch as well&lt;/p&gt;</comment>
                            <comment id="15951437" author="jhump" created="Fri, 31 Mar 2017 18:22:40 +0000"  >&lt;p&gt;Hey, Varun,&lt;/p&gt;

&lt;p&gt;I actually just got it into our production cluster yesterday. It reduced&lt;br/&gt;
the average time to restart a node (just under 50 nodes) and have it fully&lt;br/&gt;
active (e.g. overseer queue go quiet, all collections updated) from about&lt;br/&gt;
2.5 minutes down to 55 seconds. Our tools to examine and verify cluster&lt;br/&gt;
states also show that everything looked good.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Josh Humphries&lt;/p&gt;

&lt;p&gt;FullStory &amp;lt;&lt;a href=&quot;https://www.fullstory.com/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.fullstory.com/&lt;/a&gt;&amp;gt;  |  Atlanta, GA&lt;/p&gt;

&lt;p&gt;Software Engineer&lt;/p&gt;

&lt;p&gt;jh@fullstory.com&lt;/p&gt;

&lt;p&gt;On Fri, Mar 31, 2017 at 2:04 PM, Varun Thacker (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="15955217" author="shalinmangar" created="Tue, 4 Apr 2017 14:53:04 +0000"  >&lt;p&gt;It&apos;d be nice to release this fix in 6.5.1 &amp;#8211; looks serious.&lt;/p&gt;</comment>
                            <comment id="15955274" author="dragonsinth" created="Tue, 4 Apr 2017 15:42:32 +0000"  >&lt;p&gt;Agreed, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; I&apos;m actually OOO all week-- if you wanted to take point on getting this landed that would be super.  I reviewed all the live code previously, but not &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&apos;s patch to the test.  (though to be honest I&apos;m not super familiar with the test frameworks anyway)&lt;/p&gt;</comment>
                            <comment id="15955288" author="shalinmangar" created="Tue, 4 Apr 2017 15:54:00 +0000"  >&lt;p&gt;No problem, I&apos;ll review the patch and commit.&lt;/p&gt;</comment>
                            <comment id="15956459" author="shalinmangar" created="Wed, 5 Apr 2017 07:44:23 +0000"  >&lt;p&gt;Patch removes the nocommit and fixes the tests. I didn&apos;t remove the limitation of always having a bad replica in ClusterStateMockUtil but worked around it in the new tests. We can fix this in a different issue. I also changed the NodeMutator#downNode method slightly to remove a few extra copies and a ZK call (via clusterState.getCollection).&lt;/p&gt;

&lt;p&gt;I&apos;ll commit after running precommit and all tests.&lt;/p&gt;</comment>
                            <comment id="15956634" author="jira-bot" created="Wed, 5 Apr 2017 10:32:07 +0000"  >&lt;p&gt;Commit 60303028debf3927e0c3abfaaa4015f73b88e689 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6030302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6030302&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10277&quot; title=&quot;On &amp;#39;downnode&amp;#39;, lots of wasteful mutations are done to ZK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10277&quot;&gt;&lt;del&gt;SOLR-10277&lt;/del&gt;&lt;/a&gt;: On &apos;downnode&apos;, lots of wasteful mutations are done to ZK&lt;/p&gt;</comment>
                            <comment id="15956636" author="jira-bot" created="Wed, 5 Apr 2017 10:34:13 +0000"  >&lt;p&gt;Commit ef5db56632bdc2ec73a51bf393c6670318e80bd8 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ef5db56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ef5db56&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10277&quot; title=&quot;On &amp;#39;downnode&amp;#39;, lots of wasteful mutations are done to ZK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10277&quot;&gt;&lt;del&gt;SOLR-10277&lt;/del&gt;&lt;/a&gt;: On &apos;downnode&apos;, lots of wasteful mutations are done to ZK&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6030302)&lt;/p&gt;</comment>
                            <comment id="15956639" author="jira-bot" created="Wed, 5 Apr 2017 10:35:57 +0000"  >&lt;p&gt;Commit 8a2a409eca3ea3de6d31188deb8b532522f8e9e6 in lucene-solr&apos;s branch refs/heads/branch_6_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8a2a409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8a2a409&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10277&quot; title=&quot;On &amp;#39;downnode&amp;#39;, lots of wasteful mutations are done to ZK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10277&quot;&gt;&lt;del&gt;SOLR-10277&lt;/del&gt;&lt;/a&gt;: On &apos;downnode&apos;, lots of wasteful mutations are done to ZK&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6030302)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ef5db56)&lt;/p&gt;</comment>
                            <comment id="15956643" author="shalinmangar" created="Wed, 5 Apr 2017 10:37:16 +0000"  >&lt;p&gt;Thanks everyone!&lt;/p&gt;</comment>
                            <comment id="15957285" author="dragonsinth" created="Wed, 5 Apr 2017 17:26:58 +0000"  >&lt;p&gt;Thank you Shalin!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13065185">SOLR-10524</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12783759">SOLR-7281</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12858876" name="SOLR-10277-5.5.3.patch" size="10193" author="jhump" created="Wed, 15 Mar 2017 13:20:46 +0000"/>
                            <attachment id="12862030" name="SOLR-10277.patch" size="36587" author="shalin" created="Wed, 5 Apr 2017 07:44:23 +0000"/>
                            <attachment id="12861171" name="SOLR-10277.patch" size="36077" author="varun" created="Thu, 30 Mar 2017 06:00:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3c7jj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>