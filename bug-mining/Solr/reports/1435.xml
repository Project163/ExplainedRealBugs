<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:37:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4910] solr.xml persistence is completely broken</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4910</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I&apos;m working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4862&quot; title=&quot;Core admin action &amp;quot;CREATE&amp;quot; fails to persist some settings in solr.xml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4862&quot;&gt;&lt;del&gt;SOLR-4862&lt;/del&gt;&lt;/a&gt; (persisting a created core doesn&apos;t preserve some values) and at least compared to 4.3 code, persisting to solr.xml is completely broken.&lt;/p&gt;

&lt;p&gt;I learned to hate persistence while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4196&quot; title=&quot;Untangle XML-specific nature of Config and Container classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4196&quot;&gt;&lt;del&gt;SOLR-4196&lt;/del&gt;&lt;/a&gt; &amp;amp; etc. and I&apos;m glad it&apos;s going away. I frequently got lost in implicit properties (they&apos;re easy to persist and shouldn&apos;t be), what should/shouldn&apos;t be persisted (e.g. the translated ${var:default} or the original), and it was a monster, so don&apos;t think I&apos;m nostalgic for the historical behavior.&lt;/p&gt;

&lt;p&gt;Before I dive back in I want to get some idea whether or not the current behavior was intentional or not, I don&apos;t want to go back into that junk only to undo someone else&apos;s work.&lt;/p&gt;

&lt;p&gt;Creating a new core (collection2 in my example) with persistence turned on in solr.xml for instance changes the original definition for collection1 (stock 4.x as of tonight) from this:&lt;/p&gt;

&lt;p&gt;&amp;lt;core name=&quot;collection1&quot; instanceDir=&quot;collection1&quot; shard=&quot;${shard:}&quot; collection=&quot;${collection:collection1}&quot; config=&quot;${solrconfig:solrconfig.xml}&quot; schema=&quot;${schema:schema.xml}&quot;&lt;br/&gt;
          coreNodeName=&quot;${coreNodeName:}&quot;/&amp;gt;&lt;br/&gt;
to this:&lt;/p&gt;


&lt;p&gt;  &amp;lt;core loadOnStartup=&quot;true&quot; shard=&quot;${shard:}&quot; instanceDir=&quot;collection1/&quot; transient=&quot;false&quot; name=&quot;collection1&quot; dataDir=&quot;data/&quot; collection=&quot;${collection:collection1}&quot;&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;name&quot; value=&quot;collection1&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;config&quot; value=&quot;solrconfig.xml&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;solr.core.instanceDir&quot; value=&quot;solr/collection1/&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;transient&quot; value=&quot;false&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;schema&quot; value=&quot;schema.xml&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;loadOnStartup&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;solr.core.schemaName&quot; value=&quot;schema.xml&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;solr.core.name&quot; value=&quot;collection1&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;solr.core.dataDir&quot; value=&quot;data/&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;instanceDir&quot; value=&quot;collection1/&quot;/&amp;gt;&lt;br/&gt;
      &amp;lt;property name=&quot;solr.core.configName&quot; value=&quot;solrconfig.xml&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/core&amp;gt;&lt;/p&gt;



&lt;p&gt;So, there are two questions:&lt;br/&gt;
1&amp;gt; what is correct for 4.x?&lt;br/&gt;
2&amp;gt; do we care at all about 5.x?&lt;/p&gt;

&lt;p&gt;As much as I hate to say it, I think that we need to go back to the 4.3 behavior. It might be as simple as not persisting in the &amp;lt;property&amp;gt; tags anything already in the original definition. Not quite sure what to put where in the newly-created core though, I suspect that the compact &amp;lt;core + attribs&amp;gt; would be best (assuming there&apos;s no &amp;lt;property&amp;gt; tag already in the definition. I really hate the mix of attributes on the &amp;lt;core&amp;gt; tag and &amp;lt;property&amp;gt; tags, wish we had one or the other....&lt;/p&gt;</description>
                <environment></environment>
        <key id="12651823">SOLR-4910</key>
            <summary>solr.xml persistence is completely broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="erickerickson">Erick Erickson</assignee>
                                    <reporter username="erickerickson">Erick Erickson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Jun 2013 22:50:45 +0000</created>
                <updated>Mon, 9 May 2016 18:57:11 +0000</updated>
                            <resolved>Mon, 17 Jun 2013 01:36:05 +0000</resolved>
                                    <version>4.4</version>
                    <version>6.0</version>
                                    <fixVersion>4.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13678864" author="erickerickson" created="Sat, 8 Jun 2013 21:50:53 +0000"  >&lt;p&gt;From the user&apos;s list (Mark Miller) since the JIRA was down for maintenance.&lt;/p&gt;

&lt;p&gt;*****&lt;br/&gt;
I think in the past, it simply tried to write out what it read in. That should be the end goal, and AFAIK things pretty much worked like that in the late 3&apos;s or early 4&apos;s.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure for ${} sys prop notation, 4.3 broke the &amp;lt;cores section, but now it sounds like the &amp;lt;core part is broken. Just from memory though - I know something wasn&apos;t working in 4.3 along those lines. So the real issue seems to be the current testing...&lt;/p&gt;

&lt;p&gt;We have a some pretty simple tests for this (eg, they are easy to add too), so it sounds like we just need to beef them up - the changes necessary are easy from there.&lt;/p&gt;

&lt;p&gt;******&lt;/p&gt;</comment>
                            <comment id="13678875" author="erickerickson" created="Sat, 8 Jun 2013 22:32:09 +0000"  >&lt;p&gt;bq: So the real issue seems to be the current testing...&lt;/p&gt;

&lt;p&gt;Not quite sure what you mean here. I fully agree that current testing isn&apos;t catching this kind of problem, but the underlying behavior is broken too.&lt;/p&gt;

&lt;p&gt;bq: I&apos;m pretty sure for ${} sys prop notation, 4.3 broke the &amp;lt;cores&lt;/p&gt;

&lt;p&gt;Absolutely possible.....&lt;/p&gt;

&lt;p&gt;Let me see what I can do, the hack patch has the triage code in the wrong place, it should go in SolrCores when we build the objects we pass in to be persisted, and I&apos;ll see what I can do as far as beefing up the tests. So here are the rules I&apos;m thinking of.&lt;/p&gt;

&lt;p&gt;1&amp;gt; preserve the original if present. Since we have access to the original DOM object from solr.xml, this should be easy. Although the core name change/swap may be a problem here, what should be written out? There&apos;s a bunch of stuff about coreToOrigName in there.&lt;/p&gt;

&lt;p&gt;2&amp;gt; don&apos;t persist the implicit properties (things prefixed with solr.core) as one of the &amp;lt;property&amp;gt; tags.&lt;/p&gt;

&lt;p&gt;3&amp;gt; everything else as it is now, especially the &amp;lt;cores&amp;gt; bits, I&apos;m thinking this just really applies to the &amp;lt;core&amp;gt; tags.&lt;/p&gt;

&lt;p&gt;4&amp;gt; add much beefier tests.&lt;/p&gt;

&lt;p&gt;I&apos;ll take a whack at this tomorrow morning and see how far I get.&lt;/p&gt;</comment>
                            <comment id="13678879" author="erickerickson" created="Sat, 8 Jun 2013 22:50:29 +0000"  >&lt;p&gt;So before I dive into this, I want to be sure I understand what the end result is, because core swapping and renaming isn&apos;t something I&apos;ve dealt with a lot.&lt;/p&gt;

&lt;p&gt;corea is renamed coreb. Is coreb the persisted name?&lt;br/&gt;
corea and coreb are swapped, what is persisted?&lt;/p&gt;</comment>
                            <comment id="13678913" author="elyograg" created="Sun, 9 Jun 2013 02:26:28 +0000"  >&lt;blockquote&gt;
&lt;p&gt;corea is renamed coreb. Is coreb the persisted name?&lt;br/&gt;
corea and coreb are swapped, what is persisted?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I know a little bit about this, as I use core swapping in conjunction with full index rebuilds.  Here&apos;s my opinion.  Things that should be persisted any time there&apos;s a change:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Properties whose value has changed.  In the case of a rename or swap, that would be the core name(s).&lt;/li&gt;
	&lt;li&gt;Properties that are explicitly stated in solr.xml or the core.properties that is being overwritten.&lt;/li&gt;
	&lt;li&gt;Properties whose default value will be different in a future version of Solr.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Except as described in the list above, I don&apos;t think that unspecified defaults should be written.  When I took my solr.xml from 3.5.0 and put it on 4.1-SNAPSHOT, I suddenly had new data in my solr.xml after a core swap, the settings for LotsOfCores.  I don&apos;t think that should have been written, because it wasn&apos;t there in the first place.&lt;/p&gt;</comment>
                            <comment id="13679045" author="romseygeek" created="Sun, 9 Jun 2013 13:10:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m glad it&apos;s going away&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, it isn&apos;t really, is it?  The point of persistence is to make sure that changes made by the CoreAdminHandler (creations, deletions, renames, aliases and swaps, plus splits and merges which are special cases of create/delete) are still there after you restart.  And this is the case both if you&apos;re writing everything into solr.xml or if you&apos;re updating a core.properties file.&lt;/p&gt;

&lt;p&gt;What would be really good here would be to split persistence policies out into separate classes, one for writing to solr.xml and one for writing core.properties.  For solr.xml, the only mutable part is the cores list - we can store the surrounding part as a plain String, which means a) we don&apos;t need to worry about reconstructing things from a DOM, so we&apos;re guaranteed that we&apos;ll always write out what we read in, and b) we can preserve things like XML comments.  The core.properties version just writes out any non-default properties, subject to the rules that Shawn outlined above.&lt;/p&gt;

&lt;p&gt;The persistor (CoreDescriptorPersistor maybe?  Mmm, euphonious...) would belong to the CoreContainer, which can then call persistor.persist(CoreDescriptor) after each relevant operation.  CoreAdminHandler doesn&apos;t need to care about it, and we remove persist and persistFile as public methods of CoreContainer which reduces it&apos;s surface area a bit.&lt;/p&gt;

&lt;p&gt;CoreContainer, CoreDescriptor, CoreAdminHandler and ConfigSolr are all a bit leaky at the moment.  I think this is a good opportunity to patch up some of these abstractions.&lt;/p&gt;</comment>
                            <comment id="13679191" author="romseygeek" created="Sun, 9 Jun 2013 22:03:30 +0000"  >&lt;p&gt;Patch, untested, full of nocommits, etc, etc, but shows where I&apos;m thinking we should go with this.&lt;/p&gt;</comment>
                            <comment id="13679569" author="erickerickson" created="Mon, 10 Jun 2013 15:13:07 +0000"  >&lt;p&gt;Alan:&lt;/p&gt;

&lt;p&gt;Interesting stuff, looks like it would be much more rational, but far more ambitious than I was thinking. Not to say it shouldn&apos;t be carried forward, but I think it should be a separate issue. And only on the 5.x branch?&lt;/p&gt;

&lt;p&gt;I&apos;m thinking we need to split this JIRA into two parts, tactical and strategic. The solr.xml problem blocks 4.4 IMO, and we might be cutting a 4.4 fairly soon. This approach feels like it needs some time to bake given how many changes it makes.&lt;/p&gt;

&lt;p&gt;So I&apos;ve opened up a new JIRA (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4914&quot; title=&quot;Factor out core discovery and persistence logic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4914&quot;&gt;&lt;del&gt;SOLR-4914&lt;/del&gt;&lt;/a&gt;) and attached your (renamed) patch. I&apos;ll carry 4910 forward in the short term and we can iterate on 4914 ongoing for the longer term.&lt;/p&gt;
</comment>
                            <comment id="13679579" author="markrmiller@gmail.com" created="Mon, 10 Jun 2013 15:25:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Not quite sure what you mean here. I fully agree that current testing isn&apos;t catching this kind of problem, but the underlying behavior is broken too.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I mean that I think both of these things have been broken and fixed recently - that means testing is hitting none of this, so a fix is worthless without tests to make sure this stuff works. Adding tests requires a fix to the underlying problem. So what I am saying is that the majority of thought and effort on this should not be &quot;how do we fix it&quot;, and instead spent on adding tests and making them pass.&lt;/p&gt;

&lt;p&gt;It&apos;s very easy to check and see what the old behavior was regarding peristence - it was pretty simple though - we try and write out what we read in, but if the change was triggered dynamically, we can write it out however we want.&lt;/p&gt;

&lt;p&gt;It&apos;s a little odd, but TestSolrProperties is the current class that tests this type of stuff fairly simply. I think that is what we really want to beef up. I can likely pitch in as well.&lt;/p&gt;</comment>
                            <comment id="13679798" author="erickerickson" created="Mon, 10 Jun 2013 19:28:25 +0000"  >&lt;p&gt;OK, thanks for the clarification. I&apos;ll see what I can start getting together tonight and we can iterate...&lt;/p&gt;</comment>
                            <comment id="13679864" author="romseygeek" created="Mon, 10 Jun 2013 20:23:09 +0000"  >&lt;p&gt;OK, I can see you want to hold off anything major if we&apos;re dropping 4.4 imminently, but I think it&apos;s really worth looking at rationalizing this stuff.  Part of the reason it&apos;s easy to break, in addition to the lack of test coverage, is that the logic is spread out amongst a whole bunch of classes.&lt;/p&gt;</comment>
                            <comment id="13679879" author="markrmiller@gmail.com" created="Mon, 10 Jun 2013 20:43:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;is that the logic is spread out amongst a whole bunch of classes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree - it&apos;s gotten quite difficult to deal with the persistence code.&lt;/p&gt;

&lt;p&gt;At one point, I started trying to isolate the code a bit - in an attempt to make testing easier - a fair bit was still left in CoreContainer still though. The new stuff moved away from simply keeping the old dom in memory (I think we still want to do that and actually reintroduced it at one point, though I didn&apos;t move all the code to use it) and spread the code across a variety of new classes.&lt;/p&gt;

&lt;p&gt;I started a large refactoring wave on it actually, but there remains much to do in general IMO. CoreContainer and all of this has started to grow unweildy. Things will simplify some even with no effort I think - just not having to support the two core discovery modes will make a better design easier.&lt;/p&gt;

&lt;p&gt;In any case, I&apos;m not so happy with the current state of things, but currently two things have largely affected my thoughts on that:&lt;/p&gt;

&lt;p&gt;1. I have not had much time to apply to this problem - I started a lot of work a month or two back and have yet to come back to it.&lt;br/&gt;
2. We are dropping all this persistence stuff shortly in 5, as well as support for the old style solr.xml.&lt;/p&gt;

&lt;p&gt;So while we have a pressing needs for tests and fixes around solr.xml persistence, anything else I consider just gravy that may slide off into the trash when we release 5. Who doesn&apos;t love gravy if someone is willing to serve it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; But I&apos;d be almost as happy if we simply got this working as a start - then if people want to improve it, patches welcome, but we get to clean slate it in 5.0 anyway (when it comes to solr.xml persistence).&lt;/p&gt;

&lt;p&gt;I do welcome any contributions or improvements - but until we actually nail down the testing (this refactoring has exposed how few we have in these areas), refacoring is pretty scary stuff. &lt;/p&gt;</comment>
                            <comment id="13680123" author="erickerickson" created="Tue, 11 Jun 2013 01:21:09 +0000"  >&lt;p&gt;Here&apos;s the start of a patch that does nothing except &lt;br/&gt;
1&amp;gt; read in an solr.xml file&lt;br/&gt;
2&amp;gt; persist it&lt;br/&gt;
3&amp;gt; fail because the written file is different&lt;/p&gt;

&lt;p&gt;Mind you, this is just barely past the point of working at all, so it&apos;s pretty ragged but I thought I&apos;d put it up as a place to start. I hope to have a full patch ready by Monday...&lt;/p&gt;</comment>
                            <comment id="13680131" author="erickerickson" created="Tue, 11 Jun 2013 01:36:28 +0000"  >&lt;p&gt;bq (Alan): OK, I can see you want to hold off anything major if we&apos;re dropping 4.4 imminently, but I think it&apos;s really worth looking at rationalizing this stuff&lt;/p&gt;

&lt;p&gt;I completely agree, it&apos;s pretty clear that this grew organically and is a hodgepodge at best. It&apos;s just that I&apos;m pretty uncomfortable with the timing. Once 4.4 is cut, particularly if we can do something very quickly after 4.4 goes out and that discomfort goes away. Much of my trepidation is that there&apos;s some agitation for 4.4 in the very near future.&lt;/p&gt;


&lt;p&gt;bq (Mark): We are dropping all this persistence stuff shortly in 5, as well as support for the old style solr.xml.&lt;/p&gt;

&lt;p&gt;You don&apos;t know how thrilled I am to be working on something that I &lt;em&gt;know&lt;/em&gt; is going to be thrown out &amp;lt;G&amp;gt;.. But I&apos;m feeling like I&apos;m earning the right to be the one who rips it out &amp;lt;GGG&amp;gt;.&lt;/p&gt;


&lt;p&gt;bq (Mark): But I&apos;d be almost as happy if we simply got this working as a start&lt;/p&gt;

&lt;p&gt;Right, that&apos;s about all I intend to do on this. When 5.0 comes along and we&apos;ll rip it entirely out. So I&apos;m looking at just enough to get by the current hurdles and declare victory.&lt;/p&gt;


&lt;p&gt;The bulk of the effort in what I did tonight was figuring out how to verify that all the nodes and attributes in one xml file are identical to another. Please don&apos;t tell me something&apos;s already been written, I looked but didn&apos;t find it. Of course what I made tonight is specialized to solr.xml and I suspect it has some holes to flush out as the patch matures.&lt;/p&gt;

</comment>
                            <comment id="13680416" author="markrmiller@gmail.com" created="Tue, 11 Jun 2013 14:33:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;The bulk of the effort in what I did tonight was figuring out how to verify that all the nodes and attributes in one xml file are identical to another.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nice! That will be useful.&lt;/p&gt;</comment>
                            <comment id="13681223" author="erickerickson" created="Wed, 12 Jun 2013 13:47:32 +0000"  >&lt;p&gt;bq: Nice! That will be useful.&lt;/p&gt;

&lt;p&gt;It&apos;s rather specialized to solr.xml, but perhaps it can be generalized. The idea is that it creates XPATH expressions so equality is expressed as&lt;br/&gt;
are all xpath expressions created from xml A in xml B and vice-versa&lt;/p&gt;</comment>
                            <comment id="13681229" author="erickerickson" created="Wed, 12 Jun 2013 13:56:05 +0000"  >&lt;p&gt;Latest patch. I threw together a basket of lots and lots of things that could go in a solr.xml file. Along the way I found out that we weren&apos;t persisting a bunch of things, so I added them. It&apos;s possible I got confused about what&apos;s valid in 4.x as opposed to 5.x, so any other eyes would be welcome.&lt;/p&gt;

&lt;p&gt;The current state is that we can successfully persist about a zillion things in the solr.xml file. I still have to write some more tests, particularly around creating a new core and some more attempts to use system variables and insure that the original ${} syntax is preserved. Also, renaming cores and insuring that persistence is correct.&lt;/p&gt;

&lt;p&gt;I&apos;ve also grabbed some other JIRAs that have to do with persisting solr.xml, please bring to my attention any that aren&apos;t already assigned to me.&lt;/p&gt;
</comment>
                            <comment id="13681238" author="markrmiller@gmail.com" created="Wed, 12 Jun 2013 14:01:04 +0000"  >&lt;p&gt;I don&apos;t think numShards should be persisted or be part of solr.xml currently - did you find somewhere it was? Because it can change, we have tried to keep it out of solr.xml.&lt;/p&gt;</comment>
                            <comment id="13681269" author="erickerickson" created="Wed, 12 Jun 2013 14:25:09 +0000"  >&lt;p&gt;bq: I don&apos;t think numShards should be persisted or be part of solr.xml currently - did you find somewhere it was?&lt;/p&gt;

&lt;p&gt;Ahh, thanks. I saw it in: ...trunk/solr/core/src/test-files/solr/solr.xml and inferred it was a Good Thing (and it surprised me that it was). It looks like that snuck in there incorrectly, I&apos;ll remove it totally.&lt;/p&gt;</comment>
                            <comment id="13681273" author="markrmiller@gmail.com" created="Wed, 12 Jun 2013 14:28:38 +0000"  >&lt;p&gt;Yeah, that was probably me.&lt;/p&gt;</comment>
                            <comment id="13684170" author="erickerickson" created="Sat, 15 Jun 2013 12:55:18 +0000"  >&lt;p&gt;Getting much closer, I&apos;ve got a couple of test failures to investigate, but so far most of the old tests that fail have been verifying bad behavior.... &lt;/p&gt;

&lt;p&gt;I need to add tests for RELOAD, UNLOAD/LOAD, RENAME and SWAP. These may well uncover other stuff of course.&lt;/p&gt;

&lt;p&gt;There are a couple of nocommits still in, I just saw a really neat construct for when we mess with system vars that I&apos;m trying, so I commented out where I was doing this manually, does this really reset all system vars?&lt;/p&gt;

&lt;p&gt;  @Rule&lt;br/&gt;
  public TestRule solrTestRules =&lt;br/&gt;
      RuleChain.outerRule(new SystemPropertiesRestoreRule());&lt;/p&gt;


&lt;p&gt;All eyes welcome of course.&lt;/p&gt;</comment>
                            <comment id="13684699" author="erickerickson" created="Sun, 16 Jun 2013 17:18:58 +0000"  >&lt;p&gt;OK, if all the tests pass (running now), I think this is ready and I&apos;ll put it up tonight or tomorrow unless there are objections.&lt;/p&gt;

&lt;p&gt;This patch goes against trunk...&lt;/p&gt;

&lt;p&gt;This takes care of 4 bugs and 5 things that  testing flushed out, see solr/CHANGES.txt.&lt;/p&gt;

&lt;p&gt;Shawn (or anyone for that matter) if you have a chance to run this through any exercises it would be a Good Thing, especially seeing whether I made the right decisions around swapping and renaming. &lt;/p&gt;

&lt;p&gt;Under any circumstances, though, unless someone finds something horribly wrong or the tests blow up, I think this improves solr.xml persistence significantly and I&apos;ll check it in Real Soon Now.&lt;/p&gt;</comment>
                            <comment id="13684706" author="elyograg" created="Sun, 16 Jun 2013 17:41:41 +0000"  >&lt;p&gt;That was a bit of a bear to apply to 4x, but I got it done.  I don&apos;t have anything real set up with trunk where I can easily work on it with my index building code.  Perhaps I should set up a fourth index chain for that.&lt;/p&gt;

&lt;p&gt;I will poke around a bit.&lt;/p&gt;</comment>
                            <comment id="13684868" author="commit-tag-bot" created="Mon, 17 Jun 2013 00:33:31 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; erick&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493618&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493618&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4910&quot; title=&quot;solr.xml persistence is completely broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4910&quot;&gt;&lt;del&gt;SOLR-4910&lt;/del&gt;&lt;/a&gt;, improvements to persisting solr.xml and misc other fixes, see CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="13684889" author="commit-tag-bot" created="Mon, 17 Jun 2013 01:31:06 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; erick&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493620&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493620&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4910&quot; title=&quot;solr.xml persistence is completely broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4910&quot;&gt;&lt;del&gt;SOLR-4910&lt;/del&gt;&lt;/a&gt;, improvements to persisting solr.xml and misc other fixes, see CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="13684892" author="erickerickson" created="Mon, 17 Jun 2013 01:36:05 +0000"  >&lt;p&gt;trunk: 1493618&lt;br/&gt;
4x:    1493620    &lt;/p&gt;

&lt;p&gt;Also fixed in this commit:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4862&quot; title=&quot;Core admin action &amp;quot;CREATE&amp;quot; fails to persist some settings in solr.xml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4862&quot;&gt;&lt;del&gt;SOLR-4862&lt;/del&gt;&lt;/a&gt;, CREATE fails to persist schema, config, and dataDir&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4363&quot; title=&quot;Inconsistent &amp;quot;coreLoadThreads&amp;quot; attributes in solr.xml between read/write&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4363&quot;&gt;&lt;del&gt;SOLR-4363&lt;/del&gt;&lt;/a&gt;, not persisting coreLoadThreads in &amp;lt;solr&amp;gt; tag&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3900&quot; title=&quot;LogWatcher Config Not Persisted &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3900&quot;&gt;&lt;del&gt;SOLR-3900&lt;/del&gt;&lt;/a&gt;, logWatcher properties not persisted&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4850&quot; title=&quot;Cores defined as loadOnStartup=&amp;quot;true&amp;quot; and transient=&amp;quot;true&amp;quot; can&amp;#39;t be queried &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4850&quot;&gt;&lt;del&gt;SOLR-4850&lt;/del&gt;&lt;/a&gt;, cores defined as loadOnStartup=true, transient=false can&apos;t be searched&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt; Have at it, let&apos;s open up new JIRAs for anything you find, probably just assign them to me.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; This commit probably makes your life more difficult, you may want to do an update sooner rather than later, this got somewhat bigger than I expected.&lt;/p&gt;</comment>
                            <comment id="13684899" author="commit-tag-bot" created="Mon, 17 Jun 2013 01:44:14 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; erick&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493621&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493621&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4910&quot; title=&quot;solr.xml persistence is completely broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4910&quot;&gt;&lt;del&gt;SOLR-4910&lt;/del&gt;&lt;/a&gt;, corrected typo in CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="13684900" author="commit-tag-bot" created="Mon, 17 Jun 2013 01:44:58 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; erick&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1493622&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4910&quot; title=&quot;solr.xml persistence is completely broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4910&quot;&gt;&lt;del&gt;SOLR-4910&lt;/del&gt;&lt;/a&gt;, corrected typo in CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="13685738" author="elyograg" created="Mon, 17 Jun 2013 17:31:27 +0000"  >&lt;p&gt;After stripping my solr.xml down to the minimum required, I did a rebuild/swap.  It looks like the only thing that got added was these attributes to the cores tag:&lt;/p&gt;

&lt;p&gt;distribUpdateSoTimeout=&quot;0&quot; distribUpdateConnTimeout=&quot;0&quot;&lt;/p&gt;

&lt;p&gt;If these are parameters whose value will likely have a different default in a future Solr version, then this meets the criteria I outlined.  If not, then IMHO they shouldn&apos;t have been put in there.  That said, this is a whole lot better than it was before.  I had already upgraded this test machine to branch_4x and run it through swaps before.  The solr.xml that I edited before this test run was HUGE.&lt;/p&gt;

&lt;p&gt;I did leave a couple of extraneous bits (transient and collection) around, those were still there after the swap, so that&apos;s awesome.&lt;/p&gt;

&lt;p&gt;This wasn&apos;t an exhaustive test.  I haven&apos;t looked at the tests added in your patch, but if those are pretty complete, then I don&apos;t think I need to look deeper.&lt;/p&gt;</comment>
                            <comment id="13685761" author="markrmiller@gmail.com" created="Mon, 17 Jun 2013 17:51:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;After stripping my solr.xml down to the minimum required, I did a rebuild/swap. It looks like the only thing that got added was these attributes to the cores tag:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good test and nice catch!&lt;/p&gt;</comment>
                            <comment id="13685778" author="erickerickson" created="Mon, 17 Jun 2013 18:03:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt; Thanks! I&apos;ll open up a new JIRA, this should be easy to fix. I think the tests didn&apos;t catch that b/c they were in the &amp;lt;cores&amp;gt; tag already, so this should be a pretty easy thing to add a test for.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; So there&apos;ll be one more bit to make your life a little more difficult, but this should be a very small change.&lt;/p&gt;</comment>
                            <comment id="13716812" author="steve_rowe" created="Tue, 23 Jul 2013 18:38:39 +0000"  >&lt;p&gt;Bulk close resolved 4.4 issues&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="12649038">SOLR-4852</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12648858">SOLR-4850</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12609430">SOLR-3900</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12629385">SOLR-4363</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12649564">SOLR-4862</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12658752">SOLR-5051</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12653236">SOLR-4932</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12652044">SOLR-4914</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12588028" name="SOLR-4910.patch" size="54963" author="erickerickson" created="Sun, 16 Jun 2013 17:18:58 +0000"/>
                            <attachment id="12587974" name="SOLR-4910.patch" size="45327" author="erickerickson" created="Sat, 15 Jun 2013 12:55:18 +0000"/>
                            <attachment id="12587439" name="SOLR-4910.patch" size="37203" author="erickerickson" created="Wed, 12 Jun 2013 13:56:05 +0000"/>
                            <attachment id="12587182" name="SOLR-4910.patch" size="15944" author="erickerickson" created="Tue, 11 Jun 2013 01:21:09 +0000"/>
                            <attachment id="12586991" name="SOLR-4910.patch" size="39011" author="romseygeek" created="Sun, 9 Jun 2013 22:03:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332148</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lasn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332477</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>