<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:21:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-2342] Lock starvation can cause commit to never run when many clients are adding docs</title>
                <link>https://issues.apache.org/jira/browse/SOLR-2342</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I have a stress test, where 100 clients add 100 1MB docs and then call commit in the end.  It&apos;s a falldown test (try to make Solr fall down) and nowhere near &quot;actual&quot; usage.&lt;/p&gt;

&lt;p&gt;But, after some initial commits that succeed, I&apos;m seeing later commits always time out (client side timeout @ 10 minutes).  Watching Solr&apos;s logging, no commit ever runs.&lt;/p&gt;

&lt;p&gt;Looking at the stack traces in the threads, this is not deadlock: the add/update calls are running, and new segments are being flushed to the index.&lt;/p&gt;

&lt;p&gt;Digging in the code a bit, we use ReentrantReadWriteLock, with add/update acquiring the readLock and commit acquiring the writeLock.  But, according to the jdocs, the writeLock isn&apos;t given any priority over the readLock (unless you set fairness, which we don&apos;t).  So I think this explains the starvation?&lt;/p&gt;

&lt;p&gt;However, this is not a real world use case (most apps would/should call commit less often, and from on client).  Also, we could set fairness, but it seems to have some performance penalty, and I&apos;m not sure we should penalize the &quot;normal&quot; case for this unusual one.  EG see here (thanks Mark): &lt;a href=&quot;http://www.javaspecialists.eu/archive/Issue165.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.javaspecialists.eu/archive/Issue165.html&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12497387">SOLR-2342</key>
            <summary>Lock starvation can cause commit to never run when many clients are adding docs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikemccand">Michael McCandless</assignee>
                                    <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Feb 2011 21:57:27 +0000</created>
                <updated>Wed, 30 Mar 2011 15:46:01 +0000</updated>
                            <resolved>Mon, 14 Feb 2011 23:01:52 +0000</resolved>
                                                    <fixVersion>3.1</fixVersion>
                    <fixVersion>4.0-ALPHA</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12990554" author="mikemccand" created="Fri, 4 Feb 2011 13:32:46 +0000"  >&lt;p&gt;Fixing the client threads to not commit in the end, so no client is committing, and then turning on Solr&apos;s auto-commit, still hits the starvation.&lt;/p&gt;</comment>
                            <comment id="12991965" author="mikemccand" created="Tue, 8 Feb 2011 13:46:01 +0000"  >&lt;p&gt;OK, passing true to the ReentrantReadWriteLock fixes the starvation in this test...  Should we commit that?&lt;/p&gt;

&lt;p&gt;Passing true does make the read lock acq more costly, but I suspect this is in the noise for typical indexing.&lt;/p&gt;

&lt;p&gt;And, while I think the stress test is rather unnatural (normally one thread should call commit in the end), I fear many apps may (for simplicity) do something similar to this stress test.  Also, the fact that auto-commit is also starved is I think a more realistic failure...&lt;/p&gt;</comment>
                            <comment id="12992245" author="yseeley@gmail.com" created="Wed, 9 Feb 2011 00:15:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Passing true does make the read lock acq more costly, but I suspect this is in the noise for typical indexing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ll try to do a quick test to verify this soon.&lt;/p&gt;</comment>
                            <comment id="12993331" author="yseeley@gmail.com" created="Fri, 11 Feb 2011 03:47:14 +0000"  >&lt;p&gt;I did a test on my laptop (2 cores, 4 virtual cores via hyper-threading)&lt;br/&gt;
using StreamingUpdateSolrServer with 1,2,4,8, and 16 threads.&lt;br/&gt;
The documents were just 1M unique ids, and the throughput ranged anywhere from 60,000 docs per second, to 67000.&lt;br/&gt;
The timing of different runs varied up to 6% for the same number of threads on the client, but I couldn&apos;t detect a difference when the ReadWriteLock was switched to fair mode.&lt;/p&gt;
</comment>
                            <comment id="12993770" author="mikemccand" created="Sat, 12 Feb 2011 00:15:06 +0000"  >&lt;p&gt;OK, thanks Yonik.  That&apos;s good news.  Should we commit the fairness?&lt;/p&gt;</comment>
                            <comment id="12994102" author="mikemccand" created="Sun, 13 Feb 2011 14:03:50 +0000"  >&lt;p&gt;We may as well do this for 3.1?&lt;/p&gt;</comment>
                            <comment id="12994173" author="markrmiller@gmail.com" created="Sun, 13 Feb 2011 23:50:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;We may as well do this for 3.1?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12994544" author="mikemccand" created="Mon, 14 Feb 2011 22:55:54 +0000"  >&lt;p&gt;Thanks Mark; I&apos;ll commit shortly...&lt;/p&gt;</comment>
                            <comment id="13013262" author="gsingers" created="Wed, 30 Mar 2011 15:46:01 +0000"  >&lt;p&gt;Bulk close for 3.1.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5183</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03lcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>18892</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>