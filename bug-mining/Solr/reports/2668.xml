<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:08:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8135] SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8135</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;No idea what&apos;s going on here, noticed it while testing out an unrelated patch &amp;#8211; seed reproduces against pristine trunk...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=SolrCloudExampleTest -Dtests.method=testLoadDocsIntoGettingStartedCollection -Dtests.seed=59EA523FFF6CB60F -Dtests.slow=true -Dtests.locale=es_MX -Dtests.timezone=Africa/Porto-Novo -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1
   [junit4] FAILURE 49.5s | SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: Delete action failed!
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([59EA523FFF6CB60F:4A896050CE030FA9]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.SolrCloudExampleTest.doTestDeleteAction(SolrCloudExampleTest.java:169)
   [junit4]    &amp;gt; 	at org.apache.solr.cloud.SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection(SolrCloudExampleTest.java:145)
   [junit4]    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsFixedStatement.callStatement(BaseDistributedSearchTestCase.java:963)
   [junit4]    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsStatement.evaluate(BaseDistributedSearchTestCase.java:938)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12902849">SOLR-8135</key>
            <summary>SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Oct 2015 23:24:06 +0000</created>
                <updated>Fri, 17 Jun 2016 13:11:47 +0000</updated>
                            <resolved>Thu, 10 Mar 2016 19:29:40 +0000</resolved>
                                    <version>6.0</version>
                                    <fixVersion>6.0</fixVersion>
                    <fixVersion>6.1</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14945992" author="hossman" created="Tue, 6 Oct 2015 23:27:37 +0000"  >&lt;p&gt;attaching ant output testing against...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hossman@tray:~/lucene/dev$ svnversion &amp;amp;&amp;amp; svn info | grep URL
1707150
URL: https://svn.apache.org/repos/asf/lucene/dev/trunk
Relative URL: ^/lucene/dev/trunk
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with command...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ANT_ARGS=&quot;&quot; ant test -Dtestcase=SolrCloudExampleTest -Dtests.method=testLoadDocsIntoGettingStartedCollection -Dtests.seed=59EA523FFF6CB60F -Dtests.slow=true -Dtests.locale=es_MX -Dtests.timezone=Africa/Porto-Novo -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1 &amp;gt; SOLR-8135.failure.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14961867" author="jira-bot" created="Sat, 17 Oct 2015 12:00:57 +0000"  >&lt;p&gt;Commit 1709142 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1709142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1709142&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: Disable test until it can be fixed&lt;/p&gt;</comment>
                            <comment id="14961868" author="jira-bot" created="Sat, 17 Oct 2015 12:01:55 +0000"  >&lt;p&gt;Commit 1709143 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1709143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1709143&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: Disable test until it can be fixed&lt;/p&gt;</comment>
                            <comment id="14961877" author="thetaphi" created="Sat, 17 Oct 2015 12:29:21 +0000"  >&lt;p&gt;failed also on almost any build on Jenkins (2 of 3 builds failed). Thanks for disabling. I was afraid to do this...&lt;/p&gt;</comment>
                            <comment id="14962604" author="gus_heck" created="Sun, 18 Oct 2015 20:15:54 +0000"  >&lt;p&gt;also with &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ant test  -Dtestcase=SolrCloudExampleTest -Dtests.method=testLoadDocsIntoGettingStartedCollection -Dtests.seed=D7797CB78640592B -Dtests.slow=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.locale=mt_MT -Dtests.timezone=Jamaica -Dtests.asserts=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.file.encoding=US-ASCII &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;on 5.x&lt;/p&gt;</comment>
                            <comment id="14963604" author="thelabdude" created="Mon, 19 Oct 2015 16:57:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; Can you take a look at this failure? From the logs, it looks like something is breaking in the config overlay / refresh layer when a collection is being deleted. There&apos;s nothing wrong with this test.&lt;/p&gt;</comment>
                            <comment id="14964038" author="erickerickson" created="Mon, 19 Oct 2015 20:56:48 +0000"  >&lt;p&gt;I did notice that if I added any code that delayed for 15 seconds after the doTestConfigUpdate call in that test that it would succeed. Just hacking around for clues I tried looking at the ZK state to see if we were missing a state change and I didn&apos;t see any (looking at ZK state and seeing if any nodes weren&apos;t active). If I either looped for 15 seconds looking for not active states &lt;em&gt;or&lt;/em&gt; just slept for 15 seconds, the test would consistently pass.&lt;/p&gt;

&lt;p&gt;I may have a bit of time to look at this on the flight home tonight.....&lt;/p&gt;

&lt;p&gt;And if I commented out the doUpdateConfig, it would succeed.&lt;/p&gt;

&lt;p&gt;None of which helps pinpoint what&apos;s going on, but helps me get a clue where to &lt;em&gt;start&lt;/em&gt; looking...&lt;/p&gt;</comment>
                            <comment id="14964325" author="erickerickson" created="Tue, 20 Oct 2015 00:44:39 +0000"  >&lt;p&gt;So far, this patch keeps the test from failing. I hacked this in on the hint that buried in the failure case was a message about &quot;could not reload core blah blah blah&quot; and the fact that if I commented out the update config bits the test succeeded.&lt;/p&gt;

&lt;p&gt;Maybe a race condition between multiple API calls modifying the configs and core reloading? This patch forces the collection to reload as part of updating the config...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;&lt;br/&gt;
This feels like a band-aid though. I see in the ref guide that listeners are registered on the zknode and reloads happen sometime although I&apos;m unclear on what exactly triggers them. It seems like any modification of the config file should be atomic in the sense that as long as the updates are valid, any core reloads should get a config that loads successfully. How do we guarantee atomic reads/writes of the config files? Especially when the read path is different than the write path?&lt;/p&gt;

&lt;p&gt;I don&apos;t have the logs right now, so I don&apos;t have a good sense of what in core reload was really failing, I&apos;ll see if I can get some of that info.&lt;/p&gt;

&lt;p&gt;NOTE: I&apos;m on a plane so I could only beast this lightly. Nevertheless, I never got 4 successful runs before this patch and got 16 with the patch so it certainly seems in the right neighborhood. I&apos;ll be able to give it a more thorough spin when I&apos;m not on battery. Assuming we think this is the right fix.&lt;/p&gt;</comment>
                            <comment id="14964522" author="erickerickson" created="Tue, 20 Oct 2015 04:59:24 +0000"  >
&lt;p&gt;Here&apos;s all the stack trace related to reloading the core I could find on a failure run.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; 50808 INFO  (SolrConfigHandler-refreshconf) &lt;span class=&quot;error&quot;&gt;&amp;#91;n:127.0.0.1:52555_cib c:gettingstarted s:shard2 r:core_node2 x:gettingstarted_shard2_replica2&amp;#93;&lt;/span&gt; o.a.s.c.ConfigSetProperties Did not find ConfigSet properties, assuming default properties: Can&apos;t find resource &apos;configsetprops.json&apos; in classpath or &apos;/configs/gettingstarted&apos;, cwd=/Users/Erick/apache/solr/beast-tmp/3/J0&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; 50808 INFO  (SolrConfigHandler-refreshconf) &lt;span class=&quot;error&quot;&gt;&amp;#91;n:127.0.0.1:52555_cib c:gettingstarted s:shard2 r:core_node2 x:gettingstarted_shard2_replica2&amp;#93;&lt;/span&gt; o.a.s.c.CoreContainer Reloading SolrCore &apos;gettingstarted_shard2_replica2&apos; using configuration from collection gettingstarted&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; 50808 ERROR (SolrConfigHandler-refreshconf) &lt;span class=&quot;error&quot;&gt;&amp;#91;n:127.0.0.1:52555_cib c:gettingstarted s:shard2 r:core_node2 x:gettingstarted_shard2_replica2&amp;#93;&lt;/span&gt; o.a.s.h.SolrConfigHandler Unable to refresh conf &lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; org.apache.solr.common.SolrException: Unable to reload core &lt;span class=&quot;error&quot;&gt;&amp;#91;gettingstarted_shard2_replica2&amp;#93;&lt;/span&gt;&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt;  at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:837)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt;  at org.apache.solr.core.SolrCore$11.run(SolrCore.java:2602)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt;  at org.apache.solr.handler.SolrConfigHandler$Command$1.run(SolrConfigHandler.java:212)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt; Caused by: java.lang.IllegalStateException: IndexWriter has been closed&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt;  at org.apache.solr.update.SolrCoreState.increfSolrCoreState(SolrCoreState.java:53)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt;  at org.apache.solr.core.SolrCore.reload(SolrCore.java:462)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;   2&amp;gt;  at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:832)&lt;/p&gt;

</comment>
                            <comment id="14965162" author="markrmiller@gmail.com" created="Tue, 20 Oct 2015 14:21:42 +0000"  >&lt;p&gt;Thanks Erick, looks like a reload is somehow triggering after the core is already closed?&lt;/p&gt;</comment>
                            <comment id="14965275" author="erickerickson" created="Tue, 20 Oct 2015 15:44:29 +0000"  >&lt;p&gt;An 80 iteration beast of the test ran fine last night with this patch. And yes, I did remove the badapple notation.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty convinced this is &lt;em&gt;not&lt;/em&gt; the right fix though, it just helps identify the problem area.&lt;/p&gt;</comment>
                            <comment id="14965288" author="erickerickson" created="Tue, 20 Oct 2015 15:55:31 +0000"  >&lt;p&gt;Mark:&lt;/p&gt;

&lt;p&gt;That&apos;s my assumption, got a full day today so can&apos;t do anything on it until at least this evening though.&lt;/p&gt;</comment>
                            <comment id="15129334" author="thelabdude" created="Tue, 2 Feb 2016 23:27:02 +0000"  >&lt;p&gt;I can fix the test to wait longer after it issues a config change but that will mask a race condition that the SolrConfigHandler refreshconf thread attempts to refresh a core that is being shutdown down.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   [junit4]   2&amp;gt; 42606 INFO  (qtp1036148039-29) [n:127.0.0.1:58528_    ] o.a.s.c.SolrCore [gettingstarted_shard1_replica1]  CLOSING SolrCore org.apache.solr.core.SolrCore@53fda895
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then later in the log, you have: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   [junit4]   2&amp;gt; 42629 INFO  (SolrConfigHandler-refreshconf) [n:127.0.0.1:58528_ c:gettingstarted s:shard1 r:core_node4 x:gettingstarted_shard1_replica1] o.a.s.c.ConfigSetProperties Did not find ConfigSet properties, assuming &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; properties: Can&lt;span class=&quot;code-quote&quot;&gt;&apos;t find resource &apos;&lt;/span&gt;configsetprops.json&lt;span class=&quot;code-quote&quot;&gt;&apos; in classpath or &apos;&lt;/span&gt;/configs/gettingstarted&apos;, cwd=/home/hossman/lucene/dev/solr/build/solr-core/test/J0
   [junit4]   2&amp;gt; 42629 INFO  (SolrConfigHandler-refreshconf) [n:127.0.0.1:58528_ c:gettingstarted s:shard1 r:core_node4 x:gettingstarted_shard1_replica1] o.a.s.c.CoreContainer Reloading SolrCore &lt;span class=&quot;code-quote&quot;&gt;&apos;gettingstarted_shard1_replica1&apos;&lt;/span&gt; using configuration from collection gettingstarted
   [junit4]   2&amp;gt; 42630 ERROR (SolrConfigHandler-refreshconf) [n:127.0.0.1:58528_ c:gettingstarted s:shard1 r:core_node4 x:gettingstarted_shard1_replica1] o.a.s.h.SolrConfigHandler Unable to refresh conf
   [junit4]   2&amp;gt; org.apache.solr.common.SolrException: Unable to reload core [gettingstarted_shard1_replica1]
   [junit4]   2&amp;gt;        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:837)
   [junit4]   2&amp;gt;        at org.apache.solr.core.SolrCore$11.run(SolrCore.java:2602)
   [junit4]   2&amp;gt;        at org.apache.solr.handler.SolrConfigHandler$Command$1.run(SolrConfigHandler.java:212)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see some checks for whether the core is closed, so maybe there&apos;s nothing we can do better to detect this race condition, but would appreciate if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; could take a closer look at the checks? If not, the only fix here is to wait longer for the config changes to take effect before issuing the delete.&lt;/p&gt;</comment>
                            <comment id="15129380" author="thelabdude" created="Tue, 2 Feb 2016 23:57:33 +0000"  >&lt;p&gt;The other interesting thing to note is that the SolrConfigHandler does try to wait up to 30 seconds for agreement across all cores, but that does not mean the config has been applied on all cores, apparently. For instance, in the log you see:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   [junit4]   2&amp;gt; 41864 INFO  (qtp1735783147-155) [n:127.0.0.1:35628_ c:gettingstarted s:shard2 r:core_node1 x:gettingstarted_shard2_replica2] o.a.s.h.SolrConfigHandler Took 905.0ms to set the property overlay to be of version 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; collection gettingstarted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But there is still config loading activity going on in the cores after this point, so that wait is somewhat misleading. I still think the fix here is to have the test wait longer before issuing the delete, but we should also revisit whether the SolrConfigHandler can do better at detecting a core is shutting down?&lt;/p&gt;</comment>
                            <comment id="15129422" author="thelabdude" created="Wed, 3 Feb 2016 00:16:04 +0000"  >&lt;p&gt;Chatting with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman_lucene%40fucit.org&quot; class=&quot;user-hover&quot; rel=&quot;hossman_lucene@fucit.org&quot;&gt;hossman_lucene@fucit.org&lt;/a&gt;, it seems like the SolrConfigHandler should be able to leverage the CloseHook support in SolrCore to be able to detect a core is being closed and stop its attempts at refreshing config.&lt;/p&gt;

&lt;p&gt;Moreover, as I thought about the previous comment some more, I actually think the true bug here is the config handler returns before the config change has been applied (it seems from the log anyway) ... not sure why anyone would want a config update request to return to them before the change has been applied across the cluster? Seems hard for a client app to reason about whether a change is fully applied or not with the way things are w/o adding arbitrary waits, which would just be a bandaid in the SolrCloudExampleTest.&lt;/p&gt;</comment>
                            <comment id="15129987" author="noble.paul" created="Wed, 3 Feb 2016 07:57:42 +0000"  >&lt;p&gt;Diagnosis: This happens because of a race condition. We have multiple threads in parallel that invoked an unload/or reload. Race condition caused one of the threads to fail. In our code any failure in reload() would put this core as a permanent failure. It is not a failure , it is just that two threads simultaneously tried to perform the reload/unload. &lt;/p&gt;

&lt;p&gt;Solution: We need to handle this Exception differently . So I just created a new Exception called &lt;tt&gt;CoreIsClosedException&lt;/tt&gt; this wouldn&apos;t add the core to permanently failed cores as &lt;tt&gt;IndexWriter has been closed&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Follow Question up for others : If I&apos;m trying to perform a reload and it fails , should we retry?&lt;/p&gt;</comment>
                            <comment id="15130645" author="erickerickson" created="Wed, 3 Feb 2016 16:36:46 +0000"  >&lt;p&gt;I can reasonably reliably get this to fail over night (14 out of 1,000) with the following error, so let me know if there&apos;s a patch I can try:&lt;/p&gt;

&lt;p&gt;&amp;gt; Throwable #1: java.lang.AssertionError: Delete action failed!&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;    &amp;gt; 	at __randomizedtesting.SeedInfo.seed(&lt;span class=&quot;error&quot;&gt;&amp;#91;ECD502B89BFAF991:FFB630D7AA954037&amp;#93;&lt;/span&gt;:0)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;    &amp;gt; 	at org.apache.solr.cloud.SolrCloudExampleTest.doTestDeleteAction(SolrCloudExampleTest.java:171)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;    &amp;gt; 	at org.apache.solr.cloud.SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection(SolrCloudExampleTest.java:147)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsFixedStatement.callStatement(BaseDistributedSearchTestCase.java:965)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;    &amp;gt; 	at org.apache.solr.BaseDistributedSearchTestCase$ShardsRepeatRule$ShardsStatement.evaluate(BaseDistributedSearchTestCase.java:940)&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;junit4&amp;#93;&lt;/span&gt;    &amp;gt; 	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</comment>
                            <comment id="15130774" author="erickerickson" created="Wed, 3 Feb 2016 17:59:06 +0000"  >&lt;p&gt;This feels a little like a band-aid. If I&apos;m reading this right, the sequence is this:&lt;/p&gt;

&lt;p&gt;1&amp;gt; the test changes the configs, kicking off reloads for the cores&lt;br/&gt;
2&amp;gt; the test deletes the collection&lt;/p&gt;

&lt;p&gt;&amp;lt;2&amp;gt; happens before &amp;lt;1&amp;gt; is complete, thus the race as the reload doesn&apos;t get around to reloading the core after the delete happens and the core is closed. Is this about right?&lt;/p&gt;

&lt;p&gt;Tim&apos;s comment about a delay suggests that if we waited for the config changes to complete reloading before continuing the test we&apos;d be OK. It seems like a better option would be to have Solr not start the delete while reloads were pending. Or more generally not start carrying out one command while another potentially conflicting operation was being carried.&lt;/p&gt;

&lt;p&gt;Not sure how hard having Solr be smart enough to delay &quot;potentially conflicting&quot; operations would be though.&lt;/p&gt;</comment>
                            <comment id="15131652" author="noble.paul" created="Thu, 4 Feb 2016 03:23:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;This feels a little like a band-aid. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Erick, I&apos;m not trying to make this test pass. This is a more serious issue. A race condition should not put a core in an unrecoverable error situation. This would cause SolrCloud to lose replicas randomly. I&apos;m surprised users have not experienced it yet . So, this fix must be done anyway. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Tim&apos;s comment about a delay suggests that if we waited for the config changes to complete reloading before continuing the test we&apos;d be OK&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That is fine if you wish to just avoid hitting the race condition. But in this case we should be glad that this test has uncovered a race condition&lt;/p&gt;</comment>
                            <comment id="15131762" author="erickerickson" created="Thu, 4 Feb 2016 05:33:02 +0000"  >&lt;p&gt;Noble:&lt;/p&gt;

&lt;p&gt;Well, perhaps I phrased things poorly, so let&apos;s start over and not even consider the test.&lt;/p&gt;

&lt;p&gt;bq: A race condition should not put a core in an unrecoverable error situation&lt;/p&gt;

&lt;p&gt;Totally agree. If I understand the patch though, the reload operation and the delete operation are competing. In this particular case the reload was caused by changing the configs, but that&apos;s largely immaterial. The delete got in there before the reload operation and closed the core. What happens with throwing this new exception is that the reload operation still fails in the sense that the core is still unavailable right? I don&apos;t quite see how throwing a new exception and catching it but not adding it to the failures list changes the fact that the core failed to reload; it&apos;s still unavailable. How does it ever recover?&lt;/p&gt;

&lt;p&gt;Or are you saying that in this case, since the core is deleted it really doesn&apos;t &lt;em&gt;need&lt;/em&gt; to recover? That still doesn&apos;t seem to cover the general case of the core being closed during a reload operation. There&apos;s a comment somewhere in the code that perhaps the reload should be retried. It&apos;ll still fail in this case, but are there others where reloading will succeed and thus we should retry?&lt;/p&gt;

&lt;p&gt;All that said, it&apos;ll be at least tomorrow night before I can beast this patch....&lt;/p&gt;


</comment>
                            <comment id="15131772" author="noble.paul" created="Thu, 4 Feb 2016 05:42:35 +0000"  >&lt;p&gt;the CoreContainer.coreInitFailures is a map which is intended to track a core that  has failed to load, most likely due to unrecoverable errors (such as index corruption).  This prevents other operations as well (such as delete) because any operation involving that core would consult this map  .A race condition is not unrecoverable. Imagine the race condition didn&apos;t occur, the core would not have been entered into this unrecoverable list and that is the expected behavior &lt;/p&gt;</comment>
                            <comment id="15189592" author="erickerickson" created="Thu, 10 Mar 2016 17:26:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; Should we commit this? I just beasted this for 1,00 runs last night. I saw some failures, but they were either &quot;zombie threads&quot; or &quot;suite timeout exceeded&quot; which I don&apos;t think are relevant to this code.&lt;/p&gt;</comment>
                            <comment id="15189597" author="noble.paul" created="Thu, 10 Mar 2016 17:30:55 +0000"  >&lt;p&gt;it surely would have avoided the failures. I was asking for a second opinion from others to review the code and confirm there are no unintended consequences.&lt;/p&gt;

&lt;p&gt;I guess we should commit this and get this into 6.0 anyway&lt;/p&gt;</comment>
                            <comment id="15189786" author="jira-bot" created="Thu, 10 Mar 2016 19:20:09 +0000"  >&lt;p&gt;Commit 8cc978b53b1299a27de492d7114cd2d4e353b6cb in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8cc978b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8cc978b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&lt;/p&gt;</comment>
                            <comment id="15189794" author="jira-bot" created="Thu, 10 Mar 2016 19:24:08 +0000"  >&lt;p&gt;Commit 6689e1c55a7efffadb18d25179d9d87c121af5d0 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6689e1c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6689e1c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&lt;/p&gt;</comment>
                            <comment id="15189795" author="jira-bot" created="Thu, 10 Mar 2016 19:24:09 +0000"  >&lt;p&gt;Commit 96b059c9dd67eef3a49da63d388fac7f4d3809f2 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=96b059c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=96b059c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&lt;/p&gt;</comment>
                            <comment id="15189801" author="jira-bot" created="Thu, 10 Mar 2016 19:27:44 +0000"  >&lt;p&gt;Commit 4a795ee371c1bb19285cca0fb7336807f6e2840f in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4a795ee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4a795ee&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: typo in comment&lt;/p&gt;</comment>
                            <comment id="15189807" author="jira-bot" created="Thu, 10 Mar 2016 19:29:31 +0000"  >&lt;p&gt;Commit 72f6261f55b6d851d071c8358a05b52e019416c9 in lucene-solr&apos;s branch refs/heads/branch_6_0 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=72f6261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=72f6261&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&lt;/p&gt;</comment>
                            <comment id="15189808" author="jira-bot" created="Thu, 10 Mar 2016 19:29:33 +0000"  >&lt;p&gt;Commit d3f310a18d3c7787219515e82b76d18ef6a8e050 in lucene-solr&apos;s branch refs/heads/branch_6_0 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d3f310a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d3f310a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&lt;/p&gt;</comment>
                            <comment id="15189809" author="jira-bot" created="Thu, 10 Mar 2016 19:29:34 +0000"  >&lt;p&gt;Commit a774273c641b7f95b09da9440ef43f24f5207584 in lucene-solr&apos;s branch refs/heads/branch_6_0 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a774273&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a774273&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8135&quot; title=&quot;SolrCloudExampleTest.testLoadDocsIntoGettingStartedCollection reproducible failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8135&quot;&gt;&lt;del&gt;SOLR-8135&lt;/del&gt;&lt;/a&gt;: typo in comment&lt;/p&gt;</comment>
                            <comment id="15279243" author="hossman" created="Tue, 10 May 2016 23:44:26 +0000"  >&lt;p&gt;Manually correcting fixVersion per Step #S6 of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-7271&quot; title=&quot;Cleanup jira&amp;#39;s concept of &amp;#39;master&amp;#39; and &amp;#39;6.0&amp;#39;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-7271&quot;&gt;&lt;del&gt;LUCENE-7271&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12903200">SOLR-8142</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12765283" name="SOLR-8135.failure.log" size="937487" author="hossman" created="Tue, 6 Oct 2015 23:27:37 +0000"/>
                            <attachment id="12785982" name="SOLR-8135.patch" size="5137" author="noble.paul" created="Wed, 3 Feb 2016 07:57:42 +0000"/>
                            <attachment id="12767506" name="SOLR-8135.patch" size="2036" author="erickerickson" created="Tue, 20 Oct 2015 00:44:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mnxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>