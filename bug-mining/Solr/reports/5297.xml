<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:12:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17804] CrossDC Consumer tries to reuse an already closed SolrClient</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17804</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When network is down for a while a CloudSolrClient used by the Consumer application becomes unusable because its ZkClientStateProvider gets closed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
272746 ERROR (KafkaCrossDcConsumerWorker) [n: c:ab-test s: r: x: t:] o.a.s.c.m.SolrMessageProcessor Unable to connect to solr server. Not consuming.                                                                                                    
          =&amp;gt; org.apache.solr.common.AlreadyClosedException                                                                                                                                                                                                  
    at org.apache.solr.client.solrj.impl.ZkClientClusterStateProvider.getZkStateReader(ZkClientClusterStateProvider.java:222)                                                                                                                               
org.apache.solr.common.AlreadyClosedException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;                                                                                                                                                                                                         
    at org.apache.solr.client.solrj.impl.ZkClientClusterStateProvider.getZkStateReader(ZkClientClusterStateProvider.java:222)                                                                                          
    at org.apache.solr.client.solrj.impl.ZkClientClusterStateProvider.connect(ZkClientClusterStateProvider.java:217)                                                                                                 
    at org.apache.solr.client.solrj.impl.CloudSolrClient.connect(CloudSolrClient.java:364)                                                                                  
    at org.apache.solr.crossdc.messageprocessor.SolrMessageProcessor.connectToSolrIfNeeded(SolrMessageProcessor.java:363)                                                                                             
    at org.apache.solr.crossdc.messageprocessor.SolrMessageProcessor.handleItem(SolrMessageProcessor.java:74)                                                                                                        
    at org.apache.solr.crossdc.consumer.KafkaCrossDcConsumer.lambda$sendBatch$2(KafkaCrossDcConsumer.java:375)                                                                                                       
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) [?:?]                                                                                                                                                                        
    at java.util.concurrent.FutureTask.run(FutureTask.java:264) [?:?]                                                                                                                                                                                       
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]                                                                                                                                                                
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]                                                                                                                                                                
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) [?:?] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The Consumer keeps trying to use this client instance, which results in multiple errors and no recovery without restarting the Consumer application.&lt;/p&gt;

&lt;p&gt;The immediate fix is for the Consumer to try to recover from this state by re-creating the SolrClient.&lt;/p&gt;

&lt;p&gt;A broader question (to address in another ticket) is what should be the proper behavior of CloudSolrClient when its ClusterStateProvider gets closed - IMHO the client should be closed too.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13622150">SOLR-17804</key>
            <summary>CrossDC Consumer tries to reuse an already closed SolrClient</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 30 Jun 2025 13:58:35 +0000</created>
                <updated>Mon, 28 Jul 2025 15:33:09 +0000</updated>
                            <resolved>Fri, 11 Jul 2025 09:30:24 +0000</resolved>
                                    <version>9.8.1</version>
                                    <fixVersion>9.9.0</fixVersion>
                                    <component>module - crossDC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17987993" author="hossman" created="Wed, 2 Jul 2025 21:40:02 +0000"  >&lt;p&gt;some concerns after skimming your branch...&lt;/p&gt;
&lt;hr /&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicReference&amp;lt;CloudSolrClient&amp;gt; solrClientRef = ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m a little concerned that future devs might accidentally use &lt;tt&gt;solrClientRef&lt;/tt&gt; directly (w/o going through the Supplier) since it&apos;s got protected scope in the &lt;tt&gt;KafkaCrossDcConsumer&lt;/tt&gt; class &#8211; it would be safer to encapsulate it inside the Supplier so no other code in this class can access it&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (existingClient != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; existingClient.getClusterStateProvider().isClosed()) {
                  log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;- re-creating Solr client because the previous one was closed&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
	&lt;li&gt;this comment is missleading &#8211; we don&apos;t know that the previous Solr client was closed &#8211; we only know that the previous client&apos;s cluster state provider was closed&lt;/li&gt;
	&lt;li&gt;AFAICT if we go dow this code path, nothing ever ensures that &lt;tt&gt;existingClient&lt;/tt&gt; gets closed &#8211; so it will leak it&apos;s internals (including the Executor inside the underlying &lt;tt&gt;LBSolrClient&lt;/tt&gt;
	&lt;ol&gt;
		&lt;li&gt;the test where you confirm we get a new client when the state reader is closed should also confirm the old client gets closed&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;This alternate code path (used to create the very first client) ...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (solrClientRef) {
              CloudSolrClient newClient = createSolrClient(conf);
              solrClientRef.set(newClient);
              &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newClient;
            }
          } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...is missing the &quot;double check&quot; inside the sync block (to see if &lt;tt&gt;solrClientRef.get()&lt;/tt&gt; is &lt;em&gt;still&lt;/em&gt; null)&lt;/p&gt;

&lt;p&gt;Which means if thread-2 is waiting to enter that sync block because thread-1 is already in it, thread-2 won&apos;t notice that thread-1 already called &lt;tt&gt;createSolrClient(...)&lt;/tt&gt; and we&apos;ll leak another CloudSolrCLient&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think if we change the &lt;tt&gt;Supplier&lt;/tt&gt; to something like...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; ClientSupplier &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Supplier&amp;lt;CloudSolrClient&amp;gt; {
  &lt;span class=&quot;code-comment&quot;&gt;// call &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method in the places that currently call IOUtils.closeQuietly(solrClientRef.get()) directly
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void quietCloseClient();
}
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClientSupplier solrClientSupplier;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... then we can do something like...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
solrClientSupplier = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClientSupplier() {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicRefrence&amp;lt;CloudSolrClient&amp;gt; solrClientRef = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicRefrence(createSolrClient(conf));
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CloudSolrClient get() {
    CloudSolrClient existingClient = solrClientRef.get();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (existingClient.getClusterStateProvider().isClosed()) {
      &lt;span class=&quot;code-comment&quot;&gt;// re-open the client &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; CSP was closed
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (solrClientRef) {
        existingClient = solrClientRef.get();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (existingClient.getClusterStateProvider().isClosed()) {
          log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;- re-creating Solr client because it&apos;s CSP is closed&quot;&lt;/span&gt;);
          CloudSolrClient newClient = createSolrClient(conf);
          solrClientRef.set(newClient);
 &#160; &#160; &#160; &#160; &#160;IOUtils.closeQuietly(existingClient);
 &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newClient;
        }
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; existingClient;
  }
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void quietCloseClient() {
 &#160; &#160;IOUtils.closeQuietly(solrClientRef.get())
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;..and completely protect the &lt;tt&gt;solrClientRef&lt;/tt&gt; from miss-use, ensure any &quot;old&quot; client&quot; gets closedwhen no longer in use, and simplify the locking logic.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="18003629" author="houston" created="Mon, 7 Jul 2025 21:53:40 +0000"  >&lt;p&gt;To me it would make sense to instead of fixing this in the consumer code, fix the CloudSolrClient to recreate the cluster state provider if it has been closed...&lt;/p&gt;</comment>
                            <comment id="18003705" author="ab" created="Tue, 8 Jul 2025 09:10:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt; I&apos;d like to include the fix for this bug in 9.9. I agree that fixing the client is ultimately the right path but I&apos;m not sure of the impact - checking for the ZKStateReader state and re-opening it will require additional synchronization, which may affect performance.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; I updated the PR based on your suggestions.&lt;/p&gt;</comment>
                            <comment id="18004113" author="jira-bot" created="Wed, 9 Jul 2025 11:40:39 +0000"  >&lt;p&gt;Commit 623159d3e6c81e4b36f297dc7bd0174518076692 in solr&apos;s branch refs/heads/main from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=623159d3e6c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=623159d3e6c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17804&quot; title=&quot;CrossDC Consumer tries to reuse an already closed SolrClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17804&quot;&gt;&lt;del&gt;SOLR-17804&lt;/del&gt;&lt;/a&gt;: re-create SolrClient if closed. (#3411)&lt;/p&gt;
</comment>
                            <comment id="18004634" author="jira-bot" created="Fri, 11 Jul 2025 08:29:17 +0000"  >&lt;p&gt;Commit d9c7d485b97bbbb798388ab82b535bc5eeaed983 in solr&apos;s branch refs/heads/branch_9x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=d9c7d485b97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=d9c7d485b97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17804&quot; title=&quot;CrossDC Consumer tries to reuse an already closed SolrClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17804&quot;&gt;&lt;del&gt;SOLR-17804&lt;/del&gt;&lt;/a&gt;: re-create SolrClient if closed. (#3424)&lt;/p&gt;
</comment>
                            <comment id="18004635" author="jira-bot" created="Fri, 11 Jul 2025 08:30:13 +0000"  >&lt;p&gt;Commit 51300844f8b7a98ccb60631b693063bd50bd9dd8 in solr&apos;s branch refs/heads/branch_9_9 from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=51300844f8b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=51300844f8b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17804&quot; title=&quot;CrossDC Consumer tries to reuse an already closed SolrClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17804&quot;&gt;&lt;del&gt;SOLR-17804&lt;/del&gt;&lt;/a&gt;: re-create SolrClient if closed. (#3425)&lt;/p&gt;
</comment>
                            <comment id="18009725" author="houston" created="Thu, 24 Jul 2025 22:50:52 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wjkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>