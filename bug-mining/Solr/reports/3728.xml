<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:29:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11590] Synchronize ZK connect/disconnect handling</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11590</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Here is a sequence of 2 disconnects and re-connects&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1. 2017-10-31T08:34:23.106-0700 Watcher org.apache.solr.common.cloud.ConnectionManager@1579ca20 name:ZooKeeperConnection Watcher:host:port got event WatchedEvent state:Disconnected type:None path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; type:None
2. 2017-10-31T08:34:23.106-0700 zkClient has disconnected
3. 2017-10-31T08:34:23.107-0700 Watcher org.apache.solr.common.cloud.ConnectionManager@1579ca20 name:ZooKeeperConnection Watcher:host:port got event WatchedEvent state:SyncConnected type:None path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; type:None
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1. 2017-10-31T08:36:46.541-0700 Watcher org.apache.solr.common.cloud.ConnectionManager@1579ca20 name:ZooKeeperConnection Watcher:host:port got event WatchedEvent state:Disconnected type:None path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; type:None
2. 2017-10-31T08:36:46.549-0700 Watcher org.apache.solr.common.cloud.ConnectionManager@1579ca20 name:ZooKeeperConnection Watcher:host:port got event WatchedEvent state:SyncConnected type:None path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; path:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; type:None
2. 2017-10-31T08:36:46.563-0700 zkClient has disconnected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the first disconnect the sequence is -  get disconnect watcher, execute disconnect code, execute connect code&lt;br/&gt;
In the second disconnect the sequence is - get disconnect watcher, execute connect code, execute disconnect code&lt;/p&gt;

&lt;p&gt;In the second sequence of events, if the JVM has leader replicas then all updates start failing with &quot;Cannot talk to ZooKeeper - Updates are disabled.&quot; . This starts happening exactly after 27 seconds ( zk client timeout is 30s , 90% of 30 = 27 - when the code thinks the session is likely expired). No leadership changes since there was no session expiry. Unless you restart the node all updates to the system continue to fail.&lt;/p&gt;

&lt;p&gt;These log lines correspond are from Solr 5.3 hence where the WatchedEvent was still being logged as INFO&lt;/p&gt;

&lt;p&gt;We process the connect code and then process the disconnect code out of order based on the log ordering. The connection is active but the flag is not set and hence after 27 seconds &lt;tt&gt;zkCheck&lt;/tt&gt; starts complaining that the connection is likely expired&lt;/p&gt;

&lt;p&gt;A related Jira is &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5721&quot; title=&quot;ConnectionManager can become stuck in likeExpired&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5721&quot;&gt;&lt;del&gt;SOLR-5721&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ZK gives us ordered watch events ( &lt;a href=&quot;https://zookeeper.apache.org/doc/r3.4.8/zookeeperProgrammers.html#sc_WatchGuarantees&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zookeeper.apache.org/doc/r3.4.8/zookeeperProgrammers.html#sc_WatchGuarantees&lt;/a&gt; ) but from what I understand Solr can still process them out of order. We could take a lock and synchronize &lt;tt&gt;ConnectionManager#connected&lt;/tt&gt; and &lt;tt&gt;ConnectionManager#disconnected&lt;/tt&gt; . &lt;/p&gt;

&lt;p&gt;Would that be the right approach to take?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13115302">SOLR-11590</key>
            <summary>Synchronize ZK connect/disconnect handling</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="varun">Varun Thacker</assignee>
                                    <reporter username="varun">Varun Thacker</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Nov 2017 07:10:48 +0000</created>
                <updated>Thu, 21 Nov 2019 00:41:37 +0000</updated>
                            <resolved>Tue, 5 Dec 2017 22:27:48 +0000</resolved>
                                                    <fixVersion>7.2</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16236419" author="varunthacker" created="Thu, 2 Nov 2017 19:19:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6261&quot; title=&quot;Run ZK watch event callbacks in parallel to the event thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6261&quot;&gt;&lt;del&gt;SOLR-6261&lt;/del&gt;&lt;/a&gt; is another Jira that&apos;s relevant here. We added a thread pool to execute the watch event callbacks&lt;/p&gt;</comment>
                            <comment id="16237213" author="noble.paul" created="Fri, 3 Nov 2017 07:38:32 +0000"  >&lt;p&gt;If &lt;tt&gt;disconnected&lt;/tt&gt;  and &lt;tt&gt;connected&lt;/tt&gt; events are processed in different order, it can lead to a wrong state. So, it makes sense to process them in a special single thread factory instead of the general threadpool&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dragonsinth&quot; class=&quot;user-hover&quot; rel=&quot;dragonsinth&quot;&gt;dragonsinth&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16238276" author="dragonsinth" created="Fri, 3 Nov 2017 19:55:54 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="16240506" author="varunthacker" created="Mon, 6 Nov 2017 16:21:59 +0000"  >&lt;p&gt;Small update to the patch. I took the previous patch and added an additional logging statement to ConnectionManager&lt;/p&gt;</comment>
                            <comment id="16279286" author="jira-bot" created="Tue, 5 Dec 2017 22:25:42 +0000"  >&lt;p&gt;Commit 2c14b91418b45c42aba98ea2e612e9c0a53a0948 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2c14b91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2c14b91&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11590&quot; title=&quot;Synchronize ZK connect/disconnect handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11590&quot;&gt;&lt;del&gt;SOLR-11590&lt;/del&gt;&lt;/a&gt;: Synchronize ZK connect/disconnect handling so that they are processed in linear order&lt;/p&gt;</comment>
                            <comment id="16279288" author="jira-bot" created="Tue, 5 Dec 2017 22:26:41 +0000"  >&lt;p&gt;Commit 5c10ec49af582d83422266b7357f0b50023b939b in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5c10ec4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5c10ec4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11590&quot; title=&quot;Synchronize ZK connect/disconnect handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11590&quot;&gt;&lt;del&gt;SOLR-11590&lt;/del&gt;&lt;/a&gt;: Synchronize ZK connect/disconnect handling so that they are processed in linear order&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2c14b91)&lt;/p&gt;</comment>
                            <comment id="16279289" author="varunthacker" created="Tue, 5 Dec 2017 22:27:48 +0000"  >&lt;p&gt;Thanks Scott and Noble!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12896212" name="SOLR-11590.patch" size="3069" author="varun" created="Mon, 6 Nov 2017 16:21:14 +0000"/>
                            <attachment id="12895958" name="SOLR-11590.patch" size="1726" author="noble.paul" created="Fri, 3 Nov 2017 20:26:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3m993:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>