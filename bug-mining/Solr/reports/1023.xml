<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:29:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3699] SolrIndexWriter constructor leaks Directory if Exception creating IndexWriterConfig</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3699</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-4278&quot; title=&quot;Tests no longer check directories are closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-4278&quot;&gt;&lt;del&gt;LUCENE-4278&lt;/del&gt;&lt;/a&gt; i had to add a hack to force SimpleFSDir for CoreContainerCoreInitFailuresTest, because it doesnt close its Directory on certain errors.&lt;/p&gt;

&lt;p&gt;This might indicate a problem that leaks happen if certain errors happen (e.g. not handled in finally)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12600942">SOLR-3699</key>
            <summary>SolrIndexWriter constructor leaks Directory if Exception creating IndexWriterConfig</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Aug 2012 01:07:31 +0000</created>
                <updated>Fri, 10 May 2013 10:33:36 +0000</updated>
                            <resolved>Fri, 7 Sep 2012 22:13:59 +0000</resolved>
                                                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13427429" author="hossman" created="Thu, 2 Aug 2012 16:34:27 +0000"  >&lt;p&gt;Tracked the problem down to SolrIndexWriter ... attached patch demonstrates it in the simplest usecase: a SolrCore that constructs a SolrIndexWriter where the Directory is created fine, but then the IndexWriterConfig has a problem.&lt;/p&gt;

&lt;p&gt;Unfortunately there&apos;s no clear and easy route to a fix because of how this is all done inline in a call to &lt;tt&gt;super(...)&lt;/tt&gt; ... as noted in the test comments...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testBogusMergePolicy() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-comment&quot;&gt;// Directory is leaked because SolrIndexWriter constructor has inline 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// calls to both DirectoryFactory (which succeeds) and 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Config.toIndexWriterConfig (which fails) -- but there is nothing to 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// decref the DerectoryFactory when Config &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; an Exception
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Not good to require the caller of &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrIndexWriter(...)&quot;&lt;/span&gt; to decref 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// the DirectoryFactory on exception, because they would have to be sure 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// the exception didn&apos;t already come from the DirectoryFactory in the first place.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// I think we need to re-work the inline calls in SolrIndexWriter construct&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(Ironically: this &quot;bad-mp-config.xml&quot; i was using in CoreContainerCoreInitFailuresTest has existed for a while, but wasn&apos;t already being used in the &quot;TestBadConfig&quot; class that tries to create SolrCores with bad cofigs &amp;#8211; if it had we would have caught this a long time ago.  It was only being used in SolrIndexConfigTest where it was micro testing the SolrIndexConfig and the DirectoryFactory wasn&apos;t used)&lt;/p&gt;</comment>
                            <comment id="13427612" author="hossman" created="Thu, 2 Aug 2012 21:09:57 +0000"  >&lt;p&gt;My quick and dirty attempt to fix this by making SolrIndexWriter&apos;s constructor private and adding a static &quot;create&quot; method that deals with calling directoryFactory.release() if the private constructor fails.&lt;/p&gt;

&lt;p&gt;Unfortunately it&apos;s still not working ... not clear to me why, but i&apos;m about to get on a plain and won&apos;t have a chance to dig into it anymore for another 3-4 days, so i wanted to get what i have into Jira in case anyone else wants to take a stab at it.&lt;/p&gt;</comment>
                            <comment id="13429845" author="rcmuir" created="Tue, 7 Aug 2012 03:43:32 +0000"  >&lt;p&gt;rmuir20120906-bulk-40-change&lt;/p&gt;</comment>
                            <comment id="13429904" author="hossman" created="Tue, 7 Aug 2012 03:51:53 +0000"  >&lt;p&gt;Figured out the problem in my last patch: i was ignorant of the full DirectoryFactory API and didn&apos;t realize i should be calling doneWithDirectory().&lt;/p&gt;

&lt;p&gt;I think this new patch is good to go, but i don&apos;t want to commit w/o review from someone who understands the DirectoryFactory semantics better (already opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3717&quot; title=&quot;DirectoryFactory.close() is never called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3717&quot;&gt;&lt;del&gt;SOLR-3717&lt;/del&gt;&lt;/a&gt; because something looks wonky about the API, don&apos;t want to mess up and just fix a symptom here instead of the real problem&lt;/p&gt;</comment>
                            <comment id="13429910" author="hossman" created="Tue, 7 Aug 2012 03:57:54 +0000"  >&lt;p&gt;Mark: can you sanity check this patch for me?&lt;/p&gt;</comment>
                            <comment id="13444414" author="hossman" created="Wed, 29 Aug 2012 21:03:22 +0000"  >&lt;p&gt;updated patch to trunk.&lt;/p&gt;

&lt;p&gt;Doing this helped uncover another (distinct) case where directories were not being closed that was exposed by the test &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3746&quot; title=&quot;updateLog should fail to init if there is no _version_ field in schema.xml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3746&quot;&gt;&lt;del&gt;SOLR-3746&lt;/del&gt;&lt;/a&gt; added: if the updateHandler fails to init, then nothing in SolrCore was closing the directoryfactory.&lt;/p&gt;

&lt;p&gt;I&apos;d asked miller to review this earlier, but i&apos;m going to assume CTR soon unless i hear objections.&lt;/p&gt;</comment>
                            <comment id="13444959" author="markrmiller@gmail.com" created="Thu, 30 Aug 2012 13:48:59 +0000"  >&lt;p&gt;hmm...I have to look closer than just at the patch, but the setDirFactory method seems a little troubling - why do we do that instead of making it part of the constructor? What if you don&apos;t set it?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != directoryFactory) {
+          &lt;span class=&quot;code-comment&quot;&gt;// :HACK: normally we rely on updateHandler to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, 
&lt;/span&gt;+          &lt;span class=&quot;code-comment&quot;&gt;// but what &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; updateHandler failed to init?
&lt;/span&gt;+          directoryFactory.close();
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t think you want that? The dir factory should and will be closed by the DefaultSolrCoreState when it&apos;s ref count hits 0 - you don&apos;t actually want to close it when closing a core.&lt;/p&gt;

&lt;p&gt;Otherwise, the basic idea seems fine - if the IW fails, release it&apos;s dir.&lt;/p&gt;</comment>
                            <comment id="13445009" author="hossman" created="Thu, 30 Aug 2012 15:19:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;the setDirFactory method seems a little troubling - why do we do that instead of making it part of the constructor? What if you don&apos;t set it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you asking about SolrIndexWriter.setDirectoryFactory ?&lt;/p&gt;

&lt;p&gt;it&apos;s private, and called from the (static) SolrIndexWriter.create &amp;#8211; which as of this patch is the only way to get a new SolrIndexWRiter.&lt;/p&gt;

&lt;p&gt;I had to move it out of the SolrIndexWriter constructor, because we need to be able to pass the resulting directory to super() while also releasing the directory if the constructor throws an exception &amp;#8211; this isn&apos;t possible within java&apos;s &quot;calls to super(...) must be the first line of the constructor&quot; constraints, so the static factory method was needed instead.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The dir factory should and will be closed by the DefaultSolrCoreState when it&apos;s ref count hits 0 - you don&apos;t actually want to close it when closing a core.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But the update handler is the only thing keeping track of the SolrCoreState &amp;#8211; if the SolrCore has no UpdateHanlder (ie: because it failed to initialize) then &lt;b&gt;something&lt;/b&gt; needs to close the DirectoryFactory that SolrCore.initDirectoryFactory() already created.&lt;/p&gt;

&lt;p&gt;(Go ahead and try to comment out that &quot;HACK&quot; directoryFactory.close() in the patch &amp;#8211; you&apos;ll see TestBadConfig.testUpdateLogButNoVersionField start failing.  I added that call to ensure that the DirectoryFactory gets closed if any exceptions are thrown between a (successsful) call to initDirectoryFactory() ~L641 of SolrCore and (a success of failure of) createUpdateHandler() ~L707.  Don&apos;t get me wrong, it definitely feels like a hack (hence the comment) but &lt;em&gt;something&lt;/em&gt; needs to account for this situation &amp;#8211; and i wasn&apos;t comfortably completely re-writing/re-ordering the logic in the SolrCore constructor.&lt;/p&gt;
</comment>
                            <comment id="13445047" author="markrmiller@gmail.com" created="Thu, 30 Aug 2012 15:57:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s private,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, okay, did not catch that.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;something needs to close the DirectoryFactory that SolrCore.initDirectoryFactory() already created.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, brain murmur - for some reason I was thinking DirectoryFactory was used globally across cores.&lt;/p&gt;

&lt;p&gt;This is probably fine then. Once I commit some stuff from my workspace, I&apos;ll actually apply the patch and try and consider this some more.&lt;/p&gt;</comment>
                            <comment id="13445143" author="hossman" created="Thu, 30 Aug 2012 18:01:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yeah, brain murmur - for some reason I was thinking DirectoryFactory was used globally across cores.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s only shared between reloaded versions of the same SolrCore (ie: two differnet SolrCore&apos;s can use completley diff DirectoryFactory impls) but even then, it&apos;s only shared if the SolrCore was constructed using an existing UpdateHandler (ie: reload) if the SolrCore is the &quot;first&quot; SolrCore, then it creates the DirectoryFactory, thus if the UpdateHandler doesn&apos;t init properly, that SolrCore needs to close the DirectoryFactory.&lt;/p&gt;

&lt;p&gt;Ideally, a whole metric-shit-load of the SolrCore initialization would be reworked, so thta every type of object (like DirectoryFactory) was only ever inited by one other object (like UpdateHandler) regardless of wether it&apos;s the first create or reload state, ... but i wasn&apos;t really comfortable making that heavy of a change.&lt;/p&gt;</comment>
                            <comment id="13451035" author="hossman" created="Fri, 7 Sep 2012 21:56:15 +0000"  >&lt;p&gt;updated patch to trunk (incorporates the new IndexSplitter class yonik recently added)&lt;/p&gt;

&lt;p&gt;all tests pass, i&apos;m going to press forward with committing so this can get more testing.&lt;/p&gt;</comment>
                            <comment id="13451055" author="hossman" created="Fri, 7 Sep 2012 22:13:59 +0000"  >&lt;p&gt;Committed revision 1382187. - trunk&lt;br/&gt;
Committed revision 1382192. - 4x&lt;/p&gt;</comment>
                            <comment id="13610896" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:42:53 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1382192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1382192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3699&quot; title=&quot;SolrIndexWriter constructor leaks Directory if Exception creating IndexWriterConfig&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3699&quot;&gt;&lt;del&gt;SOLR-3699&lt;/del&gt;&lt;/a&gt;: Fixed some Directory leaks when there were errors during SolrCore or SolrIndexWriter initialization (merge r1382187)&lt;/p&gt;</comment>
                            <comment id="13653973" author="thetaphi" created="Fri, 10 May 2013 10:33:36 +0000"  >&lt;p&gt;Closed after release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12599198">SOLR-3634</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12600934">LUCENE-4278</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12544306" name="SOLR-3699.patch" size="11225" author="hossman" created="Fri, 7 Sep 2012 21:56:15 +0000"/>
                            <attachment id="12542989" name="SOLR-3699.patch" size="10108" author="hossman" created="Wed, 29 Aug 2012 21:03:22 +0000"/>
                            <attachment id="12539416" name="SOLR-3699.patch" size="8613" author="hossman" created="Tue, 7 Aug 2012 03:51:52 +0000"/>
                            <attachment id="12538950" name="SOLR-3699.patch" size="7738" author="hossman" created="Thu, 2 Aug 2012 21:09:57 +0000"/>
                            <attachment id="12538920" name="SOLR-3699.patch" size="2958" author="hossman" created="Thu, 2 Aug 2012 16:34:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243284</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03d4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17561</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>