<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:15:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9377] [subquery] augmenter doesn&apos;t work with RTG on uncommited docs</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9377</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Spinning off from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9314&quot; title=&quot;Add all known transformers to TestRandomFlRTGCloud and fix any bugs found&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9314&quot;&gt;&lt;del&gt;SOLR-9314&lt;/del&gt;&lt;/a&gt;...&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;subquery&amp;#93;&lt;/span&gt;&lt;/tt&gt; DocTransformer can give unexpected results when used with RTG on uncommitted docs.&lt;/p&gt;

&lt;p&gt;Test code demonstrating the problem is being added to TestRandomFlRTGCloud as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9314&quot; title=&quot;Add all known transformers to TestRandomFlRTGCloud and fix any bugs found&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9314&quot;&gt;&lt;del&gt;SOLR-9314&lt;/del&gt;&lt;/a&gt;, but it&apos;s being disabled for now due to this current bug.  As noted in that jira...&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The subquery validation tries to search for all docs with teh same field value as the current doc, asserting that there is always at least 1 match &#8211; but this assertion currently fails ... by the looks of it this is (obviously) because it doesn&apos;t know to to use the realtime seracher re-opened by the RTG ... but based on how the SubQueryAugmenter is implemented, i&apos;m not even certain how to go about it.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12994699">SOLR-9377</key>
            <summary>[subquery] augmenter doesn&apos;t work with RTG on uncommited docs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Aug 2016 20:57:04 +0000</created>
                <updated>Sat, 8 Jun 2019 15:37:55 +0000</updated>
                            <resolved>Tue, 9 Aug 2016 02:52:29 +0000</resolved>
                                                    <fixVersion>6.2</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15408746" author="hossman" created="Fri, 5 Aug 2016 01:26:22 +0000"  >
&lt;p&gt;I spent some time today looking into this and how to &quot;fix&quot; it.&lt;/p&gt;

&lt;p&gt;My initial impression was that &lt;tt&gt;SubQueryAugmenter(Factory)&lt;/tt&gt; was doing more work then it needed to.   It currently creates an &lt;tt&gt;EmbeddedSolrServer(req.getCore())&lt;/tt&gt; and operates at the (solrj) &quot;&lt;tt&gt;QueryRequest&lt;/tt&gt;/&lt;tt&gt;QueryResponse&lt;/tt&gt;&quot; level to execute the &quot;subquery&quot;, pulling back a &lt;tt&gt;SolrDocumentList&lt;/tt&gt; to populate it&apos;s own custom &lt;tt&gt;Result extends ResultContext&lt;/tt&gt; for each document.&lt;/p&gt;

&lt;p&gt;My thinking was, we could bypass &lt;tt&gt;EmbeddedSolrServer&lt;/tt&gt; by just asking the &lt;tt&gt;SolrCore&lt;/tt&gt; to execute a &lt;tt&gt;SolrQueryRequest&lt;/tt&gt; we create directly around the realtime searcher (see below), and then use the &lt;tt&gt;DocList&lt;/tt&gt; from the resulting &lt;tt&gt;SolrQueryResponse&lt;/tt&gt; along w/ the other pieces we&apos;ve accumulated to create a regular old &lt;tt&gt;BasicResultContext&lt;/tt&gt; for each document.  ala...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SubQuerySolrQueryRequest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; SolrQueryRequestBase {
  &lt;span class=&quot;code-comment&quot;&gt;// we&apos;d pass the ResultContext.getSearcher() here, so these queries would have access to the
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// realtime seracher &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we&apos;re used in an RTG request...
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SubQuerySolrQueryRequest(SolrCore core, SolrParams params, RefCounted&amp;lt;SolrIndexSearcher&amp;gt; searcherHolder) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(core, params);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.searcherHolder = searcherHolder;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem with this idea is the &lt;tt&gt;fromIndex&lt;/tt&gt; param that this transformer supports.  It leans heavily on the existing code in &lt;tt&gt;EmbeddedSolrServer.request(...)&lt;/tt&gt; method logic to figure out the correct core to use.  We&apos;d have to refactor/unwind/duplicate some of that in order to operate directly at the &quot;go get a core by name, now execute a SubQuerySolrQueryRequest against it&quot; layer of the abstraction.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Ultimately i&apos;m starting to wonder if the current behavior is actually the best/correct behavior?&lt;/p&gt;

&lt;p&gt;In the test code that lead me to file this bug (see TestRandomFlRTGCloud &amp;amp; SubQueryValidator) the &quot;problems&quot; that arise are because the validation code for the &lt;tt&gt;[subquery]&lt;/tt&gt; I&apos;m using expects (at least) the original document to match the subquery against one of it&apos;s field values &amp;#8211; and when it&apos;s read from the tlog it doesn&apos;t because the realtime searcher is not used.&lt;/p&gt;

&lt;p&gt;Perhaps that&apos;s ok?  Perhaps the only thing that&apos;s really important is that &lt;em&gt;values&lt;/em&gt; from the doc used when building the subquery are accurate, and come from the tlog, and the query itself can (or perhaps &lt;em&gt;MUST&lt;/em&gt;?) still be run against the same currently open searcher as if the user ran that subquery themselves?&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;: do you have any opinions on what we should consider the &quot;correct&quot; behavior in this situation?&lt;/p&gt;</comment>
                            <comment id="15409392" author="mkhludnev" created="Fri, 5 Aug 2016 12:31:56 +0000"  >&lt;p&gt;no comments. &lt;/p&gt;</comment>
                            <comment id="15412751" author="hossman" created="Tue, 9 Aug 2016 00:55:31 +0000"  >

&lt;p&gt;I was working on some javadoc and test fixes to treat it as expected that &lt;tt&gt;[subquery]&lt;/tt&gt; uses the regular searcher for the sub-request, when I uncovered a slightly broader bug that isn&apos;t constrained to uncommited RTG docs &amp;#8211; it can also bite you if you don&apos;t have a documentCache and don&apos;t enableLazyFieldLoading in your configs (the realtime searcher that RTG can use in some cases doesn&apos;t use any caching, and the existing solrconfig-tlog.xml used by the RTG tests doesn&apos;t enableLazyFieldLoading)&lt;/p&gt;

&lt;p&gt;Here&apos;s an example of what this failure looks like...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# start example
$ bin/solr -e techproducts
...

# disable autocommit &amp;amp; lazy field loading
$ curl --data-binary &apos;{&quot;set-property&quot;:{&quot;updateHandler.autoSoftCommit.maxTime&quot;:&quot;-1&quot;},&quot;set-property&quot;:{&quot;query.enableLazyFieldLoading&quot;:false}}&apos; -H &apos;Content-Type: application/json&apos; &apos;http://localhost:8983/solr/techproducts/config&apos;
...

# re-index w/o doing a commit
$ bin/post -commit no -c techproducts example/exampledocs/*.xml
...

# do an RTG that involves:
#  - a function in the fl (so RTG uses a realtime searcher)
#  - a subquery in the fl that refers to field not otherwise included in the fl -- ie: price
#
# ...this will fail because the qubquery execution can&apos;t find a value for &quot;$row.price&quot; so
#    the sub-request query parsing fails
#
$ curl &apos;http://localhost:8983/solr/techproducts/get?indent=true&amp;amp;id=SOLR1000&amp;amp;fl=id,product(popularity,3)&amp;amp;fl=xxx:%5Bsubquery%5D&amp;amp;xxx.q=%7B!field+f=price+v=$row.price%7D&apos;
{
  &quot;error&quot;:{
    &quot;metadata&quot;:[
      &quot;error-class&quot;,&quot;org.apache.solr.common.SolrException&quot;,
      &quot;root-error-class&quot;,&quot;org.apache.solr.common.SolrException&quot;],
    &quot;msg&quot;:&quot;while invoking xxx:[subquery] on doc=SolrDocument{id=stored,indexed,tokenized,omitNorms,indexOptions=DOCS&amp;lt;id:SOLR1000&amp;gt;, _version_=1542133&quot;,
    &quot;code&quot;:400}}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;here&apos;s the same problem demonstrated with a regular search...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# hack to force documentCache to not init properly (no straight forward way to disable via API)
# NOTE: expected to cause errors in log
$ curl --data-binary &apos;{&quot;set-property&quot;:{&quot;query.documentCache.initialSize&quot;:&quot;-1&quot;}}&apos; -H &apos;Content-Type: application/json&apos; &apos;http://localhost:8983/solr/techproducts/config&apos;

# do a simple query that involves:
#  - a subquery in the fl that refers to field not otherwise included in the fl (price)
#
# ...this will fail because the qubquery execution can&apos;t find a value for &quot;$row.price&quot; so
#    the sub-request query parsing fails
$ curl &apos;http://localhost:8983/solr/techproducts/select?indent=true&amp;amp;q=id:SOLR1000&amp;amp;fl=id&amp;amp;fl=xxx:%5Bsubquery%5D&amp;amp;xxx.q=%7B!field+f=price+v=$row.price%7D&apos;
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;response&amp;gt;

&amp;lt;lst name=&quot;error&quot;&amp;gt;
  &amp;lt;lst name=&quot;metadata&quot;&amp;gt;
    &amp;lt;str name=&quot;error-class&quot;&amp;gt;org.apache.solr.common.SolrException&amp;lt;/str&amp;gt;
    &amp;lt;str name=&quot;root-error-class&quot;&amp;gt;org.apache.solr.common.SolrException&amp;lt;/str&amp;gt;
  &amp;lt;/lst&amp;gt;
  &amp;lt;str name=&quot;msg&quot;&amp;gt;while invoking xxx:[subquery] on doc=SolrDocument{id=stored,indexed,tokenized,omitNorms,indexOptions=DOCS&amp;amp;lt;id:SOLR1000&amp;amp;gt;}&amp;lt;/str&amp;gt;
  &amp;lt;int name=&quot;code&quot;&amp;gt;400&amp;lt;/int&amp;gt;
&amp;lt;/lst&amp;gt;
&amp;lt;/response&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;The &quot;right&quot; way to fix this is to have &lt;tt&gt;SubQueryAugmenter.getExtraRequestFields()&lt;/tt&gt; return the list of field names it expects to find in the docs being transformed, but unfortunately I can&apos;t think of any way to identify the list of all &lt;tt&gt;$row.&amp;#42;&lt;/tt&gt; params used in the subquery.&lt;/p&gt;

&lt;p&gt;So for now, this patch works around this bug (which i&apos;ll file in a new jira soon) by only refering to fields in &lt;tt&gt;$row.&amp;#42;&lt;/tt&gt; parms that it knows for certainly are included in the &quot;fl&quot; (ie: &quot;id&quot;)&lt;/p&gt;
</comment>
                            <comment id="15412845" author="jira-bot" created="Tue, 9 Aug 2016 02:51:55 +0000"  >&lt;p&gt;Commit e08d656a15a51ef2e38ceb983e786cc37eed834f in lucene-solr&apos;s branch refs/heads/branch_6x from Chris Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e08d656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e08d656&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9377&quot; title=&quot;[subquery] augmenter doesn&amp;#39;t work with RTG on uncommited docs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9377&quot;&gt;&lt;del&gt;SOLR-9377&lt;/del&gt;&lt;/a&gt;: Fix jdocs and test to match expected behavior, workaround &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9396&quot; title=&quot;[subquery] transformer doesn&amp;#39;t automatically request needed fields, only other fields in fl can be used as input to subquery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9396&quot;&gt;SOLR-9396&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 1164c17e0e1c81fae4aa1103506536f82f70cf3c)&lt;/p&gt;</comment>
                            <comment id="15412847" author="jira-bot" created="Tue, 9 Aug 2016 02:51:59 +0000"  >&lt;p&gt;Commit 1164c17e0e1c81fae4aa1103506536f82f70cf3c in lucene-solr&apos;s branch refs/heads/master from Chris Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1164c17&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1164c17&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9377&quot; title=&quot;[subquery] augmenter doesn&amp;#39;t work with RTG on uncommited docs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9377&quot;&gt;&lt;del&gt;SOLR-9377&lt;/del&gt;&lt;/a&gt;: Fix jdocs and test to match expected behavior, workaround &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9396&quot; title=&quot;[subquery] transformer doesn&amp;#39;t automatically request needed fields, only other fields in fl can be used as input to subquery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9396&quot;&gt;SOLR-9396&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15438987" author="mikemccand" created="Fri, 26 Aug 2016 13:59:21 +0000"  >&lt;p&gt;Bulk close resolved issues after 6.2.0 release.&lt;/p&gt;</comment>
                            <comment id="16706096" author="moshebla" created="Sun, 2 Dec 2018 04:27:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Perhaps that&apos;s ok? Perhaps the only thing that&apos;s really important is that values from the doc used when building the subquery are accurate, and come from the tlog, and the query itself can (or perhaps MUST?) still be run against the same currently open searcher as if the user ran that subquery themselves?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Are there any performance implications in case sub-queries are executed using real time searchers?&lt;br/&gt;
 Perhaps there could be a flag sent as a parameter for this use case?&lt;br/&gt;
 Nonetheless,&lt;br/&gt;
 I found it really hard to come by.&lt;br/&gt;
 Perhaps this should be included in the ref guide(&lt;a href=&quot;https://lucene.apache.org/solr/guide/7_5/transforming-result-documents.html#subquery&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;transforming-result-documents&lt;/a&gt;)?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12995806">SOLR-9396</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12959653">SOLR-9006</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12990465">SOLR-9314</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12822707" name="SOLR-9377.patch" size="10731" author="hossman" created="Tue, 9 Aug 2016 00:55:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31vhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>