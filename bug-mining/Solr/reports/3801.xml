<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:30:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12027] ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.solr.search.join.BlockJoinFacetDistribTest</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12027</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>
&lt;p&gt;I tried to look into the sub.&#160;The symptoms looks like.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  (jetty-closer-2-thread-2) [    ] o.e.j.u.t.QueuedThreadPool QueuedThreadPool@qtp860938026{STOPPING,8&amp;lt;=9&amp;lt;=10000,i=0,q=1} Couldn&apos;t stop &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[qtp860938
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The thread successfully handled one request before. Then we have:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 2&amp;gt; Feb 23, 2018 11:20:41 PM com.carrotsearch.randomizedtesting.ThreadLeakControl checkThreadLeaks
  2&amp;gt; SEVERE: 1 thread leaked from SUITE scope at org.apache.solr.search.join.BlockJoinFacetDistribTest: 
  2&amp;gt;    1) &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[id=76, name=qtp860938026-76, state=TIMED_WAITING, group=TGRP-BlockJoinFacetDistribTest]
  2&amp;gt;         at sun.misc.Unsafe.park(Native Method)
  2&amp;gt;         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
  2&amp;gt;         at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2163)
  2&amp;gt;         at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.reservedWait(ReservedThreadExecutor.java:308)
  2&amp;gt;         at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:373)
  2&amp;gt;         at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:708)
  2&amp;gt;         at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:626)
  2&amp;gt;         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and then&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  2&amp;gt; SEVERE: There are still zombie threads that couldn&apos;t be terminated:
  2&amp;gt;    1) &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[id=76, name=qtp860938026-76, state=TIMED_WAITING, group=TGRP-BlockJoinFacetDistribTest]
  2&amp;gt;         at sun.misc.Unsafe.park(Native Method)
  2&amp;gt;         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
...
[23:19:41.186] ERROR   0.00s | BlockJoinFacetDistribTest (suite) &amp;lt;&amp;lt;&amp;lt;
   &amp;gt; Throwable #1: com.carrotsearch.randomizedtesting.ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.solr.search.join.BlockJoinFacetDistribTest: 
   &amp;gt;    1) &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[id=76, name=qtp860938026-76, state=TIMED_WAITING, group=TGRP-BlockJoinFacetDistribTest]
   &amp;gt;         at sun.misc.Unsafe.park(Native Method)
   &amp;gt;         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
   &amp;gt;         at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2163)
   &amp;gt;         at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.reservedWait(ReservedThreadExecutor.java:308)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;This also happen to other tests as well, not deterministic, but more or less is reproduced with &lt;tt&gt;ant beast&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13140746">SOLR-12027</key>
            <summary>ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.solr.search.join.BlockJoinFacetDistribTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mkhl">Mikhail Khludnev</assignee>
                                    <reporter username="mkhl">Mikhail Khludnev</reporter>
                        <labels>
                    </labels>
                <created>Sat, 24 Feb 2018 20:49:01 +0000</created>
                <updated>Sat, 8 Jun 2019 15:16:56 +0000</updated>
                            <resolved>Wed, 28 Feb 2018 06:29:55 +0000</resolved>
                                                    <fixVersion>7.3</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16375772" author="mkhludnev" created="Sat, 24 Feb 2018 21:04:53 +0000"  >&lt;p&gt;The problem looks like is caused by &lt;a href=&quot;https://github.com/eclipse/jetty.project/blob/e87775eb0d5ed0723a633ceda62deccde5143cf3/jetty-util/src/main/java/org/eclipse/jetty/util/thread/QueuedThreadPool.java#L139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ReservedThreadExecutor&lt;/a&gt; which has idle time for inactive thread 1 minute by default and I&apos;ve found it&apos;s hard to adjust.&lt;br/&gt;
It doesn&apos;t sound weird but, that what you might see during test finishing: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-02-24 10:34:04
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.111-b14 mixed mode):

&lt;span class=&quot;code-quote&quot;&gt;&quot;Attach Listener&quot;&lt;/span&gt; #279 daemon prio=9 os_prio=31 tid=0x00007fa86d8ea000 nid=0x6407 waiting on condition [0x0000000000000000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE

&lt;span class=&quot;code-quote&quot;&gt;&quot;qtp860938026-32&quot;&lt;/span&gt; #32 prio=5 os_prio=31 tid=0x00007fa86d465800 nid=0x8003 waiting on condition [0x000070000290e000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007be6fd818&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2163)
        at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.reservedWait(ReservedThreadExecutor.java:308)
        at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:373)
        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:708)
        at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:626)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

&lt;span class=&quot;code-quote&quot;&gt;&quot;SUITE-BlockJoinFacetDistribTest-seed#[A8545A49DBAAAC5B]&quot;&lt;/span&gt; #12 prio=5 os_prio=31 tid=0x00007fa86a9da800 nid=0x5c0f waiting on condition [0x00007000016d8000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
        at com.carrotsearch.randomizedtesting.ThreadLeakControl.checkThreadLeaks(ThreadLeakControl.java:582)
        at com.carrotsearch.randomizedtesting.ThreadLeakControl$2.evaluate(ThreadLeakControl.java:439)
        at com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:705)
        at com.carrotsearch.randomizedtesting.RandomizedRunner.access$200(RandomizedRunner.java:139)
        at com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:626)

&lt;span class=&quot;code-quote&quot;&gt;&quot;JUnit4-serializer-daemon&quot;&lt;/span&gt; #10 daemon prio=5 os_prio=31 tid=0x00007fa86a9c1800 nid=0x5603 waiting on condition [0x00007000015d5000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
        at com.carrotsearch.ant.tasks.junit4.events.Serializer$1.run(Serializer.java:50)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;  
&lt;p&gt;The only explanation is that &lt;tt&gt;interrupt()&lt;/tt&gt; can not unpark that Jetty thread. A guy in a pub told me that &lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8074773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;it might happen&lt;/a&gt;.&lt;br/&gt;
So, if I set &lt;tt&gt;@ThreadLeakLingering(linger = 80000)&lt;/tt&gt; it keeps &lt;tt&gt;beast&lt;/tt&gt; happy thousand times on this test.&lt;/p&gt;

&lt;p&gt;My proposal is to set &lt;b&gt;lingering time above 1 min&lt;/b&gt; for all Solr tests and for Lucene ones which hit the same issue. Opinions?     &lt;/p&gt;</comment>
                            <comment id="16375775" author="mkhludnev" created="Sat, 24 Feb 2018 21:09:13 +0000"  >&lt;p&gt;I also checked &lt;a href=&quot;https://github.com/eclipse/jetty.project/issues/1549#issuecomment-301121436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the hint&lt;/a&gt; about StatsHandler for Jetty. I didn&apos;t make any significant difference to the beast. &lt;/p&gt;</comment>
                            <comment id="16376345" author="werder" created="Mon, 26 Feb 2018 02:48:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Options?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I debugged it a little and it &lt;em&gt;seems to me&lt;/em&gt;&#160;that if add something like&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SelectorManager manager = (server.getConnectors()[0]).getBean(SelectorManager.class);
ReservedThreadExecutor reservedThreadExecutor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReservedThreadExecutor(manager.getExecutor(), manager.getReservedThreads(),manager);
reservedThreadExecutor.setIdleTimeout(10, TimeUnit.SECONDS);
manager.addBean(reservedThreadExecutor, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in&#160; &lt;tt&gt;JettySolrRunner&lt;/tt&gt;&#160;class BEFORE call of&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
server.start()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then custom &lt;tt&gt;ReservedThreadExecutor&lt;/tt&gt;&#160;instance would be in charge.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;...doesn&apos;t sound like a very good idea though.&#160;&lt;/p&gt;</comment>
                            <comment id="16376377" author="jira-bot" created="Mon, 26 Feb 2018 04:10:25 +0000"  >&lt;p&gt;Commit d3ef153b09461aa0bd2f735954905321d6b72aed in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d3ef153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d3ef153&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12027&quot; title=&quot;ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.solr.search.join.BlockJoinFacetDistribTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12027&quot;&gt;&lt;del&gt;SOLR-12027&lt;/del&gt;&lt;/a&gt;: Increasing thread lingering to 80s&lt;/p&gt;

&lt;p&gt;Sometimes Jetty can&apos;t stop for a minute. We need tests wait more than a minute in the worst case&lt;br/&gt;
to avoid test noise like ThreadLeakError: 1 thread leaked from SUITE scope.&lt;/p&gt;</comment>
                            <comment id="16376378" author="jira-bot" created="Mon, 26 Feb 2018 04:12:24 +0000"  >&lt;p&gt;Commit aa9b7d834e42b6a9dddb4eadec5df8e97b129e83 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=aa9b7d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=aa9b7d8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12027&quot; title=&quot;ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.solr.search.join.BlockJoinFacetDistribTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12027&quot;&gt;&lt;del&gt;SOLR-12027&lt;/del&gt;&lt;/a&gt;: Increasing thread lingering to 80s&lt;/p&gt;

&lt;p&gt;Sometimes Jetty can&apos;t stop for a minute. We need tests wait more than a minute in the worst case&lt;br/&gt;
to avoid test noise like ThreadLeakError: 1 thread leaked from SUITE scope.&lt;/p&gt;</comment>
                            <comment id="16376710" author="mkhludnev" created="Mon, 26 Feb 2018 11:43:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=werder&quot; class=&quot;user-hover&quot; rel=&quot;werder&quot;&gt;werder&lt;/a&gt;, thanks for your keen consideration as usual. Watching tests. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13138745">LUCENE-8176</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12911967" name="SOLR-12027.patch" size="2170" author="mkhl" created="Sun, 25 Feb 2018 20:53:57 +0000"/>
                            <attachment id="12911931" name="SOLR-12027.patch" size="1181" author="mkhl" created="Sat, 24 Feb 2018 21:13:37 +0000"/>
                            <attachment id="12911929" name="jetty-threadleak-problem-still.txt" size="152517" author="mkhl" created="Sat, 24 Feb 2018 21:11:26 +0000"/>
                            <attachment id="12911930" name="jetty-threadleak-problem.txt" size="154308" author="mkhl" created="Sat, 24 Feb 2018 21:11:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qkd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>