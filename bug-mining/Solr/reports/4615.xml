<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:46:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-15048] collapse + query elevation behaves inconsistenty w/ &apos;null group&apos; docs depending on group head selector</title>
                <link>https://issues.apache.org/jira/browse/SOLR-15048</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15047&quot; title=&quot;&amp;#39;collapse&amp;#39; on numeric field treats all docs with &amp;#39;0&amp;#39; in collapse field as part of the null group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15047&quot;&gt;&lt;del&gt;SOLR-15047&lt;/del&gt;&lt;/a&gt;, I realized I wasn&apos;t really clear on what the &lt;em&gt;expected&lt;/em&gt; semantics of were suppose to be when &quot;boosting&quot;&lt;br/&gt;
 &#160;docs that had null values in the collapse field.&lt;/p&gt;

&lt;p&gt;I expanded on my test from that jira, to demonstrate the logic i (thought) i understood from the Ord based collector - but then discovered that depending on the group head selector used (ie: OrdScoreCollector vs OrdFieldValueCollector+OrdIntStrategy vs OrdFieldValueCollector+OrdValueSourceStrategy , etc...) you get different behavior - not just in what group head is selected, but even when the behavior should be functionally equivilent, you can get different sets of groups. (even for simple string field collapsing, independent of the bugs in numeric field collapsing).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have not dug into WTF is happening here, but I&apos;ll attach my WIP test&lt;/p&gt;</description>
                <environment></environment>
        <key id="13346015">SOLR-15048</key>
            <summary>collapse + query elevation behaves inconsistenty w/ &apos;null group&apos; docs depending on group head selector</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Dec 2020 02:25:06 +0000</created>
                <updated>Thu, 12 May 2022 00:26:26 +0000</updated>
                            <resolved>Tue, 5 Jan 2021 21:30:02 +0000</resolved>
                                                    <fixVersion>8.8</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17250655" author="hossman" created="Wed, 16 Dec 2020 21:46:16 +0000"  >&lt;p&gt;so, if we ignore nulls, the way collapse deals with &quot;boosted&quot; docs is that any boosted doc is explicitly collected (even if there are multiple boosted docs from the same group), and all other docs in the same group(s) as boosted docs are &lt;em&gt;not&lt;/em&gt; collected: ie: &lt;tt&gt;elevateIds=1,5&lt;/tt&gt; causes docs 1 &amp;amp; 5 to be boosted &amp;amp; returned, even if they would not normally be group heads, and any other docs in the same group(s) as either of those docs will not be returned (even if they would normally be the group head)&lt;/p&gt;

&lt;p&gt;I initially thought that (from the code I looked at &amp;amp; some quick testing) that the &quot;intent&quot; when dealing with &quot;null group id&quot; docs was that boosting these docs would still cause all other &quot;null group id&quot; docs to behave as they would w/o boosting. ie: nullPolicy=collapse would still result in a &quot;null&quot; group using the &quot;best&quot; group head that wasn&apos;t already boosted; nullPolicy=expand would still result in all docs w/null group id being returned as if they were their own group.&lt;/p&gt;

&lt;p&gt;In practice though, there is no rhyme or reason to how the current code behaves. some group head selectors cause nullPolicy=collapse to completely eliminate the null group if any docs in it are boosted (like a normal group) others cause the group to still be returned (like i initially thought). but when nullPolicy=expand, some group head selector code causes (non-boosted) null group docs to actually be returned in the wrong order acording to the top level sort (evidently due to a logic error, but i&apos;m not sure how since they still get returned with the correct score?)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;TL;DR: some of the nullPolicy+boosting logic is flat out broken, the logic that isn&apos;t broken is internally inconsistent.&lt;/b&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I would like to try and just ignore all the existing (lack of) &quot;logic&quot; and instead &quot;fix&quot; nullPolicy+boosting such that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;boosting null docs (continues) to work even when nullPolicy=ignore&lt;/li&gt;
	&lt;li&gt;boosting w/nullPolicy=collapse is fixed to treat the &quot;null group&quot; exactly the same as a &quot;real&quot; group: if any docs in it are boosted, the group is not returned&lt;/li&gt;
	&lt;li&gt;boosting w/nullPolicy=expand should be fixed to ensure all &quot;null&quot; docs are returned (as if they were exach in their own group) in the correct order, w/correct scores, but any &quot;boosted&quot; null docs should come first (just like boosted regular docs)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...but before i can do that, i really need to get to the bottom of how/why nullPolicy=expand is sometimes collected &lt;em&gt;non&lt;/em&gt;-boosted &quot;null&quot; docs out of their expected order ... because i can&apos;t even figure out how that&apos;s possible given the way the DelegatingCollector API works (let alone how the collapse code is &#8211; erroneously &#8211; making it happen.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbernste&quot; class=&quot;user-hover&quot; rel=&quot;jbernste&quot;&gt;jbernste&lt;/a&gt; can you please take a look at testSmallWTF in the latest patch and help me understand how the ValueSource and SortSpec related &quot;collapseStrategy&quot; impls are moving &quot;doc id=4&quot; out of it&apos;s normal position in the results (inspite of it&apos;s score) ?&lt;/p&gt;</comment>
                            <comment id="17254311" author="hossman" created="Wed, 23 Dec 2020 23:00:21 +0000"  >&lt;p&gt;There are twe distinct but interconnected problems that were contributing to the symptoms i was seeing before (which were only a subset of the actual problems involved, due to the natural order of the docs in my test)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the abstract base &quot;strategy&quot; classes expect that (in the nullPolicy=expand) case &lt;em&gt;if&lt;/em&gt; a null doc was boosted, then it would not &lt;b&gt;also&lt;/b&gt; be listed in the &apos;nullScores&apos; array (and the nullScoreIndex would not be increased in the &quot;null group but boosted&quot; code path of the finish method())   &amp;#8211; but not all of the concrete strategy impls were returning immediately when detecting a boosted doc, meaning that &quot;extra&quot; scores would be in the nullScores array, leading to using the wrong index to try nad find the score of (non-boosted) null docs&lt;/li&gt;
	&lt;li&gt;the finish method in the abstract base &quot;strategy&quot; class takes care of purging any &quot;group heads&quot; that have the same group value as a known boosted doc, but this code wasn&apos;t also cleaning the &quot;nullDoc&quot; group head of the null group (ie: it assumed nullPolicy=ignore or nullPolicy=expand)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m attaching a patch with more beefed up testing, and the minimal changes to get all of hte various strategies/collectors in agreement of how to deal with null groups &amp;#8211; i plan to do a lot of deduplication refactoring prior to committing (copy/past coding appears to be how we got in this mess) but i wanted to post the patch in this state since it makes it more evident where the &quot;wrong&quot; code was.&lt;/p&gt;</comment>
                            <comment id="17258663" author="hossman" created="Tue, 5 Jan 2021 05:11:44 +0000"  >&lt;p&gt;Patch with a lot of deduplication cleanup of the boosting related code ... there&apos;s still a bunch more that could probably be refactored, but this is as far as i felt safe taking things w/o stepping on my own toes getting &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15047&quot; title=&quot;&amp;#39;collapse&amp;#39; on numeric field treats all docs with &amp;#39;0&amp;#39; in collapse field as part of the null group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15047&quot;&gt;&lt;del&gt;SOLR-15047&lt;/del&gt;&lt;/a&gt; fixed next.&lt;/p&gt;</comment>
                            <comment id="17259052" author="jira-bot" created="Tue, 5 Jan 2021 17:01:17 +0000"  >&lt;p&gt;Commit a48e937f599bc1487df3321c490589b0d8820616 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a48e937&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=a48e937&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15048&quot; title=&quot;collapse + query elevation behaves inconsistenty w/ &amp;#39;null group&amp;#39; docs depending on group head selector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15048&quot;&gt;&lt;del&gt;SOLR-15048&lt;/del&gt;&lt;/a&gt;: Fixed collapse parser behavior when dealing with docs boosted by QueryElevationComponent that are in the null group to treat them consistently regardless of collapse field type or group head selector&lt;/p&gt;</comment>
                            <comment id="17259174" author="jira-bot" created="Tue, 5 Jan 2021 19:49:15 +0000"  >&lt;p&gt;Commit fa06f0238c98466fb20dc88745f6fc099524e2aa in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=fa06f02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=fa06f02&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15048&quot; title=&quot;collapse + query elevation behaves inconsistenty w/ &amp;#39;null group&amp;#39; docs depending on group head selector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15048&quot;&gt;&lt;del&gt;SOLR-15048&lt;/del&gt;&lt;/a&gt;: Fixed collapse parser behavior when dealing with docs boosted by QueryElevationComponent that are in the null group to treat them consistently regardless of collapse field type or group head selector&lt;/p&gt;

&lt;p&gt;(cherry picked from commit a48e937f599bc1487df3321c490589b0d8820616)&lt;/p&gt;</comment>
                            <comment id="17535417" author="janhoy" created="Thu, 12 May 2022 00:26:26 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13345986">SOLR-15047</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13018174" name="SOLR-15048.patch" size="54664" author="hossman" created="Tue, 5 Jan 2021 05:11:38 +0000"/>
                            <attachment id="13017600" name="SOLR-15048.patch" size="21411" author="hossman" created="Wed, 23 Dec 2020 23:00:19 +0000"/>
                            <attachment id="13017267" name="SOLR-15048.patch" size="15405" author="hossman" created="Wed, 16 Dec 2020 21:44:13 +0000"/>
                            <attachment id="13017103" name="SOLR-15048.patch" size="8521" author="hossman" created="Tue, 15 Dec 2020 02:27:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ligw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>