<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:08:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16907] Strange behaviour after upgrade to 9.x when security json has no longer existing permission</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16907</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I had a very strange behaviour of Authorization after migrating a standalone solr instance to Solr 9 keeping the existing security.json file.&lt;/p&gt;

&lt;p&gt;To reproduce, place the attached  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13061695/13061695_security.json&quot; title=&quot;security.json attached to SOLR-16907&quot;&gt;security.json&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; in the solr.home (it has default password &quot;SolrRocks&quot;). The only change I did was adding &lt;tt&gt;&quot;blockUnknown&quot;:false&lt;/tt&gt;, because the whole idea of the file is just to prevent people doing some changes to configuration, but all queries/select/.... on cores/collections should work without authentication (basically to prevent the developers from accessing admin UI and change something).&lt;/p&gt;

&lt;p&gt;After applying this config, all requests to any core were denied with &quot;Authentication failed, Response code: 401&quot;. This message does not come from the &quot;BasicAuthenticationProvider&quot; (hint: if you enable &quot;blockUnknown&quot;, it fails earlier and print as error message: &quot;require authentication&quot; coming from BasicAuthenticationProvider). So the problem was &lt;b&gt;not&lt;/b&gt; caused by the setting &quot;blockUnknown=false&quot; ignored.&lt;/p&gt;

&lt;p&gt;It took me a long time to actually find the reason and without enabling debug logging and going through all settings I found the issue. This is totally unexpected and should be fixed as no warning or reason is printed to default log.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [] o.e.j.s.h.ContextHandler scope null||/solr/techproducts/select @ o.e.j.w.WebAppContext@49a64d82{solr-jetty-context.xml,/solr,file:///C:/Users/Uwe%20Schindler/Desktop/solr-9.3.0-slim/server/solr-webapp/webapp/,AVAILABLE}{C:\Users\Uwe Schindler\Desktop\solr-9.3.0-slim\server/solr-webapp/webapp}
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [] o.e.j.s.h.ContextHandler context=/solr||/techproducts/select @ o.e.j.w.WebAppContext@49a64d82{solr-jetty-context.xml,/solr,file:///C:/Users/Uwe%20Schindler/Desktop/solr-9.3.0-slim/server/solr-webapp/webapp/,AVAILABLE}{C:\Users\Uwe Schindler\Desktop\solr-9.3.0-slim\server/solr-webapp/webapp}
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [] o.e.j.s.ServletHandler servlet /solr|/techproducts/select|null|ServletPathMapping{matchValue=, pattern=/, servletName=default, mappingMatch=DEFAULT, servletPath=/techproducts/select, pathInfo=null} -&amp;gt; default==org.eclipse.jetty.servlet.DefaultServlet@5c13d641{jsp=null,order=0,inst=true,async=false,src=DESCRIPTOR:file:///C:/Users/Uwe%20Schindler/Desktop/solr-9.3.0-slim/server/etc/webdefault.xml,STARTED}
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [] o.e.j.s.ServletHandler chain=Chain@47a4b5d5(SolrRequestFilter==org.apache.solr.servlet.SolrDispatchFilter@30d15e4a{inst=true,async=false,src=DESCRIPTOR:file:///C:/Users/Uwe%20Schindler/Desktop/solr-9.3.0-slim/server/solr-webapp/webapp/WEB-INF/web.xml})-&amp;gt;ChainEnd@2c16acde(default==org.eclipse.jetty.servlet.DefaultServlet@5c13d641{jsp=null,order=0,inst=true,async=false,src=DESCRIPTOR:file:///C:/Users/Uwe%20Schindler/Desktop/solr-9.3.0-slim/server/etc/webdefault.xml,STARTED})
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [] o.a.s.s.SolrDispatchFilter Request to authenticate: org.apache.solr.servlet.ServletUtils$1@5726199e, domain: 127.0.0.1, port: 8983
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [] o.a.s.s.SolrDispatchFilter User principal: null
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.a.s.s.AuthorizationUtils AuthorizationContext : userPrincipal: [null] type: [READ], collections: [], Path: [/select] path : /select params :
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.a.s.s.RuleBasedAuthorizationPluginBase Attempting to authorize request to [/select] of type: [READ], associated with collections [[]]
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.a.s.s.RuleBasedAuthorizationPluginBase Authorizing collection-aware request, checking perms applicable to all (*) collections
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.a.s.s.RuleBasedAuthorizationPluginBase Found perm [{
  &quot;name&quot;:&quot;autoscaling-write&quot;,
  &quot;role&quot;:&quot;admin&quot;,
  &quot;index&quot;:5}] to govern resource [/select]
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.a.s.s.RuleBasedAuthorizationPluginBase Governing permission [{
  &quot;name&quot;:&quot;autoscaling-write&quot;,
  &quot;role&quot;:&quot;admin&quot;,
  &quot;index&quot;:5}] has role, but request principal cannot be identified; forbidding access
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.a.s.s.AuthorizationUtils USER_REQUIRED null null
2023-07-27 08:48:23.929 DEBUG (qtp1963075870-46) [ x:techproducts] o.e.j.s.HttpChannelState sendError HttpChannelState@ca1dc41{s=HANDLING rs=BLOCKING os=OPEN is=IDLE awp=false se=false i=true al=0}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reason is that the role map still contains the &lt;b&gt;outdated&lt;/b&gt; 8.x &quot;autoscaling-write&quot; permission and for unknown reason it is selected as permission that needs to be enforced for /select queries to the core. I have no idea why this happens! This is in my opinion the main issue here. After that, the rule based authorization figures out that the principal is null and send the 401 response with useless error message (and by default no log entry at all!!!!).&lt;/p&gt;

&lt;p&gt;After removing the outdated perm from the security.json, requests to /select go through without authentication.&lt;/p&gt;

&lt;p&gt;This problem may affect other people when upgrading Solr, as it is totally unexpected that a no longer existing permission is selected to authorize!&lt;/p&gt;

&lt;p&gt;To fix please try to be more helpful:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Log warnings when authorization fail, so one must not use DEBUG logging!&lt;/li&gt;
	&lt;li&gt;fix the bug that &quot;autoscaling-write&quot; is selected as permission for any request to the core (not only /select is affected, everything).&lt;/li&gt;
	&lt;li&gt;if a permission is unknown (legacy from 8.x), a warning should be printed on startup and in the admin UI&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13545105">SOLR-16907</key>
            <summary>Strange behaviour after upgrade to 9.x when security json has no longer existing permission</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janhoy">Jan H&#248;ydahl</assignee>
                                    <reporter username="uschindler">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Jul 2023 10:16:39 +0000</created>
                <updated>Mon, 12 Feb 2024 19:48:59 +0000</updated>
                            <resolved>Tue, 7 Nov 2023 20:25:26 +0000</resolved>
                                    <version>9.0</version>
                    <version>9.1</version>
                    <version>9.2</version>
                    <version>9.3</version>
                    <version>9.4</version>
                                    <fixVersion>9.5</fixVersion>
                                    <component>Authentication</component>
                    <component>Authorization</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17750374" author="gerlowskija" created="Wed, 2 Aug 2023 15:12:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;The reason is that the role map still contains the outdated 8.x &quot;autoscaling-write&quot; permission and for unknown reason it is selected as permission that needs to be enforced for /select queries to the core. I have no idea why this happens&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Rule-Based Authz accepts a number of predefined permissions that Solr knows how to map to specific request handlers: &quot;schema-edit&quot;, &quot;collection-admin-read&quot;, etc.  But it also supports custom permissions that allow users to specify rules based on criteria like the collection/core, HTTP path, HTTP method, query parameters, etc.  If a custom permission doesn&apos;t specify a particular criterion (e.g. the HTTP method), then Solr treats that criterion as being a &quot;wild card&quot; (or a &quot;Don&apos;t Care&quot;).&lt;/p&gt;

&lt;p&gt;e.g. a rule that specifies &lt;tt&gt;verb=DELETE&lt;/tt&gt; will only match and be applied to DELETE requests, but a rule that doesn&apos;t specify any &lt;tt&gt;verb&lt;/tt&gt; criterion will apply to all requests that match the other criteria.&lt;/p&gt;

&lt;p&gt;I think that&apos;s what&apos;s happening here.  In 8.x &quot;autoscaling-write&quot; was a predefined permission that only applied to specific request handlers.  But in 9.x that same rule in security.json is being interpreted as a custom permission that is intended to match requests for any collection, path, HTTP method, etc.&lt;/p&gt;</comment>
                            <comment id="17750381" author="gerlowskija" created="Wed, 2 Aug 2023 15:37:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;Log warnings when authorization fail, so one must not use DEBUG logging!&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Some environments see a lot of rejected traffic: either because they&apos;re not behind a firewall as we recommend, or because of more mundane issues like misconfigured scanners, healthchecks, etc.  Given that, I think the DEBUG log-level for the current messages is a decent default.&lt;/p&gt;

&lt;p&gt;But I agree this is definitely a logging failure.  IMO a more effective place to log would be when we load in security.json and notice the sketchy permissions.  We can&apos;t print warnings on any &quot;unknown&quot; permissions, since we&apos;re apparently intent on supporting custom permissions going forward.  But it&apos;d be pretty easy to warn about permissions whose names are in a set of &quot;old perms that have been removed from Solr&quot;.  Or we could warn about &quot;match all&quot; permissions that don&apos;t specify any criteria.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17750386" author="thetaphi" created="Wed, 2 Aug 2023 15:48:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think that&apos;s what&apos;s happening here. In 8.x &quot;autoscaling-write&quot; was a predefined permission that only applied to specific request handlers. But in 9.x that same rule in security.json is being interpreted as a custom permission that is intended to match requests for any collection, path, HTTP method, etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That was my first idea. Maybe it should keep an internal entry about all the old exsiting predefined permissions. When they are encountered it should log a warning (asking users to remove them).&lt;/p&gt;

&lt;p&gt;On the other hand: Any custom permission must be defined somewhere. &quot;autoscaling-write&quot; is not defined anywhere, so shouldn&apos;t it throw error?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But I agree this is definitely a logging failure. IMO a more effective place to log would be when we load in security.json and notice the sketchy permissions. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Either like this, or log them by default: If it gets too noisy for user XY you can always silence those logs by reconfigure them to &quot;error&quot;. That&apos;s easy with admin UI or by adding a line to log4j.xml.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We can&apos;t print warnings on any &quot;unknown&quot; permissions, since we&apos;re apparently intent on supporting custom permissions going forward. But it&apos;d be pretty easy to warn about permissions whose names are in a set of &quot;old perms that have been removed from Solr&quot;. Or we could warn about &quot;match all&quot; permissions that don&apos;t specify any criteria.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;See above, I have the same idea. Just check the old hardcoded permissions in 8.x source tree and preserve them as &quot;deprecated&quot; ones in some HashSet or whatever.&lt;/p&gt;</comment>
                            <comment id="17751416" author="janhoy" created="Sun, 6 Aug 2023 23:56:20 +0000"  >&lt;p&gt;+1 to keep shadow perms to warn (and fail loading?) old non-existent permissions.&lt;/p&gt;

&lt;p&gt;Also, I like the idea of warning if a custom permission is not defined. It could be a typo, e.g. &lt;tt&gt;colection-edit&lt;/tt&gt; that would otherwise go unnoticed and cause issues...&lt;/p&gt;</comment>
                            <comment id="17781768" author="janhoy" created="Wed, 1 Nov 2023 14:44:22 +0000"  >&lt;p&gt;Updated the PR with a generic approach of failing when parsing security.json if the name is not a predefined permission, and it does not contain &quot;path&quot;, &quot;method&quot; or &quot;params&quot;.&lt;/p&gt;</comment>
                            <comment id="17783685" author="jira-bot" created="Tue, 7 Nov 2023 16:27:18 +0000"  >&lt;p&gt;Commit 2062d057c003e4113b09b8e6aab49caa134b4a7c in solr&apos;s branch refs/heads/main from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=2062d057c00&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=2062d057c00&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16907&quot; title=&quot;Strange behaviour after upgrade to 9.x when security json has no longer existing permission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16907&quot;&gt;&lt;del&gt;SOLR-16907&lt;/del&gt;&lt;/a&gt;: Fail when parsing an invalid custom permission definition from security.json (#2040)&lt;/p&gt;
</comment>
                            <comment id="17783781" author="jira-bot" created="Tue, 7 Nov 2023 20:25:22 +0000"  >&lt;p&gt;Commit ce1935ff8bc9024327f40ecfe48f39d7b249f39b in solr&apos;s branch refs/heads/branch_9x from Jan H&#248;ydahl&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=ce1935ff8bc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=ce1935ff8bc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16907&quot; title=&quot;Strange behaviour after upgrade to 9.x when security json has no longer existing permission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16907&quot;&gt;&lt;del&gt;SOLR-16907&lt;/del&gt;&lt;/a&gt;: Fail when parsing an invalid custom permission definition from security.json (#2040)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2062d057c003e4113b09b8e6aab49caa134b4a7c)&lt;/p&gt;</comment>
                            <comment id="17816748" author="gerlowskija" created="Mon, 12 Feb 2024 19:48:59 +0000"  >&lt;p&gt;Closing after the 9.5.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13061695" name="security.json" size="1222" author="uschindler" created="Thu, 27 Jul 2023 10:00:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jexc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>