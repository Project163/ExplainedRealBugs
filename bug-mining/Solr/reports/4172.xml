<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:37:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13352] possible deadlock/threadleak from OverseerTriggerThread/AutoScalingWatcher during close()</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13352</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>
&lt;p&gt;A recent jenkins failure in TestSimTriggerIntegration lead me to what appears to be a &quot;lock leak&quot; situation in OverseerTriggerThread in how the &quot;updateLock&quot; object is dealt with in the event that the OverseerTriggerThread is closed.&lt;/p&gt;

&lt;p&gt;It&apos;s possible that this only affects tests using the SimCloudManager when calling &quot;simRestartOverseer&quot; &amp;#8211; but &lt;br/&gt;
I &lt;em&gt;believe&lt;/em&gt; this can lead also lead to an actual deadlock / threadleak situation in a thread running AutoScalingWatcher (that hold a refrefrences to OverseerTriggerThread and every object reachable from it) when the OverseerTriggerThread is closed as part of a real Solr shutdown ... which i think would cause the JVM to stall untill externally killed.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;If my analysis of the test failure (to follow in comment) is correct, then even even if this bug isn&apos;t likely to affect real world solr instances (and only surfaces because of how OverseerTriggerThread is used in SimCloudManager) the fix to OverseerTriggerThread is a trivial change to follow locking best practices (patch to follow)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13224645">SOLR-13352</key>
            <summary>possible deadlock/threadleak from OverseerTriggerThread/AutoScalingWatcher during close()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Mar 2019 17:12:34 +0000</created>
                <updated>Sat, 8 Jun 2019 14:58:46 +0000</updated>
                            <resolved>Mon, 1 Apr 2019 17:43:05 +0000</resolved>
                                                    <fixVersion>7.7.2</fixVersion>
                    <fixVersion>8.1</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16804119" author="hossman" created="Thu, 28 Mar 2019 17:15:19 +0000"  >&lt;p&gt;I&apos;m attaching the jenkins log file sarowe_Lucene-Solr-tests-master_20462.log.txt that shows the following...&lt;/p&gt;

&lt;p&gt;First off note that on the surface the TestSimTriggerIntegration.testNodeMarkersRegistration fails because the call to assertAutoScalingRequest() @ TestSimTriggerIntegration.java:956 throws a TimeoutException after waiting the (hardcoded) 2 minutes for the &quot;set-trigger&quot; command to finish &#8211; the question is why, since the log messages show nothing much happening (except for a background thread running the scheduled auto_add_replicas trigger) during that time.&lt;/p&gt;

&lt;p&gt;From the log messages we do get, and the eventual suite level threadleak reported by the test framework, we can see that the logic kicked off by the assertAutoScalingRequest() call makes it down to the point where the AutoScalingHandler has used the (simulated) DistribStateManager to call setData and is now trying to execute the &quot;OverseerTriggerThread$AutoScalingWatcher&quot; which is parked waiting on the updateLock.lock() @ OverseerTriggerThread.java:301 ... this then stalls forever.&lt;/p&gt;

&lt;p&gt;Looking over the usage of OverseerTriggerThread.updateLock here&apos;s what i think happens...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;T1: OverseerTriggerThread.run() calls getAutoScalingConfig() which registers an AutoScalingWatcher&lt;/li&gt;
	&lt;li&gt;T1: OverseerTriggerThread.run() then goes into it&apos;s &quot;while (true) loop @ OverseerTriggerThread.java:184&lt;/li&gt;
	&lt;li&gt;T1: OverseerTriggerThread acquires the udpateLock @ OverseerTriggerThread.java:189&lt;/li&gt;
	&lt;li&gt;T2: some thread calls OverseerTriggerThread.close()&lt;/li&gt;
	&lt;li&gt;T1: OverseerTriggerThread breaks is &quot;isClosed==true&quot; and breaks out of the while loop @ OverseerTriggerThread.java:194
	&lt;ul&gt;
		&lt;li&gt;T1: still holds the updateLock, even as OverseerTriggerThread.run() returns&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;T3: some thread calls DistribStateManager.setData triggering the previously registered AutoScalingWatcher
	&lt;ul&gt;
		&lt;li&gt;T3: this thread is now blocked waiting on the updateLock that will never be released&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The fix seems straight forward: after acquiring the lock, the run() method should immediately enter a try block with an unlock in the finally clause and only do it&apos;s &quot;if isClosed break/return&quot; logic w/in that try block.&lt;/p&gt;

&lt;p&gt;There is however currently a very weird comment associated with the lock acquisition lines in question that makes no sense to me...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
  Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, AutoScaling.Trigger&amp;gt; copy = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; can &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; InterruptedException and we don&apos;t want to unlock &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it did, so we keep &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; outside
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// of the &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;/&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; block
&lt;/span&gt;    updateLock.lockInterruptibly();

    &lt;span class=&quot;code-comment&quot;&gt;// must check &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; close here before we await on the condition otherwise we can only be woken up on interruption
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isClosed) {
      log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;OverseerTriggerThread has been closed, exiting.&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }

    log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Current znodeVersion {}, lastZnodeVersion {}&quot;&lt;/span&gt;, znodeVersion, lastZnodeVersion);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
       ...
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
       &lt;span class=&quot;code-comment&quot;&gt;// Restore the interrupted status
&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
       log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted&quot;&lt;/span&gt;, e);
       &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      updateLock.unlock();
    }
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
    &lt;span class=&quot;code-comment&quot;&gt;// Restore the interrupted status
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
	&lt;li&gt;if lockInterruptibly() throws InterruptedException, that means we never acquired the lock &#8211; so we shouldn&apos;t call unlock in the outer try/finally anyway&lt;/li&gt;
	&lt;li&gt;if the comment was actually refering to the logic inside the &lt;em&gt;inner&lt;/em&gt; try block that mght throw InterruptedException, that still wouldn&apos;t make sense (why not release the lock???) ... and already has a finally block releasing the lock.&lt;/li&gt;
&lt;/ol&gt;


&lt;hr /&gt;
&lt;p&gt;The attached patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;moves the &quot;isClosed&quot; check inside the try/finally/unlock block&lt;/li&gt;
	&lt;li&gt;simplifies the InterruptedException handling/logging to a single catch in the outer try&lt;/li&gt;
	&lt;li&gt;removes the comment that doesn&apos;t seem to make much sense&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...this seems very straight forward, but I&apos;m still testing &#8211; I would appreciate a sanity check from folks that i&apos;m not overlooking something silly about why the existing code/comment are the way they are.&lt;/p&gt;</comment>
                            <comment id="16804679" author="shalinmangar" created="Fri, 29 Mar 2019 08:16:54 +0000"  >&lt;p&gt;Thanks Hoss. Your fix looks good to me.&lt;/p&gt;

&lt;p&gt;Re: the code comment:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;// this can throw InterruptedException and we don&apos;t want to unlock if it did, so we keep this outside&lt;br/&gt;
// of the try/finally block&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;and your comment:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;if lockInterruptibly() throws InterruptedException, that means we never acquired the lock &#8211; so we shouldn&apos;t call unlock in the outer try/finally anyway&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Aren&apos;t they equivalent statements? It is saying that the reason why the lockInterruptibly() call is not inside the try-finally block is because it can throw InterruptedException and in that case unlock should not be called.&lt;/p&gt;

&lt;p&gt;I mean if it is obvious to everyone why lockInterruptibly() should never be inside a try-finally block then fine, we can remove the code comment but it might not be obvious to me if I come back to this code in a year or two. Feel free to re-word it to make it more clear.&lt;/p&gt;</comment>
                            <comment id="16807017" author="jira-bot" created="Mon, 1 Apr 2019 17:35:07 +0000"  >&lt;p&gt;Commit 1071d093360b2c5869a918de743c7089952094f4 in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=1071d09&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=1071d09&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13352&quot; title=&quot;possible deadlock/threadleak from OverseerTriggerThread/AutoScalingWatcher during close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13352&quot;&gt;&lt;del&gt;SOLR-13352&lt;/del&gt;&lt;/a&gt;: Remove risk of deadlock/threadleak when shutting down an Overseer(TriggerThread)&lt;/p&gt;</comment>
                            <comment id="16807021" author="jira-bot" created="Mon, 1 Apr 2019 17:39:56 +0000"  >&lt;p&gt;Commit c18da4c6bc570a353960405aed644e7502270f1a in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c18da4c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=c18da4c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13352&quot; title=&quot;possible deadlock/threadleak from OverseerTriggerThread/AutoScalingWatcher during close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13352&quot;&gt;&lt;del&gt;SOLR-13352&lt;/del&gt;&lt;/a&gt;: Remove risk of deadlock/threadleak when shutting down an Overseer(TriggerThread)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 1071d093360b2c5869a918de743c7089952094f4)&lt;/p&gt;</comment>
                            <comment id="16807027" author="hossman" created="Mon, 1 Apr 2019 17:42:42 +0000"  >&lt;p&gt;Thanks shalin,&lt;/p&gt;

&lt;p&gt;I think that comment was more confusing then helpful considering the ambiguity of which of the two nested try blocks it was refering to.&lt;/p&gt;

&lt;p&gt;In generally, a Lock should &lt;b&gt;NEVER&lt;/b&gt; be acquired &lt;em&gt;inside&lt;/em&gt; the try/finally where the lock is released (that&apos;s pretty fundamental to the design of the Lock API) and now that we only catch InterruptedException in the outer try/catch, there shouldn&apos;t be much risk of confusion in the future of people thinking that maybe the lock call should be moved inside the inner try.&lt;/p&gt;</comment>
                            <comment id="16841533" author="jira-bot" created="Thu, 16 May 2019 16:48:45 +0000"  >&lt;p&gt;Commit 97bb70e73710a701abeed2997d535bc0fc98d7a5 in lucene-solr&apos;s branch refs/heads/branch_7_7 from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=97bb70e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=97bb70e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13352&quot; title=&quot;possible deadlock/threadleak from OverseerTriggerThread/AutoScalingWatcher during close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13352&quot;&gt;&lt;del&gt;SOLR-13352&lt;/del&gt;&lt;/a&gt;: Remove risk of deadlock/threadleak when shutting down an Overseer(TriggerThread)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 1071d093360b2c5869a918de743c7089952094f4)&lt;/p&gt;</comment>
                            <comment id="16857082" author="janhoy" created="Wed, 5 Jun 2019 21:30:57 +0000"  >&lt;p&gt;Closing after the 7.7.2 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12964060" name="SOLR-13352.patch" size="2666" author="hossman" created="Thu, 28 Mar 2019 17:14:58 +0000"/>
                            <attachment id="12964059" name="sarowe_Lucene-Solr-tests-master_20462.log.txt" size="2913256" author="hossman" created="Thu, 28 Mar 2019 17:15:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z017qw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>