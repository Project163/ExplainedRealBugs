<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:28:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3587] After reloading a SolrCore, the original Analyzer is still used rather than a new one.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3587</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;It&apos;s a usual practice in Solr to overwrite synonyms/stopwords files and issue a core reload command to force Solr reload these files. We&apos;ve noticed that this trick is no longer working on trunk. &lt;/p&gt;

&lt;p&gt;I started debugging this problem in Eclipse and I can see that Solr actually re-reads updated synonym file on core reload, but indexing process still uses old reference to Synonym filter / SynonymMap instance. &lt;/p&gt;

&lt;p&gt;When I start Solr initially I can see that my Solr server has 2 instances of SynonymMap (the object that holds actual synonyms data). This is expected as I have 2 SynonymFilters defined in my schema (one field with 2 synonym filters - index + query time)&lt;/p&gt;

&lt;p&gt;After a core reload I see that Solr has 4 instances of this class. So I thought that there could be some leak and issued many (N) core reload commands and expected to see 2*N instances. It didn&apos;t happen. I can only see 20 instances of this class. &lt;/p&gt;

&lt;p&gt;This is pretty interesting number as well because, according to thread dump/list, Solr/Jetty has 10 working threads in thread pool (by default for example configs). So I suspect that we cache something in thread local storage and it hits us. &lt;/p&gt;

&lt;p&gt;I looked into the code and found that Lucene caches token streams in ThreadLocal, but I don&apos;t know the code enough to state that this is the problem.&lt;/p&gt;

&lt;p&gt;So I took a different approach and found the commit that introduced this bug. I wrote a simple test (shell script) and used &lt;em&gt;git bisect&lt;/em&gt; tool to chase this bug.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ffd9c717448eca895d19be8ee9718bc399ac34a7 is the first bad commit&lt;br/&gt;
commit ffd9c717448eca895d19be8ee9718bc399ac34a7&lt;br/&gt;
Author: Mark Robert Miller &amp;lt;markrmiller@apache.org&amp;gt;&lt;br/&gt;
Date:   Thu Jun 30 13:59:59 2011 +0000&lt;/p&gt;

&lt;p&gt;      &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2193&quot; title=&quot;Re-architect Update Handler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2193&quot;&gt;&lt;del&gt;SOLR-2193&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2565&quot; title=&quot;Prevent IW#close and cut over to IW#commit&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-2565&quot;&gt;&lt;del&gt;SOLR-2565&lt;/del&gt;&lt;/a&gt;: The default Solr update handler has been improved so&lt;br/&gt;
      that it uses fewer locks, keeps the IndexWriter open rather than closing it&lt;br/&gt;
      on each commit (ie commits no longer wait for background merges to complete),&lt;br/&gt;
      works with SolrCore to provide faster &apos;soft&apos; commits, and has an improved API&lt;br/&gt;
      that requires less instanceof special casing.&lt;/p&gt;

&lt;p&gt;      You may now specify a &apos;soft&apos; commit when committing. This will&lt;br/&gt;
      use Lucene&apos;s NRT feature to avoid guaranteeing documents are on stable storage in exchange&lt;br/&gt;
      for faster reopen times. There is also a new &apos;soft&apos; autocommit tracker that can be&lt;br/&gt;
      configured.&lt;/p&gt;

&lt;p&gt;     SolrCores now properly share IndexWriters across SolrCore reloads.&lt;/p&gt;

&lt;p&gt;    git-svn-id: &lt;a href=&quot;https://svn.apache.org/repos/asf/lucene/dev/trunk@1141542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/lucene/dev/trunk@1141542&lt;/a&gt; 13f79535-47bb-0310-9956-ffa450edef68&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It looks like sharing IndexWriters across SolrCore reloads could be the root cause, right?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596575">SOLR-3587</key>
            <summary>After reloading a SolrCore, the original Analyzer is still used rather than a new one.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="alexey.serba">Alexey Serba</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Jul 2012 08:33:37 +0000</created>
                <updated>Mon, 9 May 2016 18:48:49 +0000</updated>
                            <resolved>Tue, 3 Jul 2012 18:22:35 +0000</resolved>
                                    <version>4.0-ALPHA</version>
                                    <fixVersion>4.0-BETA</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13404951" author="alexey" created="Mon, 2 Jul 2012 09:08:40 +0000"  >&lt;p&gt;Added Solr test&lt;/p&gt;</comment>
                            <comment id="13405392" author="markrmiller@gmail.com" created="Mon, 2 Jul 2012 22:19:38 +0000"  >&lt;p&gt;I have an early hack attempt at a workaround for this. It starts opening a new writer again, but also tracks how many writers are being used by forcing the caller to call a release method. When it&apos;s time to open a new writer, we stop giving the writer out, wait for all refs to come in, then open the new writer - then start giving refs to the new writer out.&lt;/p&gt;

&lt;p&gt;Some things that complicate this:&lt;/p&gt;

&lt;p&gt;An NRT reader takes the writer as an argument. I have not dealt with this, and I don&apos;t yet know how to do so nicely.&lt;/p&gt;

&lt;p&gt;A couple tests needed to be changed to use a FSDirectory because on rebooting the writer, no existing index was found in the RAMDir.&lt;/p&gt;

&lt;p&gt;Still mostly an exploratory idea/solution.&lt;/p&gt;

&lt;p&gt;I&apos;ll post an ugly patch in a while, but headed out for a bit now.&lt;/p&gt;</comment>
                            <comment id="13405407" author="yseeley@gmail.com" created="Mon, 2 Jul 2012 22:45:56 +0000"  >&lt;p&gt;Can&apos;t we just pass null for the writer analyzer (or a dummy one if it can&apos;t be null) and then just use the IW APIs that accept Analyzer?&lt;/p&gt;</comment>
                            <comment id="13405454" author="markrmiller@gmail.com" created="Tue, 3 Jul 2012 00:00:35 +0000"  >&lt;p&gt;Ah - still new to IWConfig - I was looking through the live stuff to try and change the analyzer.&lt;/p&gt;

&lt;p&gt;So that will still leave the other settings unchangeable, but its a much cleaner solution, and the analyzer is really the deal killer here, so I&apos;ll give that a shot.&lt;/p&gt;</comment>
                            <comment id="13405468" author="hossman" created="Tue, 3 Jul 2012 00:24:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;...the analyzer is really the deal killer here...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yeah, if there is a clean way to make sure we get the analyzer working in 4.0 that should be the main priority.&lt;/p&gt;

&lt;p&gt;if there are other ways to do &quot;live&quot; indexwriter setting changes that can make it into 4.0 great, but worse case scenerio we can always document the caveat (or even have an alternate code path where we compare the settings and if they&apos;ve changed to a hard close and let some updates fail) ... but that&apos;s really secondary.&lt;/p&gt;

&lt;p&gt;the number of people who care about RELOADing cores with low level IW settings modified is probably a lot less then the number of people tweaking schema.xml&lt;/p&gt;</comment>
                            <comment id="13405888" author="markrmiller@gmail.com" created="Tue, 3 Jul 2012 12:45:33 +0000"  >&lt;p&gt;mentioned patch attached for posterity - I&apos;m going to give a shot at just updating the analyzer now.&lt;/p&gt;</comment>
                            <comment id="13405942" author="markrmiller@gmail.com" created="Tue, 3 Jul 2012 14:04:07 +0000"  >&lt;p&gt;Another simple patch with alexey&apos;s test (now passes) that simply uses an updated analyzer. I made a new issue for the other IW settings.&lt;/p&gt;</comment>
                            <comment id="13405961" author="markrmiller@gmail.com" created="Tue, 3 Jul 2012 18:22:35 +0000"  >&lt;p&gt;Committed - thanks all!&lt;/p&gt;</comment>
                            <comment id="13412243" author="hossman" created="Wed, 11 Jul 2012 22:33:57 +0000"  >&lt;p&gt;hoss20120711-manual-post-40alpha-change&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12478201">SOLR-2193</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12508922">SOLR-2565</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12597245">SOLR-3592</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12534873" name="SOLR-3587.patch" size="9228" author="markrmiller@gmail.com" created="Tue, 3 Jul 2012 14:04:07 +0000"/>
                            <attachment id="12534861" name="SOLR-3587.patch" size="23962" author="markrmiller@gmail.com" created="Tue, 3 Jul 2012 12:45:33 +0000"/>
                            <attachment id="12534190" name="SOLR-3587.patch" size="7256" author="alexey.serba" created="Mon, 2 Jul 2012 09:08:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03dsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17669</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>