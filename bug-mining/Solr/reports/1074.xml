<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:30:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3961] LimitTokenCountFilterFactory config parsing is totally broken</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3961</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;As noted on the mailing list, LimitTokenCountFilterFactory throws a NumberFormatException because it tries to use the value of it&apos;s config param as a key to look up another param that it parses as an integer ... totally ridiculous.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12612282">SOLR-3961</key>
            <summary>LimitTokenCountFilterFactory config parsing is totally broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Oct 2012 19:07:05 +0000</created>
                <updated>Mon, 9 May 2016 18:45:36 +0000</updated>
                            <resolved>Tue, 15 Jan 2013 21:22:06 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13478256" author="hossman" created="Wed, 17 Oct 2012 19:08:32 +0000"  >&lt;p&gt;From the list...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;I read the following in the example solrconfig:

 &amp;lt;!-- maxFieldLength was removed in 4.0. To get similar behavior, include a
         LimitTokenCountFilterFactory in your fieldType definition. E.g.
     &amp;lt;filter class=&quot;solr.LimitTokenCountFilterFactory&quot; maxTokenCount=&quot;10000&quot;/&amp;gt;
    --&amp;gt;

I tried that as follows:

...
&amp;lt;fieldType name=&quot;textgen&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot;&amp;gt;
      &amp;lt;analyzer type=&quot;index&quot;&amp;gt;
        &amp;lt;tokenizer class=&quot;solr.StandardTokenizerFactory&quot;/&amp;gt;
        &amp;lt;filter class=&quot;solr.LimitTokenCountFilterFactory&quot;
maxTokenCount=&quot;100000&quot;/&amp;gt;
        &amp;lt;filter class=&quot;solr.WordDelimiterFilterFactory&quot;
generateWordParts=&quot;1&quot; generateNumberParts=&quot;1&quot; catenateWords=&quot;0&quot;
catenateNumbers=&quot;0&quot; catenateAll=&quot;0&quot; splitOnCaseChange=&quot;0&quot;/&amp;gt;
        &amp;lt;filter class=&quot;solr.LowerCaseFilterFactory&quot;/&amp;gt;
        &amp;lt;filter class=&quot;solr.SnowballPorterFilterFactory&quot; language=&quot;German&quot;
/&amp;gt;
        &amp;lt;filter class=&quot;solr.StopFilterFactory&quot; ignoreCase=&quot;true&quot;
words=&quot;stopwords.txt&quot; enablePositionIncrements=&quot;true&quot; /&amp;gt;
        &amp;lt;filter class=&quot;solr.RemoveDuplicatesTokenFilterFactory&quot; /&amp;gt;
      &amp;lt;/analyzer&amp;gt;
...

The LimitTokenCountFilterFactory configured like that crashes the startup
of the corresponding core with the following exception (without the Factory
the core startup works):


17.10.2012 17:44:19 org.apache.solr.common.SolrException log
SCHWERWIEGEND: null:org.apache.solr.common.SolrException: Plugin init
failure for [schema.xml] fieldType &quot;textgen&quot;: Plugin init failure for
[schema.xml] analyze
r/filter: null
        at
org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:177)
        at
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And as Jack noted...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Anybody want to guess what&apos;s wrong with this code:

String maxTokenCountArg = args.get(&quot;maxTokenCount&quot;);
if (maxTokenCountArg == null) {
 throw new IllegalArgumentException(&quot;maxTokenCount is mandatory.&quot;);
}
maxTokenCount = Integer.parseInt(args.get(maxTokenCountArg));

Hmmm... try this &quot;workaround&quot;:

    &amp;lt;filter class=&quot;solr.LimitTokenCountFilterFactory&quot; maxTokenCount=&quot;foo&quot; foo=&quot;10000&quot;/&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13478306" author="hossman" created="Wed, 17 Oct 2012 19:49:29 +0000"  >
&lt;p&gt;i modified one of the test schemas to include LImitTOkenCountFilterFactory to quickly demonstrate the init failure, then banged out a quick fix to the factory.  for added measure, i added a unit test of the factory itself, and seem to have uncovered another bug somewhere &amp;#8211; although i&apos;m not yet clear if it&apos;s in the Filter (violating the TokenStream contract) or in BaseTokenStreamTestCase (trying to enforce the contract)...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit4:junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=TestLimitTokenCountFilterFactory -Dtests.method=test -Dtests.seed=D40B43DE6627A1AB -Dtests.slow=true -Dtests.locale=mk -Dtests.timezone=Singapore -Dtests.file.encoding=US-ASCII
[junit4:junit4] FAILURE 0.13s | TestLimitTokenCountFilterFactory.test &amp;lt;&amp;lt;&amp;lt;
[junit4:junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: end() called before incrementToken() returned false!
[junit4:junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([D40B43DE6627A1AB:5C5F7C04C8DBCC53]:0)
[junit4:junit4]    &amp;gt; 	at org.apache.lucene.analysis.MockTokenizer.end(MockTokenizer.java:243)
[junit4:junit4]    &amp;gt; 	at org.apache.lucene.analysis.TokenFilter.end(TokenFilter.java:46)
[junit4:junit4]    &amp;gt; 	at org.apache.lucene.analysis.BaseTokenStreamTestCase.assertTokenStreamContents(BaseTokenStreamTestCase.java:239)
[junit4:junit4]    &amp;gt; 	at org.apache.lucene.analysis.BaseTokenStreamTestCase.assertTokenStreamContents(BaseTokenStreamTestCase.java:250)
[junit4:junit4]    &amp;gt; 	at org.apache.lucene.analysis.BaseTokenStreamTestCase.assertTokenStreamContents(BaseTokenStreamTestCase.java:262)
[junit4:junit4]    &amp;gt; 	at org.apache.lucene.analysis.miscellaneous.TestLimitTokenCountFilterFactory.test(TestLimitTokenCountFilterFactory.java:37)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m going to need another set of eyeballs on this.&lt;/p&gt;</comment>
                            <comment id="13478318" author="rcmuir" created="Wed, 17 Oct 2012 20:04:44 +0000"  >&lt;p&gt;For testing LimitTokenCountFilter, you need to set &lt;a href=&quot;http://lucene.apache.org/core/4_0_0/test-framework/org/apache/lucene/analysis/MockTokenizer.html#setEnableChecks%28boolean%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://lucene.apache.org/core/4_0_0/test-framework/org/apache/lucene/analysis/MockTokenizer.html#setEnableChecks%28boolean%29&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thats because LimitTokenCountFilter violates the workflow of the standard tokenstream API (&lt;a href=&quot;http://lucene.apache.org/core/4_0_0/core/org/apache/lucene/analysis/TokenStream.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://lucene.apache.org/core/4_0_0/core/org/apache/lucene/analysis/TokenStream.html&lt;/a&gt;)... it cuts off its consumer and calls end() even while that consumer still has more tokens: this could easily cause unexpected side effects and bugs.&lt;/p&gt;

&lt;p&gt;But we knew about this anyway: existing tests for LimitTokenCountFilter already do setEnableChecks(false) for this exact reason... this is just an explanation of why.&lt;/p&gt;</comment>
                            <comment id="13478456" author="hossman" created="Wed, 17 Oct 2012 22:27:12 +0000"  >&lt;p&gt;Thanks rmuir, setEnableChecks is the piece i was missing and using it makes the test pass, but i&apos;m still a little confused by the rest of your comment and what i&apos;m seeing in the tests...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But we knew about this anyway: existing tests for LimitTokenCountFilter already do setEnableChecks(false) for this exact reason... this is just an explanation of why.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;1)  HunspellStemFilterTest is the only lucene/analysis test i see using setEnableChecks (although there do seem to be some highlighter tests that use it, and TestIndexWriterExceptions uses it to ignore secondary problems since it&apos;s going out of it&apos;s way to force exceptions)&lt;/p&gt;

&lt;p&gt;2) i don&apos;t see any existing tests for LimitTokenCountFilter .. were they deleted by mistake?&lt;/p&gt;

&lt;p&gt;3) the closest thing i see to a test of LimitTokenCountFilter is TestLimitTokenCountAnalyzer - i realize now the reason it&apos;s testLimitTokenCountAnalyzer doesn&apos;t get the same failure is because it&apos;s wrapping WhitespaceAnalyzer, StandardAnalyzer - should those be changed to use MockTokenizer?&lt;/p&gt;

&lt;p&gt;4) TestLimitTokenCountAnalyzer also has a testLimitTokenCountIndexWriter that uses MockAnalyzer w/o calling setEnableChecks(false) which seems like it should trigger the same failure i got since it uses MockTokenizer, but in general that test looks suspicious, as it seems to add the &lt;b&gt;exact&lt;/b&gt; number of tokens that the limit is configured for, and then asserts that the last token is in the index - but never actaully triggers the limiting logic since exactly the allowed umber of tokens are used.&lt;/p&gt;</comment>
                            <comment id="13478487" author="rcmuir" created="Wed, 17 Oct 2012 23:13:26 +0000"  >&lt;blockquote&gt;
&lt;p&gt;HunspellStemFilterTest is the only lucene/analysis test i see using setEnableChecks&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It sets it to true, which is dead code (true is the default!).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;although there do seem to be some highlighter tests that use it&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Highlighter has a built-in limiter, that limits not based on tokencount, but accumulated # of analyzed chars. &lt;br/&gt;
So it disables it for the same reason as LimitTokenCount does or should&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2) i don&apos;t see any existing tests for LimitTokenCountFilter .. were they deleted by mistake?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think these are in TestLimitTokenCountAnalyzer? For lucene users this is the way you use this (just wrap your analyzer).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;3) the closest thing i see to a test of LimitTokenCountFilter is TestLimitTokenCountAnalyzer - i realize now the reason it&apos;s testLimitTokenCountAnalyzer doesn&apos;t get the same failure is because it&apos;s wrapping WhitespaceAnalyzer, StandardAnalyzer - should those be changed to use MockTokenizer?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should always do this!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;4) TestLimitTokenCountAnalyzer also has a testLimitTokenCountIndexWriter that uses MockAnalyzer w/o calling setEnableChecks(false) which seems like it should trigger the same failure i got since it uses MockTokenizer, but in general that test looks suspicious, as it seems to add the exact number of tokens that the limit is configured for, and then asserts that the last token is in the index - but never actaully triggers the limiting logic since exactly the allowed umber of tokens are used.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then thats fine, because when LimitTokenCountFilter consumes the whole stream, its a &quot;good consumer&quot;. its only when it actually truncates that it breaks the tokenstream contract.&lt;/p&gt;


</comment>
                            <comment id="13478491" author="hossman" created="Wed, 17 Oct 2012 23:30:47 +0000"  >&lt;p&gt;I spun off &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-4489&quot; title=&quot;improve LimitTokenCountFilter and/or it&amp;#39;s tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LUCENE-4489&quot;&gt;&lt;del&gt;LUCENE-4489&lt;/del&gt;&lt;/a&gt; for some of the remaining questions about testingLimitTokenCountFilter since it&apos;s really only tangentially related to this issue &amp;#8211; In the meantime i want to commit a fix for this factory bug.&lt;/p&gt;

&lt;p&gt;Committed revision 1399474. - trunk&lt;br/&gt;
Committed revision 1399482. - branch_4x&lt;/p&gt;

&lt;p&gt;...i&apos;m a little unclear as to how we&apos;re dealing with possible 4.0.1 fixes, so leaving this issue open for now until i figure it out.&lt;/p&gt;

&lt;p&gt;(BTW: Thanks for figuring out this problem Jack!)&lt;/p&gt;</comment>
                            <comment id="13554286" author="steve_rowe" created="Tue, 15 Jan 2013 20:24:52 +0000"  >&lt;p&gt;Hoss, I don&apos;t think there will be a 4.0.1 release - can this be resolved as fixed?&lt;/p&gt;</comment>
                            <comment id="13610667" author="commit-tag-bot" created="Fri, 22 Mar 2013 16:25:37 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Chris M. Hostetter&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1399482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1399482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3961&quot; title=&quot;LimitTokenCountFilterFactory config parsing is totally broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3961&quot;&gt;&lt;del&gt;SOLR-3961&lt;/del&gt;&lt;/a&gt;: Fixed error using LimitTokenCountFilterFactory (merge r1399474)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12549593" name="SOLR-3961.patch" size="4776" author="hossman" created="Wed, 17 Oct 2012 22:27:12 +0000"/>
                            <attachment id="12549562" name="SOLR-3961.patch" size="4634" author="hossman" created="Wed, 17 Oct 2012 19:49:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249369</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0a76f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>