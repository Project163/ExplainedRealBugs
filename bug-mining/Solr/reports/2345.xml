<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:02:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6832] Queries be served locally rather than being forwarded to another replica</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6832</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Currently, I see that code flow for a query in SolrCloud is as follows:&lt;/p&gt;

&lt;p&gt;For distributed query:&lt;br/&gt;
SolrCore -&amp;gt; SearchHandler.handleRequestBody() -&amp;gt; HttpShardHandler.submit()&lt;/p&gt;

&lt;p&gt;For non-distributed query:&lt;br/&gt;
SolrCore -&amp;gt; SearchHandler.handleRequestBody() -&amp;gt; QueryComponent.process()&lt;/p&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For a distributed query, the request is always sent to all the shards even if the originating SolrCore (handling the original distributed query) is a replica of one of the shards.&lt;br/&gt;
If the original Solr-Core can check itself before sending http requests for any shard, we can probably save some network hopping and gain some performance.&lt;/p&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can change SearchHandler.handleRequestBody() or HttpShardHandler.submit() to fix this behavior (most likely the former and not the latter).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12760806">SOLR-6832</key>
            <summary>Queries be served locally rather than being forwarded to another replica</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thelabdude">Timothy Potter</assignee>
                                    <reporter username="sachingoyal">Sachin Goyal</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Dec 2014 17:14:12 +0000</created>
                <updated>Mon, 9 Dec 2019 14:03:00 +0000</updated>
                            <resolved>Sat, 14 Feb 2015 03:04:28 +0000</resolved>
                                    <version>4.10.2</version>
                                    <fixVersion>5.1</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14241408" author="sachingoyal" created="Wed, 10 Dec 2014 17:23:39 +0000"  >&lt;p&gt;The performance gain increases if coresPerMachine is &amp;gt; 1 and a single JVM has cores from &apos;k&apos; shards.&lt;/p&gt;</comment>
                            <comment id="14242231" author="elyograg" created="Thu, 11 Dec 2014 06:54:33 +0000"  >&lt;p&gt;I have concerns, but I don&apos;t want to derail the work.  There are use-cases for which this would be very useful, but many other use-cases where it would cause a single machine to crumble under the load while other machines in the cloud are nearly idle.&lt;/p&gt;

&lt;p&gt;Duplicating what I said on the dev@l.a.o thread:&lt;/p&gt;

&lt;p&gt;Consider a SolrCloud that is handling 5000 requests per second with a replicationFactor of 20 or 30.  This could be one shard or multiple shards.  Currently, those requests will be load balanced to the entire cluster.  If this option is implemented, suddenly EVERY request will have at least one part handled locally ... and unless the index is very tiny or 99 percent of the queries hit a Solr cache, one index core simply won&apos;t be able to handle 5000 queries per second.  Getting a single machine capable of handling that load MIGHT be possible, but it would likely be &lt;b&gt;VERY&lt;/b&gt; expensive.&lt;/p&gt;

&lt;p&gt;This would be great as an &lt;b&gt;OPTION&lt;/b&gt; that can be enabled when the index composition and query patterns dictate it will be beneficial ... but it definitely should not be default behavior.&lt;/p&gt;</comment>
                            <comment id="14244844" author="ayonsinha" created="Fri, 12 Dec 2014 21:50:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elyograg&quot; class=&quot;user-hover&quot; rel=&quot;elyograg&quot;&gt;elyograg&lt;/a&gt;, I work with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sachingoyal&quot; class=&quot;user-hover&quot; rel=&quot;sachingoyal&quot;&gt;sachingoyal&lt;/a&gt;. The background of this patch is that, we have a cluster of 14 machines actually serving upwards of 5000 qps, and when one machine goes into a multi-second GC pause, it easily brings down the entire cluster. I know this is not the sole cause of the distributed deadlock and we definitely fixed other things like (gc pauses, thread counts etc) to reduce the likelihood of this problem.&lt;/p&gt;

&lt;p&gt;In the scenario that you mention, the load balancer outside SolrCloud is at fault and when that is the case we&apos;d like it to take down only one replica rather than propagate the problem to other replicas.&lt;/p&gt;

&lt;p&gt;So to be clear, when this Option is ON, the only thing you&apos;ll &quot;lose&quot; is extra load balancing among the shard-queries. And frankly when I have all the shards in the same node, I prefer to NOT go over the network as network is among the most unreliable and taxed resource in cloud environments. When we go over the network to another compute, I have no idea what is carrying me over there and how is that other node doing overall. &lt;br/&gt;
We will post our results on the benefit of having this option as ON.&lt;/p&gt;</comment>
                            <comment id="14245538" author="elyograg" created="Sat, 13 Dec 2014 21:09:40 +0000"  >&lt;p&gt;That sounds like a perfect use-case for this option.  In your setup, you have an external load balancer and are not relying on SolrCloud itself or the zookeeper-aware Java client (CloudSolrServer) to do the load balancing for you.  For an environment like that, letting SolrCloud forward the request adds a completely unnecessary network hop, along with new Java objects and subsequent garbage that must be collected.&lt;/p&gt;

&lt;p&gt;This is why I said I didn&apos;t want to derail the work.  If you have a solution, we should try to get it to a state where it can be committed.  It is very clear that it will be an immense help for many users.  I just don&apos;t want it to become the default.&lt;/p&gt;

&lt;p&gt;Trying to come up with a useful and descriptive option name that&apos;s not horribly long ... that&apos;s a challenge. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Something like handleRequestsLocally may be too generic, but it&apos;s a lot shorter than handleShardRequestsLocallyIfPossible!&lt;/p&gt;</comment>
                            <comment id="14245587" author="ayonsinha" created="Sat, 13 Dec 2014 22:02:49 +0000"  >&lt;p&gt;Our clients actually do use CloudSolrServer (LB SolrJ client). Is there something we should be worrying about there? We are under the impression that the Zk aware CloudSolrServer is doing a round-robin load balancing sending query requests.&lt;/p&gt;

&lt;p&gt;We only intend to &apos;preferLocalShards&apos; on the Solr node side only.&lt;/p&gt;

&lt;p&gt;BTW, how is the name &apos;preferLocalShards&apos; ?&lt;/p&gt;</comment>
                            <comment id="14245665" author="elyograg" created="Sat, 13 Dec 2014 22:56:59 +0000"  >&lt;p&gt;CloudSolrServer does load balance, so you do not need an external load balancer.  Internally, it uses changes in the zookeeper clusterstate to add and remove URLs on an instance of LBHttpSolrServer, which in turn uses HttpSolrServer for each of those URLs.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://lucene.apache.org/solr/4_10_2/solr-solrj/org/apache/solr/client/solrj/impl/LBHttpSolrServer.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lucene.apache.org/solr/4_10_2/solr-solrj/org/apache/solr/client/solrj/impl/LBHttpSolrServer.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The name preferLocalShards is perfect ... and I think a good case can be made for CloudSolrServer using this for queries (probably via a query URL parameter) by default.&lt;/p&gt;</comment>
                            <comment id="14245667" author="elyograg" created="Sat, 13 Dec 2014 23:01:38 +0000"  >&lt;p&gt;we might even be able to shorten the parameter name to preferLocal, but that will require some further thought.  I&apos;d hate to have the shorter version be in use when another preferLocalXXX requirement comes up.&lt;/p&gt;</comment>
                            <comment id="14246130" author="elyograg" created="Sun, 14 Dec 2014 21:13:43 +0000"  >&lt;p&gt;A slightly better choice might be preferLocalReplicas ... but Shards is pretty good too.&lt;/p&gt;</comment>
                            <comment id="14249429" author="sachingoyal" created="Wed, 17 Dec 2014 03:52:29 +0000"  >&lt;p&gt;Attaching a patch for this ticket.&lt;/p&gt;

&lt;p&gt;The patch creates an option &lt;b&gt;preferLocalShards&lt;/b&gt; in solrconfig.xml and in the query request params (giving more preference to the one in the query).&lt;/p&gt;

&lt;p&gt;If this option is set, &lt;b&gt;HttpShardHandler.preferCurrentHostForDistributedReq()&lt;/b&gt; tries to find a local URL and puts that URL as the first one in the list of URLs sent to LBHttpSolrServer. This ensures that the current host&apos;s cores will be given preference for distributed queries.&lt;/p&gt;

&lt;p&gt;Other important function is &lt;b&gt;ResponseBuilder.findCurrentHostAddress()&lt;/b&gt; which tries to find the current host&apos;s URL by searching for current core&apos;s name in the list of shards. The URL found by this function is used by the HttpShardHandle&apos;s function above.&lt;/p&gt;

&lt;p&gt;Default value of the option is kept as &apos;false&apos; to ensure normal behavior.&lt;/p&gt;</comment>
                            <comment id="14303922" author="thelabdude" created="Tue, 3 Feb 2015 20:34:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sachingoyal&quot; class=&quot;user-hover&quot; rel=&quot;sachingoyal&quot;&gt;sachingoyal&lt;/a&gt; Thanks for the patch! I&apos;m working to get it to a committable state.&lt;/p&gt;

&lt;p&gt;I don&apos;t think adding &lt;tt&gt;preferLocalShards&lt;/tt&gt; as a collection-level setting (in SolrConfig) adds much value here. If an operator wants to enforce that query parameter for all requests, they can use the built-in support for defaults or invariants on the appropriate query request handler, e.g. to make this the default on the /select handler, you could do:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &amp;lt;requestHandler name=&lt;span class=&quot;code-quote&quot;&gt;&quot;/select&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SearchHandler&quot;&lt;/span&gt;&amp;gt;
     &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;defaults&quot;&lt;/span&gt;&amp;gt;
       &amp;lt;str name=&lt;span class=&quot;code-quote&quot;&gt;&quot;echoParams&quot;&lt;/span&gt;&amp;gt;explicit&amp;lt;/str&amp;gt;
       &amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt;&amp;gt;10&amp;lt;/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
       &amp;lt;bool name=&lt;span class=&quot;code-quote&quot;&gt;&quot;preferLocalShards&quot;&lt;/span&gt;&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/bool&amp;gt;
       ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both approaches require some config changes in solrconfig.xml, but the latter (my suggestion) avoids adding new code / config settings. That said, please let me know if you think there&apos;s another reason to have this as an explicit setting in solrconfig.xml.&lt;/p&gt;

&lt;p&gt;Also, all the code in &lt;tt&gt;findCurrentHostAddress&lt;/tt&gt; can simply be replaced by &lt;tt&gt;ZkController.getBaseUrl()&lt;/tt&gt; when needed.&lt;/p&gt;</comment>
                            <comment id="14304014" author="sachingoyal" created="Tue, 3 Feb 2015 21:20:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt;, I do not feel very strongly about the configuration option in solrconfig.xml&lt;br/&gt;
I kept it here only because specifying a global option looked simpler to use.&lt;/p&gt;

&lt;p&gt;I will try the ZkController.getBaseUrl() and update the patch shortly with the above suggestions.&lt;/p&gt;

&lt;p&gt;Thank you for reviewing.&lt;/p&gt;</comment>
                            <comment id="14304033" author="thelabdude" created="Tue, 3 Feb 2015 21:28:04 +0000"  >&lt;p&gt;Awesome - btw ... in case you haven&apos;t seen this before, it&apos;s a little cumbersome to get at the ZkController from the req object, something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;req.getCore().getCoreDescriptor().getCoreContainer().getZkController().getBaseUrl()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14304149" author="sachingoyal" created="Tue, 3 Feb 2015 22:25:07 +0000"  >&lt;p&gt;Oh great. Thanks for saving me a search for the ZkController &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14304309" author="sachingoyal" created="Tue, 3 Feb 2015 23:33:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt;, here is a new patch with the above comments incorporated.&lt;br/&gt;
I have checked that &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;req.getCore().getCoreDescriptor().getCoreContainer().getZkController().getBaseUrl()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; works well and so &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ResponseBuilder. findCurrentHostAddress()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is no longer required.&lt;/p&gt;

&lt;p&gt;Configuration change is also done.&lt;/p&gt;</comment>
                            <comment id="14307520" author="thelabdude" created="Thu, 5 Feb 2015 16:40:37 +0000"  >&lt;p&gt;Thanks for the updated patch. Only thing we need now is a good unit test. I can take a stab at that over the next few days.&lt;/p&gt;</comment>
                            <comment id="14312895" author="sachingoyal" created="Mon, 9 Feb 2015 21:18:24 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt;.&lt;br/&gt;
If you can point me to some existing test-case from where I can see the creation of multiple nodes&apos; cluster and running updates/queries on the same, then I can help with unit test creation.&lt;/p&gt;</comment>
                            <comment id="14315259" author="sachingoyal" created="Wed, 11 Feb 2015 00:24:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt;, I have included a unit-test in the new patch.&lt;/p&gt;

&lt;p&gt;This tests that response is received from local cores only when `preferLocalShards` is set to true in the query.&lt;/p&gt;</comment>
                            <comment id="14316692" author="thelabdude" created="Wed, 11 Feb 2015 18:16:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sachingoyal&quot; class=&quot;user-hover&quot; rel=&quot;sachingoyal&quot;&gt;sachingoyal&lt;/a&gt; It seems like your latest patch was created / tested against branch4x vs. trunk? It&apos;s better to work against trunk for new features and then we&apos;ll back-port the changes as needed. I went ahead and migrated your patch to work with trunk and cleaned up a few places in the code. Overall looking good!&lt;/p&gt;</comment>
                            <comment id="14316697" author="thelabdude" created="Wed, 11 Feb 2015 18:17:45 +0000"  >&lt;p&gt;Also, I don&apos;t think we need to include this parameter in all of the configs, as we&apos;re trying to get away from bloated configs. So I changed the patch to just include in the sample techproducts configs. We&apos;ll also need to document this parameter in the Solr reference guide.&lt;/p&gt;</comment>
                            <comment id="14316779" author="sachingoyal" created="Wed, 11 Feb 2015 19:05:04 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt;.&lt;br/&gt;
Please let me know how we can get this committed into the trunk and I can edit the Solr reference guide.&lt;br/&gt;
I would also like to back-port this into the 5x branch.&lt;/p&gt;</comment>
                            <comment id="14320851" author="thelabdude" created="Fri, 13 Feb 2015 22:13:01 +0000"  >&lt;p&gt;Working on committing this now.&lt;/p&gt;</comment>
                            <comment id="14321177" author="jira-bot" created="Sat, 14 Feb 2015 02:40:07 +0000"  >&lt;p&gt;Commit 1659748 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1659748&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1659748&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6832&quot; title=&quot;Queries be served locally rather than being forwarded to another replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6832&quot;&gt;&lt;del&gt;SOLR-6832&lt;/del&gt;&lt;/a&gt;: Queries be served locally rather than being forwarded to another replica&lt;/p&gt;</comment>
                            <comment id="14321192" author="jira-bot" created="Sat, 14 Feb 2015 03:06:10 +0000"  >&lt;p&gt;Commit 1659750 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1659750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1659750&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6832&quot; title=&quot;Queries be served locally rather than being forwarded to another replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6832&quot;&gt;&lt;del&gt;SOLR-6832&lt;/del&gt;&lt;/a&gt;: Queries be served locally rather than being forwarded to another replica&lt;/p&gt;</comment>
                            <comment id="14321249" author="sachingoyal" created="Sat, 14 Feb 2015 05:30:29 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thelabdude&quot; class=&quot;user-hover&quot; rel=&quot;thelabdude&quot;&gt;thelabdude&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14337776" author="otis" created="Thu, 26 Feb 2015 03:14:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;The performance gain increases if coresPerMachine is &amp;gt; 1 and a single JVM has cores from &apos;k&apos; shards.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ever managed to measure how much this feature helps in various scenarios?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For a distributed query, the request is always sent to all the shards even if the originating SolrCore (handling the original distributed query) is a replica of one of the shards.  If the original Solr-Core can check itself before sending http requests for any shard, we can probably save some network hopping and gain some performance.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This sounds as like it saves only a N local calls out of M, where M &amp;gt; N, N is the number of local replicas that could be queried locally, and M is the total number of primary shards in the cluster that are to be queries.  Is this correct?&lt;/p&gt;

&lt;p&gt;So say there are 20 shards spread evenly over 20 nodes (i.e., 1 shard per node) and a query request comes in, the node that got the request will query send 19 requests to the remaining 19 nodes and thus save just one network trip by querying a local shard?  I must be missing something...&lt;/p&gt;</comment>
                            <comment id="14337800" author="ayonsinha" created="Thu, 26 Feb 2015 03:35:33 +0000"  >&lt;p&gt;@Otis, you are correct. This helps only where there is over-sharding. And in our particular scenario where we sharded to get better CPU core utilization and write speeds based on Tim&apos;s experiments with over-sharding. Since all queries were send to other nodes, we were getting hit with distributed deadlocks more often when one or more nodes were slow/overloaded.&lt;br/&gt;
So this patch is a slight optimization and a reduction of likelihood of getting bogged down by other slow nodes when the parent query node has the core.&lt;/p&gt;</comment>
                            <comment id="14337817" author="otis" created="Thu, 26 Feb 2015 03:51:49 +0000"  >&lt;p&gt;Hmmmm.... didn&apos;t examine the patch or tried this functionality, but based on your description... here are some comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This helps only where there is over-sharding.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That in itself should be avoided whenever possible in my experience. Overhead around memory and communication during querying.  Could be related to your deadlocks.  Or maybe you do a ton more writes so distributing writes across all nodes is worth the query-time overhead of over-sharding?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since all queries were send to other nodes, we were getting hit with distributed deadlocks more often when one or more nodes were slow/overloaded.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmmmm... if that is truly happening, then isn&apos;t that a separate issue to be fixed?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So this patch is a slight optimization and a reduction of likelihood of getting bogged down by other slow nodes when the parent query node has the core.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But VERY slight, right? (hence my Q about whether you&apos;ve quantified the improvement from this patch)&lt;/p&gt;

&lt;p&gt;Intuitively, querying the local data makes sense - why would one not do that if the data is right there.  I just wonder how much you really benefit if you are saving just 1 (or very small) number of network calls in request that ends up dispatching NN requests to NN other nodes in the cluster.&lt;/p&gt;</comment>
                            <comment id="14337866" author="ayonsinha" created="Thu, 26 Feb 2015 04:48:38 +0000"  >&lt;p&gt;Actually, in our experience, network has been the most flaky piece. So any network hop saved is a big deal.&lt;/p&gt;

&lt;p&gt;And again you are right that the root cause (first domino) of the distributed deadlock is yet to be identified. What we see is when 1 machine in the cluster goes for a GC pause or traffic spike, it brings down all the other machines be quickly. The slow machine currently does not tell ZK that its struggling and hence all other nodes keep sending it queries. This is being addressed in another JIRA.&lt;/p&gt;

&lt;p&gt;This particular patch buys us some time.&lt;/p&gt;</comment>
                            <comment id="14495246" author="thelabdude" created="Wed, 15 Apr 2015 00:30:15 +0000"  >&lt;p&gt;Bulk close after 5.1 release&lt;/p&gt;</comment>
                            <comment id="14578181" author="sachingoyal" created="Tue, 9 Jun 2015 01:54:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7121&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-7121&lt;/a&gt; is a patch to address the other part of this problem.&lt;br/&gt;
It helps nodes become aware of their slowness and tell the ZK that they should be moved out of the network for a while.&lt;br/&gt;
When their health has recovered, the nodes automatically request the ZK to be joined back in the cluster.&lt;/p&gt;

&lt;p&gt;These two patches have resulted in making our cluster stable, though we have yet to quantify by how much (Quantification is not really a priority right now given that we will need to compare the cluster with an un-patched cluster and then put load on them to bring them down etc.)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13020513">SOLR-9758</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13273390">SOLR-14035</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12913411">SOLR-8298</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12698147" name="SOLR-6832.patch" size="14053" author="thelabdude" created="Wed, 11 Feb 2015 18:16:22 +0000"/>
                            <attachment id="12697935" name="SOLR-6832.patch" size="17173" author="sachingoyal" created="Wed, 11 Feb 2015 00:24:36 +0000"/>
                            <attachment id="12696321" name="SOLR-6832.patch" size="10215" author="sachingoyal" created="Tue, 3 Feb 2015 23:33:03 +0000"/>
                            <attachment id="12687662" name="SOLR-6832.patch" size="13256" author="sachingoyal" created="Wed, 17 Dec 2014 03:52:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23aen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>