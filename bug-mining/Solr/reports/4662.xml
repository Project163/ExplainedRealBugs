<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:47:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11921] cursorMark ClassCastException (or incorrect results) when combined with QueryElevationComponent</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11921</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When cursorMark pagination is used together with elevateIds, an exception is thrown.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Steps to reproduce described below.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;1. Start solr with the `demo` core&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;docker run --name solr_cursor_elevate -d -p 8983:8983 solr:7.2 solr-demo&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2. Add some test documents&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;curl &lt;a href=&quot;http://localhost:8983/solr/demo/update?commit=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/demo/update?commit=true&lt;/a&gt; -d &apos;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;[&lt;/tt&gt;&lt;br/&gt;
{{ {&quot;id&quot; : &quot;book1&quot;,}}&lt;br/&gt;
{{ &quot;title_t&quot; : &quot;book one&quot;}}&lt;br/&gt;
{{ },}}&lt;br/&gt;
{{ {&quot;id&quot; : &quot;book2&quot;,}}&lt;br/&gt;
{{ &quot;title_t&quot; : &quot;book two&quot;}}&lt;br/&gt;
{{ },}}&lt;br/&gt;
{{ {&quot;id&quot; : &quot;book3&quot;,}}&lt;br/&gt;
{{ &quot;title_t&quot; : &quot;book three&quot;}}&lt;br/&gt;
{{ }}}&lt;br/&gt;
&lt;tt&gt;]&apos;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3. Execute a query with cursorMark and elevateIds&lt;/p&gt;

&lt;p&gt;curl &apos;&lt;a href=&quot;http://localhost:8983/solr/demo/elevate?cursorMark=*&amp;amp;elevateIds=book3&amp;amp;enableElevation=true&amp;amp;df=title_t&amp;amp;fl=id,title_t&amp;amp;forceElevation=true&amp;amp;q=book&amp;amp;rows=2&amp;amp;sort=id%20asc%27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/demo/elevate?cursorMark=*&amp;amp;elevateIds=book3&amp;amp;enableElevation=true&amp;amp;df=title_t&amp;amp;fl=id,title_t&amp;amp;forceElevation=true&amp;amp;q=book&amp;amp;rows=2&amp;amp;sort=id%20asc&apos;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Observe the stacktrace:&lt;br/&gt;
null:java.lang.ClassCastException: java.lang.Integer cannot be cast to org.apache.lucene.util.BytesRef&lt;br/&gt;
	at org.apache.solr.schema.FieldType.marshalStringSortValue(FieldType.java:1127)&lt;br/&gt;
	at org.apache.solr.schema.StrField.marshalSortValue(StrField.java:100)&lt;br/&gt;
	at org.apache.solr.search.CursorMark.getSerializedTotem(CursorMark.java:250)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.doProcessUngroupedSearch(QueryComponent.java:1445)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:375)&lt;br/&gt;
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:295)&lt;br/&gt;
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:177)&lt;br/&gt;
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:2503)&lt;br/&gt;
	at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:710)&lt;br/&gt;
	at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:516)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:382)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:326)&lt;br/&gt;
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1751)&lt;br/&gt;
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)&lt;br/&gt;
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)&lt;br/&gt;
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)&lt;br/&gt;
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)&lt;br/&gt;
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)&lt;br/&gt;
	at org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)&lt;br/&gt;
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)&lt;br/&gt;
	at org.eclipse.jetty.server.Server.handle(Server.java:534)&lt;br/&gt;
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)&lt;br/&gt;
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)&lt;br/&gt;
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:283)&lt;br/&gt;
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:108)&lt;br/&gt;
	at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13134331">SOLR-11921</key>
            <summary>cursorMark ClassCastException (or incorrect results) when combined with QueryElevationComponent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="groodt">Greg Roodt</reporter>
                        <labels>
                    </labels>
                <created>Sun, 28 Jan 2018 23:28:46 +0000</created>
                <updated>Wed, 23 Jun 2021 13:42:57 +0000</updated>
                            <resolved>Mon, 5 Apr 2021 19:11:59 +0000</resolved>
                                    <version>7.2</version>
                                    <fixVersion>9.0</fixVersion>
                    <fixVersion>8.9</fixVersion>
                                    <component>SearchComponents - other</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16790749" author="mmarrero" created="Tue, 12 Mar 2019 16:52:21 +0000"  >&lt;p&gt;I have the same problem: when cursorMark is used together with elevation an error is thrown if we want to force the elevated documents to appear first.&lt;/p&gt;

&lt;p&gt;I reproduced the error with Solr 7.7 and the techproducts collection. This is what happens:&lt;/p&gt;

&lt;p&gt;Request1:&#160;&lt;a href=&quot;http://localhost:8983/solr/techproducts/elevate?q=ipod&amp;amp;df=text&amp;amp;fl=id,[elevated],score&amp;amp;rows=2&amp;amp;sort=id%20asc&amp;amp;cursorMark=*&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/techproducts/elevate?q=ipod&amp;amp;df=text&amp;amp;fl=id,[elevated],score&amp;amp;rows=2&amp;amp;sort=id%20asc&amp;amp;cursorMark=*&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Result1: Works fine but the document is not boosted to the first results (we are ordering just by id)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Request2: &lt;a href=&quot;http://localhost:8983/solr/techproducts/elevate?q=ipod&amp;amp;df=text&amp;amp;fl=id,[elevated],score&amp;amp;rows=2&amp;amp;*sort=id%20asc&amp;amp;forceElevation=true*&amp;amp;cursorMark=*&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/techproducts/elevate?q=ipod&amp;amp;df=text&amp;amp;fl=id,[elevated],score&amp;amp;rows=2&amp;amp;*sort=id%20asc&amp;amp;forceElevation=true*&amp;amp;cursorMark=*&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Result2:&#160;Error: java.lang.Integer cannot be cast to org.apache.lucene.util.BytesRef&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Request3: &lt;a href=&quot;http://localhost:8983/solr/techproducts/elevate?q=ipod&amp;amp;df=text&amp;amp;fl=id,[elevated],score&amp;amp;cursorMark=*&amp;amp;rows=2&amp;amp;*sort=score%20desc,%20id%20asc*&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/techproducts/elevate?q=ipod&amp;amp;df=text&amp;amp;fl=id,[elevated],score&amp;amp;cursorMark=*&amp;amp;rows=2&amp;amp;*sort=score%20desc,%20id%20asc*&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Result3: Error:java.lang.Float cannot be cast to org.apache.lucene.util.BytesRef&lt;/p&gt;</comment>
                            <comment id="16790779" author="erickerickson" created="Tue, 12 Mar 2019 17:22:47 +0000"  >&lt;p&gt;Hmmm, what&apos;s the use case? Should the same documents appear at the top of every page as you&apos;re paging?&lt;/p&gt;

&lt;p&gt;CursorMark is intended to handle the &quot;deep paging&quot; issue where &quot;start&quot; is at least in the hundreds. If this combination is intended to keep the elevated documents at the top of successive pages while a user pages, cursorMark is overkill and a workaround would be to just use start without cursormark.&lt;/p&gt;</comment>
                            <comment id="16791452" author="mmarrero" created="Wed, 13 Mar 2019 08:42:15 +0000"  >&lt;p&gt;The idea is that the elevated document appears in the first result of the first page, but you can still use pagination to access the next pages (where that document should not appear, of course).&lt;/p&gt;</comment>
                            <comment id="16791843" author="erickerickson" created="Wed, 13 Mar 2019 16:07:36 +0000"  >&lt;p&gt;Then the question still stands whether cursorMark is necessary.&lt;/p&gt;

&lt;p&gt;I&apos;m not disagreeing that this is a bug, but cursorMark is intended for a start parameter that&apos;s in the hundreds at least.&lt;/p&gt;

&lt;p&gt;So can you work around it in this case by &lt;em&gt;not&lt;/em&gt; using cursorMark? Worst case would be to fire two queries until this is fixed.&lt;/p&gt;

&lt;p&gt;And patches always welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16792514" author="mmarrero" created="Thu, 14 Mar 2019 10:04:41 +0000"  >&lt;p&gt;Not sure I understand... the start parameter has to be 0 in case we use it together with cursorMark, so in our case, we start with cursorMark=* (equivalent to start=0) and then we go to the next pages from there with the value of nextCursorMark.&lt;/p&gt;

&lt;p&gt;For the moment, we can disable the elevation&#160;(enableElevation=false) when using cursorMarks.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17222941" author="bwahlen" created="Thu, 29 Oct 2020 15:06:10 +0000"  >&lt;p&gt;i also run in this bug on 8.6.3&lt;br/&gt;
i mean all the docs are in the result of the first page and then instead of the next cursormark field:&lt;br/&gt;
&quot;error&quot;: &lt;/p&gt;
{
&quot;msg&quot;: &quot;class java.lang.Integer cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Integer is in module java.base of loader &apos;bootstrap&apos;; org.apache.lucene.util.BytesRef is in unnamed module of loader org.eclipse.jetty.webapp.WebAppClassLoader @329a1243)&quot;,
&quot;trace&quot;: &quot;java.lang.ClassCastException: class java.lang.Integer cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Integer is in module java.base of loader &apos;bootstrap&apos;; org.apache.lucene.util.BytesRef is in unnamed module of loader org.eclipse.jetty.webapp.WebAppClassLoader @329a1243)\n\tat org.apache.solr.schema.FieldType.marshalStringSortValue(FieldType.java:1296)\n\tat org.apache.solr.schema.StrField.marshalSortValue(StrField.java:117)\n\tat org.apache.solr.search.CursorMark.getSerializedTotem(CursorMark.java:251)\n\tat org.apache.solr.handler.component.QueryComponent.doProcessUngroupedSearch(QueryComponent.java:1526)\n\tat org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:403)\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:331)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:214)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2606)\n\tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:815)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:588)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:415)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:345)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1596)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:545)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:590)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:235)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1610)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1300)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:188)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:485)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1580)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:186)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1215)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:221)\n\tat org.eclipse.jetty.server.handler.InetAccessHandler.handle(InetAccessHandler.java:177)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:146)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:322)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:500)\n\tat org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:383)\n\tat org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:547)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:375)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:273)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)\n\tat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:117)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:336)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:313)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:171)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:129)\n\tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:375)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:806)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:938)\n\tat java.base/java.lang.Thread.run(Unknown Source)\n&quot;,
&quot;code&quot;: 500
}

&lt;p&gt;we had the following use case:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;match_stack where we put some pretty users (via elevation) on top.&lt;/li&gt;
	&lt;li&gt;deep paging via cursormark (we return pages of 30 users, some users are paging down 4000+ users)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;currently we are doing 2 searches: the pretty userId list and the normal user search and putting the results together&lt;br/&gt;
via holding both nextCursorMarks and all the already delivered users from both lists in the session.&lt;br/&gt;
I wanted to merge this into 1 search with elevation to make paging stateless.&lt;/p&gt;

&lt;p&gt;when the number of elevated users is less then the number on page 1, we can tinker around:&lt;br/&gt;
first search only the elevated users (without cursor mark) then reduce the size of the first query by the size of the elevated-user-result and exclude the ids manually.&lt;br/&gt;
I think we need to exclude the ids also on the following pages, which is not trivial in a stateless and distributed system. I remember them, but then the solution is not much better then the current solution.&lt;/p&gt;</comment>
                            <comment id="17313469" author="hossman" created="Thu, 1 Apr 2021 23:14:11 +0000"  >&lt;p&gt;I&apos;ve been looking into this a bit...&lt;/p&gt;

&lt;p&gt;first off: the problem is not specific to elevateIds, it is a general incompatibility with how the QueryElevationComponent is designed, and how the CursorMark functionality is designed.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;QueryElevationComponent is intended to be used as a &lt;tt&gt;last-component&lt;/tt&gt; so that it&apos;s &lt;tt&gt;prepare()&lt;/tt&gt; method runs after the &lt;tt&gt;prepare()&lt;/tt&gt; method of all other components, and it can modify the &lt;tt&gt;SortSpec&lt;/tt&gt; produced in the &lt;tt&gt;preapre()&lt;/tt&gt; method of any other component (typically QueryComponent)&lt;/li&gt;
	&lt;li&gt;CurorMark logic is initialized in &lt;tt&gt;QueryComponent.prepare()&lt;/tt&gt; &#8211; just after the &lt;tt&gt;sort&lt;/tt&gt; param is parsed into a &lt;tt&gt;SortSpec&lt;/tt&gt; &#8211; so that it can validate &amp;amp; parse the &lt;tt&gt;cursorMark&lt;/tt&gt; param against the &lt;tt&gt;SortSpec&lt;/tt&gt; to produce the &lt;tt&gt;SearchAfter&lt;/tt&gt; before any request &quot;process&quot;ing is done by QueryComponent.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The way this particular bug manifests &#8211; as a ClassCastException &#8211; comes from the fact that while a &lt;tt&gt;cursorMark=*&lt;/tt&gt; param (on the initial request) can be parsed &amp;amp; validated against any &lt;tt&gt;SortSpec&lt;/tt&gt;, once it&apos;s time to generate the &lt;tt&gt;nextCursorMark&lt;/tt&gt; for inclusion in the response, the &lt;tt&gt;SortSpec&lt;/tt&gt; the CursorMark was initialized with no longer matches the &lt;tt&gt;SortSpec&lt;/tt&gt; that was used to process the request, and there is an extra &quot;sort value&quot; (from QEC) prepended to the list that doesn&apos;t match up with the type expected based on the first sort clause CursorMark knows about.&lt;/p&gt;

&lt;p&gt;(There is actually a sanity check that the number of &quot;sort values&quot; matches the number expected, but it&apos;s currently implemented as an assertion, so it doesn&apos;t trip unless SOlr is running with assertions enabled)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Once I realized the root of the problem, I spend some time brainstorming possible solutions ... for the record, here are some notes on ideas I ruled out...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;move the CursorMark parsing into QueryComponent.process + distributedProcess
	&lt;ul&gt;
		&lt;li&gt;kind of defeats the point of the prepare/process abstraction&lt;/li&gt;
		&lt;li&gt;would need to be done carefully to ensure we still validate the cursorMark locally before trying to federate to multiple shards - but also that we don&apos;t inadvertantly re-parse hte cursorMark during every &quot;stage&quot; of a distributedProcess loop&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;change CursorMark so that parsing &amp;amp; validating the current cursor against the sort spec happens &quot;lazy&quot; the first time it&#8217;s needed in SolrIndexSearcher
	&lt;ul&gt;
		&lt;li&gt;again defeats the point of the prepare/process abstraction
		&lt;ul&gt;
			&lt;li&gt;would mean really late failure reporting if someone provides an invalid cursorMark value&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;would still be tricky to get right given how QEC completley replaces the SortSpec object ... CursorMark would basically need to hold a ref to the entire ResponseBuilder&lt;/li&gt;
		&lt;li&gt;feels very hackish&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;make QEC (and or any other future component that mucks with the SortSpec) responsible for &quot;re-initializing&quot; the CursorMark after changing the SortSpec
	&lt;ul&gt;
		&lt;li&gt;could potentialy bundle the logic into ResponseBuilder.setSortSpec ?&lt;/li&gt;
		&lt;li&gt;EXCEPT: this will only work on the initial &lt;tt&gt;cursormark=*&lt;/tt&gt; ?&lt;/li&gt;
		&lt;li&gt;for any request after that, when QueryComponent.prepare() tries to do the &quot;initial&quot; sort param + cursor parsing, that SortSpec won&apos;t work with the values encoded in the cursorMark mark param at the end of the previuos request by the QEC modified SortSpec.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;go back in time...
	&lt;ul&gt;
		&lt;li&gt;re-implement CursorMark &quot;parsing&quot; as it&apos;s own (optional) SearchComponent:
		&lt;ul&gt;
			&lt;li&gt;make people configure it as a &apos;last-component&apos; (even after QEC)&lt;/li&gt;
			&lt;li&gt;CursorMarkComponent.prepare() handles the &lt;tt&gt;cursorMark&lt;/tt&gt; param parsing&lt;/li&gt;
			&lt;li&gt;CursorMarkComponent.process/finish handles serialzing &lt;tt&gt;nextCursorMark&lt;/tt&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;EXCEPT: would totally break cursor behavor for all existing users who don&apos;t care about QEC&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here&apos;s the best idea i&apos;ve come up with to fix this (that doesn&apos;t require back compat break)....&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;move CursorMark init into SearchHandler
	&lt;ul&gt;
		&lt;li&gt;after the prepare() loop and before the process/distributedProcess loops&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;feels a little unclean since QueryComponent is the &quot;user&quot; of CursorMark
	&lt;ul&gt;
		&lt;li&gt;but ... SearchHandler is already &quot;aware&quot; of the CursorMark because of how it handles special case situations of cursorMark searches that &quot;time out&quot;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;if we do this, gate the (new) SearchHandler behavior it on whether ResponseBuilder.getSortSpec() is null
	&lt;ul&gt;
		&lt;li&gt;if someone has a handler configuration that doesn&apos;t use QueryComponent (or any other component that sets the SortSpec) it shouldn&apos;t cause failures if a &quot;useless&quot; cursorMark param is also provided in the request&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;
&lt;p&gt;I&apos;m attaching a patch that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;fixes CursorMark to throw a SERVER_ERROR (nt assertion check) if the some component still manages to produce &quot;sort values&quot; that don&apos;t match the SortSpec&lt;/li&gt;
	&lt;li&gt;implements the logic change to make SearchHandler responsible for CursorMark initialization&lt;/li&gt;
	&lt;li&gt;updates tests to use cursor w/ QEC...
	&lt;ul&gt;
		&lt;li&gt;some very basic updates to the (single core) QEC tests to show a basic cursor usage works&lt;/li&gt;
		&lt;li&gt;some more robust updates to the randomized Cursor tests (both single core and distributed) proving that a cursor walk with QEC enabled:
		&lt;ul&gt;
			&lt;li&gt;always returns the same docs as the same search w/o elevation&lt;/li&gt;
			&lt;li&gt;always returns the elevated docs first (required small test HACK to work around &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15307&quot; title=&quot;QueryElevationComponent forceElevation=true behaves oddly when &amp;quot;sort=score asc&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15307&quot;&gt;SOLR-15307&lt;/a&gt;)&lt;/li&gt;
			&lt;li&gt;all of the docs we expect to be elevated get elevated&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m still doing some beasting .. but curious if anyone has any feedback / concerns about this solution?&lt;/p&gt;</comment>
                            <comment id="17314968" author="jira-bot" created="Mon, 5 Apr 2021 16:57:33 +0000"  >&lt;p&gt;Commit 59a59138668e9513060824d85ee375a1723f4bfb in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=59a5913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=59a5913&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11921&quot; title=&quot;cursorMark ClassCastException (or incorrect results) when combined with QueryElevationComponent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11921&quot;&gt;&lt;del&gt;SOLR-11921&lt;/del&gt;&lt;/a&gt;: Move &quot;cursorMark&quot; logic from QueryComponent to SearchHandler so it can work with things like QueryElevationComponent that modify the SortSpec in prepare(), as well as possible custom &quot;search&quot; components other then QueryComponent&lt;/p&gt;</comment>
                            <comment id="17315040" author="jira-bot" created="Mon, 5 Apr 2021 18:58:01 +0000"  >&lt;p&gt;Commit b4e08f5a8431e4b94ff9ac06959d1768e0343a69 in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b4e08f5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b4e08f5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11921&quot; title=&quot;cursorMark ClassCastException (or incorrect results) when combined with QueryElevationComponent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11921&quot;&gt;&lt;del&gt;SOLR-11921&lt;/del&gt;&lt;/a&gt;: Move &quot;cursorMark&quot; logic from QueryComponent to SearchHandler so it can work with things like QueryElevationComponent that modify the SortSpec in prepare(), as well as possible custom &quot;search&quot; components other then QueryComponent&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 59a59138668e9513060824d85ee375a1723f4bfb)&lt;/p&gt;</comment>
                            <comment id="17368204" author="mayya" created="Wed, 23 Jun 2021 13:42:57 +0000"  >&lt;p&gt;Closing after the 8.9.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13369183">SOLR-15307</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13023339" name="SOLR-11921.patch" size="42987" author="hossman" created="Thu, 1 Apr 2021 23:14:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pgtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>