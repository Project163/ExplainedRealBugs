<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:12:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17792] ParallelHttpShardHandler has massive performance issues.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17792</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17158&quot; title=&quot;Terminate distributed processing quickly when query limit is reached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17158&quot;&gt;&lt;del&gt;SOLR-17158&lt;/del&gt;&lt;/a&gt; changed the way that the HttpShardHandler (And ParallelHttpShardHandler) did locking and concurrency. However, after upgrading, and running distributed queries (at a relatively slow rate), I noticed that there were 3 types of responses:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;QTimes between 3-6ms&lt;/li&gt;
	&lt;li&gt;QTimes between 53-56 ms&lt;/li&gt;
	&lt;li&gt;And requests that timed out&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Looking at the logic in HttpShardHandler, there is a poll(50ms) call that is very suspicious, and likely the reason for the jump between 3-6 ms and 53-56 ms. I would also assume that this change in concurrency logic is the reason that many requests started timing out. Changing to the HttpShardHandlerFactory from the ParallellHttpShardHandlerFactory fixed these issues.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13621423">SOLR-17792</key>
            <summary>ParallelHttpShardHandler has massive performance issues.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="houston">Houston Putman</assignee>
                                    <reporter username="houston">Houston Putman</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 20 Jun 2025 17:33:16 +0000</created>
                <updated>Thu, 24 Jul 2025 22:50:56 +0000</updated>
                            <resolved>Sat, 12 Jul 2025 02:35:54 +0000</resolved>
                                    <version>9.8</version>
                                    <fixVersion>9.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="18001391" author="gus_heck" created="Mon, 7 Jul 2025 06:40:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17419&quot; title=&quot;Improve HttpShardHandler performance in many-shard collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17419&quot;&gt;&lt;del&gt;SOLR-17419&lt;/del&gt;&lt;/a&gt; was committed days before &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17158&quot; title=&quot;Terminate distributed processing quickly when query limit is reached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17158&quot;&gt;&lt;del&gt;SOLR-17158&lt;/del&gt;&lt;/a&gt; was ready, and it definitely made things much more difficult (delaying it by weeks). I worked through it,  beasted related tests and definitely found and removed some deadlocks at that time. I seem to recall that ensuring &apos;happens-before&apos; was an issue behind one of the hard to reproduce failures I fought so don&apos;t forget to think about that side effect of synchronization. If a deadlock is still possible, certainly we should eliminate it. I tried to leave copious notes in comments and there&apos;s some discussion in the 17158 ticket that won&apos;t want to get forgotten of course. The poll is arbitrary, and I think I floated the idea of making it configurable in side conversations, but that was met with the sentiment that such a thing might be over doing it (on the assumption that it was only encountered in a rare case). &lt;/p&gt;

&lt;p&gt;Therefore, I&apos;m curious what the proportion of the results you described is, and how the overall response time varied (if at all) when you went back to HttpShardHandlerFactory. Of course the additional question is what was the variation in the queries themselves. Is this a replay of queries gleaned from logs type situation, or randomly selected terms in a simple, consistently shaped query? Do you have any evidence from profiling or jstack of a deadlock? If you share what you&apos;re finding I&apos;ll try to help with sorting it out.&lt;/p&gt;</comment>
                            <comment id="18003587" author="gus_heck" created="Mon, 7 Jul 2025 18:08:33 +0000"  >&lt;p&gt;Just discovered that there is a PR here which didn&apos;t link up to this issue here: &lt;a href=&quot;https://github.com/apache/solr/pull/3398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/3398&lt;/a&gt;  &lt;/p&gt;</comment>
                            <comment id="18004787" author="jira-bot" created="Fri, 11 Jul 2025 21:25:11 +0000"  >&lt;p&gt;Commit 2a5cc9d97b059d8264b8a80d386ca205e4c1e8a9 in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=2a5cc9d97b0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=2a5cc9d97b0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17792&quot; title=&quot;ParallelHttpShardHandler has massive performance issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17792&quot;&gt;&lt;del&gt;SOLR-17792&lt;/del&gt;&lt;/a&gt;: Fix deadlocks in ParallelHttpShardHandler (#3398)&lt;/p&gt;

&lt;p&gt;Re-do the way that HttpShardHandler does synchronization&lt;/p&gt;</comment>
                            <comment id="18004788" author="jira-bot" created="Fri, 11 Jul 2025 21:30:00 +0000"  >&lt;p&gt;Commit d5ec5f4c1a8283a39751b4af4041e146de662e92 in solr&apos;s branch refs/heads/branch_9x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=d5ec5f4c1a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=d5ec5f4c1a8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17792&quot; title=&quot;ParallelHttpShardHandler has massive performance issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17792&quot;&gt;&lt;del&gt;SOLR-17792&lt;/del&gt;&lt;/a&gt;: Fix deadlocks in ParallelHttpShardHandler (#3398)&lt;/p&gt;

&lt;p&gt;Re-do the way that HttpShardHandler does synchronization&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2a5cc9d97b059d8264b8a80d386ca205e4c1e8a9)&lt;/p&gt;</comment>
                            <comment id="18004821" author="jira-bot" created="Sat, 12 Jul 2025 02:35:43 +0000"  >&lt;p&gt;Commit f94343603a494eb2df147f615fafa646d9e67a1b in solr&apos;s branch refs/heads/branch_9_9 from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=f94343603a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=f94343603a4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17792&quot; title=&quot;ParallelHttpShardHandler has massive performance issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17792&quot;&gt;&lt;del&gt;SOLR-17792&lt;/del&gt;&lt;/a&gt;: Fix deadlocks in ParallelHttpShardHandler (#3398)&lt;/p&gt;

&lt;p&gt;Re-do the way that HttpShardHandler does synchronization&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2a5cc9d97b059d8264b8a80d386ca205e4c1e8a9)&lt;/p&gt;</comment>
                            <comment id="18007303" author="houston" created="Tue, 15 Jul 2025 17:50:08 +0000"  >&lt;p&gt;Copying from the PR:&lt;/p&gt;

&lt;p&gt;So this broke &lt;tt&gt;DistributedDebugComponentTest.testTolerantSearch&lt;/tt&gt; and &lt;tt&gt;TestJsonFacets.testTolerant&lt;/tt&gt;. The reason is that originally &lt;tt&gt;HttpShardHandler.take()&lt;/tt&gt; would return on an error, cancelling all other responses. Now the logic is that on an error, outstanding requests will be cancelled, but if any responses come in in the meantime, they will be processed. However, the code currently expects that the last response will have the error. So since the last response might not have the error anymore, we have to change the code that checks the responses for errors.&lt;/p&gt;

&lt;p&gt;However, after fixing that and beasting the tests, there is a really weird error around cancelling requests. The &lt;tt&gt;DistributedDebugComponentTest.testTolerantSearch&lt;/tt&gt; does a non-tolerant search then does a tolerant search. The error I described above was breaking the non-tolerant search. That is easily fixable. The second part of the test, testing tolerant search fails very occasionally (but only when the non-tolerant search is done first, when that is commented out, the tolerant search does not fail).&lt;/p&gt;

&lt;p&gt;The tolerant search fails (occasionally) because all three shard requests fail instead of just 1 of the shard requests failing (because of a non-exisistant endpoint). the bad shard has the failure that the test expects, but the good shards both fail with &lt;tt&gt;java.io.IOException: cancel_stream_error/unexpected_data_frame&lt;/tt&gt; meaning that the requests were cancelled, even thought the request is &quot;tolerant&quot;. I did a lot of debugging here, and noticed that Solr is behaving correctly and we are not cancelling shard requests for tolerant solr requests. And the fact that if the &quot;non-tolerant search&quot; request case right before the tolerant search request is commented out, the failures stop, tell us that the cancellations from the non-tolerant request are bleeding into the tolerant request. This is bad. I also confirmed this by commenting out the line that actually cancels the HTTP requests: &lt;a href=&quot;https://github.com/apache/solr/blob/branch_9_9/solr/solrj/src/java/org/apache/solr/client/solrj/impl/Http2SolrClient.java#L570-L574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/blob/branch_9_9/solr/solrj/src/java/org/apache/solr/client/solrj/impl/Http2SolrClient.java#L570-L574&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This only happens on branch_9x (and presumable branch_9_9), not on main. So I believe it&apos;s a bug in Jetty 10, which Jetty 12 has solved. So we are probably fine just fixing this part on branch_9x and branch_9_9, and leaving the request cancellation enabled on main (10.x).&lt;/p&gt;

&lt;p&gt;Amazingly, when beasting, there is a big difference in whether the non-existent endpoint is put first or last in the list of shards. The failure rate is much higher when the bad shard is the first listed rather the last one listed.&lt;/p&gt;

&lt;p&gt;I&apos;ve create another ticket (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17819&quot; title=&quot;HttpShardHandler non-tolerant request cancellation bleeds across requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17819&quot;&gt;&lt;del&gt;SOLR-17819&lt;/del&gt;&lt;/a&gt;) for the cancellation bug. But I&apos;ll create another PR to fix what this PR broke (the first part of this long comment).&lt;/p&gt;</comment>
                            <comment id="18008124" author="jira-bot" created="Fri, 18 Jul 2025 18:46:09 +0000"  >&lt;p&gt;Commit 71554944de68207ea39e60aae5387b793a5f2c4b in solr&apos;s branch refs/heads/main from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=71554944de6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=71554944de6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17792&quot; title=&quot;ParallelHttpShardHandler has massive performance issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17792&quot;&gt;&lt;del&gt;SOLR-17792&lt;/del&gt;&lt;/a&gt;: Fix error handling for shard requests (#3429)&lt;/p&gt;
</comment>
                            <comment id="18008125" author="jira-bot" created="Fri, 18 Jul 2025 18:54:30 +0000"  >&lt;p&gt;Commit 94c01372042172d6c5b526ba526dcd75a193c358 in solr&apos;s branch refs/heads/branch_9x from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=94c01372042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=94c01372042&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17792&quot; title=&quot;ParallelHttpShardHandler has massive performance issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17792&quot;&gt;&lt;del&gt;SOLR-17792&lt;/del&gt;&lt;/a&gt;: Fix error handling for shard requests (#3429)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 71554944de68207ea39e60aae5387b793a5f2c4b)&lt;/p&gt;</comment>
                            <comment id="18008131" author="jira-bot" created="Fri, 18 Jul 2025 19:04:17 +0000"  >&lt;p&gt;Commit 498568b5dd6d2d7422742bdebd1ec4a500817be2 in solr&apos;s branch refs/heads/branch_9_9 from Houston Putman&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=498568b5dd6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=498568b5dd6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17792&quot; title=&quot;ParallelHttpShardHandler has massive performance issues.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17792&quot;&gt;&lt;del&gt;SOLR-17792&lt;/del&gt;&lt;/a&gt;: Fix error handling for shard requests (#3429)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 71554944de68207ea39e60aae5387b793a5f2c4b)&lt;/p&gt;</comment>
                            <comment id="18009792" author="houston" created="Thu, 24 Jul 2025 22:50:56 +0000"  >&lt;p&gt;Closing after the 9.9.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13568026">SOLR-17158</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wf3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>