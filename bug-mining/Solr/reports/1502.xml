<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:38:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5122] spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &quot;ArithmeticException: / by zero&quot;</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5122</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;As part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4952&quot; title=&quot;audit test configs to use solrconfig.snippet.randomindexconfig.xml in more tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4952&quot;&gt;&lt;del&gt;SOLR-4952&lt;/del&gt;&lt;/a&gt; SpellCheckCollatorTest started using RandomMergePolicy, and this (aparently) led to a failure in testEstimatedHitCounts.&lt;/p&gt;

&lt;p&gt;As far as i can tell: the test assumes that specific values would be returned as the &lt;em&gt;estimated&lt;/em&gt; &quot;hits&quot; for a colleation, and it appears that the change in MergePolicy however resulted in different segments with different term stats, causing the estimation code to produce different values then what is expected.&lt;/p&gt;

&lt;p&gt;I made a quick attempt to improve the test to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;expect explicit exact values only when spellcheck.collateMaxCollectDocs is set such that the &quot;estimate&apos; should actually be exact (ie: collateMaxCollectDocs  == 0 or collateMaxCollectDocs greater then the num docs in the index&lt;/li&gt;
	&lt;li&gt;randomize the values used for collateMaxCollectDocs and confirm that the estimates are never more then the num docs in the index&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This lead to an odd &quot;ArithmeticException: / by zero&quot; error in the test, which seems to suggest that there is a genuine bug in the code for estimating the hits that only gets tickled in certain mergepolicy/segment/collateMaxCollectDocs combinations.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Update:&lt;/b&gt; This appears to be a general problem with collecting docs out of order and the estimation of hits &amp;#8211; i believe even if there is no divide by zero error, the estimates are largely meaningless since the docs are collected out of order.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12662457">SOLR-5122</key>
            <summary>spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &quot;ArithmeticException: / by zero&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Aug 2013 18:58:14 +0000</created>
                <updated>Mon, 9 May 2016 18:50:02 +0000</updated>
                            <resolved>Thu, 15 Aug 2013 17:55:08 +0000</resolved>
                                    <version>4.4</version>
                                    <fixVersion>4.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13732584" author="hossman" created="Wed, 7 Aug 2013 19:01:16 +0000"  >&lt;p&gt;Attached patch applied to trunk r1511141 produces the following error...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit4]   2&amp;gt; 6500 T10 C1 oasc.SolrCore.execute [collection1] webapp=null path=null params={spellcheck=true&amp;amp;spellcheck.dictionary=direct&amp;amp;spellcheck.count=1&amp;amp;spellcheck.collate=true&amp;amp;spellcheck.maxCollationTries=1&amp;amp;spellcheck.maxCollations=1&amp;amp;spellcheck.collateExtendedResults=true&amp;amp;qt=spellCheckCompRH&amp;amp;q=teststop%3Ametnoia&amp;amp;spellcheck.collateMaxCollectDocs=5} hits=0 status=500 QTime=25 
   [junit4]   2&amp;gt; 6501 T10 oasc.SolrException.log ERROR REQUEST FAILED: spellcheck=true&amp;amp;spellcheck.dictionary=direct&amp;amp;spellcheck.count=1&amp;amp;spellcheck.collate=true&amp;amp;spellcheck.maxCollationTries=1&amp;amp;spellcheck.maxCollations=1&amp;amp;spellcheck.collateExtendedResults=true&amp;amp;qt=spellCheckCompRH&amp;amp;q=teststop%3Ametnoia&amp;amp;spellcheck.collateMaxCollectDocs=5:java.lang.ArithmeticException: / by zero
   [junit4]   2&amp;gt; 		at org.apache.solr.spelling.SpellCheckCollator.collate(SpellCheckCollator.java:153)
   [junit4]   2&amp;gt; 		at org.apache.solr.handler.component.SpellCheckComponent.addCollationsToResponse(SpellCheckComponent.java:229)
   [junit4]   2&amp;gt; 		at org.apache.solr.handler.component.SpellCheckComponent.process(SpellCheckComponent.java:196)
   [junit4]   2&amp;gt; 		at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:208)
   [junit4]   2&amp;gt; 		at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
   [junit4]   2&amp;gt; 		at org.apache.solr.core.SolrCore.execute(SolrCore.java:1845)
   [junit4]   2&amp;gt; 		at org.apache.solr.util.TestHarness.query(TestHarness.java:292)
   [junit4]   2&amp;gt; 		at org.apache.solr.util.TestHarness.query(TestHarness.java:274)
   [junit4]   2&amp;gt; 		at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:609)
   [junit4]   2&amp;gt; 		at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:602)
   [junit4]   2&amp;gt; 		at org.apache.solr.spelling.SpellCheckCollatorTest.testEstimatedHitCounts(SpellCheckCollatorTest.java:475)
...
   [junit4]   2&amp;gt; 6501 T10 oas.SolrTestCaseJ4.tearDown ###Ending testEstimatedHitCounts
   [junit4]   2&amp;gt; NOTE: reproduce with: ant test  -Dtestcase=SpellCheckCollatorTest -Dtests.method=testEstimatedHitCounts -Dtests.seed=16B4D8F74E59EE10 -Dtests.multiplier=2 -Dtests.nightly=true -Dtests.slow=true -Dtests.locale=nl -Dtests.timezone=America/Dawson -Dtests.file.encoding=US-ASCII
   [junit4] ERROR   0.35s | SpellCheckCollatorTest.testEstimatedHitCounts &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.RuntimeException: Exception during query
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([16B4D8F74E59EE10:270F66C2EB66FEC0]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:635)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:602)
   [junit4]    &amp;gt; 	at org.apache.solr.spelling.SpellCheckCollatorTest.testEstimatedHitCounts(SpellCheckCollatorTest.java:475)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:724)
   [junit4]    &amp;gt; Caused by: java.lang.ArithmeticException: / by zero
   [junit4]    &amp;gt; 	at org.apache.solr.spelling.SpellCheckCollator.collate(SpellCheckCollator.java:153)
   [junit4]    &amp;gt; 	at org.apache.solr.handler.component.SpellCheckComponent.addCollationsToResponse(SpellCheckComponent.java:229)
   [junit4]    &amp;gt; 	at org.apache.solr.handler.component.SpellCheckComponent.process(SpellCheckComponent.java:196)
   [junit4]    &amp;gt; 	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:208)
   [junit4]    &amp;gt; 	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
   [junit4]    &amp;gt; 	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1845)
   [junit4]    &amp;gt; 	at org.apache.solr.util.TestHarness.query(TestHarness.java:292)
   [junit4]    &amp;gt; 	at org.apache.solr.util.TestHarness.query(TestHarness.java:274)
   [junit4]    &amp;gt; 	at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:609)
   [junit4]    &amp;gt; 	... 42 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13732654" author="hossman" created="Wed, 7 Aug 2013 19:53:16 +0000"  >&lt;p&gt;The problematic line is when catching the EarlyTerminatingCollectorException exception and computing the estimate based on the last doc id collected...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hits = maxDocId / ((etce.getLastDocId() + 1) / docCollectionLimit);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unless i&apos;m mising something, the problem comes up when &lt;tt&gt;(etce.getLastDocId() + 1) &amp;lt; docCollectionLimit&lt;/tt&gt; because then the integer division results in 0, which then becomes the demoninator under &lt;tt&gt;maxDocId&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;It would be trivial to toss another &quot;1+&quot; in there to eliminate the divide by zero, but i&apos;m confused about the basic assumption taking place here &amp;#8211; it smells fishy &amp;#8211; making any estimation based on getLastDocId() seems to only be useful if we know docs are being collected in order, and when the collateMaxCollectDocs option was added in r1479638, it did force in order collection when using hte early termination...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/spelling/SpellCheckCollator.java?r1=1479638&amp;amp;r2=1479637&amp;amp;pathrev=1479638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/spelling/SpellCheckCollator.java?r1=1479638&amp;amp;r2=1479637&amp;amp;pathrev=1479638&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...but in r1479645 that use of FORCE_INORDER_COLLECTION was eliminate with the msg &quot;removing dead code&quot; ...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/spelling/SpellCheckCollator.java?r1=1479645&amp;amp;r2=1479644&amp;amp;pathrev=1479645&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/spelling/SpellCheckCollator.java?r1=1479645&amp;amp;r2=1479644&amp;amp;pathrev=1479645&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But w/o FORCE_INORDER_COLLECTION I don&apos;t see how any estimation based on the lastDocId can ever be meaningful?&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdyer&quot; class=&quot;user-hover&quot; rel=&quot;jdyer&quot;&gt;jdyer&lt;/a&gt; can you take a look at this?&lt;/p&gt;</comment>
                            <comment id="13732659" author="hossman" created="Wed, 7 Aug 2013 19:57:49 +0000"  >&lt;p&gt;Reviewing the comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3240&quot; title=&quot;add spellcheck &amp;#39;approximate collation count&amp;#39; mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3240&quot;&gt;&lt;del&gt;SOLR-3240&lt;/del&gt;&lt;/a&gt; i think i just figured out hte &quot;remove dead code&quot; comment...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m also thinking I can safely get rid of the &quot;forceInorderCollection&quot; flag because requesting docs sorted by doc-id would enforce the same thing, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;...i don&apos;t think this assumption is valid.  I don&apos;t think using the &lt;tt&gt;&lt;em&gt;docid&lt;/em&gt;&lt;/tt&gt; sort option affects the order that collectors recieve docs, it&apos;s just used to register a &lt;tt&gt;SortField&lt;/tt&gt; using &lt;tt&gt;SortField.Type.DOC&lt;/tt&gt;, which isn&apos;t used until &lt;b&gt;after&lt;/b&gt; the collector collects &quot;all&quot; of the docs.&lt;/p&gt;

&lt;p&gt;So i think we need to add back in the FORCE_INORDER_COLLECTION&lt;/p&gt;</comment>
                            <comment id="13732865" author="hossman" created="Wed, 7 Aug 2013 22:41:06 +0000"  >&lt;p&gt;FYI: I attempted ot do a simple revert of r1479645 and the test still fails &amp;#8211; but reviewing hte diff i think that&apos;s because there doesn&apos;t seem to be anything paying attention to the FORCE_INORDER_COLLECTION flag at collection time, so it&apos;s effectively useless.&lt;/p&gt;

&lt;p&gt;I&apos;m at a loss to really understand what the correct fix should be at this point&lt;/p&gt;</comment>
                            <comment id="13732951" author="jira-bot" created="Wed, 7 Aug 2013 23:48:21 +0000"  >&lt;p&gt;Commit 1511539 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1511539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1511539&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5122&quot; title=&quot;spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &amp;quot;ArithmeticException: / by zero&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5122&quot;&gt;&lt;del&gt;SOLR-5122&lt;/del&gt;&lt;/a&gt;: disble testEstimatedHitCounts until issue with inordered collection can be dealt with&lt;/p&gt;</comment>
                            <comment id="13732953" author="jira-bot" created="Wed, 7 Aug 2013 23:49:43 +0000"  >&lt;p&gt;Commit 1511540 from hossman@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1511540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1511540&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5122&quot; title=&quot;spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &amp;quot;ArithmeticException: / by zero&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5122&quot;&gt;&lt;del&gt;SOLR-5122&lt;/del&gt;&lt;/a&gt;: disble testEstimatedHitCounts until issue with inordered collection can be dealt with (merge r1511539)&lt;/p&gt;</comment>
                            <comment id="13738311" author="jdyer" created="Tue, 13 Aug 2013 14:55:28 +0000"  >&lt;p&gt;Hoss,&lt;/p&gt;

&lt;p&gt;I appreciate your reporting this &amp;amp; taking care of this as much as possible.  Do you know offhand a failing seed for this test?  (I&apos;ve been away for awhile and might not have the jenkins log easily available.)  I will look at this.  Likely, I need to require docs to be collected in order and mistakenly thought this was unnecessary.&lt;/p&gt;</comment>
                            <comment id="13738395" author="hossman" created="Tue, 13 Aug 2013 15:51:50 +0000"  >&lt;p&gt;The initial jenkins failure i saw was &quot;At revision 1511278&quot;...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/Lucene-Solr-NightlyTests-trunk/343/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Lucene-Solr-NightlyTests-trunk/343/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://mail-archives.apache.org/mod_mbox/lucene-dev/201308.mbox/%3Calpine.DEB.2.02.1308070919170.13959@frisbee%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://mail-archives.apache.org/mod_mbox/lucene-dev/201308.mbox/%3Calpine.DEB.2.02.1308070919170.13959@frisbee%3E&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I can reproduce this &amp;#8211; it&apos;s probably related to the MP randomization i &lt;br/&gt;
put in ... looks like it&apos;s doing exact numeric comparisons based on term &lt;br/&gt;
stats.  I&apos;ll take a look later today...&lt;/p&gt;

&lt;p&gt;ant test  -Dtestcase=SpellCheckCollatorTest -Dtests.method=testEstimatedHitCounts -Dtests.seed=16B4D8F74E59EE10 -Dtests.multiplier=2 -Dtests.nightly=true -Dtests.slow=true   -Dtests.locale=nl -Dtests.timezone=America/Dawson -Dtests.file.encoding=US-ASCII&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;...regardless of he initial failure though, if you try out the patch i attached to try and improve the test coverage, then the &quot;reproduce&quot; line from the failure i posted along iwth that patch still reproduces on trunk (but you do have to manually uncomment the &lt;tt&gt;@Ignore&lt;/tt&gt;...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ant test  -Dtestcase=SpellCheckCollatorTest -Dtests.method=testEstimatedHitCounts -Dtests.seed=16B4D8F74E59EE10 -Dtests.multiplier=2 -Dtests.nightly=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.slow=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dtests.locale=nl -Dtests.timezone=America/Dawson -Dtests.file.encoding=US-ASCII
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13738397" author="hossman" created="Tue, 13 Aug 2013 15:52:45 +0000"  >&lt;p&gt;updated patch to trunk and included the commenting out of the &lt;tt&gt;@Ignore&lt;/tt&gt; so all ou need to do is apply this patch to reproduce with the previously mentioned seed.&lt;/p&gt;</comment>
                            <comment id="13738708" author="jdyer" created="Tue, 13 Aug 2013 19:28:36 +0000"  >&lt;p&gt;The scenarios tested in testEstimatedHitCounts() seem to always pick a collector that does not accept docs out-of-order (&quot;TopFieldCollector$OneComparatorNonScoringCollector&quot;).  The problem looks like when a new segment/scorer is set, we get a new set of doc id&apos;s.  So prior to random merges, the test naively assummed everything was on 1 segment.  Now with multiple, all bets are off and I don&apos;t think we can be estimating hits.&lt;/p&gt;

&lt;p&gt;I think the best fix is to dial back the functionality here and not offer hit estimates at all.  The functionality still would be beneficial in cases the user did not require hit-counts to be returned at all (for instance, ~rmuir mentioned using this feature with suggesters).  &lt;/p&gt;

&lt;p&gt;Another option is to add together the doc ids for the various scorers that are looked at and pretend this is your max doc id.  I&apos;m torn here because I&apos;d hate to remove functionality that has been released but on the other hand if it is always going to give lousy estimates then why fool people?&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13739893" author="hossman" created="Wed, 14 Aug 2013 17:14:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;So prior to random merges, the test naively assummed everything was on 1 segment. Now with multiple, all bets are off and I don&apos;t think we can be estimating hits.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not following you here &amp;#8211; why don&apos;t you think the basic approach to estimation can still work?&lt;/p&gt;

&lt;p&gt;the only missing pieces seem to be that when an estimation is requested:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;docs &lt;b&gt;must&lt;/b&gt; be collected in order &amp;#8211; a property that forces this behavior from EarlyTerminatingCollector.acceptsDocsOutOfOrder regardless of what the delegate cares about should do the trick.&lt;/li&gt;
	&lt;li&gt;lastDocId needs to be absolute, not per-segment &amp;#8211; which could be done by tracking the reader offsets in EarlyTerminatingCollector.setNextReader and using that offset when assigning lastDocId in EarlyTerminatingCollector.collect&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...and that should make it work as you previously designed it ... right?&lt;/p&gt;</comment>
                            <comment id="13740492" author="hossman" created="Thu, 15 Aug 2013 00:35:28 +0000"  >&lt;p&gt;here&apos;s a patch that improves EarlyTerminatingCollector to keep track of the size of each reader it collects against so that it can derive some meaning from the docIds it collects.  As part of this patch i eliminated the use of the &quot;lastDocId&quot; to try and discourage people from trying to find specific &amp;#8211; instead the EarlyTerminatingCollectorException now just reports the number of docs &quot;collected&quot; out of the total number of docs &quot;scanned&quot; ... the result is that the collector doesn&apos;t really care which order it gets the AtomicReaderContexts in, however it still has to force documents to be collected in order, so that they will be in-order within a single reader so that the stats for that reader can be meaningful.&lt;/p&gt;

&lt;p&gt;patch includes the previous tests, plus a new test loop that we get a reasonably accurate estimate from a term that is in every other doc in the index.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdyer&quot; class=&quot;user-hover&quot; rel=&quot;jdyer&quot;&gt;jdyer&lt;/a&gt; - does this look right to you? does it address your concerns about keeping hte estimation code in place?&lt;/p&gt;</comment>
                            <comment id="13740999" author="jdyer" created="Thu, 15 Aug 2013 14:32:02 +0000"  >&lt;p&gt;Hoss,&lt;/p&gt;

&lt;p&gt;This looks reasonable to me.  The test is more forgiving to variations caused by random merges, no more integer division, etc.  I appreciate your working on this as I wouldn&apos;t have much more time until next week.  I think your method of estimating the hits would be at least as good of what I attempted to do before.&lt;/p&gt;</comment>
                            <comment id="13741262" author="jira-bot" created="Thu, 15 Aug 2013 17:50:32 +0000"  >&lt;p&gt;Commit 1514402 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1514402&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1514402&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5122&quot; title=&quot;spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &amp;quot;ArithmeticException: / by zero&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5122&quot;&gt;&lt;del&gt;SOLR-5122&lt;/del&gt;&lt;/a&gt;: Fixed bug in spellcheck.collateMaxCollectDocs.  Eliminates risk of divide by zero, and makes estimated hit counts meaningful in non-optimized indexes.&lt;/p&gt;</comment>
                            <comment id="13741270" author="jira-bot" created="Thu, 15 Aug 2013 17:53:53 +0000"  >&lt;p&gt;Commit 1514408 from hossman@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1514408&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1514408&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5122&quot; title=&quot;spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &amp;quot;ArithmeticException: / by zero&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5122&quot;&gt;&lt;del&gt;SOLR-5122&lt;/del&gt;&lt;/a&gt;: Fixed bug in spellcheck.collateMaxCollectDocs.  Eliminates risk of divide by zero, and makes estimated hit counts meaningful in non-optimized indexes. (merge r1514402)&lt;/p&gt;</comment>
                            <comment id="13741273" author="hossman" created="Thu, 15 Aug 2013 17:55:08 +0000"  >&lt;p&gt;Committed revision 1514402.&lt;br/&gt;
Committed revision 1514408.&lt;/p&gt;</comment>
                            <comment id="13741477" author="jira-bot" created="Thu, 15 Aug 2013 21:07:17 +0000"  >&lt;p&gt;Commit 1514494 from hossman@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1514494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1514494&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5122&quot; title=&quot;spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &amp;quot;ArithmeticException: / by zero&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5122&quot;&gt;&lt;del&gt;SOLR-5122&lt;/del&gt;&lt;/a&gt;: fix javadocs&lt;/p&gt;</comment>
                            <comment id="13741506" author="jira-bot" created="Thu, 15 Aug 2013 21:27:23 +0000"  >&lt;p&gt;Commit 1514504 from hossman@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1514504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1514504&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5122&quot; title=&quot;spellcheck.collateMaxCollectDocs estimates seem to be meaninless -- can lead to &amp;quot;ArithmeticException: / by zero&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5122&quot;&gt;&lt;del&gt;SOLR-5122&lt;/del&gt;&lt;/a&gt;: fix javadocs (merge r1514494)&lt;/p&gt;</comment>
                            <comment id="13787131" author="jpountz" created="Sat, 5 Oct 2013 10:19:23 +0000"  >&lt;p&gt;4.5 release -&amp;gt; bulk close&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12654280">SOLR-4952</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12546249">SOLR-3240</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12598117" name="SOLR-5122.patch" size="17208" author="hossman" created="Thu, 15 Aug 2013 00:35:28 +0000"/>
                            <attachment id="12597747" name="SOLR-5122.patch" size="6452" author="hossman" created="Tue, 13 Aug 2013 15:52:45 +0000"/>
                            <attachment id="12596688" name="SOLR-5122.patch" size="6320" author="hossman" created="Wed, 7 Aug 2013 19:01:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342460</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n26n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342765</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>