<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:29:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9440] ZkStateReader on a client can cache collection state and never refresh it</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9440</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I saw this while writing a test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9438&quot; title=&quot;Shard split can lose data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9438&quot;&gt;&lt;del&gt;SOLR-9438&lt;/del&gt;&lt;/a&gt;. The collection1 collection which was in stateFormat=2 was somehow caching the CloudSolrClient&apos;s ZkStateReader such that the returned cluster state contained the collection state. However this collection was neither watched nor lazy so any call to waitForRecoveriesToFinish would see stale state and loop until timeout.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12999807">SOLR-9440</key>
            <summary>ZkStateReader on a client can cache collection state and never refresh it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Aug 2016 21:17:34 +0000</created>
                <updated>Wed, 2 Oct 2019 17:24:45 +0000</updated>
                            <resolved>Wed, 8 Nov 2017 06:39:36 +0000</resolved>
                                                    <fixVersion>7.2</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15907791" author="ichattopadhyaya" created="Mon, 13 Mar 2017 16:41:50 +0000"  >&lt;p&gt;Moving to 6.5, since 6.4 has already been released.&lt;/p&gt;</comment>
                            <comment id="16015005" author="tomasflobbe" created="Thu, 18 May 2017 00:57:22 +0000"  >&lt;p&gt;I hit this problem all the time in the tests of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10233&quot; title=&quot;Add support for different replica types in Solr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10233&quot;&gt;&lt;del&gt;SOLR-10233&lt;/del&gt;&lt;/a&gt;, the only workaround I found is to use &lt;tt&gt;cluster.getSolrClient().getZkStateReader().registerCore(collectionName);&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16190978" author="jira-bot" created="Wed, 4 Oct 2017 08:25:02 +0000"  >&lt;p&gt;Commit 5982d8734adf44e12cae1985574ca682f07839ca in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5982d87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5982d87&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11076&quot; title=&quot;New /autoscaling/history API to return past cluster events and actions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11076&quot;&gt;&lt;del&gt;SOLR-11076&lt;/del&gt;&lt;/a&gt;: Added more debug logging. Ensure collections are active before we exercise autoscaling. Added workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9440&quot; title=&quot;ZkStateReader on a client can cache collection state and never refresh it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9440&quot;&gt;&lt;del&gt;SOLR-9440&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16226414" author="shalinmangar" created="Tue, 31 Oct 2017 07:49:22 +0000"  >&lt;p&gt;I found the root cause.&lt;/p&gt;

&lt;p&gt;The bug is in &lt;tt&gt;ZkStateReader.removeCollectionStateWatcher&lt;/tt&gt; which only removes the collection from the collection&apos;s watch list i.e. collectionWatches map. Since ZK does not have a way to remove a watch, the watch object is fired again when the collection changes. Now, there is code in StateWatcher&apos;s refreshAndWatch method which is supposed to evict the cached DocCollection object from watchedCollectionStates if the collection is no more in the collectionWatches map. However, that code never gets executed because the StateWatcher&apos;s process method returns early if the collection is not in collectionWatches list. So a cached DocCollection reference that is neither lazy nor watched is left behind.&lt;/p&gt;</comment>
                            <comment id="16226416" author="shalinmangar" created="Tue, 31 Oct 2017 07:51:24 +0000"  >&lt;p&gt;Also, the reason why we saw this manifest on tests is because the SolrCloudTestCase.waitForState method eventually calls ZkStateReader.waitForState method which registers and then removes a collection state watcher.&lt;/p&gt;</comment>
                            <comment id="16226673" author="shalinmangar" created="Tue, 31 Oct 2017 11:59:10 +0000"  >&lt;p&gt;This patch changes removeCollectionStateWatcher to handle evictions the same as unregisterCore method. It also removes all the workarounds introduces because of this bug in various places.&lt;/p&gt;</comment>
                            <comment id="16226690" author="shalinmangar" created="Tue, 31 Oct 2017 12:23:46 +0000"  >&lt;p&gt;I added a test in ZkStateReaderTest which fails 100% of the time without the fix. This is ready.&lt;/p&gt;</comment>
                            <comment id="16226695" author="jira-bot" created="Tue, 31 Oct 2017 12:28:56 +0000"  >&lt;p&gt;Commit 39376cd8b5ef03b3338c2e8fa31dce732749bcd7 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=39376cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=39376cd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9440&quot; title=&quot;ZkStateReader on a client can cache collection state and never refresh it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9440&quot;&gt;&lt;del&gt;SOLR-9440&lt;/del&gt;&lt;/a&gt;: The ZkStateReader.removeCollectionStateWatcher method can cache a DocCollection reference and never update it causing stale state to be returned in ClusterState&lt;/p&gt;</comment>
                            <comment id="16226696" author="shalinmangar" created="Tue, 31 Oct 2017 12:29:20 +0000"  >&lt;p&gt;I&apos;ll observe the impact of this change on jenkins for a couple of days before porting it to branch_7x.&lt;/p&gt;</comment>
                            <comment id="16227172" author="tomasflobbe" created="Tue, 31 Oct 2017 17:38:53 +0000"  >&lt;p&gt;Thanks for looking at this Shalin!&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (v.canBeRemoved()) {
        watchedCollectionStates.remove(collection);
        lazyCollectionStates.put(collection, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LazyCollectionRef(collection));
        reconstructState.set(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m wondering if we need some synchronization here, with &lt;tt&gt;registerCollectionStateWatcher&lt;/tt&gt; and also to make sure the &lt;tt&gt;watchedCollectionStates.remove&lt;/tt&gt; and &lt;tt&gt;lazyCollectionStates.put&lt;/tt&gt; is done atomically?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ConcurrentHashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, CollectionWatch&amp;gt; collectionWatches = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap&amp;lt;&amp;gt;();
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ConcurrentHashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, CollectionWatch&amp;gt; collectionWatches = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap&amp;lt;&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is this only for testing purposes?&lt;/p&gt;</comment>
                            <comment id="16233639" author="shalinmangar" created="Wed, 1 Nov 2017 04:35:37 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;m wondering if we need some synchronization here, with registerCollectionStateWatcher and also to make sure the watchedCollectionStates.remove and lazyCollectionStates.put is done atomically&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm good point. I don&apos;t think we need synchronization here but we need to ensure that the result, once visible, is consistent. So this is a trick that the ZkStateReader uses &amp;#8211; It adds all collections to the lazyCollectionStates map and never removes them unless the collection is deleted. But it gives priority to watchedCollectionStates over the lazy ones. This ensures that during constructState, the collection is always available in the cluster state even if it is removed from the watchedCollectionStates. Actually the lazyCollectionStates.put is not necessary but it is there just for safety.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is this only for testing purposes?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oops, yes, thanks for catching. I&apos;ll revert it.&lt;/p&gt;</comment>
                            <comment id="16233650" author="jira-bot" created="Wed, 1 Nov 2017 04:45:48 +0000"  >&lt;p&gt;Commit 2e4b6929d2d714b1c12dc66cd46a2307c8bb1044 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2e4b692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2e4b692&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9440&quot; title=&quot;ZkStateReader on a client can cache collection state and never refresh it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9440&quot;&gt;&lt;del&gt;SOLR-9440&lt;/del&gt;&lt;/a&gt;: Revert visibility change of collectionWatches&lt;/p&gt;</comment>
                            <comment id="16243444" author="jira-bot" created="Wed, 8 Nov 2017 06:36:31 +0000"  >&lt;p&gt;Commit f6f5d01be9bafedb4794d2e3a104ea8db5bcfa78 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f6f5d01&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f6f5d01&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9440&quot; title=&quot;ZkStateReader on a client can cache collection state and never refresh it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9440&quot;&gt;&lt;del&gt;SOLR-9440&lt;/del&gt;&lt;/a&gt;: The ZkStateReader.removeCollectionStateWatcher method can cache a DocCollection reference and never update it causing stale state to be returned in ClusterState&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 39376cd)&lt;/p&gt;</comment>
                            <comment id="16243445" author="jira-bot" created="Wed, 8 Nov 2017 06:36:34 +0000"  >&lt;p&gt;Commit 23e1aeb2ce8f7abaee49000099d1a951328edebc in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shalin&quot; class=&quot;user-hover&quot; rel=&quot;shalin&quot;&gt;shalin&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=23e1aeb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=23e1aeb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9440&quot; title=&quot;ZkStateReader on a client can cache collection state and never refresh it&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9440&quot;&gt;&lt;del&gt;SOLR-9440&lt;/del&gt;&lt;/a&gt;: Revert visibility change of collectionWatches&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2e4b692)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13171461">SOLR-12544</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13079425">SOLR-10878</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12894967" name="SOLR-9440.patch" size="15855" author="shalin" created="Tue, 31 Oct 2017 12:23:27 +0000"/>
                            <attachment id="12894964" name="SOLR-9440.patch" size="11212" author="shalin" created="Tue, 31 Oct 2017 11:58:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32qzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>