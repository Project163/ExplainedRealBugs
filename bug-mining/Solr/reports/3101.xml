<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:16:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9512] CloudSolrClient&apos;s cluster state cache can break direct updates to leaders</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9512</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;This is the root cause of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9305&quot; title=&quot;ForceLeaderTest.testReplicasInLIRNoLeader(): connection refused&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9305&quot;&gt;&lt;del&gt;SOLR-9305&lt;/del&gt;&lt;/a&gt; and (at least some of) &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9390&quot; title=&quot;LeaderFailoverAfterPartitionTest failures: Connection refused, too few active replicas, and no registered leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9390&quot;&gt;SOLR-9390&lt;/a&gt;.  The process goes something like this:&lt;/p&gt;

&lt;p&gt;Documents are added to the cluster via a CloudSolrClient, with directUpdatesToLeadersOnly set to true.  CSC caches its view of the DocCollection.  The leader then goes down, and is reassigned.  Next time documents are added, CSC checks its cache again, and gets the old view of the DocCollection.  It then tries to send the update directly to the old, now down, leader, and we get ConnectionRefused.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13004910">SOLR-9512</key>
            <summary>CloudSolrClient&apos;s cluster state cache can break direct updates to leaders</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="romseygeek">Alan Woodward</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Sep 2016 14:48:22 +0000</created>
                <updated>Sat, 8 Jun 2019 15:29:32 +0000</updated>
                            <resolved>Tue, 29 Nov 2016 15:28:18 +0000</resolved>
                                                    <fixVersion>6.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15490788" author="romseygeek" created="Wed, 14 Sep 2016 15:57:35 +0000"  >&lt;p&gt;Possibly related: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9090&quot; title=&quot;solrj CloudSolrClient: add directUpdatesToLeadersOnly support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9090&quot;&gt;&lt;del&gt;SOLR-9090&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6312&quot; title=&quot;CloudSolrServer doesn&amp;#39;t honor updatesToLeaders constructor argument&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6312&quot;&gt;&lt;del&gt;SOLR-6312&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I think the best case here is to catch a ConnectionRefusedException on a routed update and expire the collection cache entry before retrying?&lt;/p&gt;</comment>
                            <comment id="15493315" author="noble.paul" created="Thu, 15 Sep 2016 13:27:05 +0000"  >&lt;ul&gt;
	&lt;li&gt;Catch the Connectionrefused Exception&lt;/li&gt;
	&lt;li&gt;Check how old is the state. if it is older than a few seconds invalidate the cache and retry&lt;/li&gt;
	&lt;li&gt;if it is fresh, throw the error back&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15495751" author="romseygeek" created="Fri, 16 Sep 2016 08:36:20 +0000"  >&lt;p&gt;Having played with this a bit, I think adding extra retry logic to CloudSolrClient isn&apos;t the best solution; instead, I think we should make directUpdatesToLeaders a hint, rather than a directive, and just make sure that the leader is the first URL in the list passed to the load-balancer.  We can then check in the response if the leader was in fact the shard that served that particular request, and if not, then we invalidate the collection cache.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cpoerschke&quot; class=&quot;user-hover&quot; rel=&quot;cpoerschke&quot;&gt;cpoerschke&lt;/a&gt; you worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9090&quot; title=&quot;solrj CloudSolrClient: add directUpdatesToLeadersOnly support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9090&quot;&gt;&lt;del&gt;SOLR-9090&lt;/del&gt;&lt;/a&gt;, does this make sense to you?&lt;/p&gt;</comment>
                            <comment id="15498485" author="noble.paul" created="Sat, 17 Sep 2016 07:45:17 +0000"  >&lt;p&gt;It&apos;s just hiding the problem. The fact that there is no leader for that shard means that the request will fail eventually. &lt;/p&gt;</comment>
                            <comment id="15498495" author="romseygeek" created="Sat, 17 Sep 2016 07:50:25 +0000"  >&lt;p&gt;I don&apos;t think so - there &lt;b&gt;is&lt;/b&gt; a leader, it&apos;s just that we locally have the wrong one cached.  And because we&apos;re sending our updates &lt;b&gt;only&lt;/b&gt; to the previous (and now down) leader, we get a failure, when instead we ought to be sending this update on to the next leader.&lt;/p&gt;</comment>
                            <comment id="15498506" author="noble.paul" created="Sat, 17 Sep 2016 07:55:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;there is a leader, it&apos;s just that we locally have the wrong one cached&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;When we get an error , we must invalidate the cache. That&apos;s part of the solution. But the larger problem is that leader election takes a while and the state.json will have that information after sometime. The solution of sending the doc to another replica in the shard is just kicking the can down the road&lt;/p&gt;</comment>
                            <comment id="15498629" author="romseygeek" created="Sat, 17 Sep 2016 09:22:28 +0000"  >&lt;p&gt;It&apos;s kicking the can to a live server, though, which will be able to tell us either a) yes, everything&apos;s fine now, you just need to invalidate your cache, or b) there&apos;s no leader for this shard, so fail the update.  Either way, we get useful information, whereas at the moment we&apos;re trying to find out what&apos;s happening from a dead server.&lt;/p&gt;</comment>
                            <comment id="15498631" author="romseygeek" created="Sat, 17 Sep 2016 09:23:13 +0000"  >&lt;p&gt;(apologies for the terrible metaphor there, it&apos;s early on a Saturday)&lt;/p&gt;</comment>
                            <comment id="15498680" author="noble.paul" created="Sat, 17 Sep 2016 09:53:36 +0000"  >&lt;p&gt;So in your solution here is what happens&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Instead of just passing one server , we pass all the nodes to LBHttpSolrClient (LBHSC). The shard leader should be the first in the list&lt;/li&gt;
	&lt;li&gt;LBHSC knows that the leader is a dead node (or it will soon know that). So it would pick up the next server in the list and makes a request there&lt;/li&gt;
	&lt;li&gt;The request would come back with an error (no leader)&lt;/li&gt;
	&lt;li&gt;CSC returns the call with an error &quot;no leader&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Is that right?&lt;/p&gt;</comment>
                            <comment id="15502696" author="romseygeek" created="Mon, 19 Sep 2016 08:25:38 +0000"  >&lt;p&gt;Right, there are two scenarios:&lt;br/&gt;
1. The leader is down, and there&apos;s no replacement voted for yet, in which case things happen much as you describe above&lt;br/&gt;
2. The old leader is down, a new leader has been selected, but the cache hasn&apos;t updated yet.  In this case the update actually succeeds, as it&apos;s passed to the next node in the list and then forwarded on to the relevant leader.&lt;br/&gt;
In both cases, we need to invalidate the cache.&lt;/p&gt;

&lt;p&gt;Separately, there&apos;s a bit of cleanup we can do in the directUpdate() method call - at the moment we have two paths, dependent on whether or not we&apos;re using parallel updates or not, and they end up doing things like throwing slightly different exceptions for the same failure types.  I&apos;ll open up another JIRA for that.&lt;/p&gt;</comment>
                            <comment id="15502871" author="noble.paul" created="Mon, 19 Sep 2016 09:41:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;The old leader is down, a new leader has been selected, but the cache hasn&apos;t updated yet. In this case the update actually succeeds, as it&apos;s passed to the next node in the list and then forwarded on to the relevant leader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is already taken care of. When SolrJ makes a request to the node, it responds with a flag to invalidate the cache. So the next request will get the updated state&lt;/p&gt;</comment>
                            <comment id="15503035" author="romseygeek" created="Mon, 19 Sep 2016 10:29:36 +0000"  >&lt;p&gt;Patch, changing the &apos;buildUrlMap()&apos; method to always include a full list of replica URLs, with the leader in front.  In reality, this makes &apos;directUpdateToLeadersOnly&apos; a no-op, so maybe we should just deprecate and remove it?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;When SolrJ makes a request to the node, it responds with a flag to invalidate the cache. So the next request will get the updated state&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think this is the case for update requests?  At the least, when running the test in the patch, a breakpoint in ZkStateReader.compareStateVersions is never triggered.  Looking at HttpSolrCall it appears that it&apos;s only used in /select requests, which may be a bug by itself, of course.&lt;/p&gt;</comment>
                            <comment id="15503044" author="noble.paul" created="Mon, 19 Sep 2016 10:32:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking at HttpSolrCall it appears that it&apos;s only used in /select requests,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It must be a serious bug. Without proper invalidation,  the caching is useless&lt;/p&gt;</comment>
                            <comment id="15503651" author="jira-bot" created="Mon, 19 Sep 2016 14:31:28 +0000"  >&lt;p&gt;Commit f96017d9e10c665e7ab6b9161f2af08efc491946 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f96017d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f96017d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient tries other replicas if a cached leader is down&lt;/p&gt;</comment>
                            <comment id="15503653" author="jira-bot" created="Mon, 19 Sep 2016 14:31:31 +0000"  >&lt;p&gt;Commit 3d130097b7768a8d753476ffe26b83db070c8e20 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3d13009&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3d13009&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient tries other replicas if a cached leader is down&lt;/p&gt;</comment>
                            <comment id="15504167" author="noble.paul" created="Mon, 19 Sep 2016 18:01:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; The patch contains way more changes than you mentioned. You committed it without any review from the people who are collaborating with you. &lt;/p&gt;

&lt;p&gt;If there are other people collaborating on a ticket, the general protocol is that you submit a patch with the changes explained and give some review time before committing stuff.&lt;/p&gt;

&lt;p&gt;You submitted a patch and 3 hours later you committed it&lt;/p&gt;</comment>
                            <comment id="15504227" author="noble.paul" created="Mon, 19 Sep 2016 18:17:30 +0000"  >&lt;p&gt;The following is not the way we should invalidate the cache. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (response.getServer().equals(url) == &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// we didn&apos;t hit our first-preference server, which means that our cached
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// collection state is no longer valid
&lt;/span&gt;            invalidateCollectionState(collection);
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15504502" author="romseygeek" created="Mon, 19 Sep 2016 19:58:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;The patch contains way more changes than you mentioned.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I ... don&apos;t think it does?  It makes the changes I described above to CloudSolrClient, and adds a test case.  What else is there?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The following is not the way we should invalidate the cache.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How so?&lt;/p&gt;</comment>
                            <comment id="15505419" author="noble.paul" created="Tue, 20 Sep 2016 03:05:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;How so?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You invalidate the cache if the first server did not serve the request. That&apos;s a problem. When the next request comes , it gets the fresh state which is exactly the same as the entry that was just invalidated because the new leader is not elected yet and the state. json is not yet updated in ZK.  As we discussed before, the cache must be invalidated when a server says the version is stale&lt;/p&gt;</comment>
                            <comment id="15505849" author="romseygeek" created="Tue, 20 Sep 2016 07:18:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;because the new leader is not elected yet&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The invalidation clause above is only called when the request was successful, ie if a new leader is up.  If leader election hasn&apos;t happened yet, then LBHttpSolrClient will throw an exception and the whole request will fail.  The test case should illustrate this.&lt;/p&gt;</comment>
                            <comment id="15505858" author="noble.paul" created="Tue, 20 Sep 2016 07:22:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;The invalidation clause above is only called when the request was successful,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It shouldn&apos;t need to. The response must have the flag to invalidate the collection. if that code is not working as expected we should fix that. &lt;/p&gt;</comment>
                            <comment id="15505951" author="romseygeek" created="Tue, 20 Sep 2016 08:02:23 +0000"  >&lt;p&gt;OK, but lets deal with that in a separate issue, as I think it&apos;s a bit more complicated than just fixing cache invalidation for /update requests.  The current invalidation and retry logic happens at the level of the whole request, but CSC is splitting updates up into several sub-requests, and we probably don&apos;t want to redo the whole thing if a single subshard has changed leader.&lt;/p&gt;</comment>
                            <comment id="15505956" author="noble.paul" created="Tue, 20 Sep 2016 08:04:23 +0000"  >&lt;p&gt;Let&apos;s first discuss what is the fix and don&apos;t rush into solutions.If I were you I would revert the commit and discuss the solution and get a consensus&lt;/p&gt;</comment>
                            <comment id="15506019" author="cpoerschke" created="Tue, 20 Sep 2016 08:28:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; - am only now joining this ticket late here since i have been on vacation.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9090&quot; title=&quot;solrj CloudSolrClient: add directUpdatesToLeadersOnly support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9090&quot;&gt;&lt;del&gt;SOLR-9090&lt;/del&gt;&lt;/a&gt; &lt;tt&gt;directUpdatesToLeadersOnly&lt;/tt&gt; motivation/intention was for the flag to be not a hint but a directive and for updates to &apos;fail fast&apos; if there is (temporarily or otherwise) no shard leader. Fail fast (and let the caller of the &lt;tt&gt;CloudSolrClient&lt;/tt&gt; handle alarming and retries as it sees fit) as opposed to sending or retry-sending to a non-leader which would then forward to the leader (and potentially still fail eventually, eventually/not-fast-slowly).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Marvin+Justice&quot; class=&quot;user-hover&quot; rel=&quot;Marvin Justice&quot;&gt;Marvin Justice&lt;/a&gt; and I worked together on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9090&quot; title=&quot;solrj CloudSolrClient: add directUpdatesToLeadersOnly support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9090&quot;&gt;&lt;del&gt;SOLR-9090&lt;/del&gt;&lt;/a&gt; - Marvin, any thoughts on this ticket here?&lt;/p&gt;</comment>
                            <comment id="15506551" author="jira-bot" created="Tue, 20 Sep 2016 13:36:14 +0000"  >&lt;p&gt;Commit a4293ce7c4e849b171430a34f36b830a84927a93 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a4293ce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a4293ce&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient tries other replicas if a cached leader is down&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit f96017d9e10c665e7ab6b9161f2af08efc491946.&lt;/p&gt;</comment>
                            <comment id="15506552" author="jira-bot" created="Tue, 20 Sep 2016 13:36:17 +0000"  >&lt;p&gt;Commit bd3fc7f43ff54a174660b7ad51f031d2104f84b5 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bd3fc7f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bd3fc7f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient tries other replicas if a cached leader is down&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 3d130097b7768a8d753476ffe26b83db070c8e20.&lt;/p&gt;</comment>
                            <comment id="15506575" author="romseygeek" created="Tue, 20 Sep 2016 13:42:08 +0000"  >&lt;p&gt;OK, have reverted.  For the moment, I&apos;ll set directUpdatesToLeaders=false on the two regularly failing test cases.&lt;/p&gt;</comment>
                            <comment id="15506675" author="noble.paul" created="Tue, 20 Sep 2016 14:14:52 +0000"  >&lt;p&gt;Does it make any sense to have the explicit flag &lt;tt&gt;directUpdatesToLeaders&lt;/tt&gt; ? IMHO it should be the only supported behavior. Why would we ever send a request ever to another node when the shard leader is down?&lt;/p&gt;

&lt;p&gt;My proposal is as follows.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The LBHttpSolrClient is aware of down servers. So, if the leader for the shard is down we already know it and we can fail fast&lt;/li&gt;
	&lt;li&gt;If we have to fail because the shard leader is dead, we should try to explicitly read the &lt;tt&gt;state.json&lt;/tt&gt; for that collection provided the cached state is older than a certain threshold (say 1 sec?). This means, the client may fire a request to ZK to every second to refresh the state. For such refreshes, check the version first to optimize ZK reads&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15509483" author="jira-bot" created="Wed, 21 Sep 2016 10:16:38 +0000"  >&lt;p&gt;Commit bae66f7cca8cff796d142eb19585d8e79fae34f8 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bae66f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bae66f7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9305&quot; title=&quot;ForceLeaderTest.testReplicasInLIRNoLeader(): connection refused&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9305&quot;&gt;&lt;del&gt;SOLR-9305&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9390&quot; title=&quot;LeaderFailoverAfterPartitionTest failures: Connection refused, too few active replicas, and no registered leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9390&quot;&gt;SOLR-9390&lt;/a&gt;: Don&apos;t use directToLeaders updates in partition tests (see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="15509487" author="jira-bot" created="Wed, 21 Sep 2016 10:16:44 +0000"  >&lt;p&gt;Commit d326adc8bfa33432d50293402a39454d60e070e4 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d326adc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d326adc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9305&quot; title=&quot;ForceLeaderTest.testReplicasInLIRNoLeader(): connection refused&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9305&quot;&gt;&lt;del&gt;SOLR-9305&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9390&quot; title=&quot;LeaderFailoverAfterPartitionTest failures: Connection refused, too few active replicas, and no registered leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9390&quot;&gt;SOLR-9390&lt;/a&gt;: Don&apos;t use directToLeaders updates in partition tests (see &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="15576189" author="shalinmangar" created="Fri, 14 Oct 2016 19:02:21 +0000"  >&lt;p&gt;Noble and I discussed this offline. Here is a summary of the problem and the solution:&lt;/p&gt;

&lt;p&gt;There are five cases that we need to tackle. Assuming replica x is leader:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Case 1: x is disconnected from zk, y becomes leader
	&lt;ul&gt;
		&lt;li&gt;currently &#8212; x throws error on indexing, client fails and keeps trying to send requests to x and fail. This will continue until X re-connects and the client gets a stale state flag in the response.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Case 2: x is dead, y becomes leader
	&lt;ul&gt;
		&lt;li&gt;currently - client gets connect exception or NoResponseException (for in-flight requests) and client keeps retrying request to x. This will continue until x comes back online.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Case 3: x is disconnected from zk, no one is leader
	&lt;ul&gt;
		&lt;li&gt;currently &amp;#8211; client keeps sending requests to x which fail because x is disconnected from leader. This will continue until X re-connects and the client gets a stale state flag in the response.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Case 4: x is dead, no one is leader yet
	&lt;ul&gt;
		&lt;li&gt;currently - client gets connect exception or NoResponseException (for in-flight requests) and client keeps retrying request to x. This will continue until x comes back online.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Case 5: x is alive but now y is leader
	&lt;ul&gt;
		&lt;li&gt;currently &amp;#8211; client gets a stale state flag from x and refreshes cluster state to see y as the new leader. All further indexing requests are sent to y.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Case 6: client is disconnected from zk
	&lt;ul&gt;
		&lt;li&gt;currently &amp;#8211; client keeps indexing to x. If it receives a stale state error, it will try to refresh cluster state, fail and continue to send further requests to x, keep failing and keep trying to read from zk and be stuck in a cycle.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Cases 1-5 are solved by a single solution &amp;#8211; On ConnectException, NoHttpResponseException, Leader disconnected from zk error, client should fetch state from zk again. If client fetches from zk and does not get a new version then this should be marked in a flag and subsequent retries should only happen after N seconds are elapsed or if we know for a fact that version has changed since the last zk fetch was made. N could be something small as 2 seconds or so.&lt;/p&gt;

&lt;p&gt;Case 6 is more difficult. Either we can keep failing the indexing requests or we can ask a random Solr instance to return the latest cluster state. This is kinda dangerous because it can open us up to very difficult to debug bugs so I am inclined to punt on this for now.&lt;/p&gt;</comment>
                            <comment id="15583374" author="cpoerschke" created="Mon, 17 Oct 2016 20:36:11 +0000"  >&lt;p&gt;Thanks Shalin and Noble for analysing and summarising this.&lt;/p&gt;

&lt;p&gt;The proposed cases 1-5 solution sounds good to me (though i have not actually looked at the code concerned to see what the implementation of that solution might look like).&lt;/p&gt;

&lt;p&gt;Case 6: do i understand it right that we would keep failing the indexing requests but &apos;only&apos; until eventually the client manages to reconnect to zk? I agree that asking a random solr instance for its latest cluster state could be problematic.&lt;/p&gt;</comment>
                            <comment id="15587088" author="shalinmangar" created="Tue, 18 Oct 2016 23:55:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;Case 6: do i understand it right that we would keep failing the indexing requests but &apos;only&apos; until eventually the client manages to reconnect to zk?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that is correct.&lt;/p&gt;</comment>
                            <comment id="15664168" author="noble.paul" created="Mon, 14 Nov 2016 15:19:28 +0000"  >&lt;p&gt;no tests yet&lt;/p&gt;</comment>
                            <comment id="15686548" author="noble.paul" created="Tue, 22 Nov 2016 12:02:04 +0000"  >&lt;p&gt;Added tests&lt;/p&gt;</comment>
                            <comment id="15694027" author="jira-bot" created="Thu, 24 Nov 2016 18:57:43 +0000"  >&lt;p&gt;Commit e309f9058985375076cac0ed982a158dd865b86a in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e309f90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e309f90&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9784&quot; title=&quot;Refactor CloudSolrClient to eliminate direct dependency on ZK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9784&quot;&gt;&lt;del&gt;SOLR-9784&lt;/del&gt;&lt;/a&gt;: Refactor CloudSolrClient to eliminate direct dependency on ZK&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient&apos;s cluster state cache can break direct updates to leaders&lt;/p&gt;</comment>
                            <comment id="15694063" author="jira-bot" created="Thu, 24 Nov 2016 19:23:07 +0000"  >&lt;p&gt;Commit d87ffa4bf82c30e9a6f0bbb6b8c0087a5c07f9d6 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d87ffa4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d87ffa4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9784&quot; title=&quot;Refactor CloudSolrClient to eliminate direct dependency on ZK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9784&quot;&gt;&lt;del&gt;SOLR-9784&lt;/del&gt;&lt;/a&gt;: Refactor CloudSolrClient to eliminate direct dependency on ZK&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient&apos;s cluster state cache can break direct updates to leaders&lt;/p&gt;</comment>
                            <comment id="15694066" author="jira-bot" created="Thu, 24 Nov 2016 19:23:11 +0000"  >&lt;p&gt;Commit 5650939a8d41b7bad584947a2c9dcedf3774b8de in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5650939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5650939&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9784&quot; title=&quot;Refactor CloudSolrClient to eliminate direct dependency on ZK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9784&quot;&gt;&lt;del&gt;SOLR-9784&lt;/del&gt;&lt;/a&gt;: Refactor CloudSolrClient to eliminate direct dependency on ZK&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: CloudSolrClient&apos;s cluster state cache can break direct updates to leaders&lt;/p&gt;</comment>
                            <comment id="15694664" author="jira-bot" created="Fri, 25 Nov 2016 02:48:23 +0000"  >&lt;p&gt;Commit 142461b395506efa01ec2509346bae755f1b2726 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=142461b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=142461b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: removed unused import&lt;/p&gt;</comment>
                            <comment id="15694736" author="jira-bot" created="Fri, 25 Nov 2016 03:40:57 +0000"  >&lt;p&gt;Commit 3a3d6afef08e3c49c29cc9a015f4e7cca40cf52d in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3a3d6af&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3a3d6af&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9512&quot; title=&quot;CloudSolrClient&amp;#39;s cluster state cache can break direct updates to leaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9512&quot;&gt;&lt;del&gt;SOLR-9512&lt;/del&gt;&lt;/a&gt;: removed unused import&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13001675">SOLR-9464</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13032064">SOLR-9927</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13022110">SOLR-9784</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12966037">SOLR-9090</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12840013" name="SOLR-9512.patch" size="46640" author="noble.paul" created="Tue, 22 Nov 2016 12:02:04 +0000"/>
                            <attachment id="12838777" name="SOLR-9512.patch" size="7380" author="noble.paul" created="Mon, 14 Nov 2016 15:19:28 +0000"/>
                            <attachment id="12829174" name="SOLR-9512.patch" size="15852" author="romseygeek" created="Mon, 19 Sep 2016 10:29:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33mgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>