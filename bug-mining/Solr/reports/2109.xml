<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:57:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6530] Commits under network partition can put any node in down state</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6530</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Commits are executed by any node in SolrCloud i.e. they&apos;re not routed via the leader like other updates. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Suppose there&apos;s 1 collection, 1 shard, 2 replicas (A and B) and A is the leader&lt;/li&gt;
	&lt;li&gt;Suppose a commit request is made to node B during a time where B cannot talk to A due to a partition for any reason (failing switch, heavy GC, whatever)&lt;/li&gt;
	&lt;li&gt;B fails to distribute the commit to A (times out) and asks A to recover&lt;/li&gt;
	&lt;li&gt;This was okay earlier because a leader just ignores recovery requests but with leader initiated recovery code, B puts A in the &quot;down&quot; state and A can never get out of that state.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;tl;dr; During network partitions, if enough commit/optimize requests are sent to the cluster, all the nodes in the cluster will eventually be marked as &quot;down&quot;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12742178">SOLR-6530</key>
            <summary>Commits under network partition can put any node in down state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="shalin">Shalin Shekhar Mangar</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Sep 2014 15:27:39 +0000</created>
                <updated>Mon, 9 May 2016 18:58:10 +0000</updated>
                            <resolved>Thu, 16 Oct 2014 08:26:30 +0000</resolved>
                                                    <fixVersion>4.10.2</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14137386" author="shalinmangar" created="Wed, 17 Sep 2014 15:29:05 +0000"  >&lt;p&gt;A trivial test which demonstrates the problem by partitioning the leader from a replica and sending a commit to the replica which then marks the leader as &quot;down&quot;.&lt;/p&gt;</comment>
                            <comment id="14139086" author="shalinmangar" created="Thu, 18 Sep 2014 15:54:44 +0000"  >&lt;p&gt;The fix is trivial. I added checks to make sure that the current core is a leader before LIR code is executed.&lt;/p&gt;

&lt;p&gt;There is an isLeader variable in DUP which I thought about using but it is true by default and not updated for commits. I think the whole leader logic thing is very trappy and it needs some refactoring. I&apos;ll try to tackle that later in a separate issue.&lt;/p&gt;</comment>
                            <comment id="14139107" author="markrmiller@gmail.com" created="Thu, 18 Sep 2014 16:07:45 +0000"  >&lt;p&gt;Something like this came up in another JIRA issue as well. Cannot remember which. I said it there as well, but beyond this improvement, I don&apos;t think it makes a lot of sense for someone to ask for a recover because a commit failed. There should be better / cheaper options.&lt;/p&gt;</comment>
                            <comment id="14139131" author="shalinmangar" created="Thu, 18 Sep 2014 16:18:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think it makes a lot of sense for someone to ask for a recover because a commit failed. There should be better / cheaper options.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree that commits shouldn&apos;t force recovery. What do you suggest? Should we specifically disallow commit requests from executing the LIR code?&lt;/p&gt;</comment>
                            <comment id="14139170" author="romseygeek" created="Thu, 18 Sep 2014 16:59:06 +0000"  >&lt;p&gt;Think I just came across another version of this:&lt;/p&gt;

&lt;p&gt;1. A is leader, and is distributing docs to B&lt;br/&gt;
2. A gets a large GC pause, during which B takes over as leader&lt;br/&gt;
3. A wakes up again, continues to send docs from DistributedUpdateProcessor, but now gets errors in response because B is refusing the updates (as they&apos;re marked as FROMLEADER, and B is now the leader)&lt;br/&gt;
4. In DUP.doFinish(), A finds that it has a bunch of errors from B, and so it attempts to put B into recovery, with the same result as point 4 in the issue description&lt;/p&gt;</comment>
                            <comment id="14139180" author="andyetitmoves" created="Thu, 18 Sep 2014 17:08:08 +0000"  >&lt;p&gt;In general, its leader initiated recovery, so if I am not the leader, I shouldn&apos;t be doing the logic for any operation. That&apos;s probably just commit for now since that&apos;s not forwarded to the leader, but if there&apos;s any other operation in the future which doesn&apos;t have to be coordinated by the leader, that could use the same logic?&lt;/p&gt;</comment>
                            <comment id="14140056" author="shalinmangar" created="Fri, 19 Sep 2014 06:12:35 +0000"  >&lt;p&gt;Here&apos;s a better fix which uses the global (ZK) state instead of the local before executing the LIR code. From my reading of the code, the local isLeader variable in CloudDescriptor is not unset in all cases.&lt;/p&gt;</comment>
                            <comment id="14140068" author="shalinmangar" created="Fri, 19 Sep 2014 06:21:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=romseygeek&quot; class=&quot;user-hover&quot; rel=&quot;romseygeek&quot;&gt;romseygeek&lt;/a&gt; - That sounds right. This fix will help to a great extent but it isn&apos;t perfect. I think we may need to add some intelligence to the overseer to eliminate invalid state transitions to the cluster state. Also &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6538&quot; title=&quot;Add an event API to register for cluster state updates and leader updates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6538&quot;&gt;SOLR-6538&lt;/a&gt; can help in resolving such issues e.g. a leader being set to down state isn&apos;t aware of it&apos;s state and will never try to get out of it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andyetitmoves&quot; class=&quot;user-hover&quot; rel=&quot;andyetitmoves&quot;&gt;andyetitmoves&lt;/a&gt; - Yes, you&apos;re right that it could happen. We need to refactor this code such that these rules are properly defined and enforced.&lt;/p&gt;</comment>
                            <comment id="14141366" author="shalinmangar" created="Fri, 19 Sep 2014 21:51:42 +0000"  >&lt;p&gt;My last fix was not complete. Checking if I am the leader is not enough because commits are broadcast to the entire collection without caring for the shards. So it is still possible that a core which is a leader of shard2 may run LIR code for a leader/replica of another shard.&lt;/p&gt;

&lt;p&gt;I&apos;ve added a test case to reproduce this. The fix is again simple - we just don&apos;t run recovery for commits at all.&lt;/p&gt;</comment>
                            <comment id="14141894" author="andyetitmoves" created="Sat, 20 Sep 2014 09:33:47 +0000"  >&lt;p&gt;Should LIR then be checked for: I am a leader and I am the leader for replica X which is not accessible?&lt;/p&gt;</comment>
                            <comment id="14141903" author="shalinmangar" created="Sat, 20 Sep 2014 09:56:23 +0000"  >&lt;p&gt;bq, Should LIR then be checked for: I am a leader and I am the leader for replica X which is not accessible?&lt;/p&gt;

&lt;p&gt;That will be done by the initial fix that I made. But that&apos;s not enough for commits because it is sent to all shards.&lt;/p&gt;</comment>
                            <comment id="14141960" author="shalinmangar" created="Sat, 20 Sep 2014 13:07:42 +0000"  >&lt;p&gt;Okay now i got what you are saying.  That&apos;s a good idea. I&apos;ll fix. &lt;/p&gt;</comment>
                            <comment id="14155051" author="shalinmangar" created="Wed, 1 Oct 2014 16:22:16 +0000"  >&lt;p&gt;Folding in the change suggested by Ramkumar.&lt;/p&gt;</comment>
                            <comment id="14155062" author="shalinmangar" created="Wed, 1 Oct 2014 16:27:23 +0000"  >&lt;p&gt;Patch with the right test. I accidentally included an old version of the test with my last patch.&lt;/p&gt;</comment>
                            <comment id="14156299" author="shalinmangar" created="Thu, 2 Oct 2014 10:23:00 +0000"  >&lt;p&gt;The last patch&apos;s test had a bug. It wasn&apos;t using the right proxies map. This is fixed now.&lt;/p&gt;</comment>
                            <comment id="14156375" author="shalinmangar" created="Thu, 2 Oct 2014 11:08:25 +0000"  >&lt;p&gt;Here&apos;s a better patch which removes the redundant isLeader check and also logs if the error&apos;d node is not in the replica list of the current replica. All tests passed. This is ready.&lt;/p&gt;</comment>
                            <comment id="14156388" author="jira-bot" created="Thu, 2 Oct 2014 11:31:17 +0000"  >&lt;p&gt;Commit 1628945 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1628945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1628945&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Commits under network partitions can put any node in down state&lt;/p&gt;</comment>
                            <comment id="14157646" author="jira-bot" created="Fri, 3 Oct 2014 03:41:02 +0000"  >&lt;p&gt;Commit 1629107 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1629107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1629107&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Reopen the socket proxy after test finishes&lt;/p&gt;</comment>
                            <comment id="14157648" author="jira-bot" created="Fri, 3 Oct 2014 03:43:43 +0000"  >&lt;p&gt;Commit 1629108 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1629108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1629108&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Commits under network partitions can put any node in down state&lt;/p&gt;</comment>
                            <comment id="14173525" author="jira-bot" created="Thu, 16 Oct 2014 08:24:46 +0000"  >&lt;p&gt;Commit 1632236 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1632236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1632236&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Commits under network partitions can put any node in down state&lt;/p&gt;</comment>
                            <comment id="14173527" author="shalinmangar" created="Thu, 16 Oct 2014 08:26:30 +0000"  >&lt;p&gt;This is fixed. Thanks everyone!&lt;/p&gt;</comment>
                            <comment id="14178012" author="jira-bot" created="Tue, 21 Oct 2014 06:10:22 +0000"  >&lt;p&gt;Commit 1633276 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1633276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1633276&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Protect against NPE when there are no live replicas&lt;/p&gt;</comment>
                            <comment id="14178013" author="jira-bot" created="Tue, 21 Oct 2014 06:11:09 +0000"  >&lt;p&gt;Commit 1633277 from shalin@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1633277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1633277&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Protect against NPE when there are no live replicas&lt;/p&gt;</comment>
                            <comment id="14178016" author="jira-bot" created="Tue, 21 Oct 2014 06:12:18 +0000"  >&lt;p&gt;Commit 1633278 from shalin@apache.org in branch &apos;dev/branches/lucene_solr_4_10&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1633278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1633278&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6530&quot; title=&quot;Commits under network partition can put any node in down state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6530&quot;&gt;&lt;del&gt;SOLR-6530&lt;/del&gt;&lt;/a&gt;: Protect against NPE when there are no live replicas&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12742491">SOLR-6536</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12672533" name="SOLR-6530.patch" size="9758" author="shalin" created="Thu, 2 Oct 2014 11:08:25 +0000"/>
                            <attachment id="12672528" name="SOLR-6530.patch" size="9098" author="shalin" created="Thu, 2 Oct 2014 10:23:00 +0000"/>
                            <attachment id="12672352" name="SOLR-6530.patch" size="10006" author="shalin" created="Wed, 1 Oct 2014 16:27:23 +0000"/>
                            <attachment id="12672350" name="SOLR-6530.patch" size="8883" author="shalin" created="Wed, 1 Oct 2014 16:22:16 +0000"/>
                            <attachment id="12670107" name="SOLR-6530.patch" size="14278" author="shalin" created="Fri, 19 Sep 2014 21:51:42 +0000"/>
                            <attachment id="12669929" name="SOLR-6530.patch" size="8508" author="shalin" created="Fri, 19 Sep 2014 06:12:35 +0000"/>
                            <attachment id="12669745" name="SOLR-6530.patch" size="7986" author="shalin" created="Thu, 18 Sep 2014 15:54:44 +0000"/>
                            <attachment id="12669420" name="SOLR-6530.patch" size="6481" author="shalin" created="Wed, 17 Sep 2014 15:29:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i205x3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>