<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:17:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9470] Deadlocked threads in recovery</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9470</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Background: Booted up a cluster and replicas were in recovery. All replicas recovered minus one, and it was hanging on HTTP requests. Issued shutdown and solr would not shut down. Examined with JStack and found a deadlock had occurred. The relevant thread information is attached. Some information has been redacted as well (some custom URPs, IPs) from the stack traces.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13002362">SOLR-9470</key>
            <summary>Deadlocked threads in recovery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mbraun688">Michael Braun</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Sep 2016 14:22:09 +0000</created>
                <updated>Sat, 8 Jun 2019 15:37:54 +0000</updated>
                            <resolved>Fri, 30 Sep 2016 13:30:39 +0000</resolved>
                                    <version>6.2</version>
                                                        <due></due>
                            <votes>3</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15477568" author="mbraun688" created="Fri, 9 Sep 2016 16:52:54 +0000"  >&lt;p&gt;Dug more into this and only two threads are actually part of the core deadlock - &lt;/p&gt;

&lt;p&gt;&quot;recoveryExecutor-3-thread-1-processing-n:x.x.x.166:8983_solr x:mycollection_shard1_replica2 s:shard1 c:mycollection r:core_node97&quot;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00007fc1b0a97250&amp;gt; (a java.util.concurrent.locks.ReentrantLock$FairSync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
	at java.util.concurrent.locks.ReentrantLock$FairSync.lock(ReentrantLock.java:224)
	at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1804)
	at org.apache.solr.handler.IndexFetcher.openNewSearcherAndUpdateCommitPoint(IndexFetcher.java:746)
	at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:523)
	at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:254)
	at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:397)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It first acquires the iwLock ( 0x00007fc1b0a96fe0) by this mechanism:&lt;br/&gt;
org.apache.solr.update.DefaultSolrCoreState.newIndexWriter(DefaultSolrCoreState.java 210)&lt;br/&gt;
org.apache.solr.update.DirectUpdateHandler2.newIndexWriter(DirectUpdateHandler2.java 698)&lt;br/&gt;
org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java 520)&lt;/p&gt;


&lt;p&gt;Then as you see from the stacktrace above, it&apos;s waiting on the openSearcherLock, which is held by the thread below:&lt;/p&gt;

&lt;p&gt;&quot;qtp1879034789-189&quot;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00007fc1b0a96fe0&amp;gt; (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync)
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedNanos(AbstractQueuedSynchronizer.java:1037)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireSharedNanos(AbstractQueuedSynchronizer.java:1328)
	at java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.tryLock(ReentrantReadWriteLock.java:871)
	at org.apache.solr.update.DefaultSolrCoreState.lock(DefaultSolrCoreState.java:159)
	at org.apache.solr.update.DefaultSolrCoreState.getIndexWriter(DefaultSolrCoreState.java:104)
	at org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1601)
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1806)
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1552)
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1487)
	at org.apache.solr.request.SolrQueryRequestBase.getSearcher(SolrQueryRequestBase.java:115)
	at org.apache.solr.handler.admin.LukeRequestHandler.handleRequestBody(LukeRequestHandler.java:130)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:154)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s already holding the openSearchLock (0x00007fc1b0a97250) and wants the iwLock. It gets the openSearchLock by this mechanism:&lt;br/&gt;
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1804) is where it does the actual lock of openSearcher.lock, called by....&lt;br/&gt;
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1552)&lt;br/&gt;
	at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1487)&lt;br/&gt;
	at org.apache.solr.request.SolrQueryRequestBase.getSearcher(SolrQueryRequestBase.java:115)&lt;br/&gt;
	at org.apache.solr.handler.admin.LukeRequestHandler.handleRequestBody(LukeRequestHandler.java:130)&lt;/p&gt;</comment>
                            <comment id="15483039" author="dsmiley" created="Mon, 12 Sep 2016 04:35:00 +0000"  >&lt;p&gt;Nice analysis &amp;#8211; a lock ordering problem.  I don&apos;t have a lot of familiarity with this internal aspect of Solr, but I have more faith in the code path of SolrCore.getSearcher() to get locks in the right order (as it&apos;s hammered all the time) than that of IndexFetcher/Replication.  That getSearcher first obtains the openSearcher lock and then the indexWriter lock makes sense to me.   &lt;/p&gt;

&lt;p&gt;I don&apos;t follow something you said:  You explained how IndexFetcher (line 520) grabs the iwLock by calling DefaultSolrCoreState.newIndexWriter(DefaultSolrCoreState.java 210).  I see this. However, that method promptly releases the lock.  Granted during all this I think openSearcher should be held and it doesn&apos;t seem to be but despite that, the stack trace, to me, doesn&apos;t show that to be a problem in this instance.  I do see that the iwLock is held (by cross-referencing the memory reference with that of another thread awaiting it)... but it&apos;s not evident to me where exactly iwLock is acquired &lt;em&gt;such that it isn&apos;t released at the time IndexFetcher line 523 is reached&lt;/em&gt;.&lt;/p&gt;</comment>
                            <comment id="15484798" author="mbraun688" created="Mon, 12 Sep 2016 17:58:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; you&apos;re right - will dig deeper and figure out where it&apos;s actually being acquired.&lt;/p&gt;</comment>
                            <comment id="15514291" author="mbraun688" created="Thu, 22 Sep 2016 19:43:09 +0000"  >&lt;p&gt;Replicated again - redacted thread dumps attached for relevant threads. Also confirmed we see some of the same lines that were shown in the relevant &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9278&quot; title=&quot;Possible deadlock in replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9278&quot;&gt;&lt;del&gt;SOLR-9278&lt;/del&gt;&lt;/a&gt; deadlock ticket, where the index files can&apos;t be deleted, as shown below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;09-22 17:24:42.317  - we started the process

09-22 17:25:43.716 org.apache.solr.handler.IndexFetcher (recoveryExecutor-3-thread-1-processing-n:x.x.x.75:8983_solr x:collection_shard1_replica1 s:shard1 c:collection) [s:shard1] IndexFetcher unable to cleanup unused lucene index files so we must &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a full copy instead globalRequestId: 
09-22 17:25:43.716 org.apache.solr.handler.IndexFetcher (recoveryExecutor-3-thread-1-processing-n:x.x.x.75:8983_solr x:collection_shard1_replica1 s:shard1 c:collection) [s:shard1] IndexFetcher slept &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 30000ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unused lucene index files 
to be delete-able globalRequestId: 
INFO  09-22 17:25:43.864 org.apache.solr.update.DefaultSolrCoreState (recoveryExecutor-3-thread-1-processing-n:x.x.x.75:8983_solr x:collection_shard1_replica1 s:shard1 c:collection) [s:shard1] Rollback old IndexWriter... core=collection_shard1_replica1
 globalRequestId: 
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m hoping that the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9278&quot; title=&quot;Possible deadlock in replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9278&quot;&gt;&lt;del&gt;SOLR-9278&lt;/del&gt;&lt;/a&gt; is valid and would fix the problem?&lt;/p&gt;</comment>
                            <comment id="15533669" author="mbraun688" created="Thu, 29 Sep 2016 18:46:47 +0000"  >&lt;p&gt;We are now running with the patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9278&quot; title=&quot;Possible deadlock in replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9278&quot;&gt;&lt;del&gt;SOLR-9278&lt;/del&gt;&lt;/a&gt; and have not yet run into the issue again. Is someone able to take a look at the patch included in that ticket? &lt;/p&gt;</comment>
                            <comment id="15536008" author="risdenk" created="Fri, 30 Sep 2016 13:30:39 +0000"  >&lt;p&gt;Closing as duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9278&quot; title=&quot;Possible deadlock in replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9278&quot;&gt;&lt;del&gt;SOLR-9278&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15552291" author="jira-bot" created="Thu, 6 Oct 2016 15:47:06 +0000"  >&lt;p&gt;Commit ce22c2697c1342fd670e3bac460a53aef90d1d80 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ce22c26&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ce22c26&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt;: Index replication interactions with IndexWriter can cause deadlock.&lt;/p&gt;</comment>
                            <comment id="15552293" author="jira-bot" created="Thu, 6 Oct 2016 15:47:51 +0000"  >&lt;p&gt;Commit 82440f307a211d8f05fe729ec1361bcd1abd0e4e in lucene-solr&apos;s branch refs/heads/branch_6x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=82440f3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=82440f3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt;: Index replication interactions with IndexWriter can cause deadlock.&lt;/p&gt;</comment>
                            <comment id="15552304" author="markrmiller@gmail.com" created="Thu, 6 Oct 2016 15:52:03 +0000"  >&lt;p&gt;Tagged this with the dupe issue. I&apos;ll flip it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12986896">SOLR-9278</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12829921" name="solr-deadlock-2-r.txt" size="10924" author="mbraun688" created="Thu, 22 Sep 2016 19:43:09 +0000"/>
                            <attachment id="12826849" name="solr-deadlock.txt" size="15542" author="mbraun688" created="Fri, 2 Sep 2016 14:22:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i336qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>