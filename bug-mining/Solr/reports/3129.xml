<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:17:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9278] Possible deadlock in replication</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9278</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;There is a bug in IndexFetcher for replication logic, it may cause deadlock issue, and it&apos;s very easy to reproduce. If you change your solrconfig to keep more than 1 commit points, this operation will causes 2 issues:&lt;br/&gt;
1. Slave has to download whole index directory of Master, instead of incremental udpates only;&lt;br/&gt;
2. If you click &quot;replicate now&quot; button manually, this is cause deadlock, stop both &quot;indexFetcher&quot; thread and &quot;explicitFetcher&quot; thread.&lt;/p&gt;

&lt;p&gt;The first issue is a design issue, can be worked around by keep only 1 commit point. But the second issue can always happen if there is some file located in slave&apos;s index directory, but can not be deleted by index delete policy (due to permission issue etc), I have fixed this issue for my service, would happy to contribute to Solr community to benefit others.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux&lt;/p&gt;</environment>
        <key id="12986896">SOLR-9278</key>
            <summary>Possible deadlock in replication</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="gui.xunlong@gmail.com">Xunlong</reporter>
                        <labels>
                            <label>replication</label>
                    </labels>
                <created>Tue, 5 Jul 2016 18:07:22 +0000</created>
                <updated>Sat, 8 Jun 2019 15:38:17 +0000</updated>
                            <resolved>Thu, 6 Oct 2016 15:54:25 +0000</resolved>
                                    <version>6.2</version>
                                    <fixVersion>6.3</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>Server</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>12</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="15362900" author="erickerickson" created="Tue, 5 Jul 2016 18:11:28 +0000"  >&lt;p&gt;Xunlong:&lt;/p&gt;

&lt;p&gt;It would certainly be appreciated if you went ahead and attached a patch, and note that patches are easiest to work with. Here&apos;s a bit of documentation on patches in case you are unfamiliar with them:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.apache.org/solr/HowToContribute#Working_With_Patches&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/solr/HowToContribute#Working_With_Patches&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for reporting this!&lt;/p&gt;

&lt;p&gt;Erick&lt;/p&gt;</comment>
                            <comment id="15362921" author="gui.xunlong@gmail.com" created="Tue, 5 Jul 2016 18:16:14 +0000"  >&lt;p&gt;This can be fixed by code change:&lt;/p&gt;

&lt;p&gt;f45c89a52c67% git diff&lt;br/&gt;
diff --git a/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java b/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java&lt;br/&gt;
index 0244844..99f7124 100644&lt;br/&gt;
&amp;#8212; a/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java&lt;br/&gt;
+++ b/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java&lt;br/&gt;
@@ -416,11 +416,22 @@ public class IndexFetcher {&lt;br/&gt;
           } finally &lt;/p&gt;
{
             writer.decref();
           }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;solrCore.getUpdateHandler().getSolrCoreState().closeIndexWriter(solrCore, true);&lt;br/&gt;
+&lt;br/&gt;
+          // Following line is in original Solr 5.4 code base, but could possibly cause dead lock issue&lt;br/&gt;
+          //solrCore.getUpdateHandler().getSolrCoreState().closeIndexWriter(solrCore, true);&lt;br/&gt;
         }&lt;br/&gt;
         boolean reloadCore = false;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         try {&lt;br/&gt;
+          // start to download index files&lt;br/&gt;
+          // need to close current index writer if we are just doing incremental index files download&lt;br/&gt;
+          // notice this operation will occupy indexWriterLock in DefaultSolrCoreState which has to be released&lt;br/&gt;
+          // later by calling openIndexWriter(), otherwise, we might cause a deadlock once explicit-replication thread&lt;br/&gt;
+          // jump in&lt;br/&gt;
+          if (!isFullCopyNeeded) &lt;/p&gt;
{
+            solrCore.getUpdateHandler().getSolrCoreState().closeIndexWriter(solrCore, true);
+          }
&lt;p&gt;+&lt;br/&gt;
           LOG.info(&quot;Starting download (fullCopy={}) to {}&quot;, isFullCopyNeeded, tmpIndexDir);&lt;br/&gt;
           successfulInstall = false;&lt;/p&gt;

&lt;p&gt;@@ -470,6 +481,8 @@ public class IndexFetcher {&lt;br/&gt;
             }&lt;br/&gt;
           }&lt;br/&gt;
         } finally {&lt;br/&gt;
+          // open a new index writer, this will also release indexWriterLock in DefaultSolrCoreState to&lt;br/&gt;
+          // allow other thread (like explicit-replication thread) do replication job&lt;br/&gt;
           if (!isFullCopyNeeded) &lt;/p&gt;
{
             solrCore.getUpdateHandler().getSolrCoreState().openIndexWriter(solrCore);
           }


&lt;p&gt;The reason is that we change boolean value &quot;isFullCopyNeeded&quot; from &quot;false&quot; to &quot;true&quot; if there are files can not be deleted by IndexDeletionPolicy, but we still close indexWriter to occupy index writer lock because we thought &quot;isFullCopyNeeded==false&quot;, but actually &quot;isFullCopyNeeded==true&quot; right now. Due to &quot;isFullCopyNeeded==true&quot;, the following logic can not create a new indexWriter to release index writer lock, then this thread will hold the index writer lock forever. If another replication thread jump in, which will acquire &quot;indexFetchLock&quot; in ReplicationHandler, deadlock will happen.&lt;/p&gt;</comment>
                            <comment id="15363277" author="gui.xunlong@gmail.com" created="Tue, 5 Jul 2016 21:20:58 +0000"  >&lt;p&gt;Patch&lt;/p&gt;</comment>
                            <comment id="15363280" author="gui.xunlong@gmail.com" created="Tue, 5 Jul 2016 21:22:10 +0000"  >&lt;p&gt;Hi Erick,&lt;/p&gt;

&lt;p&gt;Patch is attached. Thanks.&lt;/p&gt;</comment>
                            <comment id="15477579" author="mbraun688" created="Fri, 9 Sep 2016 16:55:21 +0000"  >&lt;p&gt;Is this possibly the same issue I reported as &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt; or another deadlock?&lt;/p&gt;</comment>
                            <comment id="15533661" author="mbraun688" created="Thu, 29 Sep 2016 18:45:02 +0000"  >&lt;p&gt;We are running this patch on top of 6.2.1 on our cluster and have not run into the issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt; again. Is someone able to take a look at it to see if it can fit into the regular release?&lt;/p&gt;</comment>
                            <comment id="15552310" author="jira-bot" created="Thu, 6 Oct 2016 15:53:43 +0000"  >&lt;p&gt;Commit 05f51c85f6a536915bdfad5959966c891fac6ee0 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=05f51c8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=05f51c8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9278&quot; title=&quot;Possible deadlock in replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9278&quot;&gt;&lt;del&gt;SOLR-9278&lt;/del&gt;&lt;/a&gt;: Update issue number in CHANGES to be orig rather than dupe.&lt;/p&gt;</comment>
                            <comment id="15552312" author="jira-bot" created="Thu, 6 Oct 2016 15:53:59 +0000"  >&lt;p&gt;Commit 360ac3ad26d71fedcba2550271ee4af3dc93651f in lucene-solr&apos;s branch refs/heads/branch_6x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=360ac3a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=360ac3a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9278&quot; title=&quot;Possible deadlock in replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9278&quot;&gt;&lt;del&gt;SOLR-9278&lt;/del&gt;&lt;/a&gt;: Update issue number in CHANGES to be orig rather than dupe.&lt;/p&gt;</comment>
                            <comment id="15552314" author="markrmiller@gmail.com" created="Thu, 6 Oct 2016 15:54:26 +0000"  >&lt;p&gt;Thanks Xunlong!&lt;/p&gt;</comment>
                            <comment id="15552320" author="markrmiller@gmail.com" created="Thu, 6 Oct 2016 15:56:24 +0000"  >&lt;p&gt;Commits are accidently logged in the dupe issue FYI: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Commit ce22c2697c1342fd670e3bac460a53aef90d1d80 in lucene-solr&apos;s branch refs/heads/master from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ce22c26&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ce22c26&lt;/a&gt; ]&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt;: Index replication interactions with IndexWriter can cause deadlock. &lt;/p&gt;

&lt;p&gt;Commit 82440f307a211d8f05fe729ec1361bcd1abd0e4e in lucene-solr&apos;s branch refs/heads/branch_6x from markrmiller&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=82440f3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=82440f3&lt;/a&gt; ]&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9470&quot; title=&quot;Deadlocked threads in recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9470&quot;&gt;&lt;del&gt;SOLR-9470&lt;/del&gt;&lt;/a&gt;: Index replication interactions with IndexWriter can cause deadlock.&lt;/p&gt;</comment>
                            <comment id="15650302" author="shalinmangar" created="Wed, 9 Nov 2016 08:39:00 +0000"  >&lt;p&gt;Closing after 6.3.0 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13002362">SOLR-9470</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12816310" name="SOLR-9278.patch" size="2018" author="gui.xunlong@gmail.com" created="Tue, 5 Jul 2016 21:20:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30jvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>