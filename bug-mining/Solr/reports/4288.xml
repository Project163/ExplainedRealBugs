<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13700] Race condition in initializing metrics for new security plugins when security.json is modified</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13700</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When new security plugins are initialized due to remote API requetss, there is a delay between &quot;registering&quot; the new plugins for use in methods like &lt;tt&gt;initializeAuthenticationPlugin()&lt;/tt&gt; (by assigning them to CoreContainer&apos;s volatile &lt;tt&gt;this.authenticationPlugin&lt;/tt&gt; variable) and when the &lt;tt&gt;initializeMetrics(..)&lt;/tt&gt; method is called on these plugins, so that they continue to use the existing &lt;tt&gt;Metric&lt;/tt&gt; instances as the plugins they are replacing.&lt;/p&gt;

&lt;p&gt;Because these security plugins maintain local refrences to these Metrics (and don&apos;t &quot;get&quot; them from the MetricRegisty everytime they need to &lt;tt&gt;inc()&lt;/tt&gt; them) this means that there is short race condition situation such that during the window of time after a new plugin instance is put into use, but before  &lt;tt&gt;initializeMetrics(..)&lt;/tt&gt; is called on them, at these plugins are responsible for accepting/rejecting requests, and decisions in &lt;tt&gt;Metric&lt;/tt&gt; instances that are not registered and subsequently get thrown away (and GCed) once the CoreContainer gets around to calling &lt;tt&gt;initializeMetrics(..)&lt;/tt&gt; (and the plugin starts using the pre-existing metric objects)&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;This has some noticible impacts on auth tests on CPU constrained jenkins machines (even after putting in place &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13464&quot; title=&quot;no way for external clients to detect when changes to security config have taken effect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13464&quot;&gt;SOLR-13464&lt;/a&gt; work arounds) that make assertions about the metrics recorded.&lt;/p&gt;

&lt;p&gt;In real world situations, the impact of this bug on users is minor: for a few micro/milli-seconds, requests may come in w/o being counted in the auth metrics &amp;#8211; which may also result in descrepencies between the auth metrics totals and the overall request metrics.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="13251130">SOLR-13700</key>
            <summary>Race condition in initializing metrics for new security plugins when security.json is modified</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Aug 2019 01:12:28 +0000</created>
                <updated>Thu, 12 May 2022 00:26:40 +0000</updated>
                            <resolved>Thu, 22 Aug 2019 00:34:58 +0000</resolved>
                                                    <fixVersion>8.3</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16908595" author="hossman" created="Fri, 16 Aug 2019 01:15:17 +0000"  >
&lt;p&gt;Attaching a patch to address this, one nocommit regarding something that makes no sense to me...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; - can you please review and sanity check:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;that my understanding is correct, and that it&apos;s &quot;safe&quot; (and more correct) for the &quot;old&quot; and &quot;new&quot; instances of these plugins to be using the same Metric instances before the &quot;new&quot; plugin replaces the old one&lt;/li&gt;
	&lt;li&gt;the nocommit comments &amp;#8211; unless i&apos;m missing something &lt;tt&gt;reloadSecurityProperties()&lt;/tt&gt; has no business calling &lt;tt&gt;pkiAuthenticationPlugin.initializeMetrics(...)&lt;/tt&gt;, because &lt;tt&gt;pkiAuthenticationPlugin&lt;/tt&gt; can never change as a result of reloading the security.json ... so &lt;tt&gt;pkiAuthenticationPlugin.initializeMetrics(...)&lt;/tt&gt; should be called exactly once (and only once) for it&apos;s entire lifecycle ... ideally in &lt;tt&gt;CoreContainer.load()&lt;/tt&gt; immediately after calling &lt;tt&gt;pkiAuthenticationPlugin = new PKIAuthenticationPlugin...)&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;

</comment>
                            <comment id="16908870" author="janhoy" created="Fri, 16 Aug 2019 09:07:53 +0000"  >&lt;p&gt;Good catch.&lt;/p&gt;

&lt;p&gt;Re point 2, your patch deletes the wrong lines for auditloggerPlugin metrics.&#160;I agree that the initialization of PKI metrics in &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/core/CoreContainer.java#L877-L879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;lines 877-879&lt;/a&gt; should be moved to L631, right after initializing PKI first (only) time.&lt;/p&gt;</comment>
                            <comment id="16909041" author="ab" created="Fri, 16 Aug 2019 13:16:39 +0000"  >&lt;p&gt;ad 1: yes, it&apos;s correct - the instances of these metrics are reused by all instances of respective plugins, so if the &quot;old&quot; instance was still processing an in-flight request it will still be counted, while the new instance may already handle new requests and use the same counters. It&apos;s perfectly ok.&lt;/p&gt;

&lt;p&gt;ad 2: this seems like a confusion between referring to &lt;tt&gt;pkiAuthenticationPlugin&lt;/tt&gt;&#160;(which stays unchanged) and &lt;tt&gt;authenticationPlugin&lt;/tt&gt; (which may have changed). It&apos;s correct we don&apos;t need this here.&lt;/p&gt;

&lt;p&gt;Also, I think the call to &lt;tt&gt;initializeMetrics&lt;/tt&gt; should be done in each of &lt;tt&gt;initializeAuditloggerPlugin&lt;/tt&gt; and &lt;tt&gt;initializeAuthenticationPlugin&lt;/tt&gt;, then it&apos;s easier to avoid confusion because within the scope of these methods it&apos;s obvious that a new instance is created which needs to be initialized.&lt;/p&gt;

&lt;p&gt;Also, I just spotted that both &lt;tt&gt;AuditLoggerPlugin.initializeMetrics&lt;/tt&gt; and &lt;tt&gt;AuthenticationPlugin.initializeMetrics&lt;/tt&gt; needlessly add metrics names to &lt;tt&gt;metricNames&lt;/tt&gt; - this is already done as a part of each respective metric registration by using &lt;tt&gt;SolrInfoBean.this.registerName(name)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16909083" author="janhoy" created="Fri, 16 Aug 2019 14:14:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, I just spotted that both &lt;tt&gt;AuditLoggerPlugin.initializeMetrics&lt;/tt&gt; and &lt;tt&gt;AuthenticationPlugin.initializeMetrics}}needlessly add metrics names to {{metricNames&lt;/tt&gt; - this is already done as a part of each respective metric registration by using &lt;tt&gt;SolrInfoBean.this.registerName(name)&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can you file a new Jira for this one and I&apos;ll grab it? Don&apos;t remember which class I used as template back then, but there may be other places to clean up too.&lt;/p&gt;</comment>
                            <comment id="16909100" author="ab" created="Fri, 16 Aug 2019 14:52:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt; created &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13702&quot; title=&quot;Some components register twice their metric names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13702&quot;&gt;&lt;del&gt;SOLR-13702&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16909256" author="hossman" created="Fri, 16 Aug 2019 17:37:23 +0000"  >
&lt;p&gt;I&apos;ve updated the patch to move &lt;tt&gt;pkiAuthenticationPlugin.initializeMetrics((...)&lt;/tt&gt; so that it is called exactly once immediately after &lt;tt&gt;new PKIAuthenticationPlugin(...)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;precommit now passes, i&apos;m still beasting.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;: I don&apos;t understand this part of your comment...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... Re point 2, your patch deletes the wrong lines for auditloggerPlugin metrics. ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The only lines modified in my patch(es) that mention &lt;tt&gt;auditloggerPlugin&lt;/tt&gt; is to move the &lt;tt&gt;auditloggerPlugin.plugin.initializeMetrics(...)&lt;/tt&gt; call into the existing &lt;tt&gt;initializeAuditloggerPlugin(...)&lt;/tt&gt; as per the point of this jira.&lt;/p&gt;

&lt;p&gt;Can you please elaborate on what lines you think were wrong to be deleted/moved ?  ... ideally with a counter-patch, or suggested new case demonstrating the problem, so there&apos;s no ambiguity as to what you mean?&lt;/p&gt;</comment>
                            <comment id="16909331" author="janhoy" created="Fri, 16 Aug 2019 18:50:40 +0000"  >&lt;p&gt;Forget my comment, I now see what happened in the first patch. And the newest patch makes the code easier to read, I like it!&lt;/p&gt;</comment>
                            <comment id="16909338" author="ab" created="Fri, 16 Aug 2019 19:01:23 +0000"  >&lt;p&gt;+1.&lt;/p&gt;</comment>
                            <comment id="16910045" author="jira-bot" created="Sun, 18 Aug 2019 19:21:06 +0000"  >&lt;p&gt;Commit 251259d5abf94578b51da3efd05327da72667e7e in lucene-solr&apos;s branch refs/heads/master from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=251259d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=251259d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13700&quot; title=&quot;Race condition in initializing metrics for new security plugins when security.json is modified&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13700&quot;&gt;&lt;del&gt;SOLR-13700&lt;/del&gt;&lt;/a&gt;: Fixed a race condition when initializing metrics for new security plugins on security.json change&lt;/p&gt;</comment>
                            <comment id="16910058" author="jira-bot" created="Sun, 18 Aug 2019 20:35:36 +0000"  >&lt;p&gt;Commit 2ca46fb0a385f0a56b2828609efa5f2b876527a6 in lucene-solr&apos;s branch refs/heads/branch_8x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=2ca46fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=2ca46fb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13700&quot; title=&quot;Race condition in initializing metrics for new security plugins when security.json is modified&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13700&quot;&gt;&lt;del&gt;SOLR-13700&lt;/del&gt;&lt;/a&gt;: Fixed a race condition when initializing metrics for new security plugins on security.json change&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 251259d5abf94578b51da3efd05327da72667e7e)&lt;/p&gt;</comment>
                            <comment id="16910303" author="jira-bot" created="Mon, 19 Aug 2019 10:20:49 +0000"  >&lt;p&gt;Commit 251259d5abf94578b51da3efd05327da72667e7e in lucene-solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13650&quot; title=&quot;Support for named global classloaders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13650&quot;&gt;&lt;del&gt;SOLR-13650&lt;/del&gt;&lt;/a&gt; from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=251259d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=251259d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13700&quot; title=&quot;Race condition in initializing metrics for new security plugins when security.json is modified&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13700&quot;&gt;&lt;del&gt;SOLR-13700&lt;/del&gt;&lt;/a&gt;: Fixed a race condition when initializing metrics for new security plugins on security.json change&lt;/p&gt;</comment>
                            <comment id="17535552" author="janhoy" created="Thu, 12 May 2022 00:26:40 +0000"  >&lt;p&gt;Closing after the 9.0.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12977830" name="SOLR-13700.patch" size="2910" author="hossman" created="Fri, 16 Aug 2019 17:36:55 +0000"/>
                            <attachment id="12977736" name="SOLR-13700.patch" size="2651" author="hossman" created="Fri, 16 Aug 2019 01:12:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05pwg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>