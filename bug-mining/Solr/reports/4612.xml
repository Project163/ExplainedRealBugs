<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:46:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-15031] NPE caused by FunctionQParser returning a null ValueSource</title>
                <link>https://issues.apache.org/jira/browse/SOLR-15031</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;When parsing a sub query in a function query, &lt;tt&gt;FunctionQParser#parseValueSource&lt;/tt&gt; does not check if the produced query object is null. When it is, it just wraps a null in a &lt;tt&gt;QueryValueSource&lt;/tt&gt; object. This is a cause for NPE&apos;s in code consuming that object. Parsed queries can be null, for example when the query string only contains stopwords, so we need handle that condition.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Stepstoreproducetheissue&quot;&gt;&lt;/a&gt;Steps to reproduce the issue&lt;/h3&gt;
&lt;ol&gt;
	&lt;li&gt;Start solr with the techproducts example collection: &lt;tt&gt;solr start -e techproducts&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Add a stopword to SOLR_DIR/example/techproducts/solr/techproducts/conf/stopwords.txt, for example &quot;at&quot;&lt;/li&gt;
	&lt;li&gt;Reload the core&lt;/li&gt;
	&lt;li&gt;Execute a function query:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8983/solr/techproducts/select?fieldquery={!field%20f=features%20v=%27%22at%22%27}&amp;amp;q={!func}%20if($fieldquery,1,0)&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The following stacktrace is produced:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-12-03 13:35:38.868 INFO  (qtp2095677157-21) [   x:techproducts] o.a.s.c.S.Request [techproducts]  webapp=/solr path=/select params={q={!func}+&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;($fieldquery,1,0)&amp;amp;fieldquery={!field+f%3Dfeatures+v%3D&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-quote&quot;&gt;&quot;at&quot;&lt;/span&gt;&apos;&lt;/span&gt;}} status=500 QTime=34
2020-12-03 13:35:38.872 ERROR (qtp2095677157-21) [   x:techproducts] o.a.s.s.HttpSolrCall &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;:java.lang.NullPointerException
        at org.apache.lucene.queries.function.valuesource.QueryValueSource.hashCode(QueryValueSource.java:63)
        at org.apache.lucene.queries.function.valuesource.IfFunction.hashCode(IfFunction.java:129)
        at org.apache.lucene.queries.function.FunctionQuery.hashCode(FunctionQuery.java:176)
        at org.apache.solr.search.QueryResultKey.&amp;lt;init&amp;gt;(QueryResultKey.java:53)
        at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1341)
        at org.apache.solr.search.SolrIndexSearcher.search(SolrIndexSearcher.java:580)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13344024">SOLR-15031</key>
            <summary>NPE caused by FunctionQParser returning a null ValueSource</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mdrob">Mike Drob</assignee>
                                    <reporter username="boxtelp">Pieter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Dec 2020 13:59:03 +0000</created>
                <updated>Sat, 20 Mar 2021 21:12:31 +0000</updated>
                            <resolved>Tue, 22 Dec 2020 21:39:00 +0000</resolved>
                                                    <fixVersion>8.8</fixVersion>
                    <fixVersion>9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17243908" author="boxtelp" created="Fri, 4 Dec 2020 10:00:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/2118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt; fixing this has been created.&lt;/p&gt;</comment>
                            <comment id="17243910" author="boxtelp" created="Fri, 4 Dec 2020 10:03:12 +0000"  >&lt;p&gt;FYI; the reproduction query is a bit silly, but this is just a simplified version of our real life queries. We use the function queries in a sort clause, to pull additional features like freshness in the ranking and to sort special documents on top, etc.&lt;/p&gt;</comment>
                            <comment id="17253779" author="jira-bot" created="Tue, 22 Dec 2020 21:34:59 +0000"  >&lt;p&gt;Commit 9d19a5893621766be6ffd0002ef0997da6847aa5 in lucene-solr&apos;s branch refs/heads/branch_8x from Pieter van Boxtel&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=9d19a58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=9d19a58&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15031&quot; title=&quot;NPE caused by FunctionQParser returning a null ValueSource&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15031&quot;&gt;&lt;del&gt;SOLR-15031&lt;/del&gt;&lt;/a&gt; Prevent null being wrapped in a QueryValueSource&lt;/p&gt;

&lt;p&gt;closes #2118&lt;/p&gt;</comment>
                            <comment id="17253780" author="jira-bot" created="Tue, 22 Dec 2020 21:35:08 +0000"  >&lt;p&gt;Commit 98f12f4aeb9f6ec9f5c4de53f9faddc41043df59 in lucene-solr&apos;s branch refs/heads/master from Pieter van Boxtel&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=98f12f4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=98f12f4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-15031&quot; title=&quot;NPE caused by FunctionQParser returning a null ValueSource&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-15031&quot;&gt;&lt;del&gt;SOLR-15031&lt;/del&gt;&lt;/a&gt; Prevent null being wrapped in a QueryValueSource&lt;/p&gt;

&lt;p&gt;closes #2118&lt;/p&gt;</comment>
                            <comment id="17253781" author="mdrob" created="Tue, 22 Dec 2020 21:39:00 +0000"  >&lt;p&gt;Merged this in, thanks for the contribution!&lt;/p&gt;</comment>
                            <comment id="17275704" author="dsmiley" created="Sat, 30 Jan 2021 19:47:00 +0000"  >&lt;p&gt;See my comment &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8319?focusedCommentId=17275656&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17275656&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-8319?focusedCommentId=17275656&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17275656&lt;/a&gt;&lt;br/&gt;
&amp;#8211; QParser.parse returning null is the cause of many Solr NPEs.&lt;/p&gt;</comment>
                            <comment id="17294419" author="boxtelp" created="Wed, 3 Mar 2021 09:25:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt;, I agree with that comment, I also thought the real problem is QParser.parse returning null, but I did not dare to suggest to deal with that. &lt;/p&gt;

&lt;p&gt;Since the introduction of the Java language it supports the concept of null values, which is abused by programmers to give &quot;null&quot; a special meaning. That happened in Lucene too, QParser.parse is allowed to return null when the input does not produce a Query. Java 8 finally brought a solution with the Optional type and I think that would be the ideal solution here too. Changing the return type of QParser.parse however is a breaking change which is though. Maybe we can introduce a new QParser.parse method, mark the current one deprecated and refactor all Lucene&amp;amp;Solr code to use the new?&lt;/p&gt;

&lt;p&gt;Alternatively, we can change the contract as you suggest, but that&apos;s problematic too because how do we prevent it from breaking stuff? We can refactor all Solr and Lucene code, but people (like me) write their own query parsers and code calling such query parsers. Such code also needs to be reviewed and how do we enforce that? Even if I have a junit test assuming QParser.parse to return null and coding that assumption in a mock QParser, that test will not break after changing the contract. I think the only way to enforce such change and to make sure it is dealt with, is to make a breaking change like changing the return type as suggested above.&lt;/p&gt;</comment>
                            <comment id="17294985" author="dsmiley" created="Thu, 4 Mar 2021 04:36:32 +0000"  >&lt;p&gt;Yeah; it&apos;d be an upgrade headache to change the contract or create some other parseNotNull.  Ugh.&lt;br/&gt;
Alternatively &amp;#8211; I&apos;ve been thinking Lucene/Solr would benefit from having a &quot;Nullable&quot; annotation in our codebase with IDE support and/or static analysis checkers.  It&apos;d need a bit of exploration and a dev list post to draw attention to it.&lt;/p&gt;</comment>
                            <comment id="17297179" author="boxtelp" created="Mon, 8 Mar 2021 08:39:47 +0000"  >&lt;p&gt;Yes that would help. It will be a lot work of to add the annotations everywhere, but that&apos;s the case for any solution. The big advantage is, it will be compatible with what we have. New issues, possible bugs will be flagged, but there will not be a broken build or failing test that needs immediate attention, so fixing those issues can be planned.&lt;/p&gt;

&lt;p&gt;This issue is a nice demonstration of how that would work (I think, haven&apos;t tried it out yet): if QueryValueSource would mark the Query constructor parameter as @NotNull and QParser.getQuery() would return a @Nullable Query, then a problem would be detected (while building the code). Issue if fixed by adding an explicit null check in FunctionQParser as I did in my PR.&lt;/p&gt;

&lt;p&gt;Regarding &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8319&quot; title=&quot;NPE when creating pivot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8319&quot;&gt;&lt;del&gt;SOLR-8319&lt;/del&gt;&lt;/a&gt;; since Solr&apos;s QParsers (like ExtendedDismaxQParser) delegate building the Query to QueryBuilder, it makes sense to mark methods in there to be returning a @Nullable Query as well. Doing so would also deal with &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8319&quot; title=&quot;NPE when creating pivot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8319&quot;&gt;&lt;del&gt;SOLR-8319&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To explore the solution, we could use this issue; cut a branch before my PR is merged, add annotations in there, observate the warnings being generated, merge in the PR and see that the warnings are gone.&lt;/p&gt;</comment>
                            <comment id="17305571" author="dsmiley" created="Sat, 20 Mar 2021 21:12:31 +0000"  >&lt;p&gt;I confess I&apos;m too busy to push for this at this time, but if you wish to, I&apos;d be happy to review &amp;amp; commit. &#160;The proper start is a dev list post to raise awareness and gather input from others who have used similar approaches in other projects.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 34 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0l67c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>