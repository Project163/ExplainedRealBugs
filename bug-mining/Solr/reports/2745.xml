<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:10:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8372] Canceled recovery can lead to data loss</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8372</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;A recovery via index replication tells the update log to start buffering updates.  If that recovery is canceled for whatever reason by the replica, the RecoveryStrategy calls ulog.dropBufferedUpdates() which stops buffering and places the UpdateLog back in active mode.  If updates come from the leader after this point (and before ReplicationStrategy retries recovery), the update will be processed as normal and added to the transaction log. If the server is bounced, those last updates to the transaction log look normal (no FLAG_GAP) and can be used to determine who is more up to date. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12919077">SOLR-8372</key>
            <summary>Canceled recovery can lead to data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Dec 2015 20:36:55 +0000</created>
                <updated>Mon, 9 May 2016 18:44:57 +0000</updated>
                            <resolved>Tue, 15 Dec 2015 21:24:11 +0000</resolved>
                                                    <fixVersion>5.5</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15049944" author="yseeley@gmail.com" created="Thu, 10 Dec 2015 03:14:05 +0000"  >&lt;p&gt;I&apos;ve been thinking about possible ways to deal with this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stop updates at a higher level... if the distributed update processor knows it&apos;s not in the right state to accept updates, then reject them
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;this has problems with race conditions unless the check/reject is with the bucket lock held&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;keep buffering updates when recovery is canceled.  When another call to bufferUpdates() is made, reset the starting position so we know where replay needs to start from.&lt;/li&gt;
	&lt;li&gt;introduce a new state into UpdateLog (the current states are REPLAYING, BUFFERING, APPLYING_BUFFERED, ACTIVE)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;this new state would do what?  Silently drop updates it receives?  Throw an exception?  The latter would seem to complicate things further if it could possibly cause another node to put us into LIR again.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In anticipation of really hairy scenarios, keeping updates might be useful rather than dropping them.  So perhaps the &quot;keep buffering&quot; option may be simplest as it also avoids introducing another state?  We should normally receive only a a few more updates that were in the pipeline when something happened to our recovery attempt anyway (like the leader dying)? &lt;/p&gt;</comment>
                            <comment id="15050925" author="markrmiller@gmail.com" created="Thu, 10 Dec 2015 12:42:52 +0000"  >&lt;p&gt;Buffering seems fine to me. Now that we start buffering even before peer sync anyway, we are almost always in a buffering state anyway, other than the brief time between replaying buffered docs and starting the recovery again.&lt;/p&gt;</comment>
                            <comment id="15051199" author="shalinmangar" created="Thu, 10 Dec 2015 16:33:09 +0000"  >&lt;p&gt;Continuing to buffer updates seems safe but why to reset the starting updates on another call to bufferUpdates()? Wouldn&apos;t the existing RecoveryInfo have the right start position already?&lt;/p&gt;</comment>
                            <comment id="15051213" author="yseeley@gmail.com" created="Thu, 10 Dec 2015 16:43:01 +0000"  >&lt;p&gt;Buffering is done during recovery-via-index-replication... the leader starts forwarding updates and then does a commit we can replicate from.  If that whole process is canceled and restarted, we only need to replay from the last time bufferUpdates() was called (all of the previously buffered updates should be in the new index snapshot we are going to get).&lt;/p&gt;

&lt;p&gt;Are there other scenarios where this wouldn&apos;t be the right thing to do?  I guess we need an audit of every place that bufferUpdates() is called.&lt;/p&gt;</comment>
                            <comment id="15051229" author="markrmiller@gmail.com" created="Thu, 10 Dec 2015 16:56:05 +0000"  >&lt;p&gt;Shard splitting does use it.&lt;/p&gt;

&lt;p&gt;There is also a general Solr admin API that start buffering. Looks like migrate uses that.&lt;/p&gt;</comment>
                            <comment id="15051243" author="markrmiller@gmail.com" created="Thu, 10 Dec 2015 17:02:32 +0000"  >&lt;p&gt;Looks like for shard splitting it is just entering buffering earlier, to be sure it happens before the core can receive updates.&lt;/p&gt;

&lt;p&gt;I&apos;m not so sure what migrate is doing on a first glance.&lt;/p&gt;

&lt;p&gt;For both of them, I&apos;m curious where the replay or drop happens. Seems a little hairy to rely on the RecoveryStrategy replay or drop. (Though I guess it seems a whole lot safer now that we always buffer docs in recovery, even if peer sync works.)&lt;/p&gt;</comment>
                            <comment id="15051267" author="shalinmangar" created="Thu, 10 Dec 2015 17:14:18 +0000"  >&lt;p&gt;Thanks for explaining that Yonik. Yes, resetting start position does seem like the right thing to do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shard splitting does use it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, sub-shard leader set update log to buffering mode during core creation. The sub-shard leader has no one to recover from so recovery is a no-op so it shouldn&apos;t be impacted by this change.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There is also a general Solr admin API that start buffering. Looks like migrate uses that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that is used by migrate to enable buffering on the target collection&apos;s leader. After this call succeeds, a routing rule is added to the source collection which starts sending all relevant updates to the target collection.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For both of them, I&apos;m curious where the replay or drop happens. Seems a little hairy to rely on the RecoveryStrategy replay or drop. (Though I guess it seems a whole lot safer now that we always buffer docs in recovery, even if peer sync works.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Both use the REQUESTAPPLYUPDATES core admin action to apply buffered updates. RecoveryStrategy is not used here at all. If a migrate action fails, the target collection is still left in buffering state which shouldn&apos;t pose a problem if migrate is retried.&lt;/p&gt;</comment>
                            <comment id="15051283" author="markrmiller@gmail.com" created="Thu, 10 Dec 2015 17:21:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Both use the REQUESTAPPLYUPDATES &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, was looking for a cmd like that but did not see it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are there other scenarios where this wouldn&apos;t be the right thing to do?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Doesn&apos;t seem so then? &lt;/p&gt;

&lt;p&gt;Only thing I can think of is, what about the async nature of those core admin buffer calls - any chance of those overlapping with recovery strategy buffer calls? And if so, would that matter with this change?&lt;/p&gt;</comment>
                            <comment id="15058388" author="yseeley@gmail.com" created="Tue, 15 Dec 2015 17:36:07 +0000"  >&lt;p&gt;Here&apos;s a patch that allows bufferUpdates() to be called more than once, and removes the call to dropBufferedUpdates() from RecoveryStrategy.&lt;/p&gt;

&lt;p&gt;Previously, if bufferUpdates() was called in a state!=ACTIVE, we simply returned w/o changing the state.  This is now logged at least.&lt;/p&gt;

&lt;p&gt;This has an additional side effect of having buffered versions in our log that were never applied to the index.  This seems OK though... better not to lose updates in general.&lt;/p&gt;</comment>
                            <comment id="15058808" author="jira-bot" created="Tue, 15 Dec 2015 21:06:33 +0000"  >&lt;p&gt;Commit 1720250 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1720250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1720250&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8372&quot; title=&quot;Canceled recovery can lead to data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8372&quot;&gt;&lt;del&gt;SOLR-8372&lt;/del&gt;&lt;/a&gt;: continue buffering if recovery is canceled/failed&lt;/p&gt;</comment>
                            <comment id="15058814" author="jira-bot" created="Tue, 15 Dec 2015 21:07:27 +0000"  >&lt;p&gt;Commit 1720251 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1720251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1720251&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8372&quot; title=&quot;Canceled recovery can lead to data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8372&quot;&gt;&lt;del&gt;SOLR-8372&lt;/del&gt;&lt;/a&gt;: continue buffering if recovery is canceled/failed&lt;/p&gt;</comment>
                            <comment id="15060085" author="mdrob" created="Wed, 16 Dec 2015 14:54:46 +0000"  >&lt;p&gt;Yonik - it looks like &lt;tt&gt;logReplayFinish&lt;/tt&gt; is never used; is that an oversight?&lt;/p&gt;

&lt;p&gt;Also, &lt;tt&gt;logReplay&lt;/tt&gt; might need to only release one permit before applying buffered updates, so that you can release again before the second apply?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12777780" name="SOLR-8372.patch" size="7194" author="yseeley@gmail.com" created="Tue, 15 Dec 2015 17:36:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pfgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>