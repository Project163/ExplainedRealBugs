<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:45:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-5661] PriorityQueue has OOM (Requested array size exceeds VM limit) issue</title>
                <link>https://issues.apache.org/jira/browse/SOLR-5661</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;It look like JDK7 change the design for max_array_length logic, it isn&apos;t max_jint, and it should be  max_jint - header_size(type).&lt;/p&gt;

&lt;p&gt;If you deliver the Integer.MaxValue to create the PriorityQueue and have enough memory, you will find it is ok in JVM6 but not work in JVM7.&lt;/p&gt;

&lt;p&gt;JVM7 will throw OOM error while do array rang checking.&lt;/p&gt;

&lt;p&gt;It should the compatible issue between JVM6 and JVM7.&lt;/p&gt;

&lt;p&gt;Maybe need protect in the code logic, throw OOM look like big issues for customer.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;JDK 7 &lt;/p&gt;</environment>
        <key id="12690997">SOLR-5661</key>
            <summary>PriorityQueue has OOM (Requested array size exceeds VM limit) issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikemccand">Michael McCandless</assignee>
                                    <reporter username="raintung.li">Raintung Li</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Jan 2014 09:33:10 +0000</created>
                <updated>Mon, 9 May 2016 18:50:34 +0000</updated>
                            <resolved>Fri, 20 Jun 2014 14:49:10 +0000</resolved>
                                    <version>4.3.1</version>
                    <version>4.4</version>
                    <version>4.5</version>
                    <version>4.5.1</version>
                    <version>4.6</version>
                                    <fixVersion>4.7</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>contrib - Solr Cell (Tika extraction)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13880869" author="mikemccand" created="Fri, 24 Jan 2014 10:16:05 +0000"  >&lt;p&gt;Hmm, how were you able to get an OOME from Solr?&lt;/p&gt;

&lt;p&gt;Lucene&apos;s IndexSearcher tries to prevent this, when you ask for Integer.MAX_VALUE as the topN hits to the search method, it drops that to the maxDoc for the reader.&lt;/p&gt;

&lt;p&gt;Still, we should fix oal.util.PriorityQueue to use ArrayUtil.MAX_ARRAY_LENGTH, not Integer.MAX_VALUE.&lt;/p&gt;</comment>
                            <comment id="13881610" author="raintung.li" created="Sat, 25 Jan 2014 02:23:18 +0000"  >&lt;p&gt;If you have multiple shard for one collection, send the query url for max integer rowid, it can easy replicate.&lt;br/&gt;
Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit&lt;br/&gt;
	at org.apache.lucene.util.PriorityQueue.&amp;lt;init&amp;gt;(PriorityQueue.java:64)&lt;br/&gt;
	at org.apache.lucene.util.PriorityQueue.&amp;lt;init&amp;gt;(PriorityQueue.java:37)&lt;br/&gt;
	at org.apache.solr.handler.component.ShardFieldSortedHitQueue.&amp;lt;init&amp;gt;(ShardDoc.java:113)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.mergeIds(QueryComponent.java:790)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.handleRegularResponses(QueryComponent.java:649)&lt;br/&gt;
	at org.apache.solr.handler.component.QueryComponent.handleResponses(QueryComponent.java:628)&lt;br/&gt;
	at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:311)&lt;br/&gt;
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)&lt;br/&gt;
	at org.apache.solr.core.SolrCore.execute(SolrCore.java:1859)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:710)&lt;br/&gt;
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:413)&lt;/p&gt;</comment>
                            <comment id="13881615" author="raintung.li" created="Sat, 25 Jan 2014 02:28:44 +0000"  >&lt;p&gt;add the protection logic.&lt;/p&gt;</comment>
                            <comment id="13881975" author="mikemccand" created="Sat, 25 Jan 2014 18:24:48 +0000"  >&lt;p&gt;I think that&apos;s a good low-level fix for Lucene; but I&apos;m not sure how to fix Solr here: somewhere it should limit the size it passes to the PQ constructor?&lt;/p&gt;</comment>
                            <comment id="13881993" author="jira-bot" created="Sat, 25 Jan 2014 19:09:29 +0000"  >&lt;p&gt;Commit 1561369 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikemccand&quot; class=&quot;user-hover&quot; rel=&quot;mikemccand&quot;&gt;mikemccand&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1561369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1561369&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5661&quot; title=&quot;PriorityQueue has OOM (Requested array size exceeds VM limit) issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5661&quot;&gt;&lt;del&gt;SOLR-5661&lt;/del&gt;&lt;/a&gt;: catch too-large priority queue&lt;/p&gt;</comment>
                            <comment id="13881994" author="jira-bot" created="Sat, 25 Jan 2014 19:11:14 +0000"  >&lt;p&gt;Commit 1561370 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikemccand&quot; class=&quot;user-hover&quot; rel=&quot;mikemccand&quot;&gt;mikemccand&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1561370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1561370&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5661&quot; title=&quot;PriorityQueue has OOM (Requested array size exceeds VM limit) issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5661&quot;&gt;&lt;del&gt;SOLR-5661&lt;/del&gt;&lt;/a&gt;: catch too-large priority queue&lt;/p&gt;</comment>
                            <comment id="13881995" author="mikemccand" created="Sat, 25 Jan 2014 19:12:05 +0000"  >&lt;p&gt;Thanks Raintung, I committed your patch (tweaked the message) to 4.7 &amp;amp; 5.0, but I&apos;ll leave this open for someone else to fix the Solr part ...&lt;/p&gt;</comment>
                            <comment id="13882338" author="shalinmangar" created="Sun, 26 Jan 2014 16:25:27 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If you have multiple shard for one collection, send the query url for max integer rowid, it can easy replicate.&lt;br/&gt;
Caused by: java.lang.OutOfMemoryError: Requested array size exceeds VM limit&lt;br/&gt;
at org.apache.lucene.util.PriorityQueue.&amp;lt;init&amp;gt;(PriorityQueue.java:64)&lt;br/&gt;
at org.apache.lucene.util.PriorityQueue.&amp;lt;init&amp;gt;(PriorityQueue.java:37)&lt;br/&gt;
at org.apache.solr.handler.component.ShardFieldSortedHitQueue.&amp;lt;init&amp;gt;(ShardDoc.java:113)&lt;br/&gt;
at org.apache.solr.handler.component.QueryComponent.mergeIds(QueryComponent.java:790)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Raintung, please correct me if I am wrong but the max integer value is being used in the constructor only because you have explicitly asked for that many rows? Solr doesn&apos;t pass such a big value to the PriorityQueue constructor by itself.&lt;/p&gt;

&lt;p&gt;Also, I think the fix committed to Lucene takes care of the problem on Solr&apos;s side as well. Even if we implement a check on Solr&apos;s side, the error message can&apos;t be any different.&lt;/p&gt;</comment>
                            <comment id="13882535" author="raintung.li" created="Mon, 27 Jan 2014 03:00:05 +0000"  >&lt;p&gt;Yes, I ask the many rows that it is max integer. The root node will collect the results from different node(shards) to combin and meger the results. For this case, will directly create the queue .&lt;/p&gt;

&lt;p&gt;Fix the Lucene side, it is enough.&lt;/p&gt;

&lt;p&gt;For solr issue, should be how to handle the biggest rowid, for biggest rowid should have the different logic. Can&apos;t direct create the biggest queue.&lt;/p&gt;</comment>
                            <comment id="13885114" author="raintung.li" created="Wed, 29 Jan 2014 07:39:39 +0000"  >&lt;p&gt;I create the other issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5674&quot; title=&quot;The rows improvement for QueryComponent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5674&quot;&gt;&lt;del&gt;SOLR-5674&lt;/del&gt;&lt;/a&gt; to distinguish track biggest rows issue.&lt;/p&gt;</comment>
                            <comment id="13970943" author="thetaphi" created="Wed, 16 Apr 2014 12:56:41 +0000"  >&lt;p&gt;Move issue to Solr 4.9.&lt;/p&gt;</comment>
                            <comment id="14038855" author="shalinmangar" created="Fri, 20 Jun 2014 14:49:10 +0000"  >&lt;p&gt;This was resolved in 4.7&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12625169" name="patch-5661.txt" size="1348" author="raintung.li" created="Sat, 25 Jan 2014 02:28:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>369740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rq5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370041</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>