<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:15:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-9310] PeerSync fails on a node restart due to IndexFingerPrint mismatch</title>
                <link>https://issues.apache.org/jira/browse/SOLR-9310</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I found that Peer Sync fails if a node restarts and documents were indexed while node was down. IndexFingerPrint check fails after recovering node applies updates. &lt;/p&gt;

&lt;p&gt;This happens only when node restarts and not if node just misses updates due reason other than it being down.&lt;/p&gt;

&lt;p&gt;Please check attached patch for the test.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12989898">SOLR-9310</key>
            <summary>PeerSync fails on a node restart due to IndexFingerPrint mismatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="praste">Pushkar Raste</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Jul 2016 18:47:44 +0000</created>
                <updated>Sat, 8 Jun 2019 15:38:15 +0000</updated>
                            <resolved>Mon, 29 Aug 2016 16:11:34 +0000</resolved>
                                                    <fixVersion>5.5.3</fixVersion>
                    <fixVersion>6.3</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15379987" author="praste" created="Fri, 15 Jul 2016 19:41:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yseeley%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yseeley@gmail.com&quot;&gt;yseeley@gmail.com&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8690&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SOLR-8690&lt;/a&gt; you mentioned that fingerprint check could have performance cost. Was performance cost you mentioned could be due to the fact that PeerSync was failing on node restart and hence Solr was falling back to do full replication ? &lt;/p&gt;

&lt;p&gt;Is PeerSync failing on node restart expected behavior&lt;/p&gt;
</comment>
                            <comment id="15379989" author="praste" created="Fri, 15 Jul 2016 19:42:37 +0000"  >&lt;p&gt;Adding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=k317h&quot; class=&quot;user-hover&quot; rel=&quot;k317h&quot;&gt;k317h&lt;/a&gt; in the loop&lt;/p&gt;</comment>
                            <comment id="15381495" author="praste" created="Sun, 17 Jul 2016 20:02:51 +0000"  >&lt;p&gt;I was able to figure a few more things about what going own. The existing &lt;tt&gt;PeerSyncTest&lt;/tt&gt; does not change core&apos;s state from &lt;tt&gt;ACTIVE&lt;/tt&gt; to recovering and hence the condition following condition (block) in &lt;tt&gt;DistributedUpdateLogProcessor.versionAdd()&lt;/tt&gt; does not get executed &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ulog.getState() != UpdateLog.State.ACTIVE &amp;amp;&amp;amp; (cmd.getFlags() &amp;amp; UpdateCommand.REPLAY) == 0) {
              &lt;span class=&quot;code-comment&quot;&gt;// we&lt;span class=&quot;code-quote&quot;&gt;&apos;re not in an active state, and &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; update isn&apos;&lt;/span&gt;t from a replay, so buffer it.
&lt;/span&gt;              cmd.setFlags(cmd.getFlags() | UpdateCommand.BUFFERING);
              ulog.add(cmd);
              &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, the test I have attached certainly goes through above mentioned code which results in updates came from log replay to be buffered. As a result of this &lt;tt&gt;compareFingerPrint()&lt;/tt&gt; check at the end of &lt;tt&gt;PeerSync.handleUpdates()&lt;/tt&gt; fails,whenever a PeerSync was triggered and core was in not ACTIVE state. I am not entirely sure why a core would in ACTIVE state if PeerSync was triggered (which happens in &lt;tt&gt;PeerSyncTest&lt;/tt&gt;). &lt;/p&gt;

&lt;p&gt;I think &lt;tt&gt;compareFingerPrint&lt;/tt&gt; check should be moved out of &lt;tt&gt;PeerSync&lt;/tt&gt; class to &lt;tt&gt;RecoveryStrategy&lt;/tt&gt; after buffered updates are applied. It might also be a good idea to move the commit after log replay as current commit seems to be resulting in a NOOP.&lt;/p&gt;</comment>
                            <comment id="15381496" author="praste" created="Sun, 17 Jul 2016 20:03:19 +0000"  >&lt;p&gt;Adding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andyetitmoves&quot; class=&quot;user-hover&quot; rel=&quot;andyetitmoves&quot;&gt;andyetitmoves&lt;/a&gt; in the loop&lt;/p&gt;</comment>
                            <comment id="15381572" author="praste" created="Sun, 17 Jul 2016 23:26:08 +0000"  >&lt;p&gt;On second thought, moving fingerprint check after log replay would not work as it can contain updates other than the node received from the leader.&lt;/p&gt;

&lt;p&gt;Only two options I could think of is &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Change the check in &lt;tt&gt;DistributedUpdateProcessor.versionAdd()&lt;/tt&gt; to handle &lt;tt&gt;PEER_SYNC&lt;/tt&gt; flag (i.e. not to buffer updates from PEER_SYNC). I am not entirely sure what other issues it might cause.&lt;/li&gt;
	&lt;li&gt;Not to do the fingerprint check for after updates are applied in PeerSync if core is not in active state.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15383277" author="praste" created="Mon, 18 Jul 2016 23:21:12 +0000"  >&lt;p&gt;Attached patch to fix the issue. Fix is not to buffer updates with &lt;tt&gt;UpdateCommand.PEER_SYNC&lt;/tt&gt; in &lt;tt&gt;DistributedUpdateProcessor.addVersion()&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15383282" author="praste" created="Mon, 18 Jul 2016 23:24:17 +0000"  >&lt;p&gt;If fix itself looks good, I will upate my Test to include all the scenarios in exiting &lt;tt&gt;PerrSyncTest&lt;/tt&gt; test&lt;/p&gt;</comment>
                            <comment id="15385265" author="praste" created="Wed, 20 Jul 2016 03:37:48 +0000"  >&lt;p&gt;Although my patch would work, if there was no active indexing going on during PeerSync, fingerprint check may fail if there was any active indexing was going on. There are too many race conditions here. &lt;/p&gt;

&lt;p&gt;In my opinion people who are continuously indexing data, should disable fingerprint check.&lt;/p&gt;</comment>
                            <comment id="15385278" author="praste" created="Wed, 20 Jul 2016 03:52:48 +0000"  >&lt;p&gt;There is another problem in &lt;tt&gt;RealTimeGetComponent.processGetVersions()&lt;/tt&gt;, since asking for a fingerprint causes a new RealTime Searcher to open, we should first get the fingerprint and then get versions from ulog&lt;/p&gt;</comment>
                            <comment id="15385283" author="praste" created="Wed, 20 Jul 2016 04:01:05 +0000"  >&lt;p&gt;Updated patch and tests for scenarios I have described&lt;/p&gt;</comment>
                            <comment id="15389298" author="noble.paul" created="Fri, 22 Jul 2016 10:41:13 +0000"  >&lt;p&gt;is there a test in the patch? I don&apos;t see it&lt;/p&gt;</comment>
                            <comment id="15389384" author="praste" created="Fri, 22 Jul 2016 12:17:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; - Thanks for pointing out. Check updated patch with the test &lt;/p&gt;</comment>
                            <comment id="15389402" author="noble.paul" created="Fri, 22 Jul 2016 12:28:14 +0000"  >&lt;p&gt;When you post a patch please post the whole patch, not pieces. This contains the test only. We can&apos;t know in which order to apply your patches. No need to delete old patches. &lt;/p&gt;</comment>
                            <comment id="15389428" author="praste" created="Fri, 22 Jul 2016 12:48:04 +0000"  >&lt;p&gt;Damn the first lapse was 4:00 am mystery thing, this second on is on me.&lt;br/&gt;
Recomputing and attaching patch. &lt;/p&gt;</comment>
                            <comment id="15390702" author="noble.paul" created="Sat, 23 Jul 2016 14:17:59 +0000"  >&lt;p&gt;I&apos;m assuming that this one is not related to this ticket. Should it not be a new ticket?&lt;/p&gt;</comment>
                            <comment id="15390758" author="praste" created="Sat, 23 Jul 2016 16:25:14 +0000"  >&lt;p&gt;I think it is related to this ticket. It is just another scenario in which PeerSync would fail on restart &quot;if you index documents while a node was down, but did not issue a commit (or not autoCommit / autoSoftCommit was triggered). &lt;/p&gt;


&lt;p&gt;Do you think there needs to be a different ticket for this scenario. If needed, I will create a sperate ticket, update my patch for this ticket not to cover that scenario and send a patch for this scenario on the new ticket&lt;/p&gt;</comment>
                            <comment id="15392232" author="noble.paul" created="Mon, 25 Jul 2016 16:31:34 +0000"  >&lt;p&gt;I guess we should compare the fingerprint before the updates are applied. I&apos;m testing another approach. Will report back&lt;/p&gt;</comment>
                            <comment id="15392262" author="praste" created="Mon, 25 Jul 2016 16:46:29 +0000"  >&lt;p&gt;That won&apos;t work as leader may have already diverged when compared to node that is just coming up&lt;/p&gt;</comment>
                            <comment id="15392301" author="noble.paul" created="Mon, 25 Jul 2016 17:04:48 +0000"  >&lt;p&gt;Well, There is a way to compute a fingerprint upto a point . So, if replica has updates  till version &apos;x&apos; and if  fingerprint of the leader matches till &apos;x&apos; wouldn&apos;t it be good enough? &lt;/p&gt;</comment>
                            <comment id="15392314" author="yseeley@gmail.com" created="Mon, 25 Jul 2016 17:13:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;The variable name is confusing. maxInHash is not a hash &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;max-in-hash... t&apos;s the maximum value included in the hash.  That name does not seem to imply that it &lt;b&gt;is&lt;/b&gt; a hash.&lt;/p&gt;</comment>
                            <comment id="15392412" author="praste" created="Mon, 25 Jul 2016 18:11:04 +0000"  >&lt;p&gt;Another question. &lt;/p&gt;

&lt;p&gt;Why update commands with flag &lt;tt&gt;REPLAY&lt;/tt&gt; are not buffered in &lt;tt&gt;DistributedUpdateProcessor.versionAdd()&lt;/tt&gt; but update commands with flag &lt;tt&gt;PEER_SYNC&lt;/tt&gt; are. &lt;/p&gt;

&lt;p&gt;Also even you ask for IndexFingerPrint of a specific version, you will end up sending &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt; while asking for versions to &lt;tt&gt;RealTimeGetComponent&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Given all different race conditions, I am not sure how much we really gain out of fingerprint check&lt;/p&gt;</comment>
                            <comment id="15393901" author="noble.paul" created="Tue, 26 Jul 2016 14:54:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=praste&quot; class=&quot;user-hover&quot; rel=&quot;praste&quot;&gt;praste&lt;/a&gt; I have tried a few approaches and only your approach (as given in the patch) seems to yield results. I&apos;ll do some more testing anyway. Your test has some commented out stuff, parallel indexing. Does it work too?&lt;/p&gt;</comment>
                            <comment id="15393961" author="praste" created="Tue, 26 Jul 2016 15:38:37 +0000"  >&lt;p&gt;Parallel indexing unfortunately does not work, it is a race condition where things could diverge on the leader during call to get index fingerprint and get versions. I think fingerprint check is mostly likely to fail if documents are being indexed while node is recovering and if a commits (or softCommits) get issued/triggered.&lt;/p&gt;</comment>
                            <comment id="15395571" author="noble.paul" created="Wed, 27 Jul 2016 12:27:33 +0000"  >&lt;p&gt;Another approach. Compute the fingerprint with the latest version in the current node and compare it with the same version in the remote node&lt;/p&gt;</comment>
                            <comment id="15395592" author="praste" created="Wed, 27 Jul 2016 12:37:19 +0000"  >&lt;p&gt;Looks like you uploaded wrong patch. It doesn&apos;t look any different than one I attached.&lt;/p&gt;</comment>
                            <comment id="15395622" author="noble.paul" created="Wed, 27 Jul 2016 12:56:32 +0000"  >&lt;p&gt;sorry , wrong file&lt;/p&gt;</comment>
                            <comment id="15395796" author="praste" created="Wed, 27 Jul 2016 14:54:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rideordie482%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;rideordie482@gmail.com&quot;&gt;rideordie482@gmail.com&lt;/a&gt;, I will take a look at it tonight and run my origin test that exposed the issue and will let you know if it works as expected. &lt;/p&gt;

&lt;p&gt;Does changing logic in the {[DistributedUpdateProcessor}} has any downside to it? I am wondering why &lt;tt&gt;REPLAY&lt;/tt&gt; flag is treated differently than &lt;tt&gt;PEER_SYNC&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15396439" author="praste" created="Wed, 27 Jul 2016 21:40:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; -  Patch looks good. Can you please provide info about my question for &lt;tt&gt;PEER_SYNC&lt;/tt&gt; vs &lt;tt&gt;REPLAY&lt;/tt&gt; flag. &lt;/p&gt;

&lt;p&gt;are there any downsides of the way I was doing it?&lt;/p&gt;

&lt;p&gt;Only problem I could think of your approach is we are requesting updates twice, which in my case is asking for tens of thousands of updates, which could be lot of chatter of the wire.&lt;/p&gt;</comment>
                            <comment id="15396804" author="shalinmangar" created="Thu, 28 Jul 2016 02:31:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;am wondering why REPLAY flag is treated differently than PEER_SYNC&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;REPLAY updates are not written to update log because that would be redundant. The update log itself is the source of the updates being replayed. PEER_SYNC updates come from a different node and they certainly weren&apos;t present in the local update log already (or else we would not have requested them). This is why they must be written to the tlog.&lt;/p&gt;</comment>
                            <comment id="15397793" author="praste" created="Thu, 28 Jul 2016 16:42:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; - Seems like with your patch we are matching fingerprint upto the version before node went down, whereas intent is to compare fingerprint after apply updates from the leader.  I modified &lt;tt&gt;PeerSync.handleUpdates()&lt;/tt&gt; to not apply updates at all and fingerprint check still passed. Here is excerpt of change I am talking about &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; handleUpdates(ShardResponse srsp) {
    &lt;span class=&quot;code-comment&quot;&gt;// we retrieved the last N updates from the replica
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; test = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    
    List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; updates = (List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;)srsp.getSolrResponse().getResponse().get(&lt;span class=&quot;code-quote&quot;&gt;&quot;updates&quot;&lt;/span&gt;);

    SyncShardRequest sreq = (SyncShardRequest) srsp.getShardRequest();
    
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(test) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; compareFingerprint(sreq);
    }
   ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am not sure if there is a way to write a test for my observation about fingerprint check happening on state before updates were applied and not after were applied.&lt;/p&gt;

&lt;p&gt;This probably defies intent of comparing fingerprint after applying updates. Why not check it before asking for updates in the first place then.  &lt;/p&gt;
</comment>
                            <comment id="15397850" author="anshumg" created="Thu, 28 Jul 2016 17:21:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; just wanted to check on the current state here. Do you suggest holding back the 5.5.3 release for this ?&lt;/p&gt;

&lt;p&gt;Please consider the complexity as well as how close we are to the solution at this point.&lt;/p&gt;</comment>
                            <comment id="15398806" author="noble.paul" created="Fri, 29 Jul 2016 06:32:21 +0000"  >&lt;p&gt;it depends. if there is no urgency, let&apos;s hold back 5.5.3. Else there can always be a 5.5.4&lt;/p&gt;</comment>
                            <comment id="15398816" author="noble.paul" created="Fri, 29 Jul 2016 06:37:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;This probably defies intent of comparing fingerprint after applying updates. Why not check it before asking for updates in the first place then.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Isn&apos;t it enough if we compare the fingerprint up to the point when it was down? After that, we are going to apply the updates from the  other replica (so fingerprint of the delta will be same anyway. If we can get a consensus on this  approach, I guess we should implement this solution &lt;/p&gt;
</comment>
                            <comment id="15399194" author="praste" created="Fri, 29 Jul 2016 11:51:29 +0000"  >&lt;p&gt;What was the original reason for adding fingerprint check.  Unless that is clear we are not solving the right problem here. I couldn&apos;t find a test case that led to adding fingerprint checl.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If intent is to check state before node down, for clarity. check should be made before applying updates.&lt;/li&gt;
	&lt;li&gt;Let&apos;s also make read and sort update log of recovering node only once.&lt;/li&gt;
	&lt;li&gt;I would also uncomment parallel indexing logic in the &lt;tt&gt;PeerSyncReplicationTest&lt;/tt&gt;, as this won&apos;t break fingerprint check, with your patch.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15399217" author="noble.paul" created="Fri, 29 Jul 2016 12:07:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;What was the original reason for adding fingerprint check?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Previously we were just comparing the latest versions. We had no way to know if some intermediate versions were missing or not. In most cases, that would be correct. but if there was an out of order update, then we would assume we have everything and go ahead with downloading versions after our latest update. Fingerprints compute the hash of all versions. So , we will be able to avoid such errors&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Let&apos;s also make read and sort update log of recovering node only once.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sure. I&apos;m aware of this optimization. It was a rudimentary patch to ensure that the approach is valid &lt;/p&gt;</comment>
                            <comment id="15399290" author="noble.paul" created="Fri, 29 Jul 2016 12:56:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Here is excerpt of change I am talking about&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Somehow I could not make that change to work. Can u post your patch&lt;/p&gt;</comment>
                            <comment id="15399429" author="praste" created="Fri, 29 Jul 2016 14:44:49 +0000"  >&lt;p&gt;This an experimental patch, just to test what happens if PeerSync falls on its face. &lt;/p&gt;

&lt;p&gt;I could not think of an elegant way to test it, but it just proves that we if compare index fingerprint only before applying updates, it would not validate if PeerSync itself is successful. &lt;/p&gt;

&lt;p&gt;IMHO we should know that after recovery nodes are in sync irrespective of whether they were in sync at some point before failure or not. &lt;/p&gt;</comment>
                            <comment id="15399450" author="praste" created="Fri, 29 Jul 2016 14:56:51 +0000"  >&lt;p&gt;Also looking at Yonik&apos;s comments &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8586?focusedCommentId=15122263&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15122263&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-8586?focusedCommentId=15122263&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15122263&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8586?focusedCommentId=15126352&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15126352&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-8586?focusedCommentId=15126352&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15126352&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It seems to me that we should make sure that nodes are in sync after applying updates. &lt;/p&gt;

&lt;p&gt;I had tagged Yonik and Mark in my comments but haven&apos;t heard anything from them yet. May be we should reach out to them to ask what&apos;s the intention of fingerprint check.&lt;/p&gt;</comment>
                            <comment id="15401563" author="noble.paul" created="Mon, 1 Aug 2016 05:54:02 +0000"  >&lt;p&gt;It&apos;s hard to have the fingerprint match after applying the updates. The system as exists today does not work in case of  restarting node or LIR. So , it&apos;s already broken. I shall wait for some time for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt; to revert on this. &lt;/p&gt;</comment>
                            <comment id="15405342" author="markrmiller@gmail.com" created="Wed, 3 Aug 2016 05:34:47 +0000"  >&lt;p&gt;Yeah, it was better before. Except for the fact that it didn&apos;t work. &lt;/p&gt;</comment>
                            <comment id="15408141" author="noble.paul" created="Thu, 4 Aug 2016 17:07:03 +0000"  >&lt;p&gt;I Plan to commit this soon if there are no other comments&lt;/p&gt;</comment>
                            <comment id="15408155" author="praste" created="Thu, 4 Aug 2016 17:14:41 +0000"  >&lt;p&gt;Can this wait for Yonik&apos;s comment. Je fact his implementation used MAX&lt;br/&gt;
VERSION and that check was added at the end of handleUpdates makes me think&lt;br/&gt;
intention was to do the check later and not before starting PeerSync&lt;/p&gt;
</comment>
                            <comment id="15417480" author="yseeley@gmail.com" created="Thu, 11 Aug 2016 15:56:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;intention was to do the check later and not before starting PeerSync&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that was the intention.  The approach was deliberately conservative : in cases where peersync formerly thought it had gotten into sync, verify that with a fingerprint.&lt;/p&gt;

&lt;p&gt;On a quick skim through, it&apos;s not clear what people think the bug is... but I&apos;ll try a more thorough read-through next.&lt;/p&gt;</comment>
                            <comment id="15417489" author="noble.paul" created="Thu, 11 Aug 2016 16:00:09 +0000"  >&lt;p&gt;The testcase fails without the fix. That can help you see the bug easily&lt;/p&gt;</comment>
                            <comment id="15417545" author="yseeley@gmail.com" created="Thu, 11 Aug 2016 16:41:00 +0000"  >&lt;p&gt;You were ready to commit a fix though... so what was exactly is the bug, what caused it, and how does the patch fix it?&lt;/p&gt;</comment>
                            <comment id="15417558" author="praste" created="Thu, 11 Aug 2016 16:45:26 +0000"  >&lt;p&gt;Here is short description of bug&lt;br/&gt;
1. A node goes down in solr cloud &lt;br/&gt;
2. More documents and added (and may be a commit issued)&lt;br/&gt;
3. Node that was down comes up. &lt;br/&gt;
4. Node gets fingerprint from the leader and version too &lt;br/&gt;
5. Node calculates diff for missing versions and  requests updates for the same  &lt;br/&gt;
6. Node applies updates and then checks it&apos;s fingerprint against the leader&apos;s fingerprint&lt;br/&gt;
7. Check in #6 always fail, fingerprint of recovering node does not reflect updates applied during PeerSync&lt;/p&gt;


&lt;p&gt;There are two proposed fixes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;My fix is not to buffer updates commands that have PEER_SYNC flag on it.&lt;br/&gt;
I think, hesitation about my patch, we don&apos;t know what other side effect it may have. (All test cases are passing, but we might not have a test case where my fix would break things)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Noble&apos;s fix to check fingerprint before we start applying updates.&lt;br/&gt;
In my opinion this no really fixing original issue, what really matters is if fingerprint matches after applying updates during PeerSync.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and we don&apos;t know which approach in right. May be there 3rd better approach&lt;/p&gt;</comment>
                            <comment id="15417909" author="yseeley@gmail.com" created="Thu, 11 Aug 2016 20:45:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;My fix is not to buffer updates commands that have PEER_SYNC flag on it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, I see... I had no idea that PEER_SYNC updates were buffered (I don&apos;t recall that being intentional at least).&lt;br/&gt;
That would prevent updates obtained from the leader and applied to the replica from being included in the fingerprint on the replica after the peersync.&lt;/p&gt;
</comment>
                            <comment id="15418279" author="noble.paul" created="Fri, 12 Aug 2016 02:50:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think, hesitation about my patch, we don&apos;t know what other side effect it may have&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We know the side effect. If this replica becomes the leader and some other node tries to peersync from this replica, that node will not get those updates. That breaks the functionality&lt;/p&gt;</comment>
                            <comment id="15418297" author="praste" created="Fri, 12 Aug 2016 03:17:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt; -  I will write a test for the scenario you mentioned&lt;/p&gt;</comment>
                            <comment id="15418720" author="praste" created="Fri, 12 Aug 2016 11:42:41 +0000"  >&lt;p&gt;Hesitation about your patch is it checks index fingerprint before applying&lt;br/&gt;
updates. Which Yonik agrees is not right.&lt;/p&gt;
</comment>
                            <comment id="15418843" author="noble.paul" created="Fri, 12 Aug 2016 13:43:48 +0000"  >&lt;p&gt;If there is a way to get the fingerprint after applying the updates, it will be good. &lt;/p&gt;</comment>
                            <comment id="15418915" author="noble.paul" created="Fri, 12 Aug 2016 14:31:45 +0000"  >&lt;p&gt;Do you see a potential problem if fingerprint is compared before applying updates&lt;/p&gt;</comment>
                            <comment id="15418920" author="praste" created="Fri, 12 Aug 2016 14:34:03 +0000"  >&lt;p&gt;If something goes wrong while applying updates, how can you assure that replica is in sync?&lt;/p&gt;</comment>
                            <comment id="15418979" author="noble.paul" created="Fri, 12 Aug 2016 15:15:28 +0000"  >&lt;p&gt;Of something goes wrong peersync fails&lt;/p&gt;</comment>
                            <comment id="15419478" author="praste" created="Fri, 12 Aug 2016 21:03:48 +0000"  >&lt;p&gt;Here is my patch with update test for scenario Noble is concerned about and a small diagram depicting what is going on in the test.&lt;/p&gt;

&lt;p&gt;Test for my patch still passes.&lt;/p&gt;

&lt;p&gt;If it looks good, I will take stab at fixing PeerSync failure (due index fingerprint) during active indexing, however, due to race conditions, it might not work well. &lt;/p&gt;

&lt;p&gt;Can we setup a call to discuss this ?&lt;/p&gt;</comment>
                            <comment id="15428248" author="praste" created="Fri, 19 Aug 2016 14:16:52 +0000"  >&lt;p&gt;Final patch. Here are highlights about the changes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Don&apos;t buffer updates with `PEER_SYNC` flag on it, otherwise those would not be included in the fingerprint and PeerSync would always fail on fingerprint check&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;PeerSync should care for fingerprint only for the updates it is applying. Otherwise if documents are being indexed while a node is PeerSync. Node recovering would have some of the documents in a buffer already. Node recovering would ask for updates for those documents. Leader&apos;s fingerprint will however reflect all the documents but recovering node&apos;s fingerprint would not consider documents in the buffer.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This also applies for missed updates &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Cache fingerprint in `SolrIndexSearcher` judiciously&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15429597" author="noble.paul" created="Sun, 21 Aug 2016 05:39:25 +0000"  >&lt;p&gt;Use the maxVersion in fingerprint before returning versions&lt;/p&gt;</comment>
                            <comment id="15429773" author="praste" created="Sun, 21 Aug 2016 15:24:59 +0000"  >&lt;p&gt;Since any race condition would be handled by limiting fingerprint upto the maxVersion will get in `getUpdates`, I could not think of compelling reason to uset in `getVersions()`. &lt;/p&gt;

&lt;p&gt; It probably won&apos;t hurt to use `maxVersion` before returning versions&lt;/p&gt;</comment>
                            <comment id="15430139" author="noble.paul" created="Mon, 22 Aug 2016 06:42:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;It probably won&apos;t hurt to use `maxVersion` before returning versions&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right. It won&apos;t hurt peersync because getUpdates take care of it. But , for correctness of the API the the following should be true &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;fingerPrint.maxEncounteredVersion== max(versions)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15430210" author="jira-bot" created="Mon, 22 Aug 2016 07:02:28 +0000"  >&lt;p&gt;Commit c2e769450fac21a8f98e818b4783d7dca14cffb8 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c2e7694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c2e7694&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: PeerSync fails on a node restart due to IndexFingerPrint mismatch&lt;/p&gt;</comment>
                            <comment id="15430294" author="jira-bot" created="Mon, 22 Aug 2016 08:28:15 +0000"  >&lt;p&gt;Commit 80f916780798162a5c68875fed10ef1ff132c8f7 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=80f9167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=80f9167&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: PeerSync fails on a node restart due to IndexFingerPrint mismatch, precommit errors fixed&lt;/p&gt;</comment>
                            <comment id="15430303" author="jira-bot" created="Mon, 22 Aug 2016 08:35:25 +0000"  >&lt;p&gt;Commit 2f73129edae7541d5cf45c2085d9ca40ff048b9b in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2f73129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2f73129&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: PeerSync fails on a node restart due to IndexFingerPrint mismatch&lt;/p&gt;</comment>
                            <comment id="15430304" author="jira-bot" created="Mon, 22 Aug 2016 08:35:28 +0000"  >&lt;p&gt;Commit c37c22dbb0cd6de5804b1d72c4e2e86c1bba7ef2 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c37c22d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c37c22d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: PeerSync fails on a node restart due to IndexFingerPrint mismatch&lt;/p&gt;</comment>
                            <comment id="15430880" author="yseeley@gmail.com" created="Mon, 22 Aug 2016 14:38:05 +0000"  >&lt;p&gt;Reopening... the cache that was added in SolrIndexSearcher is not thread safe and is checked outside synchronization.&lt;/p&gt;

&lt;p&gt;Also, about this comment:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-comment&quot;&gt;// TODO what happens &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; updates came out of order, would cached fingerprint still be valid?
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// May be caching fingerprint may lead more problems&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The index fingerprint only depends on what documents are in the index, not on their order in the index.  And since the cache is on SolrIndexSearcher (which has a static view of the index), it will be impossible for fingerprint to change for a given max version.  The comment should probably just be removed to avoid confusion.&lt;/p&gt;

&lt;p&gt;In changes on UpdateLog:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(ptr.version &amp;gt; maxVersion) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;versions can be negative for deletes, so we should really be checking against the absolute value of ptr.version&lt;/p&gt;</comment>
                            <comment id="15430898" author="k317h" created="Mon, 22 Aug 2016 14:45:43 +0000"  >&lt;p&gt;What is the need for the cache? I seems like there would only ever be a cache hit if if there is no active indexing. It seems like the added complexity is not worth the potential small performance boost.  &lt;/p&gt;</comment>
                            <comment id="15430922" author="yseeley@gmail.com" created="Mon, 22 Aug 2016 14:56:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;What is the need for the cache?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Multiple replicas syncing against each other (or all replicas syncing against a new leader...)  I &lt;b&gt;think&lt;/b&gt; it&apos;s part of the protocol to elect a new leader (because when one leader goes down, we don&apos;t know which replicas may have received the last update(s) and which replicas did not...)  In such a scenario, there is no active indexing because no new leader yet.&lt;br/&gt;
Some people run with large numbers of replicas (10 or 20), and hence the difference could well be large.&lt;/p&gt;</comment>
                            <comment id="15431013" author="noble.paul" created="Mon, 22 Aug 2016 15:34:03 +0000"  >&lt;p&gt;Addressing the thread safety issue and compare absolute values of versions in UpdateLog&lt;/p&gt;</comment>
                            <comment id="15431250" author="yseeley@gmail.com" created="Mon, 22 Aug 2016 17:37:58 +0000"  >&lt;p&gt;minor: since there is a cache now, we could sync on that and get rid of fingerprintLock&lt;/p&gt;</comment>
                            <comment id="15431255" author="noble.paul" created="Mon, 22 Aug 2016 17:40:47 +0000"  >&lt;p&gt;&#128077;&lt;/p&gt;</comment>
                            <comment id="15431280" author="jira-bot" created="Mon, 22 Aug 2016 17:48:23 +0000"  >&lt;p&gt;Commit 37ae065591772172dbd44cde4c952d7b56fc8803 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=37ae065&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=37ae065&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: fixing concurrency issue and taking care of negative versions&lt;/p&gt;</comment>
                            <comment id="15431306" author="dsmiley" created="Mon, 22 Aug 2016 18:00:19 +0000"  >&lt;p&gt;I see the double-check locking pattern there... I believe ConcurrentHashMap.computeIfAbsent would be perfect in this case?&lt;/p&gt;</comment>
                            <comment id="15431312" author="praste" created="Mon, 22 Aug 2016 18:05:19 +0000"  >&lt;p&gt;I tried that, but since `IndexFingerprint.getFingerprint()` can throw an exception, implementation using `computeIfAbsent` looked too ugly to use it.&lt;/p&gt;</comment>
                            <comment id="15431393" author="jira-bot" created="Mon, 22 Aug 2016 18:36:34 +0000"  >&lt;p&gt;Commit 0bdbbbfd52a95e83ce3827161852dbccdd618f5b in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0bdbbbf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0bdbbbf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: fixing concurrency issue and taking care of negative versions&lt;/p&gt;</comment>
                            <comment id="15432331" author="noble.paul" created="Tue, 23 Aug 2016 07:58:52 +0000"  >&lt;p&gt;ported to 5.5.x&lt;/p&gt;</comment>
                            <comment id="15433253" author="jira-bot" created="Tue, 23 Aug 2016 17:30:45 +0000"  >&lt;p&gt;Commit c6c3166bf5d28922bb3639ac9da3912aab85f520 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c6c3166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c6c3166&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: addressing the test failures in jenkins&lt;/p&gt;</comment>
                            <comment id="15433267" author="jira-bot" created="Tue, 23 Aug 2016 17:39:26 +0000"  >&lt;p&gt;Commit d9c4c5282a46bc5d3d1a6e4b1586083dc8970837 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d9c4c52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d9c4c52&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: addressing the test failures in jenkins&lt;/p&gt;</comment>
                            <comment id="15437214" author="yseeley@gmail.com" created="Thu, 25 Aug 2016 16:57:18 +0000"  >&lt;p&gt;Ah, a piece of the puzzle: we didn&apos;t always buffer before peersync... &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8407&quot; title=&quot;We log an error during normal recovery PeerSync now.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8407&quot;&gt;&lt;del&gt;SOLR-8407&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15437399" author="praste" created="Thu, 25 Aug 2016 18:26:33 +0000"  >&lt;p&gt;Thanks Yonik. I don&apos;t know context for &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8407&quot; title=&quot;We log an error during normal recovery PeerSync now.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8407&quot;&gt;&lt;del&gt;SOLR-8407&lt;/del&gt;&lt;/a&gt;. Should we have not buffered updates to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8407&quot; title=&quot;We log an error during normal recovery PeerSync now.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8407&quot;&gt;&lt;del&gt;SOLR-8407&lt;/del&gt;&lt;/a&gt;, or patch for this (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;) issue would break &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8407&quot; title=&quot;We log an error during normal recovery PeerSync now.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8407&quot;&gt;&lt;del&gt;SOLR-8407&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="15437446" author="yseeley@gmail.com" created="Thu, 25 Aug 2016 18:49:11 +0000"  >&lt;p&gt;Mark pointed me to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8085&quot; title=&quot;Fix a variety of issues that can result in replicas getting out of sync.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8085&quot;&gt;&lt;del&gt;SOLR-8085&lt;/del&gt;&lt;/a&gt; for where/when we started buffering before peersync.&lt;br/&gt;
I think it probably had to do with the following scenario:&lt;br/&gt;
1) replica that is behind comes up and starts peersync&lt;br/&gt;
2) replica receives a bunch of updates forwarded from leader (and indexes them and adds them to tlog as normal)&lt;br/&gt;
3) replica goes down&lt;br/&gt;
4) replica comes up, looks at last 100 versions in it&apos;s transaction log, does peersync and concludes that it&apos;s up-to-date&lt;/p&gt;

&lt;p&gt;Putting the udpate log in buffering mode adds a FLAG_GAP to all the records int he log, which signals that there is a gap somewhere and hence one can&apos;t conclude that if the last 100 updates are good that everything else is good.  This is all before fingerprinting of course.&lt;/p&gt;</comment>
                            <comment id="15452488" author="jira-bot" created="Wed, 31 Aug 2016 15:09:42 +0000"  >&lt;p&gt;Commit 8655b97b27d8da470c8235683af11a8b85a2b10f in lucene-solr&apos;s branch refs/heads/branch_5_5 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8655b97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8655b97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: java 7 compile errors&lt;/p&gt;</comment>
                            <comment id="15452558" author="jira-bot" created="Wed, 31 Aug 2016 15:38:15 +0000"  >&lt;p&gt;Commit 4f6e2546739e5352738f786aaddfb6f08b1549aa in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4f6e254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4f6e254&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: PeerSync fails on a node restart due to IndexFingerPrint mismatch&lt;/p&gt;</comment>
                            <comment id="15452566" author="jira-bot" created="Wed, 31 Aug 2016 15:41:07 +0000"  >&lt;p&gt;Commit afcc8c05dd2c13a0cb0165674931a99decf98373 in lucene-solr&apos;s branch refs/heads/branch_5x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=afcc8c0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=afcc8c0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-9310&quot; title=&quot;PeerSync fails on a node restart due to IndexFingerPrint mismatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-9310&quot;&gt;&lt;del&gt;SOLR-9310&lt;/del&gt;&lt;/a&gt;: PeerSync fails on a node restart due to IndexFingerPrint mismatch&lt;/p&gt;</comment>
                            <comment id="15452802" author="anshumg" created="Wed, 31 Aug 2016 17:19:42 +0000"  >&lt;p&gt;I&apos;ve manually checked that these changes are in branch_5_5, but there&apos;s no log/comment here in the JIRA, other than the single entry about fixing Java7 compile errors. Am I missing something here?&lt;/p&gt;</comment>
                            <comment id="15452810" author="noble.paul" created="Wed, 31 Aug 2016 17:22:48 +0000"  >&lt;p&gt;Actually, the commit did not make it to JIRA. May be the bot was down or something.&lt;/p&gt;</comment>
                            <comment id="15497044" author="yseeley@gmail.com" created="Fri, 16 Sep 2016 18:36:06 +0000"  >&lt;p&gt;I looped HdfsChaosMoneyNothingIsSafeTest after this change, and I occasionally started getting some shards &quot;non consistent&quot; failures again.&lt;/p&gt;</comment>
                            <comment id="15497075" author="praste" created="Fri, 16 Sep 2016 18:46:22 +0000"  >&lt;p&gt;Is this happening when active indxing is going on when node is in recovery. That is only scenario I could think of fingerprint might mismatch (but I don&apos;t really doubt that), as we compare fingerprint only upto the max version that we request during peersync. &lt;/p&gt;

&lt;p&gt;Also, earlier, the only reason nodes were able to sync was nodes were doing snap pull every single time. &lt;/p&gt;

&lt;p&gt;Does this fail only with HDFS or in non-hdfs scenario as well. If this breaks only with HDFS, may be we can add option to recover using replication only until the fingerprint implementation stabilizes. &lt;/p&gt;</comment>
                            <comment id="15497183" author="yseeley@gmail.com" created="Fri, 16 Sep 2016 19:39:27 +0000"  >&lt;p&gt;I only tested with the HDFS variant quickly... it tends to fail a little more often because of greater timing variability I think.&lt;br/&gt;
We should also test the &quot;safe-leader&quot; test... this may be just an issue when leaders are killed.&lt;/p&gt;
</comment>
                            <comment id="15507745" author="shalinmangar" created="Tue, 20 Sep 2016 20:45:29 +0000"  >&lt;p&gt;This wasn&apos;t backported to 6.2.1 so removing the fix version 6.2.1&lt;/p&gt;</comment>
                            <comment id="15520083" author="yseeley@gmail.com" created="Sun, 25 Sep 2016 03:27:22 +0000"  >&lt;p&gt;I just happened to notice that PeerSyncReplicationTest failed in jenkins:&lt;br/&gt;
&lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-6.x-Linux/1796/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-6.x-Linux/1796/&lt;/a&gt;&lt;br/&gt;
Not sure how often it&apos;s happened though.&lt;/p&gt;</comment>
                            <comment id="15520747" author="praste" created="Sun, 25 Sep 2016 12:25:44 +0000"  >&lt;p&gt;I went through logs at &lt;a href=&quot;https://jenkins.thetaphi.de/job/Lucene-Solr-6.x-MacOSX/429/consoleFull&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins.thetaphi.de/job/Lucene-Solr-6.x-MacOSX/429/consoleFull&lt;/a&gt; &lt;br/&gt;
If PeerSync was unsuccessful I would expect to see a line like &lt;br/&gt;
&lt;tt&gt;o.a.s.u.PeerSync Fingerprint comparison: -1&lt;/tt&gt; &lt;/p&gt;

&lt;p&gt;However, I don&apos;t see such line. I could think of two scenarios that could break the test &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;data directory could get deleted while a node is brought down, since data directory is created in &lt;tt&gt;temp&lt;/tt&gt;. Upon restart replica would have no frame of reference and will have to fall back on replication.&lt;/li&gt;
	&lt;li&gt;we need a better check than relying number of requests made to &lt;tt&gt;ReplicationHandler&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15650197" author="shalinmangar" created="Wed, 9 Nov 2016 08:36:53 +0000"  >&lt;p&gt;Closing after 6.3.0 release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13005475">SOLR-9524</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12823536" name="PeerSync_3Node_Setup.jpg" size="187199" author="praste" created="Fri, 12 Aug 2016 21:03:48 +0000"/>
                            <attachment id="12820975" name="PeerSync_Experiment.patch" size="2628" author="praste" created="Fri, 29 Jul 2016 14:44:49 +0000"/>
                            <attachment id="12824873" name="SOLR-9310.patch" size="2538" author="noble.paul" created="Mon, 22 Aug 2016 15:33:18 +0000"/>
                            <attachment id="12824720" name="SOLR-9310.patch" size="25312" author="noble.paul" created="Sun, 21 Aug 2016 05:39:25 +0000"/>
                            <attachment id="12821265" name="SOLR-9310.patch" size="13954" author="noble.paul" created="Mon, 1 Aug 2016 05:54:02 +0000"/>
                            <attachment id="12820440" name="SOLR-9310.patch" size="13268" author="noble.paul" created="Wed, 27 Jul 2016 12:56:32 +0000"/>
                            <attachment id="12819615" name="SOLR-9310.patch" size="13058" author="praste" created="Fri, 22 Jul 2016 12:48:52 +0000"/>
                            <attachment id="12819602" name="SOLR-9310.patch" size="9988" author="praste" created="Fri, 22 Jul 2016 12:16:01 +0000"/>
                            <attachment id="12823537" name="SOLR-9310_3ReplicaTest.patch" size="16350" author="praste" created="Fri, 12 Aug 2016 21:03:48 +0000"/>
                            <attachment id="12825007" name="SOLR-9310_5x.patch" size="26779" author="noble.paul" created="Tue, 23 Aug 2016 07:58:52 +0000"/>
                            <attachment id="12824570" name="SOLR-9310_final.patch" size="24195" author="praste" created="Fri, 19 Aug 2016 14:16:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i311vj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>