<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:19:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10121] BlockCache corruption with high concurrency</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10121</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Improving the tests of the BlockCache in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10116&quot; title=&quot;BlockCache test and documentation improvement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10116&quot;&gt;&lt;del&gt;SOLR-10116&lt;/del&gt;&lt;/a&gt; uncovered a corruption bug (either that or the test is flawed... TBD).&lt;/p&gt;

&lt;p&gt;The failing test is TestBlockCache.testBlockCacheConcurrent()&lt;/p&gt;</description>
                <environment></environment>
        <key id="13042123">SOLR-10121</key>
            <summary>BlockCache corruption with high concurrency</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                    <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Feb 2017 16:59:46 +0000</created>
                <updated>Sat, 8 Jun 2019 15:29:11 +0000</updated>
                            <resolved>Tue, 21 Feb 2017 23:59:39 +0000</resolved>
                                    <version>4.4</version>
                                    <fixVersion>6.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15863699" author="yseeley@gmail.com" created="Mon, 13 Feb 2017 13:48:02 +0000"  >&lt;p&gt;I reviewed the pertinent BlockCache and haven&apos;t seen any thread safety issues yet. Looking at the history of BlockCache, I reverted to right before &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7355&quot; title=&quot;Java 8: ConcurrentLinkedHashMap -&amp;gt; Caffeine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7355&quot;&gt;&lt;del&gt;SOLR-7355&lt;/del&gt;&lt;/a&gt; was applied, and the issues went away.  So it looks like it could be a thread safety or usage issue with Caffeine?&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.manes&quot; class=&quot;user-hover&quot; rel=&quot;ben.manes&quot;&gt;ben.manes&lt;/a&gt;, does putting a key/value in Caffeine constitute safe publication to a different thread (as is the case with ConcurrentHashMap for example)?&lt;/p&gt;

&lt;p&gt;Note that this doesn&apos;t necessarily mean something is wrong with Caffeine... it may be that the increased concurrency or other allowable differences in behavior uncover a bug in BlockCache as well.&lt;/p&gt;</comment>
                            <comment id="15863924" author="ben.manes" created="Mon, 13 Feb 2017 16:15:39 +0000"  >&lt;p&gt;Yes, a write should constitute a publication. Caffeine decorates a ConcurrentHashMap but does bypass it at times. By default eviction is asynchronous by delegating to fjp commonPool, but can be configured to use the caller instead. That might be useful for testing.&lt;/p&gt;

&lt;p&gt;Solr uses an old version of Caffeine. A patch was reviewed and approved, but needs someone to merge it in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8241&quot; title=&quot;Evaluate W-TinyLfu cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8241&quot;&gt;&lt;del&gt;SOLR-8241&lt;/del&gt;&lt;/a&gt;. I&apos;m not aware of a visibility bug in any release, but staying current would be helpful as I have fixed bugs since that version.&lt;/p&gt;</comment>
                            <comment id="15864343" author="yseeley@gmail.com" created="Mon, 13 Feb 2017 20:13:54 +0000"  >&lt;p&gt;Hmmm, so on further review of BlockCache.java, I think I&apos;ve found 2 concurrency issues.&lt;br/&gt;
Unfortunately, fixing those issues does not get my test to pass.&lt;br/&gt;
Another &quot;issue&quot; is that my test did pass pre-Caffeine, which means the test is not good enough at sussing out issues (since the BlockCache bugs I identified should not depend on the underlying map implementation).&lt;/p&gt;</comment>
                            <comment id="15864352" author="ben.manes" created="Mon, 13 Feb 2017 20:20:19 +0000"  >&lt;p&gt;Can you try a local hack of changing Caffeine versions and, if it fails, try reverting back to CLHM? Both should be easy changes that could help us isolate it.&lt;/p&gt;

&lt;p&gt;Also note that CLHM ran the eviction listener on the same thread, whereas Caffeine delegates that to the executor. If there is a race due to that, you could use `executor(Runnable::run)` in the builder.&lt;/p&gt;</comment>
                            <comment id="15864590" author="yseeley@gmail.com" created="Mon, 13 Feb 2017 22:28:30 +0000"  >&lt;p&gt;Thanks for the extra info - running the eviction listener in a separate thread shouldn&apos;t matter for correctness, but may work better the way this BlockCache code is written anyway.&lt;/p&gt;

&lt;p&gt;I went back and re-tested right before the Caffeine switch (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7355&quot; title=&quot;Java 8: ConcurrentLinkedHashMap -&amp;gt; Caffeine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7355&quot;&gt;&lt;del&gt;SOLR-7355&lt;/del&gt;&lt;/a&gt;) and was able to reproduce some fails by bumping up the concurrency.&lt;/p&gt;</comment>
                            <comment id="15866249" author="yseeley@gmail.com" created="Tue, 14 Feb 2017 17:55:13 +0000"  >&lt;p&gt;Here&apos;s a draft patch to fix the currently identified concurrency issues in BlockCache.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fetch() checked isRemoved() before the read from the block, but the block could be reused after that point (i.e. before or during the read), causing the wrong data to be returned.&lt;/li&gt;
	&lt;li&gt;store() allowed existing blocks to be updated, but resulted in corruption.  The reason is that if one retrieves an existing block, one does not know when that block may stop being used for one key and start being used for another key.  To safely do this, one would require write locks.  Since we don&apos;t need the functionality, I simply failed the case of trying to cache/update a block already in the cache.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15867962" author="jira-bot" created="Wed, 15 Feb 2017 14:57:05 +0000"  >&lt;p&gt;Commit b71a667d74dfabeaad9584372bded80b0c609add in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b71a667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b71a667&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10121&quot; title=&quot;BlockCache corruption with high concurrency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10121&quot;&gt;&lt;del&gt;SOLR-10121&lt;/del&gt;&lt;/a&gt;: fix race conditions in BlockCache.fetch and BlockCache.store&lt;/p&gt;</comment>
                            <comment id="15868008" author="jira-bot" created="Wed, 15 Feb 2017 15:19:18 +0000"  >&lt;p&gt;Commit 65e2d2add68a557b1e628039c328f9346df282f9 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=65e2d2a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=65e2d2a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10121&quot; title=&quot;BlockCache corruption with high concurrency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10121&quot;&gt;&lt;del&gt;SOLR-10121&lt;/del&gt;&lt;/a&gt;: fix race conditions in BlockCache.fetch and BlockCache.store&lt;/p&gt;</comment>
                            <comment id="15868088" author="yseeley@gmail.com" created="Wed, 15 Feb 2017 16:00:44 +0000"  >&lt;p&gt;I&apos;m splitting off the Caffeine issues to &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10141&quot; title=&quot;Caffeine cache causes BlockCache corruption &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10141&quot;&gt;&lt;del&gt;SOLR-10141&lt;/del&gt;&lt;/a&gt; since the BlockCache race conditions that have existed since inception and will need to be handled/backported separately.&lt;/p&gt;</comment>
                            <comment id="15877050" author="jira-bot" created="Tue, 21 Feb 2017 23:56:45 +0000"  >&lt;p&gt;Commit cf1cba66f49c551cddbc6053565c30bf3a8b23bb in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cf1cba6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cf1cba6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10121&quot; title=&quot;BlockCache corruption with high concurrency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10121&quot;&gt;&lt;del&gt;SOLR-10121&lt;/del&gt;&lt;/a&gt;: enable BlockCacheTest.testBlockCacheConcurrent that now passes&lt;/p&gt;</comment>
                            <comment id="15877051" author="jira-bot" created="Tue, 21 Feb 2017 23:57:12 +0000"  >&lt;p&gt;Commit 8dbb1bb3fb64fea4baa672ce82a1b62af22c3571 in lucene-solr&apos;s branch refs/heads/branch_6x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yonik%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;yonik@apache.org&quot;&gt;yonik@apache.org&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8dbb1bb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8dbb1bb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10121&quot; title=&quot;BlockCache corruption with high concurrency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10121&quot;&gt;&lt;del&gt;SOLR-10121&lt;/del&gt;&lt;/a&gt;: enable BlockCacheTest.testBlockCacheConcurrent that now passes&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="13043296">SOLR-10141</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13041915">SOLR-10115</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13041942">SOLR-10116</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12852619" name="SOLR-10121.patch" size="2396" author="yseeley@gmail.com" created="Tue, 14 Feb 2017 17:55:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39x3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>