<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:40:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-13699] maxChars no longer working on CopyField with Javabin</title>
                <link>https://issues.apache.org/jira/browse/SOLR-13699</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;We recently upgraded from Solr 7.3 to 8.1, and noticed that the maxChars property on a copy field is no longer functioning as designed, while indexing via SolrJ. Per the most recent documentation it looks like there have been no intentional changes as to the functionality of this property, so I assume this is a bug.&lt;br/&gt;
 &#160;&lt;br/&gt;
 In debugging the issue, it looks like the bug was caused by&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12992&quot; title=&quot;Avoid creating Strings from BytesRef in ExportWriter &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12992&quot;&gt;&lt;del&gt;SOLR-12992&lt;/del&gt;&lt;/a&gt;. In DocumentBuilder where the maxChar limit is applied, it first checks if the value is instanceof String. As of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12992&quot; title=&quot;Avoid creating Strings from BytesRef in ExportWriter &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12992&quot;&gt;&lt;del&gt;SOLR-12992&lt;/del&gt;&lt;/a&gt;, string values are now coming in as ByteArrayUtf8CharSequence (unless they are above a certain size as defined by JavaBinCodec.MAX_UTF8_SZ), so they are failing the instanceof String check, and the maxChar truncation is not being applied.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue seems to be limited to Javabin, docs indexed in other formats (where values come in as strings) are working fine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13251077">SOLR-13699</key>
            <summary>maxChars no longer working on CopyField with Javabin</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="noble.paul">Noble Paul</assignee>
                                    <reporter username="ctroullis">Chris Troullis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Aug 2019 18:20:26 +0000</created>
                <updated>Tue, 21 Jan 2020 16:59:11 +0000</updated>
                            <resolved>Sun, 25 Aug 2019 23:02:56 +0000</resolved>
                                    <version>7.7</version>
                    <version>7.7.1</version>
                    <version>7.7.2</version>
                    <version>7.7.3</version>
                    <version>8.0</version>
                    <version>8.1</version>
                    <version>8.1.1</version>
                    <version>8.1.2</version>
                    <version>8.2</version>
                                    <fixVersion>8.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16908386" author="ctroullis" created="Thu, 15 Aug 2019 18:25:01 +0000"  >&lt;p&gt;Created after discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt; on the mailing list. I think I have a fix working, just finishing testing and writing a unit test, then I will attach my patch.&lt;/p&gt;</comment>
                            <comment id="16908422" author="ctroullis" created="Thu, 15 Aug 2019 19:20:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erickerickson&quot; class=&quot;user-hover&quot; rel=&quot;erickerickson&quot;&gt;erickerickson&lt;/a&gt;&#160;So after looking through the CopyFieldTest unit tests, I found that we are already testing the maxChars functionality via the&#160;testCopyFieldFunctionality() test, and the maxChars functionality is working properly when the test runs!&#160;&lt;/p&gt;

&lt;p&gt;After further digging it seems that the issue only occurs when docs are indexed in Binary format, using the JavaBinCodec, as this is where there change was made to read strings as a ByteArrayUtf8CharSequence instead of a string. It appears that the test framework indexes docs in XML format, which does not use the JavaBinCodec, so the fields are read as strings, and the maxChars works as designed.&#160;&lt;/p&gt;

&lt;p&gt;So, in other words, it&apos;s still an issue, but looks like it only effects docs indexed in Binary format. Since it looks like the test framework only supports indexing in XML format (although I didn&apos;t look that hard), do you have any suggestions on how to properly unit test this?&lt;/p&gt;</comment>
                            <comment id="16908850" author="janhoy" created="Fri, 16 Aug 2019 08:44:50 +0000"  >&lt;p&gt;So this is yet another regression from the&#160;ByteArrayUtf8CharSequence &quot;optimization&quot;? If this surfaces a symptom of bad design, let&apos;s fix that rather than patch just the maxChars check for JavaBin with some instanceOf or something?&lt;/p&gt;</comment>
                            <comment id="16909124" author="ctroullis" created="Fri, 16 Aug 2019 15:18:42 +0000"  >&lt;p&gt;The fix I have was just to basically add another instanceOf check to handle the ByteArrayUtf8CharSequence, which I agree is not the best solution. It does seem like there have been a number of regressions created by the optimization. I&apos;m not sure I understand enough about the intent of the original change to make any kind of larger scale refactor.&lt;/p&gt;

&lt;p&gt;Let me know if you still think it&apos;s worth submitting my patch, or if you&apos;d prefer to revisit&#160;the design of the original optimization.&lt;/p&gt;</comment>
                            <comment id="16909162" author="janhoy" created="Fri, 16 Aug 2019 16:11:10 +0000"  >&lt;p&gt;In this particular case I guess we can replace&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( val &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; &amp;amp;&amp;amp; cf.getMaxChars() &amp;gt; 0 ) {&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( val &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CharSequence &amp;amp;&amp;amp; cf.getMaxChars() &amp;gt; 0 ) {&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But how do we guard against other code locations expecting &lt;tt&gt;String&lt;/tt&gt; explicitly?&#160;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&#160;any suggestions?&#160;&lt;/p&gt;</comment>
                            <comment id="16909330" author="ctroullis" created="Fri, 16 Aug 2019 18:44:18 +0000"  >&lt;p&gt;Indeed. There appears to be a lot of &quot;Instanceof String&quot; in the codebase, so there could potentially be a lot of other places that are affected by this same issue. I went ahead an uploaded my patch with some unit tests, just so it&apos;s there if we decide to move forward with the change. Please let me know if I can help at all further.&lt;/p&gt;</comment>
                            <comment id="16909489" author="noble.paul" created="Fri, 16 Aug 2019 23:50:10 +0000"  >&lt;p&gt;Let&apos;s limit all the changes to DocumentBuilder. Eventually, we have to convert our tests to run on all the 3 formats&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;JSON&lt;/li&gt;
	&lt;li&gt;XML&lt;/li&gt;
	&lt;li&gt;javabin&lt;br/&gt;
Sticking to XML alone in tests can lead to many unforseen problems.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16914486" author="ctroullis" created="Fri, 23 Aug 2019 17:31:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&#160;Sounds good. I thought it would be cleaner to only have the 1 instanceOf check, the copyfield change seemed low risk since the only place that method was called was from DocumentBuilder. I fully understand the desire to keep the changes as low impact as possible though.&#160;&lt;/p&gt;

&lt;p&gt;Is there anything else I should do to move these changes forward? Not sure what the process is. Should I enable patch review on the ticket?&lt;/p&gt;

&lt;p&gt;Also, I agree that it would be good to have the tests running in all 3 formats, the existing CopyField tests would have caught this regression if the test docs had been indexed using javabin. Should we create a ticket to track that work, if one doesn&apos;t already exist?&lt;/p&gt;</comment>
                            <comment id="16914711" author="noble.paul" created="Fri, 23 Aug 2019 23:30:23 +0000"  >&lt;p&gt;You can submit a PR and I can merge it&lt;/p&gt;</comment>
                            <comment id="16915361" author="ctroullis" created="Sun, 25 Aug 2019 22:16:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noble.paul&quot; class=&quot;user-hover&quot; rel=&quot;noble.paul&quot;&gt;noble.paul&lt;/a&gt;&#160;Thanks. I created a PR with the discussed changes:&#160;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/845&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/845&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16915367" author="jira-bot" created="Sun, 25 Aug 2019 22:57:25 +0000"  >&lt;p&gt;Commit 64a4ca57a89ad05085e60571fcea3b532de28e8e in lucene-solr&apos;s branch refs/heads/master from Chris Troullis&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=64a4ca5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=64a4ca5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13699&quot; title=&quot;maxChars no longer working on CopyField with Javabin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13699&quot;&gt;&lt;del&gt;SOLR-13699&lt;/del&gt;&lt;/a&gt; - maxChars no longer working on CopyField with Javabin&lt;/p&gt;
</comment>
                            <comment id="16915372" author="jira-bot" created="Sun, 25 Aug 2019 23:01:12 +0000"  >&lt;p&gt;Commit 0ad8c1f30226adedb3ed64118961e7fbf86d8c98 in lucene-solr&apos;s branch refs/heads/master from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=0ad8c1f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=0ad8c1f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13699&quot; title=&quot;maxChars no longer working on CopyField with Javabin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13699&quot;&gt;&lt;del&gt;SOLR-13699&lt;/del&gt;&lt;/a&gt; - maxChars no longer working on CopyField with javabin&lt;/p&gt;</comment>
                            <comment id="16915373" author="jira-bot" created="Sun, 25 Aug 2019 23:02:23 +0000"  >&lt;p&gt;Commit 16a1ef8621dbcd7251281a7182ca4fe49999fd57 in lucene-solr&apos;s branch refs/heads/branch_8x from Chris Troullis&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=16a1ef8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=16a1ef8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13699&quot; title=&quot;maxChars no longer working on CopyField with Javabin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13699&quot;&gt;&lt;del&gt;SOLR-13699&lt;/del&gt;&lt;/a&gt; - maxChars no longer working on CopyField with Javabin&lt;/p&gt;
</comment>
                            <comment id="16915374" author="jira-bot" created="Sun, 25 Aug 2019 23:02:25 +0000"  >&lt;p&gt;Commit b7c9a9f4a1a72ac0003f9fa98582ad89e75f043f in lucene-solr&apos;s branch refs/heads/branch_8x from Noble Paul&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b7c9a9f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=b7c9a9f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-13699&quot; title=&quot;maxChars no longer working on CopyField with Javabin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-13699&quot;&gt;&lt;del&gt;SOLR-13699&lt;/del&gt;&lt;/a&gt; - maxChars no longer working on CopyField with javabin&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12977848" name="SOLR-13699.patch" size="3736" author="noble.paul" created="Fri, 16 Aug 2019 23:49:41 +0000"/>
                            <attachment id="12977835" name="SOLR-13699.patch" size="6214" author="ctroullis" created="Fri, 16 Aug 2019 18:40:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05pko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>