<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:24:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-10506] Possible memory leak upon collection reload</title>
                <link>https://issues.apache.org/jira/browse/SOLR-10506</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Upon manual Solr Collection reloading, references to the closed &lt;tt&gt;SolrCore&lt;/tt&gt; are not fully removed by the garbage collector as a strong reference to the &lt;tt&gt;ZkIndexSchemaReader&lt;/tt&gt; is held in a ZooKeeper &lt;tt&gt;Watcher&lt;/tt&gt; that watches for schema changes.&lt;/p&gt;

&lt;p&gt;In our case, this leads to a massive memory leak as managed resources are still referenced by the closed &lt;tt&gt;SolrCore&lt;/tt&gt;. Our Solr cloud environment utilizes rather large managed resources (synonyms, stopwords). To reproduce, we fired out environment up and reloaded the collection 13 times. As a result we fully exhausted our heap. A closer look with the Yourkit profiler revealed 13 &lt;tt&gt;SolrCore&lt;/tt&gt; instances, still holding strong references to the garbage collection root (see screenshot 1).&lt;/p&gt;

&lt;p&gt;Each &lt;tt&gt;SolrCore&lt;/tt&gt; instance holds a single path with strong references to the gc root via a `Watcher` in `ZkIndexSchemaReader` (see screenshot 2). The &lt;tt&gt;ZkIndexSchemaReader&lt;/tt&gt; registers a close hook in the &lt;tt&gt;SolrCore&lt;/tt&gt; but the Zookeeper is not removed upon core close.&lt;/p&gt;

&lt;p&gt;We supplied a Github Pull Request (&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/197&lt;/a&gt;) that extracts the zookeeper `Watcher` as a static inner class. To eliminate the memory leak, the schema reader is held inside a `WeakReference` and the reference is explicitly removed on core close.&lt;/p&gt;

&lt;p&gt;Initially I wanted to supply a test case but unfortunately did not find a good starting point ...&lt;/p&gt;</description>
                <environment></environment>
        <key id="13064657">SOLR-10506</key>
            <summary>Possible memory leak upon collection reload</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cpoerschke">Christine Poerschke</assignee>
                                    <reporter username="tboeghk">Torsten B&#248;gh K&#246;ster</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Apr 2017 10:15:33 +0000</created>
                <updated>Tue, 21 Jan 2020 18:08:10 +0000</updated>
                            <resolved>Fri, 8 Mar 2019 08:36:09 +0000</resolved>
                                    <version>6.5</version>
                                    <fixVersion>6.6.6</fixVersion>
                    <fixVersion>7.0</fixVersion>
                                    <component>Server</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>15</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="15972458" author="tboeghk" created="Tue, 18 Apr 2017 10:16:35 +0000"  >&lt;p&gt;A single collection gets reloaded 13 times. 13 SolrCore instances remain.&lt;/p&gt;</comment>
                            <comment id="15972459" author="tboeghk" created="Tue, 18 Apr 2017 10:17:13 +0000"  >&lt;p&gt;The strong references via schema index reader&lt;/p&gt;</comment>
                            <comment id="15972465" author="githubbot" created="Tue, 18 Apr 2017 10:19:11 +0000"  >&lt;p&gt;GitHub user tboeghk opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt; Fixes a memory leak in zk schema watching&lt;/p&gt;

&lt;p&gt;    Upon manual Solr Collection reloading, references to the closed `SolrCore` are not fully removed by the garbage collector as a strong reference to the `ZkIndexSchemaReader` is held in a ZooKeeper `Watcher` that watches for schema changes.&lt;/p&gt;

&lt;p&gt;    In our case, this leads to a massive memory leak as managed resources are still referenced by the closed `SolrCore`. Our Solr cloud environment utilizes rather large managed resources (synonyms, stopwords). To reproduce, we fired out environment up and reloaded the collection 13 times. As a result we fully exhausted our heap. A closer look with the Yourkit profiler revealed 13 `SolrCore` instances, still holding strong references to the garbage collection root.&lt;/p&gt;

&lt;p&gt;    Each `SolrCore` instance holds a single path with strong references to the gc root via a `Watcher` in `ZkIndexSchemaReader`. The `ZkIndexSchemaReader` registers a close hook in the `SolrCore` but the Zookeeper is not removed upon core close.&lt;/p&gt;

&lt;p&gt;    We supplied this Github Pull Request that extracts the zookeeper `Watcher` as a static inner class. To eliminate the memory leak, the schema reader is held inside a `WeakReference` and the reference is explicitly removed on core close.&lt;/p&gt;

&lt;p&gt;    Initially I wanted to supply a test case but unfortunately did not find a good starting point ...&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/shopping24/lucene-solr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/shopping24/lucene-solr&lt;/a&gt; branch_6_5&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/190.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/190.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #190&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9a5abee7e9b431ba0c2e0d432dc33b1919fa4f40&lt;br/&gt;
Author: Torsten B&#248;gh Ko&#776;ster &amp;lt;torsten.koester@s24.com&amp;gt;&lt;br/&gt;
Date:   2017-04-18T09:43:52Z&lt;/p&gt;

&lt;p&gt;    Fixes a memory leak in zk schema watching&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15985007" author="cpoerschke" created="Wed, 26 Apr 2017 15:30:07 +0000"  >&lt;p&gt;Hi Torsten, thanks for finding and analysing this issue, and for putting up a fix for it.&lt;/p&gt;

&lt;p&gt;I&apos;ve just tried to send you a pull request with two small suggestions from my &lt;a href=&quot;https://github.com/cpoerschke/lucene-solr/tree/jira/solr-10506-branch_6_5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jira/solr-10506-branch_6_5&lt;/a&gt; branch but something in the settings didn&apos;t allow it. Anyhow, the commit is there at the top of the branch ...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... To eliminate the memory leak, the schema reader is held inside a `WeakReference` and the reference is explicitly removed on core close. ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As I read the code and patch, this will allow the ZkIndexSchemaReader (and SolrCore?) to be garbage collected but the Watcher would stay around, right? And ideally we&apos;d also wish for the Watcher to not stay around ...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... Initially I wanted to supply a test case but unfortunately did not find a good starting point ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, yeah, tricky. Building upon the above &quot;but the watcher stays around&quot; observation, perhaps something like this could work:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# start instance without cores
# determine baseline number of (managed-schema) watchers
# create a core
# reload the core a couple of times
# delete the core
# determine &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; number of (managed-schema) watchers
# test that no &lt;span class=&quot;code-quote&quot;&gt;&apos;extra&apos;&lt;/span&gt; watchers are still around
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15996574" author="githubbot" created="Thu, 4 May 2017 11:26:33 +0000"  >&lt;p&gt;GitHub user tboeghk opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt; Fixes a memory leak in zk schema watching&lt;/p&gt;

&lt;p&gt;    Upon manual Solr Collection reloading, references to the closed SolrCore are not fully removed by the garbage collector as a strong reference to the ZkIndexSchemaReader is held in a ZooKeeper Watcher that watches for schema changes.&lt;/p&gt;

&lt;p&gt;    In our case, this leads to a massive memory leak as managed resources are still referenced by the closed SolrCore. Our Solr cloud environment utilizes rather large managed resources (synonyms, stopwords). To reproduce, we fired out environment up and reloaded the collection 13 times. As a result we fully exhausted our heap. A closer look with the Yourkit profiler revealed 13 SolrCore instances, still holding strong references to the garbage collection root.&lt;/p&gt;

&lt;p&gt;    Each SolrCore instance holds a single path with strong references to the gc root via a Watcher in ZkIndexSchemaReader. The ZkIndexSchemaReader registers a close hook in the SolrCore but the Zookeeper is not removed upon core close.&lt;/p&gt;

&lt;p&gt;    We supplied this Github Pull Request that extracts the zookeeper Watcher as a static inner class. To eliminate the memory leak, the schema reader is held inside a WeakReference and the reference is explicitly removed on core close.&lt;/p&gt;

&lt;p&gt;    Initially I wanted to supply a test case but unfortunately did not find a good starting point ...&lt;/p&gt;

&lt;p&gt;    N.B.: I did this second PR for the same issue to separate code changes for both &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10550&quot; title=&quot;Improve FileFloatSource eviction // reduce FileFloatSource memory footprint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10550&quot;&gt;&lt;del&gt;SOLR-10550&lt;/del&gt;&lt;/a&gt; which I maintained on the same fork branch :-/&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/shopping24/lucene-solr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/shopping24/lucene-solr&lt;/a&gt; branch_6_5__&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/197.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/197.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #197&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit aa3a96cd88d1724f3ab641f25c5373ff58f4616d&lt;br/&gt;
Author: Torsten B&#248;gh Ko&#776;ster &amp;lt;torsten.koester@s24.com&amp;gt;&lt;br/&gt;
Date:   2017-04-18T09:43:52Z&lt;/p&gt;

&lt;p&gt;    Fixes a memory leak in zk schema watching&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15996576" author="githubbot" created="Thu, 4 May 2017 11:26:59 +0000"  >&lt;p&gt;Github user tboeghk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Superseeded by #197 &lt;/p&gt;</comment>
                            <comment id="15996577" author="githubbot" created="Thu, 4 May 2017 11:27:00 +0000"  >&lt;p&gt;Github user tboeghk closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/190&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15996607" author="tboeghk" created="Thu, 4 May 2017 11:58:10 +0000"  >&lt;p&gt;Hi Christine,&lt;/p&gt;

&lt;p&gt;thanks for the suggestions, I cherry picked your commit onto the pull request branch! &lt;/p&gt;

&lt;p&gt;Indeed, removing a watcher from the Zookeeper would be the best ans cleanest solution. The problem with garbage collecting a schema watcher is that neither the &lt;tt&gt;SolrZkClient&lt;/tt&gt; nor the underlying &lt;tt&gt;SolrZooKeeper&lt;/tt&gt; / &lt;tt&gt;ZooKeeper&lt;/tt&gt; facilitates any method to enumerate or manipulate registered watchers. Futhermore, any Zookeeper watchers are wrapped before submitted into the Zookeeper code &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. So I guess that removing a submitted Zookeeper watcher might be pretty hard &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Regarding the test: The plan seems legit to me, I&apos;ll try my very best. Do you have any hints towards an existing test super class?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/branch_6_5/solr/solrj/src/java/org/apache/solr/common/cloud/SolrZkClient.java#L299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/branch_6_5/solr/solrj/src/java/org/apache/solr/common/cloud/SolrZkClient.java#L299&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15997269" author="cpoerschke" created="Thu, 4 May 2017 19:13:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;... removing a submitted Zookeeper watcher might be pretty hard ..&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, you&apos;re right. Somehow I thought it could be done since leader elections after all can be canceled (there&apos;s the ElectionWatcher class in LeaderElector.java) but that works differently.&lt;/p&gt;

&lt;p&gt;Okay, so if we can&apos;t remove a watcher, can we perhaps re-use the one we&apos;ve got? I&apos;ve added a commit to my &lt;a href=&quot;https://github.com/cpoerschke/lucene-solr/tree/jira/solr-10506-branch_6_5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jira/solr-10506-branch_6_5&lt;/a&gt; branch to explore that possibility.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... Do you have any hints towards an existing test super class? ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;TestReload and TestConfigReload look like possibilities. StressRamUsageEstimator.testLargeSetOfByteArrays does a before/after memory measurement. If our test could use a large managed resource (like in your use case) and do a couple of reloads then perhaps a very measureable difference could be detected without the fix and a less measureable (but still non-zero) difference could be detected with the fix, something along those lines?&lt;/p&gt;</comment>
                            <comment id="16002538" author="joergr" created="Tue, 9 May 2017 11:40:15 +0000"  >&lt;p&gt;I&apos;d suggest to simply implement the command method in ZkIndexSchmeaReader like this, so that it reuses the already existing SchemaWatcher:&lt;br/&gt;
&lt;tt&gt;updateSchema(schemaWatcher, -1);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;See my changes here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/joergrathlev/lucene-solr/tree/branch_6_5__SOLR-10506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/joergrathlev/lucene-solr/tree/branch_6_5__SOLR-10506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve also added a basic test for the SchemaWatcher class.&lt;/p&gt;</comment>
                            <comment id="16004451" author="cpoerschke" created="Wed, 10 May 2017 10:29:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;... implement the command method in ZkIndexSchmeaReader ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Interesting idea to re-use the watcher like that. That would cover the session expiry but not the core reload, correct?&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;As a next step, could I suggest combining what we&apos;ve got so far into a working branch/pull request based off master(&amp;#42;), &lt;em&gt;jira/solr-10506&lt;/em&gt; would be conventional name for the branch. What we&apos;ve got so far is spread across multiple commits and multiple branches, an overall working branch/pull request should make it easier to &apos;see&apos; the overall change:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/pull/197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/197&lt;/a&gt; (into apache:branch_6_5 from shopping24:branch_6_5__&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt; )&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/cpoerschke/lucene-solr/tree/jira/solr-10506-branch_6_5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cpoerschke/lucene-solr/tree/jira/solr-10506-branch_6_5&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/joergrathlev/lucene-solr/tree/branch_6_5__SOLR-10506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/joergrathlev/lucene-solr/tree/branch_6_5__SOLR-10506&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(&amp;#42;) Development workflow would be for the changes to be made to master first, followed by any backporting to non-master branch.&lt;/p&gt;</comment>
                            <comment id="16004456" author="mdrob" created="Wed, 10 May 2017 10:32:34 +0000"  >&lt;p&gt;Since it&apos;s a weak reference, couldn&apos;t the schema reader be collected now without getting explicitly removed? That leads to a bad situation where a still-open SolrCore stops getting updates.&lt;/p&gt;</comment>
                            <comment id="16004503" author="joergr" created="Wed, 10 May 2017 11:27:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;Interesting idea to re-use the watcher like that. That would cover the session expiry but not the core reload, correct?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, correct.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since it&apos;s a weak reference, couldn&apos;t the schema reader be collected now without getting explicitly removed? That leads to a bad situation where a still-open SolrCore stops getting updates.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well, the stopWatching method is only called when a core is closed. Maybe it should be called in postClose to be safe? I&apos;m not familiar enough with the internals of a SolrCore lifecycle to judge this.&lt;/p&gt;</comment>
                            <comment id="16004527" author="joergr" created="Wed, 10 May 2017 11:45:09 +0000"  >&lt;p&gt;Based off upstream/master: &lt;a href=&quot;https://github.com/joergrathlev/lucene-solr/tree/jira/solr-10506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/joergrathlev/lucene-solr/tree/jira/solr-10506&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16004552" author="tboeghk" created="Wed, 10 May 2017 12:01:48 +0000"  >&lt;p&gt;Thanks Joerg &amp;amp; Christine for digging into this! &lt;/p&gt;

&lt;p&gt;I would love to see a patch in the official release as this is causing us a lot of pain (as does &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10550&quot; title=&quot;Improve FileFloatSource eviction // reduce FileFloatSource memory footprint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10550&quot;&gt;&lt;del&gt;SOLR-10550&lt;/del&gt;&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16004822" author="mdrob" created="Wed, 10 May 2017 14:59:53 +0000"  >&lt;p&gt;Well, the stopWatching method is only called when a core is closed. Maybe it should be called in postClose to be safe? I&apos;m not familiar enough with the internals of a SolrCore lifecycle to judge this.&lt;br/&gt;
The implementation details of it being a weak reference mean that it can return null without stopWatching/clear ever being called. If the GC decides that it needs memory then your schema reader will suddenly be gone. So an open core using lots of memory will eventually lose the reference before it should.&lt;/p&gt;</comment>
                            <comment id="16004852" author="joergr" created="Wed, 10 May 2017 15:25:51 +0000"  >&lt;p&gt;Oh, right, good point! So, the SchemaWatcher needs to keep a strong reference to the ZkIndexSchemaReader but then that should be cleaned up in the SolrCore&apos;s onClose hook. I&apos;ll try to run another test with a memory profiler in the next couple of days to see if that solves the issue.&lt;/p&gt;</comment>
                            <comment id="16015480" author="joergr" created="Thu, 18 May 2017 09:27:05 +0000"  >&lt;p&gt;I&apos;ve updated my branch so that the reference in the SchemaWatcher is a strong reference, and is discarded after the SolrCore is closed (postClose). Based on testing this with a memory profiler, no strong references to the cores are retained after closing the cores, so this fixes the memory leak.&lt;br/&gt;
&lt;a href=&quot;https://github.com/joergrathlev/lucene-solr/tree/jira/solr-10506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/joergrathlev/lucene-solr/tree/jira/solr-10506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What&apos;s the next step now? Should I open another Github pull request to merge my branch into upstream&apos;s master branch?&lt;/p&gt;</comment>
                            <comment id="16017757" author="cpoerschke" created="Fri, 19 May 2017 17:57:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;... Based on testing this with a memory profiler, no strong references to the cores are retained after closing the cores ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nice. Just wondering if SchemaWatcher objects are also not retained or if they stick around? I had &lt;a href=&quot;https://github.com/cpoerschke/lucene-solr/tree/jira/solr-10506-branch_6_5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;explored&lt;/a&gt; SchemaWatcher re-use in code only so far i.e. without any profiling.&lt;/p&gt;</comment>
                            <comment id="16017804" author="mdrob" created="Fri, 19 May 2017 18:27:46 +0000"  >&lt;p&gt;+1 LGTM. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cpoerschke&quot; class=&quot;user-hover&quot; rel=&quot;cpoerschke&quot;&gt;cpoerschke&lt;/a&gt;, I&apos;ll let you commit this when you are done exploring the reuse - I think it might be reasonable to have as a separate issue to get this code fixed now, but it&apos;s your call.&lt;/p&gt;</comment>
                            <comment id="16019247" author="joergr" created="Mon, 22 May 2017 08:00:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Nice. Just wondering if SchemaWatcher objects are also not retained or if they stick around?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;They stick around until the Zookeeper connector releases the reference to the watcher. I had looked at your exploration, but I wasn&apos;t sure if reassigning the existing watcher to a new reader/core works because it would mean that the previous core will no longer be notified on schema updates, but it might still be open for a while. I think that reusing the watchers requires a bigger restructuring of the code, so that one reusable watcher can notify multiple schema readers.&lt;/p&gt;

&lt;p&gt;My preference would be to open a separate issue for that, because I think the watchers by themselves are lightweight objects, while this issue is currently causing actual production outages for us (or it would if we didn&apos;t use a locally patched version).&lt;/p&gt;</comment>
                            <comment id="16035222" author="cpoerschke" created="Fri, 2 Jun 2017 18:45:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;... to have as a separate issue ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;... preference would be to open a separate issue for that ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good.&lt;/p&gt;

&lt;p&gt;I just returned to this, and maybe Friday evening timing was a mistake and it will all be clearer next week ... am struggling to convince myself that the proposed removal of the watcher re-creation in &lt;em&gt;ZkIndexSchemaReader.command()&lt;/em&gt; is appropriate. The existing comment on the method says&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  /**
   * Called after a ZooKeeper session expiration occurs; need to re-create the watcher and update the current
   * schema from ZooKeeper.
   */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and &lt;em&gt;ZkController.addOnReconnectListener(OnReconnect listener)&lt;/em&gt; method has a comment&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  /**
   * Add a listener to be notified once there is a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session created after a ZooKeeper session expiration occurs;
   * in most cases, listeners will be components that have watchers that need to be re-created.
   */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and intuitively &quot;we got disconnected and so need to recreate our watchers since/if the watchers we had previously were for the connection that got disconnected&quot; seems plausible but then equally so &quot;we registered watches with the zkclient and wouldn&apos;t it be nice for zkclient to take care of watcher lifecycle across disconnects?&quot; is not implausible. Need to go checkout ZK docs and stuff, not today.&lt;/p&gt;</comment>
                            <comment id="16063149" author="cpoerschke" created="Mon, 26 Jun 2017 14:15:35 +0000"  >&lt;p&gt;Attaching final(&amp;#63;) patch: merged latest master into &lt;a href=&quot;https://github.com/joergrathlev/lucene-solr/tree/jira/solr-10506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/joergrathlev/lucene-solr/tree/jira/solr-10506&lt;/a&gt; and changed &lt;em&gt;ZkIndexSchemaReader.command()&lt;/em&gt; back to re-create the watcher.&lt;/p&gt;

&lt;p&gt;If there are no further comments or concerns then I will go ahead and commit the change some time tomorrow (Tuesday) London time.&lt;/p&gt;</comment>
                            <comment id="16063170" author="githubbot" created="Mon, 26 Jun 2017 14:32:15 +0000"  >&lt;p&gt;Github user uschindler commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Should we not have a non-empty message when logging the InterruptedException?&lt;/p&gt;</comment>
                            <comment id="16063188" author="githubbot" created="Mon, 26 Jun 2017 14:44:37 +0000"  >&lt;p&gt;Github user tboeghk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/lucene-solr/pull/197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/pull/197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 &lt;/p&gt;

&lt;p&gt;    ... but I wanted to focus the PR above on the fix (the empty message is copied code). Also this PR is outdated as the current patch is atached here: &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SOLR-10506&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16063199" author="cpoerschke" created="Mon, 26 Jun 2017 14:55:08 +0000"  >&lt;p&gt;+1 to having a non-empty message in general, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10958&quot; title=&quot;avoid (and eventually disallow?) empty message when logging exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10958&quot;&gt;SOLR-10958&lt;/a&gt; created.&lt;/p&gt;</comment>
                            <comment id="16064888" author="jira-bot" created="Tue, 27 Jun 2017 14:08:18 +0000"  >&lt;p&gt;Commit 701c73d45a0188d006316e9a3168ad6b70e0fac9 in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cpoerschke&quot; class=&quot;user-hover&quot; rel=&quot;cpoerschke&quot;&gt;cpoerschke&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=701c73d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=701c73d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt;: Fix memory leak (upon collection reload or ZooKeeper session expiry) in ZkIndexSchemaReader.&lt;br/&gt;
(Torsten B&#248;gh K&#246;ster, Christine Poerschke, J&#246;rg Rathlev, Mike Drob)&lt;/p&gt;</comment>
                            <comment id="16066825" author="cpoerschke" created="Wed, 28 Jun 2017 16:35:51 +0000"  >&lt;p&gt;Thanks everyone!&lt;/p&gt;</comment>
                            <comment id="16787656" author="ichattopadhyaya" created="Fri, 8 Mar 2019 08:29:03 +0000"  >&lt;p&gt;Reopening this for a backport into 6x (and a potential 6.6.6 release). This is quite serious, IMHO, and doesn&apos;t affect functionality.&lt;/p&gt;</comment>
                            <comment id="16787663" author="jira-bot" created="Fri, 8 Mar 2019 08:34:39 +0000"  >&lt;p&gt;Commit 23dea2ca7038f435b109aaedac91d8d1335349b8 in lucene-solr&apos;s branch refs/heads/branch_6x from Christine Poerschke&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=23dea2c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=23dea2c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt;: Fix memory leak (upon collection reload or ZooKeeper session expiry) in ZkIndexSchemaReader.&lt;br/&gt;
(Torsten B&#248;gh K&#246;ster, Christine Poerschke, J&#246;rg Rathlev, Mike Drob)&lt;/p&gt;</comment>
                            <comment id="16787666" author="jira-bot" created="Fri, 8 Mar 2019 08:35:21 +0000"  >&lt;p&gt;Commit 386b22203e5c23521344578e367c59f1c746f896 in lucene-solr&apos;s branch refs/heads/branch_6_6 from Christine Poerschke&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=386b222&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=386b222&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-10506&quot; title=&quot;Possible memory leak upon collection reload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-10506&quot;&gt;&lt;del&gt;SOLR-10506&lt;/del&gt;&lt;/a&gt;: Fix memory leak (upon collection reload or ZooKeeper session expiry) in ZkIndexSchemaReader.&lt;br/&gt;
(Torsten B&#248;gh K&#246;ster, Christine Poerschke, J&#246;rg Rathlev, Mike Drob)&lt;/p&gt;</comment>
                            <comment id="16787667" author="ichattopadhyaya" created="Fri, 8 Mar 2019 08:36:09 +0000"  >&lt;p&gt;Committed to 6.6 branch, slated for a release if/when there is a 6.6.6 release.&lt;/p&gt;</comment>
                            <comment id="17019264" author="vinhlh" created="Mon, 20 Jan 2020 06:52:22 +0000"  >&lt;p&gt;In 7.7.2, some SolrCore still are not released after being removed.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12991357/12991357_image-2020-01-20-14-51-26-411.png&quot; height=&quot;538&quot; width=&quot;880&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
 &#160;&lt;br/&gt;
 &#160;&lt;br/&gt;
 &#160;&lt;br/&gt;
 &#160;&lt;/p&gt;</comment>
                            <comment id="17020445" author="cpoerschke" created="Tue, 21 Jan 2020 18:07:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;In 7.7.2, some SolrCore still are not released after being removed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinhlh&quot; class=&quot;user-hover&quot; rel=&quot;vinhlh&quot;&gt;vinhlh&lt;/a&gt; for sharing your findings! I&apos;ve started &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14201&quot; title=&quot;some SolrCore are not released after being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14201&quot;&gt;SOLR-14201&lt;/a&gt; for a separate investigation since this ticket here is already closed and related to a different earlier version.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13280814">SOLR-14201</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13023551">SOLR-9803</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12874508" name="SOLR-10506.patch" size="9711" author="cpoerschke" created="Mon, 26 Jun 2017 14:15:09 +0000"/>
                            <attachment id="12991357" name="image-2020-01-20-14-51-26-411.png" size="677429" author="vinhlh" created="Mon, 20 Jan 2020 06:51:32 +0000"/>
                            <attachment id="12863788" name="solr_collection_reload_13_cores.png" size="190599" author="tboeghk" created="Tue, 18 Apr 2017 10:16:35 +0000"/>
                            <attachment id="12863789" name="solr_gc_path_via_zk_WatchManager.png" size="245389" author="tboeghk" created="Tue, 18 Apr 2017 10:17:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dqjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>