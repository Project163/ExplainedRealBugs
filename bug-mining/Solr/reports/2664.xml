<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:08:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-8152] Overseer Task Processor/Queue can miss responses, leading to timeouts</title>
                <link>https://issues.apache.org/jira/browse/SOLR-8152</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I noticed some jenkins reports of timeouts in the TestConfigSetsAPIExclusivityTest, which seemed strange given the amount of work to be done is small and the timeout generous at 300 seconds.&lt;/p&gt;

&lt;p&gt;I added some statistics gathering and started beasting the test and sure enough, some tests reported tasks taking slightly more than 300 seconds, while most tests ran with a maximum task run of less than a second.  This suggested something was hanging until the timeout.&lt;/p&gt;

&lt;p&gt;Some investigation lead to this code:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/80a73535b20debb1717c6f7f11e08fc311833c88/solr/core/src/java/org/apache/solr/cloud/OverseerTaskQueue.java#L179-L194&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/80a73535b20debb1717c6f7f11e08fc311833c88/solr/core/src/java/org/apache/solr/cloud/OverseerTaskQueue.java#L179-L194&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There appears to be a few issues here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = createData(dir + &lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt; + PREFIX, data,
          CreateMode.PERSISTENT_SEQUENTIAL);
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; watchID = createData(
          dir + &lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt; + response_prefix + path.substring(path.lastIndexOf(&lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt;) + 1),
          &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, CreateMode.EPHEMERAL);

      &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; lock = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;();
      LatchWatcher watcher = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LatchWatcher(lock);
      &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zookeeper.exists(watchID, watcher, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          watcher.await(timeout);
        }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For one, the request object is created before the response object.  If the request is quickly picked up and processed, two things can happen:&lt;br/&gt;
1) The response is written before the watch is set, which means we wait until the timeout even though the response is ready.  This will still pass the test because the response is available, the client will just wait needlessly.&lt;br/&gt;
2) The response is attempted to be written before the response node is even created.  The fact that the response node doesn&apos;t exist is ignored:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/80a73535b20debb1717c6f7f11e08fc311833c88/solr/core/src/java/org/apache/solr/cloud/OverseerTaskQueue.java#L92-L94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/80a73535b20debb1717c6f7f11e08fc311833c88/solr/core/src/java/org/apache/solr/cloud/OverseerTaskQueue.java#L92-L94&lt;/a&gt;&lt;br/&gt;
In this case, the task is processed but the client will actually see a failure because there is no response.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12903931">SOLR-8152</key>
            <summary>Overseer Task Processor/Queue can miss responses, leading to timeouts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gchanan">Gregory Chanan</assignee>
                                    <reporter username="gchanan">Gregory Chanan</reporter>
                        <labels>
                    </labels>
                <created>Sat, 10 Oct 2015 00:32:31 +0000</created>
                <updated>Mon, 9 May 2016 18:48:21 +0000</updated>
                            <resolved>Tue, 13 Oct 2015 23:22:36 +0000</resolved>
                                                    <fixVersion>5.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14951446" author="gchanan" created="Sat, 10 Oct 2015 00:37:11 +0000"  >&lt;p&gt;There are a few ways to solve this, the most straightforward of which appears to be:&lt;br/&gt;
1) Create the response node first using SEQUENTIAL (to generate the path to the request node)&lt;br/&gt;
2) Watch the response node, so we can&apos;t possible miss the response (because the request node isn&apos;t even created yet)&lt;br/&gt;
3) Create the request mode&lt;/p&gt;

&lt;p&gt;At this point, before we wait, we check that the watch didn&apos;t already fire (otherwise we will wait unnecessarily).&lt;/p&gt;</comment>
                            <comment id="14951452" author="gchanan" created="Sat, 10 Oct 2015 00:44:14 +0000"  >&lt;p&gt;Here&apos;s a patch implementing the above.  I haven&apos;t beasted it for too long, but it&apos;s gotten further than I ever got without the changes.&lt;/p&gt;</comment>
                            <comment id="14951608" author="shalinmangar" created="Sat, 10 Oct 2015 05:18:48 +0000"  >&lt;p&gt;Thanks Gregory, good catch! Your patch changes the response node from EPHEMERAL to EPHEMERAL_SEQUENTIAL. Was that intentional?&lt;/p&gt;

&lt;p&gt;Another option could be to create both nodes together in a &apos;multi&apos; operation but this approach also looks fine.&lt;/p&gt;</comment>
                            <comment id="14952126" author="gchanan" created="Sun, 11 Oct 2015 01:34:38 +0000"  >&lt;p&gt;Thanks for taking a look, Shalin.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Your patch changes the response node from EPHEMERAL to EPHEMERAL_SEQUENTIAL. Was that intentional?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, see below.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Another option could be to create both nodes together in a &apos;multi&apos; operation but this approach also looks fine.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I considered using the &apos;multi&apos; operation, but it doesn&apos;t appear trivial.  The issue is that the request and response node share a suffix as determined by ZooKeeper&apos;s SEQUENTIAL, but you don&apos;t know that until you actually create the node.  So, to use multi to create the request and response znodes together, you&apos;d have to do something like first create a SEQUENTIAL node, note the suffix, then use multi to create the request and response nodes together.  This seemed to lead to more of a tracking / cleanup issue than not using multi.  The fact that the response is EPHEMERAL_SEQUENTIAL rather than EPHEMERAL is because it is now created first (so we don&apos;t miss the response).&lt;/p&gt;</comment>
                            <comment id="14952153" author="shalinmangar" created="Sun, 11 Oct 2015 04:45:06 +0000"  >&lt;p&gt;Okay I understand now. So we first create the response node as an EPHEMERAL_SEQUENTIAL and then use its sequence ID to create the persistent request node. Sounds good to me. Thanks for explaining.&lt;/p&gt;</comment>
                            <comment id="14955908" author="jira-bot" created="Tue, 13 Oct 2015 23:21:14 +0000"  >&lt;p&gt;Commit 1708538 from gchanan@apache.org in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1708538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1708538&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8152&quot; title=&quot;Overseer Task Processor/Queue can miss responses, leading to timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8152&quot;&gt;&lt;del&gt;SOLR-8152&lt;/del&gt;&lt;/a&gt;: Overseer Task Processor/Queue can miss responses, leading to timeouts&lt;/p&gt;</comment>
                            <comment id="14955911" author="jira-bot" created="Tue, 13 Oct 2015 23:22:07 +0000"  >&lt;p&gt;Commit 1708539 from gchanan@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1708539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1708539&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8152&quot; title=&quot;Overseer Task Processor/Queue can miss responses, leading to timeouts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8152&quot;&gt;&lt;del&gt;SOLR-8152&lt;/del&gt;&lt;/a&gt;: Overseer Task Processor/Queue can miss responses, leading to timeouts&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12856840">SOLR-7940</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12932105">SOLR-8563</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12823687">SOLR-7459</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12765947" name="SOLR-8152.patch" size="3481" author="gchanan" created="Sat, 10 Oct 2015 00:44:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mufj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>