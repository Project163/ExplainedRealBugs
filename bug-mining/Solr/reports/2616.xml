<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:07:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-7844] Zookeeper session expiry during shard leader election can cause multiple leaders.</title>
                <link>https://issues.apache.org/jira/browse/SOLR-7844</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;If the ZooKeeper session expires for a host during shard leader election, the ephemeral leader_elect nodes are removed. However the threads that were processing the election are still present (and could believe the host won the election). They will then incorrectly create leader nodes once a new ZooKeeper session is established.&lt;/p&gt;

&lt;p&gt;This introduces a subtle race condition that could cause two hosts to become leader.&lt;/p&gt;

&lt;p&gt;Scenario:&lt;/p&gt;

&lt;p&gt;a three machine cluster, all of the machines are restarting at approximately the same time.&lt;/p&gt;

&lt;p&gt;The first machine starts, writes a leader_elect ephemeral node, it&apos;s the only candidate in the election so it wins and starts the leadership process. As it knows it has peers, it begins to block waiting for the peers to arrive.&lt;/p&gt;

&lt;p&gt;During this period of blocking&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; the ZK connection drops and the session expires.&lt;/p&gt;

&lt;p&gt;A new ZK session is established, and ElectionContext.cancelElection is called. Then register() is called and a new set of leader_elect ephemeral nodes are created.&lt;/p&gt;

&lt;p&gt;During the period between the ZK session expiring, and new set of leader_elect nodes being created the second machine starts.&lt;/p&gt;

&lt;p&gt;It creates its leader_elect ephemeral nodes, as there are no other nodes it wins the election and starts the leadership process. As its still missing one of its peers, it begins to block waiting for the third machine to join.&lt;/p&gt;

&lt;p&gt;There is now a race between machine1 &amp;amp; machine2, both of whom think they are the leader.&lt;/p&gt;

&lt;p&gt;So far, this isn&apos;t too bad, because the machine that loses the race will fail when it tries to create the /collection/name/leader/shard1 node (as it already exists), and will rejoin the election.&lt;/p&gt;

&lt;p&gt;While this is happening, machine3 has started and has queued for leadership behind machine2.&lt;/p&gt;

&lt;p&gt;If the loser of the race is machine2, when it rejoins the election it cancels the current context, deleting it&apos;s leader_elect ephemeral nodes.&lt;/p&gt;

&lt;p&gt;At this point, machine3 believes it has become leader (the watcher it has on the leader_elect node fires), and it runs the LeaderElector::checkIfIAmLeader method. This method DELETES the current /collection/name/leader/shard1 node, then starts the leadership process (as all three machines are now running, it does not block to wait).&lt;/p&gt;

&lt;p&gt;So, machine1 won the race with machine2 and declared its leadership and created the nodes. However, machine3 has just deleted them, and recreated them for itself. So machine1 and machine3 both believe they are the leader.&lt;/p&gt;

&lt;p&gt;I am thinking that the fix should be to cancel &amp;amp; close all election contexts immediately on reconnect (we do cancel them, however it&apos;s run serially which has blocking issues, and just canceling does not cause the wait loop to exit). That election context logic already has checks on the closed flag, so they should exit if they see it has been closed.&lt;/p&gt;

&lt;p&gt;I&apos;m working on a patch for this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12849696">SOLR-7844</key>
            <summary>Zookeeper session expiry during shard leader election can cause multiple leaders.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="miketroberts">Mike Roberts</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jul 2015 18:36:35 +0000</created>
                <updated>Mon, 9 May 2016 18:45:56 +0000</updated>
                            <resolved>Mon, 18 Jan 2016 04:20:15 +0000</resolved>
                                    <version>4.10.4</version>
                                    <fixVersion>5.4</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14715613" author="miketroberts" created="Wed, 26 Aug 2015 22:10:02 +0000"  >&lt;p&gt;Initial attempt at a patch.&lt;/p&gt;

&lt;p&gt;When we reconnect after a zookeeper session expiry we cancel any ongoing leader elections. The current ongoing election threads check status in a few places to ensure that no &apos;leader specific&apos; operations are taken after the election has been canceled.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this is bulletproof, but it does significantly reduce the size of the window in which this scenario can occur.&lt;/p&gt;</comment>
                            <comment id="14716604" author="markrmiller@gmail.com" created="Thu, 27 Aug 2015 12:50:20 +0000"  >&lt;p&gt;Did you see this in the wild? Can you reproduce it?&lt;/p&gt;

&lt;p&gt;Any chance you can port this patch to trunk?&lt;/p&gt;

&lt;p&gt;This looks like a good improvement.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This method DELETES the current /collection/name/leader/shard1 node&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We need to audit that. We should be using that node to ensure only one leader in any case.&lt;/p&gt;</comment>
                            <comment id="14716607" author="markrmiller@gmail.com" created="Thu, 27 Aug 2015 12:53:37 +0000"  >&lt;p&gt;We really want to remove the following and count on &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-5799&quot; title=&quot;When registering as the leader, if an existing ephemeral registration exists, wait a short time to see if it goes away.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-5799&quot;&gt;&lt;del&gt;SOLR-5799&lt;/del&gt;&lt;/a&gt;. This is really a mistake. This patch probably also still makes sense as well though.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &lt;span class=&quot;code-comment&quot;&gt;// first we delete the node advertising the old leader in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the ephem is still there
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        zkClient.delete(context.leaderPath, -1, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (KeeperException.NoNodeException nne){
        &lt;span class=&quot;code-comment&quot;&gt;//no problem
&lt;/span&gt;      }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e){
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
        &lt;span class=&quot;code-comment&quot;&gt;//failed to delete the leader node
&lt;/span&gt;        log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;leader elect delete error&quot;&lt;/span&gt;,e);
        retryElection(context, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        &lt;span class=&quot;code-comment&quot;&gt;// fine
&lt;/span&gt;      } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14718432" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 12:14:25 +0000"  >&lt;p&gt;Here is a patch merging everything together for trunk.&lt;/p&gt;

&lt;p&gt;We no longer delete the advertised leader node - too dangerous. We also do better at stopping elections from living across session expiration reconnects.&lt;/p&gt;</comment>
                            <comment id="14720117" author="mewmewball" created="Fri, 28 Aug 2015 16:21:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, not sure if this is intended--looks like the newly added ShardLeaderElectionContextBase.cancelElection now blindly deletes the leader node, which sounds just as dangerous. From your comment it seems like you just wanted it to expire out, so I&apos;m wondering if it&apos;s just a merge bug or something.&lt;/p&gt;

&lt;p&gt;In general, I think it&apos;d make a lot of sense to predicate the writing of the leader node on the election node still having the same session as the thread thinks (using the same zookeeper multi-transactional semantics as in ZkController.markShardAsDownIfLeader), so that a thread that went GCing before writing the leader node will fail when it comes back since its election node will have expired. &lt;/p&gt;</comment>
                            <comment id="14720206" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 16:41:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Mark Miller, not sure if this is intended--looks like the newly added ShardLeaderElectionContextBase.cancelElection now blindly deletes the leader node, which sounds just as dangerous. From your comment it seems like you just wanted it to expire out, so I&apos;m wondering if it&apos;s just a merge bug or something.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, it seems we need it because sometimes the leader is lost without an expiration. Some tests won&apos;t pass without. I think this is why that first delete was put in - a quick fix.&lt;/p&gt;

&lt;p&gt;We do want to make sure we only remove our own registration though. We should be able to track that with the znode version and ensure we don&apos;t remove another candidate&apos;s entry with an optimistic delete?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;In general, I think it&apos;d make a lot of sense to predicate the writing of the leader node on the election node still having the same session as the thread thinks (using the same zookeeper multi-transactional semantics as in ZkController.markShardAsDownIfLeader), so that a thread that went GCing before writing the leader node will fail when it comes back since its election node will have expired.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That sounds like a good idea as well.&lt;/p&gt;</comment>
                            <comment id="14720220" author="mewmewball" created="Fri, 28 Aug 2015 16:50:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;We do want to make sure we only remove our own registration though. We should be able to track that with the znode version and ensure we don&apos;t remove another candidate&apos;s entry with an optimistic delete?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sounds good!&lt;/p&gt;

&lt;p&gt;Thanks for clarifying!&lt;/p&gt;</comment>
                            <comment id="14720238" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 17:02:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;using the same zookeeper multi-transactional semantics as in ZkController.markShardAsDownIfLeader)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm ... is there an easy way to check session id this way though? Perhaps we should open up a new issue to try for this improvement.&lt;/p&gt;</comment>
                            <comment id="14720244" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 17:03:22 +0000"  >&lt;p&gt;Another patch that only deletes a registered leader node if the current election context owns it.&lt;/p&gt;</comment>
                            <comment id="14720336" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 18:02:11 +0000"  >&lt;p&gt;I&apos;m also sad to not see a way to get the version back from a created node? Just the path?&lt;/p&gt;</comment>
                            <comment id="14720410" author="mewmewball" created="Fri, 28 Aug 2015 18:58:41 +0000"  >&lt;p&gt;Ah, well, &quot;create&quot; means version is 0 (or whatever initial version is) right? Otherwise you get a NodeExists back. Hmm...&lt;/p&gt;</comment>
                            <comment id="14720425" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 19:15:07 +0000"  >&lt;p&gt;I did not know you could count on that, but good point, I&apos;ll read up on versions again and work that in.&lt;/p&gt;</comment>
                            <comment id="14720466" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 19:48:59 +0000"  >&lt;p&gt;Okay, here is a more bullet proof idea perhaps.&lt;/p&gt;

&lt;p&gt;We use the multi to create the leader znode and get the cversion of the parent node of the leader znode.&lt;/p&gt;

&lt;p&gt;We then conditionally delete on cancel with multi again, conditional on the parent nodes cversion.&lt;/p&gt;

&lt;p&gt;Rough patch attached.&lt;/p&gt;</comment>
                            <comment id="14720563" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 20:59:39 +0000"  >&lt;p&gt;No, they don&apos;t let you compare the cversion on the part where we use the multi to delete - darn.&lt;/p&gt;</comment>
                            <comment id="14720713" author="mewmewball" created="Fri, 28 Aug 2015 22:46:01 +0000"  >&lt;p&gt;Since you&apos;re doing a setData on the parent (and thereby bumping the parent&apos;s version) each time  you create the leaderPath, you should be able to rely on the parent&apos;s version as well, instead of its cversion.&lt;/p&gt;

&lt;p&gt;Since you&apos;re doing the multi already, might as well add &quot;ops.add(Op.check(leaderSeqPath, -1));&quot; right before the Op.create?&lt;/p&gt;</comment>
                            <comment id="14720759" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 23:11:24 +0000"  >&lt;p&gt;Yeah, I tried that trick after some googling, but the parent version and cversion seem to move out of the sync. I have not spotted why yet, but it seems to tricky to enforce or test. Running low on options though.&lt;/p&gt;</comment>
                            <comment id="14720891" author="mewmewball" created="Sat, 29 Aug 2015 01:36:01 +0000"  >&lt;p&gt;The parent&apos;s cversion will change if the child node expires, whereas in this case the version won&apos;t change--so they won&apos;t be in sync. But that&apos;s ok. Are you seeing any case where while the leader node stayed there (didn&apos;t change) that the parent version changed?&lt;/p&gt;</comment>
                            <comment id="14721122" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 14:26:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;But that&apos;s ok.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay, so I had a slightly different thought in my head. Now I understand what you meant. That works I think.&lt;/p&gt;

&lt;p&gt;I just have to figure out why the leader rebalance test is failing, but otherwise I think this works.&lt;/p&gt;</comment>
                            <comment id="14721140" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 15:25:28 +0000"  >&lt;p&gt;Man, this leader rebalance stuff looks really hairy. Not much appetite to dig into it. I&apos;m already spotting likely bugs and odd things.&lt;/p&gt;</comment>
                            <comment id="14721142" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 15:43:03 +0000"  >&lt;p&gt;Blah. Perhaps it&apos;s working now.&lt;/p&gt;

&lt;p&gt;Rough patch attached.&lt;/p&gt;</comment>
                            <comment id="14721160" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 17:18:23 +0000"  >&lt;p&gt;Still some issue with rebalance leaders.&lt;/p&gt;</comment>
                            <comment id="14721287" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 23:16:11 +0000"  >&lt;p&gt;Okay, still in rough edges shape, but this patch should address everything.&lt;/p&gt;

&lt;p&gt;We do have to move the advertised leader node in zk so that we can have a shard specific non ephemeral version to track.&lt;/p&gt;

&lt;p&gt;Perhaps in 5x we can also just still write that data to the now parent node?&lt;/p&gt;
</comment>
                            <comment id="14721293" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 23:32:59 +0000"  >&lt;blockquote&gt;
&lt;p&gt;So, machine1 won the race with machine2 and declared its leadership and created the nodes. However, machine3 has just deleted them, and recreated them for itself. So machine1 and machine3 both believe they are the leader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is an interesting state. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=miketroberts&quot; class=&quot;user-hover&quot; rel=&quot;miketroberts&quot;&gt;miketroberts&lt;/a&gt;, do you have any notes on the following behavior in this state? Other nodes should consider the leader whoever is advertised in ZK as that is what lookups will return. Even the leader that did not win the advertisement should consider the winning node the real leader, and in cases updates came in anyway, our defensive checks should prevent the losing leader from accepting anything?&lt;/p&gt;

&lt;p&gt;In any case, the latest patch should use ZK to ensure only one node can ever think it&apos;s the leader.&lt;/p&gt;</comment>
                            <comment id="14721317" author="markrmiller@gmail.com" created="Sun, 30 Aug 2015 00:41:11 +0000"  >&lt;p&gt;Here is a cleaned up patch with all tests passing.&lt;/p&gt;</comment>
                            <comment id="14723484" author="markrmiller@gmail.com" created="Mon, 31 Aug 2015 14:42:29 +0000"  >&lt;p&gt;Let me know what you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mewmewball&quot; class=&quot;user-hover&quot; rel=&quot;mewmewball&quot;&gt;mewmewball&lt;/a&gt;. I think this is pretty close.&lt;/p&gt;</comment>
                            <comment id="14723682" author="mewmewball" created="Mon, 31 Aug 2015 16:54:58 +0000"  >&lt;p&gt;This looks good to me.&lt;/p&gt;

&lt;p&gt;The two comments I have are the following:&lt;br/&gt;
1. It&apos;d be good to add some &quot;explanation/documentation&quot; type comment in ElectionContext to describe what we&apos;re trying to accomplish with the zk multi-transaction. For example, why can we rely on the parent version, etc.&lt;br/&gt;
2. Will the change to the leaderProps in ZkController (adding CORE_NODE_NAME_PROP) make this change non-backwards compatible?&lt;/p&gt;

&lt;p&gt;Related but unrelated--how do you guys usually make line comments in a JIRA patch situation? Here I only have two comments so it&apos;s pretty tractable, but I can see it being difficult if it&apos;s a large change, etc.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14723753" author="markrmiller@gmail.com" created="Mon, 31 Aug 2015 17:36:23 +0000"  >&lt;blockquote&gt;
&lt;p&gt;2. Will the change to the leaderProps in ZkController (adding CORE_NODE_NAME_PROP) make this change non-backwards compatible?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s kind of an internal API, but we could accept both for 5x.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;how do you guys usually make line comments in a JIRA patch situation? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I signed us up for ReviewBoard sometime back.&lt;/p&gt;

&lt;p&gt;It has the downside of splitting the discussion between JIRA and ReviewBoard and never really got much traction.&lt;/p&gt;

&lt;p&gt;I tried to jump start it anyway because of two key features:&lt;/p&gt;

&lt;p&gt;1. Line comments&lt;br/&gt;
2. Ability to easily see diffs between patches&lt;/p&gt;

&lt;p&gt;I&apos;d be happy to put any patch on it by request.&lt;/p&gt;</comment>
                            <comment id="14725371" author="elyograg" created="Tue, 1 Sep 2015 13:15:16 +0000"  >&lt;p&gt;Being able to see diffs between patches would be pretty awesome.  I have on occasion used diff on patches in bash, but without color syntax highlighting, it&apos;s hard to read.  Something that would be really cool for that particular use case is multiple colors, not just two &amp;#8211; one color set for the additions and removals in the underlying patch, one for the differences between the patches.  I&apos;m thinking about another color set for parts of the text where the two overlap, but until I actually see it, I don&apos;t know if that would truly be useful.&lt;/p&gt;

&lt;p&gt;I saw things on the mailing list about ReviewBoard, but it didn&apos;t jump out as directly useful to me.  I will pay more attention the next time something shows up from it.&lt;/p&gt;</comment>
                            <comment id="14725626" author="markrmiller@gmail.com" created="Tue, 1 Sep 2015 16:06:40 +0000"  >&lt;p&gt;Okay, I think we are ready to commit this.&lt;/p&gt;

&lt;p&gt;For 5x I will accept NODE_NAME as well as CORE_NODE_NAME for the rebalance API and write the current leader info to the old registration node as well.&lt;/p&gt;</comment>
                            <comment id="14725634" author="jira-bot" created="Tue, 1 Sep 2015 16:13:39 +0000"  >&lt;p&gt;Commit 1700603 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1700603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1700603&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7844&quot; title=&quot;Zookeeper session expiry during shard leader election can cause multiple leaders.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7844&quot;&gt;&lt;del&gt;SOLR-7844&lt;/del&gt;&lt;/a&gt;: Zookeeper session expiry during shard leader election can cause multiple leaders.&lt;/p&gt;</comment>
                            <comment id="14727611" author="markrmiller@gmail.com" created="Wed, 2 Sep 2015 16:48:24 +0000"  >&lt;p&gt;Here is the 5x patch.&lt;/p&gt;</comment>
                            <comment id="14727664" author="jira-bot" created="Wed, 2 Sep 2015 17:21:38 +0000"  >&lt;p&gt;Commit 1700853 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; in branch &apos;dev/branches/branch_5x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1700853&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1700853&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-7844&quot; title=&quot;Zookeeper session expiry during shard leader election can cause multiple leaders.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-7844&quot;&gt;&lt;del&gt;SOLR-7844&lt;/del&gt;&lt;/a&gt;: Zookeeper session expiry during shard leader election can cause multiple leaders.&lt;/p&gt;</comment>
                            <comment id="14727665" author="markrmiller@gmail.com" created="Wed, 2 Sep 2015 17:22:18 +0000"  >&lt;p&gt;Thanks guys!&lt;/p&gt;</comment>
                            <comment id="15103645" author="shaie" created="Sun, 17 Jan 2016 09:58:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt; this seems to break upgrading existing 5x (e.g. 5.3) clusters to 5.4, unless I missed a &quot;migration&quot; step. If you&apos;re doing a rolling upgrade, such that you take one of the nodes down, replace the JARs to 5.4 and restart the node, you&apos;ll see such exceptions:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.solr.common.SolrException: Error getting leader from zk for shard shard1
    at org.apache.solr.cloud.ZkController.getLeader(ZkController.java:1034)
    at org.apache.solr.cloud.ZkController.register(ZkController.java:940)
    at org.apache.solr.cloud.ZkController.register(ZkController.java:883)
    at org.apache.solr.core.ZkContainer$2.run(ZkContainer.java:184)
    at org.apache.solr.core.ZkContainer.registerInZk(ZkContainer.java:213)
    at org.apache.solr.core.CoreContainer.registerCore(CoreContainer.java:696)
    at org.apache.solr.core.CoreContainer.create(CoreContainer.java:750)
    at org.apache.solr.core.CoreContainer.create(CoreContainer.java:716)
    at org.apache.solr.handler.admin.CoreAdminHandler.handleCreateAction(CoreAdminHandler.java:623)
    at org.apache.solr.handler.admin.CoreAdminHandler.handleRequestInternal(CoreAdminHandler.java:204)
    at org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:184)
    at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:156)
    at org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:664)
    at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:438)
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:222)
    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:181)
        ...
Caused by: org.apache.solr.common.SolrException: Could not get leader props
    at org.apache.solr.cloud.ZkController.getLeaderProps(ZkController.java:1081)
    at org.apache.solr.cloud.ZkController.getLeaderProps(ZkController.java:1045)
    at org.apache.solr.cloud.ZkController.getLeader(ZkController.java:1001)
    ... 35 more
Caused by: org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /collections/acg-test-1/leaders/shard1/leader
    at org.apache.zookeeper.KeeperException.create(KeeperException.java:111)
    at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
    at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1155)
    at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:345)
    at org.apache.solr.common.cloud.SolrZkClient$7.execute(SolrZkClient.java:342)
    at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:61)
    at org.apache.solr.common.cloud.SolrZkClient.getData(SolrZkClient.java:342)
    at org.apache.solr.cloud.ZkController.getLeaderProps(ZkController.java:1059)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the 5.4 nodes come up, they don&apos;t find &lt;tt&gt;/collections/coll/shard/leader1&lt;/tt&gt; path and fail. I am not quite sure how to recover this though, since the cluster has a mixture of 5.3 and 5.4 nodes. I cannot create &lt;tt&gt;.../shard1/leader&lt;/tt&gt; since &lt;tt&gt;../shard1&lt;/tt&gt; is an EPHEMERAL node and therefore can&apos;t create child nodes. I am not sure what will happen if I delete &quot;../shard1&quot; and recreate it as non EPHEMERAL, will the old 5.3 nodes work? I also need to ensure that the new 5.4 node doesn&apos;t become the leader if it wasn&apos;t already.&lt;/p&gt;

&lt;p&gt;Perhaps a fix would be for 5.4 to fallback to read the leader info from &quot;../shard1&quot;? Then when the last 5.3 node is down, the leader will be attempted by a 5.4 node which will recreate the leader path according to the 5.4 format? Should this have been a zk version change?&lt;/p&gt;

&lt;p&gt;I&apos;d appreciate some guidance here.&lt;/p&gt;</comment>
                            <comment id="15103781" author="shaie" created="Sun, 17 Jan 2016 16:37:00 +0000"  >&lt;p&gt;I think that if we also check for the leader under &quot;/shard1&quot; as a fallback, the situation will resolve itself? I.e. the new 5.4 nodes will come up finding a leader. When that leader dies, the &quot;shard1&quot; EPHEMERAL node will be deleted, and a 5.4 node will create the proper structure in ZK? What do you think?&lt;/p&gt;</comment>
                            <comment id="15103909" author="markrmiller@gmail.com" created="Sun, 17 Jan 2016 20:29:26 +0000"  >&lt;p&gt;Yeah, 5x needs a little bridge back compat that checks the old location if the new one does not exist.&lt;/p&gt;

&lt;p&gt;We don&apos;t have any tests at all for rolling updates, so it is all a bit hit or miss, but I believe that should work out fine.&lt;/p&gt;</comment>
                            <comment id="15103923" author="shaie" created="Sun, 17 Jan 2016 21:07:40 +0000"  >&lt;p&gt;Where is the best place to check that in your opinion? If we do something in &lt;tt&gt;ZkStateReader.getLeaderPath()&lt;/tt&gt;, then we cover both &lt;tt&gt;ZkController.getLeaderProps()&lt;/tt&gt; and also &lt;tt&gt;ShardLeaderElectionContextBase&lt;/tt&gt;. As I see it, the latter may also log failures to remove a leader node, while attempting to delete &quot;shard1/leader&quot;.&lt;/p&gt;

&lt;p&gt;So in &lt;tt&gt;ZkStateReader.getLeaderPath()&lt;/tt&gt;, we can perhaps check if &quot;shard1&quot; is an ephemeral node (looking at its &lt;tt&gt;ephemeralOwner&lt;/tt&gt; value &amp;#8211; 0 means it&apos;s not an ephemeral node), it means this is a pre-5.4 leader, and we return it as the leader path? Otherwise, we return shard1/leader?&lt;/p&gt;

&lt;p&gt;Am I over-thinking it, and this only needs to be handled in &lt;tt&gt;ZkController.getLeaderProps()&lt;/tt&gt;, catching &lt;tt&gt;NoNodeException&lt;/tt&gt; and attempting to read the props from the parent? I ask because I&apos;m not sure what role &lt;tt&gt;ShardLeaderElectionContextBase&lt;/tt&gt; plays here.&lt;/p&gt;</comment>
                            <comment id="15103928" author="markrmiller@gmail.com" created="Sun, 17 Jan 2016 21:21:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;Am I over-thinking it, and this only needs to be handled in ZkController.getLeaderProps(), catching NoNodeException and attempting to read the props from the parent?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think so.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I ask because I&apos;m not sure what role ShardLeaderElectionContextBase plays here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This sets where it will get written out. We don&apos;t need to change that, we want to write out to the new spot, so I think the above is probably all that needs to be done with an initial glance over.&lt;/p&gt;</comment>
                            <comment id="15104139" author="shaie" created="Mon, 18 Jan 2016 04:10:57 +0000"  >&lt;p&gt;Reopening to adddress &quot;upgrade from 5.3&quot; issue.&lt;/p&gt;</comment>
                            <comment id="15104140" author="shaie" created="Mon, 18 Jan 2016 04:11:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markrmiller%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;markrmiller@gmail.com&quot;&gt;markrmiller@gmail.com&lt;/a&gt;, can you please review this patch? If it looks OK to you, I&apos;d like to try get it out in 5.4.1.&lt;/p&gt;</comment>
                            <comment id="15104142" author="markrmiller@gmail.com" created="Mon, 18 Jan 2016 04:14:03 +0000"  >&lt;p&gt;I can look in the morning. We should use the other issue and just link to this one. This issue is released and essentially frozen now. &lt;/p&gt;</comment>
                            <comment id="15104144" author="shaie" created="Mon, 18 Jan 2016 04:16:37 +0000"  >&lt;p&gt;OK I will open a separate issue.&lt;/p&gt;</comment>
                            <comment id="15104148" author="shaie" created="Mon, 18 Jan 2016 04:20:15 +0000"  >&lt;p&gt;Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8561&quot; title=&quot;Add fallback to ZkController.getLeaderProps for a mixed 5.4-pre-5.4 deployments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8561&quot;&gt;&lt;del&gt;SOLR-8561&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12753799" name="SOLR-7844-5x.patch" size="38396" author="markrmiller@gmail.com" created="Wed, 2 Sep 2015 16:48:24 +0000"/>
                            <attachment id="12753549" name="SOLR-7844.patch" size="36077" author="markrmiller@gmail.com" created="Tue, 1 Sep 2015 16:06:40 +0000"/>
                            <attachment id="12753161" name="SOLR-7844.patch" size="35406" author="markrmiller@gmail.com" created="Sun, 30 Aug 2015 00:41:11 +0000"/>
                            <attachment id="12753156" name="SOLR-7844.patch" size="36261" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 23:16:11 +0000"/>
                            <attachment id="12753143" name="SOLR-7844.patch" size="21286" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 16:50:45 +0000"/>
                            <attachment id="12753142" name="SOLR-7844.patch" size="17445" author="markrmiller@gmail.com" created="Sat, 29 Aug 2015 15:43:03 +0000"/>
                            <attachment id="12753059" name="SOLR-7844.patch" size="12461" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 19:49:09 +0000"/>
                            <attachment id="12753025" name="SOLR-7844.patch" size="10402" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 17:03:22 +0000"/>
                            <attachment id="12752985" name="SOLR-7844.patch" size="8650" author="markrmiller@gmail.com" created="Fri, 28 Aug 2015 12:14:25 +0000"/>
                            <attachment id="12752587" name="SOLR-7844.patch" size="4403" author="miketroberts" created="Wed, 26 Aug 2015 22:10:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i14v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>