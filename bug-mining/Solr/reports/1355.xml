<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:35:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4648] Create a PreAnalyzedUpdateProcessor</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4648</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Spin-off from the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4619&quot; title=&quot;Improve PreAnalyzedField query analysis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4619&quot;&gt;&lt;del&gt;SOLR-4619&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Instead of using a PreAnalyzedField type we can use an UpdateRequestProcessor that converts any input field values to StorableField-s, using the PreAnalyzedParser-s, and then directly passes StorableField-s to DocumentBuilder for indexing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639392">SOLR-4648</key>
            <summary>Create a PreAnalyzedUpdateProcessor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Mar 2013 17:12:08 +0000</created>
                <updated>Mon, 9 May 2016 18:55:42 +0000</updated>
                            <resolved>Fri, 5 Apr 2013 09:51:17 +0000</resolved>
                                    <version>4.3</version>
                    <version>6.0</version>
                                    <fixVersion>4.3</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>update</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13615636" author="ab" created="Wed, 27 Mar 2013 18:58:00 +0000"  >&lt;p&gt;Patch and unit test.&lt;/p&gt;</comment>
                            <comment id="13615640" author="ab" created="Wed, 27 Mar 2013 19:03:06 +0000"  >&lt;p&gt;Oops, this needs to be visible after all...&lt;/p&gt;</comment>
                            <comment id="13617342" author="dsmiley" created="Fri, 29 Mar 2013 13:53:15 +0000"  >&lt;p&gt;Great start Andrzej!&lt;/p&gt;

&lt;p&gt;Reviewing the patch...&lt;/p&gt;

&lt;p&gt;I think PreAnalyzedUpdateProcessorFactory should extend &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=janhoy&quot; class=&quot;user-hover&quot; rel=&quot;janhoy&quot;&gt;janhoy&lt;/a&gt;&apos;s FieldMutatingUpdateProcessorFactory, which will shorten some of your code and give it more flexibility on how fields are matched.&lt;/p&gt;

&lt;p&gt;In PreAnalyzedField line 112:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error parsing pre-analyzed field &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt; + field.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt;: &quot;&lt;/span&gt; + e.toString());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Shouldn&apos;t you pass &apos;e&apos; as the last arg to warn()?&lt;/p&gt;

&lt;p&gt;It would be interesting to test this against the example Solr schema with pre-analyzing every field to see if it works, comparing the index output using the SimpleTextCodec.  I strongly suspect it won&apos;t, since there is more to the state of a Field than it&apos;s tokenStream and stored value &amp;#8211; which seem to be the only thing the code in this patch accounts for.  For example its &apos;type&apos; (Lucene FieldType).&lt;/p&gt;

&lt;p&gt;In summary, great start!&lt;/p&gt;
</comment>
                            <comment id="13617463" author="ab" created="Fri, 29 Mar 2013 16:08:38 +0000"  >&lt;p&gt;David, thanks for the review. I&apos;ll prepare a new patch, using the FieldMutatingUP* classes - indeed, I missed them and they help a lot.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;since there is more to the state of a Field than it&apos;s tokenStream and stored value...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I can try creating the StorableField using the SchemaField.createField(...) for this field&apos;s type, so that most of its state will be specific to the declared schema field, and the only mutations will be to set the optional stringValue and the tokenStreamValue, and to flip the type flags accordingly.&lt;/p&gt;</comment>
                            <comment id="13620863" author="ab" created="Wed, 3 Apr 2013 11:45:39 +0000"  >&lt;p&gt;Updated patch, using FieldMutatingUP*, more tests and javadocs.&lt;/p&gt;</comment>
                            <comment id="13621024" author="dsmiley" created="Wed, 3 Apr 2013 16:21:19 +0000"  >&lt;p&gt;Feedback on your patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;in Solr, it&apos;s bad form to call Class.forName() as you&apos;re doing in PreAnalzyedField; you&apos;re supposed to use the SolrResourceLoader instead.  Instead use &lt;tt&gt;schema.getResourceLoader().findClass(implName, PreAnalyzedParser.class);&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;minor: you&apos;re using 4-spaces indent instead of 2 in the main value loop in your URP&lt;/li&gt;
	&lt;li&gt;in those log.debug() calls, it&apos;s creating the string to potentially not even log it.  Instead use this feature of SLF4J: &lt;tt&gt;log.debug(&quot;Ignoring stored part - field &apos;{}&apos; is not stored.&quot;, sf.getName());&lt;/tt&gt;  So few people use that great feature of SLF4J and instead rely on more bulky surrounding conditionals.&lt;/li&gt;
	&lt;li&gt;When you call sf.createFields(o, 1.0f) in the URP, isn&apos;t this doing analysis &amp;#8211; the very analysis that you&apos;re trying to avoid by pre-analyzing?  It is.  And isn&apos;t &apos;o&apos; the JSON or similar representation of the analyzed token stream, and thus shouldn&apos;t be passed in here?  When I run your test, I get a logged error because of this, actually.  Stepping through with a debugger further validated this.  This must be remedied.  Looking at what FieldType.createField() is doing, I propose you do the same in this URP:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.lucene.document.FieldType newType = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.lucene.document.FieldType();
    newType.setIndexed(field.indexed());
    newType.setTokenized(field.isTokenized());
    newType.setStored(field.stored());
    newType.setOmitNorms(field.omitNorms());
    newType.setIndexOptions(getIndexOptions(field, val));
    newType.setStoreTermVectors(field.storeTermVector());
    newType.setStoreTermVectorOffsets(field.storeTermOffsets());
    newType.setStoreTermVectorPositions(field.storeTermPositions());
&lt;span class=&quot;code-comment&quot;&gt;//getIndexOptions() is:
&lt;/span&gt;    IndexOptions options = IndexOptions.DOCS_AND_FREQS_AND_POSITIONS;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (field.omitTermFreqAndPositions()) {
      options = IndexOptions.DOCS_ONLY;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (field.omitPositions()) {
      options = IndexOptions.DOCS_AND_FREQS;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (field.storeOffsetsWithPositions()) {
      options = IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS;
    }
&lt;span class=&quot;code-comment&quot;&gt;//then what createField() does is:
&lt;/span&gt;    Field f = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Field(name, val, type);
    f.setBoost(boost);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This won&apos;t work for all field types (e.g. numbers) but it will for TextField (the one with analysis!) and could potentially for a custom FieldType.  I don&apos;t think we should put much if any work into supporting other FieldTypes.&lt;/p&gt;

&lt;p&gt;The resulting &quot;Field&quot; instance can be shared from one document to the next I believe, and so you can cache this in the URP and reset its value &amp;amp; tokenStream.&lt;/p&gt;</comment>
                            <comment id="13622080" author="ab" created="Thu, 4 Apr 2013 12:21:04 +0000"  >&lt;p&gt;Thanks again for a thorough review. New patch is attached.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in Solr, it&apos;s bad form to call Class.forName() ..&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;minor: you&apos;re using 4-spaces indent instead of 2 in the main value loop in your URP&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed (it was actually a left-over from removing an outer-level loop, all other indents are 2 spaces).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in those log.debug() calls, it&apos;s creating the string to potentially not even log it&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Looking at what FieldType.createField() is doing, I propose you do the same in this URP ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Funny thing, I had this in one version of the patch, and then decided to reuse SF.createField(..) to avoid code duplication. The problem is that SchemaField.isTokenized() has package-level visibility so it&apos;s not visible in the UP&apos;s package. I fixed this by providing a utility method in PreAnalyzedField to create a FieldType. Also, I moved there the chunk of logic for setting / resetting the Field content and type flags based on SchemaField. Overall, it simplifies the UP.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The resulting &quot;Field&quot; instance can be shared from one document to the next I believe, and so you can cache this in the URP and reset its value &amp;amp; tokenStream.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, this doesn&apos;t seem feasible at all. First, this cache would have to be thread safe, and prevent reuse of Field instances until the document is actually processed by IndexWriter - I don&apos;t think there&apos;s a mechanism to enforce this in the context of this class? Also it would have to cache multiple instances of Field, because processing a single document may result in creating multiple instances (at least one per pre-analyzed field, more if fields are multi-valued).&lt;/p&gt;</comment>
                            <comment id="13622621" author="dsmiley" created="Thu, 4 Apr 2013 18:26:31 +0000"  >&lt;p&gt;I like how your refactoring has clarified the logic in the URP.  And I like your new PreAnalyzedUpdateProcessorFactory.createFieldType() method.&lt;/p&gt;

&lt;p&gt;I think you&apos;re right that sharing Field instances isn&apos;t such a good idea after all.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;minor: in the URP, &quot;for (Object o : src.getValues()) {&quot; can be &quot;for (Object o : src) {&quot;  since it implements Iterable, and for the single-value case avoids redundant collection wrapping.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The remaining thing I&apos;m thinking of is wether PreAnalyzedUpdateProcessorFactory.createFieldType() should move down into Solr&apos;s FieldType where it can be re-used so we don&apos;t duplicate this code.  Seems pretty clear this is a good idea.  Then, I&apos;m wondering if these Lucene FieldType instances could be cached on Solr&apos;s SchemaField so that they don&apos;t have to be needlessly re-created for each indexed value that runs through Solr.  The only obstacle I see to this is that getIndexOptions(field,val) takes the value, and if that value were to alter the logic then the FieldType can&apos;t be shared.  This is a protected method and I don&apos;t see anything that overrides it, and the default implementation doesn&apos;t use the value.  I&apos;ll create another issue for that; I can get off track easily and try to fix the world in one issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13622672" author="ab" created="Thu, 4 Apr 2013 19:15:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;minor: in the URP, &quot;for (Object o : src.getValues()) {&quot; can be &quot;for (Object o : src) {&quot; since it implements Iterable&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ll fix this before committing. Thanks again for the review.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;PreAnalyzedUpdateProcessorFactory.createFieldType() ..&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to create a separate issue.&lt;/p&gt;</comment>
                            <comment id="13623486" author="ab" created="Fri, 5 Apr 2013 09:51:17 +0000"  >&lt;p&gt;Committed to trunk in rev. 1464889.&lt;br/&gt;
Committed to branch_4x in rev. 1464902.&lt;/p&gt;</comment>
                            <comment id="13653885" author="thetaphi" created="Fri, 10 May 2013 10:33:17 +0000"  >&lt;p&gt;Closed after release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576969" name="SOLR-4648.patch" size="25818" author="ab" created="Thu, 4 Apr 2013 12:19:53 +0000"/>
                            <attachment id="12576772" name="SOLR-4648.patch" size="20216" author="ab" created="Wed, 3 Apr 2013 11:45:39 +0000"/>
                            <attachment id="12575746" name="SOLR-4648.patch" size="16780" author="ab" created="Wed, 27 Mar 2013 19:03:06 +0000"/>
                            <attachment id="12575745" name="SOLR-4648.patch" size="16510" author="ab" created="Wed, 27 Mar 2013 18:58:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>319862</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j6un:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320203</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>