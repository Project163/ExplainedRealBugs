<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:10:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-17369] FunctionQParser&apos;s $param derefrencing ignores flags: breaks two arg vectorSimilarity() function for BYTE fields when constant vec is param ref</title>
                <link>https://issues.apache.org/jira/browse/SOLR-17369</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;A coworker of mine recently ran into a problem that I believe stems from the way &lt;tt&gt;FunctionQParser&lt;/tt&gt; recursively parses param references.&lt;/p&gt;

&lt;p&gt;When it creates the &lt;tt&gt;subParser&lt;/tt&gt; that it uses, it does not set it&apos;s current &quot;flags&quot; on that parser...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &#160;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; ValueSource parseValueSource(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; flags) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SyntaxError {
...
  &#160; } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ch == &lt;span class=&quot;code-quote&quot;&gt;&apos;$&apos;&lt;/span&gt;) {
  &#160; &#160; sp.pos++;
&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; param = sp.getId();
&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; val = getParam(param);
...
&#160; &#160; &#160; &#160; QParser subParser = subQuery(val, &lt;span class=&quot;code-quote&quot;&gt;&quot;func&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subParser &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FunctionQParser) {
&#160; &#160; &#160; &#160; &#160; ((FunctionQParser) subParser).setParseMultipleSources(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; Query subQuery = subParser.getQuery();
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One practical problem this causes, that i&apos;ve seen &quot;in the wild&quot;, is in the 2 argument variant of the &lt;tt&gt;vectorSimilarity&lt;/tt&gt; function, where the &lt;tt&gt;VectorEncoding&lt;/tt&gt; of the first arg (the field name) is used to set a flag on the &#160;&lt;tt&gt;FunctionQParser&lt;/tt&gt;&#160; when parsing the second arg (which may be a constant vector)&lt;/p&gt;

&lt;p&gt;So something like this works fine, for either &lt;tt&gt;FLOAT32&lt;/tt&gt; or &lt;tt&gt;BYTE&lt;/tt&gt; fields...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;q={!func}vectorSimilarity(my_vec_field,[1,...,2,3])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But using a param reference like this...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;q={!func}vectorSimilarity(my_vec_field,$raw_vec)
raw_vec=[1,...,2,3]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... parses the &lt;tt&gt;raw_vec&lt;/tt&gt; param as a &lt;tt&gt;ConstKnnFloatValueSource&lt;/tt&gt; (the default) even if &lt;tt&gt;my_vec_field&lt;/tt&gt; uses &lt;tt&gt;BYTE&lt;/tt&gt; encoding.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13585664">SOLR-17369</key>
            <summary>FunctionQParser&apos;s $param derefrencing ignores flags: breaks two arg vectorSimilarity() function for BYTE fields when constant vec is param ref</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="hossman">Chris M. Hostetter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jul 2024 23:20:12 +0000</created>
                <updated>Fri, 17 Oct 2025 20:05:12 +0000</updated>
                            <resolved>Mon, 22 Jul 2024 22:06:34 +0000</resolved>
                                                    <fixVersion>9.7</fixVersion>
                    <fixVersion>10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17865610" author="hossman" created="Fri, 12 Jul 2024 23:21:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;&#160;... parses the &lt;tt&gt;raw_vec&lt;/tt&gt; param as a &lt;tt&gt;ConstKnnFloatValueSource&lt;/tt&gt; (the default) even if &lt;tt&gt;my_vec_field&lt;/tt&gt; uses &lt;tt&gt;BYTE&lt;/tt&gt; encoding.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This can manifest as the very confusing...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; java.lang.UnsupportedOperationException
	at org.apache.lucene.queries.function.FunctionValues.byteVectorVal(FunctionValues.java:79)
	at org.apache.lucene.queries.function.valuesource.ByteVectorSimilarityFunction.func(ByteVectorSimilarityFunction.java:39)
	at org.apache.lucene.queries.function.valuesource.VectorSimilarityFunction$1.floatVal(VectorSimilarityFunction.java:52)
	at org.apache.lucene.queries.function.FunctionQuery$AllScorer.score(FunctionQuery.java:130)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17867442" author="hossman" created="Fri, 19 Jul 2024 22:22:04 +0000"  >&lt;p&gt;Attaching patch with test + fix.&lt;/p&gt;

&lt;p&gt;Calling &lt;tt&gt;subParser.setFlags(flags)&lt;/tt&gt; turned out to only be alf the fix: the other problem is that the &lt;tt&gt;getQuery() -&amp;gt; parse() -&amp;gt; parseValueSource(...)&lt;/tt&gt; call chain was using &lt;tt&gt;FLAG_DEFAULT&lt;/tt&gt; directly instead of paying attention to whether the caller had modified the the flags to for &quot;this&quot; parser.&lt;/p&gt;</comment>
                            <comment id="17867847" author="hossman" created="Mon, 22 Jul 2024 18:52:56 +0000"  >&lt;p&gt;added some more tests.&lt;/p&gt;</comment>
                            <comment id="17867885" author="jira-bot" created="Mon, 22 Jul 2024 21:28:08 +0000"  >&lt;p&gt;Commit da7230a7c6095cb8d1a926c377dbb4d43a0db418 in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=da7230a7c60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=da7230a7c60&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17369&quot; title=&quot;FunctionQParser&amp;#39;s $param derefrencing ignores flags: breaks two arg vectorSimilarity() function for BYTE fields when constant vec is param ref&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17369&quot;&gt;&lt;del&gt;SOLR-17369&lt;/del&gt;&lt;/a&gt;: Fix &quot;flags&quot; usage in FunctionQParser that caused some issues in vectorSimilarity() with BYTE vector constants&lt;/p&gt;</comment>
                            <comment id="17867893" author="jira-bot" created="Mon, 22 Jul 2024 22:06:17 +0000"  >&lt;p&gt;Commit 3cab6f2756be16d4464aa6e4340e478a528a3b7f in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=3cab6f2756b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=3cab6f2756b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-17369&quot; title=&quot;FunctionQParser&amp;#39;s $param derefrencing ignores flags: breaks two arg vectorSimilarity() function for BYTE fields when constant vec is param ref&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-17369&quot;&gt;&lt;del&gt;SOLR-17369&lt;/del&gt;&lt;/a&gt;: Fix &quot;flags&quot; usage in FunctionQParser that caused some issues in vectorSimilarity() with BYTE vector constants&lt;/p&gt;

&lt;p&gt;(cherry picked from commit da7230a7c6095cb8d1a926c377dbb4d43a0db418)&lt;/p&gt;</comment>
                            <comment id="17892957" author="anshumg" created="Fri, 25 Oct 2024 17:18:57 +0000"  >&lt;p&gt;Closing after the 9.7.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13070372" name="SOLR-17369-1.patch" size="9919" author="hossman" created="Mon, 22 Jul 2024 18:52:54 +0000"/>
                            <attachment id="13070317" name="SOLR-17369.patch" size="6992" author="hossman" created="Fri, 19 Jul 2024 22:21:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qbds:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>