<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:51:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6119] TestReplicationHandler attempts to remove open folders</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6119</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;TestReplicationHandler has a weird logic around the &apos;snapDir&apos; variable. It attempts to remove snapshot folders, even though they&apos;re not closed yet. My recent patch uncovered the bug but I don&apos;t know how to fix it cleanly &amp;#8211; the test itself seems to be very fragile (for example I don&apos;t understand the &apos;namedBackup&apos; variable which is always set to true, yet there are conditionals around it).&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12717216">SOLR-6119</key>
            <summary>TestReplicationHandler attempts to remove open folders</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dweiss">Dawid Weiss</assignee>
                                    <reporter username="dweiss">Dawid Weiss</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 May 2014 05:38:50 +0000</created>
                <updated>Mon, 9 May 2016 18:55:42 +0000</updated>
                            <resolved>Thu, 5 Jun 2014 12:16:50 +0000</resolved>
                                                    <fixVersion>4.9</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14012094" author="jira-bot" created="Thu, 29 May 2014 05:43:10 +0000"  >&lt;p&gt;Commit 1598205 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1598205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1598205&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: a quick workaround for the problem of removing files that are still open during the test.&lt;/p&gt;</comment>
                            <comment id="14012096" author="jira-bot" created="Thu, 29 May 2014 05:44:00 +0000"  >&lt;p&gt;Commit 1598206 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1598206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1598206&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: a quick workaround for the problem of removing files that are still open during the test.&lt;/p&gt;</comment>
                            <comment id="14012208" author="varunthacker" created="Thu, 29 May 2014 09:04:43 +0000"  >&lt;p&gt;Patch which fixes the test.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Renamed snapDir to snapDirs to make it more evident that this test creates 2 backups in each run.&lt;/li&gt;
	&lt;li&gt;Fixed
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; namedBackup = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; namedBackup = random().nextBoolean();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Fixed 2 logical mistakes in the test&lt;/li&gt;
	&lt;li&gt;Revision 1598013 changed the logic in the finally block by trying to delete snapDir instead of each of the directories. Fixed this.&lt;br/&gt;
I ran 
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; ant test  -Dtestcase=TestReplicationHandler -Dtests.method=doTestBackup -Dtests.seed=55ADF081A0AD0544 -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=fr_FR -Dtests.timezone=America/Lower_Princes -Dtests.file.encoding=US-ASCII&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; which was reported by the Jenkins failures and it passed for me after the patch&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14012210" author="dweiss" created="Thu, 29 May 2014 09:11:35 +0000"  >&lt;p&gt;&amp;gt; Revision 1598013 changed the logic in the finally block by trying to delete snapDir instead of each of the directories.&lt;/p&gt;

&lt;p&gt;This isn&apos;t true? The change I introduced still attempted to remove all of the dirs because snapDir is/was an array. In fact, this is not really correct in the patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (File dir : snapDirs) &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(dir !=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+        TestUtil.rm(dir);
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;because the first failure will cause an IOException and cause any remaining folders not to be considered for deletion (that&apos;s why I changed it in the first place).&lt;/p&gt;

&lt;p&gt;&amp;gt; Fixed 2 logical mistakes in the test&lt;/p&gt;

&lt;p&gt;What were the logical mistakes in this test?&lt;/p&gt;</comment>
                            <comment id="14012214" author="varunthacker" created="Thu, 29 May 2014 09:19:15 +0000"  >&lt;p&gt;The logical mistakes were - &lt;br/&gt;
1. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!namedBackup &amp;amp;&amp;amp; snapDirs[0].exists()) {
  fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;The first backup should have been cleaned up because &quot;&lt;/span&gt; + backupKeepParamName + &lt;span class=&quot;code-quote&quot;&gt;&quot; was set to 1.&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This check should have been outside the for loop.&lt;/p&gt;

&lt;p&gt;2. The test deletion of named backup loop should check if namedBackup is actually true or not.&lt;/p&gt;

&lt;p&gt;Both never cropped up because namedBackup was always set to true.&lt;/p&gt;</comment>
                            <comment id="14012216" author="varunthacker" created="Thu, 29 May 2014 09:25:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dweiss&quot; class=&quot;user-hover&quot; rel=&quot;dweiss&quot;&gt;dweiss&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This isn&apos;t true? The change I introduced still attempted to remove all of the dirs because snapDir is/was an array. In fact, this is not really correct in the patch:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see what you mean. The changed around the finally block introduced in the patch is incorrect then.&lt;/p&gt;

&lt;p&gt;Let me see whats the actual problem there then.&lt;/p&gt;</comment>
                            <comment id="14012307" author="varunthacker" created="Thu, 29 May 2014 12:12:13 +0000"  >&lt;p&gt;New patch&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Doesn&apos;t change the finally block in doTestBackup. We still need to figure out whats wrong here.&lt;/li&gt;
	&lt;li&gt;Has all the fixes to doTestBackup from my previous patch.&lt;/li&gt;
	&lt;li&gt;Fixes a possible NPE in SnapShooter&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14013335" author="dweiss" created="Fri, 30 May 2014 06:05:26 +0000"  >&lt;p&gt;Varun, your patch is fine but it doesn&apos;t address the original problem. I&apos;ve added a try/finally block around rm because the backup folder cannot be removed (it&apos;s still open on Windows). I attach an updated patch that removes this block &amp;#8211; if you run it now, you should be seeing the same issue (you may need a Windows machine for this, though).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[08:00:08.376] ERROR   3.78s | TestReplicationHandler.doTestBackup &amp;lt;&amp;lt;&amp;lt;
   &amp;gt; Throwable #1: java.io.IOException: Could not remove the following files (in the order of attempts):
   &amp;gt;    C:\Work\lucene-solr-svn\trunk\solr\build\solr-core\test\J0\.\temp\solr.handler.TestReplicationHandler-B751491BC59B33CA-001\solr-instance-001\collection1\data\snapshot.eyxtuk
   &amp;gt; 
   &amp;gt; 	at __randomizedtesting.SeedInfo.seed([B751491BC59B33CA:F6DA697EE225C085]:0)
   &amp;gt; 	at org.apache.lucene.util.TestUtil.rm(TestUtil.java:118)
   &amp;gt; 	at org.apache.solr.handler.TestReplicationHandler.doTestBackup(TestReplicationHandler.java:1559)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14013348" author="dweiss" created="Fri, 30 May 2014 06:25:19 +0000"  >&lt;p&gt;The problem is in the test, here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;          BackupThread deleteBackupThread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BackupThread(backupNames[i], ReplicationHandler.CMD_DELETE_BACKUP);
          deleteBackupThread.start();
          &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; waitCnt = 0;
          CheckDeleteBackupStatus checkDeleteBackupStatus = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckDeleteBackupStatus();
          &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
            checkDeleteBackupStatus.fetchStatus();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;you run the backup threads but never wait for the backup to finish, checking the &quot;delete status&quot;. There is a race condition in there &amp;#8211; either the check for backup status should really return true after backup files are removed or the wait for the backup itself should be done in an alternative way.&lt;/p&gt;

&lt;p&gt;If you add a log to backup (before/ after) and to the finally block in the test, the wrong interleaving is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;4752 T60 oash.SnapShooter.deleteNamedSnapshot Deleting snapshot: eyxtuk
4752 T12 oash.TestReplicationHandler.doTestBackup #### --&amp;gt; DELETING (&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; block in the test)
4754 T60 oash.SnapPuller.delTree WARN Unable to delete file : C:\Users\dweiss\AppData\Local\Temp\solr.handler.TestReplicationHandler-B751491BC59B33CA-005\solr-instance-001\collection1\data\snapshot.eyxtuk\_0.cfs
4754 T60 oash.SnapShooter.deleteNamedSnapshot WARN Unable to delete snapshot: eyxtuk
4754 T60 oash.SnapShooter.deleteNamedSnapshot Deleting snapshot: eyxtuk (DONE)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the test never waits for the snapshooter.deleteNamedSnapshot to finish.&lt;/p&gt;</comment>
                            <comment id="14013384" author="varunthacker" created="Fri, 30 May 2014 07:34:35 +0000"  >&lt;p&gt;Hi Dawid,&lt;/p&gt;

&lt;p&gt;Thanks for tracking that down. Yes that does seem to be the problem.&lt;/p&gt;

&lt;p&gt;Looks like we should not be deleting the directories in the finally block if it is a named snapshot. We delete in as part of the test. Attached a patch which changes that.&lt;/p&gt;

&lt;p&gt;All of this is looking very fragile and looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6117&quot; title=&quot;Replication command=fetchindex always return success.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6117&quot;&gt;&lt;del&gt;SOLR-6117&lt;/del&gt;&lt;/a&gt; it does look like ReplicationHandler needs a overhaul.&lt;/p&gt;</comment>
                            <comment id="14015231" author="dweiss" created="Mon, 2 Jun 2014 07:34:27 +0000"  >&lt;p&gt;There seem to be other problems with this test too, do you know how to fix these, Varun? Here&apos;s my comment on the dev list for this failure:&lt;br/&gt;
&lt;a href=&quot;http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-Linux/10446/consoleText&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-Linux/10446/consoleText&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ok, I don&apos;t know what&apos;s going on but I know this sequence at the start&lt;br/&gt;
of the test:&lt;/p&gt;

&lt;p&gt;    masterJetty.stop();&lt;br/&gt;
    masterClient.shutdown();&lt;/p&gt;

&lt;p&gt;doesn&apos;t do anything to stop existing snappuller; if you breakpoint&lt;br/&gt;
after the above you still get periodic calls to:&lt;/p&gt;

&lt;p&gt;&amp;gt; org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:311)&lt;br/&gt;
&amp;gt; org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:337)&lt;br/&gt;
&amp;gt; org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:226)&lt;br/&gt;
&amp;gt; java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
&amp;gt; java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)&lt;br/&gt;
&amp;gt; java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)&lt;br/&gt;
&amp;gt; java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)&lt;br/&gt;
&amp;gt; java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
&amp;gt; java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
&amp;gt; java.lang.Thread.run(Thread.java:724)&lt;/p&gt;</comment>
                            <comment id="14015532" author="varunthacker" created="Mon, 2 Jun 2014 16:42:50 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit4] FAILURE 3.05s J1 | TestReplicationHandler.doTestBackup &amp;lt;&amp;lt;&amp;lt;
   [junit4]    &amp;gt; Throwable #1: java.lang.AssertionError: expected:&amp;lt;1&amp;gt; but was:&amp;lt;2&amp;gt;
   [junit4]    &amp;gt; 	at __randomizedtesting.SeedInfo.seed([227BE1FA9CDC834F:63F0C19FBB627000]:0)
   [junit4]    &amp;gt; 	at org.apache.solr.handler.TestReplicationHandler.doTestBackup(TestReplicationHandler.java:1513)
   [junit4]    &amp;gt; 	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The file names created are - q and qjxiogjoksvtiijnlhhm and the test conditon &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (name.startsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;snapshot.&quot;&lt;/span&gt; + backupName)) { &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; should have been equals.&lt;/p&gt;

&lt;p&gt;Patch which fixes this.&lt;/p&gt;

&lt;p&gt;Updating the patch against branch_4x.&lt;/p&gt;</comment>
                            <comment id="14016261" author="jira-bot" created="Tue, 3 Jun 2014 06:21:15 +0000"  >&lt;p&gt;Commit 1599422 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1599422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1599422&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: TestReplicationHandler attempts to remove open folders (and other fixes).&lt;/p&gt;</comment>
                            <comment id="14016263" author="dweiss" created="Tue, 3 Jun 2014 06:22:22 +0000"  >&lt;p&gt;I&apos;ve committed your latest patch, Varun, thanks. I still don&apos;t think SnapPuller should be working after &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;masterJetty.stop();
masterClient.shutdown();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but it may be my misunderstanding of Solr&apos;s infrastructure (I don&apos;t work with Solr much).&lt;/p&gt;

&lt;p&gt;Thanks for help!&lt;/p&gt;</comment>
                            <comment id="14016264" author="jira-bot" created="Tue, 3 Jun 2014 06:23:09 +0000"  >&lt;p&gt;Commit 1599423 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1599423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1599423&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: TestReplicationHandler attempts to remove open folders (and other fixes).&lt;/p&gt;</comment>
                            <comment id="14016279" author="varunthacker" created="Tue, 3 Jun 2014 06:56:33 +0000"  >&lt;p&gt;Dawid, Thanks for committing the fixes. &lt;/p&gt;

&lt;p&gt;Regarding the SnapPuller issue, I put a breakpoint on on L149 and ran the test in debug mode from my ide. When I take a thread dump after the execution pauses I don&apos;t see any SnapPuller threads. Could you tell me how to reproduce it?&lt;/p&gt;</comment>
                            <comment id="14016285" author="dweiss" created="Tue, 3 Jun 2014 07:11:47 +0000"  >&lt;p&gt;You don&apos;t see a stack trace because snap puller is invoked from a thread pool (executor service) so there&apos;s nothing in between calls. But if you put a sleep here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java
===================================================================
--- solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java      (revision 1599422)
+++ solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java      (working copy)
@@ -1329,6 +1329,9 @@
     masterClient.shutdown();
     masterClient = createNewSolrServer(masterJetty.getLocalPort());

+    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;-- Sleeping...&quot;&lt;/span&gt;);
+    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(30000);
+
     nDocs--;
     masterClient.deleteByQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;);
     &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; nDocs; i++)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then you will see that it&apos;s working, even though it perhaps shouldn&apos;t?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2830 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not available. Index fetch failed. Exception: Server refused connection at: http://127.0.0.1:55584/solr
&lt;/span&gt;3837 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not available. Index fetch failed. Exception: Server refused connection at: http://127.0.0.1:55584/solr
&lt;/span&gt;4840 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not available. Index fetch failed. Exception: Server refused connection at: http://127.0.0.1:55584/solr
&lt;/span&gt;5843 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not available. Index fetch failed. Exception: Server refused connection at: http://127.0.0.1:55584/solr
&lt;/span&gt;6846 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not available. Index fetch failed. Exception: Server refused connection at: http://127.0.0.1:55584/solr&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The executor service should be terminated (and is in SnapPuller#destroy()), but I don&apos;t think this code is invoked. In fact, I don&apos;t quite get this snippet of code in doTestBackup:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    masterJetty.stop();
    master.copyConfigFile(CONF_DIR + configFile,
                          &lt;span class=&quot;code-quote&quot;&gt;&quot;solrconfig.xml&quot;&lt;/span&gt;);

    masterJetty = createJetty(master);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What is all this stopping/starting for? To restart jetty in a different config? If so, it should really be part of a per-test fixture rather than per-suite fixture. Just my two cents.&lt;/p&gt;</comment>
                            <comment id="14017024" author="varunthacker" created="Tue, 3 Jun 2014 19:19:11 +0000"  >&lt;p&gt;Dawid, Thanks for the detailed explanation.&lt;/p&gt;

&lt;p&gt;Looks like the main problem is doTestBackup() is not a Replication test. All the other tests in this class use 2 Jettys ( masterJetty and slaveJetty ) and have replication tests. doTestBackup()  is testing index backups and deletes.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2830 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;These are calls made from the slaveJetty trying to connect to the masterJetty. But in doTestBackup like many other tests in the suite we restart masterJetty after which slaveJetty is unable to connect to the old master anymore. The other tests stop and start the slaveJetty after the master has been restarted correctly thus the problem is not seen.&lt;/p&gt;

&lt;p&gt;So there are two solutions - &lt;br/&gt;
1. stop/start the slave jetty in doTestBackup() for it to connect to the new master jetty.&lt;br/&gt;
2. break it out into another test class where slave jetty won&apos;t be required.&lt;/p&gt;</comment>
                            <comment id="14017043" author="dweiss" created="Tue, 3 Jun 2014 19:38:32 +0000"  >&lt;p&gt;Thanks for clarifying, Varun. I think we can leave the test in the same class, but at least shut down the slave jetty and provide a single-line comment of what those shutdowns are for (in the code). I&apos;m sure it&apos;ll be of help in the future for somebody browsing through the code!&lt;/p&gt;</comment>
                            <comment id="14017080" author="varunthacker" created="Tue, 3 Jun 2014 20:18:21 +0000"  >&lt;p&gt;Patch against trunk which moves the test to a new class. I feel this is cleaner. &lt;/p&gt;

&lt;p&gt;I&apos;ll try out option 2 also&lt;/p&gt;</comment>
                            <comment id="14017097" author="varunthacker" created="Tue, 3 Jun 2014 20:25:39 +0000"  >&lt;p&gt;Adding &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;slaveJetty.stop()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; right before &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;masterJetty.stop()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; seems to work too. TestReplicationHandler passes and I don&apos;t see any log message like this anymore - &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2830 T38 oash.SnapPuller.fetchLatestIndex ERROR Master at: http:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:55584/solr is not available. Index fetch failed. Exception: Server refused connection at: http://127.0.0.1:55584/solr&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14017408" author="jira-bot" created="Wed, 4 Jun 2014 06:07:35 +0000"  >&lt;p&gt;Commit 1599942 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1599942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1599942&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: backporting some replication handler fixes from trunk.&lt;/p&gt;</comment>
                            <comment id="14017412" author="jira-bot" created="Wed, 4 Jun 2014 06:11:31 +0000"  >&lt;p&gt;Commit 1599943 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1599943&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1599943&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: refactored doTestBackup into a separate class.&lt;/p&gt;</comment>
                            <comment id="14017415" author="jira-bot" created="Wed, 4 Jun 2014 06:17:24 +0000"  >&lt;p&gt;Commit 1599944 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dawidweiss&quot; class=&quot;user-hover&quot; rel=&quot;dawidweiss&quot;&gt;dawidweiss&lt;/a&gt; in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1599944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1599944&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6119&quot; title=&quot;TestReplicationHandler attempts to remove open folders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6119&quot;&gt;&lt;del&gt;SOLR-6119&lt;/del&gt;&lt;/a&gt;: backport of test split from trunk.&lt;/p&gt;</comment>
                            <comment id="14018715" author="varunthacker" created="Thu, 5 Jun 2014 12:04:48 +0000"  >&lt;p&gt;Dawid, can we resolve this issue?&lt;/p&gt;</comment>
                            <comment id="14018725" author="dweiss" created="Thu, 5 Jun 2014 12:18:01 +0000"  >&lt;p&gt;I think so, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12648214" name="SOLR-6119.patch" size="22287" author="varun" created="Tue, 3 Jun 2014 20:18:21 +0000"/>
                            <attachment id="12647926" name="SOLR-6119.patch" size="5809" author="varun" created="Mon, 2 Jun 2014 16:42:50 +0000"/>
                            <attachment id="12647549" name="SOLR-6119.patch" size="5384" author="varun" created="Fri, 30 May 2014 07:34:35 +0000"/>
                            <attachment id="12647543" name="SOLR-6119.patch" size="4775" author="dweiss" created="Fri, 30 May 2014 06:05:26 +0000"/>
                            <attachment id="12647347" name="SOLR-6119.patch" size="4696" author="varun" created="Thu, 29 May 2014 12:12:13 +0000"/>
                            <attachment id="12647331" name="SOLR-6119.patch" size="4263" author="varun" created="Thu, 29 May 2014 09:04:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395420</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1w2vz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395548</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>