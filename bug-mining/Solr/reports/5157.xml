<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:09:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-16858] Allow KnnQParser to selectively apply filters</title>
                <link>https://issues.apache.org/jira/browse/SOLR-16858</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;The KnnQParser is parsing the filter query which limits the rows considered by the vector query with the following method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Query getFilterQuery() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SolrException, SyntaxError {
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSubQuery = recurseCount != 0;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isFilter() &amp;amp;&amp;amp; !isSubQuery) {
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] filterQueries = req.getParams().getParams(CommonParams.FQ);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filterQueries != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; filterQueries.length != 0) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          List&amp;lt;Query&amp;gt; filters = QueryUtils.parseFilterQueries(req);
          SolrIndexSearcher.ProcessedFilter processedFilter =
              req.getSearcher().getProcessedFilter(filters);
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; processedFilter.filter;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrException(SolrException.ErrorCode.SERVER_ERROR, e);
        }
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is pulling all filter queries from the main query parameters and using them to limit the vector query. This is the automatic behavior of the KnnQParser.&lt;/p&gt;

&lt;p&gt;There are cases where you may want to selectively apply different filters. One such case is &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16857&quot; title=&quot;Efficiently rerank collapsed queries with vector queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16857&quot;&gt;SOLR-16857&lt;/a&gt; which involves reRanking a collapsed query.&lt;/p&gt;

&lt;p&gt;Overriding the default filter behavior could be done by adding an &quot;fq&quot; local parameter to the KnnQParser which would override the default filtering behavior.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{!knn f=vector topK=10 fq=$kfq}[...]&amp;amp;kfq=myquery
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;





</description>
                <environment></environment>
        <key id="13541804">SOLR-16858</key>
            <summary>Allow KnnQParser to selectively apply filters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="jbernste">Joel Bernstein</reporter>
                        <labels>
                            <label>hybrid-search</label>
                    </labels>
                <created>Wed, 28 Jun 2023 14:00:51 +0000</created>
                <updated>Sun, 28 Apr 2024 19:22:39 +0000</updated>
                            <resolved>Fri, 9 Feb 2024 00:30:42 +0000</resolved>
                                                    <fixVersion>9.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17794885" author="hossman" created="Sat, 9 Dec 2023 00:15:41 +0000"  >&lt;p&gt;I&apos;ve attached a patch that implements the &lt;tt&gt;fq&lt;/tt&gt; local param change joel suggested when creating this jira, along with some tests proving that it works with one or more values, and/or that an &quot;empty&quot; &lt;tt&gt;fq&lt;/tt&gt; local param can be used to prevent the use of any of the global &lt;tt&gt;fq&lt;/tt&gt; params from being wrapped.&lt;/p&gt;

&lt;p&gt;I think this is good for the users (like me) that want to be able to say &quot;I have very specific filters i want my KNN query to wrap&quot; but i&apos;ve talked to some folks who think about using KNN very differently then i do, who really like the current behavior of slurping up all of the global &lt;tt&gt;fq&lt;/tt&gt; params, but they really need the ability to &lt;em&gt;exclude&lt;/em&gt; a few fq params based on tags &#8211; in the same way that multiselect faceting requires using &lt;tt&gt;excludeTags&lt;/tt&gt; as you add &lt;tt&gt;fq&lt;/tt&gt; params for drilldown.&lt;/p&gt;

&lt;p&gt;Specifically the usecase for these folks is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Initial Request
	&lt;ul&gt;
		&lt;li&gt;&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;?q={!knn excludeTags=drill_down topK=1000}...
&amp;amp;fq=foo
&amp;amp;fq=bar
&amp;amp;...
&amp;amp;facet.field=xxx
&amp;amp;facet.field=yyy
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;where &lt;em&gt;by default&lt;/em&gt; any &lt;tt&gt;fq&lt;/tt&gt; param is used as a pre-filter ensure they get the &quot;fullest&quot; possible &lt;tt&gt;topK&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;When a user clicks on one or more facet term to drill down
	&lt;ul&gt;
		&lt;li&gt;&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;?q={!knn excludeTags=drill_down topK=1000}...
&amp;amp;fq=foo
&amp;amp;fq=bar
&amp;amp;...
&amp;amp;facet.field=xxx
&amp;amp;facet.field=yyy
&amp;amp;fq={!term tag=drill_down f=xxx}...
&amp;amp;fq={!term tag=drill_down f=yyy}...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;so that the &lt;tt&gt;numFound&lt;/tt&gt; starts to decrease, as all of the facet drill down &lt;tt&gt;fq&lt;/tt&gt; params are applied independently to the &lt;tt&gt;knn&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think this would be a nice addition to the flexibility of the &lt;tt&gt;knn&lt;/tt&gt; QParser, and would be fairly straightforward to implement. I have some nocommit comments / psuedo-code in my patch about how i think we can go about it.&lt;/p&gt;

&lt;p&gt;Part of my idea is to not only support an &lt;tt&gt;excludeTags&lt;/tt&gt; localparam, but also an &lt;tt&gt;includeTags&lt;/tt&gt; param for folks who might have a lot of &lt;tt&gt;fq&lt;/tt&gt; params that they use in &lt;em&gt;every&lt;/em&gt; request (ie: invariants/appends on the handler), and if/when the &lt;tt&gt;q&lt;/tt&gt; param uses &lt;tt&gt;knn&lt;/tt&gt; they want a large subset (but not &lt;em&gt;all&lt;/em&gt;) of their &lt;tt&gt;fq&lt;/tt&gt; params to be slurped up by the &lt;tt&gt;knn&lt;/tt&gt; parser.&lt;/p&gt;

&lt;p&gt;Next week i&apos;ll start work up some test cases for these ideas, and then convert the nocommit psuedo-code into real code to confirm it&apos;s actually as easy to support as i think it should be.&lt;/p&gt;</comment>
                            <comment id="17796971" author="hossman" created="Fri, 15 Dec 2023 01:37:10 +0000"  >&lt;p&gt;Updated patch to add support for &lt;tt&gt;includeTags&lt;/tt&gt; and &lt;tt&gt;excludeTags&lt;/tt&gt; as well as a lot of beefed up test cases (including things like ensuring you can use the &lt;tt&gt;fq&lt;/tt&gt; localparam when the knn parser is used as a sub-query, or as a top level &lt;tt&gt;fq&lt;/tt&gt; param)&lt;/p&gt;

&lt;p&gt;Other then adding ref-guide docs on the new options, i think this is pretty solid?&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abenedetti&quot; class=&quot;user-hover&quot; rel=&quot;abenedetti&quot;&gt;abenedetti&lt;/a&gt; - any concerns?&lt;/p&gt;</comment>
                            <comment id="17797119" author="alessandro.benedetti" created="Fri, 15 Dec 2023 10:03:23 +0000"  >&lt;p&gt;Thanks for the contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;! Can we open a Pull Request that&apos;s easier to review and discuss?&lt;br/&gt;
I remember I was waiting for Lucene for a change to simplify the filtering in this way then:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/solr/pull/1246/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1246/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now that approach should be doable (changing the return null with returning a new KNN query, copy of the source one).&lt;/p&gt;

&lt;p&gt;Anyway, let&apos;s create the GitHub pull request and discuss it from there!&lt;/p&gt;</comment>
                            <comment id="17797322" author="jira-bot" created="Fri, 15 Dec 2023 22:08:39 +0000"  >&lt;p&gt;Commit 68d2c743f30f834572155cd32b06f67440715a4b in solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt; from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=68d2c743f30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=68d2c743f30&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;: new localparams for knn to override pre-filtering behavior: fq, includeTags, &amp;amp; excludeTags&lt;/p&gt;</comment>
                            <comment id="17797323" author="hossman" created="Fri, 15 Dec 2023 22:10:42 +0000"  >&lt;p&gt;I personally dislike PRs as a development process &#8211; but if it makes it easier for you to review i went ahead and created a branch and a PR...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/solr/pull/2157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/2157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...I may not immediately notice if you comment/update/edit the PR though, so please put a short comment here if you do.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;I don&apos;t really understand your point about your older &lt;a href=&quot;https://github.com/apache/solr/pull/1246.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; ... particularly since the Jira it mentions is already resolved, and the test &amp;amp; ref-guide changes have already been committed as part of some other change?&lt;/p&gt;

&lt;p&gt;But based on this comment...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Now that approach should be doable (changing the return null with returning a new KNN query, copy of the source one).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;...I don&apos;t really understand how that would help with the problem this jira is trying to tackle?  (specifically: giving users more control over what &quot;pre-filtering&quot; the Knn query does before finding the topK).&lt;/p&gt;</comment>
                            <comment id="17798171" author="alessandro.benedetti" created="Mon, 18 Dec 2023 12:13:17 +0000"  >&lt;p&gt;Sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;, let me explain here and if that old pull request is not relevant anymore, I&apos;ll proceed with a deep review of this PR (thanks for opening it, the fact you dislike the approach but you opened it nonetheless is much appreciated &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;):&lt;/p&gt;

&lt;p&gt;So the idea of the Pull Request I mentioned was to remove any filter query logic from the KNN Query parser and leave it to the standard way of managing filter queries, already available in Solr in QueryUtils &apos;public static Query combineQueryAndFilter&apos;.&lt;br/&gt;
When I opened that tentative PR Lucene didn&apos;t allow me to instantiate a new Knn Query, copying the one already parsed and adding just the filter query, but now this would be possible (just updated the PR):&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/solr/pull/1246/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/solr/pull/1246/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this way, any filter should work as it works for any other Solr query (where you can decide if doing a prefilter of postfilter based on the cache and cost &amp;gt;100 of the filter).&lt;br/&gt;
Also, include/exclude should work as usual.&lt;/p&gt;

&lt;p&gt;I checked the reranking issue and I don&apos;t think having a local FQ is necessary(or recommended) for that, but If you can think of other scenarios where a localFq would make sense, I am happy to listen.&lt;br/&gt;
Do we have other query parsers that have a local FQ?&lt;/p&gt;
</comment>
                            <comment id="17798321" author="hossman" created="Mon, 18 Dec 2023 18:58:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;...let me explain here and if that old pull request is not relevant anymore, I&apos;ll proceed with a deep review of this PR...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes please &#8211; I definitely think you should give a more in depth read of some of the examples I posted above, and the test cases added in my PR &#8211; what you&apos;re talking about really seems to be orthogonal to the flexibility I&apos;m trying to add?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In this way, any filter should work as it works for any other Solr query (where you can decide if doing a prefilter of postfilter based on the cache and cost &amp;gt;100 of the filter).&lt;br/&gt;
Also, include/exclude should work as usual.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we&apos;re having a disconnect in concepts, so I&apos;d like to clarify terminology....&lt;/p&gt;

&lt;p&gt;Historically, before any notion of knn, solr has had 2 types of &lt;tt&gt;fq&lt;/tt&gt; &quot;filters&quot;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Plain old &quot;regular&quot; filter queries &#8211; that can be evaluated completely independently of each other or the main query
	&lt;ul&gt;
		&lt;li&gt;These are typically cached, so that they can be re-used in other request&lt;/li&gt;
		&lt;li&gt;If they aren&apos;t cached some small optimizations are available&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;PostFilter&lt;/tt&gt; which allows the ability to defer &quot;expensive&quot; match/scoring computation until we &lt;em&gt;know&lt;/em&gt; that the document matches all other parts of the query (including &quot;regular filter queries&quot;
	&lt;ul&gt;
		&lt;li&gt;Only a small handful of built in &lt;tt&gt;QParser&lt;/tt&gt; s can be used a &lt;tt&gt;PostFilter&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;Never cached, because they are entirely dependent on situation&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;KNN queries, really have their own filtering:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&quot;pre-filter&quot; the set of documents considered per segment when identifying the topK
	&lt;ul&gt;
		&lt;li&gt;The &lt;tt&gt;KnnVectorQuery&lt;/tt&gt; classes is essentially a &lt;em&gt;wrapper&lt;/em&gt; around another &quot;inner&quot; query (like &lt;tt&gt;ConstantScoreQuery&lt;/tt&gt;, &lt;tt&gt;BoostQuery&lt;/tt&gt;, etc...)&lt;/li&gt;
		&lt;li&gt;The KNN score calculations only consider documents that match the inner query&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So conceptually, we&apos;ve got&lt;/p&gt;

&lt;p&gt;1. Solr&apos;s &quot;regular&quot; filters&lt;br/&gt;
2. Solr&apos;s &lt;tt&gt;PostFilter&lt;/tt&gt;&lt;br/&gt;
3. KNN&apos;s pre-filter&lt;/p&gt;

&lt;p&gt;When the &lt;tt&gt;KnnQParser&lt;/tt&gt; was added to Solr, The assumption/implementation was/is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(A) when &lt;tt&gt;KnnQParser&lt;/tt&gt; is used as the main query:
	&lt;ul&gt;
		&lt;li&gt;&lt;b&gt;All&lt;/b&gt; of Solr&apos;s &quot;regular&quot; filter quries should be used as the KNN &quot;pre-filter&quot;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;(B) when &lt;tt&gt;KnnQParser&lt;/tt&gt; is itself used as a &quot;regular&quot; solr filter, or as a subquery:
	&lt;ul&gt;
		&lt;li&gt;There should be &lt;b&gt;no&lt;/b&gt; KNN pre-filter at all&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Essentially: the design of the &lt;tt&gt;KnnQParser&lt;/tt&gt; assumes a tight, &quot;all or nothing&quot; coupling between the KNN pre-filter and Solr&apos;s &quot;regular&quot; filters.&lt;/p&gt;

&lt;p&gt;If we go back to what you described regarding your PR...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In this way, any filter should work as it works for any other Solr query (where you can decide if doing a prefilter of postfilter based on the cache and cost &amp;gt;100 of the filter).&lt;br/&gt;
Also, include/exclude should work as usual.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;... that sounds like you&apos;re saying there is a bug in &quot;(A)&quot; you want to address, such that it&apos;s not just wrapping the &quot;regular&quot; filters, it&apos;s also wrapping any/all &lt;tt&gt;PostFilter&lt;/tt&gt; s as well (which i hadn&apos;t noticed before, but thinking about how the code works it makes sense that bug would exist) and you have an approach in PR you were planning to use to tackle that.&lt;/p&gt;

&lt;p&gt;As I said, I have not considered the &lt;tt&gt;PostFilter&lt;/tt&gt; bug case you are describing &#8211; What I&apos;m focused on is giving users the ability to decouple that &quot;all or nothing&quot; assumption:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Give users the ability to control what &quot;pre-filtering&quot; is used when &lt;tt&gt;KnnQParser&lt;/tt&gt; is the main query
	&lt;ul&gt;
		&lt;li&gt;Really important for a lot of faceting usecases, when you want to be able to add &quot;regular filters&quot; for facet drill down (to narrow the set of documents returned) that should not become part of the KNN &quot;pre-filter&quot;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Give users the ability to specify &lt;em&gt;some&lt;/em&gt; &quot;pre-filtering&quot; even when &lt;tt&gt;KnnQParser&lt;/tt&gt; is &lt;b&gt;NOT&lt;/b&gt; the main query
	&lt;ul&gt;
		&lt;li&gt;Example: pre-filter on &lt;tt&gt;inStock:true&lt;/tt&gt; to get the best &lt;tt&gt;topK&lt;/tt&gt; possible, even when &lt;tt&gt;KnnQParser&lt;/tt&gt; is a subquery...
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;q=(name:foo AND (category:hot-reviews OR {!knn f=vfield topK=100 v=$vec fq=&apos;inStock&apos;})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;Example: Multiple &lt;tt&gt;KnnQParser&lt;/tt&gt; instances in the same request that want to pre-filter on different things...
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;q=({!knn f=vfield topK=100 v=$vec fq=&apos;category:legal&apos;}^3 OR {!knn f=vfield topK=100 v=$vec fq=&apos;category:hr&apos;}^7)
vec=...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Does that make sense?&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;p&gt;Do we have other query parsers that have a local FQ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, but we also don&apos;t have any other query parsers that &lt;em&gt;implicitly&lt;/em&gt; slurp up all other &quot;regular&quot; filters and use those to change their internal behavior. My goal in adding an &lt;tt&gt;fq&lt;/tt&gt; (and &lt;tt&gt;excludeTag&lt;/tt&gt;/&lt;tt&gt;includeTag&lt;/tt&gt;) local params is to give users the ability to override that very special implicit behavior.&lt;/p&gt;

&lt;p&gt;We &lt;em&gt;DO&lt;/em&gt; have lots of other query parsers that are designed to &quot;wrap&quot; other queries &#8211; and IMO &lt;tt&gt;KnnQParser&lt;/tt&gt; probably should have been implemented that way from the beginning &#8211; similar to how the &lt;tt&gt;boost&lt;/tt&gt; or &lt;tt&gt;join&lt;/tt&gt; QParsers work. ie: no implicit slurping of &lt;tt&gt;fq&lt;/tt&gt; params, the vector to score with is a local param, and the body of the parser is the query to wrap for the &quot;knn pre-filter&quot;...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;q={!knn f=myfield topK=10 v=&apos;[1,2,3,4]&apos;}inStock:true
fq=foo:&quot;nothing special happens to this filter&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...but we can&apos;t go back in time now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;So instead i&apos;m trying to provide ways to move forward with additional use cases that aren&apos;t supported by the current design.&lt;/p&gt;</comment>
                            <comment id="17798322" author="hossman" created="Mon, 18 Dec 2023 18:59:30 +0000"  >&lt;p&gt;Also, FWIW:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We should definitely open a new jira to track the bug with using &lt;tt&gt;KnnQParser&lt;/tt&gt; w/ &lt;tt&gt;PostFilter&lt;/tt&gt; s
	&lt;ul&gt;
		&lt;li&gt;The changes i&apos;m suggesting here would at least provide a workaround for that (by letting users tag/exclude them)&lt;/li&gt;
		&lt;li&gt;But I agree, we should really fix the implicit slurping of Solr&apos;s &lt;tt&gt;fq&lt;/tt&gt; params to exclude &lt;tt&gt;PostFilter&lt;/tt&gt; s &#8212; ideally in a way that doesn&apos;t preclude the added flexibility &amp;amp; use cases I&apos;m trying to support here.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;I used &lt;tt&gt;fq&lt;/tt&gt; as the local param name purely because that&apos;s what this jira originally suggested
	&lt;ul&gt;
		&lt;li&gt;I&apos;d probably prefer something like &lt;tt&gt;filter&lt;/tt&gt; because it might be better to help convey that this is a different concept from Solr filters &#8211; the KNN Pre-filter&lt;/li&gt;
		&lt;li&gt;And maybe, someday, we can remove the implicit default slurping and make &lt;tt&gt;filter&lt;/tt&gt; a mandatory local param? ... maybe?&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17798438" author="dsmiley" created="Tue, 19 Dec 2023 05:58:44 +0000"  >&lt;p&gt;IMO PostFilters are so special that they deserve their own query parameter and shouldn&apos;t be produceable from a QueryParser either as they really aren&apos;t Query subclasses; it&apos;s a hack right now. &#160;Maybe not worth changing after so many years.&lt;/p&gt;</comment>
                            <comment id="17798674" author="alessandro.benedetti" created="Tue, 19 Dec 2023 17:34:32 +0000"  >&lt;p&gt;I read everything and I agree with you.&lt;br/&gt;
I think it makes sense to have a local parameter (which we can call &apos;preFilter&apos; maybe?) and leave FQs to behave as they were with no slurping.&lt;br/&gt;
This means that every FQ will behave as a post-filter for the KNN world, but effectively from a Solr standpoint, they will behave as usual.&lt;br/&gt;
This is a breaking change, so we&apos;ll have to clarify as a warning somewhere as users will see a drastic difference (people using FQ as pre-filters will have to switch to the local parameter instead (but I think it&apos;s fair).&lt;/p&gt;

&lt;p&gt;In terms of the &apos;postFiltering bug&apos;, once we add the local param, and remove the slurping, is any bug left?&lt;/p&gt;

</comment>
                            <comment id="17798675" author="alessandro.benedetti" created="Tue, 19 Dec 2023 17:37:05 +0000"  >&lt;p&gt;I also agree with David, few people know that to run post-filtering you need the cache/cost parameter combination (actually I think many Solr guys don&apos;t even know post-filtering is a thing).&lt;br/&gt;
A new parameter would make a lot of sense, probably not an urgent priority, for sure un-related with vector-based search, but still relevant (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsmiley&quot; class=&quot;user-hover&quot; rel=&quot;dsmiley&quot;&gt;dsmiley&lt;/a&gt; feel free to create a Jira if you want someone to tackle it sooner or later)&lt;/p&gt;</comment>
                            <comment id="17798686" author="alessandro.benedetti" created="Tue, 19 Dec 2023 18:00:23 +0000"  >&lt;p&gt;I did a first review and I have some additional questions:&lt;/p&gt;

&lt;p&gt;I have the concept of filter tag/exclusion clear in my mind for the faceting scenario.&lt;br/&gt;
But I&apos;m struggling to understand why we would need the include/exclude tags as local parameters for KNN.&lt;br/&gt;
Once we set that the local preFilter is independent of the global FQs, why should we involve tags?&lt;br/&gt;
Is it just to avoid re-writing a pre-filter condition that has been already specified by a tag in the global?&lt;/p&gt;</comment>
                            <comment id="17799220" author="hossman" created="Thu, 21 Dec 2023 00:54:29 +0000"  >&lt;p&gt;(NOTE: I&apos;m responding to some questions/comments out of order so that I can group the answers by logical topic)&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;p&gt;I also agree with David, few people know that to run post-filtering you need ... for sure un-related with vector-based search, but still relevant ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I have conflicting opinions about the API for using PostFilters, but agree we shouldn&apos;t let that bog down this discussion of the knn parser &#8211; if one of you opens an issue regarding that please link from here and i&apos;ll try to comment there w/thoughts later.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;p&gt;In terms of the &apos;postFiltering bug&apos;, once we add the local param, and remove the slurping, is any bug left?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I re-reviewed the code today and I do not believe there is any &quot;postFiltering bug&quot; on either the &lt;tt&gt;main&lt;/tt&gt; branch, or the &lt;tt&gt;jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;&lt;/tt&gt; branch. &lt;tt&gt;KnnQParser&lt;/tt&gt; &apos;s use of &lt;tt&gt;SolrIndexSearcher.getProcessedFilter&lt;/tt&gt; will ensure that any PostFilters are excluded from the &quot;pre-filter wrapping&quot;.&lt;/p&gt;

&lt;p&gt;(We can add a test that proves it by checking the result of &lt;tt&gt;KnnVectorQuery.getFilter()&lt;/tt&gt; after using &lt;tt&gt;KnnQParser&lt;/tt&gt; in a request with PostFilters)&lt;/p&gt;

&lt;p&gt;I made my earlier comment about a (possible) bug in the PostFilter situation based on some confusion I had about the motivation for your PR1246. I thought &lt;em&gt;YOU&lt;/em&gt; were saying there was a bug with knn + PostFilters, which PR1246 would fix by delaying the pre-filter wrapping until after SolrIndexSearcher had computed the PostFilters (and that you had been blocked on committing PR1246 to fix the &quot;bug&quot; while waiting for the lucene change).&lt;/p&gt;

&lt;p&gt;Just a misunderstanding on my part.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;p&gt;I think it makes sense to have a local parameter (which we can call &apos;preFilter&apos; maybe?)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m happy to change it to &quot; &lt;tt&gt;preFilter&lt;/tt&gt; &quot;&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;&lt;p&gt;This is a breaking change, so we&apos;ll have to clarify as a warning somewhere as users will see a drastic difference (people using FQ as pre-filters will have to switch to the local parameter instead (but I think it&apos;s fair).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m not certain if we should &lt;em&gt;EVER&lt;/em&gt; remove the fq slurping logic completely &#8211; but I DEFINITELY do not think we should do so in a way that would be a breaking change on upgrade. (if we&apos;re going to do it, it should first be deprecated, with some new param or config option to enable/disable, and wait for a major version to change the default)&lt;/p&gt;

&lt;p&gt;The reason I&apos;m not convinced we should &lt;b&gt;EVER&lt;/b&gt; completely remove the fq slurping ties into your other question...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;But I&apos;m struggling to understand why we would need the include/exclude tags as local parameters for KNN.&lt;/p&gt;

&lt;p&gt;Once we set that the local preFilter is independent of the global FQs, why should we involve tags?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This goes back to those other 2 usecases (or maybe &quot;user profiles&quot; is a better description) that I mentioned in my first comment on this jira: it makes a lot of sense for some users to have the slurping of global FQ params &#8211; as long as we give them some control over how it&apos;s done...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;... i&apos;ve talked to some folks who think about using KNN very differently then i do, who really like the current behavior of slurping up all of the global fq params, but they really need the ability to exclude a few fq params based on tags &#8211; in the same way that multiselect faceting requires using &lt;tt&gt;excludeTags&lt;/tt&gt; as you add &lt;tt&gt;fq&lt;/tt&gt; params for drilldown. ...&lt;/p&gt;

&lt;p&gt;... so that the numFound starts to decrease, as all of the facet drill down fq params are applied independently to the knn.&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;Part of my idea is to not only support an &lt;tt&gt;excludeTags&lt;/tt&gt; localparam, but also an &lt;tt&gt;includeTags&lt;/tt&gt; param for folks who might have a lot of &lt;tt&gt;fq&lt;/tt&gt; params that they use in &lt;em&gt;every&lt;/em&gt; request (ie: invariants/appends on the handler), and if/when the q param uses knn they want a large subset (but not &lt;em&gt;all&lt;/em&gt;) of their fq params to be slurped up by the knn parser.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The last part of your question was...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Is it just to avoid re-writing a pre-filter condition that has been already specified by a tag in the global?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;...and I guess that&apos;s one way of looking at it &#8211; but to me it&apos;s more about giving as much flexibility as possible for how people can specify the pre-filter.&lt;/p&gt;

&lt;p&gt;To go back to the earlier part of your question...&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Once we set that the local preFilter is independent of the global FQs, why should we involve tags?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My thinking about this issue is that &lt;tt&gt;KnnQParser&lt;/tt&gt; should support multiple ways of defining the pre-filter that exists on the resulting &lt;tt&gt;KnnVectorQuery&lt;/tt&gt; :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(1) When &lt;tt&gt;KnnQParser&lt;/tt&gt; is used for the main query string, FQ params are used to build the &lt;em&gt;default&lt;/em&gt; pre-filter on the &lt;tt&gt;KnnVectorQuery&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;if you find yourself in a situation where you only want to use &lt;em&gt;some&lt;/em&gt; (but not all) of the global FQs - you can use &lt;tt&gt;includeTags&lt;/tt&gt; or &lt;tt&gt;excludeTags&lt;/tt&gt; localparams to adjust the set of FQ params used&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;(2) Regardless of where/how you use &lt;tt&gt;KnnQParser&lt;/tt&gt; , a &lt;tt&gt;preFilter&lt;/tt&gt; local param can be used to override the default behavior and explicit set the pre-filter on the &lt;tt&gt;KnnVectorQuery&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...ie: there doesn&apos;t have to be one and only one way of specifying what gets put in &lt;tt&gt;KnnVectorQuery.getFilter&lt;/tt&gt; &#8211; we can give the user options (and in some use cases, one option will be easier to use then others)&lt;/p&gt;

&lt;p&gt;does that make sense?&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;I&apos;m about to go offline until January, but when I get back I&apos;ll have some time to update the jira branch to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;change the local param name to &quot; &lt;tt&gt;preFilter&lt;/tt&gt; &quot;&lt;/li&gt;
	&lt;li&gt;add a clear-box test of the post filter situation to prove they are automatically excluded&lt;/li&gt;
	&lt;li&gt;add ref-guide edits of the new params with some examples.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17808262" author="alessandro.benedetti" created="Thu, 18 Jan 2024 15:05:27 +0000"  >&lt;p&gt;I spent some peaceful and not distracted time on this issue and I we are on the same page.&lt;br/&gt;
I totally agree with:&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;My thinking about this issue is that KnnQParser should support multiple ways of defining the pre-filter that exists on the resulting KnnVectorQuery :&lt;br/&gt;
(1) When KnnQParser is used for the main query string, FQ params are used to build the default pre-filter on the KnnVectorQuery&lt;br/&gt;
if you find yourself in a situation where you only want to use some (but not all) of the global FQs - you can use includeTags or excludeTags localparams to adjust the set of FQ params used&lt;br/&gt;
(2) Regardless of where/how you use KnnQParser , a preFilter local param can be used to override the default behavior and explicit set the pre-filter on the KnnVectorQuery&lt;br/&gt;
...ie: there doesn&apos;t have to be one and only one way of specifying what gets put in KnnVectorQuery.getFilter &#8211; we can give the user options (and in some use cases, one option will be easier to use then others)&lt;br/&gt;
does that make sense?&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;we just need to carefully craft the pull request and the way this is explained to users via documentation&lt;br/&gt;
I&apos;ll wait for your next iteration and then I&apos;ll add any additional feedback on the PR.&lt;br/&gt;
Thanks for your effort!&lt;/p&gt;</comment>
                            <comment id="17808408" author="hossman" created="Fri, 19 Jan 2024 00:48:42 +0000"  >&lt;p&gt;yeah, sorry &#8211; i am coming back to this soon, i&apos;ve just been bogged down in something else.&lt;/p&gt;</comment>
                            <comment id="17812477" author="jira-bot" created="Tue, 30 Jan 2024 21:00:38 +0000"  >&lt;p&gt;Commit 68ec852ca80a38d08fc22e4a7253e309f2388aa9 in solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt; from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=68ec852ca80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=68ec852ca80&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge branch &apos;main&apos; into jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17812478" author="hossman" created="Tue, 30 Jan 2024 21:01:20 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;m about to go offline until January, but when I get back I&apos;ll have some time to update the jira branch to:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;change the local param name to &quot; preFilter &quot;&lt;/li&gt;
	&lt;li&gt;add a clear-box test of the post filter situation to prove they are automatically excluded&lt;/li&gt;
	&lt;li&gt;add ref-guide edits of the new params with some examples.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve updated the branch to include these changes, please lemme know what you think.&lt;/p&gt;</comment>
                            <comment id="17814138" author="hossman" created="Mon, 5 Feb 2024 01:28:17 +0000"  >&lt;p&gt;Alessandro: Any feedback or concerns on the branch?  I think it&apos;s pretty solid and ready to merge&lt;/p&gt;</comment>
                            <comment id="17814325" author="alessandro.benedetti" created="Mon, 5 Feb 2024 11:31:11 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; for the contribution! I left various comments.&lt;br/&gt;
My feedback is generally positive, I have some minor concerns over testing and documentation we can discuss in the Pull Request.&lt;br/&gt;
I am also involving &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eliaporciani&quot; class=&quot;user-hover&quot; rel=&quot;eliaporciani&quot;&gt;eliaporciani&lt;/a&gt; who helped me with the original implementation (he specifically worked on the filters).&lt;br/&gt;
So he can add some considerations as well, especially regarding the documentation.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="17814551" author="jira-bot" created="Tue, 6 Feb 2024 00:29:04 +0000"  >&lt;p&gt;Commit c5587492b6509ccb8a6f0f18aa55e28115522e70 in solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt; from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=c5587492b65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=c5587492b65&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge remote-tracking branch &apos;origin/main&apos; into jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17814552" author="hossman" created="Tue, 6 Feb 2024 00:29:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;I have some minor concerns over testing and documentation....&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I updated my branch to try to address your concerns, but as far some high level responses/discussion...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Re: changes to &lt;tt&gt;knnQueryUsedInFilters_shouldFilterResultsBeforeTheQueryExecution&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;Changing this test wasn&apos;t necessary because of the feature being added, it&apos;s just a general improvement to the test i made to be confident i wasn&apos;t breaking back compat&lt;/li&gt;
		&lt;li&gt;On the main branch, this test doesn&apos;t really assert anything about the &lt;tt&gt;knn&lt;/tt&gt; parser &#8211; you could delete the knn filter from this test and it would still pass
		&lt;ul&gt;
			&lt;li&gt;This is because &quot;4&quot; is already the only overlap between the &lt;tt&gt;q=id:(3 4 9 2)&lt;/tt&gt; and &lt;tt&gt;fq=id:(4 20)&lt;/tt&gt; params&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;I added &apos;9&apos; to the &lt;tt&gt;fq=id:...&lt;/tt&gt; to demonstrate that the knn filter was in fact impacting the results&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Re: test splitting
	&lt;ul&gt;
		&lt;li&gt;I went ahead and split up a bunch of the tests that you asked about&lt;/li&gt;
		&lt;li&gt;I probably did not split as much as you wold like, but that&apos;s because I tried to keep things together where:
		&lt;ul&gt;
			&lt;li&gt;The tests aren&apos;t just asserting the behavior of multiple inputs, they are asserting exact equivalence in behavior for those inputs. Keeping them together ensures that if at some point in the future a developer tries to change the behavior &#8211; and thus change the test &#8211; they will be forced to consider the equivalence assertions (and either update all the impacted code paths, or intentionally break the equivalence)&lt;/li&gt;
			&lt;li&gt;Multiple assertions are &lt;em&gt;logically&lt;/em&gt; very related, even if the exact input/output are distinct (ex: &lt;tt&gt;knnQueryWithFilterQuery_preFilterLocalParamOverridesGlobalFilters&lt;/tt&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;In the specific case of &lt;tt&gt;QueryEqualityTest.testQueryKNN()&lt;/tt&gt; that you asked about: I don&apos;t view these as 4 diff test cases
		&lt;ul&gt;
			&lt;li&gt;There are 4 requests needed to have a diff parsing context (ie: diff request params)&lt;/li&gt;
			&lt;li&gt;but the tests asserts that specific permutations of the resulting &lt;tt&gt;Query&lt;/tt&gt; objects are equal (or unequal) regardless of the parsing context&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Re: &quot;may not&quot; vs &quot;must not&quot;
	&lt;ul&gt;
		&lt;li&gt;while &quot;may&quot; and &quot;must&quot; have very different meanings, &quot;may not&quot; and &quot;must not&quot; are generally are interchangeable in english: with &quot;may not&quot; typically considered friendlier &amp;amp; less abrasive.&lt;/li&gt;
		&lt;li&gt;But if you found &quot;may not&quot; confusing as a non native speaker, then presumably other non native speakers (with less understanding of the underlying subject matter) will be equally confused&lt;/li&gt;
		&lt;li&gt;So i switched them all to &quot;must not&quot; for clarity&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17815019" author="jira-bot" created="Tue, 6 Feb 2024 22:24:12 +0000"  >&lt;p&gt;Commit 2566c6d221e2e7dfccbab9d7bd51e8fb6b80be43 in solr&apos;s branch refs/heads/jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt; from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=2566c6d221e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=2566c6d221e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge branch &apos;main&apos; into jira/&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17815029" author="alessandro.benedetti" created="Tue, 6 Feb 2024 23:17:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt; thanks for your effort! I just reviewed the PR now and it looks much better.&lt;br/&gt;
I see you split the tests, sure, as you mentioned I would have loved even additional splits but to be honest I think it&apos;s good enough.&lt;br/&gt;
A minor thing that remains is &quot;equivilence&quot; and &quot;equivilent&quot; in many places -&amp;gt; it should be &quot;equivalence&quot; and &quot;equivalent&quot;.&lt;/p&gt;

&lt;p&gt;If you&apos;re not in a rush, I would like to have a more in-depth look at the tests and also have my colleague &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eliaporciani&quot; class=&quot;user-hover&quot; rel=&quot;eliaporciani&quot;&gt;eliaporciani&lt;/a&gt; to take a look.&lt;/p&gt;

&lt;p&gt;But in general, I&apos;m approving the PR!&lt;/p&gt;
</comment>
                            <comment id="17815355" author="hossman" created="Wed, 7 Feb 2024 16:36:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;A minor thing that remains is &quot;equivilence&quot; and &quot;equivilent&quot; in many places -&amp;gt; it should be &quot;equivalence&quot; and &quot;equivalent&quot;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sorry about that ... i fixed the ref-guide typos you had pointed out a few days ago, but i didn&apos;t realize there were similar mistakes in the test comments&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If you&apos;re not in a rush, I would like to have a more in-depth look at the tests and also have my colleague &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eliaporciani&quot; class=&quot;user-hover&quot; rel=&quot;eliaporciani&quot;&gt;eliaporciani&lt;/a&gt; to take a look.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I mean ... &quot;rush&quot; is relative ... i&apos;d rather this doesn&apos;t stagnate forever.&#160; Any idea when Elia can take a look?&lt;/p&gt;</comment>
                            <comment id="17815682" author="JIRAUSER280197" created="Thu, 8 Feb 2024 13:35:54 +0000"  >&lt;p&gt;I&apos;ve just gone through the code, and the changes look good to me. A nice feature to have. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hossman&quot; class=&quot;user-hover&quot; rel=&quot;hossman&quot;&gt;hossman&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17815865" author="jira-bot" created="Thu, 8 Feb 2024 23:32:34 +0000"  >&lt;p&gt;Commit b88fa0d7d15d70cea669218ab9dfd1068f9fcf73 in solr&apos;s branch refs/heads/main from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=b88fa0d7d15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=b88fa0d7d15&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;: KnnQParser&apos;s &quot;Pre-Filtering&quot; behavior is now controlable via local params (closes #2157)&lt;/p&gt;</comment>
                            <comment id="17815874" author="jira-bot" created="Fri, 9 Feb 2024 00:30:24 +0000"  >&lt;p&gt;Commit d98e26cc3310697fbf80a1bb428ed257548cfcd1 in solr&apos;s branch refs/heads/branch_9x from Chris M. Hostetter&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=solr.git;h=d98e26cc331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=solr.git;h=d98e26cc331&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-16858&quot; title=&quot;Allow KnnQParser to selectively apply filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-16858&quot;&gt;&lt;del&gt;SOLR-16858&lt;/del&gt;&lt;/a&gt;: KnnQParser&apos;s &quot;Pre-Filtering&quot; behavior is now controlable via local params (closes #2157)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b88fa0d7d15d70cea669218ab9dfd1068f9fcf73)&lt;/p&gt;</comment>
                            <comment id="17815875" author="hossman" created="Fri, 9 Feb 2024 00:30:42 +0000"  >&lt;p&gt;thanks for all the review folks!&lt;/p&gt;</comment>
                            <comment id="17816040" author="alessandro.benedetti" created="Fri, 9 Feb 2024 12:41:19 +0000"  >&lt;p&gt;Thank you for the contribution!&lt;/p&gt;</comment>
                            <comment id="17841720" author="gus_heck" created="Sun, 28 Apr 2024 19:22:39 +0000"  >&lt;p&gt;Closing after the 9.6.0 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13065337" name="SOLR-16858-1.patch" size="29170" author="hossman" created="Fri, 15 Dec 2023 01:37:06 +0000"/>
                            <attachment id="13065150" name="SOLR-16858.patch" size="12994" author="hossman" created="Sat, 9 Dec 2023 00:15:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 28 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1iumo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>