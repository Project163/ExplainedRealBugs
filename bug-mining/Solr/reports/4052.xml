<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:35:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12729] SplitShardCmd should lock the parent shard to prevent parallel splitting requests</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12729</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;This scenario was discovered by the simulation framework, but it exists also in the non-simulated code.&lt;/p&gt;

&lt;p&gt;When &lt;tt&gt;IndexSizeTrigger&lt;/tt&gt; requests SPLITSHARD, which is then successfully started and &#8220;completed&#8221; from the point of view of &lt;tt&gt;ExecutePlanAction&lt;/tt&gt;, the reality is that it still can take significant amount of time until the moment when the new replicas fully recover and cause the switch of shard states (parent to INACTIVE, child from RECOVERY to ACTIVE).&lt;/p&gt;

&lt;p&gt;If this time is longer than the trigger&apos;s &lt;tt&gt;waitFor&lt;/tt&gt; the trigger will issue the same SPLITSHARD request again. &lt;tt&gt;SplitShardCmd&lt;/tt&gt; doesn&apos;t prevent this new request from being processed because the parent shard is still ACTIVE. However, a section of the code in &lt;tt&gt;SplitShardCmd&lt;/tt&gt; will realize that sub-slices with the target names already exist and they are not active, at which point it will delete the new sub-slices (&lt;tt&gt;SplitShardCmd:182&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;The end result is an infinite loop, where &lt;tt&gt;IndexSizeTrigger&lt;/tt&gt; will keep generating SPLITSHARD, and &lt;tt&gt;SplitShardCmd&lt;/tt&gt; will keep deleting the recovering sub-slices created by the previous command.&lt;/p&gt;

&lt;p&gt;A simple solution is for the parent shard to be marked to indicate that it&#8217;s in a process of splitting, so that no other split is attempted on the same shard. Furthermore, &lt;tt&gt;IndexSizeTrigger&lt;/tt&gt; could temporarily exclude such shards from monitoring.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13182601">SOLR-12729</key>
            <summary>SplitShardCmd should lock the parent shard to prevent parallel splitting requests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="ab">Andrzej Bialecki</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Sep 2018 10:37:05 +0000</created>
                <updated>Mon, 8 Sep 2025 12:18:45 +0000</updated>
                            <resolved>Mon, 22 Oct 2018 10:40:25 +0000</resolved>
                                                    <fixVersion>7.6</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>AutoScaling</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16602080" author="ab" created="Mon, 3 Sep 2018 12:07:58 +0000"  >&lt;p&gt;Shalin suggested that we could use an ephemeral znode to signal that a shard is in the process of being split. This way the lock would be automatically released on Overseer crash.&lt;/p&gt;

&lt;p&gt;We should also check for stale locks, if eg. a sub-shard is permanently stuck in RECOVERY. This can be implemented in &lt;tt&gt;InactiveShardPlanAction&lt;/tt&gt;, which is periodically invoked from the maintenance trigger.&lt;/p&gt;</comment>
                            <comment id="16658773" author="jira-bot" created="Mon, 22 Oct 2018 09:28:20 +0000"  >&lt;p&gt;Commit 8c70811f3a2a4deab8186b187909ac5c3615e6fb in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8c70811&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8c70811&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12729&quot; title=&quot;SplitShardCmd should lock the parent shard to prevent parallel splitting requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12729&quot;&gt;&lt;del&gt;SOLR-12729&lt;/del&gt;&lt;/a&gt;: Unlock the shard on error.&lt;/p&gt;</comment>
                            <comment id="16658864" author="jira-bot" created="Mon, 22 Oct 2018 10:39:19 +0000"  >&lt;p&gt;Commit f47acc4588346843f3a20d1e973fcfe3fdbe10c2 in lucene-solr&apos;s branch refs/heads/branch_7x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f47acc4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f47acc4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12729&quot; title=&quot;SplitShardCmd should lock the parent shard to prevent parallel splitting requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12729&quot;&gt;&lt;del&gt;SOLR-12729&lt;/del&gt;&lt;/a&gt;: SplitShardCmd should lock the parent shard to prevent parallel splitting requests.&lt;/p&gt;</comment>
                            <comment id="16658865" author="jira-bot" created="Mon, 22 Oct 2018 10:39:20 +0000"  >&lt;p&gt;Commit 90c1804131108091c06dc50ccc3e4ed72c2a854d in lucene-solr&apos;s branch refs/heads/branch_7x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=90c1804&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=90c1804&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12729&quot; title=&quot;SplitShardCmd should lock the parent shard to prevent parallel splitting requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12729&quot;&gt;&lt;del&gt;SOLR-12729&lt;/del&gt;&lt;/a&gt;: Unlock the shard on error.&lt;/p&gt;</comment>
                            <comment id="18017907" author="gerlowskija" created="Wed, 3 Sep 2025 13:54:40 +0000"  >&lt;p&gt;Ran into some lock-orphaning issues recently, which brought me to this JIRA ticket.  My understanding of the design is as follows:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;lock is created early on in SplitShardCmd, as the ephemeral znode &quot;/collections/myCollName/&amp;lt;shardName&amp;gt;-splitting&quot;&lt;/li&gt;
	&lt;li&gt;SplitShardCmd cleans up the lock in a try-finally, handling the failure case (i.e. when &quot;success&quot; flag is false)&lt;/li&gt;
	&lt;li&gt;when SplitShardCmd finishes successfully, (i.e. &quot;success&quot; flag is true), the lock is left in place&lt;/li&gt;
	&lt;li&gt;ReplicaMutator.setState cleans up the lock when it detects that the last sub-shard replica has finished recovery, which aims to cover the successful case.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Assuming that understand is correct and I&apos;m not missing other pieces of the design, I think we&apos;ve got some issues:&lt;/p&gt;

&lt;p&gt;First, it seems like we&apos;re trying to cover replica-recovery in the locking, but we do so inconsistently.  In the happy-path, the lock is left in place until after sub-shard replicas recover.  But if the overseer node restarts during that recovery phase, then the ephemeral lock will be lost.&lt;/p&gt;

&lt;p&gt;Second (and admittedly less importantly),  the lock can be orphaned if users attempt to delete sub-shard replicas (or the sub-shard itself) while they&apos;re still recovering.  In particular I&apos;ve seen this occur when workflow automation gives up on a long-running split and runs DELETESHARD on the two sub-shards.  DELETESHARD succeeds...but as a result the ReplicaMutator lock-clearing will never trigger.  I suspect this would also occur if a user runs DELETEREPLICA on a recovering sub-shard replica, but haven&apos;t tested it myself.&lt;/p&gt;</comment>
                            <comment id="18017912" author="gerlowskija" created="Wed, 3 Sep 2025 14:10:42 +0000"  >&lt;p&gt;Is my understanding above correct &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt;?  Am I missing anything?&lt;/p&gt;

&lt;p&gt;If so, wdyt about changing the locking to only cover the split itself (i.e. NOT cover sub-shard replica recovery).  Replicas do full-recovery all the time without the benefit of any special locking.  If we&apos;re worried about some automation re-triggering the split while replicas are in recovery, then we can detect that and abort in SplitShardCmd.  &lt;a href=&quot;https://github.com/apache/solr/blob/main/solr/core/src/java/org/apache/solr/cloud/api/collections/SplitShardCmd.java#L331-L334&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SplitShardCmd already has a check for &quot;active&quot; sub-shards&lt;/a&gt;, seems reasonable to extend that to cover &quot;recovering&quot; sub-shards as well?&lt;/p&gt;</comment>
                            <comment id="18018818" author="ab" created="Mon, 8 Sep 2025 12:18:45 +0000"  >&lt;p&gt;Re. the existing design - yes, that&apos;s the way it was supposed to work. And I agree that it doesn&apos;t work well in these edge-cases.&lt;/p&gt;

&lt;p&gt;Re. your proposed change: at the moment I can&apos;t find any reason why it shouldn&apos;t work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160; However ... it&apos;s been 7 years since I worked on this code but I still remember I had quite a few nasty surprises regarding the proper ordering of steps, rolling back while new requests may be coming, etc .. so I can&apos;t guarantee that something else won&apos;t break.&lt;/p&gt;

&lt;p&gt;Maybe a simpler fix would be to recognize these additional cases and do a re-lock + cleanup, or reject the new request?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xo67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>