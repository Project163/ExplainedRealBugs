<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:53:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-6159] cancelElection fails on uninitialized ElectionContext</title>
                <link>https://issues.apache.org/jira/browse/SOLR-6159</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I had a solr collection that basically was out of memory (no exception, just continuous 80-90 second full GCs). This of course is not a good state, but when in this state ever time you come out of the GC your zookeeper session has expired causing all kinds of havoc. Anyway I found bug in the condition where during LeaderElector.setup() if you get a Zookeeper error the LeaderElector.context get set to a context that is not fully initialized (ie hasn&apos;t called joinElection..&lt;/p&gt;

&lt;p&gt;Anyway once this happens the node can no longer attempt to join elections because every time the LeaderElector attempts to call cancelElection() on the previous ElectionContext..&lt;/p&gt;

&lt;p&gt;Some logs below and I&apos;ve attached a patch that does 2 things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Move the setting of LeaderElector.context in the setup call to then of the call so it is only set if the setup completes.&lt;/li&gt;
	&lt;li&gt;Added a check to see if leaderSeqPath is null in ElectionContext.cancelElection&lt;/li&gt;
	&lt;li&gt;Made leaderSeqPath volatile as it is being directly accessed by multiple threads.&lt;/li&gt;
	&lt;li&gt;set LeaderElector.context = null when joinElection fails&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There may be other issues.. the patch is focused on breaking the failure loop that occurs when initialization of the ElectionContext fails.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-06-08 23:14:57.805 INFO  ClientCnxn [main-SendThread(host1:1234)] - Opening socket connection to server host1/10.122.142.31:1234. Will not attempt to authenticate using SASL (unknown error)
2014-06-08 23:14:57.806 INFO  ClientCnxn [main-SendThread(host1:1234)] - Socket connection established to host1/10.122.142.31:1234, initiating session
2014-06-08 23:14:57.810 INFO  ClientCnxn [main-SendThread(host1:1234)] - Unable to reconnect to ZooKeeper service, session 0x2467d956c8d0446 has expired, closing socket connection
2014-06-08 23:14:57.816 INFO  ConnectionManager [main-EventThread] - Watcher org.apache.solr.common.cloud.ConnectionManager@7fe8e0f1 name:ZooKeeperConnection Watcher:host4:1234,host1:1234,host3:1234,host2:1234/engines/solr/collections/XXXXXX got event WatchedEvent state:Expired type:None path:null path:null type:None
2014-06-08 23:14:57.817 INFO  ConnectionManager [main-EventThread] - Our previous ZooKeeper session was expired. Attempting to reconnect to recover relationship with ZooKeeper...
2014-06-08 23:14:57.817 INFO  DefaultConnectionStrategy [main-EventThread] - Connection expired - starting a new one...
2014-06-08 23:14:57.817 INFO  ZooKeeper [main-EventThread] - Initiating client connection, connectString=host4:1234,host1:1234,host3:1234,host2:1234/engines/solr/collections/XXXXXX sessionTimeout=15000 watcher=org.apache.solr.common.cloud.ConnectionManager@7fe8e0f1
2014-06-08 23:14:57.857 INFO  ConnectionManager [main-EventThread] - Waiting for client to connect to ZooKeeper
2014-06-08 23:14:57.859 INFO  ClientCnxn [main-SendThread(host4:1234)] - Opening socket connection to server host4/172.17.14.107:1234. Will not attempt to authenticate using SASL (unknown error)
2014-06-08 23:14:57.891 INFO  ClientCnxn [main-SendThread(host4:1234)] - Socket connection established to host4/172.17.14.107:1234, initiating session
2014-06-08 23:14:57.906 INFO  ClientCnxn [main-SendThread(host4:1234)] - Session establishment complete on server host4/172.17.14.107:1234, sessionid = 0x4467d8d79260486, negotiated timeout = 15000
2014-06-08 23:14:57.907 INFO  ConnectionManager [main-EventThread] - Watcher org.apache.solr.common.cloud.ConnectionManager@7fe8e0f1 name:ZooKeeperConnection Watcher:host4:1234,host1:1234,host3:1234,host2:1234/engines/solr/collections/XXXXXX got event WatchedEvent state:SyncConnected type:None path:null path:null type:None
2014-06-08 23:14:57.909 INFO  ConnectionManager [main-EventThread] - Client is connected to ZooKeeper
2014-06-08 23:14:57.909 INFO  ConnectionManager [main-EventThread] - Connection with ZooKeeper reestablished.
2014-06-08 23:14:57.911 ERROR ZkController [Thread-203] - :org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /overseer_elect/election
  at org.apache.zookeeper.KeeperException.create(KeeperException.java:127)
  at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
  at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1045)
  at org.apache.solr.common.cloud.SolrZkClient$4.execute(SolrZkClient.java:226)
  at org.apache.solr.common.cloud.SolrZkClient$4.execute(SolrZkClient.java:223)
  at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
  at org.apache.solr.common.cloud.SolrZkClient.exists(SolrZkClient.java:223)
  at org.apache.solr.common.cloud.ZkCmdExecutor.ensureExists(ZkCmdExecutor.java:100)
  at org.apache.solr.common.cloud.ZkCmdExecutor.ensureExists(ZkCmdExecutor.java:94)
  at org.apache.solr.cloud.LeaderElector.setup(LeaderElector.java:324)
  at org.apache.solr.cloud.ZkController$1.command(ZkController.java:235)
  at org.apache.solr.common.cloud.ConnectionManager$1$1.run(ConnectionManager.java:166)
2014-06-08 23:14:57.911 WARN  ConnectionManager [Thread-203] - Exception running onReconnect command
org.apache.solr.common.cloud.ZooKeeperException:
  at org.apache.solr.cloud.ZkController$1.command(ZkController.java:267)
  at org.apache.solr.common.cloud.ConnectionManager$1$1.run(ConnectionManager.java:166)
Caused by: org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /overseer_elect/election
  at org.apache.zookeeper.KeeperException.create(KeeperException.java:127)
  at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
  at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1045)
  at org.apache.solr.common.cloud.SolrZkClient$4.execute(SolrZkClient.java:226)
  at org.apache.solr.common.cloud.SolrZkClient$4.execute(SolrZkClient.java:223)
  at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
  at org.apache.solr.common.cloud.SolrZkClient.exists(SolrZkClient.java:223)
  at org.apache.solr.common.cloud.ZkCmdExecutor.ensureExists(ZkCmdExecutor.java:100)
  at org.apache.solr.common.cloud.ZkCmdExecutor.ensureExists(ZkCmdExecutor.java:94)
  at org.apache.solr.cloud.LeaderElector.setup(LeaderElector.java:324)
  at org.apache.solr.cloud.ZkController$1.command(ZkController.java:235)
  ... 1 more
2014-06-08 23:14:57.917 INFO  DefaultConnectionStrategy [main-EventThread] - Reconnected to ZooKeeper
2014-06-08 23:14:57.917 INFO  ConnectionManager [main-EventThread] - Connected:true
2014-06-08 23:14:57.917 INFO  ClientCnxn [main-EventThread] - EventThread shut down
2014-06-08 23:14:57.917 INFO  ZkController [Thread-205] - publishing core=XXXXXX state=down collection=XXXXXX
2014-06-08 23:14:57.920 INFO  ZkController [Thread-205] - numShards not found on descriptor - reading it from system property
2014-06-08 23:14:58.033 INFO  ElectionContext [Thread-205] - canceling election null
2014-06-08 23:14:58.083 ERROR ZkController [Thread-205] - :java.lang.IllegalArgumentException: Path cannot be null
  at org.apache.zookeeper.common.PathUtils.validatePath(PathUtils.java:45)
  at org.apache.zookeeper.ZooKeeper.delete(ZooKeeper.java:851)
  at org.apache.solr.common.cloud.SolrZkClient$2.execute(SolrZkClient.java:177)
  at org.apache.solr.common.cloud.SolrZkClient$2.execute(SolrZkClient.java:174)
  at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
  at org.apache.solr.common.cloud.SolrZkClient.delete(SolrZkClient.java:174)
  at org.apache.solr.cloud.ElectionContext.cancelElection(ElectionContext.java:72)
  at org.apache.solr.cloud.OverseerElectionContext.cancelElection(ElectionContext.java:447)
  at org.apache.solr.cloud.ZkController$1.command(ZkController.java:232)
  at org.apache.solr.common.cloud.ConnectionManager$1$1.run(ConnectionManager.java:166)
2014-06-08 23:14:58.083 WARN  ConnectionManager [Thread-205] - Exception running onReconnect command
org.apache.solr.common.cloud.ZooKeeperException:
  at org.apache.solr.cloud.ZkController$1.command(ZkController.java:267)
  at org.apache.solr.common.cloud.ConnectionManager$1$1.run(ConnectionManager.java:166)
Caused by: java.lang.IllegalArgumentException: Path cannot be null
  at org.apache.zookeeper.common.PathUtils.validatePath(PathUtils.java:45)
  at org.apache.zookeeper.ZooKeeper.delete(ZooKeeper.java:851)
  at org.apache.solr.common.cloud.SolrZkClient$2.execute(SolrZkClient.java:177)
  at org.apache.solr.common.cloud.SolrZkClient$2.execute(SolrZkClient.java:174)
  at org.apache.solr.common.cloud.ZkCmdExecutor.retryOperation(ZkCmdExecutor.java:73)
  at org.apache.solr.common.cloud.SolrZkClient.delete(SolrZkClient.java:174)
  at org.apache.solr.cloud.ElectionContext.cancelElection(ElectionContext.java:72)
  at org.apache.solr.cloud.OverseerElectionContext.cancelElection(ElectionContext.java:447)
  at org.apache.solr.cloud.ZkController$1.command(ZkController.java:232)
  ... 1 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12720515">SOLR-6159</key>
            <summary>cancelElection fails on uninitialized ElectionContext</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shalin">Shalin Shekhar Mangar</assignee>
                                    <reporter username="sbower">Steven Bower</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jun 2014 04:46:28 +0000</created>
                <updated>Mon, 9 May 2016 18:52:52 +0000</updated>
                            <resolved>Tue, 1 Jul 2014 07:01:13 +0000</resolved>
                                    <version>4.8.1</version>
                                    <fixVersion>4.10</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14033422" author="shalinmangar" created="Tue, 17 Jun 2014 04:30:45 +0000"  >&lt;p&gt;Nice catch! Thanks Steven. Let me see if I can re-create the problem in a test.&lt;/p&gt;</comment>
                            <comment id="14048012" author="shalinmangar" created="Mon, 30 Jun 2014 19:25:40 +0000"  >&lt;p&gt;Added a new test called TestLeaderElectionZkExpiry which expires zk sessions in a tight loop. This test is able to reproduce the problem reported in this issue 6 out of 10 times on my machine. The patch given by Steven fixes the problems.&lt;/p&gt;</comment>
                            <comment id="14048584" author="jira-bot" created="Tue, 1 Jul 2014 07:00:11 +0000"  >&lt;p&gt;Commit 1606996 from shalin@apache.org in branch &apos;dev/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1606996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1606996&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6159&quot; title=&quot;cancelElection fails on uninitialized ElectionContext&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6159&quot;&gt;&lt;del&gt;SOLR-6159&lt;/del&gt;&lt;/a&gt;: A ZooKeeper session expiry during setup can keep LeaderElector from joining elections&lt;/p&gt;</comment>
                            <comment id="14048585" author="jira-bot" created="Tue, 1 Jul 2014 07:00:46 +0000"  >&lt;p&gt;Commit 1606997 from shalin@apache.org in branch &apos;dev/branches/branch_4x&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1606997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1606997&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-6159&quot; title=&quot;cancelElection fails on uninitialized ElectionContext&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-6159&quot;&gt;&lt;del&gt;SOLR-6159&lt;/del&gt;&lt;/a&gt;: A ZooKeeper session expiry during setup can keep LeaderElector from joining elections&lt;/p&gt;</comment>
                            <comment id="14048586" author="shalinmangar" created="Tue, 1 Jul 2014 07:01:13 +0000"  >&lt;p&gt;Thanks Steven!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12722408">SOLR-6181</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12653210" name="SOLR-6159.patch" size="6752" author="shalin" created="Mon, 30 Jun 2014 19:25:40 +0000"/>
                            <attachment id="12649746" name="SOLR-6159.patch" size="2286" author="sbower" created="Wed, 11 Jun 2014 04:54:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398714</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wn5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398836</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>