<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:28:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-3642] Count is inconsistent between facet and stats</title>
                <link>https://issues.apache.org/jira/browse/SOLR-3642</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;1) Download apache-solr-4.0.0-ALPHA&lt;br/&gt;
2) cd example;  java -jar start.jar&lt;br/&gt;
3) cd exampledocs;  ./post.sh *.xml&lt;br/&gt;
4) Use statsComponent to get the stats info for field &apos;popularity&apos; based on facet &apos;cat&apos;.  And the &apos;count&apos; for &apos;electronics&apos; is 3&lt;br/&gt;
&lt;a href=&quot;http://localhost:8983/solr/collection1/select?q=cat:electronics&amp;amp;wt=json&amp;amp;rows=0&amp;amp;stats=true&amp;amp;stats.field=popularity&amp;amp;stats.facet=cat&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/collection1/select?q=cat:electronics&amp;amp;wt=json&amp;amp;rows=0&amp;amp;stats=true&amp;amp;stats.field=popularity&amp;amp;stats.facet=cat&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;stats_fields: &lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;popularity: &lt;br/&gt;
{&lt;/p&gt;

&lt;p&gt;min: 0,&lt;br/&gt;
max: 10,&lt;br/&gt;
count: 14,&lt;br/&gt;
missing: 0,&lt;br/&gt;
sum: 75,&lt;br/&gt;
sumOfSquares: 503,&lt;br/&gt;
mean: 5.357142857142857,&lt;br/&gt;
stddev: 2.7902892835178013,&lt;br/&gt;
facets: &lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;cat: &lt;br/&gt;
{&lt;/p&gt;

&lt;p&gt;music: &lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;min: 10,&lt;/p&gt;

&lt;p&gt;max: 10,&lt;/p&gt;

&lt;p&gt;count: 1,&lt;/p&gt;

&lt;p&gt;missing: 0,&lt;/p&gt;

&lt;p&gt;sum: 10,&lt;/p&gt;

&lt;p&gt;sumOfSquares: 100,&lt;/p&gt;

&lt;p&gt;mean: 10,&lt;/p&gt;

&lt;p&gt;stddev: 0&lt;br/&gt;
},&lt;/p&gt;

&lt;p&gt;monitor: &lt;br/&gt;
{&lt;/p&gt;

&lt;p&gt;min: 6,&lt;br/&gt;
max: 6,&lt;br/&gt;
count: 2,&lt;br/&gt;
missing: 0,&lt;br/&gt;
sum: 12,&lt;br/&gt;
sumOfSquares: 72,&lt;br/&gt;
mean: 6,&lt;br/&gt;
stddev: 0&lt;br/&gt;
},&lt;br/&gt;
hard drive: &lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;min: 6,&lt;/p&gt;

&lt;p&gt;max: 6,&lt;/p&gt;

&lt;p&gt;count: 2,&lt;/p&gt;

&lt;p&gt;missing: 0,&lt;/p&gt;

&lt;p&gt;sum: 12,&lt;/p&gt;

&lt;p&gt;sumOfSquares: 72,&lt;/p&gt;

&lt;p&gt;mean: 6,&lt;/p&gt;

&lt;p&gt;stddev: 0&lt;br/&gt;
},&lt;/p&gt;

&lt;p&gt;scanner: &lt;br/&gt;
{&lt;/p&gt;

&lt;p&gt;min: 6,&lt;br/&gt;
max: 6,&lt;br/&gt;
count: 1,&lt;br/&gt;
missing: 0,&lt;br/&gt;
sum: 6,&lt;br/&gt;
sumOfSquares: 36,&lt;br/&gt;
mean: 6,&lt;br/&gt;
stddev: 0&lt;br/&gt;
},&lt;br/&gt;
memory: &lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;min: 0,&lt;/p&gt;

&lt;p&gt;max: 7,&lt;/p&gt;

&lt;p&gt;count: 3,&lt;/p&gt;

&lt;p&gt;missing: 0,&lt;/p&gt;

&lt;p&gt;sum: 12,&lt;/p&gt;

&lt;p&gt;sumOfSquares: 74,&lt;/p&gt;

&lt;p&gt;mean: 4,&lt;/p&gt;

&lt;p&gt;stddev: 3.605551275463989&lt;br/&gt;
},&lt;/p&gt;

&lt;p&gt;graphics card: &lt;br/&gt;
{&lt;/p&gt;

&lt;p&gt;min: 7,&lt;br/&gt;
max: 7,&lt;br/&gt;
count: 2,&lt;br/&gt;
missing: 0,&lt;br/&gt;
sum: 14,&lt;br/&gt;
sumOfSquares: 98,&lt;br/&gt;
mean: 7,&lt;br/&gt;
stddev: 0&lt;br/&gt;
},&lt;br/&gt;
electronics: &lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;min: 1,&lt;/p&gt;

&lt;p&gt;max: 7,&lt;/p&gt;

&lt;p&gt;count: 3,&lt;/p&gt;

&lt;p&gt;missing: 0,&lt;/p&gt;

&lt;p&gt;sum: 9,&lt;/p&gt;

&lt;p&gt;sumOfSquares: 51,&lt;/p&gt;

&lt;p&gt;mean: 3,&lt;/p&gt;

&lt;p&gt;stddev: 3.4641016151377544&lt;br/&gt;
}&lt;br/&gt;
}&lt;br/&gt;
}&lt;br/&gt;
}&lt;br/&gt;
}&lt;br/&gt;
}&lt;br/&gt;
5)  Facet on &apos;cat&apos; and the count is 14.  &lt;a href=&quot;http://localhost:8983/solr/collection1/select?q=cat:electronics&amp;amp;wt=json&amp;amp;rows=0&amp;amp;facet=true&amp;amp;facet.field=cat&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/collection1/select?q=cat:electronics&amp;amp;wt=json&amp;amp;rows=0&amp;amp;facet=true&amp;amp;facet.field=cat&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;cat: &lt;/p&gt;

&lt;p&gt;[&lt;/p&gt;

&lt;p&gt;&quot;electronics&quot;,&lt;/p&gt;

&lt;p&gt;14,&lt;/p&gt;

&lt;p&gt;&quot;memory&quot;,&lt;/p&gt;

&lt;p&gt;3,&lt;/p&gt;

&lt;p&gt;&quot;connector&quot;,&lt;/p&gt;

&lt;p&gt;2,&lt;/p&gt;

&lt;p&gt;&quot;graphics card&quot;,&lt;/p&gt;

&lt;p&gt;2,&lt;/p&gt;

&lt;p&gt;&quot;hard drive&quot;,&lt;/p&gt;

&lt;p&gt;2,&lt;/p&gt;

&lt;p&gt;&quot;monitor&quot;,&lt;/p&gt;

&lt;p&gt;2,&lt;/p&gt;

&lt;p&gt;&quot;camera&quot;,&lt;/p&gt;

&lt;p&gt;1,&lt;/p&gt;

&lt;p&gt;&quot;copier&quot;,&lt;/p&gt;

&lt;p&gt;1,&lt;/p&gt;

&lt;p&gt;&quot;multifunction printer&quot;,&lt;/p&gt;

&lt;p&gt;1,&lt;/p&gt;

&lt;p&gt;&quot;music&quot;,&lt;/p&gt;

&lt;p&gt;1,&lt;/p&gt;

&lt;p&gt;&quot;printer&quot;,&lt;/p&gt;

&lt;p&gt;1,&lt;/p&gt;

&lt;p&gt;&quot;scanner&quot;,&lt;/p&gt;

&lt;p&gt;1,&lt;/p&gt;

&lt;p&gt;&quot;currency&quot;,&lt;/p&gt;

&lt;p&gt;0,&lt;/p&gt;

&lt;p&gt;&quot;search&quot;,&lt;/p&gt;

&lt;p&gt;0,&lt;/p&gt;

&lt;p&gt;&quot;software&quot;,&lt;/p&gt;

&lt;p&gt;0&lt;br/&gt;
]&lt;br/&gt;
},&lt;/p&gt;




&lt;p&gt;So from StatsComponent the count for &apos;electronics&apos; cat is 3, while FacetComponent report 14 &apos;electronics&apos;. Is this a bug?&lt;/p&gt;

&lt;p&gt;Following is the field definition for &apos;cat&apos;. &lt;br/&gt;
&amp;lt;field name=&quot;cat&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot;/&amp;gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;4.0 alpha on macos 10.6&lt;/p&gt;</environment>
        <key id="12599383">SOLR-3642</key>
            <summary>Count is inconsistent between facet and stats</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hossman">Chris M. Hostetter</assignee>
                                    <reporter username="yydzero">Yandong Yao</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Jul 2012 00:03:53 +0000</created>
                <updated>Mon, 9 May 2016 18:43:43 +0000</updated>
                            <resolved>Thu, 19 Jul 2012 21:30:22 +0000</resolved>
                                    <version>4.0-ALPHA</version>
                                    <fixVersion>4.0-BETA</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>SearchComponents - other</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13417887" author="hossman" created="Thu, 19 Jul 2012 00:17:13 +0000"  >&lt;p&gt;I believe the root problem here is that&quot;stats.facet&quot; is relatively naive and doesn&apos;t work with multivalued fields (and &quot;cat&quot; is multivalued)&lt;/p&gt;</comment>
                            <comment id="13417906" author="yydzero" created="Thu, 19 Jul 2012 00:39:28 +0000"  >&lt;p&gt;You are right, Relative code below:&lt;/p&gt;

&lt;p&gt;      SchemaField fsf = searcher.getSchema().getField(facetField);&lt;br/&gt;
      FieldType facetFieldType = fsf.getType();&lt;/p&gt;

&lt;p&gt;      if (facetFieldType.isTokenized() || facetFieldType.isMultiValued()) &lt;/p&gt;
{
        throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,
          &quot;Stats can only facet on single-valued fields, not: &quot; + facetField
          + &quot;[&quot; + facetFieldType + &quot;]&quot;);
        }
&lt;p&gt;      try &lt;/p&gt;
{
        facetTermsIndex = FieldCache.DEFAULT.getTermsIndex(searcher.getAtomicReader(), facetField);
      }

&lt;p&gt;Sounds like the condition is not enough for multiValued field check, should be:&lt;/p&gt;

&lt;p&gt;      if (fsf.multiValued() || facetFieldType.isTokenized() || facetFieldType.isMultiValued()) &lt;/p&gt;</comment>
                            <comment id="13418603" author="hossman" created="Thu, 19 Jul 2012 19:34:18 +0000"  >&lt;p&gt;Nice catch!&lt;/p&gt;

&lt;p&gt;yeah, that entire error check is bogus &amp;#8211; the properties of the field type don&apos;t matter at all, just the properties of the SchemaField (and tokenized isn&apos;t a valid check, because something could use &quot;KeywordTokenizer&quot; and would be valid to facet on)&lt;/p&gt;

&lt;p&gt;here&apos;s a patch with a test to ensure we fail instead of giving bogus results back (still running all tests to make sure i havne&apos;t broken something else)&lt;/p&gt;</comment>
                            <comment id="13418681" author="hossman" created="Thu, 19 Jul 2012 21:30:22 +0000"  >&lt;p&gt;Committed revision 1363555. - trunk&lt;br/&gt;
Committed revision 1363556. - 4x&lt;/p&gt;

&lt;p&gt;Thanks Yandong!&lt;/p&gt;</comment>
                            <comment id="13418890" author="yydzero" created="Fri, 20 Jul 2012 02:48:40 +0000"  >&lt;p&gt;Hi Hoss,&lt;/p&gt;

&lt;p&gt;Thanks for the quick commit, one further question: if i would like to implement stats with facet field which is multi-valued field, would you please provide some guidance on this?&lt;/p&gt;

&lt;p&gt;Currently StatsComponent don&apos;t support multivalued facet field because it is using FieldCache which don&apos;t support multivalued field. Any alternatives?&lt;/p&gt;

&lt;p&gt;If it is possible, I would like to create a JIRA issue for it and try to work on it.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Yandong&lt;/p&gt;</comment>
                            <comment id="13421824" author="hossman" created="Tue, 24 Jul 2012 22:13:46 +0000"  >&lt;p&gt;Yandong: the issue i linked this one to (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1782&quot; title=&quot;stats.facet assumes FieldCache.StringIndex - fails horribly on multivalued fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1782&quot;&gt;&lt;del&gt;SOLR-1782&lt;/del&gt;&lt;/a&gt;) is open precisely to try and address this problem &amp;#8211; there is an (old) patch there that i honestly have not had time to look at, but you may want to take a look and see if it can be brought up to date and polished up to work and have good tests&lt;/p&gt;

&lt;p&gt;(IIRC: the reason i never really dug into it before was because the way StatsComponent deals with stats.facet in general struck me as being kind of kludgy and hard to understand, and i couldn&apos;t see a clean way to make it work well with both multivalued fields and arbitrary field types)&lt;/p&gt;

&lt;p&gt;(EDIT: i don&apos;t usually worry about typos, but i&apos;m sorry for spelling your name wrong) &lt;/p&gt;</comment>
                            <comment id="13425402" author="yydzero" created="Mon, 30 Jul 2012 23:57:16 +0000"  >&lt;p&gt;Hi Hoss,&lt;/p&gt;

&lt;p&gt;Thanks a lot, Will look at the patch at &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1782&quot; title=&quot;stats.facet assumes FieldCache.StringIndex - fails horribly on multivalued fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-1782&quot;&gt;&lt;del&gt;SOLR-1782&lt;/del&gt;&lt;/a&gt; and try to apply to trunk.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Yandong&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12456802">SOLR-1782</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12537233" name="SOLR-3642.patch" size="2891" author="hossman" created="Thu, 19 Jul 2012 19:34:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243341</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i03dhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17618</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>