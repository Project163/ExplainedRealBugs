<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:44:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-14431] Using &quot;Segments Info&quot; UI screen can cause future stalls in replication/recovery/core-reload (/admin/segments)</title>
                <link>https://issues.apache.org/jira/browse/SOLR-14431</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;A bug in the &lt;tt&gt;SegmentsInfoRequestHandler&lt;/tt&gt; (aka: &lt;tt&gt;/admin/segments&lt;/tt&gt; - which is used under the covers when viewing the &quot;Segments Info&quot; panel of a core in the Admin UI) causes it to increment the internal &quot;ref-count&quot; of the IndexWriter by default, with out ever decrementing that ref-count.&lt;/p&gt;

&lt;p&gt;This can cause delayed problems in any situation where the IndexWriter needs updated/replaced/locked:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Core &lt;tt&gt;RELOAD&lt;/tt&gt; operations&lt;/li&gt;
	&lt;li&gt;Master/Slave replication (via IndexFetcher)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;PULL&lt;/tt&gt; Replica updates (via IndexFetcher)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;TLOG&lt;/tt&gt; Replica updates (via IndexFetcher)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;NRT&lt;/tt&gt; Recovery from Leader (via IndexFetcher)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;...these manifest as operations that &quot;stall&quot; due to the threads attempting to execute them blocking forever waiting for a &lt;tt&gt;ReentrantReadWriteLock&lt;/tt&gt; in &lt;tt&gt;DefaultSolrCoreState&lt;/tt&gt; that will never be released.&lt;/p&gt;

&lt;p&gt;A config only workaround exists for this problem, by explicitly declaring the &lt;tt&gt;/admin/segments&lt;/tt&gt; handler in &lt;tt&gt;solrconfig.xml&lt;/tt&gt; with an &lt;tt&gt;invariants&lt;/tt&gt; param that requests additional info, forcing it down a code path where it &lt;em&gt;uses&lt;/em&gt; the IndexWriter, &lt;b&gt;and decrements the ref-count, releasing the lock&lt;/b&gt;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;solrconfig.xml workaround&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &amp;lt;requestHandler name=&lt;span class=&quot;code-quote&quot;&gt;&quot;/admin/segments&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;solr.SegmentsInfoRequestHandler&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;!-- work around &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; https:&lt;span class=&quot;code-comment&quot;&gt;//issues.apache.org/jira/browse/SOLR-14431 --&amp;gt;
&lt;/span&gt;    &amp;lt;lst name=&lt;span class=&quot;code-quote&quot;&gt;&quot;invariants&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;bool name=&lt;span class=&quot;code-quote&quot;&gt;&quot;coreInfo&quot;&lt;/span&gt;&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/bool&amp;gt;
    &amp;lt;/lst&amp;gt;
  &amp;lt;/requestHandler&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;Example stack traces of what this can look like&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;IndexFetcher example stalled thread&quot;&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      &quot;thread&quot;,{
        &quot;id&quot;:65,
        &quot;name&quot;:&quot;indexFetcher-19-thread-1&quot;,
        &quot;state&quot;:&quot;TIMED_WAITING&quot;,
        &quot;lock&quot;:&quot;java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync@22a18ed&quot;,
        &quot;cpuTime&quot;:&quot;1454860.0285ms&quot;,
        &quot;userTime&quot;:&quot;622230.0000ms&quot;,
        &quot;stackTrace&quot;:[&quot;java.base@11.0.7/jdk.internal.misc.Unsafe.park(Native Method)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:234)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireNanos(AbstractQueuedSynchronizer.java:980)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireNanos(AbstractQueuedSynchronizer.java:1288)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.locks.ReentrantReadWriteLock$WriteLock.tryLock(ReentrantReadWriteLock.java:1131)&quot;,
          &quot;org.apache.solr.update.DefaultSolrCoreState.lock(DefaultSolrCoreState.java:179)&quot;,
          &quot;org.apache.solr.update.DefaultSolrCoreState.closeIndexWriter(DefaultSolrCoreState.java:240)&quot;,
          &quot;org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:569)&quot;,
          &quot;org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:351)&quot;,
          &quot;org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:424)&quot;,
          &quot;org.apache.solr.handler.ReplicationHandler.lambda$setupPolling$13(ReplicationHandler.java:1210)&quot;,
          &quot;org.apache.solr.handler.ReplicationHandler$$Lambda$513/0x00000008006bf440.run(Unknown Source)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:305)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)&quot;,
          &quot;java.base@11.0.7/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)&quot;,
          &quot;java.base@11.0.7/java.lang.Thread.run(Thread.java:834)&quot;]},
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Core RELOAD example stalled thread&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      &quot;thread&quot;,{
        &quot;id&quot;:16,
        &quot;name&quot;:&quot;qtp1558079303-16&quot;,
        &quot;state&quot;:&quot;WAITING&quot;,
        &quot;lock&quot;:&quot;java.lang.Object@70c81fe1&quot;,
        &quot;cpuTime&quot;:&quot;73.4453ms&quot;,
        &quot;userTime&quot;:&quot;60.0000ms&quot;,
        &quot;stackTrace&quot;:[&quot;java.base@11.0.4/java.lang.Object.wait(Native Method)&quot;,
          &quot;java.base@11.0.4/java.lang.Object.wait(Object.java:328)&quot;,
          &quot;org.apache.solr.core.SolrCores.waitAddPendingCoreOps(SolrCores.java:394)&quot;,
          &quot;org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1545)&quot;,
          &quot;org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$2(CoreAdminOperation.java:132)&quot;,
          &quot;org.apache.solr.handler.admin.CoreAdminOperation$$Lambda$266/0x0000000100431040.execute(Unknown Source)&quot;,
          &quot;org.apache.solr.handler.admin.CoreAdminOperation.execute(CoreAdminOperation.java:362)&quot;,
          &quot;org.apache.solr.handler.admin.CoreAdminHandler$CallInfo.call(CoreAdminHandler.java:397)&quot;,
          &quot;org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:181)&quot;,
          &quot;org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:211)&quot;,
          &quot;org.apache.solr.servlet.HttpSolrCall.handleAdmin(HttpSolrCall.java:839)&quot;,
          &quot;org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:805)&quot;,
          &quot;org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:558)&quot;,
          &quot;org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:419)&quot;,
          &quot;org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:351)&quot;,
          &quot;org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1602)&quot;,
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;&quot;Original Jira Description&quot;&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;If withCoreInfo is false iwRef.decref() will not&lt;br/&gt;
 be called to release the reader lock, preventing any further writer locks.&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/lucene-solr/blob/3a743ea953f0ecfc35fc7b198f68d142ce99d789/solr/core/src/java/org/apache/solr/handler/admin/SegmentsInfoRequestHandler.java#L144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/3a743ea953f0ecfc35fc7b198f68d142ce99d789/solr/core/src/java/org/apache/solr/handler/admin/SegmentsInfoRequestHandler.java#L144&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Line 130 should be moved inside the if statement L144.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ab&quot; class=&quot;user-hover&quot; rel=&quot;ab&quot;&gt;ab&lt;/a&gt; FYI&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13300622">SOLR-14431</key>
            <summary>Using &quot;Segments Info&quot; UI screen can cause future stalls in replication/recovery/core-reload (/admin/segments)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ab">Andrzej Bialecki</assignee>
                                    <reporter username="Tiziano.DE">Tiziano Degaetano</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Apr 2020 19:04:49 +0000</created>
                <updated>Wed, 15 Jul 2020 15:09:57 +0000</updated>
                            <resolved>Mon, 4 May 2020 13:02:20 +0000</resolved>
                                    <version>8.1.1</version>
                    <version>8.5.1</version>
                                    <fixVersion>8.6</fixVersion>
                                    <component>Admin UI</component>
                    <component>replication (java)</component>
                    <component>SolrCloud</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17098901" author="jira-bot" created="Mon, 4 May 2020 12:58:52 +0000"  >&lt;p&gt;Commit 96a8c6a91c050b4db3c0f39ba68a55db4936f348 in lucene-solr&apos;s branch refs/heads/branch_8x from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=96a8c6a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=96a8c6a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14431&quot; title=&quot;Using &amp;quot;Segments Info&amp;quot; UI screen can cause future stalls in replication/recovery/core-reload (/admin/segments)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14431&quot;&gt;&lt;del&gt;SOLR-14431&lt;/del&gt;&lt;/a&gt;: SegmentsInfoRequestHandler does not release IndexWriter.&lt;/p&gt;</comment>
                            <comment id="17098902" author="jira-bot" created="Mon, 4 May 2020 12:59:11 +0000"  >&lt;p&gt;Commit 5eea489e447be1bbc291d1465fca8b40c1f46d11 in lucene-solr&apos;s branch refs/heads/master from Andrzej Bialecki&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=5eea489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=lucene-solr.git;h=5eea489&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-14431&quot; title=&quot;Using &amp;quot;Segments Info&amp;quot; UI screen can cause future stalls in replication/recovery/core-reload (/admin/segments)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-14431&quot;&gt;&lt;del&gt;SOLR-14431&lt;/del&gt;&lt;/a&gt;: SegmentsInfoRequestHandler does not release IndexWriter.&lt;/p&gt;</comment>
                            <comment id="17098906" author="ab" created="Mon, 4 May 2020 13:02:20 +0000"  >&lt;p&gt;I applied your fix and modified a unit test to ensure the fix works as intended. Thanks Tiziano!&lt;/p&gt;</comment>
                            <comment id="17147966" author="hossman" created="Mon, 29 Jun 2020 16:58:48 +0000"  >&lt;p&gt;updated jira summary, description, and metadata to make it more clear how serious this issue is, and to point out a config only work around.&lt;/p&gt;</comment>
                            <comment id="17158324" author="broustant" created="Wed, 15 Jul 2020 15:09:57 +0000"  >&lt;p&gt;Closing after the 8.6.0 release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13302129">SOLR-14450</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13302606">SOLR-14458</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0e0ag:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>