<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 03:34:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-4380] ReplicationHandler replicateAfter startup not showing commits after SOLR-3911</title>
                <link>https://issues.apache.org/jira/browse/SOLR-4380</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;In the process of upgrading to 4.1 from 3.6, I&apos;ve noticed that our master servers do not show any commit points &amp;#8211; e.g. via &lt;a href=&quot;http://127.0.0.1:8983/solr/collection1/replication?command=commits&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://127.0.0.1:8983/solr/collection1/replication?command=commits&lt;/a&gt; &amp;#8211; available until after a new commit happens. So, for static indexes, replication doesn&apos;t happen and for dynamic indexes, we have to wait until an incremental update of master for slaves to see any commits.&lt;/p&gt;

&lt;p&gt;Tracing through the code, it looks like the change that may have effected us was part of &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3911&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SOLR-3911&lt;/a&gt;, specifically commenting out the initialization of the newIndexWriter in the replicateAfterStartup block &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// TODO: perhaps &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is no longer necessary then?
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// core.getUpdateHandler().newIndexWriter(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m guessing this is commented out because it is assumed that indexCommitPoint was going to be set by that block, but when a slave requests commits, that goes back to core.getDeletionPolicy().getCommits() to fetch the list of commits. If no indexWriter has been initialized, then, as far as I can tell, IndexDeletionPolicyWrapper#onInit will not have been called and there will be no commits available.&lt;/p&gt;

&lt;p&gt;By uncommenting this line, I was able to see commits on startup and slaves began to replicate successfully.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/viewvc/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/handler/ReplicationHandler.java?annotate=1420992&amp;amp;diff_format=h&amp;amp;pathrev=1420992#l880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/lucene/dev/branches/branch_4x/solr/core/src/java/org/apache/solr/handler/ReplicationHandler.java?annotate=1420992&amp;amp;diff_format=h&amp;amp;pathrev=1420992#l880&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12629807">SOLR-4380</key>
            <summary>ReplicationHandler replicateAfter startup not showing commits after SOLR-3911</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markrmiller@gmail.com">Mark Miller</assignee>
                                    <reporter username="greggny3">Gregg Donovan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Jan 2013 22:48:32 +0000</created>
                <updated>Mon, 9 May 2016 18:51:31 +0000</updated>
                            <resolved>Wed, 30 Jan 2013 17:03:37 +0000</resolved>
                                    <version>4.1</version>
                                    <fixVersion>4.2</fixVersion>
                    <fixVersion>6.0</fixVersion>
                                    <component>replication (java)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13566270" author="ab" created="Wed, 30 Jan 2013 07:59:20 +0000"  >&lt;p&gt;I confirm this is an issue in my environment too, where we use a custom deletion policy to replicate additional side-load index data.&lt;/p&gt;

&lt;p&gt;If reopening a writer was too heavy-weight for NRT (was that the motivation for this change) then perhaps the replication code should use a different mechanism to obtain the list of IndexCommit-s if there is no writer?&lt;/p&gt;</comment>
                            <comment id="13566526" author="markrmiller@gmail.com" created="Wed, 30 Jan 2013 15:06:55 +0000"  >&lt;p&gt;Gregg, can you check if the follow patch solves this for you?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: solr/core/src/java/org/apache/solr/handler/ReplicationHandler.java
===================================================================
--- solr/core/src/java/org/apache/solr/handler/ReplicationHandler.java	(revision 1440432)
+++ solr/core/src/java/org/apache/solr/handler/ReplicationHandler.java	(working copy)
@@ -42,6 +42,7 @@
 import org.apache.lucene.index.IndexCommit;
 import org.apache.lucene.index.IndexDeletionPolicy;
 import org.apache.lucene.index.DirectoryReader;
+import org.apache.lucene.index.IndexWriter;
 import org.apache.lucene.store.Directory;
 import org.apache.lucene.store.IOContext;
 import org.apache.lucene.store.IndexInput;
@@ -877,10 +878,9 @@
             }
           }
 
-          // reboot the writer on the new index
-          // TODO: perhaps this is no longer necessary then?
-         // core.getUpdateHandler().newIndexWriter(true);
-
+          // ensure the writer is init&apos;d
+          RefCounted&amp;lt;IndexWriter&amp;gt; iw = core.getUpdateHandler().getSolrCoreState().getIndexWriter(core);
+          iw.decref();
         } catch (IOException e) {
           LOG.warn(&quot;Unable to get IndexCommit on startup&quot;, e);
         } finally {

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13566529" author="markrmiller@gmail.com" created="Wed, 30 Jan 2013 15:12:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;was that the motivation for this change&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, based on the comment I&apos;m thinking I couldn&apos;t see why it was necessary and no test failed without it.&lt;/p&gt;

&lt;p&gt;However, when I try to uncomment it, the tests seem to show problems given the work done in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3911&quot; title=&quot;Make Directory and DirectoryFactory first class so that the majority of Solr&amp;#39;s features work with any custom implementations.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3911&quot;&gt;&lt;del&gt;SOLR-3911&lt;/del&gt;&lt;/a&gt;. Perhaps that is part of why it&apos;s commented out as well, I don&apos;t remember.&lt;/p&gt;

&lt;p&gt;The above tries to just make sure the writer has been init&apos;d rather than forcing a new one.&lt;/p&gt;</comment>
                            <comment id="13566542" author="greggny3" created="Wed, 30 Jan 2013 15:33:07 +0000"  >&lt;p&gt;Mark &amp;#8211; Your new patch works perfectly for us. I like the approach better than just restoring the call to newIndexWriter, as well. If a writer already exists when ReplicationHandler#inform gets called, why make a new one?&lt;/p&gt;</comment>
                            <comment id="13566569" author="markrmiller@gmail.com" created="Wed, 30 Jan 2013 16:13:54 +0000"  >&lt;p&gt;Thanks Gregg - I&apos;ve added a test that catches this issue as well. I&apos;ll commit shortly.&lt;/p&gt;</comment>
                            <comment id="13566602" author="markrmiller@gmail.com" created="Wed, 30 Jan 2013 16:42:47 +0000"  >&lt;p&gt;Committed - accidentally tagged it as &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-3911&quot; title=&quot;Make Directory and DirectoryFactory first class so that the majority of Solr&amp;#39;s features work with any custom implementations.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-3911&quot;&gt;&lt;del&gt;SOLR-3911&lt;/del&gt;&lt;/a&gt; though.&lt;/p&gt;</comment>
                            <comment id="13566611" author="commit-tag-bot" created="Wed, 30 Jan 2013 16:58:12 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;trunk commit&amp;#93;&lt;/span&gt; Mark Robert Miller&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1440518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1440518&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4380&quot; title=&quot;ReplicationHandler replicateAfter startup not showing commits after SOLR-3911&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4380&quot;&gt;&lt;del&gt;SOLR-4380&lt;/del&gt;&lt;/a&gt;: fix JIRA issue number&lt;/p&gt;</comment>
                            <comment id="13566625" author="commit-tag-bot" created="Wed, 30 Jan 2013 17:06:14 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;branch_4x commit&amp;#93;&lt;/span&gt; Mark Robert Miller&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1440521&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1440521&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-4380&quot; title=&quot;ReplicationHandler replicateAfter startup not showing commits after SOLR-3911&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-4380&quot;&gt;&lt;del&gt;SOLR-4380&lt;/del&gt;&lt;/a&gt;: fix JIRA issue number&lt;/p&gt;</comment>
                            <comment id="13654155" author="thetaphi" created="Fri, 10 May 2013 10:34:13 +0000"  >&lt;p&gt;Closed after release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12609991">SOLR-3911</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>310303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hjw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>310648</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>