<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:29:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-11687] SolrCore.getNewIndexDir falsely returns {dataDir}/index on any IOException reading index.properties</title>
                <link>https://issues.apache.org/jira/browse/SOLR-11687</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;I&apos;ll link the originating Solr JIRA in a minute (many thanks Nikolay). &lt;/p&gt;

&lt;p&gt;right at the top of this method we have this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; result = dataDir + &lt;span class=&quot;code-quote&quot;&gt;&quot;index/&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If, for any reason, the method doesn&apos;t complete properly, the &quot;result&quot; is still returned. Now for instance, down in SolrCore.cleanupOldIndexDirectories the &quot;old&quot; directory is dataDir/index which may point to the current index.&lt;/p&gt;

&lt;p&gt;This seems particularly dangerous:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          p.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InputStreamReader(is, StandardCharsets.UTF_8));

          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = p.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;index&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (s != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; s.trim().length() &amp;gt; 0) {
              result = dataDir + s;
          }

        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
          log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to load &quot;&lt;/span&gt; + IndexFetcher.INDEX_PROPERTIES, e);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
          IOUtils.closeQuietly(is);
        }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should &quot;p.load&quot; fail for any reason whatsoever, we&apos;ll still return dataDir/index.&lt;/p&gt;

&lt;p&gt;Anyone want to chime on on what the expectations are here before I dive in?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13121104">SOLR-11687</key>
            <summary>SolrCore.getNewIndexDir falsely returns {dataDir}/index on any IOException reading index.properties</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="erickerickson">Erick Erickson</assignee>
                                    <reporter username="erickerickson">Erick Erickson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Nov 2017 22:21:52 +0000</created>
                <updated>Thu, 21 Nov 2019 00:42:29 +0000</updated>
                            <resolved>Mon, 4 Dec 2017 18:30:33 +0000</resolved>
                                                    <fixVersion>7.2</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16267697" author="erickerickson" created="Mon, 27 Nov 2017 22:23:12 +0000"  >&lt;p&gt;Fixing 11687 may handle 11625, listing them separately though.&lt;/p&gt;</comment>
                            <comment id="16267736" author="hossman" created="Mon, 27 Nov 2017 22:52:07 +0000"  >&lt;p&gt;(issue edited to reformat the description and clarify the summary)&lt;/p&gt;</comment>
                            <comment id="16267747" author="hossman" created="Mon, 27 Nov 2017 22:59:07 +0000"  >&lt;p&gt;AFAICT, this method is just blatently broken in the situation where &lt;tt&gt;index.properties&lt;/tt&gt; exists but any sort of Exception occurs while attempting to read it, or any sort of IOException occurs when even trying to determine if it exists (other then the FNFE and NSFE used to indicate that it does not)&lt;/p&gt;

&lt;p&gt;A decision needs to be made as to what the semantics of this method should be in the event of an underlying Exception reading this file (ie: return null, throw IOException, throw SolrException, something else, etc...) and all callers need to be updated to ensure they account for that possibility.&lt;/p&gt;

&lt;p&gt;Until then, this method will happily lie and say &quot;the new index dir is &lt;tt&gt;dataDir + &quot;index/&quot;&lt;/tt&gt;&quot; even if there is a much more current one listed in &lt;tt&gt;index.properties&lt;/tt&gt;.&lt;/p&gt;
</comment>
                            <comment id="16268093" author="erickerickson" created="Tue, 28 Nov 2017 04:22:53 +0000"  >&lt;p&gt;I&apos;ve worked up the skeleton of a patch I&apos;ll look over and attach tomorrow after running tests. I have a couple of nocommits I&apos;d like to draw attention to, in particular what do we do if, say, the index.properties file has &lt;br/&gt;
&lt;tt&gt;index=&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;or, more generically if &lt;tt&gt;Properties.getProperty(&quot;index&quot;)&lt;/tt&gt; returns null or an empty string? It seems like returning the default &lt;tt&gt;dataDir/index/&lt;/tt&gt; is correct.&lt;/p&gt;

&lt;p&gt;The simple notion of returning null looks ugly, there are numerous places that pretty much assume the response is &lt;em&gt;not&lt;/em&gt; null and some of them are convoluted. Catching them all would be a pain and I&apos;m not sure would add any value. Failing to catch them would result in NPEs, just kicking the can down the road.&lt;/p&gt;

&lt;p&gt;Throwing a RuntimeException fits the bill of &quot;something a programmer can&apos;t reasonably be expected to handle&quot;. If we throw a checked exception it looks at first glance like there are a lot of places the code needs to be touched. Ditto I&apos;m not sure any value would be added by using a checked exception&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll see if tests run tonight and attach the file if it looks OK in the morning.&lt;/p&gt;</comment>
                            <comment id="16269946" author="erickerickson" created="Wed, 29 Nov 2017 02:19:28 +0000"  >&lt;p&gt;Here&apos;s a patch for comment. All tests pass. &lt;/p&gt;

&lt;p&gt;Mostly it reorganizes the decision whether to return a string that&apos;s the indexDir or throw an exception.&lt;/p&gt;

&lt;p&gt;There are  a couple of nocommits in here, mostly to draw people&apos;s attention to some assumptions if they have any opinion.&lt;/p&gt;

&lt;p&gt;Comments welcome. If there aren&apos;t any objections I&apos;ll commit this in a few days after doing some additional testing.&lt;/p&gt;</comment>
                            <comment id="16269955" author="erickerickson" created="Wed, 29 Nov 2017 02:23:03 +0000"  >&lt;p&gt;If this approach is OK, it fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11625&quot; title=&quot;Solr may remove live index on Solr shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11625&quot;&gt;&lt;del&gt;SOLR-11625&lt;/del&gt;&lt;/a&gt; as well I think.&lt;/p&gt;</comment>
                            <comment id="16271690" author="hossman" created="Wed, 29 Nov 2017 22:42:52 +0000"  >&lt;p&gt;erick: i haven&apos;t audited all of the code paths that call this method (did you?) but the one thing that jumps out at me in your patch is your choice to throw an explicit &lt;tt&gt;new RuntimeException(e)&lt;/tt&gt; ... why not &lt;tt&gt;new SolrException(SERVER_ERROR, &quot;Some message about index.properties&quot;, e)&lt;/tt&gt; (since SolrException is also a RuntimeException) &lt;/p&gt;

&lt;p&gt;?&lt;/p&gt;
</comment>
                            <comment id="16271839" author="erickerickson" created="Thu, 30 Nov 2017 00:00:53 +0000"  >&lt;p&gt;Good catch Hoss, I&apos;ll change it for the next version of the patch.&lt;/p&gt;</comment>
                            <comment id="16276199" author="erickerickson" created="Mon, 4 Dec 2017 01:42:26 +0000"  >&lt;p&gt;Final patch (except for CHANGES.txt). I&apos;ll commit tomorrow (Monday) unless there are objections after running another round of precommit/tests.&lt;/p&gt;

&lt;p&gt;There&apos;s a bit of extra noise. When I adopted Hoss&apos; suggestion to use SolrException rather than RuntimeException, IntelliJ added an import and changed all the &lt;br/&gt;
SolrException.ErrorCode.SERVER_ERROR&lt;br/&gt;
to&lt;br/&gt;
ErrorCode.SERVER_ERROR&lt;/p&gt;

&lt;p&gt;but I&apos;m going to leave that part in and easily ignorable.&lt;/p&gt;</comment>
                            <comment id="16276248" author="varunthacker" created="Mon, 4 Dec 2017 03:27:13 +0000"  >&lt;p&gt;Hi Erick,&lt;/p&gt;

&lt;p&gt;This is my current reading of the &lt;tt&gt;getNewIndexDir()&lt;/tt&gt; method ( without the patch )&lt;br/&gt;
1. If index.properties is not present return &lt;tt&gt;dataDir + &quot;index/&quot;&lt;/tt&gt; &lt;br/&gt;
2. If index.properties is present AND &quot;index&quot; key is not null/empty then return that value&lt;br/&gt;
3. If while reading index.properties there is an exception we return &lt;tt&gt;dataDir + &quot;index/&quot;&lt;/tt&gt; &lt;/p&gt;

&lt;p&gt;From what I understood of the patch the semantics of handling point 3 have changed i.e we throw an exception instead of returning &lt;tt&gt;dataDir + &quot;index/&quot;&lt;/tt&gt;  . Am I understanding it correctly ?&lt;/p&gt;</comment>
                            <comment id="16276699" author="shalinmangar" created="Mon, 4 Dec 2017 12:26:50 +0000"  >&lt;p&gt;+1 LGTM.&lt;/p&gt;</comment>
                            <comment id="16276943" author="erickerickson" created="Mon, 4 Dec 2017 15:30:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;Right. And the last point is the kicker because some interrupts would cause exceptions and would return dataDir+&quot;index/&quot;. And in the case in point, the code was trying to delete old indexes. So what would get deleted instead was the &lt;em&gt;current&lt;/em&gt; index.&lt;/p&gt;</comment>
                            <comment id="16276944" author="erickerickson" created="Mon, 4 Dec 2017 15:30:58 +0000"  >&lt;p&gt;Thanks Shalin....&lt;/p&gt;</comment>
                            <comment id="16277155" author="erickerickson" created="Mon, 4 Dec 2017 17:54:29 +0000"  >&lt;p&gt;Final patch with CHANGES.txt&lt;/p&gt;</comment>
                            <comment id="16277158" author="jira-bot" created="Mon, 4 Dec 2017 17:57:33 +0000"  >&lt;p&gt;Commit 929ce7ca30d5b4f9d08aee604ba5184f0d94d505 in lucene-solr&apos;s branch refs/heads/master from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=929ce7c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=929ce7c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11687&quot; title=&quot;SolrCore.getNewIndexDir falsely returns {dataDir}/index on any IOException reading index.properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11687&quot;&gt;&lt;del&gt;SOLR-11687&lt;/del&gt;&lt;/a&gt;: SolrCore.getNewIndexDir falsely returns &lt;/p&gt;
{dataDir}
&lt;p&gt;/index on any IOException reading index.properties&lt;/p&gt;</comment>
                            <comment id="16277165" author="varunthacker" created="Mon, 4 Dec 2017 18:05:48 +0000"  >&lt;p&gt;Hi Erick&lt;/p&gt;

&lt;p&gt;Is this change enough then? &lt;/p&gt;</comment>
                            <comment id="16277191" author="jira-bot" created="Mon, 4 Dec 2017 18:21:48 +0000"  >&lt;p&gt;Commit 04cb83cbc33b78b23cf978f242e44c79f427abfe in lucene-solr&apos;s branch refs/heads/branch_7x from Erick&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=04cb83c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=04cb83c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-11687&quot; title=&quot;SolrCore.getNewIndexDir falsely returns {dataDir}/index on any IOException reading index.properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-11687&quot;&gt;&lt;del&gt;SOLR-11687&lt;/del&gt;&lt;/a&gt;: SolrCore.getNewIndexDir falsely returns &lt;/p&gt;
{dataDir}
&lt;p&gt;/index on any IOException reading index.properties&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 929ce7c)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="13117174">SOLR-11625</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13117174">SOLR-11625</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12900517" name="SOLR-11687.patch" size="14500" author="erickerickson" created="Mon, 4 Dec 2017 17:54:12 +0000"/>
                            <attachment id="12900406" name="SOLR-11687.patch" size="13516" author="erickerickson" created="Mon, 4 Dec 2017 01:39:33 +0000"/>
                            <attachment id="12899734" name="SOLR-11687.patch" size="4423" author="erickerickson" created="Wed, 29 Nov 2017 02:15:49 +0000"/>
                            <attachment id="12900520" name="SOLR-11687_alt.patch" size="703" author="varun" created="Mon, 4 Dec 2017 18:05:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3n8yn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>