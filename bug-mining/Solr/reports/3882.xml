<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 04:32:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SOLR-12065] Restore replica always in buffering state</title>
                <link>https://issues.apache.org/jira/browse/SOLR-12065</link>
                <project id="12310230" key="SOLR">Solr</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://localhost:8983/solr/admin/collections?action=CREATE&amp;amp;name=test_backup&amp;amp;numShards=1&amp;amp;nrtReplicas=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/collections?action=CREATE&amp;amp;name=test_backup&amp;amp;numShards=1&amp;amp;nrtReplicas=1&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;curl &lt;a href=&quot;http://127.0.0.1:8983/solr/test_backup/update?commit=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://127.0.0.1:8983/solr/test_backup/update?commit=true&lt;/a&gt; -H &apos;Content-type:application/json&apos; -d &apos;&lt;br/&gt;
 [ {&quot;id&quot; : &quot;1&quot;}&lt;br/&gt;
]&apos;&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://localhost:8983/solr/admin/collections?action=BACKUP&amp;amp;name=test_backup&amp;amp;collection=test_backup&amp;amp;location=/Users/varunthacker/backups&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/collections?action=BACKUP&amp;amp;name=test_backup&amp;amp;collection=test_backup&amp;amp;location=/Users/varunthacker/backups&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://localhost:8983/solr/admin/collections?action=RESTORE&amp;amp;name=test_backup&amp;amp;location=/Users/varunthacker/backups&amp;amp;collection=test_restore&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/collections?action=RESTORE&amp;amp;name=test_backup&amp;amp;location=/Users/varunthacker/backups&amp;amp;collection=test_restore&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;curl &lt;a href=&quot;http://127.0.0.1:8983/solr/test_restore/update?commit=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://127.0.0.1:8983/solr/test_restore/update?commit=true&lt;/a&gt; -H &apos;Content-type:application/json&apos; -d &apos;&lt;br/&gt;
 [
{&quot;id&quot; : &quot;2&quot;}
&lt;p&gt;]&apos;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Snippet when you try adding a document&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO - 2018-03-07 22:48:11.555; [c:test_restore s:shard1 r:core_node22 x:test_restore_shard1_replica_n21] org.apache.solr.update.processor.DistributedUpdateProcessor; Ignoring commit &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; not ACTIVE - state: BUFFERING replay: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
INFO - 2018-03-07 22:48:11.556; [c:test_restore s:shard1 r:core_node22 x:test_restore_shard1_replica_n21] org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor; [test_restore_shard1_replica_n21] webapp=/solr path=/update params={commit=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;}{add=[2 (1594320896973078528)],commit=} 0 4&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
	&lt;li&gt;If you see &quot;TLOG.state&quot; from &lt;a href=&quot;http://localhost:8983/solr/admin/metrics&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/metrics&lt;/a&gt; it&apos;s always 1 (BUFFERING)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13143383">SOLR-12065</key>
            <summary>Restore replica always in buffering state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="varun">Varun Thacker</assignee>
                                    <reporter username="varun">Varun Thacker</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Mar 2018 22:51:28 +0000</created>
                <updated>Mon, 7 Aug 2023 19:57:27 +0000</updated>
                            <resolved>Thu, 12 Apr 2018 17:16:42 +0000</resolved>
                                                    <fixVersion>7.3.1</fixVersion>
                    <fixVersion>7.4</fixVersion>
                    <fixVersion>8.0</fixVersion>
                                    <component>Backup/Restore</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16390397" author="varunthacker" created="Wed, 7 Mar 2018 22:57:03 +0000"  >&lt;p&gt;I&apos;ve attached a log file from the local run:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What&apos;s interesting is that Line 83 says that the collection is restored successfully ( while the shard state is in &quot;construction&quot; ) while only in Line 101 that the shard state becomes active&lt;/p&gt;


&lt;p&gt;This looks like a race condition as it should first become active and then complete the task.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/cloud/api/collections/RestoreCmd.java#L280-L292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/cloud/api/collections/RestoreCmd.java#L280-L292&lt;/a&gt;&#160;tries to mark it as active , refresh the cluster-state and then proceed which seems broken as it&apos;s not really refreshed yet and hence is seeing a stale state&lt;/p&gt;</comment>
                            <comment id="16390870" author="varunthacker" created="Thu, 8 Mar 2018 07:44:48 +0000"  >&lt;p&gt;I spent some time looking into this but my initial assessment is we need to replay the tlogs which will then mark it as active&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
requestMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Slice slice : restoreCollection.getSlices()) {
Replica oneReplica = slice.getReplicas().iterator().next();

log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Applying buffered updates on : &quot;&lt;/span&gt; + oneReplica.getName());

ModifiableSolrParams params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModifiableSolrParams();
params.set(CoreAdminParams.ACTION, CoreAdminParams.CoreAdminAction.REQUESTAPPLYUPDATES.toString());
params.set(CoreAdminParams.NAME, oneReplica.getCoreName());

&lt;span class=&quot;code-comment&quot;&gt;//ocmh.sliceCmd(clusterState, params, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, slice, shardHandler, asyncId, requestMap);
&lt;/span&gt;
ocmh.sendShardRequest(oneReplica.getNodeName(), params, shardHandler, asyncId, requestMap);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Something like this around Line 284 to RestoreCmd.java&lt;/p&gt;

&lt;p&gt;I&apos;ll try spending some time tomorrow and working on this&#160;&lt;/p&gt;</comment>
                            <comment id="16403486" author="mkhludnev" created="Sat, 17 Mar 2018 15:31:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sarkaramrit2%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;sarkaramrit2@gmail.com&quot;&gt;sarkaramrit2@gmail.com&lt;/a&gt;, not that &lt;span class=&quot;error&quot;&gt;&amp;#91;^SOLR-12071.patch&amp;#93;&lt;/span&gt; jira.&lt;/p&gt;</comment>
                            <comment id="16403520" author="sarkaramrit2@gmail.com" created="Sat, 17 Mar 2018 16:12:45 +0000"  >&lt;p&gt;oh damn. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkhludnev&quot; class=&quot;user-hover&quot; rel=&quot;mkhludnev&quot;&gt;mkhludnev&lt;/a&gt;, thanks for pointing this out.&lt;/p&gt;</comment>
                            <comment id="16417843" author="rohitcse" created="Wed, 28 Mar 2018 17:59:00 +0000"  >&lt;p&gt;Changed flow in RestoreCmd.java and improved the backup and restore test case:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Post restoration index new docs to the restored collection&lt;/li&gt;
	&lt;li&gt;Verify that the new documents are searchable and the original doc count + newly indexed doc count matches are correct&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Additional steps performed to test and verify:&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12916659/12916659_12605UTLogs.txt.zip&quot; title=&quot;12605UTLogs.txt.zip attached to SOLR-12065&quot;&gt;12605UTLogs.txt.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12916660/12916660_logs_and_metrics.zip&quot; title=&quot;logs_and_metrics.zip attached to SOLR-12065&quot;&gt;logs_and_metrics.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;1. &lt;a href=&quot;http://localhost:8983/solr/admin/collections?action=CREATE&amp;amp;name=test_backup&amp;amp;numShards=2&amp;amp;nrtReplicas=2&amp;amp;replicationFactor=2&amp;amp;maxShardsPerNode=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/collections?action=CREATE&amp;amp;name=test_backup&amp;amp;numShards=2&amp;amp;nrtReplicas=2&amp;amp;replicationFactor=2&amp;amp;maxShardsPerNode=2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2. curl &lt;a href=&quot;http://127.0.0.1:8983/solr/test_backup/update?commit=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://127.0.0.1:8983/solr/test_backup/update?commit=true&lt;/a&gt; -H &apos;Content-type:application/json&apos; -d &apos;[ {&quot;id&quot; : &quot;1&quot;}]&apos; &lt;/p&gt;

&lt;p&gt;3. &lt;a href=&quot;http://localhost:8983/solr/admin/collections?action=BACKUP&amp;amp;name=test_backup&amp;amp;collection=test_backup&amp;amp;location=/Users/Rohit/Desktop/backup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/collections?action=BACKUP&amp;amp;name=test_backup&amp;amp;collection=test_backup&amp;amp;location=/Users/Rohit/Desktop/backup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4. &lt;a href=&quot;http://localhost:8983/solr/admin/collections?action=RESTORE&amp;amp;name=test_backup&amp;amp;location=/Users/Rohit/Desktop/backup&amp;amp;collection=test_restore&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8983/solr/admin/collections?action=RESTORE&amp;amp;name=test_backup&amp;amp;location=/Users/Rohit/Desktop/backup&amp;amp;collection=test_restore&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5.&#160;curl &lt;a href=&quot;http://127.0.0.1:8983/solr/test_restore/update?commit=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://127.0.0.1:8983/solr/test_restore/update?commit=true&lt;/a&gt; -H &apos;Content-type:application/json&apos; -d &apos;[ {&quot;id&quot; : &quot;2&quot;}]&apos;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;a) Verify doc count on all replicas for each shard.&lt;/p&gt;

&lt;p&gt;&quot;response&quot;:{&quot;numFound&quot;:2,&quot;start&quot;:0,&quot;maxScore&quot;:1.0,&quot;docs&quot;:[ &lt;/p&gt;
{ &quot;id&quot;:&quot;2&quot;}
&lt;p&gt;, { &quot;id&quot;:&quot;1&quot;}]&lt;/p&gt;

&lt;p&gt;b) Verify from Solr logs (attached)&lt;/p&gt;

&lt;p&gt;c) Verify from tlog.state in the admin/metrics api response for node 8983 and 7574 (attached)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Attaching the patch and logs to the JIRA.&lt;/p&gt;</comment>
                            <comment id="16419749" author="mkhludnev" created="Thu, 29 Mar 2018 20:57:51 +0000"  >&lt;p&gt;The patch seems great. Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohitcse&quot; class=&quot;user-hover&quot; rel=&quot;rohitcse&quot;&gt;rohitcse&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt;, would you mind to skim through? If you approve, I&apos;ll proceed with commit.   &lt;/p&gt;</comment>
                            <comment id="16420785" author="varunthacker" created="Fri, 30 Mar 2018 18:03:38 +0000"  >&lt;p&gt;Hi Rohit,&lt;/p&gt;

&lt;p&gt;Thanks for the patch. This looks great!&lt;/p&gt;

&lt;p&gt;Some feedback from the patch:&lt;/p&gt;

&lt;p&gt;1. In AbstractCloudBackupRestoreTestCase we added a new method indexNewDocsToCollection . Can&apos;t we reuse indexDocs ? We can make changes to that method so that it&apos;s generally more reusable for your test&lt;br/&gt;
Also in general we don&apos;t need to do &lt;tt&gt;Random random = new Random(docsSeed);&lt;/tt&gt; . We can do &lt;tt&gt;Random r = random();&lt;/tt&gt; because the test setup already has a static method to get random.&lt;/p&gt;

&lt;p&gt;2. Maybe {[getDocCountInCollection}} can be something like this since we are counting the number of docs in a collection , so hitting any underlying node will be fine &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; getDocCountInCollection(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; collectionName) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SolrServerException, IOException {
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cluster.getSolrClient().query(collectionName, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SolrQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;*:*&quot;&lt;/span&gt;)).getResults().getNumFound();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. RestoreCmd has a unused import. This will make &lt;tt&gt;ant precommit&lt;/tt&gt; fail&lt;/p&gt;

&lt;p&gt;4. Should both of the log.info lines added to RestoreCmd be debug level? Also can we use parameterized logging ?&lt;/p&gt;

&lt;p&gt;5. After the REQUESTAPPLYUPDATES command is sent , shouldn&apos;t we validate the response? So something like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 ocmh.processResponses(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NamedList(), shardHandler, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;REQUESTAPPLYUPDATES calls did not succeed&quot;&lt;/span&gt;, asyncId, requestMap);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16420787" author="varunthacker" created="Fri, 30 Mar 2018 18:05:46 +0000"  >&lt;p&gt;Lastly, if you upload the patch as&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12065&quot; title=&quot;Restore replica always in buffering state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12065&quot;&gt;&lt;del&gt;SOLR-12065&lt;/del&gt;&lt;/a&gt;.patch , you can then hit the submit patch button and the automated QA system will be able to validate your patch as well. That&apos;s the general convention we follow for patch naming formats.&lt;/p&gt;</comment>
                            <comment id="16426778" author="rohitcse" created="Thu, 5 Apr 2018 11:38:24 +0000"  >&lt;p&gt;1. In AbstractCloudBackupRestoreTestCase we added a new method indexNewDocsToCollection . Can&apos;t we reuse indexDocs ? We can make changes to that method so that it&apos;s generally more reusable for your test&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Done&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2. Maybe {[getDocCountInCollection}} can be something like this since we are counting the number of docs in a collection , so hitting any underlying node will be fine&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Reused the existing&#160;getShardToDocCountMap function&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;3. RestoreCmd has a unused import. This will make&#160;&lt;tt&gt;ant precommit&lt;/tt&gt;&#160;fail&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Removed the un-used import and verified with ant precommit&#160;&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Crawl/parse...&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;exec&amp;#93;&lt;/span&gt; Verify...&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;echo&amp;#93;&lt;/span&gt; Checking for malformed docs...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;precommit:&lt;/p&gt;

&lt;p&gt;BUILD SUCCESSFUL&lt;br/&gt;
 Total time: 16 minutes 30 seconds&lt;/p&gt;

&lt;p&gt;4. Should both of the log.info lines added to RestoreCmd be debug level? Also can we use parameterized logging ?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Changed at one place and used parameterised logging&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;5. After the REQUESTAPPLYUPDATES command is sent , shouldn&apos;t we validate the response? So something like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 ocmh.processResponses(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NamedList(), shardHandler, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;REQUESTAPPLYUPDATES calls did not succeed&quot;&lt;/span&gt;, asyncId, requestMap);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
	&lt;li&gt;Done, added it to the RestoreCmd source.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Verified the build on Master and state in tlog.state for test_restore collection using the admin/metrics API on two node Solr cluster&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;SEARCHER.searcher.searcherName&quot;:&quot;Searcher@70ed14d&lt;span class=&quot;error&quot;&gt;&amp;#91;test_restore_shard1_replica_n47&amp;#93;&lt;/span&gt; main&quot;,&lt;/tt&gt;&lt;br/&gt;
 {{ &quot;SEARCHER.searcher.warmupTime&quot;:0,}}&lt;br/&gt;
 &lt;tt&gt;......&lt;/tt&gt;&lt;br/&gt;
 {{ &quot;TLOG.replay.remaining.bytes&quot;:0,}}&lt;br/&gt;
 {{ &quot;TLOG.replay.remaining.logs&quot;:0,}}&lt;br/&gt;
 {{ &quot;TLOG.state&quot;:3,}}&lt;tt&gt;&quot;SEARCHER.searcher.registeredAt&quot;:&quot;2018-04-05T11:24:20.667Z&quot;,&lt;/tt&gt;&lt;br/&gt;
 {{ &quot;SEARCHER.searcher.searcherName&quot;:&quot;Searcher@475f6bda&lt;span class=&quot;error&quot;&gt;&amp;#91;test_restore_shard2_replica_n45&amp;#93;&lt;/span&gt; main&quot;,}}&lt;br/&gt;
 {{ &quot;TLOG.replay.remaining.bytes&quot;:104,}}&lt;br/&gt;
 {{ &quot;TLOG.replay.remaining.logs&quot;:1,}}&lt;br/&gt;
 {{ &quot;TLOG.state&quot;:3,}}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun&quot; class=&quot;user-hover&quot; rel=&quot;varun&quot;&gt;varun&lt;/a&gt; Requesting you to have a look and let me know your feedback&lt;/p&gt;</comment>
                            <comment id="16434763" author="varunthacker" created="Thu, 12 Apr 2018 00:29:03 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Slice shard : restoreCollection.getSlices()) {
  ocmh.waitForNewShard(restoreCollectionName, shard.getName());
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I don&apos;t think we need to explicitly do this in RestoreCmd. We call createcollection command which internally wait&apos;s for the shard to become active. So we are good here.&lt;/p&gt;

&lt;p&gt;I removed this logging line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numberOfActiveShards = restoreCollection.getActiveSlices().size();
log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of activeShards: &quot;&lt;/span&gt;  + numberOfActiveShards);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also in the test case I cleaned up how we are counting docs before and after indexing&lt;/p&gt;

&lt;p&gt;With the latest patch , the HDFS backup test fails quite regularly on my machine.&lt;/p&gt;

&lt;p&gt;here&apos;s what&apos;s happening:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we add docs after the restore is complete&lt;/li&gt;
	&lt;li&gt;call commit&#160;&lt;/li&gt;
	&lt;li&gt;query to assert doc count. Now if the query hits a non-leader replica and open searcher hasn&apos;t&#160;been executed&#160;on&#160;the replica then gives the old count and the test fails&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16434833" author="varunthacker" created="Thu, 12 Apr 2018 02:17:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;With the latest patch , the HDFS backup test fails quite regularly on my machine.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Looking more closely at the logs, there were 3 replicas for the shard . And the replica that got queried was a pull replica. I think I&apos;ll revert to querying the leaders explicitly and counting the total&lt;/p&gt;</comment>
                            <comment id="16434857" author="varunthacker" created="Thu, 12 Apr 2018 02:47:35 +0000"  >&lt;p&gt;Uploaded a new patch with a CHANGES entry . Running tests and precommit on this patch before committing it&lt;/p&gt;</comment>
                            <comment id="16435747" author="jira-bot" created="Thu, 12 Apr 2018 15:20:52 +0000"  >&lt;p&gt;Commit 7a57ca8c0d10ceb23cad6fe9bc3538314ce6b6ce in lucene-solr&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun_saxena&quot; class=&quot;user-hover&quot; rel=&quot;varun_saxena&quot;&gt;varun_saxena&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7a57ca8c0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7a57ca8c0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12065&quot; title=&quot;Restore replica always in buffering state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12065&quot;&gt;&lt;del&gt;SOLR-12065&lt;/del&gt;&lt;/a&gt;: A successful restore collection should mark the shard state as active and not buffering&lt;/p&gt;</comment>
                            <comment id="16435972" author="jira-bot" created="Thu, 12 Apr 2018 17:16:19 +0000"  >&lt;p&gt;Commit b25ae6779c9ad875eabd8b3e2a72b7108e740a33 in lucene-solr&apos;s branch refs/heads/branch_7x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun_saxena&quot; class=&quot;user-hover&quot; rel=&quot;varun_saxena&quot;&gt;varun_saxena&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b25ae67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b25ae67&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12065&quot; title=&quot;Restore replica always in buffering state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12065&quot;&gt;&lt;del&gt;SOLR-12065&lt;/del&gt;&lt;/a&gt;: A successful restore collection should mark the shard state as active and not buffering&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 7a57ca8)&lt;/p&gt;</comment>
                            <comment id="16435973" author="varunthacker" created="Thu, 12 Apr 2018 17:16:42 +0000"  >&lt;p&gt;Thanks Rohit!&lt;/p&gt;</comment>
                            <comment id="16451681" author="jira-bot" created="Wed, 25 Apr 2018 05:39:23 +0000"  >&lt;p&gt;Commit 8894db1a727dff5a52444f9b4a5838995a8f7513 in lucene-solr&apos;s branch refs/heads/branch_7_3 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=varun_saxena&quot; class=&quot;user-hover&quot; rel=&quot;varun_saxena&quot;&gt;varun_saxena&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8894db1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8894db1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-12065&quot; title=&quot;Restore replica always in buffering state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-12065&quot;&gt;&lt;del&gt;SOLR-12065&lt;/del&gt;&lt;/a&gt;: A successful restore collection should mark the shard state as active and not buffering&lt;/p&gt;</comment>
                            <comment id="17751792" author="dsmiley" created="Mon, 7 Aug 2023 19:57:27 +0000"  >&lt;p&gt;An observation I have, years later, is that it feels really strange to call REQUESTAPPLYUPDATES on the restored replicas because &lt;em&gt;there is no update log&lt;/em&gt;!  Well technically there is but it&apos;s empty, newly created, because we don&apos;t backup / restore the update log.  AFAICT this is being called because of the side effects this command has.  It switches the internal state of the UpdateLog  from BUFFERING to ACTIVE (org.apache.solr.update.UpdateLog#applyBufferedUpdates).  It also publishes the replica as ACTIVE when done, which probably isn&apos;t pertinent here since RestoreCmd sets them ACTIVE at the end any way.  Apparently, a newly created Core of a SolrCloud Collection has its updateLog in buffering state (org.apache.solr.core.SolrCore#bufferUpdatesIfConstructing).  &lt;/p&gt;

&lt;p&gt;I propose instead that RESTORECORE call applyBufferedUpdates() (locally) and document why it is doing so.  Document that we don&apos;t have any buffered updates but that we need to transition the state to ACTIVE.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13119558">SOLR-11660</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12916661" name="12065.patch" size="6496" author="rohitcse" created="Wed, 28 Mar 2018 17:59:28 +0000"/>
                            <attachment id="12916659" name="12605UTLogs.txt.zip" size="45239" author="rohitcse" created="Wed, 28 Mar 2018 17:57:15 +0000"/>
                            <attachment id="12918663" name="SOLR-12065.patch" size="9504" author="varun" created="Thu, 12 Apr 2018 02:47:09 +0000"/>
                            <attachment id="12918657" name="SOLR-12065.patch" size="8382" author="varun" created="Thu, 12 Apr 2018 02:21:51 +0000"/>
                            <attachment id="12918650" name="SOLR-12065.patch" size="8020" author="varun" created="Thu, 12 Apr 2018 00:30:39 +0000"/>
                            <attachment id="12917680" name="SOLR-12065.patch" size="9259" author="rohitcse" created="Thu, 5 Apr 2018 11:27:55 +0000"/>
                            <attachment id="12916660" name="logs_and_metrics.zip" size="60848" author="rohitcse" created="Wed, 28 Mar 2018 17:57:38 +0000"/>
                            <attachment id="12913466" name="restore_snippet.log" size="17082" author="varun" created="Wed, 7 Mar 2018 22:52:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3r0l3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313321" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Solr Mailing List Info</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>